<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <link rel="stylesheet" href="design-system.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="report.title">Êä•Ë°® - AlwaysControl</title>
    <script src="vendor/echarts.min.js"></script>
    <link rel="stylesheet" href="components/common-styles.css">
    <link rel="stylesheet" href="components/time-selector.css">
    <link rel="stylesheet" href="components/i18n.css">
    <link rel="stylesheet" href="components/notification-center.css">
    <link rel="stylesheet" href="components/header-nav.css">
    <link rel="stylesheet" href="components/standard-layout.css">
    <link rel="stylesheet" href="components/pagination.css">
    <link rel="stylesheet" href="components/user-dropdown.css">
    <script src="components/time-selector.js"></script>
    <script src="components/user-menu-link.js"></script>
    <script src="components/i18n.js"></script>
    <script src="components/simple-message-icon.js"></script>
    <script src="components/user-dropdown-simple-new.js"></script>
    <script src="components/user-menu.js"></script>
    <script src="components/header-nav.js"></script>
    <script src="components/pagination.js"></script>
    <style>
        .time-selector-module {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding: 4px;
            background: var(--color-bg-card);
            border-radius: 24px;
            border: 1px solid var(--color-border);
        }
        .time-input {
            background: transparent;
            border: 1px solid var(--color-border);
            color: var(--color-text);
            padding: 8px 12px;
            border-radius: 16px;
            font-size: 14px;
            min-width: 150px;
            margin-left: 8px;
            transition: all 0.3s ease;
        }
        .date-input-wrapper {
            position: relative;
            display: inline-block;
            min-width: 150px;
        }
        .date-display-label {
            display: block;
            padding: 8px 12px;
            border: 1px solid var(--color-border);
            border-radius: 16px;
            font-size: 14px;
            color: var(--color-text);
            background: transparent;
            pointer-events: none;
            white-space: nowrap;
        }
        .date-native-input {
            position: absolute !important;
            top: 0; left: 0;
            width: 100% !important;
            height: 100% !important;
            opacity: 0 !important;
            cursor: pointer;
            min-width: unset !important;
            margin: 0 !important;
            padding: 0 !important;
            border: none !important;
        }
        .date-input-wrapper.disabled .date-display-label { opacity: 0.5; cursor: not-allowed; }
        .date-input-wrapper.disabled .date-native-input { pointer-events: none; }
        .time-input:disabled { opacity: 0.5; cursor: not-allowed; }
        .time-input[type="number"] { min-width: 100px; }
        select.time-input {
            background: var(--color-bg-card);
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 16px;
            padding-right: 35px;
        }
        select.time-input:hover { background-color: rgba(255,255,255,0.05); border-color: var(--color-primary); }
        select.time-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 2px rgba(0,255,136,0.2); }
        .refresh-btn {
            background: transparent;
            border: 1px solid var(--color-border);
            color: var(--color-text);
            padding: 8px 12px;
            border-radius: 16px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            white-space: nowrap;
            margin-left: 8px;
        }
        .refresh-btn:hover { background: rgba(255,255,255,0.05); }

        .page-view-tabs {
            display: inline-flex;
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: 10px;
            padding: 4px;
            gap: 4px;
        }
        .page-tab {
            position: relative;
            background: rgba(255,255,255,0.05);
            color: rgba(255,255,255,0.6);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 10px 24px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .page-tab:hover:not(.active) { background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.8); }
        .page-tab.active {
            background: #00ff88; color: #000; border-color: #00ff88;
            box-shadow: 0 4px 12px rgba(0,255,136,0.3); font-weight: 600;
        }

        .container { max-width: 95%; padding: 88px var(--page-padding, 24px) 40px; margin: 0 auto; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 36px; }
        .page-title { font-size: 48px; font-weight: 500; color: var(--color-text); margin: 0; letter-spacing: -2px; }

        /* ÁªüËÆ°Âç°Áâá */
        .stats-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; margin-bottom: 48px; }
        .stat-card { padding: 24px; text-align: center; transition: all 0.3s cubic-bezier(0.4,0,0.2,1); position: relative; overflow: hidden; }
        .stat-card:hover { transform: translateY(-4px); box-shadow: 0 8px 24px rgba(0,0,0,0.3); }
        .stat-label { color: var(--color-text-secondary); font-size: 14px; font-weight: 400; margin-bottom: 12px; }
        .stat-value { font-size: 36px; font-weight: 700; margin-bottom: 8px; color: var(--color-text); letter-spacing: -0.5px; }
        .stat-unit { font-size: 16px; font-weight: 400; color: var(--color-text-secondary); margin-left: 4px; }
        .stat-change { font-size: 13px; color: var(--color-success); font-weight: 400; }
        .stat-change.negative { color: var(--color-danger); }

        /* ÂõæË°® */
        .charts-section { display: grid; grid-template-columns: 1fr 1fr; gap: 32px; margin-bottom: 48px; }
        .chart-container { padding: 24px; min-height: 400px; position: relative; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .chart-title { font-size: 18px; font-weight: 500; color: var(--color-text); }
        .chart-controls { display: flex; gap: 8px; margin-left: auto; }
        .chart-controls .filter-tab {
            padding: 6px 12px; background: var(--color-bg); border: 1px solid var(--color-border);
            border-radius: 16px; color: var(--color-text-secondary); cursor: pointer; font-size: 12px; transition: all 0.3s ease; white-space: nowrap;
        }
        .chart-controls .filter-tab:hover { background: var(--color-border); border-color: var(--color-primary); color: var(--color-text); }
        .chart-controls .filter-tab.active { background: var(--color-primary); border-color: var(--color-primary); color: #000; font-weight: 600; }

        /* Ë°®Ê†º */
        .table-section { margin-bottom: 40px; }
        .table-container { padding: 24px; }
        .table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--color-border); }
        .table-title { font-size: 18px; font-weight: 600; color: var(--color-text); }
        .table-controls { display: flex; align-items: center; gap: 20px; }
        .export-btn {
            padding: 8px 16px; background: transparent; border: 1px solid var(--color-primary);
            border-radius: 10px; color: var(--color-primary); cursor: pointer; font-size: 14px;
            font-weight: 500; transition: all 0.3s; display: flex; align-items: center; gap: 6px; white-space: nowrap;
        }
        .export-btn:hover { background: var(--color-primary); color: #000; transform: translateY(-1px); }
        .table-scroll-wrapper { overflow-x: auto; width: 100%; }
        .table-scroll-wrapper::-webkit-scrollbar { height: 6px; }
        .table-scroll-wrapper::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 6px; }
        .table-scroll-wrapper::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 6px; }
        .data-table { width: 100%; border-collapse: collapse; color: var(--color-text); min-width: 900px; }
        .data-table th { background: var(--color-bg); padding: 10px 12px; text-align: left; font-weight: 600; color: var(--color-text-secondary); border-bottom: 1px solid var(--color-border); white-space: nowrap; font-size: 13px; }
        .data-table td { padding: 10px 12px; border-bottom: 1px solid var(--color-border); transition: background-color 0.2s ease; white-space: nowrap; }
        .data-table tr:hover { background: var(--color-bg); }
        .sort-buttons { margin-left: 6px; display: inline-flex; flex-direction: column; gap: 2px; vertical-align: middle; position: relative; top: -2px; }
        .sort-btn { background: transparent; border: none; color: rgba(255,255,255,0.4); width: 16px; height: 14px; cursor: pointer; font-size: 11px; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; padding: 0; margin: 0; line-height: 1; opacity: 0.8; }
        .sort-btn:hover { color: rgba(255,255,255,0.8); opacity: 1; transform: scale(1.2); }
        .sort-btn.active { color: var(--color-primary); opacity: 1; text-shadow: 0 0 8px rgba(0,255,136,0.6); }
        .profit-positive { color: var(--color-primary); }
        .profit-negative { color: #ff6b6b; }

        @media (max-width: 1200px) {
            .container { max-width: 98%; padding: 88px var(--page-padding, 24px) 40px; }
            .stats-grid { grid-template-columns: repeat(3, 1fr); gap: 16px; }
            .charts-section { gap: 24px; }
        }
        @media (max-width: 768px) {
            .container { max-width: 100%; padding: 88px var(--page-padding, 24px) 40px; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 14px; }
            .charts-section { grid-template-columns: 1fr; gap: 20px; }
            .page-title { font-size: 28px; }
            .stat-value { font-size: 28px; }
        }
        @media (max-width: 480px) { .stats-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body class="theme-dark">
    <div id="headerContainer"></div>

    <div class="container">
        <div class="page-header">
            <h1 class="page-title" data-i18n="report.pageTitle">Êä•Ë°®</h1>
            <div class="page-view-tabs">
                <button class="page-tab active" onclick="switchViewMode('chart', this)">üìä <span data-i18n="report.views.chart">ÂõæË°®ËßÜÂõæ</span></button>
                <button class="page-tab" onclick="switchViewMode('table', this)">üìã <span data-i18n="report.views.table">Ë°®Ê†ºËßÜÂõæ</span></button>
            </div>
        </div>

        <!-- Êü•ËØ¢Êù°‰ª∂ÔºöÈÄâÊã©ÁîµÁ´ô„ÄÅÈÄâÊã©Êó∂Èó¥ -->
        <div class="time-selector-module">
            <select id="stationSelector" class="time-input" onchange="handleStationChange()" style="min-width:200px;margin-right:8px;margin-left:0;">
            </select>
            <button class="time-pill active" onclick="switchTimePeriod('day', this)" data-i18n="report.period.day">Êó•</button>
            <button class="time-pill" onclick="switchTimePeriod('month', this)" data-i18n="report.period.month">Êúà</button>
            <button class="time-pill" onclick="switchTimePeriod('year', this)" data-i18n="report.period.year">Âπ¥</button>
            <button class="time-pill" onclick="switchTimePeriod('total', this)" data-i18n="report.period.total">Á¥ØËÆ°</button>
            <div class="date-input-wrapper">
                <span id="timeSelectorDisplay" class="date-display-label"></span>
                <input type="date" id="timeSelector" class="time-input date-native-input" onchange="handleTimeInputChange()">
            </div>
            <button class="refresh-btn" onclick="refreshData()">üîÑ <span data-i18n="report.buttons.refresh">Âà∑Êñ∞</span></button>
        </div>

        <!-- 5‰∏™Ê†∏ÂøÉÊåáÊ†á -->
        <div class="stats-grid">
            <div class="stat-card card">
                <div class="stat-label" data-i18n="report.stats.charge">ÂÖÖÁîµÈáè</div>
                <div class="stat-value" id="statCharge">2.45<span class="stat-unit">MWh</span></div>
                <div class="stat-change" id="changeCharge"><span class="compare-text" data-i18n="report.compare.day">ÊØîÊò®Êó•</span> ‚Üë 0.18 MWh</div>
            </div>
            <div class="stat-card card">
                <div class="stat-label" data-i18n="report.stats.discharge">ÊîæÁîµÈáè</div>
                <div class="stat-value" id="statDischarge">2.18<span class="stat-unit">MWh</span></div>
                <div class="stat-change" id="changeDischarge"><span class="compare-text" data-i18n="report.compare.day">ÊØîÊò®Êó•</span> ‚Üë 0.15 MWh</div>
            </div>
            <div class="stat-card card">
                <div class="stat-label" data-i18n="report.stats.avgBuyPrice">ÂÖÖÁîµÂùá‰ª∑</div>
                <div class="stat-value" id="statAvgBuyPrice">$44<span class="stat-unit">/MWh</span></div>
                <div class="stat-change" id="changeAvgBuyPrice"><span class="compare-text" data-i18n="report.compare.day">ÊØîÊò®Êó•</span> ‚Üì $3</div>
            </div>
            <div class="stat-card card">
                <div class="stat-label" data-i18n="report.stats.avgSellPrice">ÊîæÁîµÂùá‰ª∑</div>
                <div class="stat-value" id="statAvgSellPrice">$240<span class="stat-unit">/MWh</span></div>
                <div class="stat-change" id="changeAvgSellPrice"><span class="compare-text" data-i18n="report.compare.day">ÊØîÊò®Êó•</span> ‚Üë $12</div>
            </div>
            <div class="stat-card card">
                <div class="stat-label" data-i18n="report.stats.netProfit">ÂáÄÂà©Ê∂¶</div>
                <div class="stat-value profit-positive" id="statNetProfit">$415</div>
                <div class="stat-change" id="changeNetProfit"><span class="compare-text" data-i18n="report.compare.day">ÊØîÊò®Êó•</span> ‚Üë $57</div>
            </div>
        </div>

        <!-- ÂõæË°®ËßÜÂõæ -->
        <div id="chartViewContent">
            <div class="charts-section" style="display:block;">
                <div class="chart-container card" style="width:100%;">
                    <div class="chart-header">
                        <div class="chart-title" id="chartTitle">ÂÖÖÊîæÁîµÈáè</div>
                    </div>
                    <div id="chargeDischargeChart" style="width:100%;height:calc(100vh - 380px);min-height:400px;"></div>
                </div>
            </div>
        </div>

        <!-- Ë°®Ê†ºËßÜÂõæ -->
        <div id="tableViewContent" style="display:none;">
            <div class="table-section">
                <div class="table-container card">
                    <div class="table-header">
                        <div class="table-title" id="tableTitle">Á´ôÁÇπÊòéÁªÜ</div>
                        <div class="table-controls">
                            <button class="export-btn" onclick="exportTableData()">üì• <span data-i18n="report.buttons.exportData">ÂØºÂá∫Êï∞ÊçÆ</span></button>
                        </div>
                    </div>
                    <div class="table-scroll-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th id="timeColumnHeader" data-i18n="report.table.period">Êó∂ÊÆµ</th>
                                    <th><span data-i18n="report.table.charge">ÂÖÖÁîµÈáè (MWh)</span><span class="sort-buttons"><button class="sort-btn" onclick="sortTable('charge','asc',this)">‚ñ≤</button><button class="sort-btn" onclick="sortTable('charge','desc',this)">‚ñº</button></span></th>
                                    <th><span data-i18n="report.table.discharge">ÊîæÁîµÈáè (MWh)</span><span class="sort-buttons"><button class="sort-btn" onclick="sortTable('discharge','asc',this)">‚ñ≤</button><button class="sort-btn" onclick="sortTable('discharge','desc',this)">‚ñº</button></span></th>
                                    <th><span data-i18n="report.table.avgBuyPrice">ÂÖÖÁîµÂùá‰ª∑ ($/MWh)</span><span class="sort-buttons"><button class="sort-btn" onclick="sortTable('avgBuyPrice','asc',this)">‚ñ≤</button><button class="sort-btn" onclick="sortTable('avgBuyPrice','desc',this)">‚ñº</button></span></th>
                                    <th><span data-i18n="report.table.avgSellPrice">ÊîæÁîµÂùá‰ª∑ ($/MWh)</span><span class="sort-buttons"><button class="sort-btn" onclick="sortTable('avgSellPrice','asc',this)">‚ñ≤</button><button class="sort-btn" onclick="sortTable('avgSellPrice','desc',this)">‚ñº</button></span></th>
                                    <th><span data-i18n="report.table.chargeCost">ÂÖÖÁîµÊàêÊú¨ ($)</span><span class="sort-buttons"><button class="sort-btn" onclick="sortTable('chargeCost','asc',this)">‚ñ≤</button><button class="sort-btn" onclick="sortTable('chargeCost','desc',this)">‚ñº</button></span></th>
                                    <th><span data-i18n="report.table.dischargeRevenue">ÊîæÁîµÊî∂Áõä ($)</span><span class="sort-buttons"><button class="sort-btn" onclick="sortTable('dischargeRevenue','asc',this)">‚ñ≤</button><button class="sort-btn" onclick="sortTable('dischargeRevenue','desc',this)">‚ñº</button></span></th>
                                    <th><span data-i18n="report.table.netProfit">ÂáÄÂà©Ê∂¶ ($)</span><span class="sort-buttons"><button class="sort-btn" onclick="sortTable('netProfit','asc',this)">‚ñ≤</button><button class="sort-btn" onclick="sortTable('netProfit','desc',this)">‚ñº</button></span></th>
                                </tr>
                            </thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                    <div id="paginationContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let chargeDischargeChart;
        let currentViewMode = 'chart', currentTimePeriod = 'day', currentRegion = 'all';
        let currentStation = '';  // ÂΩìÂâçÈÄâ‰∏≠ÁîµÁ´ô
        let tableData = [], currentPage = 1, pageSize = 10, pagination = null;
        let currentSortColumn = null, currentSortDirection = null;
        let sharedData = { rows: [], totals: {} };

        const stationNames = [
            'Sydney Solar Farm', 'Melbourne Battery Hub', 'Brisbane Energy Park',
            'Adelaide Power Station', 'Perth Grid Storage', 'Hobart Green Energy',
            'Newcastle Battery Array', 'Gold Coast Solar Storage', 'Canberra Power Grid',
            'Darwin Energy Center', 'Cairns Solar Hub', 'Townsville Battery Park'
        ];

        const regionMultipliers = { all: 1, NSW: 0.30, QLD: 0.22, VIC: 0.20, SA: 0.18, TAS: 0.10 };

        // ÂêÑÁîµÁ´ôÂÆπÈáèÊùÉÈáçÔºàÊ®°Êãü‰∏çÂêå BESS ÂÆπÈáèÂç†ÊØîÔºåÂêàËÆ° ‚âà 1.0Ôºâ
        const stationMultipliers = {
            'Sydney Solar Farm': 0.12,
            'Melbourne Battery Hub': 0.11,
            'Brisbane Energy Park': 0.10,
            'Adelaide Power Station': 0.09,
            'Perth Grid Storage': 0.08,
            'Hobart Green Energy': 0.06,
            'Newcastle Battery Array': 0.10,
            'Gold Coast Solar Storage': 0.08,
            'Canberra Power Grid': 0.07,
            'Darwin Energy Center': 0.06,
            'Cairns Solar Hub': 0.07,
            'Townsville Battery Park': 0.06
        };

        // ÂêÑÊó∂ÊÆµÂü∫Á°ÄÊï∞ÊçÆÔºöÂÖÖÁîµÈáèMWh, ÊîæÁîµÈáèMWh, ÂÖÖÁîµÂùá‰ª∑$/MWh, ÊîæÁîµÂùá‰ª∑$/MWh
        const periodBaseData = {
            day:   { charge: 2.45, discharge: 2.18, buyPrice: 44, sellPrice: 240 },
            month: { charge: 73.5, discharge: 65.4, buyPrice: 42, sellPrice: 235 },
            year:  { charge: 882, discharge: 784.8, buyPrice: 43, sellPrice: 238 },
            total: { charge: 2646, discharge: 2354.4, buyPrice: 41, sellPrice: 232 }
        };

        // ========== ÂàùÂßãÂåñ ==========
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                if (typeof HeaderNav !== 'undefined') {
                    window.headerNav = new HeaderNav({ containerId: 'headerContainer', currentPage: 'report' });
                }
                // Â°´ÂÖÖÁîµÁ´ô‰∏ãÊãâÂàóË°®ÔºåÈªòËÆ§ÈÄâ‰∏≠Á¨¨‰∏Ä‰∏™
                const stationSelect = document.getElementById('stationSelector');
                stationNames.forEach((name, idx) => {
                    const opt = document.createElement('option');
                    opt.value = name;
                    opt.textContent = name;
                    if (idx === 0) opt.selected = true;
                    stationSelect.appendChild(opt);
                });
                currentStation = stationNames[0];

                const today = new Date();
                const timeInput = document.getElementById('timeSelector');
                if (timeInput) { timeInput.type = 'date'; timeInput.value = today.toISOString().split('T')[0]; }
                updateDateDisplay();

                generateSharedData();
                updateStats();
                initAllCharts();
                generateTableData();

                if (window.i18n) {
                    window.i18n.addObserver(() => { updateDateDisplay(); generateSharedData(); updateStats(); refreshCharts(); generateTableData(); loadTableData(); });
                    setTimeout(() => { if (window.i18n.updatePageTexts) window.i18n.updatePageTexts(); }, 100);
                }

                window.addEventListener('resize', () => {
                    [chargeDischargeChart].forEach(c => {
                        if (c && !c.isDisposed()) c.resize();
                    });
                });
            }, 200);
        });

        // ========== ÊéßÂà∂ÂáΩÊï∞ ==========
        function handleStationChange() { currentStation = document.getElementById('stationSelector').value; refreshData(); }
        function handleRegionChange() { currentRegion = document.getElementById('regionSelector').value; refreshData(); }
        function handleTimeInputChange() { updateDateDisplay(); refreshData(); }

        // Ê†πÊçÆ i18n ËØ≠Ë®ÄÊ†ºÂºèÂåñÊó•ÊúüÊòæÁ§∫
        function updateDateDisplay() {
            const timeInput = document.getElementById('timeSelector');
            const displayLabel = document.getElementById('timeSelectorDisplay');
            const wrapper = timeInput.closest('.date-input-wrapper');
            if (!displayLabel || !timeInput) return;
            const isEn = window.i18n && window.i18n.getCurrentLanguage() === 'en';
            const monthNamesEn = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

            if (currentTimePeriod === 'total' || timeInput.disabled) {
                wrapper.classList.add('disabled');
                wrapper.style.display = 'none';
                return;
            }
            wrapper.classList.remove('disabled');
            wrapper.style.display = 'inline-block';

            const val = timeInput.value;
            if (!val) { displayLabel.textContent = '‚Äî'; return; }

            if (currentTimePeriod === 'day') {
                // val = "2026-02-10"
                const [y, m, d] = val.split('-').map(Number);
                displayLabel.textContent = isEn
                    ? `${monthNamesEn[m - 1]} ${d}, ${y}`
                    : `${y}Âπ¥${String(m).padStart(2,'0')}Êúà${String(d).padStart(2,'0')}Êó•`;
            } else if (currentTimePeriod === 'month') {
                // val = "2026-02"
                const [y, m] = val.split('-').map(Number);
                displayLabel.textContent = isEn
                    ? `${monthNamesEn[m - 1]} ${y}`
                    : `${y}Âπ¥${String(m).padStart(2,'0')}Êúà`;
            } else if (currentTimePeriod === 'year') {
                displayLabel.textContent = val;
            }
        }

        function switchTimePeriod(period, el) {
            currentTimePeriod = period;
            document.querySelectorAll('.time-pill').forEach(p => p.classList.remove('active'));
            el.classList.add('active');
            const timeInput = document.getElementById('timeSelector');
            const today = new Date();
            if (period === 'total') { timeInput.disabled = true; }
            else {
                timeInput.disabled = false;
                if (period === 'day') { timeInput.type = 'date'; timeInput.value = today.toISOString().split('T')[0]; }
                else if (period === 'month') { timeInput.type = 'month'; timeInput.value = today.getFullYear() + '-' + String(today.getMonth()+1).padStart(2,'0'); }
                else { timeInput.type = 'number'; timeInput.min = 2020; timeInput.max = 2030; timeInput.value = today.getFullYear(); }
            }
            updateDateDisplay();
            refreshData();
        }

        function switchViewMode(mode, el) {
            currentViewMode = mode;
            document.querySelectorAll('.page-tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('chartViewContent').style.display = mode === 'chart' ? 'block' : 'none';
            document.getElementById('tableViewContent').style.display = mode === 'table' ? 'block' : 'none';
            if (mode === 'chart') setTimeout(() => refreshCharts(), 100);
            else { generateTableData(); if (!pagination) initializePagination(); else refreshTableData(); }
        }


        // ========== Êï∞ÊçÆÂà∑Êñ∞ ==========
        function refreshData() {
            generateSharedData();
            updateStats();
            if (currentViewMode === 'chart') refreshCharts();
            else refreshTableData();
        }

        function getMultiplier() { return stationMultipliers[currentStation] || 0.08; }

        // ========== Áªü‰∏ÄÊï∞ÊçÆÊ∫êÔºöÁîüÊàê‰∏ÄÊ¨°Ôºå‰∏âÂ§ÑÂÖ±‰∫´ ==========
        function generateSharedData() {
            const base = periodBaseData[currentTimePeriod];
            const m = getMultiplier();
            const totalCharge = base.charge * m;
            const totalDischarge = base.discharge * m;
            const isEn = window.i18n && window.i18n.getCurrentLanguage() === 'en';
            const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

            let labels, cWeights, dWeights;
            if (currentTimePeriod === 'day') {
                labels = Array.from({length:24}, (_,i) => `${i.toString().padStart(2,'0')}:00`);
                cWeights = hourlyChargeWeight; dWeights = hourlyDischargeWeight;
            } else if (currentTimePeriod === 'month') {
                const now = new Date();
                const days = new Date(now.getFullYear(), now.getMonth()+1, 0).getDate();
                labels = Array.from({length:days}, (_,i) => isEn ? `Day ${i+1}` : `${i+1}Êó•`);
                const w = 1/days; cWeights = Array(days).fill(w); dWeights = Array(days).fill(w);
            } else if (currentTimePeriod === 'year') {
                labels = Array.from({length:12}, (_,i) => isEn ? monthNames[i] : `${i+1}Êúà`);
                cWeights = monthlyWeight; dWeights = monthlyWeight;
            } else {
                labels = ['2021','2022','2023','2024','2025'];
                cWeights = [0.12,0.16,0.20,0.24,0.28]; dWeights = [0.12,0.16,0.20,0.24,0.28];
            }

            const rows = [];
            labels.forEach((label, idx) => {
                const charge = +(totalCharge * cWeights[idx] * (0.85 + Math.random()*0.3)).toFixed(2);
                const discharge = +(totalDischarge * dWeights[idx] * (0.85 + Math.random()*0.3)).toFixed(2);
                let avgBuyPrice, avgSellPrice;
                if (currentTimePeriod === 'day') {
                    const h = idx;
                    const buyVar = h < 6 ? 0.6+Math.random()*0.3 : h > 16 ? 1.0+Math.random()*0.3 : 0.8+Math.random()*0.3;
                    const sellVar = h < 6 ? 0.5+Math.random()*0.3 : h > 16 ? 1.1+Math.random()*0.4 : 0.8+Math.random()*0.3;
                    avgBuyPrice = +(base.buyPrice * buyVar).toFixed(1);
                    avgSellPrice = +(base.sellPrice * sellVar).toFixed(1);
                } else {
                    avgBuyPrice = +(base.buyPrice * (0.85+Math.random()*0.3)).toFixed(1);
                    avgSellPrice = +(base.sellPrice * (0.85+Math.random()*0.3)).toFixed(1);
                }
                const chargeCost = Math.round(charge * avgBuyPrice);
                const dischargeRevenue = Math.round(discharge * avgSellPrice);
                const netProfit = dischargeRevenue - chargeCost;
                rows.push({ timeLabel: label, charge, discharge, avgBuyPrice, avgSellPrice, chargeCost, dischargeRevenue, netProfit });
            });

            const agg = rows.reduce((s,r) => ({
                charge: s.charge+r.charge, discharge: s.discharge+r.discharge,
                cost: s.cost+r.chargeCost, revenue: s.revenue+r.dischargeRevenue, profit: s.profit+r.netProfit
            }), {charge:0, discharge:0, cost:0, revenue:0, profit:0});
            agg.avgBuyPrice = agg.charge > 0 ? +(agg.cost/agg.charge).toFixed(1) : base.buyPrice;
            agg.avgSellPrice = agg.discharge > 0 ? +(agg.revenue/agg.discharge).toFixed(1) : base.sellPrice;

            sharedData = { rows, totals: agg };
        }

        // ========== ÊåáÊ†áÂç°Ôºö‰ªé sharedData.totals ËØªÂèñ ==========
        function updateStats() {
            const totals = sharedData.totals;
            document.getElementById('statCharge').innerHTML = totals.charge.toFixed(1) + '<span class="stat-unit">MWh</span>';
            document.getElementById('statDischarge').innerHTML = totals.discharge.toFixed(1) + '<span class="stat-unit">MWh</span>';
            document.getElementById('statAvgBuyPrice').innerHTML = '$' + Math.round(totals.avgBuyPrice) + '<span class="stat-unit">/MWh</span>';
            document.getElementById('statAvgSellPrice').innerHTML = '$' + Math.round(totals.avgSellPrice) + '<span class="stat-unit">/MWh</span>';
            const profitEl = document.getElementById('statNetProfit');
            profitEl.textContent = '$' + totals.profit.toLocaleString();
            profitEl.className = 'stat-value ' + (totals.profit >= 0 ? 'profit-positive' : 'profit-negative');

            const t = (k, f) => window.i18n ? window.i18n.getText(k) : f;
            const compareTexts = {
                day: t('report.compare.day', 'ÊØîÊò®Êó•'),
                month: t('report.compare.month', 'ÊØî‰∏äÊúà'),
                year: t('report.compare.year', 'ÊØîÂéªÂπ¥'),
                total: ''
            };
            document.querySelectorAll('.compare-text').forEach(el => el.textContent = compareTexts[currentTimePeriod]);
            document.querySelectorAll('.stat-change').forEach(el => el.style.display = currentTimePeriod === 'total' ? 'none' : 'block');
        }

        // ========== ÂõæË°® ==========
        function initAllCharts() { initChargeDischargeChart(); }
        function refreshCharts() { if (currentViewMode === 'chart') setTimeout(() => initAllCharts(), 100); }

        // ÂõæË°®ÈÄöÁî®tooltipÊ†∑Âºè
        const tooltipStyle = { backgroundColor: 'rgba(0,0,0,0.9)', borderColor: 'rgba(255,255,255,0.1)', textStyle: { color: '#fff' } };
        const axisLineStyle = { lineStyle: { color: 'rgba(255,255,255,0.08)' } };
        const splitLineStyle = { lineStyle: { color: 'rgba(255,255,255,0.08)', type: 'dashed' } };
        const axisLabelStyle = { color: 'rgba(255,255,255,0.6)', fontSize: 11 };

        // ÂÖÖÊîæÁîµÈáè + Á¥ØËÆ°ÂáÄÂà©Ê∂¶ÂõæË°®Ôºà‰ªé sharedData ËØªÂèñÔºâ
        function initChargeDischargeChart() {
            const dom = document.getElementById('chargeDischargeChart');
            if (chargeDischargeChart) chargeDischargeChart.dispose();
            chargeDischargeChart = echarts.init(dom);

            const rows = sharedData.rows;
            if (!rows.length) return;

            const t = (k, f) => window.i18n ? window.i18n.getText(k) : f;
            const labelCharge = t('report.chart.charge', 'ÂÖÖÁîµÈáè');
            const labelDischarge = t('report.chart.discharge', 'ÊîæÁîµÈáè');
            const labelCumProfit = t('report.chart.cumProfit', 'Á¥ØËÆ°ÂáÄÂà©Ê∂¶');

            const labels = rows.map(r => r.timeLabel);
            const chargeData = rows.map(r => r.charge);
            const dischargeData = rows.map(r => r.discharge);

            // Á¥ØËÆ°ÂáÄÂà©Ê∂¶ÔºöÈÄêË°åÁ¥ØÂä† netProfitÔºåÊúÄÁªàÂÄº === ÊåáÊ†áÂç°ÂáÄÂà©Ê∂¶ === Ë°®Ê†ºÂêàËÆ°ÂáÄÂà©Ê∂¶
            let cum = 0;
            const cumProfitData = rows.map(r => { cum += r.netProfit; return Math.round(cum); });

            const titleEl = document.getElementById('chartTitle');
            if (titleEl) titleEl.textContent = (currentStation || '') + ' ‚Äî ' + labelCharge + ' & ' + labelCumProfit;

            const rotateLabel = labels.length > 15;

            chargeDischargeChart.setOption({
                tooltip: {
                    ...tooltipStyle, trigger: 'axis',
                    formatter: p => {
                        let html = `<div style="font-weight:600;margin-bottom:6px;">${p[0].axisValue}</div>`;
                        p.forEach(i => {
                            if (i.seriesName === labelCumProfit) {
                                html += `${i.marker} ${i.seriesName}: <b>$${i.value.toLocaleString()}</b><br/>`;
                            } else {
                                html += `${i.marker} ${i.seriesName}: <b>${i.value.toLocaleString()} MWh</b><br/>`;
                            }
                        });
                        return html;
                    }
                },
                legend: { data: [labelCharge, labelDischarge, labelCumProfit], textStyle: { color: 'rgba(255,255,255,0.6)', fontSize: 13 }, top: 0, itemGap: 24 },
                grid: { left: '3%', right: '4%', bottom: rotateLabel ? '12%' : '5%', top: '10%', containLabel: true },
                xAxis: { type: 'category', data: labels, axisLine: axisLineStyle, axisLabel: { ...axisLabelStyle, rotate: rotateLabel ? 45 : 0, fontSize: rotateLabel ? 10 : 12 } },
                yAxis: [
                    { type: 'value', name: 'MWh', nameTextStyle: axisLabelStyle, axisLine: axisLineStyle, axisLabel: axisLabelStyle, splitLine: splitLineStyle },
                    { type: 'value', name: '$', nameTextStyle: axisLabelStyle, axisLine: axisLineStyle, axisLabel: { ...axisLabelStyle, formatter: v => '$' + v.toLocaleString() }, splitLine: { show: false } }
                ],
                dataZoom: labels.length > 24 ? [{ type: 'inside', start: 0, end: 100 }, { type: 'slider', bottom: 5, height: 20, borderColor: 'rgba(255,255,255,0.1)', fillerColor: 'rgba(0,255,136,0.15)', textStyle: { color: 'rgba(255,255,255,0.5)' } }] : [],
                series: [
                    {
                        name: labelCharge, type: 'bar', yAxisIndex: 0, data: chargeData, barGap: '15%',
                        itemStyle: { color: new echarts.graphic.LinearGradient(0,0,0,1,[{offset:0,color:'#1e7fff'},{offset:1,color:'rgba(30,127,255,0.2)'}]), borderRadius: [3,3,0,0] }
                    },
                    {
                        name: labelDischarge, type: 'bar', yAxisIndex: 0, data: dischargeData,
                        itemStyle: { color: new echarts.graphic.LinearGradient(0,0,0,1,[{offset:0,color:'#00ff88'},{offset:1,color:'rgba(0,255,136,0.2)'}]), borderRadius: [3,3,0,0] }
                    },
                    {
                        name: labelCumProfit, type: 'line', yAxisIndex: 1, data: cumProfitData, smooth: true, symbol: 'circle', symbolSize: 5,
                        lineStyle: { color: '#ffd700', width: 2.5 },
                        itemStyle: { color: '#ffd700', borderColor: '#fff', borderWidth: 1 },
                        areaStyle: { color: new echarts.graphic.LinearGradient(0,0,0,1,[{offset:0,color:'rgba(255,215,0,0.25)'},{offset:1,color:'rgba(255,215,0,0.02)'}]) }
                    }
                ]
            });
        }

        // ========== Ë°®Ê†º ==========
        function sortTable(col, dir, el) {
            document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
            if (currentSortColumn === col && currentSortDirection === dir) { currentSortColumn = null; currentSortDirection = null; generateTableData(); }
            else { currentSortColumn = col; currentSortDirection = dir; el.classList.add('active'); tableData.sort((a,b) => dir === 'asc' ? a[col] - b[col] : b[col] - a[col]); }
            loadTableData();
        }
        function exportTableData() {  }

        function initializePagination() {
            pagination = new Pagination({ containerId: 'paginationContainer', currentPage, pageSize, totalItems: tableData.length, onPageChange: p => { currentPage = p; loadTableData(); }, onPageSizeChange: s => { pageSize = s; currentPage = 1; loadTableData(); } });
            loadTableData();
        }

        // Â∞èÊó∂Á∫ßÂÖÖÊîæÁîµÂàÜÂ∏ÉÊùÉÈáçÔºàÊ®°ÊãüÁúüÂÆû BESS Ë∞ÉÂ∫¶ÔºöÂáåÊô®‰Ωé‰ª∑ÂÖÖÁîµÔºåÂÇçÊôöÈ´ò‰ª∑ÊîæÁîµÔºâ
        const hourlyChargeWeight = [0.08,0.08,0.09,0.09,0.08,0.06,0.04,0.02,0.01,0.01,0.01,0.01,0.01,0.02,0.02,0.03,0.03,0.03,0.04,0.04,0.05,0.05,0.06,0.07];
        const hourlyDischargeWeight = [0.01,0.01,0.01,0.01,0.01,0.01,0.02,0.03,0.04,0.04,0.03,0.03,0.03,0.04,0.05,0.06,0.08,0.09,0.09,0.08,0.06,0.05,0.04,0.02];
        // ÊúàÁ∫ßÊùÉÈáçÔºàÂ§èÂ≠£Áî®ÁîµÈ´òÂ≥∞Êî∂ÁõäÊõ¥È´òÔºâ
        const monthlyWeight = [0.07,0.07,0.08,0.08,0.08,0.09,0.10,0.10,0.09,0.08,0.08,0.08];

        // Ë°®Ê†ºÁõ¥Êé•ËØªÂèñ sharedDataÔºå‰∏çÂÜçÁã¨Á´ãÁîüÊàêÊï∞ÊçÆ
        function generateTableData() {
            const t = (k, f) => window.i18n ? window.i18n.getText(k) : f;
            const titleEl = document.getElementById('tableTitle');
            if (titleEl) titleEl.textContent = currentStation || t('report.table.title', 'Á´ôÁÇπÊòéÁªÜ');
            const headerEl = document.getElementById('timeColumnHeader');
            if (headerEl) {
                const headerMap = {
                    day: t('report.table.period', 'Êó∂ÊÆµ'),
                    month: t('report.table.dateCol', 'Êó•Êúü'),
                    year: t('report.table.monthCol', 'Êúà‰ªΩ'),
                    total: t('report.table.yearCol', 'Âπ¥‰ªΩ')
                };
                headerEl.textContent = headerMap[currentTimePeriod] || t('report.table.period', 'Êó∂ÊÆµ');
            }
            tableData = sharedData.rows;
        }

        function loadTableData() {
            const tbody = document.getElementById('tableBody');
            if (!tbody) return;
            tbody.innerHTML = '';
            const t = (k, f) => window.i18n ? window.i18n.getText(k) : f;
            if (!tableData.length) { generateTableData(); if (!tableData.length) { tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;padding:40px;color:var(--color-text-secondary);">${t('report.table.noData', 'ÊöÇÊó†Êï∞ÊçÆ')}</td></tr>`; return; } }

            const start = (currentPage-1)*pageSize, end = Math.min(start+pageSize, tableData.length);
            const pageData = tableData.slice(start, end);

            pageData.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="white-space:nowrap;font-weight:500;">${row.timeLabel}</td>
                    <td>${row.charge.toFixed(2)}</td>
                    <td>${row.discharge.toFixed(2)}</td>
                    <td>$${row.avgBuyPrice.toFixed(1)}</td>
                    <td>$${row.avgSellPrice.toFixed(1)}</td>
                    <td>$${row.chargeCost.toLocaleString()}</td>
                    <td>$${row.dischargeRevenue.toLocaleString()}</td>
                    <td class="${row.netProfit>=0?'profit-positive':'profit-negative'}">$${row.netProfit.toLocaleString()}</td>`;
                tbody.appendChild(tr);
            });

            // ÂêàËÆ°Ë°å
            const totals = tableData.reduce((s,r) => ({ charge:s.charge+r.charge, discharge:s.discharge+r.discharge, cost:s.cost+r.chargeCost, revenue:s.revenue+r.dischargeRevenue, profit:s.profit+r.netProfit }), {charge:0,discharge:0,cost:0,revenue:0,profit:0});
            const avgBuy = totals.charge > 0 ? (totals.cost / totals.charge).toFixed(1) : '0.0';
            const avgSell = totals.discharge > 0 ? (totals.revenue / totals.discharge).toFixed(1) : '0.0';
            const totalRow = document.createElement('tr');
            totalRow.style.borderTop = '2px solid var(--color-border)';
            totalRow.style.background = 'var(--color-bg)';
            totalRow.innerHTML = `
                <td style="text-align:center;font-weight:600;color:var(--color-primary);">${t('report.table.total', 'ÂêàËÆ°')}</td>
                <td style="font-weight:600;">${totals.charge.toFixed(2)}</td>
                <td style="font-weight:600;">${totals.discharge.toFixed(2)}</td>
                <td style="font-weight:600;">$${avgBuy}</td>
                <td style="font-weight:600;">$${avgSell}</td>
                <td style="font-weight:600;">$${totals.cost.toLocaleString()}</td>
                <td style="font-weight:600;">$${totals.revenue.toLocaleString()}</td>
                <td class="${totals.profit>=0?'profit-positive':'profit-negative'}" style="font-weight:600;">$${totals.profit.toLocaleString()}</td>`;
            tbody.appendChild(totalRow);
        }

        function refreshTableData() {
            generateTableData(); currentPage = 1;
            if (pagination) pagination = new Pagination({ containerId:'paginationContainer', currentPage:1, pageSize, totalItems:tableData.length, onPageChange:p=>{currentPage=p;loadTableData();}, onPageSizeChange:s=>{pageSize=s;currentPage=1;loadTableData();} });
            loadTableData();
        }
    </script>
    <script src="page-transition.js"></script>
</body>
</html>
