<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <link rel="stylesheet" href="design-system.css">
    <script src="page-transition.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ËÉΩÊ∫êÁÆ°ÁêÜ‰∏≠ÂøÉ</title>
    <script src="vendor/echarts.min.js"></script>
    <link rel="stylesheet" href="components/common-styles.css">
    <link rel="stylesheet" href="components/time-selector.css">
    <link rel="stylesheet" href="components/i18n.css">
    <link rel="stylesheet" href="components/notification-center.css">
    <link rel="stylesheet" href="components/header-nav.css">
    <link rel="stylesheet" href="components/drawer-component.css">
    <link rel="stylesheet" href="components/user-dropdown.css">
    <script src="components/time-selector.js"></script>
    <script src="components/i18n.js"></script>
    <script src="components/simple-message-icon.js"></script>
    <script src="components/user-dropdown-simple-new.js"></script>
    <script src="components/header-nav.js"></script>
    <script src="components/drawer-component.js"></script>
    <script src="components/condition-settings-modal.js?v=1.2"></script>
    <script src="components/global-notifications.js"></script>
    <style>
        /* SOC Modal Slider Styles */
        #socEditModal input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            cursor: pointer;
        }
        
        #socEditModal input[type="range"]::-webkit-slider-track {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        #socEditModal input[type="range"]::-moz-range-track {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        #socEditModal input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: radial-gradient(circle at 30% 30%, #00ff88, #00cc6a);
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3), inset 0 1px 2px rgba(255, 255, 255, 0.3);
            transition: all 0.15s ease;
            margin-top: -6px;
        }
        
        #socEditModal input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: radial-gradient(circle at 30% 30%, #00ff88, #00cc6a);
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3), inset 0 1px 2px rgba(255, 255, 255, 0.3);
            transition: all 0.15s ease;
        }
        
        #modalChargeSOCSlider::-webkit-slider-thumb {
            background: radial-gradient(circle at 30% 30%, #00ff88, #00cc6a);
        }
        
        #modalChargeSOCSlider::-moz-range-thumb {
            background: radial-gradient(circle at 30% 30%, #00ff88, #00cc6a);
        }
        
        #modalDischargeSOCSlider::-webkit-slider-thumb {
            background: radial-gradient(circle at 30% 30%, #ffc107, #ff9800);
        }
        
        #modalDischargeSOCSlider::-moz-range-thumb {
            background: radial-gradient(circle at 30% 30%, #ffc107, #ff9800);
        }
        
        #socEditModal input[type="range"]:hover::-webkit-slider-thumb {
            transform: scale(1.15);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4), inset 0 1px 2px rgba(255, 255, 255, 0.4);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        #socEditModal input[type="range"]:hover::-moz-range-thumb {
            transform: scale(1.15);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4), inset 0 1px 2px rgba(255, 255, 255, 0.4);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        #socEditModal input[type="range"]:active::-webkit-slider-thumb {
            transform: scale(1.05);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.4), inset 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        
        #socEditModal input[type="range"]:active::-moz-range-thumb {
            transform: scale(1.05);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.4), inset 0 1px 2px rgba(0, 0, 0, 0.2);
        }


        /* ÂèØÊãñÊãΩÂú∞Âå∫Êù°‰ª∂ÊÄªËßàÂç°ÁâáÊ†∑Âºè */
        .draggable-region-overview-card {
            position: fixed;
            top: 120px;
            left: 20px;
            width: 900px;
            max-height: 400px;
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(30px) saturate(1.5);
            -webkit-backdrop-filter: blur(30px) saturate(1.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 20px;
            z-index: 1000;
            cursor: move;
            user-select: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .draggable-region-overview-card:hover {
            transform: scale(1.01);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }

        .region-overview-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .region-overview-title {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: #fff;
            background: linear-gradient(135deg, #00ff88, #00cc6a);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .region-overview-minimize-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .region-overview-minimize-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        .region-overview-content {
            max-height: 320px;
            overflow-y: auto;
            overflow-x: auto;
        }

        .region-overview-content::-webkit-scrollbar {
            width: 6px;
        }

        .region-overview-content::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
        }

        .region-overview-content::-webkit-scrollbar-thumb {
            background: rgba(0, 255, 136, 0.3);
            border-radius: 6px;
        }

        .region-overview-body {
            width: 100%;
            overflow-x: auto;
        }

        /* ÊäòÂè†ÂºèÂú∞Âå∫È°πÊ†∑Âºè */
        .region-accordion-item {
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            overflow: hidden;
            transition: all 0.3s;
        }

        .region-accordion-item:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.15);
        }

        .region-accordion-header {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
            transition: all 0.3s;
        }

        .region-accordion-header:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .region-accordion-title {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .region-accordion-arrow {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s;
            color: rgba(255, 255, 255, 0.6);
        }

        .region-accordion-item.expanded .region-accordion-arrow {
            transform: rotate(180deg);
        }

        .region-accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background: rgba(0, 0, 0, 0.2);
        }

        .region-accordion-item.expanded .region-accordion-content {
            max-height: 300px;
        }

        .region-conditions-grid {
            padding: 16px;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        /* Ë°®Ê†ºÊ†∑Âºè */
        .region-comparison-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 12px;
        }

        .region-comparison-table th,
        .region-comparison-table td {
            padding: 10px 12px;
            text-align: left;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .region-comparison-table th {
            background: rgba(255, 255, 255, 0.08);
            color: #fff;
            font-weight: 600;
            font-size: 13px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .region-comparison-table th:first-child {
            border-top-left-radius: 8px;
        }

        .region-comparison-table th:last-child {
            border-top-right-radius: 8px;
        }

        .region-comparison-table tr:hover td {
            background: rgba(255, 255, 255, 0.03);
        }

        .region-comparison-table td {
            background: rgba(255, 255, 255, 0.02);
            color: rgba(255, 255, 255, 0.8);
            transition: all 0.2s;
        }

        .region-comparison-table tbody tr:last-child td:first-child {
            border-bottom-left-radius: 8px;
        }

        .region-comparison-table tbody tr:last-child td:last-child {
            border-bottom-right-radius: 8px;
        }

        /* Âú∞Âå∫ÂêçÁß∞Âàó */
        .region-name-cell {
            font-weight: 600;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .region-status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
            position: relative;
        }

        .region-status-indicator.charging {
            background: #00ff88;
            box-shadow: 0 0 8px rgba(0, 255, 136, 0.8);
            animation: pulseGreen 2s ease-in-out infinite;
        }

        .region-status-indicator.discharging {
            background: #ffc107;
            box-shadow: 0 0 8px rgba(255, 193, 7, 0.8);
            animation: pulseYellow 2s ease-in-out infinite;
        }

        .region-status-indicator.idle {
            background: rgba(255, 255, 255, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        @keyframes pulseGreen {
            0%, 100% {
                box-shadow: 0 0 8px rgba(0, 255, 136, 0.8);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 0 16px rgba(0, 255, 136, 1);
                transform: scale(1.1);
            }
        }

        @keyframes pulseYellow {
            0%, 100% {
                box-shadow: 0 0 8px rgba(255, 193, 7, 0.8);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 0 16px rgba(255, 193, 7, 1);
                transform: scale(1.1);
            }
        }

        /* Êù°‰ª∂ÂçïÂÖÉÊ†º */
        .condition-cell {
            font-size: 11px;
            line-height: 1.4;
        }

        .condition-value {
            color: #fff;
            font-weight: 500;
        }

        .condition-label {
            color: rgba(255, 255, 255, 0.6);
            font-size: 10px;
        }

        /* Êù°‰ª∂ÈÉ®ÂàÜÊ†∑Âºè */
        .condition-section {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            padding: 12px;
        }

        .condition-title {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .condition-title.charge {
            color: #00ff88;
        }

        .condition-title.discharge {
            color: #ffc107;
        }

        .condition-details {
            font-size: 11px;
            line-height: 1.6;
        }

        .condition-detail-item {
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .condition-detail-item .condition-label {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
        }

        .condition-detail-item .condition-value {
            font-size: 12px;
            color: #fff;
            font-weight: 500;
        }

        /* Ë°®Â§¥Ê†∑Âºè */
        .table-header-charge {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.15), rgba(0, 255, 136, 0.05));
            color: #00ff88;
        }

        .table-header-discharge {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.15), rgba(255, 193, 7, 0.05));
            color: #ffc107;
        }

        /* Áº©Â∞èÁä∂ÊÄÅÊ†∑Âºè */
        .draggable-region-overview-card.minimized {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            padding: 0;
            overflow: hidden;
            background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
            border: 2px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 8px 25px rgba(0, 255, 136, 0.4), 
                        0 0 0 1px rgba(0, 255, 136, 0.3),
                        inset 0 1px 0 rgba(255, 255, 255, 0.3);
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
        }

        .draggable-region-overview-card.minimized:hover {
            transform: scale(1.15);
            box-shadow: 0 12px 35px rgba(0, 255, 136, 0.6), 
                        0 0 0 2px rgba(0, 255, 136, 0.5),
                        inset 0 1px 0 rgba(255, 255, 255, 0.4);
            border-color: rgba(255, 255, 255, 1);
        }

        .draggable-region-overview-card.minimized .region-overview-header,
        .draggable-region-overview-card.minimized .region-overview-content {
            display: none;
        }

        .draggable-region-overview-card.minimized::before {
            content: 'üåè';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        /* Áº©Â∞èÁä∂ÊÄÅËÑâÂÜ≤Âä®Áîª */
        @keyframes regionOverviewPulse {
            0%, 100% {
                box-shadow: 0 8px 25px rgba(0, 255, 136, 0.4), 
                            0 0 0 1px rgba(0, 255, 136, 0.3),
                            inset 0 1px 0 rgba(255, 255, 255, 0.3);
            }
            50% {
                box-shadow: 0 12px 35px rgba(0, 255, 136, 0.6), 
                            0 0 0 2px rgba(0, 255, 136, 0.4),
                            inset 0 1px 0 rgba(255, 255, 255, 0.4);
            }
        }

        .draggable-region-overview-card.minimized {
            animation: regionOverviewPulse 3s ease-in-out infinite;
        }

        .draggable-region-overview-card.minimized:hover {
            animation: none;
        }
        
        /* Ëá™Âä®Êù°‰ª∂ÊåâÈíÆÊÇ¨ÂÅúÊïàÊûú */
        .auto-condition-btn {
            position: relative;
            overflow: hidden;
        }
        .auto-condition-btn:hover {
            background: rgba(255, 255, 255, 0.12) !important;
            color: rgba(255, 255, 255, 0.95) !important;
            border-color: rgba(255, 255, 255, 0.2) !important;
            transform: scale(1.08);
        }
        .auto-condition-btn:active {
            transform: scale(0.95);
        }
        /* ÂúÜÂΩ¢ÊåâÈíÆÈÄâ‰∏≠Áä∂ÊÄÅÁöÑÁéØÂΩ¢ÊïàÊûú */
        /* Êú∫Âô®‰∫∫ÁéØÁªïÂ§ßÂúÜÂä®Áîª */
        @keyframes orbitRobot {
            0%   { transform: rotate(0deg)   translateX(108px) rotate(0deg); }
            100% { transform: rotate(360deg) translateX(108px) rotate(-360deg); }
        }
        @keyframes robotGlow {
            0%, 100% { filter: drop-shadow(0 0 4px rgba(0,255,136,0.4)); }
            50%      { filter: drop-shadow(0 0 10px rgba(0,255,136,0.8)); }
        }
        #aiOrbitRobot {
            position: absolute;
            top: 50%; left: 50%;
            width: 28px; height: 28px;
            margin: -14px 0 0 -14px;
            animation: orbitRobot 6s linear infinite, robotGlow 2s ease-in-out infinite;
            pointer-events: none;
            z-index: 25;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        #aiOrbitRobot.active {
            opacity: 1;
        }
        /* ÁéØÁªïËΩ®ÈÅìÂÖâÁéØ */
        #aiOrbitTrack {
            position: absolute;
            top: 50%; left: 50%;
            width: 216px; height: 216px;
            margin: -108px 0 0 -108px;
            border-radius: 50%;
            border: 1px dashed rgba(0,255,136,0.15);
            pointer-events: none;
            z-index: 5;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        #aiOrbitTrack.active {
            opacity: 1;
        }

        /* ÁøªÁâåÂÄíËÆ°Êó∂Âô® */
        .flip-clock {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            margin-top: 5px;
        }
        .flip-clock .flip-separator {
            font-size: 14px;
            font-weight: 700;
            color: rgba(0,255,136,0.5);
            line-height: 28px;
        }
        .flip-clock .flip-group {
            display: flex;
            gap: 2px;
        }
        .flip-clock .flip-label {
            font-size: 9px;
            color: rgba(255,255,255,0.3);
            text-align: center;
            margin-top: 2px;
        }
        .flip-card {
            position: relative;
            width: 22px;
            height: 28px;
            perspective: 200px;
        }
        .flip-card .flip-top,
        .flip-card .flip-bottom {
            position: absolute;
            left: 0;
            width: 100%;
            height: 50%;
            overflow: hidden;
            backface-visibility: hidden;
        }
        .flip-card .flip-top {
            top: 0;
            background: linear-gradient(180deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.04) 100%);
            border-radius: 6px 4px 0 0;
            border-bottom: 1px solid rgba(0,0,0,0.3);
        }
        .flip-card .flip-bottom {
            bottom: 0;
            background: linear-gradient(180deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0.06) 100%);
            border-radius: 0 0 4px 4px;
        }
        .flip-card .flip-top .flip-digit,
        .flip-card .flip-bottom .flip-digit {
            position: absolute;
            left: 0;
            width: 100%;
            height: 28px;
            line-height: 28px;
            text-align: center;
            font-size: 16px;
            font-weight: 700;
            font-family: 'SF Mono', 'Menlo', monospace;
            color: rgba(0,255,136,0.9);
        }
        .flip-card .flip-top .flip-digit {
            top: 0;
        }
        .flip-card .flip-bottom .flip-digit {
            bottom: 0;
        }
        /* ÁøªËΩ¨Âä®Áîª - ‰∏äÂçäÁâáÂæÄ‰∏ãÁøª */
        .flip-card .flip-front {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 50%;
            overflow: hidden;
            background: linear-gradient(180deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.04) 100%);
            border-radius: 6px 4px 0 0;
            transform-origin: bottom center;
            backface-visibility: hidden;
            z-index: 5;
        }
        .flip-card .flip-front .flip-digit {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 28px;
            line-height: 28px;
            text-align: center;
            font-size: 16px;
            font-weight: 700;
            font-family: 'SF Mono', 'Menlo', monospace;
            color: rgba(0,255,136,0.9);
        }
        .flip-card .flip-back {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 50%;
            overflow: hidden;
            background: linear-gradient(180deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0.06) 100%);
            border-radius: 0 0 4px 4px;
            transform-origin: top center;
            transform: rotateX(180deg);
            backface-visibility: hidden;
            z-index: 5;
        }
        .flip-card .flip-back .flip-digit {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 28px;
            line-height: 28px;
            text-align: center;
            font-size: 16px;
            font-weight: 700;
            font-family: 'SF Mono', 'Menlo', monospace;
            color: rgba(0,255,136,0.9);
        }
        .flip-card.flipping .flip-front {
            animation: flipDown 0.5s ease-in forwards;
        }
        .flip-card.flipping .flip-back {
            animation: flipUp 0.5s ease-out 0.25s forwards;
        }
        @keyframes flipDown {
            0%   { transform: rotateX(0deg); }
            100% { transform: rotateX(-180deg); }
        }
        @keyframes flipUp {
            0%   { transform: rotateX(180deg); }
            100% { transform: rotateX(0deg); }
        }

        @keyframes autoConditionRing {
            0% {
                box-shadow: 0 0 0 4px rgba(0, 255, 136, 0.1);
            }
            50% {
                box-shadow: 0 0 0 6px rgba(0, 255, 136, 0.15);
            }
            100% {
                box-shadow: 0 0 0 4px rgba(0, 255, 136, 0.1);
            }
        }
        .auto-condition-btn.selected {
            animation: autoConditionRing 2s ease-in-out infinite;
        }
        
        /* ÊäòÂè†ÂºèÂú∞Âå∫È°πÊ†∑Âºè */
        .region-accordion-container {
            width: 100%;
        }
        .region-accordion-item {
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            overflow: hidden;
            transition: all 0.3s;
        }
        .region-accordion-item:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.15);
        }
        .region-accordion-item.expanded {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(0, 255, 136, 0.3);
        }
        .region-accordion-header {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
            transition: all 0.3s;
        }
        .region-accordion-header:hover {
            background: rgba(255, 255, 255, 0.03);
        }
        .region-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .accordion-arrow {
            transition: transform 0.3s;
            color: rgba(255, 255, 255, 0.6);
        }
        .region-accordion-item.expanded .accordion-arrow {
            transform: rotate(90deg);
        }
        .region-name {
            font-size: 14px;
            font-weight: 600;
            color: #fff;
        }
        .region-conditions-summary {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            padding: 4px 12px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 16px;
        }
        .region-accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(0, 0, 0, 0.1);
        }
        .region-accordion-item.expanded .region-accordion-content {
            max-height: 300px;
        }
        .conditions-grid {
            padding: 16px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .condition-section {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            padding: 12px;
        }
        .condition-section h4 {
            margin: 0 0 12px 0;
            font-size: 13px;
            font-weight: 600;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .charge-section h4 {
            color: #00ff88;
        }
        .discharge-section h4 {
            color: #ffc107;
        }
        .condition-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        .condition-item:last-child {
            border-bottom: none;
        }
        .condition-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
        }
        .condition-value {
            font-size: 12px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
        }

        
        /* Á°Æ‰øùÊ®°ÊÄÅÊ°ÜÂßãÁªàÂú®ÊúÄÈ°∂Â±Ç */
        #modalContent {
            z-index: 2147483648 !important;
            position: fixed !important;
        }
        
        /* ÂÖÖÁîµÊªëÂùóÂèëÂÖâÊïàÊûú */
        #modalChargeSOCSlider:hover::-webkit-slider-thumb {
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.6), 0 4px 12px rgba(0, 0, 0, 0.4), inset 0 1px 2px rgba(255, 255, 255, 0.4);
        }
        
        #modalChargeSOCSlider:hover::-moz-range-thumb {
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.6), 0 4px 12px rgba(0, 0, 0, 0.4), inset 0 1px 2px rgba(255, 255, 255, 0.4);
        }
        
        /* ÊîæÁîµÊªëÂùóÂèëÂÖâÊïàÊûú */
        #modalDischargeSOCSlider:hover::-webkit-slider-thumb {
            box-shadow: 0 0 20px rgba(255, 193, 7, 0.6), 0 4px 12px rgba(0, 0, 0, 0.4), inset 0 1px 2px rgba(255, 255, 255, 0.4);
        }
        
        #modalDischargeSOCSlider:hover::-moz-range-thumb {
            box-shadow: 0 0 20px rgba(255, 193, 7, 0.6), 0 4px 12px rgba(0, 0, 0, 0.4), inset 0 1px 2px rgba(255, 255, 255, 0.4);
        }
        
        /* Shimmer animation for progress bars */
        @keyframes shimmer {
            0% {
                left: -100%;
            }
            100% {
                left: 200%;
            }
        }
        
        /* Âº∫Âà∂ÊäΩÂ±âÁªÑ‰ª∂Âú®ÊúÄÈ°∂Â±Ç */
        .drawer-overlay {
            z-index: 2147483647 !important;
            position: fixed !important;
        }
        
        .drawer-container {
            z-index: 2147483647 !important;
            position: fixed !important;
        }
        
        /* Á°Æ‰øùÊäΩÂ±âÁªÑ‰ª∂‰ΩøÁî®Ê≠£Á°ÆÁöÑÂ≠ó‰ΩìÂíåÂ§ßÂ∞è */
        #deviceResponseDrawerComponent .drawer-container {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
            font-size: 14px !important;
        }
        
        #deviceResponseDrawerComponent .detail-label {
            font-size: 14px !important;
        }
        
        #deviceResponseDrawerComponent .detail-value {
            font-size: 14px !important;
        }
        
        #deviceResponseDrawerComponent .stat-value {
            font-size: 24px !important;
        }
        
        #deviceResponseDrawerComponent .stat-label {
            font-size: 12px !important;
        }
        
        /* Á°Æ‰øùÊäΩÂ±âÂÆπÂô®Âú®ÊâÄÊúâÂÖÉÁ¥†‰πã‰∏ä */
        #homeOperationDrawer {
            z-index: 2147483647 !important;
            position: fixed !important;
        }
        
        #homeOperationDrawer * {
            z-index: inherit !important;
        }
        
        /* Á°Æ‰øùÊâÄÊúâÊäΩÂ±âÁõ∏ÂÖ≥ÂÖÉÁ¥†ÈÉΩÂú®ÊúÄÈ°∂Â±Ç */
        [id*="Drawer"], [class*="drawer"] {
            z-index: 2147483647 !important;
            position: relative !important;
        }
        
        /* Override for homepage specific styles */
        html {
            height: auto;
            overflow-x: hidden;
        }
        
        /* ‰∏∫È¶ñÈ°µËÆæÁΩÆÈ¢úËâ≤ÂèòÈáè */
        :root {
            --color-bg: #f7f8fa;
            --color-bg-card: #fff;
            --color-text: #1d2129;
            --color-text-secondary: #4e5969;
            --color-primary: #00b96b;
            --color-accent: #1e7fff;
            --color-border: #e5e6eb;
            --color-shadow: 0 2px 8px rgba(0,0,0,0.06);
            --radius: 12px;
        }

        body.theme-dark {
            --color-bg: #000;
            --color-bg-card: rgba(255, 255, 255, 0.03);
            --color-text: rgba(255, 255, 255, 0.9);
            --color-text-secondary: rgba(255, 255, 255, 0.6);
            --color-primary: #00ff88;
            --color-region-primary: #00ff88;
            --color-circle-primary: #52c41a;
            --color-accent: #1e7fff;
            --color-border: rgba(255, 255, 255, 0.08);
            --color-shadow: 0 2px 8px rgba(0,0,0,0.32);
        }
        
        body {
            background: #000 !important;
            overflow-x: hidden;
            position: relative;
            margin: 0;
            padding: 0;
            height: auto;
            min-height: 100vh;
            width: 100vw;
        }
        
        /* Ensure all containers utilize full screen width */
        * {
            box-sizing: border-box;
        }
        
        /* Full width responsive utilities */
        .container, .main-content-scrollable, .stats-row {
            max-width: 100% !important;
        }
        
        /* Responsive grid improvements */
        @media (max-width: 1024px) {
            .stats-row {
                grid-template-columns: 1fr 2fr !important;
                gap: 15px;
            }
            
            .container {
                padding: 20px 8px 20px !important;
            }
            
            .main-content-scrollable {
                padding: 0 !important;
            }
            
            .region-selector-fixed {
                padding: 0 16px;
                padding-bottom: 20px;
            }
            
            /* Today's Data section responsive */
            .today-data-card {
                min-width: 300px !important;
                height: 140px !important;
            }
            
            .metrics-card {
                min-width: 410px !important;
                height: 140px !important;
            }
            
            .today-data-row {
                padding-left: 8px !important;
                padding-right: 8px !important;
            }
            
            /* Power Station Card responsive */
            .power-station-card {
                min-height: 450px !important;
            }
            
        }
        
        /* Fixed region selector */
        .region-selector-fixed {
            position: fixed;
            top: 100px; /* Increased spacing from header */
            left: 0;
            right: 0;
            z-index: 999;
            background: #000; /* Solid background to prevent transparency */
            padding: 0 20px;
            padding-bottom: 20px; /* Add bottom padding */
            border-bottom: 1px solid rgba(255,255,255,0.1); /* Add subtle border */
            width: 100%;
            box-sizing: border-box;
        }
        
        /* Gradient mask to hide content smoothly - removed transparency issue */
        .region-selector-fixed::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(to bottom, #000, transparent);
            pointer-events: none;
            z-index: 1000;
        }
        
        /* Scrollable main content */
        .main-content-scrollable {
            margin-top: 90px; /* 80px fixed header + 10px spacing */
            padding: 0;
            padding-bottom: 100px; /* Á°Æ‰øùÂ∫ïÈÉ®ÊúâË∂≥Â§üÁ©∫Èó¥ */
            position: relative;
            background: #000; /* Solid black background */
            width: 100%;
            max-width: 100vw;
            box-sizing: border-box;
        }
        
        .container {
            background: transparent;
            padding-top: 20px !important;
            padding-bottom: 100px !important;
            max-width: 100%;
            margin: 0;
            min-height: auto;
            height: auto;
            overflow: visible !important;
            width: 100%;
            box-sizing: border-box;
        }
        .btn {
            background: var(--color-primary);
            color: #fff;
            border-radius: 22px;
            border: none;
            padding: 0 24px;
            height: 44px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            min-width: 100px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn:hover {
            background: var(--color-accent);
        }
        .input {
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--radius);
            padding: 0 12px;
            height: 40px;
            color: var(--color-text);
            font-size: 16px;
        }
        /* ‰∏ªÈ¢òÂàáÊç¢ÊåâÈíÆ */
        .theme-toggle-btn {
            position: absolute;
            right: 32px;
            top: 24px;
            z-index: 100;
            background: var(--color-bg-card);
            color: var(--color-text);
            border: 1px solid var(--color-border);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            box-shadow: var(--color-shadow);
            transition: background 0.3s, color 0.3s;
        }
        .theme-toggle-btn:hover {
            background: var(--color-primary);
            color: #fff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-sans);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Glass morphism effects */
        .glass {
            background: var(--color-bg-card, rgba(255,255,255,0.12));
            backdrop-filter: blur(20px) saturate(1.5);
            border: 1px solid var(--color-border, rgba(255,255,255,0.1));
            border-radius: var(--radius, 20px);
            color: var(--color-text);
        }

        /* Pulse animation for status indicators */
        @keyframes pulse {
            0% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.5;
                transform: scale(1.2);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }


        .language-selector {
            position: relative;
            cursor: pointer;
        }

        .language-current {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 10px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            transition: all 0.3s;
        }

        .language-current:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .language-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(30px) saturate(1.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 8px 0;
            display: none;
            min-width: 120px;
        }

        .language-option {
            padding: 8px 16px;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .language-option:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00ff88, #00aaff);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .user-avatar:hover {
            transform: scale(1.05);
        }

        /* Period Dropdown Styles */
        .period-dropdown {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 16px;
            padding-right: 32px !important;
            transition: all 0.3s ease;
        }

        .period-dropdown:hover {
            background-color: rgba(255,255,255,0.12) !important;
            border-color: rgba(255,255,255,0.25) !important;
        }

        .period-dropdown:focus {
            background-color: rgba(255,255,255,0.15) !important;
            border-color: var(--color-primary) !important;
            box-shadow: 0 0 0 2px rgba(0,185,107,0.2);
        }

        .period-dropdown option {
            background: #1a1a1a;
            color: #fff;
            padding: 8px;
        }

        /* Main Container */
        .container {
            max-width: 95%;
            margin: 0 auto;
            padding: 120px 10px 100px; /* Ê∑ªÂä†Â∫ïÈÉ®paddingÁ°Æ‰øùÂÜÖÂÆπÂèØËßÅ */
            height: auto;
            display: flex;
            flex-direction: column;
            overflow: visible;
        }

        /* Page Header */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding: 24px 0;
            border-bottom: 1px solid var(--color-border);
        }

        /* Top Stats Row */
        .stats-row {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-bottom: 20px;
            padding-right: 0;
            height: auto;
            min-height: auto;
            position: relative;
            overflow: visible;
            align-items: stretch;
            width: 100%;
        }
        
        /* Today's Data Row alignment with region selector */
        .today-data-row {
            padding-left: 10px;
            padding-right: 10px;
        }

        /* Market Section */
        .market-section {
            display: flex;
            flex-direction: column;
            width: 100%;
        }

        .market-section .price-cards {
            width: 100%;
            display: flex;
            justify-content: space-between;
            gap: 20px;
        }

        .market-section .price-card {
            flex: 1;
            min-width: 0;
        }

        /* Power Station Management Styles */
        .power-station-container {
            display: flex;
            flex-direction: column;
            padding: 12px;
            height: auto;
            min-height: auto;
            overflow: visible;
        }

        .station-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            padding-bottom: 4px;
        }

        .station-title {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
            margin: 0;
        }

        .highest-price-region {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        /* Price Circle Layout */
        .price-circle-layout {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 20px 0;
            gap: 20px;
        }

        .price-side-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            flex: 1;
        }

        .side-label {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 8px;
            white-space: nowrap;
        }

        .side-price {
            font-size: 20px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        /* Main Price Circle */
        .main-price-circle {
            position: relative;
            width: 160px;
            height: 160px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .circle-background {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: linear-gradient(135deg, #007AFF, #0056CC);
            opacity: 0.9;
            transition: all 0.3s ease;
        }
        
        /* ÂÖÖÁîµÁä∂ÊÄÅËÑâÂÜ≤Âä®Áîª */
        @keyframes chargePulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(0, 255, 136, 0.4);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 0 15px rgba(0, 255, 136, 0);
            }
        }
        
        /* ÊîæÁîµÁä∂ÊÄÅËÑâÂÜ≤Âä®Áîª */
        @keyframes dischargePulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(255, 149, 0, 0.4);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 0 15px rgba(255, 149, 0, 0);
            }
        }
        
        /* ÂæÖÊú∫Áä∂ÊÄÅÂëºÂê∏Âä®Áîª */
        @keyframes breathe {
            0%, 100% {
                opacity: 0.9;
                transform: scale(1);
            }
            50% {
                opacity: 1;
                transform: scale(1.02);
            }
        }
        
        .circle-background.charging {
            animation: chargePulse 2s ease-in-out infinite;
        }
        
        .circle-background.discharging {
            animation: dischargePulse 2s ease-in-out infinite;
        }
        
        .circle-background.idle {
            animation: breathe 3s ease-in-out infinite;
        }

        /* Water Wave Effect */
        .water-wave-container {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            overflow: hidden;
            background: linear-gradient(135deg, #007AFF 0%, #0056CC 100%);
        }

        .water-wave {
            position: absolute;
            bottom: 0;
            left: -50%;
            width: 200%;
            height: 30%;
            background: linear-gradient(180deg, rgba(75, 123, 255, 0.9) 0%, rgba(75, 123, 255, 0.7) 100%);
            border-radius: 50% 50% 0 0 / 100% 100% 0 0;
            animation: horizontalWaveAnimation 2s ease-in-out infinite;
            transform-origin: center bottom;
        }


        @keyframes horizontalWaveAnimation {
            0%, 100% {
                transform: translateX(0) translateY(0);
                border-radius: 50% 50% 0 0 / 100% 100% 0 0;
            }
            25% {
                transform: translateX(-5px) translateY(-1px);
                border-radius: 45% 55% 0 0 / 95% 105% 0 0;
            }
            50% {
                transform: translateX(0) translateY(1px);
                border-radius: 55% 45% 0 0 / 105% 95% 0 0;
            }
            75% {
                transform: translateX(5px) translateY(-1px);
                border-radius: 50% 50% 0 0 / 100% 100% 0 0;
            }
        }
        
        @keyframes chargeCirclePulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 255, 136, 0.4); }
            50% { transform: scale(1.02); box-shadow: 0 0 0 8px rgba(0, 255, 136, 0.1); }
        }
        
        @keyframes dischargeCirclePulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.4); }
            50% { transform: scale(1.03); box-shadow: 0 0 0 10px rgba(255, 193, 7, 0.1); }
        }
        

        .circle-content {
            position: relative;
            z-index: 3;
            text-align: center;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        .price-range {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.7);
            margin: 4px 0;
            line-height: 1.2;
        }

        .price-percentage {
            font-size: 14px;
            color: #00ff88;
            font-weight: 600;
            margin-top: 2px;
        }

        /* Stop Circle Overlay */
        .stop-circle-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #ff4757, #c44569);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5;
            opacity: 0;
            transition: opacity 0.3s ease;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(255, 71, 87, 0.3);
        }

        .main-price-circle.manual-operation:hover .stop-circle-overlay {
            opacity: 1;
        }

        .stop-circle-overlay:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(255, 71, 87, 0.4);
        }

        .stop-text {
            color: #fff;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            pointer-events: none;
        }
        
        /* SOC hover overlay styles */
        .soc-hover-overlay {
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .soc-hover-overlay:hover {
            opacity: 1;
        }
        
        div:hover .soc-hover-overlay {
            opacity: 1;
        }

        /* Circle Action Buttons */
        .circle-action-btn {
            width: 100%;
            height: 80px;
            border-radius: 16px;
            font-size: 14px;
            font-weight: 600;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .circle-action-btn.charge-btn {
            background: linear-gradient(135deg, #00ff88, #00cc6a);
            color: #000;
        }

        .circle-action-btn.charge-btn:hover {
            background: linear-gradient(135deg, #00cc6a, #00aa55);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 255, 136, 0.3);
        }

        .circle-action-btn.discharge-btn {
            background: linear-gradient(135deg, #ff9500, #e67e22);
            color: #fff;
        }

        .circle-action-btn.discharge-btn:hover {
            background: linear-gradient(135deg, #e67e22, #d35400);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 149, 0, 0.3);
        }

        /* Disabled state for circle action buttons */
        .circle-action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }


        .current-price {
            font-size: 36px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 4px;
        }

        .price-unit {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 16px;
            margin: 20px 0;
        }

        .action-btn {
            flex: 1;
            padding: 12px 24px;
            border: 2px solid transparent;
            border-radius: 32px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #000;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .charge-btn {
            background: linear-gradient(135deg, #00D67A, #00FF88) !important;
            border: 2px solid rgba(0, 255, 136, 0.3) !important;
            color: #000 !important;
        }

        .charge-btn:hover {
            transform: translateY(-2px);
            background: #00E070 !important;
            box-shadow: 0 8px 20px rgba(0, 255, 136, 0.4) !important;
            border-color: rgba(0, 255, 136, 0.6) !important;
        }

        .discharge-btn {
            background: linear-gradient(135deg, #FFC107, #FFD700) !important;
            border: 2px solid rgba(255, 193, 7, 0.3) !important;
            color: #000 !important;
        }

        .discharge-btn:hover {
            transform: translateY(-2px);
            background: linear-gradient(135deg, #FFB300, #FFC107) !important;
            box-shadow: 0 8px 20px rgba(255, 193, 7, 0.4) !important;
            border-color: rgba(255, 193, 7, 0.6) !important;
        }
        
        /* ÂÅúÊ≠¢ÊåâÈíÆÊ†∑Âºè */
        .stop-btn {
            background: linear-gradient(135deg, #ff4444, #ff6b6b) !important;
            border: 2px solid rgba(255, 68, 68, 0.3) !important;
            flex: 1 !important;
            margin: 0 !important;
            color: #fff !important;
            padding: 12px 24px !important;
            border-radius: 32px !important;
            font-size: 16px !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
            box-shadow: 0 4px 12px rgba(255, 68, 68, 0.2) !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }
        
        .stop-btn:hover {
            box-shadow: 0 8px 20px rgba(255, 68, 68, 0.4) !important;
            border-color: rgba(255, 68, 68, 0.6) !important;
        }
        
        /* Êìç‰Ωú‰∏≠ÁöÑÊåâÈíÆÂÆπÂô®Ê†∑Âºè */
        .action-buttons.operating {
            justify-content: center !important;
        }
        
        .action-buttons.operating .action-btn:not(.stop-btn) {
            display: none !important;
        }
        
        .action-buttons.operating .stop-btn {
            flex: 1 !important;
            max-width: 200px !important;
        }

        /* Stats Compact Grid */
        .stats-compact-grid {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100%;
            padding: 4px 0;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            background: #1a1a1a;
            border-radius: 10px;
            height: calc(100% / 4 - 3px);
        }

        .stat-icon {
            font-size: 14px;
            width: 16px;
            text-align: center;
            opacity: 0.9;
        }

        .stat-content {
            flex: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stat-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        .stat-value {
            font-size: 12px;
            font-weight: 600;
            color: #fff;
        }

        /* Bottom Stats Grid */
        .bottom-stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }

        .bottom-stat-card {
            padding: 8px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .bottom-stat-title {
            font-size: 9px;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 3px;
        }

        .bottom-stat-value {
            font-size: 12px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 2px;
        }

        .bottom-stat-change {
            font-size: 8px;
            font-weight: 500;
        }

        .bottom-stat-change.positive {
            color: #00ff88;
        }

        .bottom-stat-change.negative {
            color: #8A4AFF;
        }

        /* Legacy: Electricity Cost Circle for backward compatibility */
        .cost-circle-container {
            padding: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .cost-circle {
            position: relative;
            width: 200px;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }

        .circle-bg {
            position: absolute;
            inset: 0;
            border-radius: 50%;
            background: conic-gradient(from 0deg, #00ff88 0deg, #00ff88 144deg, rgba(255, 255, 255, 0.1) 144deg);
            padding: 3px;
            mask: radial-gradient(farthest-side, transparent calc(100% - 20px), #000 calc(100% - 20px));
        }

        .circle-inner {
            position: relative;
            z-index: 1;
            text-align: center;
        }

        .cost-amount {
            font-size: 48px;
            font-weight: 300;
            margin-bottom: 5px;
        }

        .cost-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
        }

        /* Price Range Display */
        .price-range {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 20px;
            gap: 20px;
        }

        .price-stat {
            flex: 1;
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }

        .price-stat-label {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .price-stat-value {
            font-size: 20px;
            font-weight: 600;
        }

        .price-high {
            color: #8A4AFF;
        }

        .price-low {
            color: #00ff88;
        }

        .cost-buttons {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 10px 30px;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .btn-primary {
            background: #00ff88;
            color: #000;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-danger {
            background: #8A4AFF;
            color: #fff;
            border: 1px solid #8A4AFF;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.3);
        }

        /* Panel Tabs */
        .panel-tabs {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 15px;
            padding-left: 20px;
        }

        .panel-tab {
            padding: 8px 20px;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .panel-tab:hover {
            color: #fff;
        }

        .panel-tab.active {
            color: #00ff88;
        }

        .panel-tab.active::after {
            content: '';
            position: absolute;
            bottom: -16px;
            left: 0;
            right: 0;
            height: 2px;
            background: #00ff88;
        }

        /* Mode Tabs for Modal */
        .mode-tab {
            padding: 12px 24px;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .mode-tab:hover {
            color: #fff;
        }

        .mode-tab.active {
            color: #00ff88;
        }

        .mode-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: #00ff88;
        }

        .auto-switch-toggle {
            margin-left: auto;
            display: flex;
            align-items: center;
        }

        /* Switch Toggle */
        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.2);
            transition: .4s;
            border-radius: 16px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #00ff88;
        }

        input:checked + .slider:before {
            transform: translateX(20px);
        }

        /* Panel Content */
        .panel-content { display: none; }
        .panel-content.active { display: flex; flex-direction: column; flex: 1; min-height: 100%; overflow: visible; }

        /* Region Tabs */
        .region-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .region-tab {
            padding: 6px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.7);
            border-radius: 16px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .region-tab:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .region-tab.active {
            background: #00ff88;
            color: #000;
            border-color: #00ff88;
        }

        /* Price Cards */
        .price-cards {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            height: 80px; /* Âõ∫ÂÆöÈ´òÂ∫¶ */
        }

        .price-card {
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 0;
            height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            background: var(--color-bg-card, rgba(255,255,255,0.03));
            border-radius: var(--radius, 8px);
            border: 1px solid var(--color-border, rgba(255,255,255,0.1));
            color: var(--color-text);
        }

        .price-card-label {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 6px;
            line-height: 1.2;
            height: 2.4em;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .price-card-value {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
        }

        /* Demand Generation Card */
        .demand-gen-card {
            padding: 12px !important;
            gap: 6px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            height: 80px;
        }

        .demand-gen-row {
            display: flex;
            align-items: center;
            padding: 6px;
            border-radius: 6px;
            transition: all 0.3s ease;
            height: 50%;
            justify-content: space-between;
        }

        .demand-gen-label {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.7);
            white-space: nowrap;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .demand-gen-value {
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .demand-row {
            background: linear-gradient(90deg, rgba(76, 217, 100, 0.2), rgba(76, 217, 100, 0.15));
        }

        .demand-row .demand-gen-value {
            color: #4CD964;
        }

        .generation-row {
            background: linear-gradient(90deg, rgba(30, 144, 255, 0.2), rgba(30, 144, 255, 0.15));
        }

        .generation-row .demand-gen-value {
            color: #1E90FF;
        }

        @media (max-width: 768px) {
            .price-cards {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 480px) {
            .price-cards {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .stats-row {
                grid-template-columns: 1fr !important;
                gap: 10px;
            }
            
            /* Today's Data section for very small screens */
            .today-data-card {
                min-width: 250px !important;
                height: 110px !important;
                padding: 12px !important;
            }
            
            .metrics-card {
                min-width: 260px !important;
                height: 110px !important;
                padding: 12px !important;
            }
            
            /* Power Station Card responsive */
            .power-station-card {
                min-height: 350px !important;
                padding: 12px !important;
            }
        }

        /* Charts Section */
        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .chart-container {
            padding: 20px;
            height: 605.2px; /* Âõ∫ÂÆöÈ´òÂ∫¶Ôºå‰∏éÂú∞ÂõæÂç°Áâá‰∏ÄËá¥ */
            display: flex;
            flex-direction: column;
            width: calc(100% - 30px); /* ÂáèÂéªÂ∑¶‰æßgapÁöÑÂÆΩÂ∫¶ */
            margin-left: auto;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 18px;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 500;
            margin: 0;
        }

        .chart-controls {
            display: flex;
            gap: 10px;
        }

        .tab {
            padding: 6px 16px;
            background: none;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.7);
            border-radius: 16px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .tab.active {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border-color: rgba(255, 255, 255, 0.3);
        }

        .chart-area {
            flex: 1;
            width: 100%;
            height: calc(100% - 60px); /* ÂáèÂéªÂ§¥ÈÉ®ÁöÑÈ´òÂ∫¶ */
            min-height: 0; /* Èò≤Ê≠¢ÂÜÖÂÆπÊ∫¢Âá∫ */
        }

        /* Info Cards */
        .info-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 40px;
        }

        .info-card {
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .info-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.2);
        }

        .info-icon {
            width: 40px;
            height: 40px;
            margin: 0 auto 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .info-value {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .info-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
        }

        /* Stats Overview */
        .stats-overview {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 20px;
            width: calc(100% - 30px);
            margin-left: auto;
        }

        .stat-overview-card {
            background: rgba(26, 26, 26, 0.85);
            backdrop-filter: blur(25px) saturate(1.5);
            border-radius: 10px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 120px;
            justify-content: center;
        }

        .stat-overview-icon {
            font-size: 20px;
            margin-bottom: 8px;
            color: rgba(255, 255, 255, 0.8);
        }

        .stat-overview-label {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            text-align: center;
            margin-bottom: 4px;
        }

        .stat-overview-value {
            font-size: 24px;
            font-weight: 600;
            color: #fff;
        }

        /* Bottom Section */
        .bottom-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 40px;
        }

        .data-table {
            padding: 30px;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .data-row {
            display: flex;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .data-label {
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
        }

        .data-value {
            font-size: 18px;
            font-weight: 500;
        }

        /* Region Selection Layer Styles */
        .region-select-tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.05) !important;
            color: var(--color-text) !important;
        }
        
        .region-select-tab.active {
            background: var(--color-region-primary) !important;
            color: #000 !important;
            box-shadow: 0 2px 8px rgba(0, 255, 136, 0.3);
        }
        
        /* Enhanced readability for selected region status badges */
        .region-select-tab.active .region-status-badge {
            background: rgba(0, 0, 0, 0.15) !important;
            color: #000 !important;
            border-color: rgba(0, 0, 0, 0.3) !important;
            font-weight: 700 !important;
        }
        
        /* Special styling for waitingExecution status */
        .region-status-badge[data-status="waitingExecution"] {
            background: rgba(30, 127, 255, 0.2) !important;
            color: #1E7FFF !important;
            border: 1px dashed #1E7FFF !important;
            padding: 6px 12px !important;
            border-radius: 10px !important;
            font-size: 11px !important;
            font-weight: 600 !important;
            display: inline-block !important;
        }
        
        /* Special styling for waitingExecution status when region is active */
        .region-select-tab.active .region-status-badge[data-status="waitingExecution"] {
            background: rgba(0, 0, 0, 0.2) !important;
            color: #000 !important;
            border: 1px dashed rgba(0, 0, 0, 0.4) !important;
        }
        
        /* Status badge base styles */
        .region-status-badge {
            transition: all 0.3s ease;
            font-size: 13px;
            font-weight: 700;
            padding: 6px 12px;
            border-radius: 16px;
            border-width: 1px;
        }

        /* Hide region status indicators in auto conditions modal */
        #regionOverviewCard .region-status-indicator {
            display: none !important;
        }
        
        /* Responsive Layout */
        @media (min-width: 1441px) {
            /* Large screens */
            .container {
                max-width: 100%;
                padding: 20px 15px 20px;
            }
            
            .main-content-scrollable {
                padding: 0;
            }
            
            .stats-row {
                height: auto;
                min-height: 600px;
            }

            .power-station-container {
                height: auto !important;
                min-height: auto;
            }

            .custom-card {
                min-height: 600px;
            }
        }

        @media (max-width: 1440px) and (min-width: 1201px) {
            /* Medium-large screens */
            .container {
                max-width: 100%;
                padding: 20px 12px 20px;
            }
            
            .main-content-scrollable {
                padding: 0;
            }
            
            .region-selector-fixed {
                padding: 0 20px;
                padding-bottom: 20px;
            }
            
            /* Today's Data section responsive */
            .today-data-card {
                min-width: 380px !important;
                height: 145px !important;
            }
            
            .metrics-card {
                min-width: 560px !important;
                height: 145px !important;
            }
            
            .today-data-row {
                padding-left: 12px !important;
                padding-right: 12px !important;
            }
            
            /* Power Station Card responsive */
            .power-station-card {
                min-height: 480px !important;
            }
            
        }

        @media (max-width: 1200px) {
            /* Tablet and small desktop */
            .container {
                max-width: 100%;
                padding: 20px 10px 20px;
            }
            
            .region-selector-fixed {
                padding: 0 20px;
                padding-bottom: 20px;
            }
            
            .stats-row {
                grid-template-columns: 1fr 2fr;
                height: auto;
                gap: 20px;
            }
            
            /* Today's Data section responsive */
            .today-data-card {
                min-width: 320px !important;
                height: 130px !important;
            }
            
            .metrics-card {
                min-width: 460px !important;
                height: 130px !important;
            }
            
            .today-data-row {
                padding-left: 10px !important;
                padding-right: 10px !important;
            }
            
            /* Power Station Card responsive */
            .power-station-card {
                min-height: 420px !important;
            }
            
        }

        @media (max-width: 768px) {
            /* Mobile devices */
            .container {
                max-width: 100%;
                padding: 20px 8px 20px;
            }
            
            .region-selector-fixed {
                padding: 0 16px;
                padding-bottom: 20px;
            }
            
            .region-selection-layer {
                margin-bottom: 15px;
                padding: 12px;
            }
            
            /* Today's Data section responsive - stack on mobile */
            .today-data-card {
                min-width: 280px !important;
                height: 120px !important;
                margin-bottom: 15px;
            }
            
            .metrics-card {
                min-width: 290px !important;
                height: 120px !important;
            }
            
            /* Stack cards vertically on mobile */
            .today-data-row {
                flex-direction: column !important;
                gap: 15px !important;
                padding-left: 8px !important;
                padding-right: 8px !important;
            }
            
            /* Power Station Card responsive */
            .power-station-card {
                min-height: 380px !important;
            }
            
            /* Responsive font sizes for today's data */
            .today-data-card div[style*="font-size:14px"] {
                font-size: 12px !important;
            }
            
            .today-data-card div[style*="font-size:16px"] {
                font-size: 14px !important;
            }
            
            .today-data-card div[style*="font-size:10px"] {
                font-size: 9px !important;
            }
            
            .today-data-card div[style*="font-size:8px"] {
                font-size: 7px !important;
            }
            
        }

        @media (max-width: 480px) {
            /* Small mobile devices */
            .container {
                max-width: 100%;
                padding: 95px 5px 15px;
            }
            
            .region-selection-layer {
                margin-bottom: 10px;
                padding: 10px;
            }
            
            .region-selection-tabs {
                gap: 3px;
                flex-wrap: wrap;
            }
            
            .region-select-tab {
                padding: 6px 12px !important;
                font-size: 12px;
                min-width: 70px !important;
            }
            
            .power-station-container {
                height: auto !important;
                min-height: auto;
                padding: 12px;
            }
            
            .custom-card {
                height: auto !important;
                min-height: 500px !important;
            }

            .price-cards {
                gap: 8px;
            }
            
            .price-card {
                min-height: 90px;
            }
            
            .main-price-circle {
                width: 90px;
                height: 90px;
            }
            
            .current-price {
                font-size: 20px;
            }
            
            .price-range {
                font-size: 7px;
            }
            
            .price-percentage {
                font-size: 10px;
            }
            
            .circle-action-btn {
                height: 45px;
                font-size: 10px;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
                gap: 6px;
            }
            
            .info-cards {
                grid-template-columns: 1fr;
            }
            
            .price-circle-layout {
                gap: 6px;
                margin: 10px 0;
            }
        }
        
        /* Responsive adjustments for info-summary-card */
        @media (min-width: 1441px) {
            .info-summary-card {
                height: 150px !important;
                min-height: 150px !important;
                max-height: 150px !important;
                margin-top: 15px !important;
                padding: 0 24px !important;
            }
        }
        
        @media (max-width: 1440px) and (min-width: 1201px) {
            .info-summary-card {
                height: 140px !important;
                min-height: 140px !important;
                max-height: 140px !important;
                margin-top: 15px !important;
                padding: 0 20px !important;
            }
        }
        
        @media (max-width: 1200px) {
            .info-summary-card {
                height: 120px !important;
                min-height: 120px !important;
                max-height: 120px !important;
                margin-top: 12px !important;
                padding: 0 16px !important;
            }
        }
        
        @media (max-width: 768px) {
            .info-summary-card {
                height: 100px !important;
                min-height: 100px !important;
                max-height: 100px !important;
                margin-top: 10px !important;
                padding: 0 12px !important;
            }
            
            .info-summary-card div[style*="font-size:18px"] {
                font-size: 16px !important;
            }
            
            .info-summary-card div[style*="font-size:13px"] {
                font-size: 12px !important;
            }
        }
        
        @media (max-width: 480px) {
            .info-summary-card {
                height: 90px !important;
                min-height: 90px !important;
                max-height: 90px !important;
                margin-top: 8px !important;
                padding: 0 10px !important;
            }
            
            .info-summary-card div[style*="font-size:18px"] {
                font-size: 14px !important;
            }
            
            .info-summary-card div[style*="font-size:13px"] {
                font-size: 10px !important;
            }
        }

        /* Height-based Responsive */
        @media (min-height: 900px) {
            .power-station-container {
                height: auto !important;
                min-height: 900px;
                max-height: none;
            }
            
            .custom-card {
                height: auto !important;
                min-height: 500px;
                max-height: 700px;
            }
        }

        @media (min-height: 800px) and (max-height: 899px) {
            .power-station-container {
                height: auto !important;
                min-height: auto;
            }

            .custom-card {
                height: auto !important;
                min-height: 550px;
            }
        }
        
        @media (max-height: 800px) {
            .power-station-container {
                height: auto;
            }
            
            .stats-row {
                height: auto;
            }
            
            .custom-card {
                height: auto !important;
                min-height: 450px;
            }

            .right-panel-scroll {
                height: auto !important;
            }
            
            .main-price-circle {
                width: 100px;
                height: 100px;
            }
            
            .current-price {
                font-size: 24px;
            }
            
            .price-circle-layout {
                margin: 8px 0;
            }
            
            .action-buttons {
                margin: 8px 0;
            }
        }
        
        @media (max-height: 600px) {
            .power-station-container {
                height: auto !important;
                min-height: auto;
            }
            
            .custom-card {
                height: auto !important;
                min-height: 300px;
            }
            
            .stats-row {
                height: auto;
                min-height: 300px;
            }
            
            .main-price-circle {
                width: 80px;
                height: 80px;
            }
            
            .current-price {
                font-size: 20px;
            }
            
            .side-price {
                font-size: 14px;
            }
            
            .station-header {
                margin-bottom: 4px;
                padding-bottom: 4px;
            }
            
            .station-title {
                font-size: 14px;
            }
        }

        /* Animations */
        @keyframes pulse {
            0% {
                opacity: 0.6;
            }
            50% {
                opacity: 1;
            }
            100% {
                opacity: 0.6;
            }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        /* Status Indicators */
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-green {
            background: #00ff88;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }

        .status-yellow {
            background: #ffaa00;
            box-shadow: 0 0 10px rgba(255, 170, 0, 0.5);
        }

        /* Region Status Indicators */
        .region-status {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            font-size: 12px;
            font-weight: 600;
        }

        .region-status.charging {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
            border: 1px solid rgba(0, 255, 136, 0.3);
        }

        .region-status.discharging {
            background: rgba(255, 170, 0, 0.2);
            color: #ffaa00;
            border: 1px solid rgba(255, 170, 0, 0.3);
        }

        /* ÈÄâ‰∏≠Áä∂ÊÄÅ‰∏ãÁöÑÊ†áËÆ∞Ê†∑Âºè */
        .region-select-tab.active .region-status.charging {
            background: #000;
            color: #00ff88;
            border: 1px solid #00ff88;
            font-weight: 700;
            box-shadow: 0 0 6px rgba(0, 255, 136, 0.5);
        }

        .region-select-tab.active .region-status.discharging {
            background: #000;
            color: #ffaa00;
            border: 1px solid #ffaa00;
            font-weight: 700;
            box-shadow: 0 0 6px rgba(255, 170, 0, 0.5);
        }
        
        /* ÊåâÈíÆÊÇ¨ÂÅúÊïàÊûú */
        .region-select-tab:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .region-select-tab.active {
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3);
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #00ff88;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(15px) saturate(1.5);
            justify-content: center;
            align-items: center;
        }
        
        /* ËÆæÂ§áÂìçÂ∫îÁªüËÆ°ÂºπÁ™óÊúÄÈ´ò‰ºòÂÖàÁ∫ß */
        #operationModal {
            z-index: 2147483650 !important;
        }
        
        #operationModal .modal-content {
            z-index: 2147483650 !important;
            position: relative !important;
        }
        
        .modal.show {
            display: flex !important;
        }

        .modal-content {
            background: #1a1a2e;
            margin: 0;
            padding: 0;
            border: none;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            color: #fff;
            position: relative;
            animation: modalSlideIn 0.3s ease-out;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Modal Button Styles */
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #00ff88, #00cc6a);
            color: #000;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #00cc6a, #00aa55);
            transform: translateY(-1px);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff4444, #ff6b6b);
            color: #fff;
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #ff3333, #ff5555);
            transform: translateY(-1px);
        }
        
        /* Operation Type Styling */
        .operation-type {
            padding: 8px 16px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 14px;
        }
        
        .operation-type.stop-charge,
        .operation-type.stop-discharge {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
            border: 1px solid rgba(255, 107, 107, 0.3);
        }
        
        /* Info Row Styling */
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .info-row label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            font-weight: 500;
        }
        
        .info-row span {
            color: #fff;
            font-size: 14px;
            font-weight: 600;
        }
        
        /* Warning Message */
        .warning-message {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 10px;
            padding: 16px;
            margin-top: 20px;
            text-align: center;
        }
        
        .warning-message span {
            color: #ffc107;
            font-size: 14px;
            line-height: 1.5;
        }

        .modal-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 20px;
        }

        .modal-icon.success {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }

        .modal-icon.warning {
            background: rgba(255, 149, 0, 0.2);
            color: #ff9500;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #00ff88;
        }

        .modal-body {
            margin-bottom: 25px;
        }

        .modal-info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .modal-info-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-info-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .modal-info-value {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 12px;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-btn {
            flex: 0 0 auto;
            min-width: 120px;
            height: 44px;
            padding: 10px 25px;
            border: none;
            border-radius: 22px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-btn-primary {
            background: linear-gradient(135deg, #00ff88, #00cc6a);
            color: #000;
        }

        .modal-btn-primary:hover {
            background: linear-gradient(135deg, #00cc6a, #00aa55);
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.3);
        }

        .modal-btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .modal-btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
            transform: translateY(-1px);
        }
        
        /* Details Panel Styles */
        .details-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: var(--color-bg-card);
            border-left: 1px solid var(--color-border);
            box-shadow: -4px 0 20px rgba(0,0,0,0.1);
            z-index: 1001;
            transition: right 0.3s ease;
            overflow-y: auto;
        }
        
        .details-panel.show {
            right: 0;
        }

        /* Device Status Drawer Styles */
        .device-status-drawer {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            z-index: 99999 !important;
            pointer-events: none;
            visibility: hidden;
        }

        .device-status-drawer.show {
            pointer-events: all !important;
            visibility: visible !important;
            z-index: 999999 !important;
        }

        .drawer-overlay {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background: rgba(0, 0, 0, 0.5) !important;
            backdrop-filter: blur(4px);
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            z-index: 999998 !important;
        }

        .device-status-drawer.show .drawer-overlay {
            opacity: 1 !important;
            pointer-events: all !important;
        }

        .drawer-content {
            position: fixed !important;
            top: 0 !important;
            right: 0 !important;
            width: 600px !important;
            height: 100% !important;
            background: var(--color-bg-card) !important;
            backdrop-filter: blur(30px);
            border-left: 1px solid var(--color-border);
            box-shadow: -8px 0 32px rgba(0, 0, 0, 0.3);
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            z-index: 999999 !important;
        }

        .device-status-drawer.show .drawer-content {
            transform: translateX(0) !important;
        }

        .drawer-header {
            padding: 24px 32px;
            border-bottom: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255, 255, 255, 0.02);
        }

        .drawer-header h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 700;
            color: var(--color-text);
        }

        .drawer-close-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 10px;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: rgba(255, 255, 255, 0.7);
            font-size: 24px;
            transition: all 0.3s;
        }

        .drawer-close-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            color: var(--color-text);
        }

        /* Drawer Tabs */
        .drawer-tabs {
            display: flex;
            gap: 6px;
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.02);
            border-bottom: 1px solid var(--color-border);
        }

        .drawer-tab {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 10px 12px;
            background: transparent;
            border: 1px solid var(--color-border);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--color-text-secondary);
            font-size: 12px;
            font-weight: 500;
        }

        .drawer-tab:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--color-primary);
        }

        .drawer-tab.active {
            background: var(--color-primary);
            border-color: var(--color-primary);
            color: #000;
            font-weight: 600;
        }

        .drawer-tab-count {
            font-size: 18px;
            font-weight: 700;
        }

        .drawer-tab.active .drawer-tab-count {
            color: #000;
        }

        .drawer-body {
            flex: 1;
            overflow-y: auto;
            padding: 24px 32px;
        }

        .drawer-stats {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
        }

        .drawer-stat-item {
            flex: 1;
            padding: 16px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--color-border);
            border-radius: 10px;
            text-align: center;
        }

        .drawer-stat-label {
            font-size: 12px;
            color: var(--color-text-secondary);
            margin-bottom: 8px;
        }

        .drawer-stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--color-text);
        }

        .drawer-table-container {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--color-border);
            border-radius: 10px;
            overflow: hidden;
        }

        .drawer-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        .drawer-table th {
            background: rgba(255, 255, 255, 0.05);
            color: var(--color-text-secondary);
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--color-border);
        }

        .drawer-table th:nth-child(1) {
            width: 40%;
        }

        .drawer-table th:nth-child(2) {
            width: 20%;
        }

        .drawer-table th:nth-child(3) {
            width: 40%;
        }

        .drawer-table td {
            padding: 14px 16px;
            color: var(--color-text);
            font-size: 14px;
            border-bottom: 1px solid var(--color-border);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .drawer-table tr:last-child td {
            border-bottom: none;
        }

        .drawer-table tr:hover td {
            background: rgba(255, 255, 255, 0.02);
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-badge.failed {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
        }

        .status-badge.success {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }

        .status-badge.executing {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }

        .status-badge.warning {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }

        .status-badge.info {
            background: rgba(30, 127, 255, 0.2);
            color: #1E7FFF;
        }

        .status-badge.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.6);
        }

        /* Operation Details Tabs Styles */
        .operation-details-tabs {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 16px;
        }

        .operation-tab.active {
            color: #00ff88 !important;
            border-bottom-color: #00ff88 !important;
        }

        .operation-tab:hover {
            color: rgba(255, 255, 255, 0.9) !important;
        }

        .tab-content {
            color: rgba(255, 255, 255, 0.9);
        }

        .detail-section {
            margin-bottom: 20px;
        }

        .detail-section-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #00ff88;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 600;
            color: #00ff88;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            flex: 1;
        }

        .detail-value {
            font-size: 13px;
            color: #fff;
            font-weight: 500;
            text-align: right;
        }

        .command-tag, .status-tag {
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .command-tag.charge {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }

        .command-tag.discharge {
            background: rgba(255, 170, 0, 0.2);
            color: #ffaa00;
        }

        .status-tag.success {
            background: rgba(52, 199, 89, 0.2);
            color: #34c759;
        }

        .status-tag.warning {
            background: rgba(255, 149, 0, 0.2);
            color: #ff9500;
        }

        .status-tag.danger {
            background: rgba(255, 59, 48, 0.2);
            color: #ff3b30;
        }

        .scrollable-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .scrollable-list::-webkit-scrollbar {
            width: 4px;
        }

        .scrollable-list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
        }

        .scrollable-list::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 6px;
        }
        
        /* ÂÖ®Â±ÄÊé®ÈÄÅÂºπÁ™óÊ†∑Âºè */
        .push-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 360px;
            max-width: calc(100vw - 40px);
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: 10px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            opacity: 0;
            transform: translateY(100%);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            overflow: hidden;
            backdrop-filter: blur(20px) saturate(1.5);
            border-left: 4px solid var(--color-primary);
        }

        .push-notification.show {
            opacity: 1;
            transform: translateY(0);
        }

        .push-notification.hide {
            opacity: 0;
            transform: translateY(100%);
        }

        .push-notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px 12px;
            border-bottom: 1px solid var(--color-border);
        }

        .push-notification-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
            font-weight: 600;
            color: var(--color-text);
        }

        .push-notification-icon {
            font-size: 20px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .push-notification-close {
            background: none;
            border: none;
            color: var(--color-text-secondary);
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
            border-radius: 6px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
        }

        .push-notification-close:hover {
            background: rgba(0, 0, 0, 0.1);
            color: var(--color-text);
        }

        .push-notification-content {
            padding: 16px 20px 20px;
        }

        .push-notification-content p {
            margin: 0;
            font-size: 14px;
            line-height: 1.5;
            color: var(--color-text);
        }

        /* ÂÖ≥ÈîÆÊï∞Â≠óÂº∫Ë∞ÉÊ†∑Âºè */
        .highlight-number {
            background: linear-gradient(135deg, #00ff88, #00dd77);
            color: #000;
            padding: 2px 6px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 15px;
            margin: 0 2px;
            display: inline-block;
            box-shadow: 0 2px 4px rgba(0, 255, 136, 0.3);
        }
        .highlight-value {
            background: linear-gradient(135deg, #ffc107, #ff9800);
            color: #000;
            padding: 2px 6px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 15px;
            margin: 0 2px;
            display: inline-block;
            box-shadow: 0 2px 4px rgba(255, 193, 7, 0.3);
        }

        .highlight-time {
            background: linear-gradient(135deg, #ff6b6b, #ff5252);
            color: #fff;
            padding: 2px 6px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 15px;
            margin: 0 2px;
            display: inline-block;
            box-shadow: 0 2px 4px rgba(255, 107, 107, 0.3);
        }

        .highlight-action {
            background: linear-gradient(135deg, #ffc107, #ff9800);
            color: #000;
            padding: 2px 6px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 15px;
            margin: 0 2px;
            display: inline-block;
            box-shadow: 0 2px 4px rgba(255, 193, 7, 0.3);
        }

        /* ÁßªÂä®Á´ØÂìçÂ∫îÂºè */
        @media (max-width: 768px) {
            .push-notification {
                right: 10px;
                left: 10px;
                width: auto;
                max-width: none;
            }
        }
        
        .details-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--color-border);
            background: var(--color-bg);
        }
        
        .details-panel-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: var(--color-text);
        }
        
        .details-close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--color-text-secondary);
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .details-close-btn:hover {
            background: var(--color-border);
            color: var(--color-text);
        }
        
        .details-content {
            padding: 20px;
        }
        
        .details-section {
            margin-bottom: 30px;
        }
        
        .details-section h4 {
            margin: 0 0 15px 0;
            font-size: 16px;
            font-weight: 600;
            color: var(--color-text);
            border-bottom: 1px solid var(--color-border);
            padding-bottom: 8px;
        }
        
        .details-grid {
            display: grid;
            gap: 12px;
        }
        
        .details-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }
        
        .details-label {
            font-size: 14px;
            color: var(--color-text-secondary);
            font-weight: 500;
        }
        
        .details-value {
            font-size: 14px;
            color: var(--color-text);
            font-weight: 600;
        }
        
        .status-overview {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        
        .status-item {
            text-align: center;
            padding: 15px;
            background: var(--color-bg);
            border-radius: 10px;
            border: 1px solid var(--color-border);
        }
        
        .status-number {
            font-size: 24px;
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: 5px;
        }
        
        .status-label {
            font-size: 12px;
            color: var(--color-text-secondary);
            font-weight: 500;
        }

        .close {
            position: absolute;
            top: 15px;
            right: 20px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close:hover {
            color: #fff;
        }

        /* Status Summary */
        .status-summary {
            margin: 20px 0;
            padding: 20px;
            background: rgba(0, 255, 136, 0.1);
            border-radius: 16px;
            border: 1px solid rgba(0, 255, 136, 0.2);
        }

        .status-summary-title {
            font-size: 16px;
            font-weight: 600;
            color: #00ff88;
            margin-bottom: 15px;
            text-align: center;
        }

        .status-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .status-stat {
            text-align: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .status-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #00ff88;
            margin-bottom: 5px;
        }

        .status-stat-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        /* Map Controls */
        .map-controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 20px;
            border-radius: 10px;
            backdrop-filter: blur(20px) saturate(1.5);
        }

        .map-stats {
            display: flex;
            gap: 30px;
        }

        .map-stat {
            text-align: center;
        }

        .map-stat-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            display: block;
            margin-bottom: 5px;
        }

        .map-stat-value {
            font-size: 18px;
            font-weight: 600;
            color: #00ff88;
        }

        /* Metrics Grid - New Layout */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 12px;
        }

        .metrics-grid .metric-card {
            min-width: 0;
        }

        .metric-card {
            background: var(--color-bg-card, rgba(255,255,255,0.12));
            border-radius: var(--radius, 8px);
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 4px;
            border: 1px solid var(--color-border, rgba(255,255,255,0.1));
            color: var(--color-text);
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .metric-value {
            font-size: 20px;
            font-weight: 600;
            color: #fff;
            text-align: left;
            line-height: 1;
        }

        .metric-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            text-align: left;
            line-height: 1;
        }

        .metric-change {
            font-size: 11px;
            color: #00ff88;
            display: flex;
            align-items: center;
            gap: 2px;
            text-align: left;
            line-height: 1;
            padding: 2px 0;
        }

        .metric-change.positive {
            color: #00ff88;
            background: rgba(0, 255, 136, 0.1);
        }

        /* Market Analysis Section */
        .market-analysis-section {
            margin-bottom: 40px;
            padding: 20px;
            width: calc(66.67% - 30px);
            margin-left: auto;
            background: rgba(17, 17, 17, 0.7);
            backdrop-filter: blur(20px) saturate(1.5);
        }

        .price-stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        .price-stat-card {
            background: rgba(25, 25, 25, 0.9);
            border-radius: 10px;
            padding: 16px;
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .price-stat-label {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
        }

        .price-stat-value {
            font-size: 24px;
            font-weight: 600;
            color: #fff;
        }

        .price-stat-change {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        .price-stat-icon {
            position: absolute;
            top: 16px;
            right: 16px;
            font-size: 16px;
            opacity: 0.7;
        }

        /* Analytics Section */
        .analytics-section {
            width: 100%;
            display: flex;
            margin-bottom: 40px;
        }

        .analytics-chart {
            width: 66.6666%;
            min-height: 400px;
            padding: 30px;
            margin-left: auto;
        }

        .system-overview {
            padding: 30px;
        }

        .overview-stats {
            margin-bottom: 25px;
        }

        .overview-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .overview-item:last-child {
            border-bottom: none;
        }

        .overview-label {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.6);
        }

        .overview-value {
            font-size: 14px;
            font-weight: 600;
            color: #fff;
        }

        .status-active {
            color: #00ff88;
        }

        .performance-chart {
            height: 120px;
            margin: 20px 0;
        }

        .overview-footer {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* Date Selection Styles */
        .date-selection {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .date-inputs {
            display: flex;
            gap: 20px;
            align-items: end;
            margin-bottom: 15px;
        }

        .date-input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .date-input-group label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            font-weight: 500;
        }

        .date-input {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            padding: 8px 12px;
            color: #fff;
            font-size: 14px;
            min-width: 140px;
        }

        .date-input:focus {
            outline: none;
            border-color: rgba(0, 255, 136, 0.5);
            box-shadow: 0 0 0 2px rgba(0, 255, 136, 0.1);
        }

        .date-input::-webkit-calendar-picker-indicator {
            filter: invert(1);
            opacity: 0.6;
        }
        
        /* ÈöêËóèÊ®°ÊÄÅÊ°Ü‰∏≠ÁöÑÊó∂Èó¥ËæìÂÖ•Ê°ÜÊó•ÂéÜÂõæÊ†á */
        input[type="time"]::-webkit-calendar-picker-indicator {
            display: none;
        }
        
        /* ÈöêËóèÊï∞Â≠óËæìÂÖ•Ê°ÜÁöÑ‰∏ä‰∏ãÁÆ≠Â§¥ */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        input[type="number"] {
            -moz-appearance: textfield;
        }

        .quick-select {
            display: flex;
            align-items: center;
            gap: 10px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .quick-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            margin-right: 10px;
        }

        .quick-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 6px 12px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quick-btn:hover {
            background: rgba(0, 255, 136, 0.1);
            border-color: rgba(0, 255, 136, 0.3);
            color: #00ff88;
        }

        /* Data Cards */
        .data-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .data-card:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .data-icon {
            font-size: 28px;
            color: rgba(255, 255, 255, 0.8);
        }

        .data-content {
            flex: 1;
        }

        .data-label {
            font-size: 18px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 8px;
        }

        .data-value {
            font-size: 32px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 8px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 24px;
        }

        .stats-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .stats-card:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .stats-label {
            font-size: 18px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 12px;
        }

        .stats-value {
            font-size: 32px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 8px;
        }

        .stats-change {
            font-size: 16px;
            color: #00ff88;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .stats-change.positive {
            color: #00ff88;
        }

        .stats-change.negative {
            color: #8A4AFF;
        }

        /* Remove excess bottom margin from last elements */
        .power-station-container > *:last-child {
            margin-bottom: 0;
        }

        .stats-grid > *:last-child {
            margin-bottom: 0;
        }

        /* Market and Map Container Styles */
        .market-container,
        .map-container {
            padding: 20px;
            min-height: auto;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
        }

        /* Market Stats Cards */
.market-stats {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-bottom: 24px;
}

.market-stat-card {
    padding: 20px;
    display: flex;
    flex-direction: column;
}

.market-stat-label {
    font-size: 12px;
    color: rgba(255, 255, 255, 0.6);
    margin-bottom: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.market-stat-value {
    font-size: 28px;
    font-weight: 600;
    color: #fff;
    display: flex;
    align-items: center;
    gap: 8px;
}

.market-stat-value .indicator {
    width: 4px;
    height: 24px;
    background: #4A9EFF;
    border-radius: 6px;
}

.market-stat-value .menu-dots {
    margin-left: auto;
    color: rgba(255, 255, 255, 0.4);
    cursor: pointer;
}

.market-stat-value .menu-dots:hover {
    color: rgba(255, 255, 255, 0.8);
}

.chart-container {
    padding: 20px;
    height: 605.2px; /* ‰∏éÁîµÁ´ôÁÆ°ÁêÜÂç°ÁâáÈ´òÂ∫¶‰øùÊåÅ‰∏ÄËá¥ */
    display: flex;
    flex-direction: column;
        }
/* AI Êô∫ËÉΩÊâòÁÆ°Èù¢ÊùøÂä®Áîª */
@keyframes aiPulseAnim {
    0%, 100% { opacity: 1; box-shadow: 0 0 6px rgba(0,255,136,0.6); }
    50% { opacity: 0.4; box-shadow: 0 0 12px rgba(0,255,136,0.9); }
}
@keyframes aiPanelSlideIn {
    from { opacity: 0; max-height: 0; margin-top: 0; }
    to { opacity: 1; max-height: 400px; margin-top: 12px; }
}
@keyframes aiPanelSlideOut {
    from { opacity: 1; max-height: 400px; margin-top: 12px; }
    to { opacity: 0; max-height: 0; margin-top: 0; }
}
    </style>
    <style>
        .custom-card {
            height: 600px;
            background: rgba(255,255,255,0.03);
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.08);
            box-shadow: 0 4px 24px rgba(0,255,136,0.04);
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
        }
        /* ÁîµÁ´ôÂç°ÁâáÔºöÂßãÁªàÊãâ‰º∏Â°´Êª° grid cellÔºåË¶ÜÁõñÊâÄÊúâ .custom-card ÁöÑ height: auto */
        .stats-row > .power-station-card {
            height: 100% !important;
            margin-bottom: 0;
        }
        .market-map-card {
            height: 605.2px;
            min-height: 605.2px;
            max-height: 605.2px;
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 4px 24px rgba(0,255,136,0.04);
            margin-bottom: 0;
            display: flex;
            flex-direction: column;
        }
    </style>
    <style>
        /* Âè≥‰æßÂÜÖÂÆπÊ≠£Â∏∏ÊòæÁ§∫Ôºå‰∏çÁã¨Á´ãÊªöÂä® */
        .right-panel-content {
            display: flex;
            flex-direction: column;
            height: auto;
            overflow: visible;
            padding-right: 10px;
        }
        
        .right-panel-scroll {
            overflow: visible;
        }
    </style>
</head>
<body>
    <!-- Login verification script -->
    <script>
        // Check if user is logged in
        const isLoggedIn = localStorage.getItem('isLoggedIn');
        if (!isLoggedIn || isLoggedIn !== 'true') {
            // Redirect to login page if not logged in
            window.location.href = 'vpp-login.html';
        }
    </script>
    
    <!-- Header Container for HeaderNav Component -->
    <div id="headerContainer"></div>

    <!-- Main Container -->
    <!-- Scrollable Main Content -->
    <div class="main-content-scrollable">
        <div class="container" style="padding-top: 20px; padding-left: 10px; padding-right: 10px; width: 100%; max-width: 100%; box-sizing: border-box;">

            <!-- Â§ßÊï∞ÊçÆÊåáÊ†áÊ†è -->
            <div style="position: relative; display: flex; align-items: stretch; width: 100%; margin: 0 0 20px 0; background: rgba(255,255,255,0.06); backdrop-filter: blur(30px) saturate(1.5); -webkit-backdrop-filter: blur(30px) saturate(1.5); border-radius: 16px; border: 1px solid rgba(255,255,255,0.12); padding: 14px 16px; box-shadow: 0 2px 16px rgba(0,0,0,0.3); box-sizing: border-box;">
                <span id="dataCutoffLabel" style="position: absolute; top: 6px; right: 12px; font-size: 9px; color: rgba(255,255,255,0.8);"></span>
                <script>
                    (function() {
                        const d = new Date();
                        d.setDate(d.getDate() - 1);
                        const pad = n => String(n).padStart(2, '0');
                        const ts = d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate()) + ' 23:59:59';
                        const isEn = window.i18n?.currentLang?.startsWith('en');
                        document.getElementById('dataCutoffLabel').textContent = (isEn ? '* Data as of ' : '* ÁªüËÆ°Êà™Ê≠¢ ') + ts;
                    })();
                </script>
                <!-- Á¥ØËÆ°ÂÖÖÁîµÊ¨°Êï∞ -->
                <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 8px 4px;">
                    <div style="font-size: 18px; margin-bottom: 4px;">‚ö°</div>
                    <div style="font-size: 10px; color: rgba(255,255,255,0.6); margin-bottom: 2px;" data-i18n="totalChargeCount">Á¥ØËÆ°ÂÖÖÁîµ <span style="color: rgba(0,255,136,0.6);" id="dailyAvgCharge">(Êó•Âùá4.2)</span></div>
                    <div style="font-size: 20px; font-weight: 700; color: #00ff88;" id="totalChargeCount">1,286Ê¨°</div>
                </div>
                <!-- ÂàÜÂâ≤Á∫ø -->
                <div style="width: 1px; background: rgba(255,255,255,0.1); margin: 8px 0;"></div>
                <!-- Á¥ØËÆ°ÊîæÁîµÊ¨°Êï∞ -->
                <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 8px 4px;">
                    <div style="font-size: 18px; margin-bottom: 4px;">üîã</div>
                    <div style="font-size: 10px; color: rgba(255,255,255,0.6); margin-bottom: 2px;" data-i18n="totalDischargeCount">Á¥ØËÆ°ÊîæÁîµ <span style="color: rgba(255,193,7,0.6);" id="dailyAvgDischarge">(Êó•Âùá3.8)</span></div>
                    <div style="font-size: 20px; font-weight: 700; color: #ffc107;" id="totalDischargeCount">1,158Ê¨°</div>
                </div>
                <!-- ÂàÜÂâ≤Á∫ø -->
                <div style="width: 1px; background: rgba(255,255,255,0.1); margin: 8px 0;"></div>
                <!-- ÂÖÖÁîµÊàêÊú¨ -->
                <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 8px 4px;">
                    <div style="font-size: 18px; margin-bottom: 4px;">üìâ</div>
                    <div style="font-size: 10px; color: rgba(255,255,255,0.6); margin-bottom: 2px;" data-i18n="totalChargeCost">ÂÖÖÁîµÊàêÊú¨</div>
                    <div style="font-size: 20px; font-weight: 700; color: #ff6b6b;" id="totalChargeCost">$12,450</div>
                </div>
                <!-- ÂàÜÂâ≤Á∫ø -->
                <div style="width: 1px; background: rgba(255,255,255,0.1); margin: 8px 0;"></div>
                <!-- ÊîæÁîµÊî∂Áõä -->
                <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 8px 4px;">
                    <div style="font-size: 18px; margin-bottom: 4px;">üìà</div>
                    <div style="font-size: 10px; color: rgba(255,255,255,0.6); margin-bottom: 2px;" data-i18n="totalDischargeRevenue">ÊîæÁîµÊî∂Áõä</div>
                    <div style="font-size: 20px; font-weight: 700; color: #00ff88;" id="totalDischargeRevenue">$28,930</div>
                </div>
                <!-- ÂàÜÂâ≤Á∫ø -->
                <div style="width: 1px; background: rgba(255,255,255,0.1); margin: 8px 0;"></div>
                <!-- ÂáÄËé∑Âà© -->
                <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 8px 4px;">
                    <div style="font-size: 18px; margin-bottom: 4px;">üí∞</div>
                    <div style="font-size: 10px; color: rgba(255,255,255,0.6); margin-bottom: 2px;" data-i18n="netProfit">ÂáÄËé∑Âà©</div>
                    <div style="font-size: 20px; font-weight: 700; color: #00ff88;" id="totalNetProfit">$16,480</div>
                </div>
            </div>

            <!-- Top Stats Row -->
        <div class="stats-row" style="align-items: stretch; margin-left: 0; margin-right: 0; width: 100%;">
            <!-- Power Station Management Card -->
            <div class="custom-card power-station-card" style="width: 100%; height: 100% !important; background: rgba(255,255,255,0.03); border-radius: 16px; border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 4px 24px rgba(0,255,136,0.04); margin-bottom: 0; display: flex; flex-direction: column; padding: 16px; overflow: visible; box-sizing: border-box; position: relative;">
                <!-- Header -->
                <div style="display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;">
                    <h3 style="margin: 0; font-size: 15px; font-weight: 600; color: #fff; display: flex; align-items: center; gap: 8px;">
                        <span data-i18n="station">ÁîµÁ´ôÁÆ°ÁêÜ</span>
                        <span id="regionStatusText" style="font-size: 11px; font-weight: 500; padding: 2px 8px; border-radius: 6px; display: none;"></span>
                    </h3>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <span style="font-size: 11px; color: rgba(255,255,255,0.6); font-weight: 500;" data-i18n="autoMode">Êô∫ËÉΩÊâòÁÆ°</span>
                        <div class="auto-toggle-switch" onclick="toggleAutoMode()" style="position: relative; width: 34px; height: 18px; background: rgba(255,255,255,0.1); border-radius: 10px; cursor: pointer; transition: all 0.3s; border: 1px solid rgba(255,255,255,0.2);">
                            <div id="autoToggleKnob" style="position: absolute; top: 1px; right: 1px; width: 14px; height: 14px; background: #fff; border-radius: 50%; transition: all 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></div>
                        </div>
                    </div>
                </div>

                <!-- AIÈ¢ÑÊµãÁä∂ÊÄÅÊñáÊú¨ÔºàÂ§ßÂúÜ‰∏äÊñπÔºâ -->
                <div id="aiPredictionText" style="flex-shrink: 0; text-align: center; padding: 0 10px; display: none;">
                    <span id="aiPredictionContent" style="font-size: 15px; font-weight: 600; color: rgba(0,255,136,0.85); letter-spacing: 0.3px;"></span>
                    <div id="aiCountdownFlip" class="flip-clock" style="display: none;">
                        <div style="display: flex; flex-direction: column; align-items: center;">
                            <div class="flip-group">
                                <div class="flip-card" id="flipH0">
                                    <div class="flip-top"><div class="flip-digit">0</div></div>
                                    <div class="flip-bottom"><div class="flip-digit">0</div></div>
                                </div>
                                <div class="flip-card" id="flipH1">
                                    <div class="flip-top"><div class="flip-digit">0</div></div>
                                    <div class="flip-bottom"><div class="flip-digit">0</div></div>
                                </div>
                            </div>
                            <div class="flip-label">Êó∂</div>
                        </div>
                        <span class="flip-separator">:</span>
                        <div style="display: flex; flex-direction: column; align-items: center;">
                            <div class="flip-group">
                                <div class="flip-card" id="flipM0">
                                    <div class="flip-top"><div class="flip-digit">0</div></div>
                                    <div class="flip-bottom"><div class="flip-digit">0</div></div>
                                </div>
                                <div class="flip-card" id="flipM1">
                                    <div class="flip-top"><div class="flip-digit">0</div></div>
                                    <div class="flip-bottom"><div class="flip-digit">0</div></div>
                                </div>
                            </div>
                            <div class="flip-label">ÂàÜ</div>
                        </div>
                        <span class="flip-separator">:</span>
                        <div style="display: flex; flex-direction: column; align-items: center;">
                            <div class="flip-group">
                                <div class="flip-card" id="flipS0">
                                    <div class="flip-top"><div class="flip-digit">0</div></div>
                                    <div class="flip-bottom"><div class="flip-digit">0</div></div>
                                </div>
                                <div class="flip-card" id="flipS1">
                                    <div class="flip-top"><div class="flip-digit">0</div></div>
                                    <div class="flip-bottom"><div class="flip-digit">0</div></div>
                                </div>
                            </div>
                            <div class="flip-label">Áßí</div>
                        </div>
                    </div>
                </div>

                <!-- ÂúÜÂΩ¢‰∏ªÂå∫ÂüüÔºàflex:1 ÊíëÊª°‰∏≠ÈÉ®ÔºåÂÜÖÂÆπÂ±Ö‰∏≠Ôºâ -->
                <div style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 20px;">
                    <button class="action-btn charge-btn" id="chargeBtn" onclick="window.handleCharge ? window.handleCharge() : handleCharge()" style="width: 60px; height: 42px; background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%); color: #000; border: none; border-radius: 21px; font-size: 13px; font-weight: 700; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(0,255,136,0.3); display: flex; align-items: center; justify-content: center;">
                        <span data-i18n="charge">ÂÖÖÁîµ</span>
                    </button>

                    <div id="circleOrbitWrapper" style="position: relative; width: 180px; height: 180px; flex-shrink: 0;">
                        <div id="aiOrbitTrack"></div>
                        <div id="aiOrbitRobot">
                            <svg viewBox="0 0 24 24" width="28" height="28" fill="none">
                                <rect x="4" y="8" width="16" height="12" rx="3" stroke="#00ff88" stroke-width="1.5" fill="rgba(0,255,136,0.1)"/>
                                <circle cx="9" cy="14" r="2" fill="#00ff88"/>
                                <circle cx="15" cy="14" r="2" fill="#00ff88"/>
                                <path d="M8 8V6a4 4 0 0 1 8 0v2" stroke="#00ff88" stroke-width="1.5" stroke-linecap="round"/>
                                <line x1="12" y1="2" x2="12" y2="4" stroke="#00ff88" stroke-width="1.5" stroke-linecap="round"/>
                                <circle cx="12" cy="1.5" r="1" fill="#00ff88"/>
                            </svg>
                        </div>
                        <div id="mainPriceCircle" style="position: relative; width: 180px; height: 180px; flex-shrink: 0; cursor: pointer; transition: transform 0.3s ease; border-radius: 50%; overflow: hidden; background: #666;" onclick="handleMainCircleClick()" onmouseenter="handleMainCircleHover()" onmouseleave="handleMainCircleLeave()">
                            <div id="waterLevelContainer" style="position: absolute; bottom: 0; left: 0; width: 100%; height: 100%; transition: height 0.5s ease; z-index: 1;">
                                <div id="waterWaveContainer" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #5AC8FA; transition: background 0.3s ease;"></div>
                            </div>
                            <div id="priceDisplay" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 10; transition: opacity 0.3s ease;">
                                <div style="font-size: 30px; font-weight: 700; color: #fff;" id="currentPrice">$163</div>
                                <div style="font-size: 13px; color: rgba(255,255,255,0.85); margin-top: 3px; font-weight: 600;" id="stationStatusLabel">ÁîµÁ´ôÁä∂ÊÄÅ</div>
                            </div>
                            <div id="statusDisplay" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 10; display: none; opacity: 0; transition: opacity 0.3s ease;">
                                <div id="statusText" style="font-size: 13px; font-weight: 600; color: rgba(255,255,255,0.9); line-height: 1.4;"></div>
                            </div>
                            <div id="hoverOverlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #ff4444; opacity: 0; transition: opacity 0.3s ease; z-index: 15; pointer-events: none;"></div>
                            <div id="stopDisplay" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 20; display: none; opacity: 0; transition: opacity 0.3s ease;">
                                <div style="font-size: 16px; font-weight: 700; color: #fff;" data-i18n="stop">ÂÅúÊ≠¢</div>
                            </div>
                        </div>
                    </div>

                    <button class="action-btn discharge-btn" id="dischargeBtn" onclick="window.handleDischarge ? window.handleDischarge() : handleDischarge()" style="width: 60px; height: 42px; background: linear-gradient(135deg, #FFC107 0%, #FFD700 100%); color: #000; border: none; border-radius: 21px; font-size: 13px; font-weight: 700; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(255,193,7,0.3); display: flex; align-items: center; justify-content: center;">
                        <span data-i18n="discharge">ÊîæÁîµ</span>
                    </button>
                </div>

                <!-- Â∫ïÈÉ®Êï∞ÊçÆ -->
                <div style="flex-shrink: 0; display: flex; flex-direction: column; gap: 20px;">
                    <!-- Á¨¨‰∏ÄÊéíÔºöÂ§ßÂç°ÁâáÔºå3‰∏™ÊåáÊ†áÁ´ñÊéí icon‚ÜíÊñáÂ≠ó‚ÜíÊï∞Â≠ó -->
                    <div style="background: rgba(255,255,255,0.05); border-radius: 10px; padding: 14px 10px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 0;">
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 4px 0;">
                            <div style="width: 34px; height: 34px; border-radius: 10px; background: rgba(0,255,136,0.1); display: flex; align-items: center; justify-content: center;">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#00ff88" stroke-width="2" stroke-linecap="round"><rect x="6" y="7" width="12" height="14" rx="2"/><line x1="10" y1="7" x2="10" y2="4"/><line x1="14" y1="7" x2="14" y2="4"/><line x1="6" y1="13" x2="18" y2="13"/></svg>
                            </div>
                            <div style="font-size: 10px; color: rgba(255,255,255,0.5);" data-i18n="currentSOC">ÂΩìÂâçSOC</div>
                            <div style="font-size: 20px; font-weight: 700; color: #00ff88;" id="currentSOCCard">72%</div>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 4px 0; border-left: 1px solid rgba(255,255,255,0.06); border-right: 1px solid rgba(255,255,255,0.06);">
                            <div style="width: 34px; height: 34px; border-radius: 10px; background: rgba(255,107,107,0.1); display: flex; align-items: center; justify-content: center;">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#ff6b6b" stroke-width="2" stroke-linecap="round"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                            </div>
                            <div style="font-size: 10px; color: rgba(255,255,255,0.5);" data-i18n="batteryCost">ÁîµÊ±†ÊàêÊú¨</div>
                            <div style="font-size: 20px; font-weight: 700; color: #ff6b6b;" id="batteryCostCard">$85.50</div>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 4px 0;">
                            <div style="width: 34px; height: 34px; border-radius: 10px; background: rgba(0,255,136,0.1); display: flex; align-items: center; justify-content: center;">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#00ff88" stroke-width="2" stroke-linecap="round"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>
                            </div>
                            <div style="font-size: 10px; color: rgba(255,255,255,0.5);" data-i18n="todayProfit">‰ªäÊó•Ëé∑Âà©</div>
                            <div style="font-size: 20px; font-weight: 700; color: #00ff88;" id="todayProfitCard">$320</div>
                        </div>
                    </div>
                    <!-- Á¨¨‰∫åÊéíÔºöÂÖÖÁîµÂç°Áâá + ÊîæÁîµÂç°Áâá -->
                    <div style="display: flex; gap: 8px;">
                        <div style="flex: 1; background: rgba(0,255,136,0.05); border: 1px solid rgba(0,255,136,0.12); border-radius: 10px; padding: 10px 12px;">
                            <div style="display: flex; align-items: center; gap: 5px; margin-bottom: 8px;">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#00ff88" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><polyline points="19 12 12 19 5 12"/></svg>
                                <span style="font-size: 11px; color: rgba(255,255,255,0.6); font-weight: 600;" data-i18n="todayCharge">‰ªäÊó•ÂÖÖÁîµ</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: baseline;">
                                <div style="font-size: 20px; font-weight: 700; color: #00ff88;" id="todayChargeEnergy">0.00 MWh</div>
                                <div style="font-size: 20px; font-weight: 700; color: #00ff88;" id="todayChargeCost">$0.00</div>
                            </div>
                        </div>
                        <div style="flex: 1; background: rgba(255,193,7,0.05); border: 1px solid rgba(255,193,7,0.12); border-radius: 10px; padding: 10px 12px;">
                            <div style="display: flex; align-items: center; gap: 5px; margin-bottom: 8px;">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#ffc107" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></svg>
                                <span style="font-size: 11px; color: rgba(255,255,255,0.6); font-weight: 600;" data-i18n="todayDischarge">‰ªäÊó•ÊîæÁîµ</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: baseline;">
                                <div style="font-size: 20px; font-weight: 700; color: #ffc107;" id="todayDischargeEnergy">0.00 MWh</div>
                                <div style="font-size: 20px; font-weight: 700; color: #ffc107;" id="todayDischargeRevenue">$0.00</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Âè≥‰æßÂç°ÁâáÂå∫ -->
            <div style="display: flex; flex-direction: column; width: 100%; height: 100%; overflow: visible;">
                <div class="right-panel-scroll" style="overflow: visible; padding-right:10px; height: 100%;">
                    <!-- Ëá™ÂÆö‰πâÂç°Áâá -->
                    <div class="custom-card" style="height: 100% !important; min-height: 540px; margin-bottom: 0; box-sizing: border-box;">
                        <div style="padding: 16px; position: relative; display: flex; flex-direction: column; min-height: 510px; overflow: visible; box-sizing: border-box;">
                            <!-- Ë°åÊÉÖ / ÂàÜÊûê ‰∏ãÂàíÁ∫ø Tab -->
                            <div style="display: flex; gap: 0; border-bottom: 1px solid rgba(255,255,255,0.08); margin: 0 0 16px 0;">
                                <button id="aemoTabMarket" onclick="switchAemoTab('market')" style="background:none;border:none;outline:none;cursor:pointer;padding:8px 24px;font-size:14px;font-weight:500;color:#00ff88;border-bottom:2px solid #00ff88;margin-bottom:-1px;transition:all 0.25s;" data-i18n="aemoTabMarket">Ë°åÊÉÖ</button>
                                <button id="aemoTabAnalysis" onclick="switchAemoTab('analysis')" style="background:none;border:none;outline:none;cursor:pointer;padding:8px 24px;font-size:14px;font-weight:500;color:rgba(255,255,255,0.45);border-bottom:2px solid transparent;margin-bottom:-1px;transition:all 0.25s;" data-i18n="aemoTabAnalysis">ÂàÜÊûê</button>
                            </div>

                            <!-- Market Panel -->
                            <div id="marketPanel" class="panel-content active" style="padding-left: 20px; padding-right: 20px;">
                                <!-- Price Cards -->
                                <div class="market-section">
                                    <div class="price-cards" style="display: flex; gap: 20px;">
                                        <!-- Combined card for first 4 items -->
                                        <div class="price-card" style="flex: 1; display: flex; flex-direction: column; padding: 0; overflow: hidden; min-height: 120px;">
                                            <div style="display: flex; height: 100%;">
                                                <div style="flex: 1; padding: 20px 24px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer;" onclick="updateMainChart('price')">
                                                    <div class="price-card-label" data-i18n="currentSpotPrice" style="font-size: 13px; font-weight: 500;">CURRENT SPOT PRICE</div>
                                                    <div class="price-card-label" style="font-size: 11px;">($/MWh)</div>
                                                    <div class="price-card-value" id="spotPrice" style="font-size: 28px; font-weight: 700; margin-top: 8px;">$162.73</div>
                                                </div>
                                                <div style="width: 1px; background: rgba(255, 255, 255, 0.1); margin: 16px 0;"></div>
                                                <div style="flex: 1; padding: 20px 24px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer;" onclick="updateMainChart('demand')">
                                                    <div class="price-card-label" data-i18n="currentDemand" style="font-size: 13px; font-weight: 500;">CURRENT DEMAND</div>
                                                    <div class="price-card-label" style="font-size: 11px;">(MW)</div>
                                                    <div class="price-card-value" id="currentDemand" style="font-size: 28px; font-weight: 700; margin-top: 8px;">8,344</div>
                                                </div>
                                                <div style="width: 1px; background: rgba(255, 255, 255, 0.1); margin: 16px 0;"></div>
                                                <div style="flex: 1; padding: 20px 24px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer;" onclick="updateMainChart('forecast')">
                                                    <div class="price-card-label" data-i18n="forecastPrice" style="font-size: 13px; font-weight: 500;">FORECAST PRICE</div>
                                                    <div class="price-card-label" style="font-size: 11px;">($/MWh - NEXT 30MIN)</div>
                                                    <div class="price-card-value" id="forecastPrice" style="font-size: 28px; font-weight: 700; margin-top: 8px;">$162.73</div>
                                                </div>
                                                <div style="width: 1px; background: rgba(255, 255, 255, 0.1); margin: 16px 0;"></div>
                                                <div style="flex: 1; padding: 20px 24px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer;" onclick="updateMainChart('forecastDemand')">
                                                    <div class="price-card-label" data-i18n="forecastDemand" style="font-size: 13px; font-weight: 500;">FORECAST DEMAND</div>
                                                    <div class="price-card-label" style="font-size: 11px;">(MW - NEXT 30MIN)</div>
                                                    <div class="price-card-value" id="forecastDemand" style="font-size: 28px; font-weight: 700; margin-top: 8px;">8,202</div>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Demand vs Generation card -->
                                        <div class="price-card demand-gen-card" style="flex: 0 0 20%; padding: 16px 12px; display: flex; flex-direction: column; min-height: 120px;">
                                            <div style="flex: 1; display: flex; flex-direction: column; justify-content: center;">
                                                <!-- Demand Row -->
                                                <div style="margin-bottom: 16px;">
                                                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                                        <span style="font-size: 12px; color: rgba(255, 255, 255, 0.7);" data-i18n="demand">ÈúÄÊ±Ç</span>
                                                        <span style="font-size: 15px; font-weight: 700; color: #fff;">9,692 <span style="font-size: 11px; font-weight: 500; color: rgba(255, 255, 255, 0.7);">kWh</span></span>
                                                    </div>
                                                    <div style="height: 16px; background: transparent; border-radius: 6px; overflow: hidden;">
                                                        <div style="width: 100%; height: 100%; background: rgba(0, 255, 136, 0.5); border-radius: 6px; display: flex; align-items: center; justify-content: center;">
                                                            <span style="font-size: 12px;">üë§</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!-- Generation Row -->
                                                <div>
                                                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                                        <span style="font-size: 12px; color: rgba(255, 255, 255, 0.7);" data-i18n="generation">ÂèëÁîµ</span>
                                                        <span style="font-size: 15px; font-weight: 700; color: #fff;">8,319 <span style="font-size: 11px; font-weight: 500; color: rgba(255, 255, 255, 0.7);">kWh</span></span>
                                                    </div>
                                                    <div style="height: 16px; background: transparent; border-radius: 6px; overflow: hidden; position: relative;">
                                                        <!-- Èó™ÁîµÂèëÁîµÈÉ®ÂàÜ 60% -->
                                                        <div style="width: 60%; height: 100%; background: rgba(0, 170, 255, 0.5); position: absolute; left: 0; top: 0; display: flex; align-items: center; justify-content: center;">
                                                            <span style="font-size: 12px;">‚ö°</span>
                                                        </div>
                                                        <!-- È£éÂäõÂèëÁîµÈÉ®ÂàÜ 20% -->
                                                        <div style="width: 20%; height: 100%; background: rgba(64, 224, 208, 0.5); position: absolute; left: 60%; top: 0; display: flex; align-items: center; justify-content: center;">
                                                            <span style="font-size: 12px;">üí®</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Market Chart -->
                                <div id="marketChart" style="height: 370px; width: 100%; margin-top: 40px;"></div>

                            </div>

                            <!-- Analysis Panel (AI ÂàÜÊûê tab) -->
                            <div id="analysisPanel" style="display: none; padding: 0 20px; flex-direction: column; flex: 1;">
                                <!-- AI Áä∂ÊÄÅÊ†è + È¢Ñ‰º∞Âà©Ê∂¶ÔºàÂπ∂ÊéíÔºâ -->
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                                    <div>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <div id="aiPulse" style="width: 10px; height: 10px; border-radius: 50%; background: #00ff88; box-shadow: 0 0 6px rgba(0,255,136,0.6), 0 0 14px rgba(0,255,136,0.25); animation: aiPulseAnim 2s ease-in-out infinite;"></div>
                                            <span style="font-size: 14px; font-weight: 700; color: #00ff88;" id="aiStatusLabel" data-i18n="aiAnalyzing">AI ÂàÜÊûê‰∏≠</span>
                                        </div>
                                        <div id="aiAnalysisTime" style="font-size: 11px; color: rgba(255,255,255,0.65); margin-top: 3px; padding-left: 18px;"></div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 12px; color: rgba(255,255,255,0.7);" data-i18n="aiEstProfit">È¢Ñ‰º∞Âà©Ê∂¶</div>
                                        <div style="font-size: 20px; font-weight: 700; color: #00ff88;" id="aiEstSpread"></div>
                                    </div>
                                </div>
                                <!-- Á≠ñÁï•Âç°Áâá -->
                                <div id="aiStrategyCards" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; align-items: start;"></div>
                                <!-- Ëø∑‰Ω†‰ª∑Ê†ºËµ∞ÂäøÂõæ -->
                                <div id="aiMiniChart" style="height: 360px; margin-bottom: 10px;"></div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>

        
        <!-- Á¨¨‰∏âÊéíÔºöÊîæÁîµ‰∏éËé∑Âà©ÔºàÂÖ®Â±èÂÆΩÂ∫¶Ôºâ -->
        <div style="margin-bottom: 20px; margin-top: 0;">
            <!-- Discharge & Profit Chart ÊîæÁîµ‰∏éÊî∂Áõä -->
                <div class="card" style="height:422px; min-height:422px; max-height:422px; margin-top:0; display:flex; flex-direction:column; align-items:stretch; justify-content:flex-start; padding:24px;">
                    <div class="chart-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
                        <div class="chart-title" style="font-size:18px; font-weight:500; color:var(--color-text);">
                            <span data-i18n="profit.charts.dischargeAndProfit">ÁîµÈáè‰∏éËé∑Âà©</span>
                            <span style="font-size:12px; font-weight:400; color:rgba(255,255,255,0.6); margin-left:8px;" data-i18n="profit.charts.profitFormula">ÔºàËé∑Âà©=È¶àÁΩëÈáè*‰ª∑Ê†ºÔºâ</span>
                        </div>
                        <div style="display:flex; align-items:center; gap:12px;">
                            <!-- Time Period Dropdown (on left) -->
                            <select id="discharge-period-select" class="period-dropdown" onchange="handleDischargePeriodChange()" style="background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.15); border-radius: 10px; padding:6px 12px; color:#fff; font-size:13px; min-width:80px; cursor:pointer; outline:none;">
                                <option value="day" data-i18n="day">Êó•</option>
                                <option value="month" data-i18n="month">Êúà</option>
                                <option value="year" data-i18n="year">Âπ¥</option>
                                <option value="cumulative" data-i18n="cumulative">Á¥ØËÆ°</option>
                            </select>
                            <!-- Date Picker (shown on right when not cumulative) -->
                            <div id="discharge-date-picker" style="display:flex; align-items:center;">
                                <input type="date" id="discharge-date-input" class="date-input" style="background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.15); border-radius: 10px; padding:6px 12px; color:#fff; font-size:13px; min-width:140px;">
                            </div>
                        </div>
                    </div>
                    <div id="powerRevenueChart" style="width:100%; height:calc(100% - 70px); min-height:0;"></div>
                </div>
            </div>
            
        </div>

        <!-- Analytics Section -->
        

        <!-- System Overview -->
        <div class="glass system-overview" style="display:none;">
            <div class="chart-header">
                <h3 class="chart-title" data-i18n="systemOverview">Á≥ªÁªüÊ¶ÇËßà</h3>
            </div>
            
            <div class="overview-stats">
                <div class="overview-item">
                    <div class="overview-label" data-i18n="totalCapacity">ÊÄªÂÆπÈáè</div>
                    <div class="overview-value">1,200 MWh</div>
                </div>
                <div class="overview-item">
                    <div class="overview-label" data-i18n="onlineDevices">Âú®Á∫øËÆæÂ§á</div>
                    <div class="overview-value" id="onlineDevices">196/200</div>
                </div>
                <div class="overview-item">
                    <div class="overview-label" data-i18n="networkStatus">ÁΩëÁªúÁä∂ÊÄÅ</div>
                    <div class="overview-value status-active" data-i18n="normal">Ê≠£Â∏∏</div>
                </div>
            </div>

            <div class="performance-chart" id="systemPerformance"></div>
            
            <div class="overview-footer">
                <div class="overview-item">
                    <div class="overview-label" data-i18n="totalGridDischarge">Á¥ØËÆ°ÊîæÁîµ‰∏äÁΩëÈáè</div>
                    <div class="overview-value" id="totalDischargeOverview">445.2 MWh</div>
                </div>
                <div class="overview-item">
                    <div class="overview-label">Á¥ØËÆ°Êî∂Áõä</div>
                    <div class="overview-value" id="totalRevenueOverview">$186,430</div>
                </div>
            </div>


            <!-- Stats Overview Grid -->
            <div class="metrics-grid">
                <div class="stat-overview-card">
                    <div class="stat-overview-icon">üè†</div>
                    <div class="stat-overview-label" data-i18n="family">ÂÆ∂Â∫≠</div>
                    <div class="stat-overview-value" id="totalHomes">235</div>
                </div>
                
                <div class="stat-overview-card">
                    <div class="stat-overview-icon">üîã</div>
                    <div class="stat-overview-label" data-i18n="installedCapacity">Ë£ÖÊú∫Èáè</div>
                    <div class="stat-overview-value" id="installedCapacity">235,000KW</div>
                </div>

                <div class="stat-overview-card">
                    <div class="stat-overview-icon">‚ö°</div>
                    <div class="stat-overview-label" data-i18n="totalGridDischarge">Á¥ØËÆ°ÊîæÁîµ‰∏äÁΩëÈáè</div>
                    <div class="stat-overview-value" id="totalDischarge">234kwh</div>
                </div>

                <div class="stat-overview-card">
                    <div class="stat-overview-icon">üí∞</div>
                    <div class="stat-overview-label">Á¥ØËÆ°Ëé∑Âà©</div>
                    <div class="stat-overview-value" id="totalProfit">$12,435</div>
                </div>
            </div>
            
            <!-- Analysis Page Modules: Discharge Statistics & Price Statistics -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-top: 32px;">
                <!-- Discharge Statistics Module -->
                <div class="card" style="padding: 24px; background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1);">
                    <h3 style="color: #fff; font-size: 18px; font-weight: 600; margin: 0 0 20px 0;">
                        <span data-i18n="dischargeStatistics">Discharge Statistics</span>
                    </h3>
                    
                    <!-- Top Stats Row -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <div style="color: rgba(255, 255, 255, 0.6); font-size: 13px; margin-bottom: 4px;">
                                <span data-i18n="outputAmount">Output</span>
                            </div>
                            <div style="display: flex; align-items: baseline; gap: 8px;">
                                <span style="color: #fff; font-size: 28px; font-weight: 700;">18.50</span>
                                <span style="color: rgba(255, 255, 255, 0.7); font-size: 14px;">kWh</span>
                                <span style="color: #00ff88; font-size: 12px; font-weight: 600;">8.0%</span>
                            </div>
                        </div>
                        <div>
                            <div style="color: rgba(255, 255, 255, 0.6); font-size: 13px; margin-bottom: 4px;">
                                <span data-i18n="inputAmount">Input</span>
                            </div>
                            <div style="display: flex; align-items: baseline; gap: 8px;">
                                <span style="color: #fff; font-size: 28px; font-weight: 700;">20.50</span>
                                <span style="color: rgba(255, 255, 255, 0.7); font-size: 14px;">kWh</span>
                                <span style="color: #ff6b6b; font-size: 12px; font-weight: 600;">5.0%</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bottom Stats Row -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div style="background: rgba(0, 255, 136, 0.1); border: 1px solid rgba(0, 255, 136, 0.2); border-radius: 10px; padding: 20px; text-align: center;">
                            <div style="color: #00ff88; font-size: 32px; font-weight: 700; margin-bottom: 8px;">3</div>
                            <div style="color: rgba(255, 255, 255, 0.6); font-size: 13px;">
                                <span data-i18n="usersExceedingTarget">Users Exceeding Target</span>
                            </div>
                        </div>
                        <div style="background: rgba(255, 107, 107, 0.1); border: 1px solid rgba(255, 107, 107, 0.2); border-radius: 10px; padding: 20px; text-align: center;">
                            <div style="color: #ff6b6b; font-size: 32px; font-weight: 700; margin-bottom: 8px;">17</div>
                            <div style="color: rgba(255, 255, 255, 0.6); font-size: 13px;">
                                <span data-i18n="usersNotExceedingTarget">Users Not Exceeding Target</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Price Statistics Module -->
                <div class="card" style="padding: 24px; background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1);">
                    <h3 style="color: #fff; font-size: 18px; font-weight: 600; margin: 0 0 20px 0;">
                        <span data-i18n="priceStatistics">Price Statistics</span>
                    </h3>
                    
                    <!-- Top Prices Row -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <div style="color: #fff; font-size: 28px; font-weight: 700; margin-bottom: 4px;">$185</div>
                            <div style="color: rgba(255, 255, 255, 0.6); font-size: 13px; margin-bottom: 8px;">
                                <span data-i18n="todaysPrice">Today's Price</span>
                            </div>
                            <div style="background: rgba(0, 255, 136, 0.2); color: #00ff88; padding: 4px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; display: inline-block;">
                                +5.2%
                            </div>
                        </div>
                        <div>
                            <div style="color: #fff; font-size: 28px; font-weight: 700; margin-bottom: 4px;">$152</div>
                            <div style="color: rgba(255, 255, 255, 0.6); font-size: 13px; margin-bottom: 8px;">
                                <span data-i18n="avgDischargePrice">Avg Discharge Price</span>
                            </div>
                            <div style="background: rgba(0, 255, 136, 0.2); color: #00ff88; padding: 4px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; display: inline-block;">
                                +3.8%
                            </div>
                        </div>
                    </div>
                    
                    <!-- Price Details Section -->
                    <div style="background: rgba(255, 255, 255, 0.05); border-radius: 10px; padding: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <span style="background: #00ff88; color: #000; padding: 6px 12px; border-radius: 16px; font-size: 12px; font-weight: 600;">
                                <span data-i18n="sellPrice">Sell Price</span>
                            </span>
                        </div>
                        
                        <div style="margin-bottom: 8px;">
                            <span style="color: rgba(255, 255, 255, 0.6); font-size: 13px;">
                                <span data-i18n="todaysLowest">Today's Lowest</span>
                            </span>
                            <span style="color: #fff; font-size: 14px; font-weight: 600; float: right;">$120</span>
                        </div>
                        
                        <div style="margin-bottom: 8px;">
                            <span style="color: rgba(255, 255, 255, 0.6); font-size: 13px;">
                                <span data-i18n="todaysHighest">Today's Highest</span>
                            </span>
                            <span style="color: #fff; font-size: 14px; font-weight: 600; float: right;">$220</span>
                        </div>
                        
                        <div style="border-top: 1px solid rgba(255, 255, 255, 0.1); padding-top: 8px;">
                            <span style="color: rgba(255, 255, 255, 0.6); font-size: 13px;">
                                <span data-i18n="sellPrice">Sell Price</span>
                            </span>
                            <span style="color: #fff; font-size: 14px; font-weight: 600; float: right;">$185</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal for operation verification -->
    <div id="confirmationModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 10000; align-items: center; justify-content: center; backdrop-filter: blur(15px) saturate(1.5);">
        <div class="modal-content" style="background: linear-gradient(145deg, #1e1e2e 0%, #252535 100%); border: none; padding: 0; overflow: hidden; width: 480px; max-width: 90%; border-radius: 24px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8), 0 0 1px rgba(255, 255, 255, 0.1);">
            <div class="modal-header" style="padding: 32px 36px 28px; border-bottom: 1px solid rgba(255, 255, 255, 0.08); display: flex; align-items: center; justify-content: flex-start; background: rgba(255, 255, 255, 0.02);">
                <div class="modal-icon" style="width: 56px; height: 56px; background: linear-gradient(145deg, rgba(0, 255, 136, 0.15), rgba(0, 255, 136, 0.05)); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 20px; box-shadow: 0 4px 12px rgba(0, 255, 136, 0.15);">
                    <span id="confirmIcon" style="font-size: 28px;">‚ö°</span>
                </div>
                <h3 class="modal-title" id="confirmTitle" style="margin: 0; font-size: 24px; font-weight: 700; color: #fff; letter-spacing: 0.5px;">Á°ÆËÆ§ÂÖÖÁîµÊìç‰Ωú</h3>
            </div>
            
            <div class="modal-body" style="padding: 36px;">
                <p id="confirmMessage" style="font-size: 16px; color: rgba(255, 255, 255, 0.7); margin: 0 0 32px 0; font-weight: 400; line-height: 1.6;">ÊÇ®Á°ÆÂÆöË¶ÅÊâßË°åÂÖÖÁîµÊìç‰ΩúÂêóÔºü</p>
                
                <div class="modal-info-grid" id="confirmInfoGrid" style="display: flex; flex-direction: column; gap: 0; margin-bottom: 32px;">
                    <div style="display: flex; gap: 20px;">
                        <div class="modal-info-item" style="flex: 1; background: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 16px; padding: 20px 24px; transition: all 0.3s;">
                            <div class="modal-info-label" style="color: rgba(255, 255, 255, 0.6); font-size: 14px; margin-bottom: 8px; font-weight: 400;" data-i18n="operationType">Êìç‰ΩúÁ±ªÂûã</div>
                            <div class="modal-info-value" id="confirmOperationType" style="color: #00ff88; font-size: 20px; font-weight: 600; letter-spacing: 0.5px;">ÂÖÖÁîµ</div>
                        </div>
                        <div class="modal-info-item" style="flex: 1; background: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 16px; padding: 20px 24px; transition: all 0.3s;">
                            <div class="modal-info-label" style="color: rgba(255, 255, 255, 0.6); font-size: 14px; margin-bottom: 8px; font-weight: 400;">ÂèØË∞ÉÂ∫¶ËÆæÂ§á</div>
                            <div class="modal-info-value" id="confirmTargetDevices" style="color: #fff; font-size: 20px; font-weight: 600;">500‰∏™</div>
                        </div>
                    </div>
                    <div class="modal-info-item" style="display: none;">
                        <div class="modal-info-label" data-i18n="estimatedPower">È¢ÑËÆ°ÂäüÁéá</div>
                        <div class="modal-info-value" id="confirmEstimatedPower">3.0MW</div>
                    </div>
                    <div class="modal-info-item" style="display: none;">
                        <div class="modal-info-label" data-i18n="currentPrice">ÂΩìÂâçÁîµ‰ª∑</div>
                        <div class="modal-info-value" id="confirmCurrentPrice">$85/MWh</div>
                    </div>
                    <div class="modal-info-item" style="display: none;">
                        <div class="modal-info-label" data-i18n="estimatedDuration">È¢ÑËÆ°Êó∂Èó¥</div>
                        <div class="modal-info-value" id="confirmDuration">15-30ÂàÜÈíü</div>
                    </div>
                    <div class="modal-info-item" style="display: none;">
                        <div class="modal-info-label" data-i18n="estimatedProfit">È¢ÑËÆ°Ëé∑Âà©</div>
                        <div class="modal-info-value" id="confirmCostBenefit">+$178</div>
                    </div>
                </div>
                
                <div class="warning-notice" style="padding: 20px; background: linear-gradient(145deg, rgba(255, 152, 0, 0.08), rgba(255, 152, 0, 0.04)); border: 1px solid rgba(255, 152, 0, 0.15); border-radius: 16px; backdrop-filter: blur(20px) saturate(1.5);">
                    <div style="display: flex; align-items: flex-start; gap: 16px;">
                        <div style="width: 32px; height: 32px; background: rgba(255, 152, 0, 0.15); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <span style="font-size: 18px;">‚ö†Ô∏è</span>
                        </div>
                        <span id="warningText" style="color: rgba(255, 255, 255, 0.8); font-size: 14px; line-height: 1.8; flex: 1;">Â∞ÜÂºÄÂßãÂØπÊâÄÊúâËøûÊé•ËÆæÂ§áËøõË°åÂÖÖÁîµÊìç‰ΩúÔºåÊ≠§ËøáÁ®ãÂ∞ÜÊ∂àËÄóÁîµÁΩëÁîµÂäõ„ÄÇ</span>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer" style="padding: 28px 36px 32px; background: rgba(0, 0, 0, 0.2); border-top: 1px solid rgba(255, 255, 255, 0.08); display: flex; justify-content: flex-end; gap: 16px;">
                <button class="modal-btn modal-cancel-btn" onclick="closeConfirmationModal()" style="background: rgba(255, 255, 255, 0.08); color: rgba(255, 255, 255, 0.8); border: 1px solid rgba(255, 255, 255, 0.1); padding: 14px 36px; border-radius: 999px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s; backdrop-filter: blur(20px) saturate(1.5); letter-spacing: 0.5px;" onmouseover="this.style.background='rgba(255, 255, 255, 0.12)'; this.style.borderColor='rgba(255, 255, 255, 0.2)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.08)'; this.style.borderColor='rgba(255, 255, 255, 0.1)'" data-i18n="cancel">ÂèñÊ∂à</button>
                <button class="modal-btn modal-confirm-btn" onclick="executeConfirmedOperation()" id="confirmExecuteBtn" style="background: linear-gradient(135deg, #00ff88, #00dd77); color: #000; padding: 14px 36px; border-radius: 999px; font-size: 15px; font-weight: 700; cursor: pointer; transition: all 0.3s; border: none; box-shadow: 0 4px 16px rgba(0, 255, 136, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.3); letter-spacing: 0.5px;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 6px 20px rgba(0, 255, 136, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 16px rgba(0, 255, 136, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.3)'">Á°ÆËÆ§ÂÖÖÁîµ</button>
            </div>
        </div>
    </div>

    <!-- Progress Dialog Modal -->
    <div class="progress-dialog" id="progressDialog" style="display: none; position: fixed; top: calc(50% + 60px); left: 50%; transform: translate(-50%, -50%); width: 450px; background: rgba(255, 255, 255, 0.12); backdrop-filter: blur(30px) saturate(1.5); -webkit-backdrop-filter: blur(30px) saturate(1.5); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); cursor: move; z-index: 100; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);">
            
            <!-- Header -->
            <div class="progress-header" style="padding: 24px 32px 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.08); display: flex; align-items: center; justify-content: space-between; background: rgba(255, 255, 255, 0.02); border-radius: 16px 16px 0 0;">
                <div style="display: flex; align-items: center; gap: 16px;">
                    <div style="width: 48px; height: 48px; background: linear-gradient(145deg, rgba(0, 255, 136, 0.15), rgba(0, 255, 136, 0.05)); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0, 255, 136, 0.15);">
                        <span id="progressIcon" style="font-size: 24px;">‚ö°</span>
                    </div>
                    <div>
                        <h3 id="progressTitle" style="margin: 0; font-size: 20px; font-weight: 700; color: #fff;" data-i18n="chargingProgress">ÂÖÖÁîµËøõÂ∫¶</h3>
                        <p id="progressSubtitle" style="margin: 4px 0 0 0; font-size: 14px; color: rgba(255, 255, 255, 0.6);" data-i18n="operationInProgress">Ê≠£Âú®ÊâßË°åÊìç‰Ωú...</p>
                    </div>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button id="progressMinimizeBtn" onclick="minimizeProgressDialog()" style="background: rgba(255, 255, 255, 0.1); border: none; border-radius: 10px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: rgba(255, 255, 255, 0.7); transition: all 0.3s;" onmouseover="this.style.background='rgba(255, 255, 255, 0.15)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.1)'">
                        <span style="font-size: 14px;">‚àí</span>
                    </button>
                </div>
            </div>
            
            <!-- Body -->
            <div class="progress-body" style="padding: 32px;">
                <!-- Progress Info -->
                <div style="display: flex; justify-content: space-between; margin-bottom: 32px;">
                    <div style="text-align: center;">
                        <div id="progressCommandsSent" style="font-size: 32px; font-weight: 700; color: #00ff88; margin-bottom: 4px;">500</div>
                        <div style="font-size: 14px; color: rgba(255, 255, 255, 0.6);" data-i18n="sentDevices">‰∏ãÂèëËÆæÂ§á</div>
                    </div>
                    <div style="text-align: center;">
                        <div id="progressOperationType" style="font-size: 32px; font-weight: 700; color: #00ff88; margin-bottom: 4px;" data-i18n="discharge">ÊîæÁîµ</div>
                        <div style="font-size: 14px; color: rgba(255, 255, 255, 0.6);" data-i18n="type">Á±ªÂûã</div>
                    </div>
                </div>
                
                <!-- Steps -->
                <div class="progress-steps">
                    <!-- Step 1 -->
                    <div class="progress-step" id="progressStep1" style="padding: 20px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="font-size: 16px; font-weight: 600; color: #fff;" data-i18n="readDeviceSettings">1. ËØªÂèñËÆæÂ§áËÆæÁΩÆ‰ø°ÊÅØ</div>
                                <div id="step1Status" style="padding: 4px 12px; background: rgba(255, 193, 7, 0.2); color: #ffc107; border-radius: 10px; font-size: 12px; font-weight: 600;" data-i18n="reading">ËØªÂèñ‰∏≠</div>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div id="step1Progress" style="font-size: 14px; color: rgba(255, 255, 255, 0.7);">1/100</div>
                        </div>
                        <!-- Progress Bar -->
                        <div style="width: 100%; height: 4px; background: rgba(255, 255, 255, 0.1); border-radius: 6px; overflow: hidden;">
                            <div id="step1ProgressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #00ff88, #00cc6a); border-radius: 6px; transition: width 0.3s ease;"></div>
                        </div>
                    </div>
                    
                    <!-- Step 2 -->
                    <div class="progress-step" id="progressStep2" style="padding: 20px 0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="font-size: 16px; font-weight: 600; color: #fff;" data-i18n="modifyDeviceSettings">2. ‰øÆÊîπËÆæÂ§áËÆæÁΩÆ‰ø°ÊÅØ</div>
                                <div id="step2Status" style="padding: 4px 12px; background: rgba(255, 255, 255, 0.1); color: rgba(255, 255, 255, 0.5); border-radius: 10px; font-size: 12px; font-weight: 600;" data-i18n="waiting">Á≠âÂæÖ‰∏≠</div>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div id="step2Progress" style="font-size: 14px; color: rgba(255, 255, 255, 0.7);">1/100</div>
                        </div>
                        <!-- Progress Bar -->
                        <div style="width: 100%; height: 4px; background: rgba(255, 255, 255, 0.1); border-radius: 6px; overflow: hidden;">
                            <div id="step2ProgressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #00ff88, #00cc6a); border-radius: 6px; transition: width 0.3s ease;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    
    <!-- Floating Ball Container -->
    <div id="progressFloatingContainer" class="progress-floating-container" style="display: none; position: fixed; right: 20px; top: 50%; transform: translateY(-50%); z-index: 1000;">
        <!-- Toggle button -->
        <div id="progressToggleBtn" onclick="toggleProgressBalls(event)" style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(145deg, #1e1e2e, #2a2a3a); border: 2px solid #00ff88; display: flex; align-items: center; justify-content: center; cursor: move; margin-bottom: 12px; transition: all 0.3s; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'" data-i18n-title="dragToMoveClickToToggle">
            <span id="progressToggleIcon" style="font-size: 16px; color: #00ff88; font-weight: bold;">‚ñº</span>
        </div>
        <!-- Balls container -->
        <div id="progressBallsContainer" style="transition: all 0.3s ease;">
            <!-- Floating balls will be generated here -->
        </div>
    </div>

    <!-- Modal for operation result -->
    <div id="operationModal" class="modal" style="display: none; z-index: 2147483650; position: fixed;">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            
            <div class="modal-header" style="text-align: left; justify-content: flex-start;">
                <div class="modal-icon success">
                    <span id="modalIcon">‚úì</span>
                </div>
                <div style="margin-left: 12px;">
                    <h3 class="modal-title" id="modalTitle" data-i18n="commandSentSuccess">Êåá‰ª§‰∏ãÂèëÊàêÂäü</h3>
                </div>
            </div>
            
            <div class="modal-body">
                <p id="modalMessage" data-i18n="systemExecuting">Á≥ªÁªüÊ≠£Âú®ÊâßË°åÊÇ®ÁöÑÊìç‰ΩúÊåá‰ª§...</p>
                
                <div class="modal-info-grid">
                    <div class="modal-info-item">
                        <div class="modal-info-label" data-i18n="operationType">Êìç‰ΩúÁ±ªÂûã</div>
                        <div class="modal-info-value" id="operationType">ÂÖÖÁîµ</div>
                    </div>
                    <div class="modal-info-item">
                        <div class="modal-info-label">ÂèØË∞ÉÂ∫¶ËÆæÂ§á</div>
                        <div class="modal-info-value" id="targetDevices">500‰∏™</div>
                    </div>
                </div>
                
                <div class="status-summary" id="statusSummary" style="display: none;">
                    <div class="status-summary-title" data-i18n="deviceResponseStatistics">ËÆæÂ§áÂìçÂ∫îÁªüËÆ°</div>
                    <div class="status-stats">
                        <div class="status-stat">
                            <div class="status-stat-value" id="devicesDispatched">500</div>
                            <div class="status-stat-label" data-i18n="commandsSent">‰∏ãÂèëËÆæÂ§á</div>
                        </div>
                        <div class="status-stat">
                            <div class="status-stat-value" id="successRate">89%</div>
                            <div class="status-stat-label" data-i18n="successRate">ÊàêÂäüÁéá</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="modal-btn modal-btn-primary" onclick="openOperationDrawer()" style="width: 120px; height: 36px; font-size: 14px; padding: 0 16px;">
                    <span data-i18n="viewDetails">Êü•ÁúãËØ¶ÊÉÖ</span>
                </button>
                <button class="modal-btn modal-btn-secondary" onclick="closeOperationResultModal()" style="width: 80px; height: 36px; font-size: 14px; padding: 0 12px; margin-left: 10px;" data-i18n="close">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>

    <!-- Operation Details Panel -->
    <div class="details-panel" id="operationDetailsPanel" style="display: none;">
        <div class="details-panel-header">
            <h3 data-i18n="operationDetails">Operation Details</h3>
            <button class="details-close-btn" onclick="closeDetailsPanel()">√ó</button>
        </div>
        <div class="details-content">
            <div class="details-section">
                <h4 data-i18n="basicInfo">Basic Information</h4>
                <div class="details-grid">
                    <div class="details-item">
                        <span class="details-label" data-i18n="operationType">Operation Type:</span>
                        <span class="details-value" id="detailsOperationType">Charge</span>
                    </div>
                    <div class="details-item">
                        <span class="details-label" data-i18n="targetDevices">Target Devices:</span>
                        <span class="details-value" id="detailsTargetDevices">500 <span data-i18n="devices">ËÆæÂ§á</span></span>
                    </div>
                    <div class="details-item">
                        <span class="details-label" data-i18n="estimatedProfit">Estimated Profit:</span>
                        <span class="details-value" id="detailsEstimatedProfit"><span data-i18n="estimatedProfitValue">+$340</span></span>
                    </div>
                    <div class="details-item">
                        <span class="details-label" data-i18n="operationTime">Operation Time:</span>
                        <span class="details-value" id="detailsOperationTime">2024-06-26 14:30:00</span>
                    </div>
                </div>
            </div>
            
            <div class="details-section">
                <h4 data-i18n="executionStatus">Execution Status</h4>
                <div class="status-overview">
                    <div class="status-item">
                        <div class="status-number" id="detailsDispatched">500</div>
                        <div class="status-label" data-i18n="devicesDispatched">Commands Sent</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Device Status Modal -->
    <div class="device-status-drawer" id="deviceStatusDrawer">
        <div class="drawer-overlay" onclick="closeDeviceStatusDrawer()"></div>
        <div class="drawer-content">
            <div class="drawer-header">
                <h3 style="margin: 0; color: #fff; font-size: 20px;" data-i18n="deviceResponseStatistics">ËÆæÂ§áÂìçÂ∫îÁªüËÆ°</h3>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <button class="drawer-export-btn" onclick="exportDrawerData()" style="background: linear-gradient(135deg, #1e7fff, #0d5dd8); color: #fff; border: none; padding: 8px 20px; border-radius: 16px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 6px;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(30, 127, 255, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                        <span>üì•</span>
                        <span data-i18n="export">ÂØºÂá∫</span>
                    </button>
                    <button class="drawer-close-btn" onclick="closeDeviceStatusDrawer()">√ó</button>
                </div>
            </div>

            <!-- Tab Navigation -->
            <div class="drawer-tabs">
                <button class="drawer-tab active" data-tab="success" onclick="switchDeviceTab('success')">
                    <span data-i18n="success">‰∏ãÂèëÊàêÂäü</span>
                    <span class="drawer-tab-count" id="tabCountSuccess">0</span>
                </button>
                <button class="drawer-tab" data-tab="executing" onclick="switchDeviceTab('executing')">
                    <span data-i18n="executing">ÊâßË°å‰∏≠</span>
                    <span class="drawer-tab-count" id="tabCountExecuting">0</span>
                </button>
                <button class="drawer-tab" data-tab="failed" onclick="switchDeviceTab('failed')">
                    <span data-i18n="failed">‰∏ãÂèëÂ§±Ë¥•</span>
                    <span class="drawer-tab-count" id="tabCountFailed">0</span>
                </button>
            </div>

            <div class="drawer-body">
                <!-- Device Table -->
                <div class="drawer-table-container">
                    <table class="drawer-table">
                        <thead id="drawerTableHead">
                            <tr>
                                <th data-i18n="nmi">NMI</th>
                                <th data-i18n="failureCount">Â§±Ë¥•Ê¨°Êï∞</th>
                                <th data-i18n="status">Áä∂ÊÄÅ</th>
                            </tr>
                        </thead>
                        <tbody id="drawerTableBody">
                            <!-- Device rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Auto Settings Panel -->
    <div class="auto-settings-panel" id="autoSettingsPanel" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10003; backdrop-filter: blur(15px) saturate(1.5);">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 500px; background: var(--color-bg-card); border-radius: 16px; padding: 24px; border: 1px solid var(--color-border); box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: #fff; font-size: 18px;" data-i18n="autoSettings">Êô∫ËÉΩÊâòÁÆ°ËÆæÁΩÆ</h3>
                <button onclick="closeAutoSettings()" style="background: none; border: none; color: rgba(255,255,255,0.7); font-size: 24px; cursor: pointer; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.3s;">√ó</button>
            </div>
            
            <!-- Auto Mode Type Selection -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; color: rgba(255,255,255,0.8); font-size: 14px; margin-bottom: 8px;" data-i18n="autoModeType">Êô∫ËÉΩÊâòÁÆ°Á±ªÂûã</label>
                <div style="display: flex; gap: 8px;">
                    <button id="autoChargeBtn" class="auto-type-btn active" onclick="selectAutoType('charge')" style="flex: 1; padding: 12px; border: none; border-radius: 10px; background: #4CD964; color: #000; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                        <span data-i18n="autoCharge">Êô∫ËÉΩÂÖÖÁîµ</span>
                    </button>
                    <button id="autoDischargeBtn" class="auto-type-btn" onclick="selectAutoType('discharge')" style="flex: 1; padding: 12px; border: none; border-radius: 10px; background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.7); font-weight: 500; cursor: pointer; transition: all 0.3s;">
                        <span data-i18n="autoDischarge">Êô∫ËÉΩÊîæÁîµ</span>
                    </button>
                </div>
            </div>

            <!-- ÂÖÖÁîµÊ®°ÂºèÈÖçÁΩÆ(Êñ∞ÁöÑÂç°ÁâáÂºèËÆæËÆ°) -->
            <div id="chargeConfigSection" style="display: block;">
                <!-- ËØ¥ÊòéÊñáÂ≠ó -->
                <div style="margin-bottom: 12px; padding: 10px; background: rgba(76,217,100,0.08); border-left: 3px solid #4CD964; border-radius: 10px;">
                    <div style="color: rgba(255,255,255,0.9); font-size: 12px; line-height: 1.5;">
                        üí° <span data-i18n="chargeStrategyTip">‰∏∫‰∏çÂêåÊó∂Èó¥ÊÆµËÆæÁΩÆ‰∏çÂêåÁöÑ‰ª∑Ê†ºÈó®ÊßõÔºåÁ≥ªÁªüÂ∞ÜÂêåÊó∂ÁõëÊµãÊâÄÊúâÊó∂Èó¥ÊÆµ</span>
                    </div>
                </div>

                <!-- Ê∑ªÂä†Êó∂Èó¥ÊÆµÊåâÈíÆ -->
                <div style="margin-bottom: 16px;">
                    <button onclick="addChargePlan()" style="width: 100%; padding: 12px; border: 2px dashed rgba(76,217,100,0.4); border-radius: 10px; background: rgba(76,217,100,0.05); color: #4CD964; font-weight: 500; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <span style="font-size: 20px; line-height: 1;">+</span>
                        <span data-i18n="addTimeSlot">Ê∑ªÂä†Êó∂Èó¥ÊÆµ</span>
                    </button>
                </div>

                <!-- Êó∂Èó¥ÊÆµÂàóË°®ÂÆπÂô® -->
                <div id="chargePlansContainer" style="max-height: 300px; overflow-y: auto; margin-bottom: 20px;">
                    <!-- Âç°ÁâáÂ∞ÜÁî±JSÂä®ÊÄÅÁîüÊàê -->
                </div>
            </div>

            <!-- ÊîæÁîµÊ®°ÂºèÈÖçÁΩÆ(Êñ∞ÁöÑÂç°ÁâáÂºèËÆæËÆ°) -->
            <div id="dischargeConfigSection" style="display: none;">
                <!-- ËØ¥ÊòéÊñáÂ≠ó -->
                <div style="margin-bottom: 12px; padding: 10px; background: rgba(255,193,7,0.08); border-left: 3px solid #FFC107; border-radius: 10px;">
                    <div style="color: rgba(255,255,255,0.9); font-size: 12px; line-height: 1.5;">
                        üí° <span data-i18n="dischargeStrategyTip">‰∏∫‰∏çÂêåÊó∂Èó¥ÊÆµËÆæÁΩÆ‰∏çÂêåÁöÑ‰ª∑Ê†ºÈó®ÊßõÔºåÁ≥ªÁªüÂ∞ÜÂêåÊó∂ÁõëÊµãÊâÄÊúâÊó∂Èó¥ÊÆµ</span>
                    </div>
                </div>

                <!-- Ê∑ªÂä†Êó∂Èó¥ÊÆµÊåâÈíÆ -->
                <div style="margin-bottom: 16px;">
                    <button onclick="addDischargePlan()" style="width: 100%; padding: 12px; border: 2px dashed rgba(255,193,7,0.4); border-radius: 10px; background: rgba(255,193,7,0.05); color: #FFC107; font-weight: 500; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <span style="font-size: 20px; line-height: 1;">+</span>
                        <span data-i18n="addTimeSlot">Ê∑ªÂä†Êó∂Èó¥ÊÆµ</span>
                    </button>
                </div>

                <!-- Êó∂Èó¥ÊÆµÂàóË°®ÂÆπÂô® -->
                <div id="dischargePlansContainer" style="max-height: 300px; overflow-y: auto; margin-bottom: 20px;">
                    <!-- Âç°ÁâáÂ∞ÜÁî±JSÂä®ÊÄÅÁîüÊàê -->
                </div>
            </div>

            <!-- Battery Level Condition -->
            <div style="margin-bottom: 24px;">
                <label style="display: block; color: rgba(255,255,255,0.8); font-size: 14px; margin-bottom: 8px;" data-i18n="batteryCondition">ÁîµÈáèÊù°‰ª∂</label>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <select id="autoBatteryOperator" style="padding: 10px; color: #fff; font-size: 14px;">
                        <option value="less" data-i18n="lessThan">‰Ωé‰∫é</option>
                        <option value="greater" data-i18n="greaterThan">È´ò‰∫é</option>
                        <option value="between" data-i18n="between">‰ªã‰∫é</option>
                    </select>
                    <input type="number" id="autoBatteryValue" value="20" min="0" max="100" style="flex: 1; padding: 10px; color: #fff; font-size: 14px;">
                    <input type="number" id="autoBatteryValue2" value="80" min="0" max="100" style="flex: 1; padding: 10px; color: #fff; font-size: 14px; display: none;">
                    <span style="color: rgba(255,255,255,0.7);">%</span>
                </div>
            </div>

            <!-- Action Buttons -->
            <div style="display: flex; gap: 12px;">
                <button onclick="closeAutoSettings()" style="flex: 1; padding: 12px; border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.7); font-weight: 500; cursor: pointer; transition: all 0.3s;">
                    <span data-i18n="cancel">ÂèñÊ∂à</span>
                </button>
                <button onclick="saveAutoSettings()" style="flex: 1; padding: 12px; border: none; border-radius: 10px; background: var(--color-primary); color: #000; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                    <span data-i18n="saveSettings">‰øùÂ≠òËÆæÁΩÆ</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // ===== ÂÖ®Â±ÄÂèòÈáèÂàùÂßãÂåñ =====
        // ÂàùÂßãÂåñÊó∂Èó¥ÊÆµÊï∞ÁªÑÔºåÁ°Æ‰øùÂú®‰ªª‰ΩïÂú∞ÊñπÈÉΩËÉΩËÆøÈóÆ
        window.chargeTimeSegments = window.chargeTimeSegments || [{ start: '22:00', end: '06:00' }];
        window.dischargeTimeSegments = window.dischargeTimeSegments || [{ start: '16:00', end: '21:00' }];
        
        // Â£∞ÊòéÊó∂Èó¥ÊÆµÂèòÈáè
        let chargeTimeSegments = [...window.chargeTimeSegments];
        let dischargeTimeSegments = [...window.dischargeTimeSegments];
        
        // Safe DOM text setter (prevents crash when element is removed)
        function safeSetText(id, val) { const el = document.getElementById(id); if (el) el.textContent = val; }

        // Global variables
        let marketChart, powerChart, performanceChart, mapChart, powerRevenueChart;
        let powerChartTimeSelector, currentOperation = null;
        let activatedDevices = 0, totalDevices = 500, chartUpdateInterval;
        let pendingOperation = null, previousPanel = null;

        // AEMOÊï∞ÊçÆ - ‰ªéAEMO.xlsxÊñá‰ª∂‰∏≠ËØªÂèñÁöÑÁúüÂÆûÊï∞ÊçÆÔºàÊØè5ÂàÜÈíü‰∏Ä‰∏™Êï∞ÊçÆÁÇπÔºåÂÖ±288‰∏™Ôºâ
        let aemoTimeLabels, aemoRealPriceData, aemoRealDemandData;
        
        // Auto operation variables
        let currentOperationMode = 'auto'; // 'manual' or 'auto' - default to auto
        let latestAIForecast = { bestCharge: null, bestDischarge: null }; // AIÈ¢ÑÊµãÁªìÊûúÁºìÂ≠ò
        let autoSettings = {
            charge: {
                // Êñ∞ËÆæËÆ°:Â§öÁªÑÁã¨Á´ãÁöÑÂÖÖÁîµËÆ°Âàí(ÂàÜÊó∂Â§öÈò∂ÂÖÖÁîµÁ≠ñÁï•)
                plans: [
                    {
                        id: 'charge_plan_' + Date.now() + '_1',
                        enabled: true,
                        timeRange: { start: '22:00', end: '06:00' },
                        priceThreshold: 50,
                        priceEnabled: true
                    }
                ],
                stopSOC: 90 // ÂÖ®Â±ÄÂÖÖÁîµÂÅúÊ≠¢SOC
            },
            discharge: {
                // Êñ∞ËÆæËÆ°:Â§öÁªÑÁã¨Á´ãÁöÑÊîæÁîµËÆ°Âàí(ÂàÜÊó∂Â§öÈò∂ÊîæÁîµÁ≠ñÁï•)
                plans: [
                    {
                        id: 'plan_' + Date.now() + '_1',
                        enabled: true,
                        timeRange: { start: '16:00', end: '21:00' },
                        priceThreshold: 100,
                        priceEnabled: true
                    }
                ],
                stopSOC: 20 // ÂÖ®Â±ÄÊîæÁîµÂÅúÊ≠¢SOC
            }
        };
        let autoCheckInterval = null;

        // ‰ªäÊó•ÂÖÖÊîæÁîµÊï∞ÊçÆËøΩË∏™
        let todayChargeData = { energy: 0, cost: 0 };    // Âçï‰Ωç: MWh, $
        let todayDischargeData = { energy: 0, revenue: 0 }; // Âçï‰Ωç: MWh, $
        // Ê≥®ÊÑè: BATTERY_CAPACITY_MWH Â∑≤Âú® line ~5919 ÂÖ®Â±ÄÂÆö‰πâÔºåÊ≠§Â§ÑÁõ¥Êé•Â§çÁî®

        function updateTodayCard() {
            const ce = document.getElementById('todayChargeEnergy');
            const cc = document.getElementById('todayChargeCost');
            const de = document.getElementById('todayDischargeEnergy');
            const dr = document.getElementById('todayDischargeRevenue');
            if (ce) ce.textContent = todayChargeData.energy.toFixed(2) + ' MWh';
            if (cc) cc.textContent = '$' + todayChargeData.cost.toFixed(2);
            if (de) de.textContent = todayDischargeData.energy.toFixed(2) + ' MWh';
            if (dr) dr.textContent = '$' + todayDischargeData.revenue.toFixed(2);
        }

        // ÂêåÊ≠• SOC ËøõÂ∫¶Êù°ÂíåÊï∞ÂÄº
        function updateSOCProgressBar() {
            const soc = getCurrentBatteryLevel();
            const socCard = document.getElementById('currentSOCCard');
            const socBar = document.getElementById('socProgressBar');
            if (socCard) socCard.textContent = Math.round(soc) + '%';
            if (socBar) socBar.style.width = soc + '%';
        }
        // ÊØè 5 ÁßíÂêåÊ≠•‰∏ÄÊ¨° SOC ËøõÂ∫¶Êù° + AIÈ¢ÑÊµãÊñáÊú¨
        setInterval(() => {
            updateSOCProgressBar();
            updateAIPredictionText();
        }, 5000);

        // Êìç‰ΩúÂêØÂä®Êó∂ËÆ°ÁÆóÂπ∂Á¥ØÁßØ‰ªäÊó•Êï∞ÊçÆÔºàÂü∫‰∫éÂΩìÂâç SOC ÂíåÁõÆÊ†á SOCÔºâ
        function accumulateTodayData(operationType) {
            const currentSOC = getCurrentBatteryLevel();
            const price = getCurrentPrice();

            if (operationType === 'charge') {
                const targetSOC = autoSettings.charge.stopSOC || 90;
                const socRange = Math.max(0, targetSOC - currentSOC) / 100;
                const energyMWh = socRange * BATTERY_CAPACITY_MWH;
                todayChargeData.energy += energyMWh;
                todayChargeData.cost += energyMWh * price;
            } else if (operationType === 'discharge') {
                const stopSOC = autoSettings.discharge.stopSOC || 20;
                const socRange = Math.max(0, currentSOC - stopSOC) / 100;
                const energyMWh = socRange * BATTERY_CAPACITY_MWH;
                todayDischargeData.energy += energyMWh;
                todayDischargeData.revenue += energyMWh * price;
            }
            updateTodayCard();
        }
        
        // Auto operation functions
        function toggleAutoMode() {
            // Ê£ÄÊü•ÂΩìÂâçÊòØÂê¶ÊúâÊ≠£Âú®ËøõË°åÁöÑÊìç‰Ωú
            const operationStatus = getRegionOperationStatus(selectedMainRegion);
            const isOperationActive = operationStatus === 'charging' || operationStatus === 'discharging';
            
            if (isOperationActive) {
                // ÊòæÁ§∫ÊèêÁ§∫‰ø°ÊÅØÔºåÁ¶ÅÊ≠¢ÂàáÊç¢
                showAutoSwitchDisabledTooltip();
                return;
            }
            
            const isCurrentlyAuto = currentOperationMode === 'auto';
            
            if (!isCurrentlyAuto) {
                // ÂàáÊç¢Âà∞Ëá™Âä®Ê®°ÂºèÊó∂ÔºåÊòæÁ§∫Á°ÆËÆ§ÂºπÁ™ó
                showAutoModeConfirmDialog();
            } else {
                // ‰ªéËá™Âä®Ê®°ÂºèÂàáÊç¢Âà∞ÊâãÂä®Ê®°ÂºèÔºå‰πüÊòæÁ§∫Á°ÆËÆ§ÂºπÁ™ó
                showDisableAutoModeConfirmDialog();
            }
        }
        
        function showAutoModeConfirmDialog() {
            const i18n = window.i18n;

            // ÂàõÂª∫Á°ÆËÆ§ÂºπÁ™ó
            const modal = document.createElement('div');
            modal.id = 'autoModeConfirmModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.9);
                z-index: 10005;
                display: flex;
                align-items: center;
                justify-content: center;
                backdrop-filter: blur(15px) saturate(1.5);
                animation: fadeIn 0.3s ease;
            `;

            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: linear-gradient(145deg, #1e1e2e 0%, #252535 100%);
                border-radius: 16px;
                padding: 0;
                width: 520px;
                max-width: 90%;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8), 0 0 1px rgba(255, 255, 255, 0.1);
                animation: slideUp 0.3s ease;
            `;

            modalContent.innerHTML = `
                <div style="padding: 24px 28px; border-bottom: 1px solid rgba(255, 255, 255, 0.08); background: rgba(255, 255, 255, 0.02);">
                    <h3 style="margin: 0; font-size: 18px; font-weight: 700; color: #fff;">${i18n ? i18n.getText('confirmAutoMode') : 'Á°ÆËÆ§ÂêØÁî®Êô∫ËÉΩÊâòÁÆ°'}</h3>
                </div>

                <div style="padding: 24px 28px;">
                    <p style="color: rgba(255, 255, 255, 0.8); font-size: 14px; margin: 0 0 20px 0;">
                        ${i18n ? i18n.getText('autoModeDescription') : 'ÂêØÁî®ÂêéÔºåAIÂ∞ÜÂÆûÊó∂ÂàÜÊûêÂ∏ÇÂú∫Êï∞ÊçÆÔºåËá™Âä®ÂØªÊâæÊúÄ‰ºòÂÖÖÊîæÁîµÊó∂Êú∫ÔºåÊúÄÂ§ßÂåñÊÇ®ÁöÑÊî∂Áõä„ÄÇ'}
                    </p>

                    <!-- AI ËÉΩÂäõËØ¥Êòé - 2x2 ÁΩëÊ†º -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                        <div style="background: rgba(0, 255, 136, 0.05); border: 1px solid rgba(0, 255, 136, 0.15); border-radius: 10px; padding: 14px;">
                            <div style="font-size: 20px; margin-bottom: 6px;">üìä</div>
                            <div style="font-size: 13px; font-weight: 600; color: #fff; margin-bottom: 4px;">${i18n ? i18n.getText('aiPriceAnalysis') : 'ÂÆûÊó∂‰ª∑Ê†ºÂàÜÊûê'}</div>
                            <div style="font-size: 11px; color: rgba(255,255,255,0.6); line-height: 1.5;">${i18n ? i18n.getText('aiPriceAnalysisDesc') : 'ÊåÅÁª≠ÁõëÊµãAEMOÁé∞Ë¥ß‰ª∑Ê†º‰∏éÈúÄÊ±ÇËµ∞Âäø'}</div>
                        </div>
                        <div style="background: rgba(0, 255, 136, 0.05); border: 1px solid rgba(0, 255, 136, 0.15); border-radius: 10px; padding: 14px;">
                            <div style="font-size: 20px; margin-bottom: 6px;">‚ö°</div>
                            <div style="font-size: 13px; font-weight: 600; color: #fff; margin-bottom: 4px;">${i18n ? i18n.getText('aiSmartCharge') : 'Êô∫ËÉΩÂÖÖÁîµÂÜ≥Á≠ñ'}</div>
                            <div style="font-size: 11px; color: rgba(255,255,255,0.6); line-height: 1.5;">${i18n ? i18n.getText('aiSmartChargeDesc') : 'Ëá™Âä®ËØÜÂà´‰Ωé‰ª∑Á™óÂè£Ôºå‰ª•ÊúÄ‰ΩéÊàêÊú¨ÂÆåÊàêÂÖÖÁîµ'}</div>
                        </div>
                        <div style="background: rgba(255, 193, 7, 0.05); border: 1px solid rgba(255, 193, 7, 0.15); border-radius: 10px; padding: 14px;">
                            <div style="font-size: 20px; margin-bottom: 6px;">üí∞</div>
                            <div style="font-size: 13px; font-weight: 600; color: #fff; margin-bottom: 4px;">${i18n ? i18n.getText('aiSmartDischarge') : 'ÊúÄ‰ºòÊîæÁîµÊó∂Êú∫'}</div>
                            <div style="font-size: 11px; color: rgba(255,255,255,0.6); line-height: 1.5;">${i18n ? i18n.getText('aiSmartDischargeDesc') : 'Á≤æÂáÜÊçïÊçâÈ´ò‰ª∑Êó∂ÊÆµÊîæÁîµÔºåÊúÄÂ§ßÂåñÈ¶àÁΩëÊî∂Áõä'}</div>
                        </div>
                        <div style="background: rgba(100, 180, 255, 0.05); border: 1px solid rgba(100, 180, 255, 0.15); border-radius: 10px; padding: 14px;">
                            <div style="font-size: 20px; margin-bottom: 6px;">üîã</div>
                            <div style="font-size: 13px; font-weight: 600; color: #fff; margin-bottom: 4px;">${i18n ? i18n.getText('aiBatteryManage') : 'ÁîµÊ±†ÂÅ•Â∫∑ÁÆ°ÁêÜ'}</div>
                            <div style="font-size: 11px; color: rgba(255,255,255,0.6); line-height: 1.5;">${i18n ? i18n.getText('aiBatteryManageDesc') : 'Êô∫ËÉΩÁÆ°ÁêÜSOCÂå∫Èó¥ÔºåÂÖºÈ°æÊî∂Áõä‰∏éÁîµÊ±†ÂØøÂëΩ'}</div>
                        </div>
                    </div>

                    <!-- ÊèêÁ§∫ -->
                    <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 10px; padding: 12px; display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 14px;">ü§ñ</span>
                        <span style="font-size: 12px; color: rgba(255, 255, 255, 0.6);">
                            ${i18n ? i18n.getText('aiCustodyHint') : 'AIÂ∞Ü7√ó24Â∞èÊó∂ÊåÅÁª≠ËøêË°åÔºåÊÇ®ÂèØÈöèÊó∂ÊâãÂä®Âπ≤È¢ÑÊàñÂÖ≥Èó≠ÊâòÁÆ°'}
                        </span>
                    </div>
                </div>

                <div style="display: flex; justify-content: flex-end; gap: 12px; padding: 20px 28px; border-top: 1px solid rgba(255, 255, 255, 0.08);">
                    <button onclick="closeAutoModeConfirmDialog()" style="background: rgba(255, 255, 255, 0.08); color: rgba(255, 255, 255, 0.8); border: 1px solid rgba(255, 255, 255, 0.1); padding: 10px 20px; border-radius: 10px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                        ${i18n ? i18n.getText('cancel') : 'ÂèñÊ∂à'}
                    </button>
                    <button onclick="confirmEnableAutoMode()" style="background: linear-gradient(135deg, #00ff88, #00dd77); color: #000; padding: 10px 24px; border-radius: 10px; font-size: 13px; font-weight: 700; cursor: pointer; transition: all 0.3s; border: none;">
                        ${i18n ? i18n.getText('confirmEnable') : 'Á°ÆËÆ§ÂêØÁî®'}
                    </button>
                </div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // Ê∑ªÂä†Âä®ÁîªÊ†∑Âºè
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                @keyframes slideUp {
                    from { transform: translateY(20px); opacity: 0; }
                    to { transform: translateY(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
        }
        
        function closeAutoModeConfirmDialog() {
            const modal = document.getElementById('autoModeConfirmModal');
            if (modal) {
                modal.remove();
            }
        }
        
        function confirmEnableAutoMode() {
            closeAutoModeConfirmDialog();
            switchOperationMode('auto');
        }
        
        // ÊòæÁ§∫ÂÖ≥Èó≠Ëá™Âä®Ê®°ÂºèÁ°ÆËÆ§ÂºπÁ™ó
        function showDisableAutoModeConfirmDialog() {
            // ÂàõÂª∫Ê®°ÊÄÅÊ°Ü
            const modal = document.createElement('div');
            modal.id = 'disableAutoModeConfirmModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                animation: fadeIn 0.3s ease;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: linear-gradient(135deg, rgba(26, 26, 26, 0.98) 0%, rgba(40, 40, 40, 0.98) 100%);
                backdrop-filter: blur(20px);
                border-radius: 16px;
                width: 480px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
                border: 1px solid rgba(255, 255, 255, 0.1);
                animation: slideUp 0.3s ease;
                overflow: hidden;
            `;
            
            modalContent.innerHTML = `
                <div style="padding: 24px 28px; border-bottom: 1px solid rgba(255, 255, 255, 0.08); background: rgba(255, 255, 255, 0.02);">
                    <h3 style="margin: 0; font-size: 18px; font-weight: 700; color: #fff;">
                        ${window.i18n ? window.i18n.getText('confirmDisableAutoMode') : 'Á°ÆËÆ§ÂÖ≥Èó≠Êô∫ËÉΩÊâòÁÆ°'}
                    </h3>
                </div>
                
                <div style="padding: 24px 28px;">
                    <div style="margin-bottom: 20px;">
                        <p style="color: rgba(255, 255, 255, 0.9); font-size: 14px; margin: 0 0 16px 0;">
                            ${window.i18n ? window.i18n.getText('disableAutoModeDescription') : 'ÂÖ≥Èó≠Êô∫ËÉΩÊâòÁÆ°ÂêéÔºåAIÂ∞ÜÂÅúÊ≠¢Êô∫ËÉΩÂàÜÊûêÔºåÊÇ®ÈúÄË¶ÅÊâãÂä®ÊéßÂà∂ÂÖÖÊîæÁîµ„ÄÇ'}
                        </p>
                    </div>
                    
                    <!-- Ë≠¶ÂëäÊèêÁ§∫ -->
                    <div style="background: rgba(255, 184, 0, 0.1); border: 1px solid rgba(255, 184, 0, 0.3); border-radius: 10px; padding: 12px; display: flex; align-items: flex-start; gap: 10px; margin-bottom: 16px;">
                        <span style="font-size: 16px; margin-top: 2px;">‚ö†Ô∏è</span>
                        <div>
                            <p style="font-size: 13px; color: rgba(255, 184, 0, 0.9); margin: 0 0 4px 0; font-weight: 600;">
                                ${window.i18n ? window.i18n.getText('autoModeWarning') : 'Ê≥®ÊÑè'}
                            </p>
                            <p style="font-size: 12px; color: rgba(255, 255, 255, 0.7); margin: 0;">
                                ${window.i18n ? window.i18n.getText('disableAutoModeWarning') : 'ÂÖ≥Èó≠Êô∫ËÉΩÊâòÁÆ°ÂêéÔºåÊÇ®ÂèØËÉΩ‰ºöÈîôËøáAIÊé®ËçêÁöÑÊúÄ‰Ω≥ÂÖÖÊîæÁîµÊó∂Êú∫ÔºåÂΩ±ÂìçÊî∂Áõä„ÄÇ'}
                            </p>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: flex-end; gap: 12px; padding: 20px 28px; border-top: 1px solid rgba(255, 255, 255, 0.08);">
                    <button onclick="closeDisableAutoModeConfirmDialog()" style="background: rgba(255, 255, 255, 0.08); color: rgba(255, 255, 255, 0.8); border: 1px solid rgba(255, 255, 255, 0.1); padding: 10px 20px; border-radius: 10px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                        ${window.i18n ? window.i18n.getText('cancel') : 'ÂèñÊ∂à'}
                    </button>
                    <button onclick="confirmDisableAutoMode()" style="background: linear-gradient(135deg, #ff6b6b, #ff5252); color: #fff; padding: 10px 20px; border-radius: 10px; font-size: 13px; font-weight: 700; cursor: pointer; transition: all 0.3s; border: none;">
                        ${window.i18n ? window.i18n.getText('confirmDisable') : 'Á°ÆËÆ§ÂÖ≥Èó≠'}
                    </button>
                </div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
        }
        
        function closeDisableAutoModeConfirmDialog() {
            const modal = document.getElementById('disableAutoModeConfirmModal');
            if (modal) {
                modal.remove();
            }
        }
        
        function confirmDisableAutoMode() {
            closeDisableAutoModeConfirmDialog();
            switchOperationMode('manual');
        }
        
        // ÊòæÁ§∫Ëá™Âä®ÂºÄÂÖ≥Á¶ÅÁî®ÊèêÁ§∫
        function showAutoSwitchDisabledTooltip() {
            const toggleSwitch = document.querySelector('.auto-toggle-switch');
            if (!toggleSwitch) return;
            
            // ÁßªÈô§Áé∞ÊúâÁöÑÊèêÁ§∫
            const existingTooltip = document.getElementById('autoSwitchTooltip');
            if (existingTooltip) {
                existingTooltip.remove();
            }
            
            // ÂàõÂª∫ÊèêÁ§∫ÂÖÉÁ¥†
            const tooltip = document.createElement('div');
            tooltip.id = 'autoSwitchTooltip';
            tooltip.style.cssText = `
                position: absolute;
                top: -45px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0, 0, 0, 0.9);
                color: white;
                padding: 6px 12px;
                border-radius: 6px;
                font-size: 12px;
                z-index: 10000;
                white-space: nowrap;
                opacity: 0;
                transition: opacity 0.3s ease;
                pointer-events: none;
                border: 1px solid rgba(255, 255, 255, 0.2);
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            `;
            
            // ËÆæÁΩÆÊèêÁ§∫ÊñáÊú¨
            tooltip.textContent = window.i18n ? window.i18n.getText('pleaseStopCurrentMode') : 'ËØ∑ÂÖàÂÅúÊ≠¢ÂΩìÂâçÊ®°Âºè';
            
            // Ê∑ªÂä†Âà∞bodyËÄå‰∏çÊòØÂºÄÂÖ≥ÂÆπÂô®Ôºå‰ΩøÁî®Âõ∫ÂÆöÂÆö‰Ωç
            const rect = toggleSwitch.getBoundingClientRect();
            tooltip.style.position = 'fixed';
            tooltip.style.top = (rect.top - 45) + 'px';
            tooltip.style.left = (rect.left + rect.width / 2) + 'px';
            tooltip.style.transform = 'translateX(-50%)';
            
            document.body.appendChild(tooltip);
            
            // ÊòæÁ§∫ÊèêÁ§∫
            setTimeout(() => {
                tooltip.style.opacity = '1';
            }, 10);
            
            // 3ÁßíÂêéËá™Âä®ÈöêËóè
            setTimeout(() => {
                tooltip.style.opacity = '0';
                setTimeout(() => {
                    if (tooltip.parentNode) {
                        tooltip.parentNode.removeChild(tooltip);
                    }
                }, 300);
            }, 3000);
        }
        
        function switchOperationMode(mode) {
            currentOperationMode = mode;

            const autoToggleKnob = document.getElementById('autoToggleKnob');
            const chargeBtn = document.getElementById('chargeBtn');
            const dischargeBtn = document.getElementById('dischargeBtn');
            const toggleSwitch = document.querySelector('.auto-toggle-switch');
            const mainCircle = document.getElementById('mainPriceCircle');

            if (mode === 'manual') {
                // Update toggle switch to off position
                if (autoToggleKnob) {
                    autoToggleKnob.style.left = '2px';
                    autoToggleKnob.style.background = '#fff';
                }
                if (toggleSwitch) toggleSwitch.style.background = 'rgba(255,255,255,0.1)';

                // Show and enable action buttons in manual mode
                if (chargeBtn) {
                    chargeBtn.style.display = 'flex';
                    chargeBtn.disabled = false;
                    chargeBtn.style.opacity = '1';
                    chargeBtn.style.cursor = 'pointer';
                }
                if (dischargeBtn) {
                    dischargeBtn.style.display = 'flex';
                    dischargeBtn.disabled = false;
                    dischargeBtn.style.opacity = '1';
                    dischargeBtn.style.cursor = 'pointer';
                }

                // Stop auto check interval
                if (autoCheckInterval) {
                    clearInterval(autoCheckInterval);
                    autoCheckInterval = null;
                }

                // Â¶ÇÊûúÂΩìÂâçÊ≠£Âú®ËøêË°åËá™Âä®Êìç‰ΩúÔºåÂÅúÊ≠¢ÂÆÉ
                if (currentOperation && (regionData[selectedMainRegion]?.status === 'autoCharge' || regionData[selectedMainRegion]?.status === 'autoDischarge')) {
                    stopOperation();
                }

                // ÈáçÁΩÆÂΩìÂâçÂú∞Âå∫Áä∂ÊÄÅ‰∏∫Êó†Áä∂ÊÄÅ
                if (regionData[selectedMainRegion]) {
                    regionData[selectedMainRegion].status = 'none';
                    // Êõ¥Êñ∞ÁîµÁ´ôÁÆ°ÁêÜÊòæÁ§∫
                    updatePowerStationStatus(selectedMainRegion, 'none');
                    // Êõ¥Êñ∞Âú∞Âå∫Áä∂ÊÄÅÊ†áËÆ∞
                    updateRegionStatusDisplay();
                }

                // ÈáçÁΩÆÂú∞Âå∫Êìç‰ΩúÁä∂ÊÄÅ‰ª•Á°Æ‰øùÊåâÈíÆÊòæÁ§∫
                updateRegionOperationStatus(selectedMainRegion, 'none');

                // Âú®ÊâãÂä®Ê®°Âºè‰∏ãÔºåÂ§ßÂúÜÂèØ‰ª•ÁÇπÂáªÔºàÂ¶ÇÊûúÊúâÊìç‰ΩúÊ≠£Âú®ËøõË°åÔºâ
                if (mainCircle) {
                    mainCircle.style.cursor = 'pointer';
                }

                hideAICustodyPanel();

                // ÈöêËóèÈ¢ÑÊµãÊñáÊú¨
                updateAIPredictionText();

                // ÈöêËóèÊú∫Âô®‰∫∫ÁéØÁªïÂä®Êïà
                const orbitBot = document.getElementById('aiOrbitRobot');
                const orbitTrack = document.getElementById('aiOrbitTrack');
                if (orbitBot) orbitBot.classList.remove('active');
                if (orbitTrack) orbitTrack.classList.remove('active');

            } else {
                // Update toggle switch to on position
                if (autoToggleKnob) {
                    autoToggleKnob.style.left = '22px';
                    autoToggleKnob.style.background = '#fff';
                }
                if (toggleSwitch) toggleSwitch.style.background = '#4CD964';

                // Â¶ÇÊûúÂΩìÂâçÊ≠£Âú®ËøõË°åÊâãÂä®Êìç‰ΩúÔºåÂÖàÂÅúÊ≠¢ÂÆÉ
                if (currentOperation && (regionData[selectedMainRegion]?.status === 'manualCharge' || regionData[selectedMainRegion]?.status === 'manualDischarge')) {
                    stopOperation();
                }

                // Hide action buttons in auto mode
                if (chargeBtn) chargeBtn.style.display = 'none';
                if (dischargeBtn) dischargeBtn.style.display = 'none';

                // Update conditions display
                updateAutoConditionsDisplay();

                // Start auto check interval
                startAutoOperationCheck();

                // ËÆæÁΩÆËá™Âä®Ê®°Âºè‰∏ãÁöÑÁ≠âÂæÖÊâßË°åÁä∂ÊÄÅ
                if (regionData[selectedMainRegion]) {
                    regionData[selectedMainRegion].status = 'waitingExecution';
                    updatePowerStationStatus(selectedMainRegion, 'waitingExecution');
                    // Êõ¥Êñ∞Âú∞Âå∫Áä∂ÊÄÅÊ†áËÆ∞
                    updateRegionStatusDisplay();
                }

                // Âú®Ëá™Âä®Ê®°Âºè‰∏ãÔºåÂ§ßÂúÜ‰∏çÂèØÁÇπÂáª
                if (mainCircle) {
                    mainCircle.style.cursor = 'default';
                }

                // Âú®Â§ßÂúÜÂÜÖÊòæÁ§∫"Á≠âÂæÖÊâßË°å‰∏≠"Áä∂ÊÄÅ
                updateCircleStatusDisplay();

                showAICustodyPanel();

                // ÊòæÁ§∫Êú∫Âô®‰∫∫ÁéØÁªïÂä®Êïà
                const orbitBot2 = document.getElementById('aiOrbitRobot');
                const orbitTrack2 = document.getElementById('aiOrbitTrack');
                if (orbitBot2) orbitBot2.classList.add('active');
                if (orbitTrack2) orbitTrack2.classList.add('active');

                // ÊòæÁ§∫È¢ÑÊµãÊñáÊú¨
                updateAIPredictionText();
            }

            // Update stop button visibility after mode change
            updateStopButtonVisibility();
            
            // Update action buttons visibility after mode change
            updateActionButtonsVisibility();
        }
        
        // ========== AI Êô∫ËÉΩÊâòÁÆ°Èù¢ÊùøÈÄªËæëÔºàÂü∫‰∫é AEMO È¢ÑÊµã‰ª∑Ê†ºÔºâ ==========
        let aiCustodyInterval = null;

        let aiMiniChartInstance = null;

        // Tab ÂàáÊç¢ÔºöË°åÊÉÖ / ÂàÜÊûê
        function switchAemoTab(tab) {
            const marketPanel = document.getElementById('marketPanel');
            const analysisPanel = document.getElementById('analysisPanel');
            const tabMarket = document.getElementById('aemoTabMarket');
            const tabAnalysis = document.getElementById('aemoTabAnalysis');

            // ‰∏ãÂàíÁ∫ø Tab Ê†∑Âºè
            const activeStyle = { color: '#00ff88', borderBottom: '2px solid #00ff88' };
            const inactiveStyle = { color: 'rgba(255,255,255,0.45)', borderBottom: '2px solid transparent' };

            if (tab === 'market') {
                if (marketPanel) { marketPanel.classList.add('active'); marketPanel.style.display = ''; }
                if (analysisPanel) { analysisPanel.style.display = 'none'; }
                if (tabMarket) Object.assign(tabMarket.style, activeStyle);
                if (tabAnalysis) Object.assign(tabAnalysis.style, inactiveStyle);
                setTimeout(() => { if (marketChart && typeof marketChart.resize === 'function') marketChart.resize(); }, 50);
            } else if (tab === 'analysis') {
                if (marketPanel) { marketPanel.classList.remove('active'); marketPanel.style.display = 'none'; }
                if (analysisPanel) { analysisPanel.style.display = 'flex'; }
                if (tabMarket) Object.assign(tabMarket.style, inactiveStyle);
                if (tabAnalysis) Object.assign(tabAnalysis.style, activeStyle);
                setTimeout(() => { if (aiMiniChartInstance && typeof aiMiniChartInstance.resize === 'function') aiMiniChartInstance.resize(); }, 50);
                if (!aiCustodyInterval) runAIForecastAnalysis();
            }
        }

        function showAICustodyPanel() {
            const tabAnalysis = document.getElementById('aemoTabAnalysis');
            if (tabAnalysis) {
                tabAnalysis.disabled = false;
                tabAnalysis.style.opacity = '';
                tabAnalysis.style.cursor = 'pointer';
            }
            startAICustodyAnalysis();
            switchAemoTab('analysis');
        }

        function hideAICustodyPanel() {
            stopAICustodyAnalysis();
            switchAemoTab('market');
            const tabAnalysis = document.getElementById('aemoTabAnalysis');
            if (tabAnalysis) {
                tabAnalysis.disabled = true;
                tabAnalysis.style.color = 'rgba(255,255,255,0.2)';
                tabAnalysis.style.cursor = 'not-allowed';
            }
        }

        function startAICustodyAnalysis() {
            stopAICustodyAnalysis();
            runAIForecastAnalysis();
            aiCustodyInterval = setInterval(runAIForecastAnalysis, 1800000);
            startAICountdown();
        }

        function stopAICustodyAnalysis() {
            if (aiCustodyInterval) { clearInterval(aiCustodyInterval); aiCustodyInterval = null; }
            if (aiMiniChartInstance) { aiMiniChartInstance.dispose(); aiMiniChartInstance = null; }
        }

        function startAICountdown() {
            // ÊòæÁ§∫ÂΩìÂâçÂàÜÊûêÂü∫‰∫éÁöÑÊó∂Èó¥ÁÇπ
            const isEn = window.i18n?.currentLang?.startsWith('en');
            const now = new Date();
            const hh = String(now.getHours()).padStart(2, '0');
            const mm = String(now.getMinutes()).padStart(2, '0');
            const el = document.getElementById('aiAnalysisTime');
            if (el) el.textContent = isEn ? `Based on ${hh}:${mm} data` : `Âü∫‰∫é ${hh}:${mm} ÁöÑÊï∞ÊçÆÂàÜÊûê`;
        }

        // Êï∞Â≠óÊªöÂä®Âä®Áîª
        function animateNumber(el, target, duration) {
            if (!el) return;
            duration = duration || 1500;
            const absTarget = Math.abs(target);
            const prefix = target >= 0 ? '$' : '-$';
            const startTime = performance.now();
            function tick(now) {
                const progress = Math.min((now - startTime) / duration, 1);
                const eased = progress === 1 ? 1 : 1 - Math.pow(2, -10 * progress);
                el.textContent = prefix + Math.round(absTarget * eased);
                if (progress < 1) requestAnimationFrame(tick);
            }
            requestAnimationFrame(tick);
        }

        /**
         * Ê†∏ÂøÉÁÆóÊ≥ïÔºöÂàÜÊûê AEMO È¢ÑÊµã‰ª∑Ê†ºÔºåÁîüÊàêÂÖÖÊîæÁîµËÆ°Âàí
         * ÁîµÊ±†ÂèÇÊï∞ÔºöÂäüÁéá 2.5MWÔºåÂÆπÈáè 10MWh
         * ÊØè‰∏™ 5 ÂàÜÈíüÊó∂ÊÆµÂèØÂÖÖ/ÊîæÁîµÈáèÔºö2.5 √ó (5/60) = 0.2083 MWh
         */
        const BATTERY_POWER_MW = 2.5;       // ÂÖÖÊîæÁîµÂäüÁéá
        const BATTERY_CAPACITY_MWH = 10;    // ÁîµÊ±†ÂÆπÈáè
        const INTERVAL_MIN = 5;             // Êï∞ÊçÆÈó¥ÈöîÔºàÂàÜÈíüÔºâ
        const ENERGY_PER_INTERVAL = BATTERY_POWER_MW * (INTERVAL_MIN / 60); // 0.2083 MWh

        function runAIForecastAnalysis() {
            if (!aemoRealPriceData || !aemoTimeLabels || aemoRealPriceData.length === 0) {
                return;
            }

            const isEn = window.i18n && window.i18n.currentLang && window.i18n.currentLang.startsWith('en');
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            const roundedMinute = Math.floor(currentMinute / 5) * 5;
            const currentIdx = currentHour * 12 + (roundedMinute / 5);
            const currentPrice = aemoRealPriceData[Math.min(currentIdx, aemoRealPriceData.length - 1)];

            // --- Êî∂ÈõÜÊú™Êù•È¢ÑÊµã‰ª∑Ê†º ---
            const futureData = [];
            for (let i = currentIdx + 1; i < aemoRealPriceData.length; i++) {
                futureData.push({ idx: i, time: aemoTimeLabels[i], price: aemoRealPriceData[i] });
            }

            if (futureData.length === 0) {
                const cardsEl = document.getElementById('aiStrategyCards');
                if (cardsEl) cardsEl.innerHTML = `<div style="grid-column:1/-1;text-align:center;color:rgba(255,255,255,0.65);font-size:13px;padding:16px;">${isEn ? 'Today\'s forecast data exhausted. Waiting for next day.' : '‰ªäÊó•È¢ÑÊµãÊï∞ÊçÆÂ∑≤ÁªìÊùüÔºåÁ≠âÂæÖÊ¨°Êó•Êï∞ÊçÆÊõ¥Êñ∞„ÄÇ'}</div>`;
                return;
            }

            // --- ËÆ°ÁÆóÂàÜ‰ΩçÊï∞ÈòàÂÄº ---
            const sortedPrices = futureData.map(d => d.price).sort((a, b) => a - b);
            const p25 = sortedPrices[Math.floor(sortedPrices.length * 0.25)];
            const p75 = sortedPrices[Math.floor(sortedPrices.length * 0.75)];

            // --- Ê†áËÆ∞ÊØè‰∏™Êó∂ÊÆµÁöÑÂä®‰Ωú ---
            const tagged = futureData.map(d => ({
                ...d,
                action: d.price <= p25 ? 'charge' : d.price >= p75 ? 'discharge' : 'hold'
            }));

            // --- ÂêàÂπ∂ËøûÁª≠Áõ∏ÂêåÂä®‰ΩúÁöÑÊó∂ÊÆµ‰∏∫Á™óÂè£ ---
            const MERGE_GAP = 3;      // ÂêåÁ±ªÁ™óÂè£Èó¥Èöî ‚â§ 3 ‰∏™Êó∂ÊÆµÔºà15ÂàÜÈíüÔºâÂàôÂêàÂπ∂
            const MIN_INTERVALS = 4;  // Á™óÂè£ÊúÄÂ∞ë 4 ‰∏™Êó∂ÊÆµÔºà20ÂàÜÈíüÔºâÔºåÂê¶Âàô‰∏¢ÂºÉ
            const rawWindows = [];
            let cur = null;
            for (const slot of tagged) {
                if (slot.action === 'hold') {
                    if (cur) { rawWindows.push(cur); cur = null; }
                    continue;
                }
                if (cur && cur.action === slot.action && slot.idx === cur.endIdx + 1) {
                    cur.endIdx = slot.idx;
                    cur.endTime = slot.time;
                    cur.prices.push(slot.price);
                } else {
                    if (cur) rawWindows.push(cur);
                    cur = {
                        action: slot.action,
                        startIdx: slot.idx,
                        endIdx: slot.idx,
                        startTime: slot.time,
                        endTime: slot.time,
                        prices: [slot.price]
                    };
                }
            }
            if (cur) rawWindows.push(cur);

            // ÂêàÂπ∂Áõ∏ËøëÁöÑÂêåÁ±ªÁ™óÂè£ÔºàÈó¥Èöî ‚â§ 15ÂàÜÈíüÔºâ
            const merged = [];
            for (const w of rawWindows) {
                const prev = merged[merged.length - 1];
                if (prev && prev.action === w.action && (w.startIdx - prev.endIdx) <= MERGE_GAP) {
                    // Ë°•ÂÖÖÈó¥ÈöîÊó∂ÊÆµÁöÑ‰ª∑Ê†º
                    for (let i = prev.endIdx + 1; i < w.startIdx; i++) {
                        prev.prices.push(aemoRealPriceData[i]);
                    }
                    prev.prices.push(...w.prices);
                    prev.endIdx = w.endIdx;
                    prev.endTime = w.endTime;
                } else {
                    merged.push({ ...w, prices: [...w.prices] });
                }
            }

            // ËøáÊª§ÊéâËøáÁü≠ÁöÑÁ™óÂè£Ôºà< 20ÂàÜÈíüÔºâ
            const windows = merged.filter(w => w.prices.length >= MIN_INTERVALS);

            // --- ËÆ°ÁÆóÊØè‰∏™Á™óÂè£ÁöÑÂùá‰ª∑„ÄÅÊó∂Èïø„ÄÅÁîµÈáè„ÄÅÈáëÈ¢ù ---
            windows.forEach(w => {
                w.avgPrice = w.prices.reduce((a, b) => a + b, 0) / w.prices.length;
                w.intervals = w.prices.length;
                w.durationMin = w.intervals * INTERVAL_MIN;
                // ÁîµÈáèÂèóÁîµÊ±†ÂÆπÈáèÈôêÂà∂ÔºàÂçïÁ™óÂè£ÊúÄÂ§öÂÖÖ/ÊîæÊª°Êï¥ÂùóÁîµÊ±†Ôºâ
                w.energyMWh = Math.min(w.intervals * ENERGY_PER_INTERVAL, BATTERY_CAPACITY_MWH);
                // ÈáëÈ¢ù = ÁîµÈáè √ó Âùá‰ª∑ÔºàÂÖÖÁîµÊòØÊàêÊú¨ÔºåÊîæÁîµÊòØÊî∂ÂÖ•Ôºâ
                w.amount = w.energyMWh * w.avgPrice;
                const endIdx = Math.min(w.endIdx + 1, aemoTimeLabels.length - 1);
                w.endTimeDisplay = aemoTimeLabels[endIdx];
            });

            // --- ÊâæÊúÄ‰Ω≥ÂÖÖÁîµÁ™óÂè£ÔºàÊúÄ‰ΩéÂùá‰ª∑ÔºâÂíåÊúÄ‰Ω≥ÊîæÁîµÁ™óÂè£ÔºàÊúÄÈ´òÂùá‰ª∑Ôºâ---
            const chargeWindows = windows.filter(w => w.action === 'charge').sort((a, b) => a.avgPrice - b.avgPrice);
            const dischargeWindows = windows.filter(w => w.action === 'discharge').sort((a, b) => b.avgPrice - a.avgPrice);
            const bestCharge = chargeWindows[0];
            const bestDischarge = dischargeWindows[0];

            // ÁºìÂ≠òAIÈ¢ÑÊµãÁªìÊûú‰æõÈ¢ÑÊµãÊñáÊú¨‰ΩøÁî®
            latestAIForecast.bestCharge = bestCharge || null;
            latestAIForecast.bestDischarge = bestDischarge || null;
            updateAIPredictionText();

            // ===== Ê∏≤ÊüìÈò∂ÊÆµÔºöÊÄùËÄÉÂä®Áîª ‚Üí ÂÜôÂÖ•Êï∞ÊçÆ ‚Üí Ê∑°ÂÖ• =====
            const cardsEl = document.getElementById('aiStrategyCards');
            const spreadEl = document.getElementById('aiEstSpread');
            const pulseEl = document.getElementById('aiPulse');
            const labelEl = document.getElementById('aiStatusLabel');
            const fadeTargets = [cardsEl];

            // Èò∂ÊÆµ‰∏ÄÔºöËøõÂÖ•"ÊÄùËÄÉ"Áä∂ÊÄÅ
            fadeTargets.forEach(el => {
                if (el) { el.style.transition = 'filter 0.3s, opacity 0.3s'; el.style.filter = 'blur(3px)'; el.style.opacity = '0.5'; }
            });
            if (pulseEl) { pulseEl.style.background = '#5AC8FA'; pulseEl.style.boxShadow = '0 0 8px rgba(90,200,250,0.8), 0 0 16px rgba(90,200,250,0.3)'; }
            if (labelEl) labelEl.textContent = isEn ? 'AI Analyzing...' : 'AI ÈáçÊñ∞ÂàÜÊûê‰∏≠...';

            // Èò∂ÊÆµ‰∫åÔºà800ms ÂêéÔºâÔºöÂÜôÂÖ•Êñ∞Êï∞ÊçÆ
            setTimeout(() => {
                // --- Ê®°Êãü SOC ÂèòÂåñÔºàÂü∫‰∫éÂÆûÈôÖÁîµÊ±†ÂèÇÊï∞Ôºâ ---
                // 2.5MW ÂäüÁéáÔºå10MWh ÂÆπÈáèÔºåÊØè5ÂàÜÈíüÂÖÖÊîæ 0.2083MWh = 2.083% SOC
                const SOC_PER_INTERVAL = (ENERGY_PER_INTERVAL / BATTERY_CAPACITY_MWH) * 100; // ‚âà2.083%
                const chargeStopSOC = autoSettings.charge.stopSOC || 90;
                const dischargeStopSOC = autoSettings.discharge.stopSOC || 20;
                const allWindowsSorted = [...windows].sort((a, b) => a.startIdx - b.startIdx);
                let simSOC = getCurrentBatteryLevel(); // Áî®ÂÆûÈôÖÂΩìÂâçÁîµÊ±† SOC
                allWindowsSorted.forEach(w => {
                    const socBefore = simSOC;
                    // ÈÄê‰∏™Êó∂ÊÆµÊ®°ÊãüÔºåÂèó SOC ‰∏ä‰∏ãÈôêÁ∫¶Êùü
                    for (let i = 0; i < w.intervals; i++) {
                        if (w.action === 'charge') {
                            if (simSOC >= chargeStopSOC) break;
                            simSOC = Math.min(simSOC + SOC_PER_INTERVAL, chargeStopSOC);
                        } else {
                            if (simSOC <= dischargeStopSOC) break;
                            simSOC = Math.max(simSOC - SOC_PER_INTERVAL, dischargeStopSOC);
                        }
                    }
                    w.socAfter = Math.round(simSOC);
                    // ÁúüÂÆûÈáëÈ¢ù = SOCÂèòÂåñ% √ó ÁîµÊ±†ÂÆπÈáè √ó Âùá‰ª∑
                    const socChange = Math.abs(simSOC - socBefore) / 100;
                    const realEnergyMWh = socChange * BATTERY_CAPACITY_MWH;
                    w.amount = realEnergyMWh * w.avgPrice;
                });

                // --- ÂÖÖÊîæÁîµÁ≠ñÁï•ÂèåÂç°ÁâáÔºàÂàóÂá∫ÊâÄÊúâÁ™óÂè£ + SOCÔºâ ---
                if (cardsEl) {
                    const renderWindowList = (list, type) => {
                        const isC = type === 'charge';
                        const color = isC ? '#00ff88' : '#ffc107';
                        const bg = isC ? 'rgba(0,255,136,0.05)' : 'rgba(255,193,7,0.05)';
                        const border = isC ? 'rgba(0,255,136,0.18)' : 'rgba(255,193,7,0.18)';
                        const icon = isC
                            ? `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#00ff88" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><polyline points="19 12 12 19 5 12"/></svg>`
                            : `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ffc107" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></svg>`;
                        const title = isEn ? (isC ? 'Charge' : 'Discharge') : (isC ? 'ÂÖÖÁîµ' : 'ÊîæÁîµ');
                        if (list.length === 0) {
                            return `<div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius: 10px;padding:14px;text-align:center;color:rgba(255,255,255,0.55);font-size:12px;">
                                <div style="margin-bottom:2px;">${icon}</div>${isEn ? 'No ' + title.toLowerCase() + ' window' : 'Êó†' + title + 'Á™óÂè£'}</div>`;
                        }
                        const sorted = list.sort((a, b) => a.startIdx - b.startIdx);
                        const rows = sorted.map(w =>
                            `<div style="display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.06);">
                                <span style="font-size:12px;color:rgba(255,255,255,0.85);font-family:'SF Mono',monospace;">${w.startTime}-${w.endTimeDisplay}</span>
                                <span style="font-size:12px;color:${color};font-weight:700;">$${w.avgPrice.toFixed(0)}</span>
                                <span style="font-size:12px;color:rgba(255,255,255,0.7);font-weight:500;">${w.socAfter != null ? w.socAfter + '%' : '--'}</span>
                            </div>`
                        ).join('');
                        const totalAmount = sorted.reduce((sum, w) => sum + w.amount, 0);
                        const amountLabel = isC
                            ? (isEn ? 'Est. Cost' : 'È¢ÑËÆ°ÊàêÊú¨')
                            : (isEn ? 'Est. Revenue' : 'È¢ÑËÆ°Êî∂ÂÖ•');
                        const amountColor = isC ? '#00ff88' : '#ffc107';
                        return `<div style="background:${bg};border:1px solid ${border};border-radius: 10px;padding:12px;">
                            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
                                <div style="display:flex;align-items:center;gap:5px;">
                                    <span style="font-size:14px;">${icon}</span>
                                    <span style="font-size:14px;color:${color};font-weight:700;">${title}</span>
                                </div>
                                <span style="font-size:14px;font-weight:700;color:${amountColor};">$${totalAmount.toFixed(0)}</span>
                            </div>
                            <div style="display:flex;justify-content:space-between;padding:0 0 4px 0;border-bottom:1px solid rgba(255,255,255,0.08);">
                                <span style="font-size:10px;color:rgba(255,255,255,0.55);font-weight:500;">${isEn ? 'Time' : 'Êó∂Èó¥'}</span>
                                <span style="font-size:10px;color:rgba(255,255,255,0.55);font-weight:500;">${isEn ? 'Price' : 'Âùá‰ª∑'}</span>
                                <span style="font-size:10px;color:rgba(255,255,255,0.55);font-weight:500;">SOC</span>
                            </div>
                            ${rows}
                        </div>`;
                    };
                    cardsEl.innerHTML = renderWindowList(chargeWindows, 'charge') + renderWindowList(dischargeWindows, 'discharge');
                }

                // --- ECharts Ëø∑‰Ω†‰ª∑Ê†ºËµ∞ÂäøÂõæ ---
                const chartContainer = document.getElementById('aiMiniChart');
                if (chartContainer && typeof echarts !== 'undefined') {
                    if (!aiMiniChartInstance) {
                        aiMiniChartInstance = echarts.init(chartContainer, 'dark');
                    }
                    // ÊûÑÈÄ† markArea Êï∞ÊçÆÔºàÂÖÖÊîæÁîµÁ™óÂè£Ëâ≤ÂùóÔºâ
                    const markAreaData = windows.map(w => {
                        const isC = w.action === 'charge';
                        return [{
                            xAxis: w.startTime,
                            itemStyle: { color: isC ? 'rgba(0,255,136,0.08)' : 'rgba(255,193,7,0.08)' }
                        }, {
                            xAxis: w.endTimeDisplay
                        }];
                    });
                    // ÊûÑÈÄ† markPoint Êï∞ÊçÆÔºàÂú®Á∫ø‰∏äÊ†áÊ≥® ÂÖÖ/ÂÅú/Êîæ/ÂÅúÔºâ
                    const markPointData = [];
                    const sortedWindows = [...windows].sort((a, b) => a.startIdx - b.startIdx);
                    sortedWindows.forEach(w => {
                        const isC = w.action === 'charge';
                        const label = isEn ? (isC ? 'CHG' : 'DCH') : (isC ? 'ÂÖÖ' : 'Êîæ');
                        const color = isC ? '#00ff88' : '#ffc107';
                        // Á™óÂè£Ëµ∑ÂßãÁÇπÔºöÊ†áÊ≥®„ÄåÂÖÖ„ÄçÊàñ„ÄåÊîæ„Äç
                        markPointData.push({
                            coord: [w.startTime, aemoRealPriceData[w.startIdx]],
                            symbol: 'circle', symbolSize: 1,
                            label: {
                                show: true, formatter: label, fontSize: 12, fontWeight: 700,
                                color: color, offset: [0, -12],
                                textShadowColor: 'rgba(0,0,0,0.9)', textShadowBlur: 4
                            }
                        });
                        // Á™óÂè£ÁªìÊùüÁÇπÔºöÊ†áÊ≥®„ÄåÂÅú„Äç
                        const stopIdx = Math.min(w.endIdx + 1, aemoTimeLabels.length - 1);
                        markPointData.push({
                            coord: [aemoTimeLabels[stopIdx], aemoRealPriceData[stopIdx]],
                            symbol: 'circle', symbolSize: 1,
                            label: {
                                show: true, formatter: isEn ? 'STOP' : 'ÂÅú', fontSize: 12, fontWeight: 700,
                                color: 'rgba(255,255,255,0.7)', offset: [0, -12],
                                textShadowColor: 'rgba(0,0,0,0.9)', textShadowBlur: 4
                            }
                        });
                    });
                    // ÁîµÊ±†ÊàêÊú¨Á∫øÔºàÂÖ®Â§© 0-24hÔºåÂÖÖÁîµÁ¥ØËÆ°Âùá‰ª∑Âä®ÊÄÅÂèòÂåñÔºâ
                    const allPricesSorted = [...aemoRealPriceData].sort((a, b) => a - b);
                    const allP25 = allPricesSorted[Math.floor(allPricesSorted.length * 0.25)];
                    const batteryCostData = new Array(aemoRealPriceData.length).fill(0);
                    let totalChargeCost = 0, totalChargeEnergy = 0;
                    let lastCost = 0;
                    for (let i = 0; i < aemoRealPriceData.length; i++) {
                        const price = aemoRealPriceData[i];
                        if (price <= allP25) {
                            // ÂÖÖÁîµÊó∂ÊÆµÔºöÁ¥ØËÆ°ÊàêÊú¨ÂíåÁîµÈáèÔºåË¥ü‰ª∑Êãâ‰ΩéÊàêÊú¨ÔºåÊ≠£‰ª∑Êé®È´òÊàêÊú¨
                            totalChargeCost += price * ENERGY_PER_INTERVAL;
                            totalChargeEnergy += ENERGY_PER_INTERVAL;
                            lastCost = totalChargeCost / totalChargeEnergy;
                        }
                        batteryCostData[i] = lastCost;
                    }
                    // ÂΩìÂâçÊó∂Èó¥Á∫ø
                    const nowTimeStr = aemoTimeLabels[Math.min(currentIdx, aemoTimeLabels.length - 1)];
                    aiMiniChartInstance.setOption({
                        backgroundColor: 'transparent',
                        grid: { left: 50, right: 16, top: 32, bottom: 32, containLabel: false },
                        tooltip: {
                            trigger: 'axis',
                            backgroundColor: 'rgba(0,0,0,0.85)',
                            borderColor: 'rgba(0,255,136,0.4)',
                            borderWidth: 1,
                            textStyle: { color: '#fff', fontSize: 12 },
                            formatter: function(params) {
                                let result = '<div style="font-weight:600;margin-bottom:4px;">' + params[0].axisValue + '</div>';
                                params.forEach(p => {
                                    if (p.value !== null && p.value !== undefined) {
                                        result += '<div>' + p.marker + ' $' + (typeof p.value === 'number' ? p.value.toFixed(2) : p.value) + '</div>';
                                    }
                                });
                                return result;
                            }
                        },
                        xAxis: {
                            type: 'category', data: aemoTimeLabels, boundaryGap: false,
                            axisLine: { show: false },
                            axisTick: { show: false },
                            axisLabel: {
                                show: true, fontSize: 11, color: 'rgba(255,255,255,0.65)',
                                interval: 23,
                                formatter: function(v) { return v; }
                            },
                            splitLine: { show: false }
                        },
                        yAxis: {
                            type: 'value',
                            scale: true,
                            axisLine: { show: false },
                            axisTick: { show: false },
                            axisLabel: { show: true, fontSize: 11, color: 'rgba(255,255,255,0.65)', formatter: '${value}' },
                            splitLine: { show: true, lineStyle: { color: 'rgba(255,255,255,0.06)', type: 'dashed', width: 1 } },
                            splitNumber: 4
                        },
                        series: [
                        {
                            // ÂÆûÁ∫øÔºöÂéÜÂè≤ÂÆûÈôÖÊï∞ÊçÆÔºàÂΩìÂâçÊó∂Èó¥Âèä‰πãÂâçÔºâ
                            name: isEn ? 'Price' : '‰ª∑Ê†º',
                            type: 'line', smooth: true, showSymbol: false,
                            data: aemoRealPriceData.map((v, i) => i <= currentIdx ? v : null),
                            lineStyle: { color: '#00ff88', width: 2 },
                            areaStyle: {
                                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                    { offset: 0, color: 'rgba(0,255,136,0.2)' },
                                    { offset: 1, color: 'rgba(0,255,136,0.01)' }
                                ])
                            },
                            markLine: {
                                silent: true, symbol: 'none',
                                lineStyle: { color: 'rgba(255,255,255,0.6)', type: 'dashed', width: 1 },
                                data: [{ xAxis: nowTimeStr }],
                                label: { show: true, position: 'end', formatter: nowTimeStr, fontSize: 11, color: 'rgba(255,255,255,0.7)' }
                            }
                        },
                        {
                            // ËôöÁ∫øÔºöÈ¢ÑÊµãÊï∞ÊçÆÔºàÂΩìÂâçÊó∂Èó¥‰πãÂêéÔºâ
                            name: isEn ? 'Forecast' : 'È¢ÑÊµã',
                            type: 'line', smooth: true, showSymbol: false,
                            data: aemoRealPriceData.map((v, i) => i >= currentIdx ? v : null),
                            lineStyle: { color: 'rgba(0,255,136,0.7)', width: 2, type: 'dashed' },
                            areaStyle: {
                                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                    { offset: 0, color: 'rgba(0,255,136,0.12)' },
                                    { offset: 1, color: 'rgba(0,255,136,0.01)' }
                                ])
                            },
                            markArea: { silent: true, data: markAreaData },
                            markPoint: { silent: true, data: markPointData, animation: true }
                        },
                        {
                            // ÁîµÊ±†ÊàêÊú¨Á∫øÔºàÂÖÖÁîµÁ¥ØËÆ°Âùá‰ª∑ÔºåÈò∂Ê¢ØÂèòÂåñÔºâ
                            name: isEn ? 'Battery Cost' : 'ÁîµÊ±†ÊàêÊú¨',
                            type: 'line', step: 'end', smooth: false, showSymbol: false,
                            z: 10,
                            data: batteryCostData,
                            lineStyle: { color: '#ff6b6b', width: 2, type: 'dotted' },
                            areaStyle: null,
                            markPoint: {
                                silent: true,
                                data: lastCost !== null ? [{
                                    coord: [aemoTimeLabels[aemoTimeLabels.length - 1], lastCost],
                                    symbol: 'circle', symbolSize: 1,
                                    label: {
                                        show: true, fontSize: 11, fontWeight: 600,
                                        formatter: (isEn ? 'Cost $' : 'ÊàêÊú¨ $') + lastCost.toFixed(0),
                                        color: '#ff6b6b', offset: [0, -10],
                                        textShadowColor: 'rgba(0,0,0,0.9)', textShadowBlur: 4
                                    }
                                }] : []
                            }
                        }
                        ]
                    }, true);
                }

                // --- È¢Ñ‰º∞Âà©Ê∂¶ÔºàÊï∞Â≠óÊªöÂä®Âä®ÁîªÔºâ ---
                if (spreadEl) {
                    if (bestCharge && bestDischarge) {
                        // Âà©Ê∂¶ = ÊîæÁîµÊî∂ÂÖ• - ÂÖÖÁîµÊàêÊú¨ÔºàÂÖÖÁîµË¥ü‰ª∑Êó∂ÊàêÊú¨‰∏∫Ë¥üÔºåÂà©Ê∂¶Êõ¥È´òÔºâ
                        const totalChargeAmt = chargeWindows.reduce((s, w) => s + w.amount, 0);
                        const totalDischargeAmt = dischargeWindows.reduce((s, w) => s + w.amount, 0);
                        const profit = totalDischargeAmt - totalChargeAmt;
                        spreadEl.style.color = profit > 0 ? '#00ff88' : '#ff6b6b';
                        animateNumber(spreadEl, profit, 1500);
                    } else {
                        spreadEl.textContent = isEn ? 'Analyzing...' : 'ÂàÜÊûê‰∏≠...';
                        spreadEl.style.color = 'rgba(255,255,255,0.4)';
                    }
                }

                // --- ÈáçÁΩÆÂÄíËÆ°Êó∂ ---
                startAICountdown();

                // Èò∂ÊÆµ‰∏âÔºà400ms ÂêéÔºâÔºöÊ∑°ÂÖ•Êñ∞ÁªìÊûú
                setTimeout(() => {
                    fadeTargets.forEach(el => {
                        if (el) { el.style.filter = 'none'; el.style.opacity = '1'; }
                    });
                    if (pulseEl) { pulseEl.style.background = '#00ff88'; pulseEl.style.boxShadow = '0 0 6px rgba(0,255,136,0.6), 0 0 14px rgba(0,255,136,0.25)'; }
                    if (labelEl) labelEl.textContent = isEn ? 'AI Active' : 'AI ÂàÜÊûê‰∏≠';
                }, 400);
            }, 800);
        }

        // Auto settings panel functions (no longer needed - using inline editing)
        function openAutoSettings() {
            // Settings are now edited inline, no need for modal
        }
        
        function closeAutoSettings() {
            // Settings are now edited inline, no need for modal
        }
        
        function saveAutoSettings() {
            // ÈÄÇÈÖçÊñ∞ plans[] Ê†ºÂºèÔºöÂ∞ÜË°®ÂçïÂÄºÂÜôÂõûÁ¨¨‰∏Ä‰∏™ËÆ°Âàí
            const timeStartEl = document.getElementById('autoStartTime');
            const timeEndEl = document.getElementById('autoEndTime');
            const priceValueEl = document.getElementById('autoPriceValue');
            const batteryValueEl = document.getElementById('autoBatteryValue');

            const chargePlan = autoSettings.charge.plans?.[0];
            if (chargePlan) {
                if (!chargePlan.timeRange) chargePlan.timeRange = {};
                chargePlan.timeRange.start = timeStartEl ? timeStartEl.value : '22:00';
                chargePlan.timeRange.end = timeEndEl ? timeEndEl.value : '06:00';
                chargePlan.priceThreshold = parseFloat(priceValueEl ? priceValueEl.value : '50');
                autoSettings.charge.stopSOC = parseFloat(batteryValueEl ? batteryValueEl.value : 90);
            }

            // Close panel
            closeAutoSettings();

            // Show confirmation message
            showAutoSettingsSaved();

            // Update conditions display
            updateAutoConditionsDisplay();

            // Restart auto check if in auto mode
            if (currentOperationMode === 'auto') {
                startAutoOperationCheck();
            }
        }
        
        function selectAutoType(type) {
            autoSettings.type = type;

            // Update UI
            const chargeBtn = document.querySelector('[onclick="selectAutoType(\'charge\')"]');
            const dischargeBtn = document.querySelector('[onclick="selectAutoType(\'discharge\')"]');
            const chargeConfigSection = document.getElementById('chargeConfigSection');
            const dischargeConfigSection = document.getElementById('dischargeConfigSection');

            if (type === 'charge') {
                // ÊòæÁ§∫ÂÖÖÁîµÈÖçÁΩÆ,ÈöêËóèÊîæÁîµÈÖçÁΩÆ
                chargeBtn.style.background = '#4CD964';  // ÁªøËâ≤
                chargeBtn.style.color = '#000';
                dischargeBtn.style.background = 'transparent';
                dischargeBtn.style.color = 'rgba(255,255,255,0.7)';

                if (chargeConfigSection) chargeConfigSection.style.display = 'block';
                if (dischargeConfigSection) dischargeConfigSection.style.display = 'none';

                // Ê∏≤ÊüìÂÖÖÁîµËÆ°ÂàíÂç°Áâá
                renderChargePlans();
            } else {
                // ÊòæÁ§∫ÊîæÁîµÈÖçÁΩÆ,ÈöêËóèÂÖÖÁîµÈÖçÁΩÆ
                chargeBtn.style.background = 'transparent';
                chargeBtn.style.color = 'rgba(255,255,255,0.7)';
                dischargeBtn.style.background = '#FFC107';  // ÈªÑËâ≤
                dischargeBtn.style.color = '#000';

                if (chargeConfigSection) chargeConfigSection.style.display = 'none';
                if (dischargeConfigSection) dischargeConfigSection.style.display = 'block';

                // Ê∏≤ÊüìÊîæÁîµËÆ°ÂàíÂç°Áâá
                renderDischargePlans();
            }
        }

        // ===== ÂàÜÊó∂Â§öÈò∂ÂÖÖÁîµÁ≠ñÁï•ÁÆ°ÁêÜÂáΩÊï∞ =====

        /**
         * Ê∑ªÂä†Êñ∞ÁöÑÂÖÖÁîµÊó∂Èó¥ÊÆµ
         */
        function addChargePlan() {
            const newPlan = {
                id: 'charge_plan_' + Date.now(),
                enabled: true,
                timeRange: { start: '00:00', end: '23:59' },
                priceThreshold: 50,
                priceEnabled: true
            };
            autoSettings.charge.plans.push(newPlan);
            renderChargePlans();
        }

        /**
         * Âà†Èô§ÊåáÂÆöÁöÑÂÖÖÁîµÊó∂Èó¥ÊÆµ
         */
        function removeChargePlan(planId) {
            // Ëá≥Â∞ë‰øùÁïô‰∏Ä‰∏™Êó∂Èó¥ÊÆµ
            if (autoSettings.charge.plans.length <= 1) {
                alert(window.i18n ? window.i18n.getText('mustKeepOneTimeSlot') : 'Ëá≥Â∞ëÈúÄË¶Å‰øùÁïô‰∏Ä‰∏™Êó∂Èó¥ÊÆµ');
                return;
            }
            autoSettings.charge.plans = autoSettings.charge.plans.filter(p => p.id !== planId);
            renderChargePlans();
        }

        /**
         * Êõ¥Êñ∞ÂÖÖÁîµÊó∂Èó¥ÊÆµÊï∞ÊçÆ
         */
        function updateChargePlan(planId, field, value) {
            const plan = autoSettings.charge.plans.find(p => p.id === planId);
            if (!plan) return;

            if (field === 'timeStart') {
                plan.timeRange.start = value;
            } else if (field === 'timeEnd') {
                plan.timeRange.end = value;
            } else if (field === 'priceThreshold') {
                plan.priceThreshold = parseFloat(value);
            } else if (field === 'priceEnabled') {
                plan.priceEnabled = value;
            } else if (field === 'enabled') {
                plan.enabled = value;
            }
        }

        /**
         * Ê∏≤ÊüìÊâÄÊúâÂÖÖÁîµÊó∂Èó¥ÊÆµÂç°Áâá
         */
        function renderChargePlans() {
            const container = document.getElementById('chargePlansContainer');
            if (!container) return;

            // Ê∏ÖÁ©∫ÂÆπÂô®
            container.innerHTML = '';

            // Ê∏≤ÊüìÊØè‰∏™ËÆ°Âàí
            autoSettings.charge.plans.forEach((plan, index) => {
                const card = createChargePlanCard(plan, index);
                container.appendChild(card);
            });
        }

        /**
         * ÂàõÂª∫Âçï‰∏™ÂÖÖÁîµÊó∂Èó¥ÊÆµÂç°Áâá
         */
        function createChargePlanCard(plan, index) {
            const card = document.createElement('div');
            card.style.cssText = `
                background: linear-gradient(145deg, rgba(76,217,100,0.1) 0%, rgba(76,217,100,0.05) 100%);
                border: 1px solid rgba(76,217,100,0.3);
                border-radius: 10px;
                padding: 14px;
                margin-bottom: 10px;
                transition: all 0.3s;
            `;

            card.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 14px; color: #4CD964;">‚è∞</span>
                        <span style="color: rgba(255,255,255,0.9); font-weight: 500; font-size: 13px;">
                            ${window.i18n ? window.i18n.getText('timeSlot') : 'Êó∂Èó¥ÊÆµ'} ${index + 1}
                        </span>
                    </div>
                    <button onclick="removeChargePlan('${plan.id}')" style="
                        background: rgba(255,59,48,0.15);
                        border: 1px solid rgba(255,59,48,0.3);
                        color: #FF3B30;
                        padding: 3px 10px;
                        border-radius: 10px;
                        font-size: 11px;
                        cursor: pointer;
                        transition: all 0.3s;
                    " onmouseover="this.style.background='rgba(255,59,48,0.25)'" onmouseout="this.style.background='rgba(255,59,48,0.15)'">
                        ${window.i18n ? window.i18n.getText('delete') : 'Âà†Èô§'}
                    </button>
                </div>

                <!-- Êó∂Èó¥ËåÉÂõ¥ -->
                <div style="margin-bottom: 10px;">
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="time" value="${plan.timeRange.start}"
                            onchange="updateChargePlan('${plan.id}', 'timeStart', this.value)"
                            style="flex: 1; padding: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(76,217,100,0.3); border-radius: 10px; color: #fff; font-size: 13px;">
                        <span style="color: rgba(255,255,255,0.5); font-size: 12px;">Ëá≥</span>
                        <input type="time" value="${plan.timeRange.end}"
                            onchange="updateChargePlan('${plan.id}', 'timeEnd', this.value)"
                            style="flex: 1; padding: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(76,217,100,0.3); border-radius: 10px; color: #fff; font-size: 13px;">
                    </div>
                </div>

                <!-- ‰ª∑Ê†ºÈó®Êßõ -->
                <div>
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                        <input type="checkbox" ${plan.priceEnabled ? 'checked' : ''}
                            onchange="updateChargePlan('${plan.id}', 'priceEnabled', this.checked)"
                            style="width: 15px; height: 15px; accent-color: #4CD964; cursor: pointer;">
                        <label style="color: rgba(255,255,255,0.8); font-size: 12px;">
                            ${window.i18n ? window.i18n.getText('enablePriceCondition') : 'ÂêØÁî®‰ª∑Ê†ºÊù°‰ª∂'}
                        </label>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center; ${plan.priceEnabled ? '' : 'opacity: 0.4;'}">
                        <span style="color: rgba(255,255,255,0.7); font-size: 12px; min-width: 32px;">${window.i18n ? window.i18n.getText('lessThan') : '‰Ωé‰∫é'}</span>
                        <input type="number" value="${plan.priceThreshold}" step="1"
                            ${plan.priceEnabled ? '' : 'disabled'}
                            onchange="updateChargePlan('${plan.id}', 'priceThreshold', this.value)"
                            style="flex: 1; padding: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(76,217,100,0.3); border-radius: 10px; color: #fff; font-size: 13px;">
                        <span style="color: rgba(255,255,255,0.6); font-size: 12px; min-width: 50px;">$/MWh</span>
                    </div>
                </div>
            `;

            return card;
        }

        // ===== ÂàÜÊó∂Â§öÈò∂ÊîæÁîµÁ≠ñÁï•ÁÆ°ÁêÜÂáΩÊï∞ =====

        /**
         * Ê∑ªÂä†Êñ∞ÁöÑÊîæÁîµËÆ°Âàí
         */
        function addDischargePlan() {
            const newPlan = {
                id: 'plan_' + Date.now(),
                enabled: true,
                timeRange: { start: '00:00', end: '23:59' },
                priceThreshold: 100,
                priceEnabled: true
            };
            autoSettings.discharge.plans.push(newPlan);
            renderDischargePlans();
        }

        /**
         * Âà†Èô§ÊåáÂÆöÁöÑÊó∂Èó¥ÊÆµ
         */
        function removeDischargePlan(planId) {
            // Ëá≥Â∞ë‰øùÁïô‰∏Ä‰∏™Êó∂Èó¥ÊÆµ
            if (autoSettings.discharge.plans.length <= 1) {
                alert(window.i18n ? window.i18n.getText('mustKeepOneTimeSlot') : 'Ëá≥Â∞ëÈúÄË¶Å‰øùÁïô‰∏Ä‰∏™Êó∂Èó¥ÊÆµ');
                return;
            }
            autoSettings.discharge.plans = autoSettings.discharge.plans.filter(p => p.id !== planId);
            renderDischargePlans();
        }

        /**
         * Êõ¥Êñ∞ÊîæÁîµËÆ°ÂàíÊï∞ÊçÆ
         */
        function updateDischargePlan(planId, field, value) {
            const plan = autoSettings.discharge.plans.find(p => p.id === planId);
            if (!plan) return;

            if (field === 'timeStart') {
                plan.timeRange.start = value;
            } else if (field === 'timeEnd') {
                plan.timeRange.end = value;
            } else if (field === 'priceThreshold') {
                plan.priceThreshold = parseFloat(value);
            } else if (field === 'priceEnabled') {
                plan.priceEnabled = value;
            } else if (field === 'enabled') {
                plan.enabled = value;
            }
        }

        /**
         * Ê∏≤ÊüìÊâÄÊúâÊîæÁîµËÆ°ÂàíÂç°Áâá
         */
        function renderDischargePlans() {
            const container = document.getElementById('dischargePlansContainer');
            if (!container) return;

            // Ê∏ÖÁ©∫ÂÆπÂô®
            container.innerHTML = '';

            // Ê∏≤ÊüìÊØè‰∏™ËÆ°Âàí
            autoSettings.discharge.plans.forEach((plan, index) => {
                const card = createDischargePlanCard(plan, index);
                container.appendChild(card);
            });
        }

        /**
         * ÂàõÂª∫Âçï‰∏™Êó∂Èó¥ÊÆµÂç°Áâá
         */
        function createDischargePlanCard(plan, index) {
            const card = document.createElement('div');
            card.style.cssText = `
                background: linear-gradient(145deg, rgba(255,193,7,0.1) 0%, rgba(255,193,7,0.05) 100%);
                border: 1px solid rgba(255,193,7,0.3);
                border-radius: 10px;
                padding: 14px;
                margin-bottom: 10px;
                transition: all 0.3s;
            `;

            card.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 14px; color: #FFC107;">‚è∞</span>
                        <span style="color: rgba(255,255,255,0.9); font-weight: 500; font-size: 13px;">
                            ${window.i18n ? window.i18n.getText('timeSlot') : 'Êó∂Èó¥ÊÆµ'} ${index + 1}
                        </span>
                    </div>
                    <button onclick="removeDischargePlan('${plan.id}')" style="
                        background: rgba(255,59,48,0.15);
                        border: 1px solid rgba(255,59,48,0.3);
                        color: #FF3B30;
                        padding: 3px 10px;
                        border-radius: 10px;
                        font-size: 11px;
                        cursor: pointer;
                        transition: all 0.3s;
                    " onmouseover="this.style.background='rgba(255,59,48,0.25)'" onmouseout="this.style.background='rgba(255,59,48,0.15)'">
                        ${window.i18n ? window.i18n.getText('delete') : 'Âà†Èô§'}
                    </button>
                </div>

                <!-- Êó∂Èó¥ËåÉÂõ¥ -->
                <div style="margin-bottom: 10px;">
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="time" value="${plan.timeRange.start}"
                            onchange="updateDischargePlan('${plan.id}', 'timeStart', this.value)"
                            style="flex: 1; padding: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,193,7,0.3); border-radius: 10px; color: #fff; font-size: 13px;">
                        <span style="color: rgba(255,255,255,0.5); font-size: 12px;">Ëá≥</span>
                        <input type="time" value="${plan.timeRange.end}"
                            onchange="updateDischargePlan('${plan.id}', 'timeEnd', this.value)"
                            style="flex: 1; padding: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,193,7,0.3); border-radius: 10px; color: #fff; font-size: 13px;">
                    </div>
                </div>

                <!-- ‰ª∑Ê†ºÈó®Êßõ -->
                <div>
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                        <input type="checkbox" ${plan.priceEnabled ? 'checked' : ''}
                            onchange="updateDischargePlan('${plan.id}', 'priceEnabled', this.checked)"
                            style="width: 15px; height: 15px; accent-color: #FFC107; cursor: pointer;">
                        <label style="color: rgba(255,255,255,0.8); font-size: 12px;">
                            ${window.i18n ? window.i18n.getText('enablePriceCondition') : 'ÂêØÁî®‰ª∑Ê†ºÊù°‰ª∂'}
                        </label>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center; ${plan.priceEnabled ? '' : 'opacity: 0.4;'}">
                        <span style="color: rgba(255,255,255,0.7); font-size: 12px; min-width: 32px;">${window.i18n ? window.i18n.getText('greaterThan') : 'È´ò‰∫é'}</span>
                        <input type="number" value="${plan.priceThreshold}" step="1"
                            ${plan.priceEnabled ? '' : 'disabled'}
                            onchange="updateDischargePlan('${plan.id}', 'priceThreshold', this.value)"
                            style="flex: 1; padding: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,193,7,0.3); border-radius: 10px; color: #fff; font-size: 13px;">
                        <span style="color: rgba(255,255,255,0.6); font-size: 12px; min-width: 50px;">$/MWh</span>
                    </div>
                </div>
            `;

            return card;
        }

        function updateBatteryRangeVisibility() {
            const operator = document.getElementById('autoBatteryOperator').value;
            const value2Input = document.getElementById('autoBatteryValue2');
            
            if (operator === 'between') {
                value2Input.style.display = 'block';
            } else {
                value2Input.style.display = 'none';
            }
        }
        
        // ====== ÁøªÁâåÂÄíËÆ°Êó∂Âô® ======
        let flipCountdownTarget = null; // ÁõÆÊ†áÊó∂Èó¥Êà≥(ms)
        let flipCountdownInterval = null;
        let flipLastDigits = { H0: '', H1: '', M0: '', M1: '', S0: '', S1: '' };

        // Êõ¥Êñ∞Âçï‰∏™ÁøªÁâåÂç°Áâá
        function updateFlipCard(id, newDigit) {
            const key = id.replace('flip', '');
            if (flipLastDigits[key] === newDigit) return; // Êï∞Â≠óÊ≤°ÂèòÔºå‰∏çÁøª
            const card = document.getElementById(id);
            if (!card) return;

            const oldDigit = flipLastDigits[key] || '0';
            flipLastDigits[key] = newDigit;

            // Êõ¥Êñ∞Â∫ïÂ±ÇÈùôÊÄÅÊï∞Â≠óÔºàÊñ∞ÂÄºÔºâ
            card.querySelector('.flip-top .flip-digit').textContent = newDigit;
            card.querySelector('.flip-bottom .flip-digit').textContent = newDigit;

            // ÁßªÈô§ÊóßÁöÑÁøªËΩ¨Áâá
            card.querySelectorAll('.flip-front, .flip-back').forEach(el => el.remove());
            card.classList.remove('flipping');

            // ÂàõÂª∫ÁøªËΩ¨ÁâáÔºö‰∏äÂçäÔºàÊóßÂÄºÁøª‰∏ãÂéªÔºâ+ ‰∏ãÂçäÔºàÊñ∞ÂÄºÁøª‰∏äÊù•Ôºâ
            const front = document.createElement('div');
            front.className = 'flip-front';
            front.innerHTML = `<div class="flip-digit">${oldDigit}</div>`;

            const back = document.createElement('div');
            back.className = 'flip-back';
            back.innerHTML = `<div class="flip-digit">${newDigit}</div>`;

            card.appendChild(front);
            card.appendChild(back);

            // Ëß¶ÂèëÂä®Áîª
            requestAnimationFrame(() => card.classList.add('flipping'));

            // Âä®ÁîªÁªìÊùüÂêéÊ∏ÖÁêÜ
            setTimeout(() => {
                card.classList.remove('flipping');
                front.remove();
                back.remove();
            }, 600);
        }

        // È©±Âä®ÁøªÁâåÂÄíËÆ°Êó∂ÊØèÁßíÊõ¥Êñ∞
        function tickFlipCountdown() {
            if (!flipCountdownTarget) return;
            const flipEl = document.getElementById('aiCountdownFlip');
            if (!flipEl) return;

            const diff = Math.max(0, flipCountdownTarget - Date.now());
            const totalSec = Math.floor(diff / 1000);
            const h = Math.floor(totalSec / 3600);
            const m = Math.floor((totalSec % 3600) / 60);
            const s = totalSec % 60;

            const hStr = h.toString().padStart(2, '0');
            const mStr = m.toString().padStart(2, '0');
            const sStr = s.toString().padStart(2, '0');

            updateFlipCard('flipH0', hStr[0]);
            updateFlipCard('flipH1', hStr[1]);
            updateFlipCard('flipM0', mStr[0]);
            updateFlipCard('flipM1', mStr[1]);
            updateFlipCard('flipS0', sStr[0]);
            updateFlipCard('flipS1', sStr[1]);

            if (totalSec <= 0) {
                stopFlipCountdown();
                // ÂÄíËÆ°Êó∂ÂΩíÈõ∂ ‚Üí Á´ãÂç≥Ëß¶ÂèëÊù°‰ª∂Ê£ÄÊü•ÔºåÈ©±Âä®Áä∂ÊÄÅÂàáÊç¢
                if (typeof checkAutoConditions === 'function') {
                    checkAutoConditions();
                }
                // Âà∑Êñ∞È¢ÑÊµãÊñáÊú¨ÊòæÁ§∫
                updateAIPredictionText();
            }
        }

        function startFlipCountdown(targetMs) {
            flipCountdownTarget = targetMs;
            // ÈáçÁΩÆËÆ∞ÂøÜÔºåÂº∫Âà∂È¶ñÊ¨°ÂÖ®ÈÉ®Âà∑Êñ∞
            flipLastDigits = { H0: '', H1: '', M0: '', M1: '', S0: '', S1: '' };
            tickFlipCountdown();
            if (flipCountdownInterval) clearInterval(flipCountdownInterval);
            flipCountdownInterval = setInterval(tickFlipCountdown, 1000);
            const flipEl = document.getElementById('aiCountdownFlip');
            if (flipEl) flipEl.style.display = 'flex';
        }

        function stopFlipCountdown() {
            if (flipCountdownInterval) {
                clearInterval(flipCountdownInterval);
                flipCountdownInterval = null;
            }
            flipCountdownTarget = null;
            const flipEl = document.getElementById('aiCountdownFlip');
            if (flipEl) flipEl.style.display = 'none';
        }

        // AIÈ¢ÑÊµãÁä∂ÊÄÅÊñáÊú¨Êõ¥Êñ∞
        function updateAIPredictionText() {
            const container = document.getElementById('aiPredictionText');
            const content = document.getElementById('aiPredictionContent');
            if (!container || !content) return;

            // ÈùûËá™Âä®Ê®°Âºè ‚Üí ÈöêËóè
            if (currentOperationMode !== 'auto') {
                container.style.display = 'none';
                stopFlipCountdown();
                return;
            }

            const status = regionData[selectedMainRegion]?.status;
            const isEn = window.i18n && window.i18n.getCurrentLanguage() === 'en';

            if (status === 'autoCharge' || status === 'autoDischarge') {
                // Ê≠£Âú®ÂÖÖÁîµ/ÊîæÁîµ ‚Üí ËÆ°ÁÆóÈ¢ÑËÆ°ÁªìÊùüÊó∂Èó¥
                const isCharge = status === 'autoCharge';
                const currentSOC = getCurrentBatteryLevel();
                const targetSOC = isCharge
                    ? (autoSettings.charge.stopSOC || 90)
                    : (autoSettings.discharge.stopSOC || 20);
                const socDiff = Math.abs(targetSOC - currentSOC);
                const intervalsNeeded = Math.ceil(socDiff / 2.083);
                const minutesLeft = intervalsNeeded * 5;
                const endTime = new Date(Date.now() + minutesLeft * 60000);
                const endTimeStr = endTime.getHours().toString().padStart(2, '0') + ':' + endTime.getMinutes().toString().padStart(2, '0');
                const actionText = isCharge
                    ? (isEn ? 'charging' : 'ÂÖÖÁîµ')
                    : (isEn ? 'discharging' : 'ÊîæÁîµ');

                const nowStr = new Date().getHours().toString().padStart(2, '0') + ':' + new Date().getMinutes().toString().padStart(2, '0');
                content.textContent = isEn
                    ? `‚ö° ${actionText} ${nowStr}-${endTimeStr}`
                    : `‚ö° ${actionText}‰∏≠ ${nowStr}-${endTimeStr}`;
                content.style.color = isCharge ? 'rgba(0,255,136,0.75)' : 'rgba(255,193,7,0.75)';

                // ÁøªÁâåÂÄíËÆ°Êó∂ÔºöË∑ùÁªìÊùü
                startFlipCountdown(endTime.getTime());
                container.style.display = 'block';

            } else if (status === 'waitingExecution') {
                const bc = latestAIForecast.bestCharge;
                const bd = latestAIForecast.bestDischarge;

                if (!bc && !bd) {
                    content.textContent = isEn ? 'ü§ñ AI analyzing...' : 'ü§ñ AI ÂàÜÊûê‰∏≠...';
                    content.style.color = 'rgba(255,255,255,0.45)';
                    stopFlipCountdown();
                    container.style.display = 'block';
                    return;
                }

                const now = new Date();
                const nowMinutes = now.getHours() * 60 + now.getMinutes();
                const toMinutes = (timeStr) => {
                    if (!timeStr) return Infinity;
                    const [h, m] = timeStr.split(':').map(Number);
                    return h * 60 + m;
                };

                let nextAction = null;
                let nextWindow = null;

                // Ê£ÄÊü•ÊòØÂê¶Êúâ"Ê≠£Âú®ËøõË°å‰∏≠"ÁöÑÁ™óÂè£ÔºàÂ∑≤Ëøá startTime ‰ΩÜÊú™Ëøá endTimeÔºâ
                const isInWindow = (w) => {
                    if (!w) return false;
                    const startMin = toMinutes(w.startTime);
                    const endMin = toMinutes(w.endTimeDisplay);
                    return nowMinutes >= startMin && nowMinutes < endMin;
                };

                if (isInWindow(bc)) {
                    nextAction = isEn ? 'charge' : 'ÂÖÖÁîµ';
                    nextWindow = bc;
                } else if (isInWindow(bd)) {
                    nextAction = isEn ? 'discharge' : 'ÊîæÁîµ';
                    nextWindow = bd;
                } else {
                    // Ê≤°ÊúâËøõË°å‰∏≠ÁöÑÁ™óÂè£ ‚Üí ÊâæÊúÄËøëÁöÑÊú™Êù•Á™óÂè£
                    const bcMin = bc ? toMinutes(bc.startTime) : Infinity;
                    const bdMin = bd ? toMinutes(bd.startTime) : Infinity;
                    const bcFuture = bcMin > nowMinutes ? bcMin : Infinity;
                    const bdFuture = bdMin > nowMinutes ? bdMin : Infinity;

                    if (bcFuture <= bdFuture && bcFuture !== Infinity && bc) {
                        nextAction = isEn ? 'charge' : 'ÂÖÖÁîµ';
                        nextWindow = bc;
                    } else if (bdFuture !== Infinity && bd) {
                        nextAction = isEn ? 'discharge' : 'ÊîæÁîµ';
                        nextWindow = bd;
                    }
                }

                if (nextAction && nextWindow) {
                    const today = new Date();
                    const [th, tm] = nextWindow.startTime.split(':').map(Number);
                    const targetDate = new Date(today.getFullYear(), today.getMonth(), today.getDate(), th, tm, 0);
                    const timeRange = nextWindow.startTime + '-' + nextWindow.endTimeDisplay;

                    if (targetDate.getTime() > Date.now()) {
                        // ËøòÊ≤°Âà∞Á™óÂè£ÂºÄÂßãÊó∂Èó¥ ‚Üí ÊòæÁ§∫"È¢ÑËÆ°ÊâßË°å"+ ÂÄíËÆ°Êó∂
                        content.textContent = isEn
                            ? `ü§ñ Est. ${nextAction} ${timeRange}`
                            : `ü§ñ È¢ÑËÆ° ${timeRange} ÊâßË°å${nextAction}`;
                        content.style.color = 'rgba(0,255,136,0.65)';
                        startFlipCountdown(targetDate.getTime());
                    } else {
                        // Â∑≤ËøáÁ™óÂè£ÂºÄÂßãÊó∂Èó¥ ‚Üí ÊòæÁ§∫"ÊâßË°å‰∏≠"ÔºåÂÄíËÆ°Êó∂Âà∞Á™óÂè£ÁªìÊùü
                        const isC = nextWindow.action === 'charge';
                        content.textContent = isEn
                            ? `‚ö° ${nextAction}ing ${timeRange}`
                            : `‚ö° ${nextAction}‰∏≠ ${timeRange}`;
                        content.style.color = isC ? 'rgba(0,255,136,0.85)' : 'rgba(255,193,7,0.85)';
                        // ËÆ°ÁÆóÁ™óÂè£ÁªìÊùüÊó∂Èó¥ÁöÑÂÄíËÆ°Êó∂
                        const [eh, em] = nextWindow.endTimeDisplay.split(':').map(Number);
                        const endDate = new Date(today.getFullYear(), today.getMonth(), today.getDate(), eh, em, 0);
                        if (endDate.getTime() > Date.now()) {
                            startFlipCountdown(endDate.getTime());
                        } else {
                            stopFlipCountdown();
                        }
                    }
                } else {
                    // ÊâÄÊúâÁ™óÂè£ÈÉΩÂ∑≤Ëøá ‚Üí ÁõëÊéß‰∏≠
                    content.textContent = isEn ? 'ü§ñ Monitoring market...' : 'ü§ñ ÁõëÊéßË°åÊÉÖ‰∏≠...';
                    content.style.color = 'rgba(255,255,255,0.45)';
                    stopFlipCountdown();
                }
                container.style.display = 'block';

            } else {
                container.style.display = 'none';
                stopFlipCountdown();
            }
        }

        function startAutoOperationCheck() {
            // Clear existing interval
            if (autoCheckInterval) {
                clearInterval(autoCheckInterval);
            }
            
            // Check conditions every 30 seconds
            autoCheckInterval = setInterval(checkAutoConditions, 30000);
        }
        
        function checkAutoConditions() {
            if (currentOperationMode !== 'auto') return;
            
            const now = new Date();
            const currentTime = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
            const currentPrice = getCurrentPrice();
            const currentBatteryLevel = getCurrentBatteryLevel();
            
            // Check charge conditions
            if (shouldTriggerCharge(currentTime, currentPrice, currentBatteryLevel)) {
                triggerChargeOperation();
                return;
            }
            
            // Check discharge conditions
            if (shouldTriggerDischarge(currentTime, currentPrice, currentBatteryLevel)) {
                triggerDischargeOperation();
                return;
            }
        }
        
        function shouldTriggerCharge(currentTime, currentPrice, currentBatteryLevel) {
            const charge = autoSettings.charge;

            // Ê£ÄÊü•ÂÖ®Â±ÄSOCÊù°‰ª∂(ÂßãÁªàÊ£ÄÊü•)
            if (currentBatteryLevel >= charge.stopSOC) {
                return false; // ÁîµÈáèÂ∑≤ËææÂà∞ÂÖÖÁîµÂÅúÊ≠¢ÂÄº,‰∏çËß¶Âèë
            }

            // ===== ÂàÜÊó∂Â§öÈò∂ÂÖÖÁîµÁ≠ñÁï•: Âπ∂ËÅîÈÄªËæë =====
            // Âè™Ë¶Å‰ªªÊÑè‰∏Ä‰∏™ËÆ°ÂàíÊª°Ë∂≥Êù°‰ª∂,Â∞±Ëß¶ÂèëÂÖÖÁîµ

            if (!charge.plans || charge.plans.length === 0) {
                return false; // Ê≤°ÊúâËÆ°Âàí,‰∏çËß¶Âèë
            }

            // ÈÅçÂéÜÊâÄÊúâÂêØÁî®ÁöÑËÆ°Âàí
            for (const plan of charge.plans) {
                if (!plan.enabled) continue; // Ë∑≥ËøáÊú™ÂêØÁî®ÁöÑËÆ°Âàí

                // Ê£ÄÊü•Êó∂Èó¥Á™óÂè£
                const timeMatch = isTimeInRange(currentTime, plan.timeRange.start, plan.timeRange.end);
                if (!timeMatch) continue; // Êó∂Èó¥‰∏çÂåπÈÖç,Ê£ÄÊü•‰∏ã‰∏Ä‰∏™ËÆ°Âàí

                // Ê£ÄÊü•‰ª∑Ê†ºÊù°‰ª∂(Â¶ÇÊûúÂêØÁî®)
                if (plan.priceEnabled) {
                    const priceMatch = currentPrice < plan.priceThreshold;
                    if (!priceMatch) continue; // ‰ª∑Ê†º‰∏çÊª°Ë∂≥,Ê£ÄÊü•‰∏ã‰∏Ä‰∏™ËÆ°Âàí
                }

                // Âà∞ËææËøôÈáåËØ¥ÊòéÂΩìÂâçËÆ°ÂàíÁöÑÊâÄÊúâÊù°‰ª∂ÈÉΩÊª°Ë∂≥
                return true; // ÊâæÂà∞‰∏Ä‰∏™Êª°Ë∂≥Êù°‰ª∂ÁöÑËÆ°Âàí,Á´ãÂç≥Ëß¶Âèë
            }

            // ÊâÄÊúâËÆ°ÂàíÈÉΩ‰∏çÊª°Ë∂≥
            return false;
        }
        
        function shouldTriggerDischarge(currentTime, currentPrice, currentBatteryLevel) {
            const discharge = autoSettings.discharge;

            // Ê£ÄÊü•ÂÖ®Â±ÄSOCÊù°‰ª∂(ÂßãÁªàÊ£ÄÊü•)
            if (currentBatteryLevel <= discharge.stopSOC) {
                return false; // ÁîµÈáèÂ∑≤ËææÂà∞ÊîæÁîµÂÅúÊ≠¢ÂÄº,‰∏çËß¶Âèë
            }

            // ===== ÂàÜÊó∂Â§öÈò∂ÊîæÁîµÁ≠ñÁï•: Âπ∂ËÅîÈÄªËæë =====
            // Âè™Ë¶Å‰ªªÊÑè‰∏Ä‰∏™ËÆ°ÂàíÊª°Ë∂≥Êù°‰ª∂,Â∞±Ëß¶ÂèëÊîæÁîµ
            // Á±ª‰ººÁîµË∑Ø‰∏≠ÁöÑ"Êàñ"ÈÄªËæë: Plan1 OR Plan2 OR Plan3...

            if (!discharge.plans || discharge.plans.length === 0) {
                return false; // Ê≤°ÊúâËÆ°Âàí,‰∏çËß¶Âèë
            }

            // ÈÅçÂéÜÊâÄÊúâÂêØÁî®ÁöÑËÆ°Âàí
            for (const plan of discharge.plans) {
                if (!plan.enabled) continue; // Ë∑≥ËøáÊú™ÂêØÁî®ÁöÑËÆ°Âàí

                // Ê£ÄÊü•Êó∂Èó¥Á™óÂè£
                const timeMatch = isTimeInRange(currentTime, plan.timeRange.start, plan.timeRange.end);
                if (!timeMatch) continue; // Êó∂Èó¥‰∏çÂåπÈÖç,Ê£ÄÊü•‰∏ã‰∏Ä‰∏™ËÆ°Âàí

                // Ê£ÄÊü•‰ª∑Ê†ºÊù°‰ª∂(Â¶ÇÊûúÂêØÁî®)
                if (plan.priceEnabled) {
                    const priceMatch = currentPrice > plan.priceThreshold;
                    if (!priceMatch) continue; // ‰ª∑Ê†º‰∏çÊª°Ë∂≥,Ê£ÄÊü•‰∏ã‰∏Ä‰∏™ËÆ°Âàí
                }

                // Âà∞ËææËøôÈáåËØ¥ÊòéÂΩìÂâçËÆ°ÂàíÁöÑÊâÄÊúâÊù°‰ª∂ÈÉΩÊª°Ë∂≥
                return true; // ÊâæÂà∞‰∏Ä‰∏™Êª°Ë∂≥Êù°‰ª∂ÁöÑËÆ°Âàí,Á´ãÂç≥Ëß¶Âèë
            }

            // ÊâÄÊúâËÆ°ÂàíÈÉΩ‰∏çÊª°Ë∂≥
            return false;
        }
        
        function checkCondition(value, operator, threshold) {
            switch (operator) {
                case 'less':
                    return value < threshold;
                case 'greater':
                    return value > threshold;
                default:
                    return true;
            }
        }
        
        function isTimeInRange(currentTime, startTime, endTime) {
            const current = timeToMinutes(currentTime);
            const start = timeToMinutes(startTime);
            const end = timeToMinutes(endTime);
            
            if (start <= end) {
                return current >= start && current <= end;
            } else {
                // Crosses midnight
                return current >= start || current <= end;
            }
        }
        
        function timeToMinutes(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }
        
        function checkPriceCondition(price) {
            const { operator, value } = autoSettings.priceCondition;
            
            switch (operator) {
                case 'less':
                    return price < value;
                case 'greater':
                    return price > value;
                default:
                    return true;
            }
        }
        
        function checkBatteryCondition(batteryLevel) {
            const { operator, value, value2 } = autoSettings.batteryCondition;
            
            switch (operator) {
                case 'less':
                    return batteryLevel < value;
                case 'greater':
                    return batteryLevel > value;
                case 'between':
                    return batteryLevel >= Math.min(value, value2) && batteryLevel <= Math.max(value, value2);
                default:
                    return true;
            }
        }
        
        function getCurrentPrice() {
            // Get current price from the price circle
            const priceElement = document.querySelector('.current-price');
            if (priceElement) {
                const priceText = priceElement.textContent.replace('$', '').replace(/[^0-9.-]/g, '');
                return parseFloat(priceText) || 0;
            }
            return 0;
        }
        
        function getCurrentBatteryLevel() {
            // Get current battery level from the power station data
            const batteryElement = document.querySelector('.power-bar');
            if (batteryElement) {
                const widthStyle = batteryElement.style.width;
                if (widthStyle) {
                    return parseFloat(widthStyle.replace('%', '')) || 0;
                }
            }
            return 50; // Default battery level
        }
        
        function triggerAutoOperation() {
            const operationType = autoSettings.type;
            
            // Prevent duplicate operations
            if (currentOperation) {
                return;
            }
            
            
            // Simulate button click for the appropriate operation
            if (operationType === 'charge') {
                triggerChargeOperation();
            } else {
                triggerDischargeOperation();
            }
        }
        
        function triggerChargeOperation() {
            // Simulate charge button click
            const chargeBtn = document.querySelector('#chargeBtn, [onclick*="charge"]');
            if (chargeBtn && !chargeBtn.disabled) {
                chargeBtn.click();
                showAutoOperationNotification('ÂÖÖÁîµ', 'Êô∫ËÉΩÂÖÖÁîµÂ∑≤ÂêØÂä®');
            }
        }
        
        function triggerDischargeOperation() {
            // Simulate discharge button click
            const dischargeBtn = document.querySelector('#dischargeBtn, [onclick*="discharge"]');
            if (dischargeBtn && !dischargeBtn.disabled) {
                dischargeBtn.click();
                showAutoOperationNotification('ÊîæÁîµ', 'Êô∫ËÉΩÊîæÁîµÂ∑≤ÂêØÂä®');
            }
        }
        
        function showAutoOperationNotification(operation, message) {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: var(--color-bg-card);
                border: 1px solid var(--color-border);
                border-radius: 10px;
                padding: 16px;
                color: #fff;
                z-index: 10000;
                max-width: 300px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                animation: slideInRight 0.3s ease-out;
            `;
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="width: 8px; height: 8px; background: #00ff88; border-radius: 50%; box-shadow: 0 0 8px rgba(0,255,136,0.5);"></div>
                    <div>
                        <div style="font-weight: 600; margin-bottom: 4px;">Ëá™Âä®Êìç‰Ωú</div>
                        <div style="font-size: 14px; opacity: 0.8;">${message}</div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease-in forwards';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }
        
        function showAutoSettingsSaved() {
            showAutoOperationNotification('ËÆæÁΩÆ', 'Êô∫ËÉΩÊâòÁÆ°ËÆæÁΩÆÂ∑≤‰øùÂ≠ò');
        }
        
        function updateAutoConditionsDisplay() {
            // ÈÄÇÈÖçÊñ∞ÁöÑ plans[] Êï∞ÊçÆÁªìÊûÑÔºå‰ªéÁ¨¨‰∏Ä‰∏™ËÆ°ÂàíËØªÂèñÊòæÁ§∫ÂÄº
            const chargePlan = autoSettings.charge.plans?.[0] || {};
            const dischargePlan = autoSettings.discharge.plans?.[0] || {};

            const setElementValue = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.value = value;
            };
            const setElementChecked = (id, checked) => {
                const el = document.getElementById(id);
                if (el) el.checked = !!checked;
            };
            const setElementText = (id, text) => {
                const el = document.getElementById(id);
                if (el) el.textContent = text ?? '';
            };

            // --- ÂÖÖÁîµÊù°‰ª∂ ---
            const chargeTimeEnabled = chargePlan.enabled ?? true;
            setElementChecked('chargeTimeEnabled', chargeTimeEnabled);
            setElementChecked('chargeTimeEnabledDisplay', chargeTimeEnabled);
            setElementText('chargeStartTime', chargePlan.timeRange?.start ?? '22:00');
            setElementText('chargeEndTime', chargePlan.timeRange?.end ?? '06:00');

            const chargeTimeDisplay = document.getElementById('chargeTimeDisplay');
            const chargeTimeDisabled = document.getElementById('chargeTimeDisabled');
            if (chargeTimeDisplay && chargeTimeDisabled) {
                chargeTimeDisplay.style.opacity = chargeTimeEnabled ? '1' : '0.4';
                chargeTimeDisabled.style.display = chargeTimeEnabled ? 'none' : 'inline';
            }

            const chargePriceEnabled = chargePlan.priceEnabled ?? true;
            setElementChecked('chargePriceEnabled', chargePriceEnabled);
            setElementChecked('chargePriceEnabledDisplay', chargePriceEnabled);
            setElementValue('chargePriceOperator', 'below');
            setElementText('chargePriceValue', chargePlan.priceThreshold ?? 50);

            const chargePriceDisplay = document.getElementById('chargePriceDisplay');
            const chargePriceDisabled = document.getElementById('chargePriceDisabled');
            if (chargePriceDisplay && chargePriceDisabled) {
                chargePriceDisplay.style.opacity = chargePriceEnabled ? '1' : '0.4';
                chargePriceDisabled.style.display = chargePriceEnabled ? 'none' : 'inline';
            }

            setElementValue('chargeSocOperator', 'equals');
            setElementValue('chargeSocValue', autoSettings.charge.stopSOC ?? 90);

            // --- ÊîæÁîµÊù°‰ª∂ ---
            const dischargeTimeEnabled = dischargePlan.enabled ?? true;
            setElementChecked('dischargeTimeEnabled', dischargeTimeEnabled);
            setElementChecked('dischargeTimeEnabledDisplay', dischargeTimeEnabled);
            setElementText('dischargeStartTime', dischargePlan.timeRange?.start ?? '16:00');
            setElementText('dischargeEndTime', dischargePlan.timeRange?.end ?? '21:00');

            const dischargeTimeDisplay = document.getElementById('dischargeTimeDisplay');
            const dischargeTimeDisabled = document.getElementById('dischargeTimeDisabled');
            if (dischargeTimeDisplay && dischargeTimeDisabled) {
                dischargeTimeDisplay.style.opacity = dischargeTimeEnabled ? '1' : '0.4';
                dischargeTimeDisabled.style.display = dischargeTimeEnabled ? 'none' : 'inline';
            }

            const dischargePriceEnabled = dischargePlan.priceEnabled ?? true;
            setElementChecked('dischargePriceEnabled', dischargePriceEnabled);
            setElementChecked('dischargePriceEnabledDisplay', dischargePriceEnabled);
            setElementValue('dischargePriceOperator', 'above');
            setElementText('dischargePriceValue', dischargePlan.priceThreshold ?? 100);

            const dischargePriceDisplay = document.getElementById('dischargePriceDisplay');
            const dischargePriceDisabled = document.getElementById('dischargePriceDisabled');
            if (dischargePriceDisplay && dischargePriceDisabled) {
                dischargePriceDisplay.style.opacity = dischargePriceEnabled ? '1' : '0.4';
                dischargePriceDisabled.style.display = dischargePriceEnabled ? 'none' : 'inline';
            }

            setElementValue('dischargeSocOperator', 'equals');
            setElementValue('dischargeSocValue', autoSettings.discharge.stopSOC ?? 20);
        }
        
        function updateConditionStatus(operationType, conditionType, enabled) {
            // ÈÄÇÈÖçÊñ∞ plans[] Ê†ºÂºèÔºöÊõ¥Êñ∞Á¨¨‰∏Ä‰∏™ËÆ°ÂàíÁöÑÂØπÂ∫îÂ≠óÊÆµ
            const plan = autoSettings[operationType]?.plans?.[0];
            if (plan) {
                if (conditionType === 'time') {
                    plan.enabled = enabled;
                } else {
                    plan.priceEnabled = enabled;
                }
            }

            // Update visual state of the condition controls
            const prefix = operationType === 'charge' ? 'charge' : 'discharge';

            if (conditionType === 'time') {
                const startTimeInput = document.getElementById(`${prefix}StartTime`);
                const endTimeInput = document.getElementById(`${prefix}EndTime`);
                if (startTimeInput) { startTimeInput.disabled = !enabled; startTimeInput.style.opacity = enabled ? '1' : '0.5'; }
                if (endTimeInput) { endTimeInput.disabled = !enabled; endTimeInput.style.opacity = enabled ? '1' : '0.5'; }
            } else {
                const operatorSelect = document.getElementById(`${prefix}PriceOperator`);
                const valueInput = document.getElementById(`${prefix}PriceValue`);
                if (operatorSelect) { operatorSelect.disabled = !enabled; operatorSelect.style.opacity = enabled ? '1' : '0.5'; }
                if (valueInput) { valueInput.disabled = !enabled; valueInput.style.opacity = enabled ? '1' : '0.5'; }
            }
        }
        
        function updateAutoSettings() {
            // ÈÄÇÈÖçÊñ∞ plans[] Ê†ºÂºèÔºöÂ∞Ü UI ÂÄºÂÜôÂõûÁ¨¨‰∏Ä‰∏™ËÆ°Âàí
            const chargePlan = autoSettings.charge.plans?.[0];
            const dischargePlan = autoSettings.discharge.plans?.[0];

            if (chargePlan) {
                const chargeStartTimeEl = document.getElementById('chargeStartTime');
                const chargeEndTimeEl = document.getElementById('chargeEndTime');
                const chargePriceValueEl = document.getElementById('chargePriceValue');
                const chargeSocValueEl = document.getElementById('chargeSocValue');

                if (!chargePlan.timeRange) chargePlan.timeRange = {};
                chargePlan.timeRange.start = chargeStartTimeEl ? chargeStartTimeEl.textContent : '22:00';
                chargePlan.timeRange.end = chargeEndTimeEl ? chargeEndTimeEl.textContent : '06:00';
                chargePlan.priceThreshold = parseFloat(chargePriceValueEl ? chargePriceValueEl.textContent : '50');
                autoSettings.charge.stopSOC = parseFloat(chargeSocValueEl ? chargeSocValueEl.value : 90);
            }

            if (dischargePlan) {
                const dischargeStartTimeEl = document.getElementById('dischargeStartTime');
                const dischargeEndTimeEl = document.getElementById('dischargeEndTime');
                const dischargePriceValueEl = document.getElementById('dischargePriceValue');
                const dischargeSocValueEl = document.getElementById('dischargeSocValue');

                if (!dischargePlan.timeRange) dischargePlan.timeRange = {};
                dischargePlan.timeRange.start = dischargeStartTimeEl ? dischargeStartTimeEl.textContent : '16:00';
                dischargePlan.timeRange.end = dischargeEndTimeEl ? dischargeEndTimeEl.textContent : '21:00';
                dischargePlan.priceThreshold = parseFloat(dischargePriceValueEl ? dischargePriceValueEl.textContent : '100');
                autoSettings.discharge.stopSOC = parseFloat(dischargeSocValueEl ? dischargeSocValueEl.value : 20);
            }

            // Restart auto check if in auto mode
            if (currentOperationMode === 'auto') {
                startAutoOperationCheck();
            }
        }
        
        // Performance utilities (inline to avoid CORS issues)
        function throttle(func, limit) {
            let inThrottle;
            let lastFunc;
            let lastRan;
            
            return function(...args) {
                if (!inThrottle) {
                    func.apply(this, args);
                    lastRan = Date.now();
                    inThrottle = true;
                } else {
                    clearTimeout(lastFunc);
                    lastFunc = setTimeout(() => {
                        if ((Date.now() - lastRan) >= limit) {
                            func.apply(this, args);
                            lastRan = Date.now();
                        }
                    }, Math.max(limit - (Date.now() - lastRan), 0));
                }
                
                setTimeout(() => {
                    inThrottle = false;
                }, limit);
            };
        }

        // Data cache class
        class DataCache {
            constructor(ttl = 5 * 60 * 1000, maxSize = 100) {
                this.cache = new Map();
                this.ttl = ttl;
                this.maxSize = maxSize;
            }
            
            set(key, data) {
                if (this.cache.size >= this.maxSize) {
                    const firstKey = this.cache.keys().next().value;
                    this.cache.delete(firstKey);
                }
                
                this.cache.set(key, {
                    data,
                    timestamp: Date.now()
                });
            }
            
            get(key) {
                const cached = this.cache.get(key);
                if (!cached) return null;
                
                if (Date.now() - cached.timestamp > this.ttl) {
                    this.cache.delete(key);
                    return null;
                }
                
                return cached.data;
            }
            
            clear() {
                this.cache.clear();
            }
        }

        // Chart manager class
        class ChartManager {
            constructor() {
                this.charts = new Map();
            }
            
            register(name, chart) {
                if (this.charts.has(name)) {
                    this.dispose(name);
                }
                this.charts.set(name, chart);
            }
            
            dispose(name) {
                const chart = this.charts.get(name);
                if (chart && typeof chart.dispose === 'function') {
                    chart.dispose();
                }
                this.charts.delete(name);
            }
        }
        
        // Create instances
        const dataCache = new DataCache();
        const chartManager = new ChartManager();
        
        // Initialize additional variables 
        let currentRegion = 'NSW';
        let selectedMainRegion = 'NSW'; // Êñ∞Â¢ûÔºö‰∏ªÂú∞Âå∫ÈÄâÊã©
        
        // Êó∂Èó¥Êù°‰ª∂ÊÆµÂÖ®Â±ÄÂèòÈáè
        let timeConditionSegments = {
            charge: [], // ÂÖÖÁîµÊó∂Èó¥ÊÆµ
            discharge: [] // ÊîæÁîµÊó∂Èó¥ÊÆµ
        };
        let regionConditions = {}; // Â≠òÂÇ®ÂêÑÂú∞Âå∫ÁöÑÊù°‰ª∂ËÆæÁΩÆ
        
        // ÂÖ®Â±ÄÂú∞Âå∫Êï∞ÊçÆÂØπË±°

        // ÁîüÊàêÈöèÊú∫ËÆæÂ§áÁªüËÆ°Êï∞ÊçÆÁöÑËæÖÂä©ÂáΩÊï∞ÔºàÈªòËÆ§ÈÖçÁΩÆÔºöÊúâÂ§±Ë¥•ËÆæÂ§áÔºâ
        function generateRandomDeviceStats() {
            const totalDevices = 500;
            const successCount = 450; // Âõ∫ÂÆö‰∏ãÂèëÊàêÂäü450‰∏™
            const executingCount = 0; // ÊâßË°å‰∏≠‰∏∫0
            const failedCount = 50; // Âõ∫ÂÆö‰∏ãÂèëÂ§±Ë¥•50‰∏™

            const stats = {
                total: totalDevices,
                success: successCount,
                executing: executingCount,
                failed: failedCount
            };

            return stats;
        }

        // ÁîüÊàêÁ≠âÂæÖÊâßË°å‰∏≠Áä∂ÊÄÅÁöÑËÆæÂ§áÁªüËÆ°ÔºàËøòÊú™‰∏ãÂèëÊåá‰ª§Ôºâ
        function generateWaitingDeviceStats() {
            const stats = {
                total: 500,
                success: 0, // Á≠âÂæÖÊâßË°å‰∏≠ÔºåËøòÊú™‰∏ãÂèëÔºåÊàêÂäüÊï∞‰∏∫0
                executing: 0, // ÊâßË°å‰∏≠‰∏∫0
                failed: 0 // Â§±Ë¥•Êï∞‰∏∫0
            };

            return stats;
        }

        // ÂàùÂßãÂåñÂú∞Âå∫Êï∞ÊçÆ

        // ÊµãËØïÂáΩÊï∞ÊòØÂê¶ÂèØÁî®
        try {
            const testWaiting = generateWaitingDeviceStats();
        } catch(e) {
            console.error('‚ùå generateWaitingDeviceStats error:', e);
        }

        try {
            const testRandom = generateRandomDeviceStats();
        } catch(e) {
            console.error('‚ùå generateRandomDeviceStats error:', e);
        }

        let regionData = {
            'NSW': {
                status: 'waitingExecution',
                deviceStats: generateWaitingDeviceStats() || { total: 500, success: 0, executing: 0, failed: 0 }
            },
            'QLD': {
                status: 'autoCharge',
                deviceStats: generateRandomDeviceStats() || { total: 500, success: 450, executing: 0, failed: 50 }
            },
            'VIC': {
                status: 'manualCharge',
                deviceStats: generateRandomDeviceStats() || { total: 500, success: 450, executing: 0, failed: 50 }
            },
            'SA': {
                status: 'autoDischarge',
                deviceStats: generateRandomDeviceStats() || { total: 500, success: 450, executing: 0, failed: 50 }
            },
            'TAS': {
                status: 'manualDischarge',
                deviceStats: generateRandomDeviceStats() || { total: 500, success: 450, executing: 0, failed: 50 }
            }
        };
        let chartType = 'both';
        let autoSwitchInterval;
        let mapAnimationInterval;
        let deviceLocations = []; // Fixed device locations


        // Initialize HeaderNav immediately when scripts are loaded
        function initHeaderNav() {
            
            if (typeof HeaderNav === 'undefined') {
                console.error('HeaderNav class not found!');
                return false;
            }
            
            try {
                const headerNav = new HeaderNav({
                    currentPage: 'home',
                    containerId: 'headerContainer',
                    showLanguageSelector: true
                });
                return true;
            } catch (error) {
                console.error('HeaderNav initialization failed:', error);
                return false;
            }
        }

        // Try to initialize HeaderNav immediately
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initHeaderNav);
        } else {
            initHeaderNav();
        }

        // Initialize all charts when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {

            // ========== Âº∫Âà∂‰øÆÂ§ç regionData ==========

            // Ê£ÄÊü•Âπ∂‰øÆÂ§çÊØè‰∏™Âú∞Âå∫ÁöÑ deviceStats
            const regions = ['NSW', 'QLD', 'VIC', 'SA', 'TAS'];
            regions.forEach(region => {
                if (!regionData[region]) {
                    regionData[region] = { status: 'none' };
                }
                if (!regionData[region].deviceStats) {
                    // deviceStats auto-created for ${region}
                    if (region === 'NSW') {
                        regionData[region].deviceStats = { total: 500, success: 0, executing: 0, failed: 0 };
                    } else {
                        regionData[region].deviceStats = { total: 500, success: 450, executing: 0, failed: 50 };
                    }
                }
            });


            // ÂêåÊ≠•UIÁä∂ÊÄÅ
            const autoToggleKnob = document.getElementById('autoToggleKnob');
            const toggleSwitch = document.querySelector('.auto-toggle-switch');
            const chargeBtn = document.getElementById('chargeBtn');
            const dischargeBtn = document.getElementById('dischargeBtn');
            
            if (currentOperationMode === 'manual') {
                // ÊâãÂä®Ê®°ÂºèUIÁä∂ÊÄÅ
                if (autoToggleKnob && toggleSwitch) {
                    autoToggleKnob.style.left = '2px';
                    autoToggleKnob.style.right = 'auto';
                    toggleSwitch.style.background = 'rgba(255,255,255,0.1)';
                }
                
                // ÂêØÁî®ÂÖÖÊîæÁîµÊåâÈíÆ
                if (chargeBtn && dischargeBtn) {
                    chargeBtn.disabled = false;
                    dischargeBtn.disabled = false;
                    chargeBtn.style.opacity = '1';
                    dischargeBtn.style.opacity = '1';
                    chargeBtn.style.cursor = 'pointer';
                    dischargeBtn.style.cursor = 'pointer';
                }
            } else {
                // Ëá™Âä®Ê®°ÂºèUIÁä∂ÊÄÅ
                if (autoToggleKnob && toggleSwitch) {
                    autoToggleKnob.style.left = '18px';
                    autoToggleKnob.style.right = 'auto';
                    toggleSwitch.style.background = '#4CD964';
                }
                
                // ÈöêËóèÂÖÖÊîæÁîµÊåâÈíÆ
                if (chargeBtn && dischargeBtn) {
                    chargeBtn.style.display = 'none';
                    dischargeBtn.style.display = 'none';
                }
            }
            
            // Use setTimeout to ensure all dependencies are loaded
            setTimeout(() => {
                try {
                    // Make sure HeaderNav is initialized
                    if (!window.headerNav) {
                        initHeaderNav();
                    }
                    
                    // Initialize price circle color and water wave effect
                    updatePriceCircleColor();
                    
                    // ËÆæÁΩÆÂÆöÊó∂Êõ¥Êñ∞Ê∞¥Ê≥¢ÊïàÊûúÔºàÊØè10ÁßíÊõ¥Êñ∞‰∏ÄÊ¨°Ôºâ
                    setInterval(() => {
                        updateWaterWaveLevel();
                    }, 10000);
                    
                    // Initialize auto conditions display (always shown)
                    updateAutoConditionsDisplay();
                    
                    // Initialize SOC sliders
                    initSOCSliders();
                    
                    // Initialize operation mode (default to auto)
                    switchOperationMode(currentOperationMode);
                    // HeaderNav initialized successfully
                    
                    // ÂêØÂä®z-indexÁõëÊéßÂô®
                    startDrawerZIndexMonitor();
                    
                    // Initialize i18n system if not already initialized by HeaderNav
                    if (!window.i18n && typeof I18n !== 'undefined') {
                        // Á°Æ‰øùÈªòËÆ§‰ΩøÁî®‰∏≠ÊñáÔºåÊ∏ÖÈô§ÂèØËÉΩÂ≠òÂú®ÁöÑËã±ÊñáËÆæÁΩÆ
                        try {
                            const storedLang = localStorage.getItem('app_language');
                            if (storedLang === 'en') {
                                localStorage.removeItem('app_language');
                            }
                        } catch (e) {
                            // warn('Failed to check/clear language setting:', e);
                        }

                        window.i18n = new I18n({
                            defaultLanguage: 'zh',
                            containerId: 'headerLanguageSelector'
                        });
                    }
                    
                    // Ensure simulation buttons are translated after i18n is ready
                    setTimeout(() => {
                        if (window.i18n && window.i18n.isReady) {
                            window.i18n.updatePageTexts();
                            updateSimulationButtonsText();
                            // ÂÜçÊ¨°Âº∫Âà∂Êõ¥Êñ∞
                            setTimeout(() => {
                                updateSimulationButtonsText();
                            }, 100);
                        }
                    }, 2000);
                    
                    // Listen for language change events to update simulation buttons
                    document.addEventListener('languageChanged', function(event) {
                        // Á´ãÂç≥Êõ¥Êñ∞
                        updateSimulationButtonsText();
                        // Â§öÊ¨°Âª∂ËøüÊõ¥Êñ∞‰ª•Á°Æ‰øùÁîüÊïà
                        setTimeout(() => {
                            updateSimulationButtonsText();
                        }, 50);
                        setTimeout(() => {
                            updateSimulationButtonsText();
                        }, 200);
                        setTimeout(() => {
                            updateSimulationButtonsText();
                        }, 500);
                    });
                    
                    // Function to specifically update simulation buttons text
                    function updateSimulationButtonsText() {
                        
                        if (!window.i18n) {
                            return;
                        }
                        
                        const currentLang = window.i18n.getCurrentLanguage();
                        
                        // Âº∫Âà∂ÁøªËØëÊØè‰∏™ÊåâÈíÆ
                        const forcedButtonUpdates = [
                            {
                                selector: '[data-i18n="settings"]',
                                chinese: 'ËÆæÁΩÆ',
                                english: 'Settings'
                            }
                        ];
                        
                        forcedButtonUpdates.forEach(update => {
                            const elements = document.querySelectorAll(update.selector);
                            elements.forEach(element => {
                                if (element) {
                                    const oldText = element.textContent;
                                    const newText = currentLang === 'en' ? update.english : update.chinese;
                                    element.textContent = newText;
                                }
                            });
                        });
                    }
                    
                    // Á°Æ‰øùÂáΩÊï∞ÂÖ®Â±ÄÂèØÁî®‰∫éË∞ÉËØï
                    window.forceUpdateSimulationButtons = updateSimulationButtonsText;
                    
                    // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÁ´ãÂç≥Êõ¥Êñ∞‰∏ÄÊ¨°
                    setTimeout(() => {
                        updateSimulationButtonsText();
                    }, 3000);
                    
                    // Initialize auto settings event listeners
                    const autoBatteryOperator = document.getElementById('autoBatteryOperator');
                    if (autoBatteryOperator) {
                        autoBatteryOperator.addEventListener('change', updateBatteryRangeVisibility);
                    }
                    
                    // Add language change listener for dynamic content
                    if (window.i18n) {
                        window.i18n.addObserver((newLanguage, oldLanguage) => {
                            updateDynamicContent(newLanguage);
                            
                            // Update region status badges
                            updateRegionStatusDisplay();
                            
                            // Refresh all charts with new language
                            if (marketChart) {
                                updateMarketChart();
                            }
                            if (powerChart && powerChartTimeSelector) {
                                const currentPeriod = powerChartTimeSelector.getCurrentPeriod();
                                const { labels, power, revenue } = generateAnalyticsData(currentPeriod);
                                updatePowerChartWithData(labels, power, revenue, currentPeriod);
                            }
                            if (mapChart) {
                                updateMapStatistics();
                            }

                            // Refresh condition regions if visible
                            if (currentConditionView !== 'default') {
                                const type = currentConditionView;
                                createConditionRegions(type);
                            }
                            
                            // Update default region display
                            updateRegionDisplay();
                            
                            // Update region status display with new language
                            updateRegionStatusDisplay();
                            
                            // ËØ≠Ë®ÄÂàáÊç¢ÂêéÈáçÊñ∞Ë∞ÉÊï¥Èó¥Ë∑ù
                            setTimeout(() => {
                                adjustSpacingForRegionSelector();
                            }, 300);
                            
                            // Êõ¥Êñ∞Â§ßÂúÜ‰∏≠ÁöÑÁä∂ÊÄÅÊ†áÁ≠æ
                            const currentRegionStatus = regionData[selectedMainRegion] ? regionData[selectedMainRegion].status : 'none';
                            updateStationStatusLabel(currentRegionStatus);
                        });
                    }
                } catch (error) {
                    console.error('HeaderNav failed to initialize:', error);
                }
            }, 10);
            
            // Add keyboard and click listeners for modal
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    const confirmModal = document.getElementById('confirmationModal');
                    if (confirmModal && confirmModal.style.display === 'block') {
                        closeConfirmationModal();
                    }
                }
                
                // Ê∑ªÂä†Âº∫Âà∂Âà∑Êñ∞Âø´Êç∑ÈîÆ Ctrl+Shift+R
                if (event.ctrlKey && event.shiftKey && event.key === 'R') {
                    event.preventDefault();
                    window.location.reload(true);
                }
                
                // Ê∑ªÂä†F5Âº∫Âà∂Âà∑Êñ∞
                if (event.key === 'F5') {
                    event.preventDefault();
                    window.location.reload(true);
                }
            });
            
            // Add click outside to close functionality
            const confirmationModal = document.getElementById('confirmationModal');
            if (confirmationModal) {
                confirmationModal.addEventListener('click', function(event) {
                    if (event.target === confirmationModal) {
                        closeConfirmationModal();
                    }
                });
            }

            // ========== ÂÜçÊ¨°Á°ÆËÆ§Âπ∂Âº∫Âà∂Êõ¥Êñ∞ NSW ÊòæÁ§∫ ==========
            if (regionData['NSW'] && regionData['NSW'].deviceStats) {
                const stats = regionData['NSW'].deviceStats;
                if (document.getElementById('totalDevices')) {
                    document.getElementById('totalDevices').textContent = stats.total;
                    document.getElementById('successfulDevices').textContent = stats.success;
                    document.getElementById('executingDevices').textContent = stats.executing;
                    document.getElementById('failedDevices').textContent = stats.failed;
                }
            } else {
                // error('‚ùå NSW deviceStats still missing after fix!');
            }

            try {
                // Generate fixed device locations once (exactly 500 devices)
                deviceLocations = generateDeviceLocations();

                // Ë∞ÉËØïÔºöÊ£ÄÊü•NSWËÆæÂ§áÁä∂ÊÄÅ
                const nswDevices = deviceLocations.filter(d => d.region === 'NSW');
                const nswStatusCounts = {
                    hidden: nswDevices.filter(d => d.status === 'hidden').length,
                    charging: nswDevices.filter(d => d.status === 'charging').length,
                    discharging: nswDevices.filter(d => d.status === 'discharging').length,
                    inactive: nswDevices.filter(d => d.status === 'inactive').length,
                    offline: nswDevices.filter(d => d.status === 'offline').length
                };

                // Á´ãÂç≥ÊòæÁ§∫NSWÂú∞Âå∫ÁöÑËÆæÂ§áÁªüËÆ°Êï∞ÊçÆÔºàÂú®‰ªª‰ΩïÂÖ∂‰ªñÊìç‰Ωú‰πãÂâçÔºâ
                const nswStats = regionData['NSW'].deviceStats;
                if (document.getElementById('totalDevices')) {
                    document.getElementById('totalDevices').textContent = nswStats.total;
                    document.getElementById('successfulDevices').textContent = nswStats.success;
                    document.getElementById('executingDevices').textContent = nswStats.executing;
                    document.getElementById('failedDevices').textContent = nswStats.failed;
                }

                // Á´ãÂç≥ÂàùÂßãÂåñÊäΩÂ±âÁöÑËÆæÂ§áÊï∞ÊçÆÔºåÁ°Æ‰øùÁÇπÂáªÊó∂ÊúâÊï∞ÊçÆÂèØÊòæÁ§∫
                updateDeviceStatusCounts(nswStats.success, nswStats.executing, nswStats.failed, nswStats);

                // ÂàùÂßãÂåñÂú∞Âå∫Áä∂ÊÄÅÊåáÁ§∫Âô®
                updateRegionStatusIndicators();

                // ËÆæÁΩÆÈªòËÆ§ÈÄâ‰∏≠NSWÂú∞Âå∫
                const defaultRegion = document.querySelector('.region-select-tab[data-region="NSW"]');
                if (defaultRegion) {
                    selectMainRegion('NSW', defaultRegion);
                }

                // Âº∫Âà∂Á´ãÂç≥ÊòæÁ§∫NSWÂú∞Âå∫ÁöÑËÆæÂ§áÁªüËÆ°Êï∞ÊçÆÔºàÁ°Æ‰øùÈ°µÈù¢Âä†ËΩΩÊó∂Â∞±ËÉΩÁúãÂà∞Ôºâ
                setTimeout(() => {
                    updateRegionDeviceStats('NSW');

                    const nswStatusBadge = document.querySelector('[data-region="NSW"] .region-status-badge');
                    if (nswStatusBadge) {
                        nswStatusBadge.setAttribute('data-status', 'waitingExecution');
                        nswStatusBadge.textContent = window.i18n ? window.i18n.getText('waitingExecution') : 'Á≠âÂæÖÊâßË°å‰∏≠';
                        nswStatusBadge.style.background = 'rgba(30, 127, 255, 0.2)';
                        nswStatusBadge.style.color = '#1E7FFF';
                        nswStatusBadge.style.border = '1px dashed #1E7FFF';
                        nswStatusBadge.style.display = 'inline-block';
                        nswStatusBadge.style.padding = '6px 12px';
                        nswStatusBadge.style.borderRadius = '12px';
                        nswStatusBadge.style.fontSize = '11px';
                        nswStatusBadge.style.fontWeight = '600';
                    }
                }, 100);
                
                // ÂÆöÊúüÊõ¥Êñ∞Âú∞Âå∫Áä∂ÊÄÅÔºàÊ®°ÊãüÂÆûÊó∂Êï∞ÊçÆÔºâ
                setInterval(updateRegionStatusIndicators, 30000); // ÊØè30ÁßíÊõ¥Êñ∞‰∏ÄÊ¨°

                // ËÆæÂ§áÁªüËÆ°Êï∞ÊçÆÁî± selectMainRegion -> updateRegionDeviceStats Ëá™Âä®Êõ¥Êñ∞
                // È¢ùÂ§ñ‰øùÈô©ÔºöÂª∂Ëøü300msÂÜçÂº∫Âà∂Êõ¥Êñ∞‰∏ÄÊ¨°ÔºåÁ°Æ‰øùÈ°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÊï∞ÊçÆ‰∏ÄÂÆöÊòæÁ§∫
                setTimeout(() => {
                    updateRegionDeviceStats('NSW');
                }, 300);

                
                // Check if chart containers exist
                const containers = ['powerRevenueChart', 'systemPerformance', 'marketChart', 'australiaMap'];
                containers.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                    }
                });
                
                
                try {
                    initPowerRevenueChart();
                } catch (e) {
                    // error('Failed to initialize power chart:', e);
                }
                
                try {
                    initSystemPerformanceChart();
                } catch (e) {
                    // error('Failed to initialize performance chart:', e);
                }
                
                try {
                    initMarketChart();
                } catch (e) {
                    // error('Failed to initialize market chart:', e);
                }
                
                try {
                    initMap();
                } catch (e) {
                    // error('Failed to initialize map:', e);
                }
                
                
                // Verify chart objects created
                setTimeout(() => {
                    
                    // Force resize all charts after initialization
                    if (marketChart) {
                        if (marketChart && typeof marketChart.resize === 'function') {
                            if (marketChart && typeof marketChart.resize === 'function') {
                        marketChart.resize();
                    }
                        }
                    }
                    if (mapChart) {
                        if (mapChart && typeof mapChart.resize === 'function') {
                            mapChart.resize();
                        }
                    }
                    if (powerChart) {
                        if (powerChart && typeof powerChart.resize === 'function') {
                            powerChart.resize();
                        }
                    }
                    if (performanceChart) {
                        if (performanceChart && typeof performanceChart.resize === 'function') {
                            performanceChart.resize();
                        }
                    }
                }, 300);
                
                // Initialize time selector after charts are ready
                setTimeout(() => {
                    try {
                        initPowerChartTimeSelector();
                    } catch (error) {
                        // error('TimeSelector initialization failed:', error);
                    }
                }, 100);
                
                // Initialize with NSW region
                updatePriceCircleRegion('NSW');

                // Force apply button styles
                forceButtonStyles();
                // Apply styles periodically to ensure they stick  
                setInterval(forceButtonStyles, 3000);
                
                // Add device response modal click handlers
                setTimeout(() => {
                    const statusSummary = document.querySelector('.status-summary');
                    if (statusSummary) {
                        statusSummary.style.cursor = 'pointer';
                        statusSummary.addEventListener('click', showDeviceResponseModal);
                    }
                    
                    // Also check for any analytics cards with device response text
                    const allCards = document.querySelectorAll('.card, .metric-card, .stat-card');
                    allCards.forEach(card => {
                        const text = card.textContent;
                        if (text && (text.includes('ËÆæÂ§áÂìçÂ∫î') || text.includes('Device Response'))) {
                            card.style.cursor = 'pointer';
                            card.addEventListener('click', showDeviceResponseModal);
                        }
                    });
                }, 1000);
                
                // Initialize highest price region display
                // updateHighestPriceRegion(); // Removed - using fixed text now
                
                // Initialize other station data
                const availableHomesEl = document.getElementById('availableHomes');
                const availablePowerEl = document.getElementById('availablePower');
                const estimatedProfitEl = document.getElementById('estimatedProfit');
                
                if (availableHomesEl) availableHomesEl.textContent = '235';
                if (availablePowerEl) availablePowerEl.textContent = '23547kWh';
                if (estimatedProfitEl) estimatedProfitEl.textContent = '$12435';

                // Start real-time updates (ÊØè5ÁßíÊõ¥Êñ∞‰∏ÄÊ¨°)
                // Ê≥®ÊÑèÔºöÈ¶ñÊ¨°Êõ¥Êñ∞‰ºöÂú® initMarketChart() ÂÆåÊàêAEMOÊï∞ÊçÆÂä†ËΩΩÂêéËá™Âä®ÊâßË°å
                setInterval(updateRealtimeData, 5000);
            } catch (error) {
                // error('Chart initialization failed:', error);
            }
            
            // Start auto switch if enabled
            const autoSwitchElement = document.getElementById('autoSwitch');
            if (autoSwitchElement && autoSwitchElement.checked) {
                startAutoSwitch();
            }
            
            // Add i18n observer to update charts when language changes
            if (window.i18n) {
                window.i18n.addObserver((newLanguage, oldLanguage) => {
                    // Update power chart
                    if (powerChart) {
                        const dischargeLabel = window.i18n.getText('discharge');
                        const revenueLabel = window.i18n.getText('totalRevenue');
                        powerChart.setOption({
                            legend: {
                                data: [dischargeLabel, revenueLabel]
                            },
                            yAxis: [
                                {
                                    name: newLanguage === 'en' ? 'Power (kWh)' : 'kWh'
                                },
                                {
                                    name: newLanguage === 'en' ? 'Revenue ($)' : '$'
                                }
                            ],
                            series: [
                                {
                                    name: dischargeLabel
                                },
                                {
                                    name: revenueLabel
                                }
                            ]
                        });
                    }
                    
                    // Update market chart
                    if (marketChart) {
                        marketChart.setOption({
                            legend: {
                                data: [
                                    window.i18n.getText('historicalPrice'),
                                    window.i18n.getText('demand'),
                                    window.i18n.getText('predictedPrice'),
                                    window.i18n.getText('predictedDemand')
                                ]
                            },
                            yAxis: [
                                {
                                    name: window.i18n.getText('price')
                                },
                                {
                                    name: window.i18n.getText('demand')
                                }
                            ],
                            series: [
                                {
                                    name: window.i18n.getText('historicalPrice')
                                },
                                {
                                    name: window.i18n.getText('demand')
                                },
                                {
                                    name: window.i18n.getText('predictedPrice')
                                },
                                {
                                    name: window.i18n.getText('predictedDemand')
                                }
                            ]
                        });
                    }
                    
                    // Re-init system performance chart to update series names
                    if (document.getElementById('systemPerformance')) {
                        initSystemPerformanceChart();
                    }
                    
                    // Update time selector labels for charts
                    const currentPeriod = powerChartTimeSelector ? powerChartTimeSelector.getCurrentPeriod() : 'month';
                    const { labels, power, revenue } = generateAnalyticsData(currentPeriod);
                    updatePowerChartWithData(labels, power, revenue, currentPeriod);
                });
            }
        });
        
        // ÊòæÁ§∫Âº∫Âà∂Âà∑Êñ∞ÈÄöÁü•
        function showRefreshNotification() {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #00ff88, #00aaff);
                color: #000;
                padding: 20px 40px;
                border-radius: 10px;
                font-size: 18px;
                font-weight: 600;
                z-index: 999999;
                box-shadow: 0 8px 32px rgba(0, 255, 136, 0.5);
                animation: pulse 0.5s ease-in-out;
            `;
            notification.textContent = window.i18n ? window.i18n.getText('forceRefreshing') : 'Ê≠£Âú®Âº∫Âà∂Âà∑Êñ∞È°µÈù¢...';
            document.body.appendChild(notification);
        }

        // System Performance Chart (Simplified Overview)
        function initSystemPerformanceChart() {
            performanceChart = echarts.init(document.getElementById('systemPerformance'));
            
            const hours = [];
            const efficiency = [];
            const availability = [];
            
            // Generate last 12 hours of system performance data
            for (let i = 11; i >= 0; i--) {
                const time = new Date();
                time.setHours(time.getHours() - i);
                hours.push(`${time.getHours()}:00`);
                
                // Generate realistic performance metrics
                efficiency.push(93.8 + Math.random() * 6.2); // 93.8-100% efficiency
                availability.push(95 + Math.random() * 5); // 95-100% availability
            }

            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    borderColor: 'rgba(255, 255, 255, 0.2)',
                    textStyle: { color: '#fff' },
                    formatter: function(params) {
                        let result = params[0].name + '<br/>';
                        params.forEach(function(item) {
                            result += item.marker + ' ' + item.seriesName + ': ' + item.value.toFixed(1) + '%<br/>';
                        });
                        return result;
                    }
                },
                grid: {
                    left: '5%',
                    right: '5%',
                    bottom: '15%',
                    top: '10%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: hours,
                    axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.2)' } },
                    axisLabel: { color: 'rgba(255, 255, 255, 0.6)', fontSize: 10 }
                },
                yAxis: {
                    type: 'value',
                    min: 85,
                    max: 100,
                    axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.2)' } },
                    axisLabel: { color: 'rgba(255, 255, 255, 0.6)', fontSize: 10 },
                    splitLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.05)' } }
                },
                series: [
                    {
                        name: window.i18n ? window.i18n.getText('executionEfficiency') : 'ÊâßË°åÊïàÁéá',
                        type: 'line',
                        data: efficiency,
                        smooth: true,
                        lineStyle: { color: '#00ff88', width: 2 },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(0, 255, 136, 0.2)' },
                                { offset: 1, color: 'rgba(0, 255, 136, 0.05)' }
                            ])
                        },
                        symbol: 'none'
                    },
                    {
                        name: window.i18n ? window.i18n.getText('systemAvailability') : 'Á≥ªÁªüÂèØÁî®ÊÄß',
                        type: 'line',
                        data: availability,
                        smooth: true,
                        lineStyle: { color: '#00aaff', width: 2 },
                        symbol: 'none'
                    }
                ]
            };

            performanceChart.setOption(option);
            window.addEventListener('resize', throttle(() => {
                if (performanceChart && typeof performanceChart.resize === 'function') {
                    performanceChart.resize();
                }
            }, 250));
        }

        // Discharge & Profit chart
        // powerRevenueChart is already declared globally above
        function initPowerRevenueChart() {
            powerRevenueChart = echarts.init(document.getElementById('powerRevenueChart'));

            // Generate realistic Australian household energy data for 24 hours (48 data points, 30-min intervals)
            // Adjusted based on current Australian season
            function generateRealisticEnergyData() {
                const inputData = [];  // Grid purchase (kW)
                const outputData = []; // Solar + Battery feed-in (kW)
                const profitData = [];  // Profit ($)

                // Grid purchase rate: ~$0.30/kWh, Feed-in rate: ~$0.08/kWh (Australian typical rates)
                const gridRate = 0.30;
                const feedInRate = 0.08;

                // Get current month (1-12) to determine season
                const currentMonth = new Date().getMonth() + 1;
                const isSummer = currentMonth === 12 || currentMonth === 1 || currentMonth === 2; // Dec-Feb
                const isWinter = currentMonth === 6 || currentMonth === 7 || currentMonth === 8; // Jun-Aug

                // Seasonal multipliers for solar generation and grid purchase
                const solarMultiplier = isSummer ? 1.3 : isWinter ? 0.6 : 1.0;
                const gridMultiplier = isSummer ? 0.7 : isWinter ? 1.4 : 1.0;

                for (let i = 0; i < 48; i++) {
                    const hour = Math.floor(i / 2);
                    const minute = (i % 2) * 30;

                    let gridPurchase = 0;  // From grid
                    let feedIn = 0;        // To grid

                    // Night period (0:00-6:00): Low grid purchase, minimal feed-in
                    if (hour >= 0 && hour < 6) {
                        gridPurchase = (0.3 + Math.random() * 0.4) * gridMultiplier;
                        feedIn = Math.random() * 0.1;
                    }
                    // Morning peak (6:00-9:00): Increasing grid purchase, solar starts
                    else if (hour >= 6 && hour < 9) {
                        gridPurchase = (1.5 + (hour - 6) * 0.8 + Math.random() * 0.5) * gridMultiplier;
                        feedIn = Math.max(0, (hour - 6) * 0.8 + Math.random() * 0.5) * solarMultiplier;
                    }
                    // Mid-morning to afternoon (9:00-17:00): Solar peak, low grid purchase
                    else if (hour >= 9 && hour < 17) {
                        gridPurchase = (0.2 + Math.random() * 0.3) * gridMultiplier;

                        // Solar peak around midday (12:00-15:00)
                        if (hour >= 12 && hour < 15) {
                            feedIn = (4.5 + Math.random() * 1.5) * solarMultiplier;
                        } else if (hour >= 10 && hour < 12) {
                            feedIn = (3.0 + Math.random() * 1.0) * solarMultiplier;
                        } else if (hour >= 15 && hour < 17) {
                            feedIn = (2.5 + Math.random() * 1.0) * solarMultiplier;
                        } else {
                            feedIn = (2.0 + Math.random() * 0.8) * solarMultiplier;
                        }
                    }
                    // Evening peak (17:00-22:00): High grid purchase, declining solar
                    else if (hour >= 17 && hour < 22) {
                        gridPurchase = (2.5 + (hour - 17) * 0.3 + Math.random() * 0.8) * gridMultiplier;

                        // Solar declining, some battery discharge
                        if (hour < 19) {
                            feedIn = Math.max(0, (1.5 - (hour - 17) * 0.5 + Math.random() * 0.3) * solarMultiplier);
                        } else {
                            feedIn = Math.random() * 0.3;
                        }
                    }
                    // Late night (22:00-24:00): Decreasing grid purchase
                    else {
                        gridPurchase = (1.2 - (hour - 22) * 0.4 + Math.random() * 0.3) * gridMultiplier;
                        feedIn = Math.random() * 0.1;
                    }

                    // Calculate profit: feed-in revenue only
                    // Convert kW to kWh for 30-min interval (kW * 0.5h)
                    const profit = feedIn * 0.5 * feedInRate;

                    inputData.push(parseFloat(gridPurchase.toFixed(2)));
                    outputData.push(parseFloat(feedIn.toFixed(2)));
                    profitData.push(parseFloat(profit.toFixed(2)));
                }

                return { inputData, outputData, profitData };
            }

            const { inputData, outputData, profitData } = generateRealisticEnergyData();

            const options = {
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(0,0,0,0.9)',
                    borderColor: 'rgba(255,255,255,0.1)',
                    textStyle: { color: '#fff' },
                    axisPointer: {
                        type: 'cross',
                        crossStyle: {
                            color: 'var(--color-text-secondary)'
                        }
                    }
                },
                legend: {
                    data: [
                        window.i18n ? window.i18n.getText('input') : 'Input',
                        window.i18n ? window.i18n.getText('output') : 'Output',
                        window.i18n ? window.i18n.getText('profit') : 'Ëé∑Âà©'
                    ],
                    textStyle: { color: 'rgba(255, 255, 255, 0.7)' },
                    top: 0
                },
                grid: {
                    left: '3%',
                    right: '3%',
                    bottom: '3%',
                    top: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: Array.from({length: 48}, (_, i) => {
                        const hour = Math.floor(i / 2);
                        const minute = (i % 2) * 30;
                        return `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                    }),
                    axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.2)' } },
                    axisLabel: {
                        color: 'rgba(255, 255, 255, 0.6)',
                        interval: 5  // Show every 6th label to avoid crowding
                    }
                },
                yAxis: [{
                    type: 'value',
                    name: 'kW',
                    nameTextStyle: { color: 'rgba(255, 255, 255, 0.6)' },
                    min: 0,
                    max: 8,
                    interval: 1,
                    axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.2)' } },
                    axisLabel: {
                        color: 'rgba(255, 255, 255, 0.6)',
                        formatter: '{value}'
                    },
                    splitLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.1)' } }
                }, {
                    type: 'value',
                    name: window.i18n ? window.i18n.getText('profit') : 'Ëé∑Âà©',
                    nameTextStyle: { color: 'rgba(255, 255, 255, 0.6)' },
                    min: 0,
                    max: 0.3,
                    interval: 0.05,
                    axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.2)' } },
                    axisLabel: {
                        color: 'rgba(255, 255, 255, 0.6)',
                        formatter: '${value}'
                    },
                    splitLine: { show: false }
                }],
                series: [{
                    name: window.i18n ? window.i18n.getText('input') : 'Input',
                    type: 'line',
                    data: inputData,
                    lineStyle: {
                        width: 3,
                        color: '#00ff88'
                    },
                    itemStyle: { color: '#00ff88' },
                    symbol: 'circle',
                    symbolSize: 6,
                    smooth: true
                }, {
                    name: window.i18n ? window.i18n.getText('output') : 'Output',
                    type: 'line',
                    data: outputData,
                    lineStyle: {
                        width: 3,
                        color: '#ffd700'
                    },
                    itemStyle: { color: '#ffd700' },
                    symbol: 'circle',
                    symbolSize: 6,
                    smooth: true
                }, {
                    name: window.i18n ? window.i18n.getText('profit') : 'Ëé∑Âà©',
                    type: 'bar',
                    yAxisIndex: 1,
                    data: profitData,
                    itemStyle: {
                        color: '#1E7FFF',
                        opacity: 0.8
                    },
                    barWidth: '30%'
                }]
            };
            
            powerRevenueChart.setOption(options);
            window.addEventListener('resize', throttle(() => {
                if (powerRevenueChart && typeof powerRevenueChart.resize === 'function') {
                    powerRevenueChart.resize();
                }
            }, 250));
        }


        // Âú∞Âå∫Êìç‰ΩúÁä∂ÊÄÅÂ≠òÂÇ®
        const regionOperationStatus = {
            'NSW': 'none',  // ‰øÆÊîπ‰∏∫noneÔºåÁî±regionDataÊéßÂà∂Áä∂ÊÄÅ
            'QLD': 'discharging',
            'VIC': 'charging',
            'SA': 'discharging',
            'TAS': 'discharging'
        };
        
        // Ëé∑ÂèñÂú∞Âå∫Êìç‰ΩúÁä∂ÊÄÅ
        function getRegionOperationStatus(region) {
            return regionOperationStatus[region] || 'none';
        }
        
        // Êõ¥Êñ∞Âú∞Âå∫Êìç‰ΩúÁä∂ÊÄÅ
        function updateRegionOperationStatus(region, status) {
            regionOperationStatus[region] = status;
        }

        // Êõ¥Êñ∞Âú∞Âå∫ÊåâÈíÆÁä∂ÊÄÅÊåáÁ§∫Âô®
        function updateRegionStatusIndicators() {
            document.querySelectorAll('.region-select-tab').forEach(tab => {
                const region = tab.getAttribute('data-region');
                const status = getRegionOperationStatus(region);
                let statusElement = tab.querySelector('.region-status');
                
                // ÂÖàÁßªÈô§ÊâÄÊúâÂèØËÉΩÁöÑÂç†‰ΩçÂÖÉÁ¥†
                const lastChild = tab.lastElementChild;
                if (lastChild && lastChild.tagName === 'SPAN' && !lastChild.classList.contains('region-status') && lastChild.style.width === '20px') {
                    lastChild.remove();
                }
                
                if (statusElement) {
                    // ÁßªÈô§Áé∞ÊúâÁä∂ÊÄÅÁ±ª
                    statusElement.classList.remove('charging', 'discharging');
                    
                    // Êñ∞ÁöÑÁä∂ÊÄÅÊòæÁ§∫ÈÄªËæëÂ∑≤ÁßªËá≥updateRegionStatusDisplayÂáΩÊï∞
                    // ËøôÈáå‰øùÁïô‰∏∫ÂÖºÂÆπÊÄßÔºå‰ΩÜ‰∏çÂÜç‰ΩøÁî®+/-Á¨¶Âè∑
                } else {
                    // Á°Æ‰øùÊúâÂç†‰ΩçÂÖÉÁ¥†
                    const placeholder = document.createElement('span');
                    placeholder.style.width = '20px';
                    tab.appendChild(placeholder);
                }
            });
        }

        // ‰∏ªÂú∞Âå∫ÈÄâÊã©ÂáΩÊï∞
        function selectMainRegion(region, button) {
            selectedMainRegion = region;
            
            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            document.querySelectorAll('.region-select-tab').forEach(tab => {
                tab.classList.remove('active');
                tab.style.background = 'transparent';
                tab.style.color = 'var(--color-text-secondary)';
                tab.style.border = '1px solid var(--color-border)';
                tab.style.borderRadius = '50px';
                
                // Reset region name color for non-selected tabs
                const regionNameSpan = tab.querySelector('span');
                if (regionNameSpan && !regionNameSpan.innerHTML.includes('<div')) {
                    regionNameSpan.style.color = 'var(--color-text-secondary)';
                }
            });
            button.classList.add('active');
            button.style.background = 'var(--color-region-primary)';
            button.style.color = '#000';
            button.style.border = 'none';
            button.style.borderRadius = '50px';
            
            // Ensure region name text is visible when selected - use white for better contrast
            const regionNameSpan = button.querySelector('span');
            if (regionNameSpan && !regionNameSpan.innerHTML.includes('<div')) {
                regionNameSpan.style.color = '#000';
                regionNameSpan.style.fontWeight = '700';
            }
            
            // Ëé∑ÂèñËØ•Âú∞Âå∫ÁöÑÁä∂ÊÄÅÔºåÂ¶ÇÊûú‰∏çÂ≠òÂú®Âàô‰ΩøÁî®ÈªòËÆ§ÂÄº
            const regionStatus = regionData[region] ? regionData[region].status : 'none';
            
            // Êõ¥Êñ∞ÁîµÁ´ôÁÆ°ÁêÜÁä∂ÊÄÅ
            updatePowerStationStatus(region, regionStatus);
            
            // ÂÖàÁ´ãÂç≥Êõ¥Êñ∞ËØ•Âú∞Âå∫ÁöÑËÆæÂ§áÁªüËÆ°ÊòæÁ§∫ÔºàÂú®ÂàáÊç¢Èù¢Êùø‰πãÂâçÔºâ
            updateRegionDeviceStats(region);

            // Ê†πÊçÆÁä∂ÊÄÅÂàáÊç¢Èù¢ÊùøÂíåÊåâÈíÆ
            if (regionStatus === 'autoCharge' || regionStatus === 'manualCharge' || regionStatus === 'autoDischarge' || regionStatus === 'manualDischarge') {
                // ÊúâÂÖÖÊîæÁîµÊ†áËÆ∞ÁöÑÂú∞Âå∫ÔºåÊòæÁ§∫Âú∞ÂõæÔºåÊåâÈíÆÂèòÊàêÂÅúÊ≠¢
                currentOperation = (regionStatus === 'autoCharge' || regionStatus === 'manualCharge') ? 'charge' : 'discharge';
                switchPanel('map');
                updateActionButtonsToStop();
            } else {
                // Êó†Ê†áËÆ∞ÁöÑÂú∞Âå∫Ôºàstatus === 'none' Êàñ 'waitingExecution'ÔºâÔºåÊòæÁ§∫Âú∞ÂõæÈù¢Êùø‰ª•ÊòæÁ§∫ËÆæÂ§áÁªüËÆ°
                currentOperation = null;
                switchPanel('map'); // Êîπ‰∏∫ÊòæÁ§∫Âú∞ÂõæÈù¢ÊùøÔºåËøôÊ†∑ÊâçËÉΩÁúãÂà∞ËÆæÂ§áÁªüËÆ°
                updateActionButtonsToChargeDis();
            }

            // Êõ¥Êñ∞È°µÈù¢Êï∞ÊçÆ
            updatePageDataByRegion(region);

            // ÊÄªÊòØÊõ¥Êñ∞Âú∞Âå∫ÊòæÁ§∫Ôºå‰ª•Á°Æ‰øùÂàáÊç¢Êó∂Ê†∑ÂºèÊ≠£Á°Æ
            updateRegionDisplay();

            // Âº∫Âà∂Êõ¥Êñ∞Âú∞Âå∫Áä∂ÊÄÅÊòæÁ§∫ÔºåÁ°Æ‰øùÁä∂ÊÄÅÊñáÂ≠óÊ≠£Á°ÆÊòæÁ§∫
            setTimeout(() => {
                updateRegionStatusDisplay();
            }, 50);

            // Ë∞ÉÊï¥Èó¥Ë∑ù
            setTimeout(() => {
                adjustSpacingForRegionSelector();
            }, 100);

            // ÂÜçÊ¨°Êõ¥Êñ∞ËÆæÂ§áÁªüËÆ°Ôºà‰øùÈô©Ôºâ
            setTimeout(() => {
                updateRegionDeviceStats(region);
            }, 150);
        }
        
        // Êõ¥Êñ∞Âú∞Âå∫ËÆæÂ§áÁªüËÆ°ÊòæÁ§∫
        function updateRegionDeviceStats(region) {

            // Ëé∑ÂèñËØ•Âú∞Âå∫ÁöÑËÆæÂ§áÁªüËÆ°Êï∞ÊçÆ
            const stats = regionData[region]?.deviceStats;

            if (!stats) {
                // error(`‚ùå No device stats found for region: ${region}`);
                return;
            }


            // Êõ¥Êñ∞È°µÈù¢ÊòæÁ§∫
            const totalEl = document.getElementById('totalDevices');
            const successEl = document.getElementById('successfulDevices');
            const executingEl = document.getElementById('executingDevices');
            const failedEl = document.getElementById('failedDevices');


            if (!totalEl || !successEl || !executingEl || !failedEl) {
                return; // device stats not in current layout
                return;
            }

            // Âº∫Âà∂Êõ¥Êñ∞ÊñáÊú¨ÂÜÖÂÆπ
            totalEl.textContent = stats.total;
            successEl.textContent = stats.success;
            executingEl.textContent = stats.executing;
            failedEl.textContent = stats.failed;

            // È™åËØÅÊõ¥Êñ∞ÊòØÂê¶ÊàêÂäü

            // ÂêåÊ≠•Êõ¥Êñ∞ÊäΩÂ±âÁöÑËÆæÂ§áÊï∞ÊçÆÔºà‰º†ÂÖ•ËØ¶ÁªÜÁªüËÆ°Êï∞ÊçÆÔºâ
            updateDeviceStatusCounts(stats.success, stats.executing, stats.failed, stats);
        }

        // Êõ¥Êñ∞ÁîµÁ´ôÁÆ°ÁêÜÁä∂ÊÄÅ
        function updatePowerStationStatus(region, status) {
            const statusText = document.getElementById('regionStatusText');
            const autoToggle = document.getElementById('autoToggleKnob');
            const circle = document.getElementById('mainPriceCircle');
            const chargeBtn = document.getElementById('chargeBtn');
            const dischargeBtn = document.getElementById('dischargeBtn');
            
            // ‰∏çÂÜçÊõ¥Êñ∞Áä∂ÊÄÅÊñáÂ≠ó - ÊåâÁî®Êà∑Ë¶ÅÊ±ÇÁßªÈô§Ê†áÈ¢òÂêéÁöÑÁä∂ÊÄÅÊñáÂ≠ó
            if (statusText) {
                statusText.textContent = '';
                statusText.style.display = 'none';
            }
            
            // Êõ¥Êñ∞Ëá™Âä®ÂºÄÂÖ≥Áä∂ÊÄÅ - Ê†πÊçÆÂú∞Âå∫Áä∂ÊÄÅÊéßÂà∂ÔºöÂè™ÊúâËá™Âä®Êìç‰ΩúÊàñÁ≠âÂæÖÊâßË°å‰∏≠Êó∂‰∏∫ÂºÄÂêØÁä∂ÊÄÅ
            if (autoToggle) {
                if (status === 'autoCharge' || status === 'autoDischarge' || status === 'waitingExecution' || (status === 'none' && currentOperationMode === 'auto')) {
                    // Ëá™Âä®Ê®°ÂºèÔºöÂºÄÂÖ≥ÂêëÂè≥ÔºàÂºÄÂêØÁä∂ÊÄÅÔºâ- Á∫ØÁªøËâ≤ËÉåÊôØÔºåÁôΩËâ≤ÂúÜÁÇπ
                    autoToggle.style.right = '1px';
                    autoToggle.style.left = 'auto';
                    autoToggle.style.background = '#fff';
                    autoToggle.parentElement.style.background = '#4CD964';
                } else {
                    // ÊâãÂä®Ê®°ÂºèÔºöÂºÄÂÖ≥ÂêëÂ∑¶ÔºàÂÖ≥Èó≠Áä∂ÊÄÅÔºâ
                    autoToggle.style.left = '1px';
                    autoToggle.style.right = 'auto';
                    autoToggle.style.background = '#fff';
                    autoToggle.parentElement.style.background = 'rgba(255,255,255,0.1)';
                }
            }
            
            // ÊéßÂà∂ÂÖÖÊîæÁîµÊåâÈíÆÁöÑÊòæÁ§∫/ÈöêËóè
            if (chargeBtn && dischargeBtn) {
                if (status === 'none') {
                    // Êó†Áä∂ÊÄÅÊó∂ÊòæÁ§∫ÂÖÖÊîæÁîµÊåâÈíÆ
                    chargeBtn.style.display = 'flex';
                    dischargeBtn.style.display = 'flex';
                    
                    // Ê†πÊçÆÂΩìÂâçÊ®°ÂºèËÆæÁΩÆÊåâÈíÆÁä∂ÊÄÅ
                    if (currentOperationMode === 'auto') {
                        chargeBtn.style.display = 'none';
                        dischargeBtn.style.display = 'none';
                    } else {
                        chargeBtn.disabled = false;
                        dischargeBtn.disabled = false;
                        chargeBtn.style.opacity = '1';
                        dischargeBtn.style.opacity = '1';
                        chargeBtn.style.cursor = 'pointer';
                        dischargeBtn.style.cursor = 'pointer';
                    }
                } else {
                    // ÊúâÁä∂ÊÄÅÊó∂ÁöÑÊåâÈíÆÂ§ÑÁêÜ
                    if (currentOperationMode === 'auto') {
                        // Ëá™Âä®Ê®°ÂºèÔºöÈöêËóèÊåâÈíÆ
                        chargeBtn.style.display = 'none';
                        dischargeBtn.style.display = 'none';
                    } else {
                        // ÊâãÂä®Ê®°ÂºèÔºöÈöêËóèÊåâÈíÆ
                        chargeBtn.style.display = 'none';
                        dischargeBtn.style.display = 'none';
                    }
                }
            }
            
            // Êõ¥Êñ∞Ê∞¥Ê≥¢È¢úËâ≤ÂíåÈ´òÂ∫¶
            if (circle) {
                const waterWaveContainer = circle.querySelector('#waterWaveContainer');
                const waterLevelContainer = circle.querySelector('#waterLevelContainer');
                
                if (status === 'autoCharge' || status === 'manualCharge') {
                    // ÂÖÖÁîµÁä∂ÊÄÅ - ‰ΩøÁî®ËèúÂçïÊ†èÈÄâ‰∏≠‰∏ªÈ¢òËâ≤ÔºåÊ∞¥Ê≥¢È´òÂ∫¶30%ÔºåÊ∑ªÂä†Â§ßÂúÜÂíåÊ∞¥Ê≥¢Âä®Êïà
                    if (waterWaveContainer) {
                        waterWaveContainer.style.background = 'var(--color-primary, #00ff88)';
                    }
                    if (waterLevelContainer) {
                        waterLevelContainer.style.height = '100%';
                    }
                    // ÁªôÂ§ßÂúÜÊ∑ªÂä†ÂêëÂ§ñÂæÆÂä®Êïà
                    circle.style.animation = 'chargeCirclePulse 2s ease-in-out infinite';
                } else if (status === 'autoDischarge' || status === 'manualDischarge') {
                    // ÊîæÁîµÁä∂ÊÄÅ - ÈªÑËâ≤Ê∞¥Ê≥¢ÔºåÊ∞¥Ê≥¢È´òÂ∫¶80%ÔºåÊ∑ªÂä†Â§ßÂúÜÂíåÊ∞¥Ê≥¢Âä®Êïà
                    if (waterWaveContainer) {
                        waterWaveContainer.style.background = '#FFC107';
                    }
                    if (waterLevelContainer) {
                        waterLevelContainer.style.height = '100%';
                    }
                    // ÁªôÂ§ßÂúÜÊ∑ªÂä†ÂêëÂ§ñÂæÆÂä®Êïà
                    circle.style.animation = 'dischargeCirclePulse 2.2s ease-in-out infinite';
                } else {
                    // Êó†Áä∂ÊÄÅ - ËìùËâ≤Ê∞¥Ê≥¢ÔºåÈªòËÆ§È´òÂ∫¶50%ÔºåÊó†Âä®Êïà
                    if (waterWaveContainer) {
                        waterWaveContainer.style.background = '#5AC8FA';
                    }
                    if (waterLevelContainer) {
                        waterLevelContainer.style.height = '100%';
                    }
                    // ÁßªÈô§Â§ßÂúÜÂä®Êïà
                    circle.style.animation = 'none';
                }
            }
            
            // Ê†πÊçÆÁä∂ÊÄÅÊõ¥Êñ∞‰ª∑Ê†ºÊòæÁ§∫
            updatePriceByStatus(region, status);
            
            // Êõ¥Êñ∞Â§ßÂúÜ‰∏≠ÁöÑÁä∂ÊÄÅÊ†áÁ≠æ
            updateStationStatusLabel(status);
            
            // Êõ¥Êñ∞Â§ßÂúÜÊòæÁ§∫Áä∂ÊÄÅ
            updateCircleStatusDisplay();

            // Êõ¥Êñ∞AIÈ¢ÑÊµãÊñáÊú¨
            updateAIPredictionText();
        }

        // Êõ¥Êñ∞ÁîµÁ´ôÁä∂ÊÄÅÊ†áÁ≠æ
        function updateStationStatusLabel(status) {
            const statusLabel = document.getElementById('stationStatusLabel');
            if (!statusLabel) return;
            
            
            let statusText = '';
            let showLabel = true;
            
            if (status === 'none') {
                // Ê≤°ÊúâÁä∂ÊÄÅÊó∂ÈöêËóèÊ†áÁ≠æ
                showLabel = false;
            } else if (status === 'autoCharge') {
                statusText = window.i18n ? window.i18n.getText('autoCharge') : 'Êô∫ËÉΩÂÖÖÁîµ';
            } else if (status === 'manualCharge') {
                statusText = window.i18n ? window.i18n.getText('manualCharge') : 'ÊâãÂä®ÂÖÖÁîµ';
            } else if (status === 'autoDischarge') {
                statusText = window.i18n ? window.i18n.getText('autoDischarge') : 'Êô∫ËÉΩÊîæÁîµ';
            } else if (status === 'manualDischarge') {
                statusText = window.i18n ? window.i18n.getText('manualDischarge') : 'ÊâãÂä®ÊîæÁîµ';
            } else if (status === 'waitingExecution') {
                statusText = window.i18n ? window.i18n.getText('waitingExecution') : 'Á≠âÂæÖÊâßË°å‰∏≠';
            }
            
            if (showLabel) {
                statusLabel.textContent = statusText;
                statusLabel.style.display = 'block';
            } else {
                statusLabel.style.display = 'none';
            }
        }
        
        // Ê†πÊçÆÁä∂ÊÄÅÊõ¥Êñ∞‰ª∑Ê†º
        function updatePriceByStatus(region, status) {
            let price;

            // ‰ºòÂÖà‰ΩøÁî®AEMOÁúüÂÆûÊï∞ÊçÆÁöÑÂΩìÂâç‰ª∑Ê†º
            if (aemoRealPriceData && aemoRealPriceData.length > 0) {
                // ËÆ°ÁÆóÂΩìÂâçÊó∂Èó¥Á¥¢Âºï
                const now = new Date();
                const currentHour = now.getHours();
                const currentMinute = now.getMinutes();
                const roundedMinute = Math.floor(currentMinute / 5) * 5;
                const currentTimeIndex = currentHour * 12 + (roundedMinute / 5);

                // ‰ΩøÁî®ÁúüÂÆûÁöÑÁé∞Ë¥ß‰ª∑Ê†º
                price = aemoRealPriceData[currentTimeIndex];
            } else {
                // ÂêéÂ§áÊñπÊ°àÔºöÂêÑÂú∞Âå∫Âõ∫ÂÆö‰ª∑Ê†º
                const regionPrices = {
                    'NSW': 163,
                    'QLD': 34,
                    'VIC': 21,
                    'SA': 403,
                    'TAS': 390
                };
                price = regionPrices[region] || 163; // ÈªòËÆ§NSW‰ª∑Ê†º
            }

            // Êõ¥Êñ∞‰ª∑Ê†ºÊòæÁ§∫
            const currentPriceElement = document.getElementById('currentPrice');
            if (currentPriceElement) currentPriceElement.textContent = '$' + (typeof price === 'number' ? price.toFixed(2) : price);
        }
        
        // Êõ¥Êñ∞Êìç‰ΩúÊåâÈíÆ‰∏∫ÂÅúÊ≠¢Áä∂ÊÄÅ
        function updateActionButtonsToStop() {
            const actionButtonsContainer = document.querySelector('.action-buttons');
            if (!actionButtonsContainer) return;
            
            // Ê∑ªÂä†operatingÁ±ª
            actionButtonsContainer.classList.add('operating');
            
            // Â§ÑÁêÜÂÖÖÊîæÁîµÊåâÈíÆ
            const chargeBtn = document.getElementById('chargeBtn');
            const dischargeBtn = document.getElementById('dischargeBtn');
            
            if (chargeBtn && dischargeBtn) {
                if (currentOperationMode === 'auto') {
                    // Ëá™Âä®Ê®°ÂºèÔºöÈöêËóèÊåâÈíÆ
                    chargeBtn.style.display = 'none';
                    dischargeBtn.style.display = 'none';
                } else {
                    // ÊâãÂä®Ê®°ÂºèÔºöÈöêËóèÊåâÈíÆ
                    chargeBtn.style.display = 'none';
                    dischargeBtn.style.display = 'none';
                }
            }
            
            // ‰∏çÊòæÁ§∫ÂÅúÊ≠¢ÊåâÈíÆÔºåÂÅúÊ≠¢ÂäüËÉΩÈõÜÊàêÂú®Â§ßÂúÜ‰∏≠
            // ÁßªÈô§‰ªª‰ΩïÁé∞ÊúâÁöÑÂÅúÊ≠¢ÊåâÈíÆ
            const stopBtn = document.querySelector('.stop-btn');
            if (stopBtn) {
                stopBtn.remove();
            }
            
            // ‰∏çÈúÄË¶ÅÊõ¥ÊîπÊòæÁ§∫Ôºå‰øùÊåÅ‰ª∑Ê†ºÊòæÁ§∫
        }
        
        // Êõ¥Êñ∞Êìç‰ΩúÊåâÈíÆ‰∏∫ÂÖÖÊîæÁîµÁä∂ÊÄÅ
        function updateActionButtonsToChargeDis() {
            const actionButtonsContainer = document.querySelector('.action-buttons');
            if (!actionButtonsContainer) return;
            
            // ÁßªÈô§operatingÁ±ª
            actionButtonsContainer.classList.remove('operating');
            
            // ÈáçÁΩÆÂΩìÂâçÊìç‰ΩúÁä∂ÊÄÅ
            currentOperation = null;
            
            // Ë∞ÉÁî®resetButtonsÁ°Æ‰øùÊ≠£Á°ÆÈáçÁΩÆ
            resetButtons();
            
            // ÁßªÈô§ÂÅúÊ≠¢ÊåâÈíÆÔºàËÄå‰∏ç‰ªÖÊòØÈöêËóèÔºâ
            const stopBtn = document.querySelector('.stop-btn');
            if (stopBtn) {
                stopBtn.remove();
            }
            
            // Á°Æ‰øùÊåâÈíÆ‰∫ã‰ª∂Â§ÑÁêÜÂô®Ê≠£Á°ÆÁªëÂÆö
            const chargeBtn = document.getElementById('chargeBtn');
            const dischargeBtn = document.getElementById('dischargeBtn');
            if (chargeBtn) {
                chargeBtn.onclick = handleCharge;
            }
            if (dischargeBtn) {
                dischargeBtn.onclick = handleDischarge;
            }
        }
        
        // Ê†πÊçÆÂú∞Âå∫Êõ¥Êñ∞È°µÈù¢Êï∞ÊçÆ
        function updatePageDataByRegion(region) {
            // Êõ¥Êñ∞ÁîµÁ´ôÁÆ°ÁêÜÊï∞ÊçÆ
            updatePowerStationData(region);
            
            // Êõ¥Êñ∞Â∏ÇÂú∫Êï∞ÊçÆ
            updateMarketDataByRegion(region);
            
            // Êõ¥Êñ∞ÁªüËÆ°Âç°Áâá
            updateStatisticsCards(region);
            
            // Êõ¥Êñ∞ÂõæË°®
            if (marketChart) {
                updateMarketChart();
            }
            if (powerRevenueChart) {
                updateDischargeChart(currentDischargePeriod, document.getElementById('discharge-date-input').value);
            }
            
            // Êõ¥Êñ∞Âú∞ÂõæÊòæÁ§∫
            if (mapChart) {
                updateMapByRegion(region);
            }
        }
        
        // Êõ¥Êñ∞ÁîµÁ´ôÁÆ°ÁêÜÊï∞ÊçÆ
        function updatePowerStationData(region) {
            const regionData = {
                'NSW': { price: '$163', low: '$120.50', high: '$185.75', families: 120, power: '65kWh', profit: '$3500' },
                'QLD': { price: '$34', low: '$110.00', high: '$170.00', families: 90, power: '48kWh', profit: '$2800' },
                'VIC': { price: '$21', low: '$115.50', high: '$175.50', families: 100, power: '52kWh', profit: '$3100' },
                'SA': { price: '$403', low: '$125.00', high: '$190.00', families: 70, power: '38kWh', profit: '$2200' },
                'TAS': { price: '$390', low: '$100.00', high: '$160.00', families: 355, power: '32kWh', profit: '$1835' }
            };

            const data = regionData[region] || regionData['NSW'];

            // Êõ¥Êñ∞‰ª∑Ê†ºÊòæÁ§∫
            const currentPriceEl = document.getElementById('currentPrice');
            const todayLowEl = document.getElementById('todayLow');
            const todayHighEl = document.getElementById('todayHigh');
            const regionIndicatorEl = document.getElementById('regionIndicator');

            // ‰ºòÂÖà‰ΩøÁî®AEMOÁúüÂÆûÊï∞ÊçÆÁöÑÂΩìÂâç‰ª∑Ê†º
            if (currentPriceEl) {
                if (aemoRealPriceData && aemoRealPriceData.length > 0) {
                    // ËÆ°ÁÆóÂΩìÂâçÊó∂Èó¥Á¥¢Âºï
                    const now = new Date();
                    const currentHour = now.getHours();
                    const currentMinute = now.getMinutes();
                    const roundedMinute = Math.floor(currentMinute / 5) * 5;
                    const currentTimeIndex = currentHour * 12 + (roundedMinute / 5);

                    // ‰ΩøÁî®ÁúüÂÆûÁöÑÁé∞Ë¥ß‰ª∑Ê†º
                    const currentPrice = aemoRealPriceData[currentTimeIndex];
                    currentPriceEl.textContent = '$' + currentPrice.toFixed(2);
                } else {
                    // ÂêéÂ§áÊñπÊ°àÔºö‰ΩøÁî®Âõ∫ÂÆö‰ª∑Ê†º
                    currentPriceEl.textContent = data.price;
                }
            }
            if (todayLowEl) todayLowEl.textContent = data.low;
            if (todayHighEl) todayHighEl.textContent = data.high;
            if (regionIndicatorEl) regionIndicatorEl.textContent = region;
            
            // Êõ¥Êñ∞ÁªüËÆ°Êï∞ÊçÆ
            const totalFamiliesCardEl = document.getElementById('totalFamiliesCard');
            if (totalFamiliesCardEl) totalFamiliesCardEl.textContent = data.families;
            // Êõ¥Êñ∞ÁîµÁ´ôÁÆ°ÁêÜ‰∏≠ÁöÑ‰∏â‰∏™Â∞èÂç°Áâá
            const powerStationCards = document.querySelectorAll('.power-station-container .stat-value');
            if (powerStationCards.length >= 3) {
                powerStationCards[0].textContent = data.families;  // ÂÆ∂Â∫≠Êï∞
                powerStationCards[1].textContent = data.power;  // ÂèØÊîæÁîµÈáè
                powerStationCards[2].textContent = data.profit;  // È¢ÑËÆ°Ëé∑Âà©
            }
            
            // Êõ¥Êñ∞ÊúÄÈ´ò‰ª∑Ê†ºÂå∫ÂüüÊòæÁ§∫
            const highestPriceRegionElement = document.getElementById('highestPriceRegion') || document.getElementById('highestPriceRegionDisplay');
            if (highestPriceRegionElement) {
                highestPriceRegionElement.textContent = region;
            }
        }
        
        // Êõ¥Êñ∞Â∏ÇÂú∫Êï∞ÊçÆ
        function updateMarketDataByRegion(region) {
            // Ëß¶ÂèëÂ∏ÇÂú∫Èù¢ÊùøÁöÑÂú∞Âå∫ÂàáÊç¢
            const marketRegionTab = document.querySelector(`.region-tab[onclick*="${region}"]`);
            if (marketRegionTab) {
                switchMarketRegion(region, marketRegionTab);
            }
        }
        
        // Êõ¥Êñ∞ÁªüËÆ°Âç°Áâá
        function updateStatisticsCards(region) {
            const summaryData = {
                'NSW': { families: 120, capacity: '65kWh', discharge: '89kwh', profit: '$3500' },
                'QLD': { families: 90, capacity: '48kWh', discharge: '45kwh', profit: '$2800' },
                'VIC': { families: 100, capacity: '52kWh', discharge: '51kwh', profit: '$3100' },
                'SA': { families: 70, capacity: '38kWh', discharge: '32kwh', profit: '$2200' },
                'TAS': { families: 355, capacity: '32kWh', discharge: '17kwh', profit: '$1835' }
            };
            
            const data = summaryData[region] || summaryData['NSW'];
            
            // Êõ¥Êñ∞Ê±áÊÄªÂç°Áâá
            const familySummary = document.getElementById('familySummaryCard');
            if (familySummary) familySummary.textContent = data.families;
            
            // Êõ¥Êñ∞ÂÖ∂‰ªñÊ±áÊÄªÊï∞ÊçÆ
            const summaryElements = document.querySelectorAll('.info-summary-card .stat-value');
            if (summaryElements.length >= 4) {
                summaryElements[1].textContent = data.capacity;
                summaryElements[2].textContent = data.discharge;
                summaryElements[3].textContent = data.profit;
            }
        }
        
        // Êõ¥Êñ∞Âú∞ÂõæÊòæÁ§∫
        function updateMapByRegion(region) {
            if (!mapChart) return;

            // Âè™ÊòæÁ§∫ÈÄâÂÆöÂú∞Âå∫ÁöÑËÆæÂ§á
            if (deviceLocations && deviceLocations.length > 0) {
                // ËøáÊª§ÈÄâ‰∏≠Âú∞Âå∫ÁöÑËÆæÂ§áÔºåÂêåÊó∂ËøáÊª§ÊéâhiddenÁä∂ÊÄÅÁöÑËÆæÂ§á
                const filteredDevices = deviceLocations.filter(device =>
                    device.region === region && device.status !== 'hidden'
                );
                const seriesData = filteredDevices.map(device => ({
                    value: device.value,
                    id: device.id,
                    status: device.status,
                    region: device.region
                }));
                
                mapChart.setOption({
                    series: [{
                        data: seriesData
                    }]
                });
            }
            
            updateMapStatistics();
        }
        
        // Update functions
        function switchRegion(region, button) {
            currentRegion = region;
            
            // Update active button
            document.querySelectorAll('.chart-controls .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            button.classList.add('active');
            
            // Update chart with new data
            updateMainChart('both');
        }

        function switchPriceRegion(region, button) {
            // Update active button
            const parent = button.parentElement;
            parent.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            button.classList.add('active');
        }

        // Discharge & Profit time period switching
        let currentDischargePeriod = 'day';
        
        function handleDischargePeriodChange() {
            const periodSelect = document.getElementById('discharge-period-select');
            const period = periodSelect.value;
            currentDischargePeriod = period;
            
            // Handle date picker visibility and type
            const datePicker = document.getElementById('discharge-date-picker');
            const dateInput = document.getElementById('discharge-date-input');
            
            if (period === 'cumulative') {
                // Hide date picker for cumulative
                datePicker.style.display = 'none';
            } else {
                // Show date picker
                datePicker.style.display = 'flex';
                
                // Set appropriate input type and default value
                const today = new Date();
                switch(period) {
                    case 'day':
                        dateInput.type = 'date';
                        dateInput.value = today.toISOString().split('T')[0];
                        dateInput.style.minWidth = '140px';
                        dateInput.style.width = '';
                        break;
                    case 'month':
                        dateInput.type = 'month';
                        dateInput.value = today.toISOString().slice(0, 7);
                        dateInput.style.minWidth = '140px';
                        dateInput.style.width = '';
                        break;
                    case 'year':
                        // For year, we'll use a number input
                        dateInput.type = 'number';
                        dateInput.min = '2020';
                        dateInput.max = today.getFullYear().toString();
                        dateInput.value = today.getFullYear().toString();
                        dateInput.style.minWidth = '100px';
                        dateInput.style.width = '100px';
                        break;
                }
            }
            
            // Update chart data based on period
            updateDischargeChart(period, dateInput.value);
        }
        
        function updateDischargeChart(period, dateValue) {
            if (!powerRevenueChart) {
                initPowerRevenueChart();
                if (!powerRevenueChart) {
                    // error('Failed to initialize powerRevenueChart');
                    return;
                }
            }

            let xAxisData, inputData, outputData, profitData;
            let yAxisConfig, yAxis2Config;
            const feedInRate = 0.08; // $0.08/kWh feed-in rate

            switch(period) {
                case 'day':
                    // Half-hourly data for selected day (48 data points) - Power in kW
                    xAxisData = Array.from({length: 48}, (_, i) => {
                        const hour = Math.floor(i / 2);
                        const minute = (i % 2) * 30;
                        return `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                    });

                    // Generate realistic Australian household energy data
                    // Adjusted based on current Australian season
                    inputData = [];
                    outputData = [];
                    profitData = [];

                    // Get current month (1-12) to determine season
                    const currentMonth = new Date().getMonth() + 1;
                    const isSummer = currentMonth === 12 || currentMonth === 1 || currentMonth === 2; // Dec-Feb
                    const isWinter = currentMonth === 6 || currentMonth === 7 || currentMonth === 8; // Jun-Aug

                    // Seasonal multipliers for solar generation and grid purchase
                    const solarMultiplier = isSummer ? 1.3 : isWinter ? 0.6 : 1.0;
                    const gridMultiplier = isSummer ? 0.7 : isWinter ? 1.4 : 1.0;

                    for (let i = 0; i < 48; i++) {
                        const hour = Math.floor(i / 2);
                        let gridPurchase = 0;
                        let feedIn = 0;

                        if (hour >= 0 && hour < 6) {
                            gridPurchase = (0.3 + Math.random() * 0.4) * gridMultiplier;
                            feedIn = Math.random() * 0.1;
                        } else if (hour >= 6 && hour < 9) {
                            gridPurchase = (1.5 + (hour - 6) * 0.8 + Math.random() * 0.5) * gridMultiplier;
                            feedIn = Math.max(0, (hour - 6) * 0.8 + Math.random() * 0.5) * solarMultiplier;
                        } else if (hour >= 9 && hour < 17) {
                            gridPurchase = (0.2 + Math.random() * 0.3) * gridMultiplier;
                            if (hour >= 12 && hour < 15) {
                                feedIn = (4.5 + Math.random() * 1.5) * solarMultiplier;
                            } else if (hour >= 10 && hour < 12) {
                                feedIn = (3.0 + Math.random() * 1.0) * solarMultiplier;
                            } else if (hour >= 15 && hour < 17) {
                                feedIn = (2.5 + Math.random() * 1.0) * solarMultiplier;
                            } else {
                                feedIn = (2.0 + Math.random() * 0.8) * solarMultiplier;
                            }
                        } else if (hour >= 17 && hour < 22) {
                            gridPurchase = (2.5 + (hour - 17) * 0.3 + Math.random() * 0.8) * gridMultiplier;
                            if (hour < 19) {
                                feedIn = Math.max(0, (1.5 - (hour - 17) * 0.5 + Math.random() * 0.3) * solarMultiplier);
                            } else {
                                feedIn = Math.random() * 0.3;
                            }
                        } else {
                            gridPurchase = (1.2 - (hour - 22) * 0.4 + Math.random() * 0.3) * gridMultiplier;
                            feedIn = Math.random() * 0.1;
                        }

                        const profit = feedIn * 0.5 * feedInRate; // kW * 0.5h = kWh

                        inputData.push(parseFloat(gridPurchase.toFixed(2)));
                        outputData.push(parseFloat(feedIn.toFixed(2)));
                        profitData.push(parseFloat(profit.toFixed(2)));
                    }

                    // Y-axis for day view: kW (0-8) and $ (0-0.3)
                    yAxisConfig = {
                        type: 'value',
                        name: 'kW',
                        nameTextStyle: { color: 'rgba(255, 255, 255, 0.6)' },
                        min: 0,
                        max: 8,
                        interval: 1,
                        axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.2)' } },
                        axisLabel: {
                            color: 'rgba(255, 255, 255, 0.6)',
                            formatter: '{value}'
                        },
                        splitLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.1)' } }
                    };
                    yAxis2Config = {
                        type: 'value',
                        name: window.i18n ? window.i18n.getText('profit') : 'Ëé∑Âà©',
                        nameTextStyle: { color: 'rgba(255, 255, 255, 0.6)' },
                        min: 0,
                        max: 0.3,
                        interval: 0.05,
                        axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.2)' } },
                        axisLabel: {
                            color: 'rgba(255, 255, 255, 0.6)',
                            formatter: '${value}'
                        },
                        splitLine: { show: false }
                    };
                    break;

                case 'month':
                    // Daily data for selected month - Energy in kWh per day
                    const daysInMonth = new Date(dateValue.split('-')[0], dateValue.split('-')[1], 0).getDate();
                    xAxisData = Array.from({length: daysInMonth}, (_, i) => (i + 1).toString());

                    inputData = [];
                    outputData = [];
                    profitData = [];

                    for (let day = 0; day < daysInMonth; day++) {
                        // Simulate seasonal variation (summer = more solar)
                        const month = parseInt(dateValue.split('-')[1]);
                        const isSummer = month === 12 || month === 1 || month === 2;
                        const isWinter = month === 6 || month === 7 || month === 8;

                        // Daily grid purchase: 8-15 kWh/day
                        const gridPurchase = (isSummer ? 8 : isWinter ? 13 : 10) + Math.random() * 5;

                        // Daily feed-in: 15-35 kWh/day (summer higher)
                        const feedIn = (isSummer ? 25 : isWinter ? 15 : 20) + Math.random() * 10;

                        // Daily profit from feed-in
                        const profit = feedIn * feedInRate;

                        inputData.push(parseFloat(gridPurchase.toFixed(1)));
                        outputData.push(parseFloat(feedIn.toFixed(1)));
                        profitData.push(parseFloat(profit.toFixed(2)));
                    }

                    // Y-axis for month view: kWh per day (0-40) and $ (0-3)
                    yAxisConfig = {
                        type: 'value',
                        name: 'kWh',
                        nameTextStyle: { color: 'rgba(255, 255, 255, 0.6)' },
                        min: 0,
                        max: 40,
                        interval: 5,
                        axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.2)' } },
                        axisLabel: {
                            color: 'rgba(255, 255, 255, 0.6)',
                            formatter: '{value}'
                        },
                        splitLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.1)' } }
                    };
                    yAxis2Config = {
                        type: 'value',
                        name: window.i18n ? window.i18n.getText('profit') : 'Ëé∑Âà©',
                        nameTextStyle: { color: 'rgba(255, 255, 255, 0.6)' },
                        min: 0,
                        max: 3,
                        interval: 0.5,
                        axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.2)' } },
                        axisLabel: {
                            color: 'rgba(255, 255, 255, 0.6)',
                            formatter: '${value}'
                        },
                        splitLine: { show: false }
                    };
                    break;

                case 'year':
                    // Monthly data for selected year - Energy in kWh per month
                    // Fixed order: Jan to Dec
                    xAxisData = ['1Êúà', '2Êúà', '3Êúà', '4Êúà', '5Êúà', '6Êúà', '7Êúà', '8Êúà', '9Êúà', '10Êúà', '11Êúà', '12Êúà'];

                    inputData = [];
                    outputData = [];
                    profitData = [];

                    // Seasonal patterns for Australia (Southern hemisphere)
                    const monthlyPatterns = [
                        { grid: 280, feedIn: 850 },  // Jan (summer)
                        { grid: 260, feedIn: 780 },  // Feb (summer)
                        { grid: 300, feedIn: 720 },  // Mar (autumn)
                        { grid: 320, feedIn: 650 },  // Apr (autumn)
                        { grid: 350, feedIn: 580 },  // May (autumn)
                        { grid: 400, feedIn: 520 },  // Jun (winter)
                        { grid: 420, feedIn: 500 },  // Jul (winter)
                        { grid: 380, feedIn: 560 },  // Aug (winter)
                        { grid: 340, feedIn: 640 },  // Sep (spring)
                        { grid: 310, feedIn: 710 },  // Oct (spring)
                        { grid: 290, feedIn: 780 },  // Nov (spring)
                        { grid: 270, feedIn: 860 }   // Dec (summer)
                    ];

                    // Generate data in order from Jan to Dec
                    for (let i = 0; i < 12; i++) {
                        const pattern = monthlyPatterns[i];
                        const gridPurchase = pattern.grid + (Math.random() - 0.5) * 50;
                        const feedIn = pattern.feedIn + (Math.random() - 0.5) * 100;
                        const profit = feedIn * feedInRate;

                        inputData.push(parseFloat(gridPurchase.toFixed(0)));
                        outputData.push(parseFloat(feedIn.toFixed(0)));
                        profitData.push(parseFloat(profit.toFixed(2)));
                    }

                    // Y-axis for year view: kWh per month (0-1000) and $ (0-80)
                    yAxisConfig = {
                        type: 'value',
                        name: 'kWh',
                        nameTextStyle: { color: 'rgba(255, 255, 255, 0.6)' },
                        min: 0,
                        max: 1000,
                        interval: 200,
                        axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.2)' } },
                        axisLabel: {
                            color: 'rgba(255, 255, 255, 0.6)',
                            formatter: '{value}'
                        },
                        splitLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.1)' } }
                    };
                    yAxis2Config = {
                        type: 'value',
                        name: window.i18n ? window.i18n.getText('profit') : 'Ëé∑Âà©',
                        nameTextStyle: { color: 'rgba(255, 255, 255, 0.6)' },
                        min: 0,
                        max: 80,
                        interval: 10,
                        axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.2)' } },
                        axisLabel: {
                            color: 'rgba(255, 255, 255, 0.6)',
                            formatter: '${value}'
                        },
                        splitLine: { show: false }
                    };
                    break;

                case 'cumulative':
                    // Cumulative data over time - Total kWh
                    xAxisData = ['2020', '2021', '2022', '2023', '2024'];

                    // Cumulative totals showing growth over years
                    inputData = [4200, 8800, 13500, 18800, 24500];
                    outputData = [8500, 18000, 28500, 40000, 52500];
                    profitData = [680, 1440, 2280, 3200, 4200];

                    // Y-axis for cumulative view: kWh (0-60000) and $ (0-5000)
                    yAxisConfig = {
                        type: 'value',
                        name: 'kWh',
                        nameTextStyle: { color: 'rgba(255, 255, 255, 0.6)' },
                        min: 0,
                        max: 60000,
                        interval: 10000,
                        axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.2)' } },
                        axisLabel: {
                            color: 'rgba(255, 255, 255, 0.6)',
                            formatter: '{value}'
                        },
                        splitLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.1)' } }
                    };
                    yAxis2Config = {
                        type: 'value',
                        name: window.i18n ? window.i18n.getText('profit') : 'Ëé∑Âà©',
                        nameTextStyle: { color: 'rgba(255, 255, 255, 0.6)' },
                        min: 0,
                        max: 5000,
                        interval: 1000,
                        axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.2)' } },
                        axisLabel: {
                            color: 'rgba(255, 255, 255, 0.6)',
                            formatter: '${value}'
                        },
                        splitLine: { show: false }
                    };
                    break;
            }

            // Update chart with new data and Y-axis configuration
            powerRevenueChart.setOption({
                xAxis: {
                    data: xAxisData,
                    axisLabel: {
                        color: 'rgba(255, 255, 255, 0.6)',
                        interval: period === 'day' ? 5 : 'auto'
                    }
                },
                yAxis: [yAxisConfig, yAxis2Config],
                series: [
                    { data: inputData },
                    { data: outputData },
                    { data: profitData }
                ]
            });
        }
        
        // Initialize discharge chart date input listener
        document.addEventListener('DOMContentLoaded', function() {
            const dateInput = document.getElementById('discharge-date-input');
            if (dateInput) {
                // Set today's date as default
                const today = new Date();
                dateInput.value = today.toISOString().split('T')[0];
                
                dateInput.addEventListener('change', function() {
                    updateDischargeChart(currentDischargePeriod, this.value);
                });
            }
        });


        // Update power chart title with current time period
        function updatePowerChartTitle() {
            const chartTitle = document.getElementById('powerChartTitle');
            if (chartTitle) {
                chartTitle.textContent = window.i18n ? window.i18n.getText('powerRevenueTrend') : 'ÊîæÁîµ‰∏éÊî∂ÁõäË∂ãÂäø';
            }
        }

        // Initialize time selector for power chart
        function initPowerChartTimeSelector() {
            if (typeof TimeSelector === 'undefined') {
                // error('TimeSelector class not loaded');
                return;
            }
            powerChartTimeSelector = new TimeSelector({
                containerId: 'power-chart-time-selector',
                onPeriodChange: handlePowerChartPeriodChange,
                onCustomDateApply: handlePowerChartCustomDate,
                enableAutoRefresh: true,
                autoRefreshInterval: 30000,
                periods: [
                    { id: 'month', label: window.i18n ? window.i18n.getText('month') : 'Êú¨Êúà', shortcut: '1' },
                    { id: 'week', label: window.i18n ? window.i18n.getText('week') : 'Êú¨Âë®', shortcut: '2' },
                    { id: 'today', label: window.i18n ? window.i18n.getText('today') : '‰ªäÊó•', shortcut: '3' },
                    { id: 'custom', label: window.i18n ? window.i18n.getText('custom') : 'Ëá™ÂÆö‰πâ', shortcut: '4' }
                ],
                quickSelectOptions: [
                    { label: window.i18n ? window.i18n.getText('last7Days') : 'ÊúÄËøë7Â§©', days: 7 },
                    { label: window.i18n ? window.i18n.getText('last30Days') : 'ÊúÄËøë30Â§©', days: 30 },
                    { label: window.i18n ? window.i18n.getText('last90Days') : 'ÊúÄËøë90Â§©', days: 90 }
                ]
            });
            
            // Add language change observer to update TimeSelector
            if (window.i18n) {
                window.i18n.addObserver((newLanguage, oldLanguage) => {
                    // Re-initialize TimeSelector with new language
                    if (powerChartTimeSelector) {
                        const currentPeriod = powerChartTimeSelector.getCurrentPeriod();
                        powerChartTimeSelector.destroy();
                        initPowerChartTimeSelector();
                        // Restore current period
                        setTimeout(() => {
                            if (powerChartTimeSelector && currentPeriod !== 'today') {
                                powerChartTimeSelector.setCurrentPeriod(currentPeriod);
                            }
                        }, 100);
                    }
                });
            }
            
            // Set initial title to show default period (today)
            updatePowerChartTitle();
            
            // Force initial data load for today to ensure display
            setTimeout(() => {
                const { labels, power, revenue } = generateAnalyticsData('month');
                updatePowerChartWithData(labels, power, revenue, 'month');
            }, 200);
        }

        // Handle period change from time selector
        function handlePowerChartPeriodChange(period, data) {
            
            // Update chart title with current period
            updatePowerChartTitle();
            
            // Generate data for the selected period
            const { labels, power, revenue } = generateAnalyticsData(period);
            
            // Update the power chart
            updatePowerChartWithData(labels, power, revenue, period);
        }

        // Handle custom date range application
        function handlePowerChartCustomDate(startDate, endDate, dayCount) {
            
            // Format date range for display
            const startFormatted = new Date(startDate).toLocaleDateString('zh-CN');
            const endFormatted = new Date(endDate).toLocaleDateString('zh-CN');
            const customDateRange = `${startFormatted} Ëá≥ ${endFormatted}`;
            
            // Update chart title with custom date range
            updatePowerChartTitle();
            
            // Generate data for custom date range
            const { labels, power, revenue } = generateAnalyticsData('custom', startDate, endDate);
            
            // Update the power chart
            updatePowerChartWithData(labels, power, revenue, 'custom');
        }

        // Legacy function for backward compatibility
        function updateAnalytics(period) {
            if (powerChartTimeSelector) {
                // Map old period names to new ones
                const periodMap = {
                    'today': 'today',
                    'week': 'week', 
                    'month': 'month',
                    'custom': 'custom'
                };
                
                const mappedPeriod = periodMap[period] || period;
                powerChartTimeSelector.setCurrentPeriod(mappedPeriod);
            }
        }

        function generateAnalyticsData(period, startDate = null, endDate = null) {
            // Create cache key based on parameters
            const cacheKey = `analyticsData_${period}_${startDate || 'null'}_${endDate || 'null'}`;
            
            // Check cache first for standard periods (not custom with random data)
            if (period !== 'custom') {
                const cached = dataCache.get(cacheKey);
                if (cached) {
                    return cached;
                }
            }
            
            const labels = [];
            const power = [];
            const revenue = [];
            
            if (period === 'today') {
                for (let i = 0; i < 24; i += 2) {
                    labels.push(`${i}:00`);
                    power.push(Math.random() * 150 + 50);
                    revenue.push(Math.random() * 200 + 100);
                }
            } else if (period === 'week') {
                const currentLang = window.i18n ? window.i18n.getCurrentLanguage() : 'zh';
                let days;
                if (currentLang === 'en') {
                    days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                } else if (currentLang === 'ja') {
                    days = ['Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü', 'Êó•'];
                } else if (currentLang === 'ko') {
                    days = ['Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†', 'Ïùº'];
                } else {
                    days = ['Âë®‰∏Ä', 'Âë®‰∫å', 'Âë®‰∏â', 'Âë®Âõõ', 'Âë®‰∫î', 'Âë®ÂÖ≠', 'Âë®Êó•'];
                }
                days.forEach(day => {
                    labels.push(day);
                    power.push(Math.random() * 2000 + 1000);
                    revenue.push(Math.random() * 2500 + 1200);
                });
            } else if (period === 'month') {
                const currentLang = window.i18n ? window.i18n.getCurrentLanguage() : 'zh';
                for (let i = 1; i <= 30; i++) {
                    if (currentLang === 'en' || currentLang === 'ja' || currentLang === 'ko') {
                        labels.push(`${i}`);
                    } else {
                        labels.push(`${i}Êó•`);
                    }
                    power.push(Math.random() * 3000 + 1500);
                    revenue.push(Math.random() * 4000 + 2000);
                }
            } else if (period === 'custom' && startDate && endDate) {
                // Generate data for custom date range
                const start = new Date(startDate);
                const end = new Date(endDate);
                const diffTime = Math.abs(end - start);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                
                for (let i = 0; i < diffDays; i++) {
                    const currentDate = new Date(start);
                    currentDate.setDate(start.getDate() + i);
                    
                    if (diffDays <= 7) {
                        // Show date format for week or less
                        labels.push(`${currentDate.getMonth() + 1}/${currentDate.getDate()}`);
                    } else if (diffDays <= 31) {
                        // Show day format for month
                        labels.push(`${currentDate.getDate()}Êó•`);
                    } else {
                        // Show month/day for longer periods
                        labels.push(`${currentDate.getMonth() + 1}/${currentDate.getDate()}`);
                    }
                    
                    // Generate realistic historical data with some trend
                    const basePower = 1000 + Math.sin(i * 0.1) * 500;
                    const baseRevenue = 1500 + Math.sin(i * 0.15) * 700;
                    
                    power.push(Math.max(50, basePower + (Math.random() - 0.5) * 400));
                    revenue.push(Math.max(100, baseRevenue + (Math.random() - 0.5) * 600));
                }
            }
            
            const result = { labels, power, revenue };
            
            // Cache the result for standard periods
            if (period !== 'custom') {
                dataCache.set(cacheKey, result);
            }
            
            return result;
        }

        function updatePowerChartWithData(labels, power, revenue, period) {
            // Check if powerChart exists before updating
            if (!powerChart) {
                // warn('powerChart is not initialized, skipping update');
                return;
            }
            
            // Get updated translated labels
            const dischargeLabel = window.i18n ? window.i18n.getText('discharge') : 'ÊîæÁîµ';
            const revenueLabel = window.i18n ? window.i18n.getText('totalRevenue') : 'Êî∂Áõä';
            
            powerChart.setOption({
                legend: {
                    data: [dischargeLabel, revenueLabel]
                },
                xAxis: { 
                    data: labels,
                    axisLabel: {
                        color: 'rgba(255, 255, 255, 0.6)',
                        interval: labels.length > 15 ? Math.floor(labels.length / 10) : 0
                    }
                },
                series: [
                    { 
                        name: dischargeLabel,
                        data: power 
                    },
                    { 
                        name: revenueLabel,
                        data: revenue 
                    }
                ]
            });
        }


        // Legacy functions for backward compatibility
        function applyCustomDateRange() {
            if (powerChartTimeSelector) {
                powerChartTimeSelector.applyCustomDateRange();
            }
        }

        function resetToToday() {
            if (powerChartTimeSelector) {
                powerChartTimeSelector.resetToDefault();
            }
        }

        function setQuickRange(days) {
            if (powerChartTimeSelector) {
                powerChartTimeSelector.setQuickRange(days);
            }
        }

        function initializeDateInputs() {
            // This is now handled by the TimeSelector component
        }


        function updatePowerChart() {
            const date = document.getElementById('dateSelect').value;
            
            // Generate new data based on selected date
            const newData = [
                Math.random() * 150 + 50,
                Math.random() * 150 + 50,
                Math.random() * 150 + 50,
                Math.random() * 150 + 50,
                Math.random() * 150 + 50
            ];
            
            powerChart.setOption({
                series: [{ data: newData }]
            });
        }

        // Real-time data updates
        function updateRealtimeData() {
            // Get current region from the price circle indicator
            const regionIndicatorEl = document.getElementById('regionIndicator');
            const currentDisplayRegion = regionIndicatorEl ? regionIndicatorEl.textContent : 'NSW';
            
            // Update price data based on current region
            updatePriceCircleRegion(currentDisplayRegion);

            // Â¶ÇÊûúAEMOÊï∞ÊçÆÂ∑≤Âä†ËΩΩÔºå‰ΩøÁî®ÁúüÂÆûÊï∞ÊçÆÊõ¥Êñ∞‰ª∑Ê†ºÂç°Áâá
            if (aemoRealPriceData && aemoRealDemandData) {
                // ËÆ°ÁÆóÂΩìÂâçÊó∂Èó¥Á¥¢Âºï
                const now = new Date();
                const currentHour = now.getHours();
                const currentMinute = now.getMinutes();
                const roundedMinute = Math.floor(currentMinute / 5) * 5;
                const currentTimeIndex = currentHour * 12 + (roundedMinute / 5);

                // ËÆ°ÁÆó30ÂàÜÈíüÂêéÁöÑÁ¥¢ÂºïÔºà6‰∏™5ÂàÜÈíüÈó¥ÈöîÔºâ
                const forecastIndex = Math.min(currentTimeIndex + 6, aemoRealPriceData.length - 1);

                // Ëé∑ÂèñÂΩìÂâç‰ª∑Ê†ºÂíåÈúÄÊ±Ç
                const currentPrice = aemoRealPriceData[currentTimeIndex];
                const currentDemand = aemoRealDemandData[currentTimeIndex];

                // Ëé∑ÂèñÈ¢ÑÊµã‰ª∑Ê†ºÂíåÈúÄÊ±ÇÔºà30ÂàÜÈíüÂêéÔºâ
                const forecast30MinPrice = aemoRealPriceData[forecastIndex];
                const forecast30MinDemand = aemoRealDemandData[forecastIndex];

                // Update spot price
                const spotPriceEl = document.getElementById('spotPrice');
                if (spotPriceEl) spotPriceEl.textContent = '$' + currentPrice.toFixed(2);

                // Update power station management price (ÁîµÁ´ôÁÆ°ÁêÜ‰ª∑Ê†º‰∏éÁé∞Ë¥ß‰ª∑Ê†º‰øùÊåÅ‰∏ÄËá¥)
                const stationPriceEl = document.getElementById('currentPrice');
                if (stationPriceEl) stationPriceEl.textContent = '$' + currentPrice.toFixed(2);

                // Update current demand
                const currentDemandEl = document.getElementById('currentDemand');
                if (currentDemandEl) currentDemandEl.textContent = Math.round(currentDemand).toLocaleString();

                // Update forecast price (30ÂàÜÈíüÂêé)
                const forecastPriceEl = document.getElementById('forecastPrice');
                if (forecastPriceEl) forecastPriceEl.textContent = '$' + forecast30MinPrice.toFixed(2);

                // Update forecast demand (30ÂàÜÈíüÂêé)
                const forecastDemandEl = document.getElementById('forecastDemand');
                if (forecastDemandEl) forecastDemandEl.textContent = Math.round(forecast30MinDemand).toLocaleString();
            }
            
            // Update power station management data with realistic values
            const baseHomes = 235;
            const basePower = 23547;
            const baseProfit = 12435;
            
            // Add small realistic variations
            const homesVariation = Math.floor((Math.random() - 0.5) * 10); // ¬±5 homes
            const powerVariation = Math.floor((Math.random() - 0.5) * 500); // ¬±250 kWh
            const profitVariation = Math.floor((Math.random() - 0.5) * 200); // ¬±100 dollars
            
            const currentLang = window.i18n ? window.i18n.getCurrentLanguage() : 'zh';
            const unit = currentLang === 'en' ? '' : 
                        currentLang === 'ja' ? 'ÂÄã' :
                        currentLang === 'ko' ? 'Í∞ú' : '‰∏™';
            const availableHomesEl = document.getElementById('availableHomes');
            const availablePowerEl = document.getElementById('availablePower');
            const estimatedProfitEl = document.getElementById('estimatedProfit');
            
            if (availableHomesEl) availableHomesEl.textContent = (baseHomes + homesVariation);
            if (availablePowerEl) availablePowerEl.textContent = (basePower + powerVariation) + 'kWh';
            if (estimatedProfitEl) estimatedProfitEl.textContent = '$' + (baseProfit + profitVariation);
            
            // Add pulse effect to updated values (excluding today's high/low to avoid constant color change)
            const elements = ['currentPrice', 'spotPrice', 'currentDemand'];
            elements.forEach(id => {
                const elem = document.getElementById(id);
                elem.style.transition = 'color 0.3s';
                elem.style.color = '#00ff88';
                setTimeout(() => {
                    elem.style.color = '';
                }, 300);
            });
            
            // Update highest price region
            // updateHighestPriceRegion(); // Removed - using fixed text now
        }

        // Update highest price region display
        function updateHighestPriceRegion() {
            // ‰ΩøÁî®ÂÆûÈôÖÁöÑÂú∞Âå∫‰ª∑Ê†ºÊï∞ÊçÆ
            const regionPrices = {
                'NSW': 163,
                'QLD': 34,
                'VIC': 21,
                'SA': 403,
                'TAS': 390
            };
            
            // Find region with highest price
            let highestRegion = 'NSW';
            let highestPrice = regionPrices['NSW'];
            
            for (const [region, price] of Object.entries(regionPrices)) {
                if (price > highestPrice) {
                    highestPrice = price;
                    highestRegion = region;
                }
            }
            
            // Update both displays
            const highestPriceElement = document.getElementById('highestPriceRegion');
            if (highestPriceElement) {
                highestPriceElement.textContent = highestRegion;
            }
            
            // Update the new display in region selection layer
            const highestRegionDisplay = document.getElementById('highestPriceRegionDisplay');
            if (highestRegionDisplay) {
                highestRegionDisplay.textContent = highestRegion;
            }
            
            const highestPriceValueDisplay = document.getElementById('highestPriceValue');
            if (highestPriceValueDisplay) {
                highestPriceValueDisplay.textContent = highestPrice;
            }
        }

        // Initialize Market Chart - Simplified and Reliable Version
        function initMarketChart() {
            const container = document.getElementById('marketChart');
            if (!container) {
                // error('Market chart container not found!');
                return;
            }
            
            // Dispose existing instance if any
            if (marketChart) {
                marketChart.dispose();
            }
            
            // Wait for container to be visible
            setTimeout(() => {
                // Initialize chart
                marketChart = echarts.init(container, 'dark');
                
                // Force container to have proper dimensions
                container.style.width = '100%';
                container.style.height = '400px';
                
                // Force a reflow to apply the new dimensions
                container.offsetHeight;
            
            // Real AEMO data from AEMO.xlsx - ‰ªéAEMO.xlsxÊñá‰ª∂‰∏≠ËØªÂèñÁöÑÁúüÂÆûÊï∞ÊçÆÔºàÊØè5ÂàÜÈíü‰∏Ä‰∏™Êï∞ÊçÆÁÇπÔºâ
            aemoTimeLabels = ["00:00", "00:05", "00:10", "00:15", "00:20", "00:25", "00:30", "00:35", "00:40", "00:45", "00:50", "00:55", "01:00", "01:05", "01:10", "01:15", "01:20", "01:25", "01:30", "01:35", "01:40", "01:45", "01:50", "01:55", "02:00", "02:05", "02:10", "02:15", "02:20", "02:25", "02:30", "02:35", "02:40", "02:45", "02:50", "02:55", "03:00", "03:05", "03:10", "03:15", "03:20", "03:25", "03:30", "03:35", "03:40", "03:45", "03:50", "03:55", "04:00", "04:05", "04:10", "04:15", "04:20", "04:25", "04:30", "04:35", "04:40", "04:45", "04:50", "04:55", "05:00", "05:05", "05:10", "05:15", "05:20", "05:25", "05:30", "05:35", "05:40", "05:45", "05:50", "05:55", "06:00", "06:05", "06:10", "06:15", "06:20", "06:25", "06:30", "06:35", "06:40", "06:45", "06:50", "06:55", "07:00", "07:05", "07:10", "07:15", "07:20", "07:25", "07:30", "07:35", "07:40", "07:45", "07:50", "07:55", "08:00", "08:05", "08:10", "08:15", "08:20", "08:25", "08:30", "08:35", "08:40", "08:45", "08:50", "08:55", "09:00", "09:05", "09:10", "09:15", "09:20", "09:25", "09:30", "09:35", "09:40", "09:45", "09:50", "09:55", "10:00", "10:05", "10:10", "10:15", "10:20", "10:25", "10:30", "10:35", "10:40", "10:45", "10:50", "10:55", "11:00", "11:05", "11:10", "11:15", "11:20", "11:25", "11:30", "11:35", "11:40", "11:45", "11:50", "11:55", "12:00", "12:05", "12:10", "12:15", "12:20", "12:25", "12:30", "12:35", "12:40", "12:45", "12:50", "12:55", "13:00", "13:05", "13:10", "13:15", "13:20", "13:25", "13:30", "13:35", "13:40", "13:45", "13:50", "13:55", "14:00", "14:05", "14:10", "14:15", "14:20", "14:25", "14:30", "14:35", "14:40", "14:45", "14:50", "14:55", "15:00", "15:05", "15:10", "15:15", "15:20", "15:25", "15:30", "15:35", "15:40", "15:45", "15:50", "15:55", "16:00", "16:05", "16:10", "16:15", "16:20", "16:25", "16:30", "16:35", "16:40", "16:45", "16:50", "16:55", "17:00", "17:05", "17:10", "17:15", "17:20", "17:25", "17:30", "17:35", "17:40", "17:45", "17:50", "17:55", "18:00", "18:05", "18:10", "18:15", "18:20", "18:25", "18:30", "18:35", "18:40", "18:45", "18:50", "18:55", "19:00", "19:05", "19:10", "19:15", "19:20", "19:25", "19:30", "19:35", "19:40", "19:45", "19:50", "19:55", "20:00", "20:05", "20:10", "20:15", "20:20", "20:25", "20:30", "20:35", "20:40", "20:45", "20:50", "20:55", "21:00", "21:05", "21:10", "21:15", "21:20", "21:25", "21:30", "21:35", "21:40", "21:45", "21:50", "21:55", "22:00", "22:05", "22:10", "22:15", "22:20", "22:25", "22:30", "22:35", "22:40", "22:45", "22:50", "22:55", "23:00", "23:05", "23:10", "23:15", "23:20", "23:25", "23:30", "23:35", "23:40", "23:45", "23:50", "23:55"];
            aemoRealPriceData = [66.14, 66.04, 77.56, 80.01, 80.01, 80.01, 78.38, 66.28, 77.27, 63.98, 65.05, 64.0, 57.06, 62.87, 62.92, 65.64, 65.22, 65.23, 62.96, 65.0, 80.01, 76.94, 77.1, 65.0, 65.28, 65.3, 77.13, 65.54, 65.05, 64.66, 64.72, 64.28, 64.72, 64.69, 64.26, 64.72, 64.34, 64.33, 66.65, 65.0, 65.0, 65.08, 65.98, 65.0, 76.86, 65.15, 66.18, 76.19, 76.26, 79.95, 80.01, 80.01, 86.94, 105.79, 105.79, 130.23, 125.62, 127.49, 158.99, 158.99, 158.99, 126.29, 138.19, 158.99, 154.19, 158.99, 158.19, 120.01, 83.87, 84.79, 69.71, 68.86, -0.08, 0.01, -0.01, -8.23, -6.66, -8.19, -0.01, -6.66, 0, 0.01, -9.46, -5.84, -5.85, -5.99, 0.0, -2.65, -6.29, -6.29, -6.5, -6.46, -6.37, -8.79, -11.13, -11.25, -13.04, -11.32, -10.51, -11.63, -14.12, -12.25, -12.19, -11.72, -12.71, -11.9, -14.99, -11.98, -15.29, -15.6, -12.7, -14.99, -15.33, -18.48, -18.17, -15.46, -16.0, -17.93, -18.7, -17.51, -18.73, -18.44, -13.68, -16.0, -18.28, -19.01, -19.56, -20.0, -20.13, -18.79, -20.52, -22.73, -24.67, -20.75, -21.92, -25.09, -21.61, -21.3, -25.33, -25.94, -19.83, -21.12, -21.58, -21.14, -21.13, -25.14, -24.31, -20.0, -22.81, -24.72, -21.52, -23.94, -25.24, -22.9, -23.91, -32.19, -27.5, -27.5, -27.5, -34.11, -34.11, -24.72, -27.5, -34.11, -34.11, -34.11, -31.01, -27.5, -27.5, -27.5, -27.5, -27.5, -27.5, -27.5, -24.02, -20.27, -27.5, -27.5, -20.81, -20.1, -20.13, -20.51, -20.35, -27.5, -19.89, -18.84, -21.06, -27.5, -18.89, -12.99, -12.64, -12.26, -10.87, -12.76, -12.55, -12.42, -11.84, -3.0, -3.0, -8.96, -6.82, -6.81, 54.94, -6.19, -0.81, -0.72, -0.81, 0.45, 9.13, 16.65, 4.77, 51.86, 69.09, 83.54, 92.45, 132.77, 139.42, 136.16, 100.24, 139.83, 117.94, 114.8, 116.34, 101.53, 126.26, 120.29, 112.12, 117.51, 122.08, 132.59, 127.47, 132.84, 137.61, 129.37, 130.71, 139.68, 127.07, 161.15, 145.97, 158.68, 159.77, 149.87, 177.5, 134.17, 156.17, 160.24, 140.38, 177.7, 181.52, 131.7, 173.91, 171.39, 147.36, 146.24, 174.0, 243.2, 126.93, 158.5, 108.89, 128.97, 125.45, 106.33, 89.38, 88.05, 80.9, 87.3, 125.69, 123.79, 108.89, 108.89, 108.89, 108.89, 106.73, 106.96, 97.74, 100.01, 107.69, 105.74, 158.99, 158.99, 158.99, 158.99, 158.99, 158.99, 158.99, 158.99, 158.99, 158.99];
            aemoRealDemandData = [6944.17, 6898.47, 6893.63, 6829.3, 6850.61, 6774.74, 6759.83, 6648.21, 6669.78, 6569.73, 6617.86, 6573.83, 6479.18, 6468.57, 6466.79, 6530.03, 6436.35, 6466.99, 6438.46, 6480.32, 6391.91, 6429.17, 6460.58, 6421.28, 6443.13, 6272.65, 6341.68, 6276.72, 6274.57, 6278.81, 6241.81, 6228.63, 6242.68, 6247.2, 6195.57, 6217.48, 6210.87, 6195.27, 6197.42, 6210.22, 6210.93, 6244.7, 6276.44, 6274.01, 6295.57, 6296.73, 6314.99, 6353.57, 6340.07, 6325.78, 6427.73, 6462.66, 6537.16, 6588.73, 6552.47, 6576.69, 6635.77, 6665.0, 6732.0, 6746.01, 6799.1, 6853.33, 6969.46, 7014.85, 7087.52, 7164.67, 7161.88, 7079.85, 7092.18, 7153.41, 7111.21, 7078.06, 7047.26, 7053.51, 6980.02, 6954.91, 6998.64, 6901.06, 6878.11, 6845.43, 6794.63, 6706.81, 6580.9, 6542.29, 6439.06, 6447.79, 6580.94, 6451.57, 6312.2, 6196.7, 6189.7, 6024.56, 5891.87, 5764.17, 5675.92, 5574.41, 5437.06, 5298.3, 5304.67, 5198.75, 5073.44, 4929.02, 4854.91, 4917.83, 4876.59, 4901.98, 4874.92, 4913.56, 4909.23, 4773.02, 4775.89, 4708.02, 4725.72, 4640.68, 4478.4, 4455.44, 4513.4, 4428.34, 4369.43, 4425.16, 4391.35, 4356.77, 4375.8, 4376.23, 4304.1, 4223.98, 4182.73, 4219.16, 4357.73, 4205.29, 4243.99, 4155.65, 4174.0, 4124.9, 4218.79, 4233.37, 4218.3, 4197.21, 4146.02, 4184.5, 4150.86, 4200.1, 4148.84, 4060.27, 4064.63, 4027.7, 4062.16, 4055.0, 4064.33, 4148.36, 4143.95, 4073.54, 4071.72, 4091.67, 4104.26, 3957.83, 4044.9, 3962.61, 4046.45, 4021.29, 4077.47, 4091.37, 4106.81, 4116.55, 4093.43, 4154.6, 4189.06, 4172.79, 4327.09, 4454.43, 4481.58, 4385.69, 4507.94, 4538.22, 4771.57, 4758.78, 4753.8, 4776.51, 4938.62, 4991.94, 5110.06, 5027.95, 5078.17, 5199.79, 5292.9, 5354.01, 5436.35, 5546.75, 5787.91, 5874.7, 5981.58, 6246.98, 6364.78, 6339.58, 6457.68, 6499.84, 6667.6, 6825.92, 7021.9, 7147.29, 7254.92, 7341.2, 7526.05, 7364.37, 7477.81, 7575.31, 7730.51, 7845.58, 7941.2, 7962.68, 7892.07, 8014.79, 8033.63, 7996.21, 8033.32, 8170.29, 8129.35, 8103.97, 7977.04, 8143.95, 8140.22, 8201.66, 8159.9, 8136.33, 8146.82, 8060.84, 8090.79, 8165.4, 8184.86, 8196.96, 8200.54, 8190.62, 8174.33, 8199.12, 8068.88, 8161.38, 8066.38, 8125.4, 7979.9, 8062.75, 8012.55, 7958.27, 7975.92, 7805.3, 7864.63, 7886.33, 7878.94, 7793.18, 7755.09, 7710.03, 7768.5, 7665.61, 7565.89, 7512.26, 7617.91, 7671.08, 7538.85, 7541.03, 7483.12, 7586.36, 7578.41, 7594.6, 7600.68, 7555.02, 7407.75, 7356.12, 7444.59, 7427.32, 7431.03, 7366.29, 7356.18, 7322.61, 7310.67, 7278.75, 7208.81, 7247.65, 7286.98, 7159.5, 7244.63, 7149.35, 7162.89, 7165.12, 7161.65, 7048.02, 7082.02, 7023.69, 7116.38, 7145.64];

            // Ëé∑ÂèñÂΩìÂâçÊó∂Èó¥Âπ∂ËÆ°ÁÆóÂØπÂ∫îÁöÑÊï∞ÊçÆÁ¥¢Âºï
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            // Â∞ÜÂàÜÈíüÊï∞Âêë‰∏ãÂèñÊï¥Âà∞ÊúÄËøëÁöÑ5ÂàÜÈíü
            const roundedMinute = Math.floor(currentMinute / 5) * 5;
            // ËÆ°ÁÆóÂΩìÂâçÊó∂Èó¥ÂØπÂ∫îÁöÑÊï∞ÁªÑÁ¥¢ÂºïÔºàÊØèÂ∞èÊó∂12‰∏™ÁÇπÔºåÊØè5ÂàÜÈíü‰∏Ä‰∏™Ôºâ
            const currentTimeIndex = currentHour * 12 + (roundedMinute / 5);

            const prices = [];
            const demands = [];
            const forecastPrices = [];
            const forecastDemands = [];

            // ÈÅçÂéÜÊâÄÊúâ288‰∏™Êï∞ÊçÆÁÇπ
            for (let i = 0; i < aemoTimeLabels.length; i++) {
                if (i < currentTimeIndex) {
                    // ÂΩìÂâçÊó∂Èó¥‰πãÂâç - ÂéÜÂè≤Êï∞ÊçÆÔºåÊòæÁ§∫‰∏∫ÂÆûÁ∫ø
                    prices.push(aemoRealPriceData[i]);
                    demands.push(aemoRealDemandData[i]);
                    forecastPrices.push(null);
                    forecastDemands.push(null);
                } else if (i === currentTimeIndex) {
                    // ÂΩìÂâçÊó∂Èó¥ÁÇπ - ÂêåÊó∂‰Ωú‰∏∫ÂÆûÁ∫øÂíåËôöÁ∫øÁöÑËøûÊé•ÁÇπ
                    prices.push(aemoRealPriceData[i]);
                    demands.push(aemoRealDemandData[i]);
                    forecastPrices.push(aemoRealPriceData[i]);
                    forecastDemands.push(aemoRealDemandData[i]);
                } else {
                    // ÂΩìÂâçÊó∂Èó¥‰πãÂêé - È¢ÑÊµãÊï∞ÊçÆÔºåÊòæÁ§∫‰∏∫ËôöÁ∫ø
                    prices.push(null);
                    demands.push(null);
                    forecastPrices.push(aemoRealPriceData[i]);
                    forecastDemands.push(aemoRealDemandData[i]);
                }
            }

                // Get translations
                const getText = (key) => window.i18n ? window.i18n.getText(key) : translations.en[key];
                const translations = {
                    en: {
                        historicalPrice: 'Historical Price',
                        predictedPrice: 'Predicted Price',
                        demand: 'Demand',
                        predictedDemand: 'Predicted Demand',
                        price: 'Price ($/MWh)',
                        demandUnit: 'Demand (MW)'
                    },
                    zh: {
                        historicalPrice: 'ÂéÜÂè≤‰ª∑Ê†º',
                        predictedPrice: 'È¢ÑÊµã‰ª∑Ê†º',
                        demand: 'ÈúÄÊ±Ç',
                        predictedDemand: 'È¢ÑÊµãÈúÄÊ±Ç',
                        price: '‰ª∑Ê†º ($/MWh)',
                        demandUnit: 'ÈúÄÊ±Ç (MW)'
                    }
                };
                
                const option = {
                    backgroundColor: 'transparent',
                    tooltip: {
                        trigger: 'axis',
                        backgroundColor: 'rgba(0, 0, 0, 0.9)',
                        borderColor: '#00ff88',
                        borderWidth: 1,
                        textStyle: { color: '#fff' },
                        formatter: function(params) {
                            let result = `<div style="font-weight: bold; margin-bottom: 5px;">${params[0].axisValue}</div>`;
                            params.forEach(param => {
                                if (param.value !== null && param.value !== undefined) {
                                    const color = param.color;
                                    const value = param.seriesName.includes(getText('price')) || param.seriesName.includes('Price') 
                                        ? `$${param.value.toFixed ? param.value.toFixed(2) : param.value}` 
                                        : `${param.value.toFixed ? param.value.toFixed(0) : param.value} MW`;
                                    result += `<div>${param.marker} ${param.seriesName}: <strong>${value}</strong></div>`;
                                }
                            });
                            return result;
                        }
                    },
                    legend: {
                        data: [getText('historicalPrice'), getText('demand'), getText('predictedPrice'), getText('predictedDemand')],
                        textStyle: { color: 'rgba(255, 255, 255, 0.7)' },
                        top: 10
                    },
                    grid: {
                        left: '60',
                        right: '60',
                        bottom: '40',
                        top: '50',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        data: aemoTimeLabels,
                        axisLine: {
                            show: false  // ÈöêËóèXËΩ¥Á∫ø
                        },
                        axisLabel: {
                            color: 'rgba(255, 255, 255, 0.7)',
                            interval: 23, // ÊØè2Â∞èÊó∂ÊòæÁ§∫‰∏ÄÊ¨°ÔºàÊØè24‰∏™ÁÇπ=2Â∞èÊó∂ÔºåÊòæÁ§∫Ôºö00:00, 02:00, 04:00, 06:00, 08:00, 10:00, 12:00, 14:00, 16:00, 18:00, 20:00, 22:00Ôºâ
                            fontSize: 12,
                            rotate: 0
                        },
                        splitLine: { show: false }
                    },
                    yAxis: [
                        {
                            type: 'value',
                            name: getText('price'),
                            nameTextStyle: {
                                color: 'rgba(255, 255, 255, 0.7)',
                                fontSize: 12
                            },
                            position: 'left',
                            scale: true,  // Ëá™Âä®Áº©Êîæ
                            min: 'dataMin',  // ‰ªéÊï∞ÊçÆÊúÄÂ∞èÂÄºÂºÄÂßã
                            max: 'dataMax',  // Âà∞Êï∞ÊçÆÊúÄÂ§ßÂÄºÁªìÊùü
                            axisLine: {
                                show: false  // ÈöêËóèYËΩ¥Á∫ø
                            },
                            axisLabel: {
                                color: 'rgba(255, 255, 255, 0.7)',
                                formatter: '${value}'
                            },
                            splitLine: {
                                show: true,
                                lineStyle: {
                                    color: 'rgba(255, 255, 255, 0.05)',  // Èôç‰ΩéÁΩëÊ†ºÁ∫øÈÄèÊòéÂ∫¶
                                    type: 'dashed',
                                    width: 1
                                }
                            }
                        },
                        {
                            type: 'value',
                            name: getText('demandUnit'),
                            nameTextStyle: {
                                color: 'rgba(255, 255, 255, 0.7)',
                                fontSize: 12
                            },
                            position: 'right',
                            scale: true,  // Ëá™Âä®Áº©Êîæ
                            min: 'dataMin',  // ‰ªéÊï∞ÊçÆÊúÄÂ∞èÂÄºÂºÄÂßã
                            max: 'dataMax',  // Âà∞Êï∞ÊçÆÊúÄÂ§ßÂÄºÁªìÊùü
                            axisLine: {
                                show: false  // ÈöêËóèYËΩ¥Á∫ø
                            },
                            axisLabel: {
                                color: 'rgba(255, 255, 255, 0.7)',
                                formatter: '{value} MW'
                            },
                        splitLine: { show: false }
                    }
                ],
                    series: [
                        {
                            name: getText('historicalPrice'),
                            type: 'line',
                            data: prices,
                            smooth: true,
                            symbol: 'circle',
                            symbolSize: 4,
                            lineStyle: {
                                color: '#00ff88',
                                width: 3
                            },
                            itemStyle: {
                                color: '#00ff88'
                            },
                            areaStyle: {
                                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                    { offset: 0, color: 'rgba(0, 255, 136, 0.3)' },
                                    { offset: 1, color: 'rgba(0, 255, 136, 0.05)' }
                                ])
                            },
                            markLine: {
                                symbol: 'none',
                                silent: true,
                                data: [
                                    {
                                        xAxis: currentTimeIndex,
                                        lineStyle: {
                                            color: 'rgba(255, 255, 255, 0.4)',
                                            type: 'dashed',
                                            width: 2
                                        },
                                        label: {
                                            show: false
                                        }
                                    }
                                ]
                            }
                        },
                        {
                            name: getText('demand'),
                            type: 'line',
                            yAxisIndex: 1,
                            data: demands,
                            smooth: true,
                            symbol: 'circle',
                            symbolSize: 4,
                            lineStyle: { 
                                color: '#ffd700', 
                                width: 2
                            },
                            itemStyle: {
                                color: '#ffd700'
                            }
                        },
                        {
                            name: getText('predictedPrice'),
                            type: 'line',
                            data: forecastPrices,
                            smooth: true,
                            symbol: 'circle',
                            symbolSize: 4,
                            lineStyle: { 
                                color: '#00ff88', 
                                width: 2,
                                type: 'dashed'
                            },
                            itemStyle: {
                                color: '#00ff88'
                            },
                            areaStyle: {
                                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                    { offset: 0, color: 'rgba(0, 255, 136, 0.15)' },
                                    { offset: 1, color: 'rgba(0, 255, 136, 0.02)' }
                                ])
                            }
                        },
                        {
                            name: getText('predictedDemand'),
                            type: 'line',
                            yAxisIndex: 1,
                            data: forecastDemands,
                            smooth: true,
                            symbol: 'circle',
                            symbolSize: 4,
                            lineStyle: {
                                color: '#ffd700',
                                width: 2,
                                type: 'dashed'
                            },
                            itemStyle: {
                                color: '#ffd700'
                            }
                        }
                    ]
                };

                // Apply configuration
                marketChart.setOption(option);
                
                // Force resize after setting option
                setTimeout(() => {
                    if (marketChart && typeof marketChart.resize === 'function') {
                        marketChart.resize();
                    }
                }, 100);
                
                // Handle resize
                window.addEventListener('resize', () => {
                    if (marketChart && typeof marketChart.resize === 'function') {
                        if (marketChart && typeof marketChart.resize === 'function') {
                        marketChart.resize();
                    }
                    }
                });
                
                // Force initial resize
                setTimeout(() => {
                    if (marketChart && typeof marketChart.resize === 'function') {
                        marketChart.resize();
                    }
                }, 100);


                // Êï∞ÊçÆÂàùÂßãÂåñÂÆåÊàêÂêéÁ´ãÂç≥Êõ¥Êñ∞‰ª∑Ê†ºÂç°ÁâáÔºåÈÅøÂÖçÊòæÁ§∫ÈªòËÆ§ÂÄº
                if (typeof updateRealtimeData === 'function') {
                    updateRealtimeData();
                }

                // AEMOÊï∞ÊçÆÂ∞±Áª™ÂêéÂêØÂä®AIÂàÜÊûêÔºàÁã¨Á´ã‰∫é switchOperationModeÔºåÁ°Æ‰øùÈù¢ÊùøÊúâÊï∞ÊçÆÔºâ
                if (typeof startAICustodyAnalysis === 'function') {
                    startAICustodyAnalysis();
                }
            }, 50); // Small delay to ensure container is ready
        }

        // Initialize Australian States Map 
        function initMap() {
            const container = document.getElementById('australiaMap');
            if (!container) {
                return; // australiaMap not in current layout
                return;
            }
            
            try {
                mapChart = echarts.init(container);
            } catch (error) {
                // error('Failed to initialize mapChart:', error);
                return;
            }
            
            // Define Australian states with proper coordinates
            const australianStates = [
                // Main states
                { name: 'NSW', center: [147, -32], color: '#00ff88', radius: 25, deviceCount: 120 },
                { name: 'VIC', center: [144, -37], color: '#00aaff', radius: 20, deviceCount: 100 },
                { name: 'QLD', center: [145, -22], color: '#8A4AFF', radius: 28, deviceCount: 90 },
                { name: 'WA', center: [122, -26], color: '#ffaa00', radius: 30, deviceCount: 70 },
                { name: 'SA', center: [135, -30], color: '#9c27b0', radius: 22, deviceCount: 60 },
                { name: 'TAS', center: [147, -42], color: '#4caf50', radius: 12, deviceCount: 30 },
                { name: 'NT', center: [133, -19], color: '#2196f3', radius: 20, deviceCount: 20 },
                { name: 'ACT', center: [149, -35.3], color: '#ff9800', radius: 8, deviceCount: 10 }
            ];

            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'item',
                    backgroundColor: 'rgba(0, 0, 0, 0.9)',
                    borderColor: 'rgba(0, 255, 136, 0.5)',
                    borderWidth: 1,
                    textStyle: { color: '#fff', fontSize: 12 },
                    formatter: function(params) {
                        if (params.seriesType === 'scatter') {
                            if (params.seriesIndex === 1) {
                                // Device points
                                const getStatusText = (status) => {
                                    if (!window.i18n) {
                                        const statusMap = {
                                            'inactive': 'ÂæÖÊú∫',
                                            'active': 'ÊøÄÊ¥ª',
                                            'charging': 'ÂÖÖÁîµ‰∏≠',
                                            'discharging': 'ÊîæÁîµ‰∏≠',
                                            'offline': 'Á¶ªÁ∫ø'
                                        };
                                        return statusMap[status] || status;
                                    }
                                    
                                    const statusKeys = {
                                        'inactive': 'inactive',
                                        'active': 'active',
                                        'charging': 'charging',
                                        'discharging': 'discharging',
                                        'offline': 'offline'
                                    };
                                    
                                    return window.i18n.getText(statusKeys[status]) || status;
                                };
                                const deviceText = window.i18n ? window.i18n.getText('device') : 'ËÆæÂ§á';
                                const statusText = window.i18n ? window.i18n.getText('status') : 'Áä∂ÊÄÅ';
                                const regionText = window.i18n ? window.i18n.getText('region') : 'Âå∫Âüü';
                                
                                return `<div style="padding: 12px; background: rgba(0,0,0,0.8); border-radius: 10px; color: white; border: 1px solid rgba(255,255,255,0.2);">
                                    <div style="color: #00ff88; font-weight: 600; font-size: 14px; margin-bottom: 8px;">${deviceText} ${params.data.id}</div>
                                    <div style="margin: 4px 0; font-size: 13px; display: flex; justify-content: space-between;">
                                        <span style="color: rgba(255,255,255,0.8);">${statusText}:</span> 
                                        <span style="color: #fff; font-weight: 500;">${getStatusText(params.data.status)}</span>
                                    </div>
                                    <div style="font-size: 13px; display: flex; justify-content: space-between;">
                                        <span style="color: rgba(255,255,255,0.8);">${regionText}:</span> 
                                        <span style="color: #fff; font-weight: 500;">${params.data.region}</span>
                                    </div>
                                </div>`;
                            } else if (params.seriesIndex === 0) {
                                // State centers
                                const stateText = window.i18n ? window.i18n.getText('state') : 'Â∑û';
                                const deviceCountText = window.i18n ? window.i18n.getText('deviceCount') : 'ËÆæÂ§áÊï∞Èáè';
                                const statusText = window.i18n ? window.i18n.getText('status') : 'Áä∂ÊÄÅ';
                                const normalText = window.i18n ? window.i18n.getText('normalOperation') : 'Ê≠£Â∏∏ËøêË°å';
                                
                                return `<div style="padding: 12px; background: rgba(0,0,0,0.8); border-radius: 10px; color: white; border: 1px solid rgba(255,255,255,0.2);">
                                    <div style="color: ${params.data.color}; font-weight: 600; font-size: 14px; margin-bottom: 8px;">${params.data.name} ${stateText}</div>
                                    <div style="margin: 4px 0; font-size: 13px; display: flex; justify-content: space-between;">
                                        <span style="color: rgba(255,255,255,0.8);">${deviceCountText}:</span> 
                                        <span style="color: #fff; font-weight: 500;">${params.data.deviceCount}</span>
                                    </div>
                                    <div style="font-size: 13px; display: flex; justify-content: space-between;">
                                        <span style="color: rgba(255,255,255,0.8);">${statusText}:</span> 
                                        <span style="color: #00ff88; font-weight: 500;">${normalText}</span>
                                    </div>
                                </div>`;
                            }
                        }
                        return '';
                    }
                },
                graphic: [],
                xAxis: {
                    type: 'value',
                    min: 110,
                    max: 160,
                    show: false
                },
                yAxis: {
                    type: 'value',
                    min: -45,
                    max: -10,
                    show: false
                },
                grid: {
                    left: 0,
                    right: 0,
                    top: 0,
                    bottom: 0
                },
                series: [
                    // Region centers with glowing effect
                    {
                        name: 'States',
                        type: 'scatter',
                        data: australianStates.map(state => ({
                            value: state.center,
                            name: state.name,
                            color: state.color,
                            deviceCount: state.deviceCount,
                            symbolSize: state.radius * 2
                        })),
                        symbol: 'circle',
                        symbolSize: function(value, params) {
                            return params.data.symbolSize;
                        },
                        label: {
                            show: true,
                            formatter: function(params) {
                                return params.data.name;
                            },
                            position: 'inside',
                            color: '#000',
                            fontSize: 14,
                            fontWeight: 'bold'
                        },
                        itemStyle: {
                            color: function(params) {
                                return {
                                    type: 'radial',
                                    x: 0.5,
                                    y: 0.5,
                                    r: 0.5,
                                    colorStops: [
                                        { offset: 0, color: params.data.color },
                                        { offset: 0.7, color: params.data.color },
                                        { offset: 1, color: 'rgba(255, 255, 255, 0.3)' }
                                    ]
                                };
                            },
                            opacity: 0.8,
                            borderColor: function(params) {
                                return params.data.color;
                            },
                            borderWidth: 3,
                            shadowBlur: 20,
                            shadowColor: function(params) {
                                return params.data.color;
                            }
                        },
                        emphasis: {
                            scale: 1.1,
                            label: {
                                fontSize: 16
                            },
                            itemStyle: {
                                opacity: 1,
                                shadowBlur: 30
                            }
                        },
                        z: 1
                    },
                    // Device network points
                    {
                        name: 'Devices',
                        type: 'scatter',
                        data: deviceLocations
                            .filter(device => device.status !== 'hidden')  // ËøáÊª§ÊéâhiddenÁä∂ÊÄÅÁöÑËÆæÂ§á
                            .map(device => ({
                                value: device.value,
                                id: device.id,
                                status: device.status,
                                region: device.region
                            })),
                        symbolSize: function(value, params) {
                            const status = params.data.status;
                            if (status === 'active' || status === 'charging' || status === 'discharging') {
                                return 8;
                            }
                            return status === 'offline' ? 3 : 5;
                        },
                        itemStyle: {
                            color: function(params) {
                                const status = params.data.status;
                                switch (status) {
                                    case 'charging': 
                                    case 'active':
                                        return currentOperation === 'charge' ? '#00ff88' : '#FFD700';
                                    case 'discharging': 
                                        return '#FFD700';
                                    case 'offline': 
                                        return 'rgba(255, 255, 255, 0.2)';
                                    default: 
                                        return 'rgba(255, 255, 255, 0.5)';
                                }
                            },
                            borderColor: 'rgba(255, 255, 255, 0.3)',
                            borderWidth: 1,
                            shadowBlur: function(params) {
                                const status = params.data.status;
                                return (status === 'active' || status === 'charging' || status === 'discharging') ? 10 : 3;
                            },
                            shadowColor: function(params) {
                                const status = params.data.status;
                                switch (status) {
                                    case 'charging':
                                    case 'active':
                                        return currentOperation === 'charge' ? 'rgba(0, 255, 136, 0.8)' : 'rgba(255, 215, 0, 0.8)';
                                    case 'discharging':
                                        return 'rgba(255, 215, 0, 0.8)';
                                    default:
                                        return 'rgba(255, 255, 255, 0.3)';
                                }
                            }
                        },
                        emphasis: {
                            scale: 1.5,
                            itemStyle: {
                                shadowBlur: 20,
                                shadowColor: 'rgba(0, 255, 136, 0.9)'
                            }
                        },
                        animation: true,
                        animationDuration: 800,
                        animationEasing: 'cubicOut',
                        z: 2
                    }
                ]
            };

            try {
                mapChart.setOption(option);
            } catch (error) {
                // error('Failed to set mapChart option:', error);
                return;
            }
            
            // Update status statistics
            const nswDevicesBeforeStats = deviceLocations.filter(d => d.region === 'NSW');

            updateMapStatistics();

            window.addEventListener('resize', throttle(() => {
                if (mapChart && typeof mapChart.resize === 'function') {
                    mapChart.resize();
                }
            }, 250));
        }
        

        // Generate Australian state device locations (exactly 500 devices)
        function generateDeviceLocations() {
            const locations = [];
            
            const australianStates = [
                { 
                    center: [147, -32], 
                    weight: 120, 
                    name: 'NSW', 
                    spread: 4,
                    cities: ['Sydney', 'Newcastle', 'Wollongong', 'Central Coast', 'Coffs Harbour']
                },
                { 
                    center: [144, -37], 
                    weight: 100, 
                    name: 'VIC', 
                    spread: 3,
                    cities: ['Melbourne', 'Geelong', 'Ballarat', 'Bendigo', 'Shepparton']
                },
                { 
                    center: [145, -22], 
                    weight: 90, 
                    name: 'QLD', 
                    spread: 6,
                    cities: ['Brisbane', 'Gold Coast', 'Townsville', 'Cairns', 'Sunshine Coast']
                },
                { 
                    center: [122, -26], 
                    weight: 70, 
                    name: 'WA', 
                    spread: 8,
                    cities: ['Perth', 'Fremantle', 'Bunbury', 'Albany', 'Kalgoorlie']
                },
                { 
                    center: [135, -30], 
                    weight: 60, 
                    name: 'SA', 
                    spread: 4,
                    cities: ['Adelaide', 'Mount Gambier', 'Whyalla', 'Murray Bridge', 'Port Lincoln']
                },
                { 
                    center: [147, -42], 
                    weight: 30, 
                    name: 'TAS', 
                    spread: 2,
                    cities: ['Hobart', 'Launceston', 'Devonport', 'Burnie', 'Ulverstone']
                },
                { 
                    center: [133, -19], 
                    weight: 20, 
                    name: 'NT', 
                    spread: 5,
                    cities: ['Darwin', 'Alice Springs', 'Katherine', 'Palmerston', 'Tennant Creek']
                },
                { 
                    center: [149, -35.3], 
                    weight: 10, 
                    name: 'ACT', 
                    spread: 0.5,
                    cities: ['Canberra', 'Queanbeyan', 'Belconnen', 'Tuggeranong', 'Gungahlin']
                }
            ];
            
            // Calculate total weight for distribution
            const totalWeight = australianStates.reduce((sum, state) => sum + state.weight, 0);
            
            // Generate exactly 500 devices
            for (let i = 0; i < 500; i++) {
                // Select state based on weight distribution
                let randomWeight = Math.random() * totalWeight;
                let selectedState = australianStates[0];
                
                for (const state of australianStates) {
                    randomWeight -= state.weight;
                    if (randomWeight <= 0) {
                        selectedState = state;
                        break;
                    }
                }
                
                // Generate random point within state spread
                const angle = Math.random() * 2 * Math.PI;
                const distance = Math.random() * selectedState.spread;
                
                const longitude = selectedState.center[0] + distance * Math.cos(angle);
                const latitude = selectedState.center[1] + distance * Math.sin(angle);
                
                // Assign initial status based on region's actual state
                let initialStatus = 'hidden'; // Default: not visible on map
                const rand = Math.random();

                // Ëé∑ÂèñËÆæÂ§áÊâÄÂú®Âú∞Âå∫ÁöÑÁä∂ÊÄÅ
                const regionStatus = regionData[selectedState.name] ? regionData[selectedState.name].status : 'none';

                // Ê†πÊçÆÂú∞Âå∫Áä∂ÊÄÅÂÜ≥ÂÆöËÆæÂ§áÁä∂ÊÄÅ
                if (regionStatus === 'waitingExecution' || regionStatus === 'none') {
                    // Á≠âÂæÖÊâßË°å‰∏≠ÊàñÊó†Áä∂ÊÄÅÔºöËÆæÂ§á‰∏çÊòæÁ§∫ÔºàÊâÄÊúâÁä∂ÊÄÅ‰∏∫0Ôºâ
                    initialStatus = 'hidden';
                } else {
                    // ÊúâÊìç‰ΩúÁä∂ÊÄÅÁöÑÂú∞Âå∫ÔºàÂÖÖÁîµ/ÊîæÁîµÔºâÔºöÊ≠£Â∏∏ÂàÜÈÖçÁä∂ÊÄÅ
                    if (rand < 0.05) {
                        initialStatus = 'offline';  // 5% offline
                    } else if (rand < 0.12 && (regionStatus === 'autoDischarge' || regionStatus === 'manualDischarge')) {
                        initialStatus = 'discharging';  // 7% discharging (‰ªÖÂú®ÊîæÁîµÂú∞Âå∫)
                    } else if (rand < 0.18 && (regionStatus === 'autoCharge' || regionStatus === 'manualCharge')) {
                        initialStatus = 'charging';  // 6% charging (‰ªÖÂú®ÂÖÖÁîµÂú∞Âå∫)
                    } else {
                        initialStatus = 'inactive';  // ÂÖ∂‰Ωô‰∏∫inactive
                    }
                }

                // Select random city from state
                const randomCity = selectedState.cities[Math.floor(Math.random() * selectedState.cities.length)];

                locations.push({
                    value: [longitude, latitude],
                    id: i,
                    status: initialStatus,
                    region: selectedState.name,
                    city: randomCity
                });
            }
            
            return locations;
        }

        // Interactive functions with proper state management and confirmation
        function handleCharge() {
            
            // Á°Æ‰øù currentOperation ÊòØ null ËÄå‰∏çÊòØ undefined ÊàñÂÖ∂‰ªñÂÄº
            if (currentOperation === null || currentOperation === undefined) {
                // Ê≤°ÊúâÂΩìÂâçÊìç‰ΩúÔºåÂèØ‰ª•ÂºÄÂßãÂÖÖÁîµ
                showOperationConfirmation('charge');
            } else if (currentOperation === 'charge') {
                // ÂΩìÂâçÊ≠£Âú®ÂÖÖÁîµÔºåÊòæÁ§∫ÂÅúÊ≠¢Á°ÆËÆ§
                showStopConfirmation();
            } else if (currentOperation === 'discharge') {
                // Ê≠£Âú®ÊîæÁîµÊó∂‰∏çËÉΩÂÖÖÁîµ
                return;
            } else {
                // Êú™Áü•Áä∂ÊÄÅÔºåÈáçÁΩÆÂπ∂ÊòæÁ§∫ÂÖÖÁîµÁ°ÆËÆ§
                currentOperation = null;
                showOperationConfirmation('charge');
            }
        }
        
        // Â∞ÜÂáΩÊï∞Êö¥Èú≤Âà∞ÂÖ®Â±Ä‰ΩúÁî®Âüü
        window.handleCharge = handleCharge;

        function handleDischarge() {
            
            // Á°Æ‰øù currentOperation ÊòØ null ËÄå‰∏çÊòØ undefined ÊàñÂÖ∂‰ªñÂÄº
            if (currentOperation === null || currentOperation === undefined) {
                // Ê≤°ÊúâÂΩìÂâçÊìç‰ΩúÔºåÂèØ‰ª•ÂºÄÂßãÊîæÁîµ
                showOperationConfirmation('discharge');
            } else if (currentOperation === 'discharge') {
                // ÂΩìÂâçÊ≠£Âú®ÊîæÁîµÔºåÊòæÁ§∫ÂÅúÊ≠¢Á°ÆËÆ§
                showStopConfirmation();
            } else if (currentOperation === 'charge') {
                // Ê≠£Âú®ÂÖÖÁîµÊó∂‰∏çËÉΩÊîæÁîµ
                return;
            } else {
                // Êú™Áü•Áä∂ÊÄÅÔºåÈáçÁΩÆÂπ∂ÊòæÁ§∫ÊîæÁîµÁ°ÆËÆ§
                currentOperation = null;
                showOperationConfirmation('discharge');
            }
        }
        
        // Â∞ÜÂáΩÊï∞Êö¥Èú≤Âà∞ÂÖ®Â±Ä‰ΩúÁî®Âüü
        window.handleDischarge = handleDischarge;
        

        // Êñ∞ÁöÑÊìç‰ΩúÂêØÂä®ÂáΩÊï∞
        function startOperation(operationType) {

            // ÈáçÁΩÆÂºπÁ™óÂÖ≥Èó≠Ê†áÂøó
            window.deviceResponseModalClosed = false;
            
            // ËÆæÁΩÆÂΩìÂâçÊìç‰Ωú
            currentOperation = operationType;

            // Á¥ØÁßØ‰ªäÊó•ÂÖÖÊîæÁîµÊï∞ÊçÆÔºàÂü∫‰∫éÂΩìÂâç SOC ‚Üí ÁõÆÊ†á SOC ËÆ°ÁÆóÔºâ
            accumulateTodayData(operationType);

            // Á°Æ‰øùÊúâÈÄâ‰∏≠ÁöÑÂú∞Âå∫ÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàôÈªòËÆ§ÈÄâÊã©NSW
            if (!selectedMainRegion) {
                selectedMainRegion = 'NSW';
                // Êõ¥Êñ∞UIÊòæÁ§∫
                const nswTab = document.querySelector('.region-select-tab[data-region="NSW"]');
                if (nswTab) {
                    selectMainRegion('NSW', nswTab);
                }
            }
            
            // Êõ¥Êñ∞ÂΩìÂâçÂú∞Âå∫ÁöÑÊìç‰ΩúÁä∂ÊÄÅ
            updateRegionOperationStatus(selectedMainRegion, operationType === 'charge' ? 'charging' : 'discharging');
            
            // Êõ¥Êñ∞regionData‰∏≠ÁöÑÁä∂ÊÄÅ‰ª•Á°Æ‰øùÊòæÁ§∫Ê≠£Á°Æ
            if (regionData[selectedMainRegion]) {
                const isAuto = currentOperationMode === 'auto';
                if (operationType === 'charge') {
                    regionData[selectedMainRegion].status = isAuto ? 'autoCharge' : 'manualCharge';
                } else if (operationType === 'discharge') {
                    regionData[selectedMainRegion].status = isAuto ? 'autoDischarge' : 'manualDischarge';
                }
                
                // ‰∏çÂú®ËøôÈáåÊõ¥Êñ∞ÁîµÁ´ôÁÆ°ÁêÜÊòæÁ§∫ÔºåÂõ†‰∏∫‰∏ãÈù¢ÁöÑ‰ª£Á†Å‰ºöËÆæÁΩÆÊ≠£Á°ÆÁöÑ"ÂÖÖÁîµ‰∏≠"/"ÊîæÁîµ‰∏≠"Áä∂ÊÄÅ
                // updatePowerStationStatus(selectedMainRegion, regionData[selectedMainRegion].status);
            }
            
            // Êõ¥Êñ∞Âú∞Âå∫Áä∂ÊÄÅÊåáÁ§∫Âô®
            updateRegionStatusIndicators();
            
            // Êõ¥Êñ∞Âú∞Âå∫Áä∂ÊÄÅÊòæÁ§∫
            updateRegionStatusDisplay();
            
            // Á´ãÂç≥Êõ¥Êñ∞‰ª∑Ê†ºÂúÜÂúàÈ¢úËâ≤
            updatePriceCircleColor();
            
            // ‰∏çÂÜçÊõ¥Êñ∞ÁîµÁ´ôÁÆ°ÁêÜÊ†áÈ¢òÁöÑÁä∂ÊÄÅÊñáÂ≠ó - ÊåâÁî®Êà∑Ë¶ÅÊ±ÇÁßªÈô§
            // const statusText = document.getElementById('regionStatusText');
            // if (statusText) {
            //     if (operationType === 'charge') {
            //         statusText.textContent = window.i18n ? window.i18n.getText('charging') : 'ÂÖÖÁîµ‰∏≠';
            //         statusText.style.color = '#00ff88';
            //         statusText.style.background = 'rgba(0, 255, 136, 0.1)';
            //         statusText.style.border = '1px solid rgba(0, 255, 136, 0.3)';
            //         statusText.style.display = 'inline-block';
            //     } else if (operationType === 'discharge') {
            //         statusText.textContent = window.i18n ? window.i18n.getText('discharging') : 'ÊîæÁîµ‰∏≠';
            //         statusText.style.color = '#FFC107';
            //         statusText.style.background = 'rgba(255, 193, 7, 0.1)';
            //         statusText.style.border = '1px solid rgba(255, 193, 7, 0.3)';
            //         statusText.style.display = 'inline-block';
            //     }
            // }
            
            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            updateButtonsForOperation(operationType);

            // ÂàáÊç¢Âà∞Âú∞ÂõæËßÜÂõæ
            switchPanel('map');

            // Á´ãÂç≥ÂêØÂä®ËÆæÂ§áÂä®Áîª(‰∏çÈúÄË¶ÅÂª∂Ëøü,ËÆ©startDeviceAnimationÁªü‰∏ÄÂ§ÑÁêÜÂàùÂßãÂåñ)
            startDeviceAnimation();
            
            // Ê∑ªÂä†Â§áÁî®ÂÆöÊó∂Âô®ÔºåÁ°Æ‰øùÁªüËÆ°ÂºπÁ™óÊòæÁ§∫ÔºàÂ¶ÇÊûúÂä®ÁîªÊú™Ê≠£Â∏∏ÂÆåÊàêÔºâ
            // ËÆæÁΩÆ‰∏∫10ÁßíÂêéÊòæÁ§∫ÔºåÊ≠£Â∏∏ÊÉÖÂÜµ‰∏ãÂä®Áîª‰ºöÂú®Á∫¶13ÁßíÂÜÖÂÆåÊàê
            if (operationType === 'discharge' || operationType === 'charge') {
                const fallbackTimer = setTimeout(() => {
                    // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÊòæÁ§∫‰∫ÜÁªüËÆ°ÂºπÁ™óÔºåÂπ∂‰∏îÊìç‰ΩúÊ≤°ÊúâË¢´ÊâãÂä®ÂÅúÊ≠¢
                    const modal = document.getElementById('deviceResponseModal');
                    const executingCount = parseInt(document.getElementById('executingDevices')?.textContent || '0');
                    const currentProgress = executingCount === 0 ? 100 : Math.floor((activatedDevices / totalDevices) * 100);
                    
                    // Âè™ÊúâÂΩìÊìç‰Ωú‰ªçÂú®ËøõË°å‰∏≠„ÄÅÂºπÁ™óÊú™ÊòæÁ§∫„ÄÅ‰∏îËøõÂ∫¶ËææÂà∞100%Êó∂ÊâçÊòæÁ§∫
                    if (modal && modal.style.display === 'none' && currentOperation && currentOperation === operationType && currentProgress >= 100) {
                        showOperationStatistics();
                    } else if (currentProgress < 100) {
                    }
                }, 10000); // 10ÁßíÂêéËß¶Âèë
                
                // ‰øùÂ≠òÂÆöÊó∂Âô®ÂºïÁî®Ôºå‰ª•‰æøÂú®ÂÅúÊ≠¢Êìç‰ΩúÊó∂Ê∏ÖÈô§
                window.operationFallbackTimer = fallbackTimer;
            }
        }
        
        // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
        function updateButtonsForOperation(operationType) {
            const chargeBtn = document.getElementById('chargeBtn');
            const dischargeBtn = document.getElementById('dischargeBtn');
            const actionButtons = document.querySelector('.action-buttons');
            
            if (operationType === 'charge' || operationType === 'discharge') {
                if (currentOperationMode === 'auto') {
                    // Ëá™Âä®Ê®°ÂºèÔºöÈöêËóèÊåâÈíÆ
                    chargeBtn.style.display = 'none';
                    dischargeBtn.style.display = 'none';
                } else {
                    // ÊâãÂä®Ê®°ÂºèÔºöÈöêËóèÊåâÈíÆ
                    chargeBtn.style.display = 'none';
                    dischargeBtn.style.display = 'none';
                }
            }
        }

        // ÂÅúÊ≠¢Á°ÆËÆ§ÂºπÁ™ó
        function showStopConfirmation() {
            // ‰ΩøÁî®Ê†áÂáÜÁöÑÂÅúÊ≠¢Á°ÆËÆ§ÂºπÁ™óÔºå‰∏çÊòæÁ§∫È¢ÑËÆ°Êî∂Áõä
            showStopConfirmationModal();
        }
        
        // ÂÅúÊ≠¢Êìç‰Ωú
        function stopOperation() {
            
            // ÂÅúÊ≠¢Âä®Áîª
            if (mapAnimationInterval) {
                clearInterval(mapAnimationInterval);
            }
            
            // ‰øùÂ≠òÂÅúÊ≠¢ÂâçÁöÑÁä∂ÊÄÅÔºåÁî®‰∫éÂà§Êñ≠ÊòØÂê¶ÈúÄË¶ÅËÆæÁΩÆ‰∏∫Á≠âÂæÖÊâßË°å‰∏≠
            const currentStatus = regionData[selectedMainRegion] ? regionData[selectedMainRegion].status : 'none';

            // ÈáçÁΩÆÂΩìÂâçÊìç‰ΩúÁä∂ÊÄÅ
            currentOperation = null;
            
            // ÈáçÁΩÆÊåâÈíÆÁä∂ÊÄÅ
            resetButtons();
            
            // ÊÅ¢Â§çÂ§ßÂúÜÊòæÁ§∫‰ª∑Ê†º
            const priceDisplay = document.getElementById('priceDisplay');
            const stopDisplay = document.getElementById('stopDisplay');
            if (priceDisplay) priceDisplay.style.display = 'block';
            if (stopDisplay) {
                stopDisplay.style.display = 'none';
                stopDisplay.style.opacity = '0';
            }
            
            // Êõ¥Êñ∞Âú∞Âå∫Áä∂ÊÄÅ
            if (regionData[selectedMainRegion]) {
                // Â¶ÇÊûúÊòØËá™Âä®Ê®°ÂºèÊìç‰ΩúÔºåÂÅúÊ≠¢ÂêéÂèò‰∏∫Á≠âÂæÖÊâßË°å‰∏≠
                if (currentStatus === 'autoCharge' || currentStatus === 'autoDischarge') {
                    regionData[selectedMainRegion].status = 'waitingExecution';
                    updatePowerStationStatus(selectedMainRegion, 'waitingExecution');
                } else {
                    // ÊâãÂä®Ê®°ÂºèÊìç‰ΩúÔºåÂÅúÊ≠¢ÂêéÂèò‰∏∫none
                    regionData[selectedMainRegion].status = 'none';
                    updatePowerStationStatus(selectedMainRegion, 'none');
                }
            }
            
            // Êõ¥Êñ∞Âú∞Âå∫Áä∂ÊÄÅÊåáÁ§∫Âô®
            updateRegionStatusIndicators();
            
            // Êõ¥Êñ∞Âú∞Âå∫Áä∂ÊÄÅÊòæÁ§∫
            updateRegionStatusDisplay();
            
            // Êõ¥Êñ∞Â§ßÂúÜÊòæÁ§∫Áä∂ÊÄÅ
            updateCircleStatusDisplay();
            
            // Á°Æ‰øùÊåâÈíÆ‰∫ã‰ª∂Â§ÑÁêÜÂô®Ê≠£Á°ÆÁªëÂÆö
            setTimeout(() => {
                const chargeBtn = document.getElementById('chargeBtn');
                const dischargeBtn = document.getElementById('dischargeBtn');
                if (chargeBtn) {
                    chargeBtn.onclick = handleCharge;
                }
                if (dischargeBtn) {
                    dischargeBtn.onclick = handleDischarge;
                }
            }, 100);
            
            // ÊòæÁ§∫Êìç‰ΩúÁªüËÆ°
            setTimeout(() => {
                showOperationStatistics();
            }, 200);
        }

        // ÈáçÁΩÆÁ°ÆËÆ§ÂºπÁ™óÂÜÖÂÆπÈÅøÂÖçÂ∏ÉÂ±ÄÊ∑∑‰π±
        function resetConfirmationModal() {
            const confirmModal = document.getElementById('confirmationModal');
            if (!confirmModal) return;
            
            // ÂÖ≥Èó≠Âπ∂ÈáçÁΩÆÂºπÁ™ó
            confirmModal.classList.remove('show');
            confirmModal.style.display = 'none';
            confirmModal.style.opacity = '0';
            
            // ÁßªÈô§‰πãÂâçÂä®ÊÄÅÊ∑ªÂä†ÁöÑÊî∂ÁõäË°å
            const confirmInfoGrid = document.getElementById('confirmInfoGrid');
            if (confirmInfoGrid) {
                // ÁßªÈô§ÊâÄÊúâÂä®ÊÄÅÊ∑ªÂä†ÁöÑË°åÔºàÂåÖÊã¨‰ªª‰ΩïÂåÖÂê´È¢ÑËÆ°Êî∂ÁõäÁöÑË°åÔºâ
                const dynamicRows = confirmInfoGrid.querySelectorAll('div[style*="margin-top"]');
                dynamicRows.forEach(row => row.remove());
                
                // È¢ùÂ§ñÊ£ÄÊü•ÔºöÁßªÈô§‰ªª‰ΩïÂåÖÂê´È¢ÑËÆ°Êî∂ÁõäÁöÑÂÖÉÁ¥†
                const profitElements = confirmInfoGrid.querySelectorAll('[data-i18n="estimatedProfit"]');
                profitElements.forEach(element => {
                    const parentRow = element.closest('div[style*="flex"]');
                    if (parentRow && parentRow.parentElement === confirmInfoGrid) {
                        parentRow.remove();
                    }
                });
            }
            
            // ÈáçÁΩÆÊâÄÊúâ‰ø°ÊÅØÈ°π‰∏∫ÂèØËßÅ
            const allInfoItems = confirmModal.querySelectorAll('.modal-info-item');
            allInfoItems.forEach(item => {
                item.style.display = 'flex';
                item.style.flexDirection = 'column';
            });
        }

        // Show operation confirmation modal
        function showOperationConfirmation(operationType) {
            pendingOperation = operationType;
            
            // ÈáçÁΩÆÂºπÁ™óÂÜÖÂÆπÈÅøÂÖçÂ∏ÉÂ±ÄÊ∑∑‰π±
            resetConfirmationModal();
            
            // Store current panel state before showing confirmation
            const activePanel = document.querySelector('.panel-content.active');
            if (activePanel) {
                if (activePanel.id === 'marketPanel') {
                    previousPanel = 'market';
                } else if (activePanel.id === 'mapPanel') {
                    previousPanel = 'map';
                }
            }
            
            // Get current data for confirmation
            const currentPrice = document.getElementById('currentPrice').textContent;
            const deviceCount = 500;
            const estimatedPower = (deviceCount * 6) / 1000; // 6kW per device, convert to MW
            
            // Update confirmation modal content
            const confirmModal = document.getElementById('confirmationModal');
            // ‰ΩøÁî®i18nËé∑ÂèñÊìç‰ΩúÂêçÁß∞
            const getOperationName = (type) => {
                return window.i18n ? window.i18n.getText(type) : (type === 'charge' ? 'ÂÖÖÁîµ' : 'ÊîæÁîµ');
            };
            
            const operationColors = {
                'charge': '#00ff88',
                'discharge': '#ffd700'
            };
            
            // Update modal icon and color based on operation type
            const confirmIcon = document.getElementById('confirmIcon');
            const modalIcon = confirmIcon.parentElement;
            
            if (operationType === 'charge') {
                confirmIcon.textContent = '‚ö°';
                modalIcon.style.background = 'linear-gradient(145deg, rgba(0, 255, 136, 0.15), rgba(0, 255, 136, 0.05))';
                modalIcon.style.boxShadow = '0 4px 12px rgba(0, 255, 136, 0.15)';
                document.getElementById('confirmOperationType').style.color = '#00ff88';
            } else if (operationType === 'discharge') {
                confirmIcon.textContent = 'üîã';
                modalIcon.style.background = 'linear-gradient(145deg, rgba(255, 215, 0, 0.15), rgba(255, 215, 0, 0.05))';
                modalIcon.style.boxShadow = '0 4px 12px rgba(255, 215, 0, 0.15)';
                document.getElementById('confirmOperationType').style.color = '#ffd700';
            }
            
            // ‰ΩøÁî®i18nËé∑ÂèñË≠¶ÂëäÊ∂àÊÅØ
            const getWarningMessage = (type) => {
                if (!window.i18n) {
                    return type === 'charge' ? 
                        'Â∞ÜÂºÄÂßãÂØπÊâÄÊúâËøûÊé•ËÆæÂ§áËøõË°åÂÖÖÁîµÊìç‰ΩúÔºåÊ≠§ËøáÁ®ãÂ∞ÜÊ∂àËÄóÁîµÁΩëÁîµÂäõ„ÄÇ' :
                        'Â∞ÜÂºÄÂßãÂØπÊâÄÊúâËøûÊé•ËÆæÂ§áËøõË°åÊîæÁîµÊìç‰ΩúÔºåÂêëÁîµÁΩëËæìÈÄÅÁîµÂäõ‰ª•Ëé∑ÂèñÊî∂Áõä„ÄÇ';
                }
                
                const messages = {
                    'zh': {
                        'charge': 'Â∞ÜÂºÄÂßãÂØπÊâÄÊúâËøûÊé•ËÆæÂ§áËøõË°åÂÖÖÁîµÊìç‰ΩúÔºåÊ≠§ËøáÁ®ãÂ∞ÜÊ∂àËÄóÁîµÁΩëÁîµÂäõ„ÄÇ',
                        'discharge': 'Â∞ÜÂºÄÂßãÂØπÊâÄÊúâËøûÊé•ËÆæÂ§áËøõË°åÊîæÁîµÊìç‰ΩúÔºåÂêëÁîµÁΩëËæìÈÄÅÁîµÂäõ‰ª•Ëé∑ÂèñÊî∂Áõä„ÄÇ'
                    },
                    'en': {
                        'charge': 'Will start charging all connected devices, this process will consume grid power.',
                        'discharge': 'Will start discharging all connected devices, sending power to the grid for revenue.'
                    },
                    'ja': {
                        'charge': 'Êé•Á∂ö„Åï„Çå„Åü„Åô„Åπ„Å¶„ÅÆ„Éá„Éê„Ç§„Çπ„ÅÆÂÖÖÈõª„ÇíÈñãÂßã„Åó„Åæ„Åô„ÄÇ„Åì„ÅÆ„Éó„É≠„Çª„Çπ„Åß„ÅØÈõªÂäõÁ∂≤„ÅÆÈõªÂäõ„ÇíÊ∂àË≤ª„Åó„Åæ„Åô„ÄÇ',
                        'discharge': 'Êé•Á∂ö„Åï„Çå„Åü„Åô„Åπ„Å¶„ÅÆ„Éá„Éê„Ç§„Çπ„ÅÆÊîæÈõª„ÇíÈñãÂßã„Åó„ÄÅÂèéÁõä„ÅÆ„Åü„ÇÅ„Å´ÈõªÂäõÁ∂≤„Å´ÈõªÂäõ„ÇíÈÄÅ‰ø°„Åó„Åæ„Åô„ÄÇ'
                    },
                    'ko': {
                        'charge': 'Ïó∞Í≤∞Îêú Î™®Îì† Ïû•ÏπòÏùò Ï∂©Ï†ÑÏùÑ ÏãúÏûëÌï©ÎãàÎã§. Ïù¥ Í≥ºÏ†ïÏóêÏÑú Ï†ÑÎ†•Îßù Ï†ÑÎ†•ÏùÑ ÏÜåÎ™®Ìï©ÎãàÎã§.',
                        'discharge': 'Ïó∞Í≤∞Îêú Î™®Îì† Ïû•ÏπòÏùò Î∞©Ï†ÑÏùÑ ÏãúÏûëÌïòÏó¨ ÏàòÏùµÏùÑ ÏúÑÌï¥ Ï†ÑÎ†•ÎßùÏóê Ï†ÑÎ†•ÏùÑ Î≥¥ÎÉÖÎãàÎã§.'
                    }
                };
                
                const currentLang = window.i18n.getCurrentLanguage();
                return messages[currentLang] && messages[currentLang][type] ? 
                    messages[currentLang][type] : messages['zh'][type];
            };
            
            const operationName = getOperationName(operationType);
            const confirmTitleTexts = {
                'zh': `Á°ÆËÆ§${operationName}Êìç‰Ωú`,
                'en': `Confirm ${operationName} Operation`,
                'ja': `${operationName}Êìç‰Ωú„ÇíÁ¢∫Ë™ç`,
                'ko': `${operationName} ÏûëÏóÖ ÌôïÏù∏`
            };
            const confirmMessageTexts = {
                'zh': `ÊÇ®Á°ÆÂÆöË¶ÅÊâßË°å${operationName}Êìç‰ΩúÂêóÔºü`,
                'en': `Are you sure to execute ${operationName} operation?`,
                'ja': `${operationName}Êìç‰Ωú„ÇíÂÆüË°å„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü`,
                'ko': `${operationName} ÏûëÏóÖÏùÑ Ïã§ÌñâÌïòÏãúÍ≤†ÏäµÎãàÍπå?`
            };
            const currentLang = window.i18n ? window.i18n.getCurrentLanguage() : 'zh';
            
            document.getElementById('confirmTitle').textContent = confirmTitleTexts[currentLang] || confirmTitleTexts['zh'];
            document.getElementById('confirmMessage').textContent = confirmMessageTexts[currentLang] || confirmMessageTexts['zh'];
            document.getElementById('confirmOperationType').textContent = operationName;
            
            const deviceTexts = {
                'zh': deviceCount + '‰∏™',
                'en': deviceCount.toString(), // Ëã±ÊñáÊ®°ÂºèÂè™ÊòæÁ§∫Êï∞Â≠ó
                'ja': deviceCount + 'Âè∞',
                'ko': deviceCount + 'ÎåÄ'
            };
            document.getElementById('confirmTargetDevices').textContent = deviceTexts[currentLang] || deviceTexts['zh'];
            
            // È¶ñÂÖàÈáçÁΩÆÊâÄÊúâ‰ø°ÊÅØÈ°π‰∏∫ÂèØËßÅÁä∂ÊÄÅ
            const allInfoItems = confirmModal.querySelectorAll('.modal-info-item');
            allInfoItems.forEach(item => {
                item.style.display = 'flex';
                item.style.flexDirection = 'column';
            });
            
            // Remove any dynamically added rows from previous operations
            const confirmInfoGrid = document.getElementById('confirmInfoGrid');
            const dynamicRows = confirmInfoGrid.querySelectorAll('div[style*="margin-top"]');
            dynamicRows.forEach(row => row.remove());
            
            // Hide/show fields based on user requirements
            const estimatedPowerEl = document.getElementById('confirmEstimatedPower');
            const currentPriceEl = document.getElementById('confirmCurrentPrice');
            const durationEl = document.getElementById('confirmDuration');
            const costBenefitEl = document.getElementById('confirmCostBenefit');
            
            const estimatedPowerItem = estimatedPowerEl ? estimatedPowerEl.parentElement : null;
            const currentPriceItem = currentPriceEl ? currentPriceEl.parentElement : null;
            const durationItem = durationEl ? durationEl.parentElement : null;
            const costBenefitItem = costBenefitEl ? costBenefitEl.parentElement : null;
            
            // Âà§Êñ≠ÊòØÂê¶‰∏∫ÂÅúÊ≠¢Êìç‰Ωú
            const isStopOperation = operationType.includes('stop') || pendingOperation.includes('stop');
            
            if (operationType === 'charge' || isStopOperation) {
                // For charge and stop operations: hide all profit-related fields
                if (estimatedPowerItem) estimatedPowerItem.style.display = 'none';
                if (currentPriceItem) currentPriceItem.style.display = 'none';
                if (durationItem) durationItem.style.display = 'none';
                if (costBenefitItem) costBenefitItem.style.display = 'none';
            } else if (operationType === 'discharge' && !isStopOperation) {
                // For discharge only (not stop discharge): show predicted profit
                if (estimatedPowerItem) estimatedPowerItem.style.display = 'none';
                if (currentPriceItem) currentPriceItem.style.display = 'none';
                if (durationItem) durationItem.style.display = 'none';
                if (costBenefitItem) costBenefitItem.style.display = 'none';
                
                const profitRow = document.createElement('div');
                profitRow.style.cssText = 'display: flex; gap: 20px; margin-top: 20px;';
                const profitLabel = window.i18n ? window.i18n.getText('estimatedProfit') : 'È¢ÑËÆ°Êî∂Áõä';
                profitRow.innerHTML = `
                    <div class="modal-info-item" style="flex: 1; max-width: calc(50% - 10px); background: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 16px; padding: 20px 24px; transition: all 0.3s; display: flex; flex-direction: column;">
                        <div class="modal-info-label" style="color: rgba(255, 255, 255, 0.6); font-size: 14px; margin-bottom: 8px; font-weight: 400;" data-i18n="estimatedProfit">${profitLabel}</div>
                        <div class="modal-info-value" style="color: #ffd700; font-size: 20px; font-weight: 600;">+$${Math.floor(estimatedPower * parseInt(currentPrice.replace('$', '')) * 0.7)}</div>
                    </div>
                    <div style="flex: 1;"></div>
                `;
                confirmInfoGrid.appendChild(profitRow);
            }
            
            // Update warning message
            document.getElementById('warningText').textContent = getWarningMessage(operationType);
            
            // Update execute button
            const executeBtn = document.getElementById('confirmExecuteBtn');
            const executeBtnTexts = {
                'zh': `Á°ÆËÆ§${operationName}`,
                'en': `Confirm ${operationName}`,
                'ja': `${operationName}Á¢∫Ë™ç`,
                'ko': `${operationName} ÌôïÏù∏`
            };
            executeBtn.textContent = executeBtnTexts[currentLang] || executeBtnTexts['zh'];
            
            if (operationType === 'discharge') {
                executeBtn.style.background = 'linear-gradient(135deg, #ffd700, #ffcc00)';
                executeBtn.style.color = '#000';
                executeBtn.onmouseover = function() { 
                    this.style.transform='translateY(-1px)'; 
                    this.style.boxShadow='0 6px 20px rgba(255, 215, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.3)';
                };
                executeBtn.onmouseout = function() { 
                    this.style.transform='translateY(0)'; 
                    this.style.boxShadow='0 4px 16px rgba(255, 215, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.3)';
                };
            } else if (operationType === 'charge') {
                // ChargeÊåâÈíÆ‰ΩøÁî®ÁªøËâ≤
                executeBtn.style.background = 'linear-gradient(135deg, #00ff88, #00dd77)';
                executeBtn.style.color = '#000';
                executeBtn.onmouseover = function() { 
                    this.style.transform='translateY(-1px)'; 
                    this.style.boxShadow='0 6px 20px rgba(0, 255, 136, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.3)';
                };
                executeBtn.onmouseout = function() { 
                    this.style.transform='translateY(0)'; 
                    this.style.boxShadow='0 4px 16px rgba(0, 255, 136, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.3)';
                };
            } else {
                // ÂÖ∂‰ªñÊìç‰ΩúÔºàÂÅúÊ≠¢Á≠âÔºâ‰ΩøÁî®Á∫¢Ëâ≤
                executeBtn.style.background = 'linear-gradient(135deg, #ff4444, #ff3333)';
                executeBtn.style.color = '#fff';
            }
            
            // Show modal with animation
            confirmModal.classList.add('show');
            confirmModal.style.display = 'flex';
            
            // Add fade-in animation
            setTimeout(() => {
                confirmModal.style.opacity = '1';
            }, 10);
        }


        // Close confirmation modal
        function closeConfirmationModal() {
            const modal = document.getElementById('confirmationModal');
            if (modal) {
                modal.classList.remove('show');
                modal.style.display = 'none';
                modal.style.opacity = '0';
            }
            pendingOperation = null;
            
            // Don't change panel view when canceling - keep current state
            // This ensures the UI stays in the same state when user cancels
        }

        // Execute confirmed operation
        function executeConfirmedOperation() {
            if (!pendingOperation) return;

            const operationType = pendingOperation;
            closeConfirmationModal();

            
            if (operationType === 'stop' || operationType.startsWith('stop_')) {
                // Execute stop operation
                executeStopOperation();
            } else {
                // Show progress dialog first (ÈöêËóèÂÖÖÁîµËøõÂ∫¶ÂºπÁ™ó)
                // showProgressDialog(operationType);

                // Execute start operation
                startOperation(operationType);
                
                // Start progress animation
                startProgressAnimation(operationType);
                
                // Á°Æ‰øù‰ª∑Ê†ºÂúÜÂúàÈ¢úËâ≤Á´ãÂç≥Êõ¥Êñ∞
                setTimeout(() => {
                    updatePriceCircleColor();
                }, 100);
            }
            
            pendingOperation = null;
        }

        // Execute the actual operation after confirmation
        function executeOperation(operationType) {
            
            const chargeBtn = document.getElementById('chargeBtn');
            const dischargeBtn = document.getElementById('dischargeBtn');
            
            currentOperation = operationType;
            
            const actionButtons = document.querySelector('.action-buttons');
            
            if (operationType === 'charge') {
                // Â§ÑÁêÜÊåâÈíÆÁä∂ÊÄÅ
                if (currentOperationMode === 'auto') {
                    // Ëá™Âä®Ê®°ÂºèÔºöÈöêËóèÊåâÈíÆ
                    chargeBtn.style.display = 'none';
                    dischargeBtn.style.display = 'none';
                } else {
                    // ÊâãÂä®Ê®°ÂºèÔºöÈöêËóèÊåâÈíÆ
                    chargeBtn.style.display = 'none';
                    dischargeBtn.style.display = 'none';
                }
                
                // ‰∏çÊõ¥ÊîπÊòæÁ§∫Ôºå‰øùÊåÅ‰ª∑Ê†ºÊòæÁ§∫
                
                // Switch to map view only after confirmation
                switchPanel('map');
                setTimeout(() => {
                    startDeviceAnimation();
                }, 200);
            } else if (operationType === 'discharge') {
                // Â§ÑÁêÜÊåâÈíÆÁä∂ÊÄÅ
                if (currentOperationMode === 'auto') {
                    // Ëá™Âä®Ê®°ÂºèÔºöÈöêËóèÊåâÈíÆ
                    chargeBtn.style.display = 'none';
                    dischargeBtn.style.display = 'none';
                } else {
                    // ÊâãÂä®Ê®°ÂºèÔºöÈöêËóèÊåâÈíÆ
                    chargeBtn.style.display = 'none';
                    dischargeBtn.style.display = 'none';
                }
                
                // ‰∏çÊõ¥ÊîπÊòæÁ§∫Ôºå‰øùÊåÅ‰ª∑Ê†ºÊòæÁ§∫
                
                // Switch to map view only after confirmation
                switchPanel('map');
                setTimeout(() => {
                    startDeviceAnimation();
                }, 200);
            }
        }


        function showDetail(type) {
            // Add detail view logic here
        }

        // Panel switching functions
        function switchPanel(panel, button) {
            // Update panel visibility
            document.querySelectorAll('.panel-content').forEach(p => {
                p.classList.remove('active');
            });
            
            const targetPanel = document.getElementById(panel + 'Panel');
            if (targetPanel) {
                targetPanel.classList.add('active');
            }
            
            // Update button states - always update, even if button not provided
            document.querySelectorAll('.panel-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Find and activate the correct tab button
            if (button) {
                button.classList.add('active');
            } else {
                // If no button provided, find the tab by panel name
                const targetTab = Array.from(document.querySelectorAll('.panel-tab')).find(tab => {
                    const onclick = tab.getAttribute('onclick');
                    return onclick && onclick.includes(`'${panel}'`);
                });
                if (targetTab) {
                    targetTab.classList.add('active');
                }
            }
            
            // Resize charts after switching
            setTimeout(() => {
                if (panel === 'market' && marketChart) {
                    if (marketChart && typeof marketChart.resize === 'function') {
                        marketChart.resize();
                    }
                } else if (panel === 'map' && mapChart) {
                    mapChart.resize();
                }
            }, 100);
            
            // Additional resize with longer delay to ensure proper rendering
            setTimeout(() => {
                if (panel === 'market' && marketChart) {
                    if (marketChart && typeof marketChart.resize === 'function') {
                        marketChart.resize();
                    }
                } else if (panel === 'map' && mapChart) {
                    mapChart.resize();
                }
            }, 300);
        }

        // Market region switching
        function switchMarketRegion(region, button) {
            // Update active button
            document.querySelectorAll('#marketPanel .region-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            button.classList.add('active');
            
            // Update current region
            currentRegion = region;
            
            // Update market chart with new data
            updateMarketChart(region);

            // Update power station management module prices
            updatePriceCircleRegion(region);
        }
        
        // Update price circle region
        function updatePriceCircleRegion(region) {
            const regionIndicatorEl = document.getElementById('regionIndicator');
            if (regionIndicatorEl) regionIndicatorEl.textContent = region;

            let price;

            // ‰ºòÂÖà‰ΩøÁî®AEMOÁúüÂÆûÊï∞ÊçÆÁöÑÂΩìÂâç‰ª∑Ê†º
            if (aemoRealPriceData && aemoRealPriceData.length > 0) {
                // ËÆ°ÁÆóÂΩìÂâçÊó∂Èó¥Á¥¢Âºï
                const now = new Date();
                const currentHour = now.getHours();
                const currentMinute = now.getMinutes();
                const roundedMinute = Math.floor(currentMinute / 5) * 5;
                const currentTimeIndex = currentHour * 12 + (roundedMinute / 5);

                // ‰ΩøÁî®ÁúüÂÆûÁöÑÁé∞Ë¥ß‰ª∑Ê†º
                price = aemoRealPriceData[currentTimeIndex];
            } else {
                // ÂêéÂ§áÊñπÊ°àÔºöÂêÑÂú∞Âå∫Âõ∫ÂÆö‰ª∑Ê†º
                const regionPrices = {
                    'NSW': 163,
                    'QLD': 34,
                    'VIC': 21,
                    'SA': 403,
                    'TAS': 390
                };
                price = regionPrices[region] || 163; // ÈªòËÆ§NSW‰ª∑Ê†º
            }

            document.getElementById('currentPrice').textContent = '$' + (typeof price === 'number' ? price.toFixed(2) : price);

            // Add smooth transition effect
            const priceElement = document.getElementById('currentPrice');
            priceElement.style.transition = 'color 0.3s ease';
            priceElement.style.color = '#00ff88';
            setTimeout(() => {
                priceElement.style.color = '#fff';
            }, 300);
        }

        function updateMarketChart(region) {
            // ‰ΩøÁî®AEMO.xlsxÁöÑÁúüÂÆûÊï∞ÊçÆÔºàÊØè5ÂàÜÈíü‰∏Ä‰∏™Êï∞ÊçÆÁÇπÔºâ
            // Ëé∑ÂèñÂΩìÂâçÊó∂Èó¥Âπ∂ËÆ°ÁÆóÂØπÂ∫îÁöÑÊï∞ÊçÆÁ¥¢Âºï
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            const roundedMinute = Math.floor(currentMinute / 5) * 5;
            const currentTimeIndex = currentHour * 12 + (roundedMinute / 5);

            const actualPrices = [];
            const actualDemands = [];
            const forecastPrices = [];
            const forecastDemands = [];

            // ÈÅçÂéÜÊâÄÊúâ288‰∏™Êï∞ÊçÆÁÇπ
            for (let i = 0; i < aemoTimeLabels.length; i++) {
                if (i < currentTimeIndex) {
                    actualPrices.push(aemoRealPriceData[i]);
                    actualDemands.push(aemoRealDemandData[i]);
                    forecastPrices.push(null);
                    forecastDemands.push(null);
                } else if (i === currentTimeIndex) {
                    actualPrices.push(aemoRealPriceData[i]);
                    actualDemands.push(aemoRealDemandData[i]);
                    forecastPrices.push(aemoRealPriceData[i]);
                    forecastDemands.push(aemoRealDemandData[i]);
                } else {
                    actualPrices.push(null);
                    actualDemands.push(null);
                    forecastPrices.push(aemoRealPriceData[i]);
                    forecastDemands.push(aemoRealDemandData[i]);
                }
            }

            const chartOption = {
                xAxis: {
                    type: 'category',
                    data: aemoTimeLabels,
                    axisLine: { show: false },
                    axisLabel: {
                        color: 'rgba(255, 255, 255, 0.7)',
                        interval: 23,
                        fontSize: 12,
                        rotate: 0
                    },
                    splitLine: { show: false }
                },
                yAxis: [
                    {
                        type: 'value',
                        scale: true,
                        min: 'dataMin',
                        max: 'dataMax',
                        axisLine: { show: false },
                        axisLabel: {
                            color: 'rgba(255, 255, 255, 0.7)',
                            formatter: '${value}'
                        },
                        splitLine: {
                            show: true,
                            lineStyle: {
                                color: 'rgba(255, 255, 255, 0.05)',
                                type: 'dashed',
                                width: 1
                            }
                        }
                    },
                    {
                        type: 'value',
                        scale: true,
                        min: 'dataMin',
                        max: 'dataMax',
                        axisLine: { show: false },
                        axisLabel: {
                            color: 'rgba(255, 255, 255, 0.7)',
                            formatter: '{value} MW'
                        },
                        splitLine: { show: false }
                    }
                ],
                legend: {
                    data: [
                        window.i18n ? window.i18n.getText('historicalPrice') : 'ÂéÜÂè≤‰ª∑Ê†º',
                        window.i18n ? window.i18n.getText('demand') : 'ÈúÄÊ±Ç',
                        window.i18n ? window.i18n.getText('predictedPrice') : 'È¢ÑÊµã‰ª∑Ê†º',
                        window.i18n ? window.i18n.getText('predictedDemand') : 'È¢ÑÊµãÈúÄÊ±Ç'
                    ],
                    textStyle: { color: 'rgba(255, 255, 255, 0.7)' },
                    top: 10
                },
                series: [
                    {
                        data: actualPrices,
                        name: window.i18n ? window.i18n.getText('historicalPrice') : 'ÂéÜÂè≤‰ª∑Ê†º',
                        markLine: {
                            symbol: 'none',
                            silent: true,
                            data: [
                                {
                                    xAxis: currentTimeIndex,
                                    lineStyle: {
                                        color: 'rgba(255, 255, 255, 0.4)',
                                        type: 'dashed',
                                        width: 2
                                    },
                                    label: {
                                        show: false
                                    }
                                }
                            ]
                        }
                    },
                    {
                        data: actualDemands,
                        name: window.i18n ? window.i18n.getText('demand') : 'ÈúÄÊ±Ç',
                        yAxisIndex: 1
                    },
                    {
                        data: forecastPrices,
                        name: window.i18n ? window.i18n.getText('predictedPrice') : 'È¢ÑÊµã‰ª∑Ê†º'
                    },
                    {
                        data: forecastDemands,
                        name: window.i18n ? window.i18n.getText('predictedDemand') : 'È¢ÑÊµãÈúÄÊ±Ç',
                        yAxisIndex: 1
                    }
                ]
            };

            marketChart.setOption(chartOption);
        }

        // Auto switch functionality
        // Ëá™Âä®ÂàáÊç¢ÂäüËÉΩÂ∑≤ÁßªÈô§
        // function toggleAutoSwitch() { }
        // function startAutoSwitch() { }
        // function stopAutoSwitch() { }

        // Â§ÑÁêÜÂÅúÊ≠¢Êìç‰Ωú
        function handleStop() {
            // ÊòæÁ§∫ÂÅúÊ≠¢Á°ÆËÆ§ÂºπÁ™ó
            showStopConfirmationModal();
        }
        
        // Â∞ÜÂáΩÊï∞Êö¥Èú≤Âà∞ÂÖ®Â±Ä‰ΩúÁî®Âüü
        window.handleStop = handleStop;
        
        // ‰∏ªÂúÜÂúàÊÇ¨ÂÅúÂ§ÑÁêÜ
        function handleMainCircleHover() {
            const regionStatus = regionData[selectedMainRegion] ? regionData[selectedMainRegion].status : 'none';
            
            // Âú®4ÁßçÁä∂ÊÄÅ‰∏ãÊòæÁ§∫ÂÅúÊ≠¢ÔºöautoCharge, manualCharge, autoDischarge, manualDischarge
            if (regionStatus === 'autoCharge' || regionStatus === 'manualCharge' || 
                regionStatus === 'autoDischarge' || regionStatus === 'manualDischarge') {
                const priceDisplay = document.getElementById('priceDisplay');
                const statusDisplay = document.getElementById('statusDisplay');
                const stopDisplay = document.getElementById('stopDisplay');
                const mainCircle = document.getElementById('mainPriceCircle');
                const hoverOverlay = document.getElementById('hoverOverlay');
                
                // ÈöêËóè‰ª∑Ê†ºÂíåÁä∂ÊÄÅÊòæÁ§∫
                if (priceDisplay) {
                    priceDisplay.style.opacity = '0';
                }
                
                if (statusDisplay) {
                    statusDisplay.style.opacity = '0';
                }
                
                // ÊòæÁ§∫ÂÅúÊ≠¢ÊñáÊú¨
                if (stopDisplay) {
                    stopDisplay.style.display = 'block';
                    setTimeout(() => {
                        stopDisplay.style.opacity = '1';
                    }, 10);
                }
                
                // ÊòæÁ§∫Á∫¢Ëâ≤Ë¶ÜÁõñÂ±Ç
                if (hoverOverlay) {
                    hoverOverlay.style.opacity = '1';
                }
                
                if (mainCircle) {
                    mainCircle.style.transform = 'scale(1.05)';
                }
            }
        }
        
        // ‰∏ªÂúÜÂúàÈº†Ê†áÁ¶ªÂºÄÂ§ÑÁêÜ
        function handleMainCircleLeave() {
            const priceDisplay = document.getElementById('priceDisplay');
            const statusDisplay = document.getElementById('statusDisplay');
            const stopDisplay = document.getElementById('stopDisplay');
            const mainCircle = document.getElementById('mainPriceCircle');
            const hoverOverlay = document.getElementById('hoverOverlay');
            
            // ÈöêËóèÂÅúÊ≠¢ÊñáÊú¨
            if (stopDisplay) {
                stopDisplay.style.opacity = '0';
                setTimeout(() => {
                    stopDisplay.style.display = 'none';
                }, 300);
            }
            
            // ÊÅ¢Â§çÊ≠£Á°ÆÁöÑÊòæÁ§∫Áä∂ÊÄÅ
            updateCircleStatusDisplay();
            
            // ÈöêËóèÁ∫¢Ëâ≤Ë¶ÜÁõñÂ±Ç
            if (hoverOverlay) {
                hoverOverlay.style.opacity = '0';
            }
            
            if (mainCircle) {
                mainCircle.style.transform = 'scale(1)';
            }
            
            // Âè™ÊÅ¢Â§çÊ∞¥Ê≥¢È¢úËâ≤Ôºå‰∏çÊîπÂèòÊ∞¥‰ΩçÈ´òÂ∫¶
            restoreWaterWaveColor();
        }
        
        // ÊÅ¢Â§çÊ∞¥Ê≥¢È¢úËâ≤‰ΩÜ‰∏çÊîπÂèòÊ∞¥‰ΩçÈ´òÂ∫¶ÁöÑÂáΩÊï∞
        function restoreWaterWaveColor() {
            const waterWaveContainer = document.getElementById('waterWaveContainer');
            if (!waterWaveContainer) return;
            
            const regionStatus = regionData[selectedMainRegion] ? regionData[selectedMainRegion].status : 'none';
            
            // Âè™ÊÅ¢Â§çÈ¢úËâ≤Ôºå‰∏çÊîπÂèòÊ∞¥‰ΩçÈ´òÂ∫¶
            if (regionStatus === 'autoCharge' || regionStatus === 'manualCharge') {
                // ÂÖÖÁîµÁä∂ÊÄÅ - ÁªøËâ≤Ê∞¥Ê≥¢
                waterWaveContainer.style.background = '#4CD964';
            } else if (regionStatus === 'autoDischarge' || regionStatus === 'manualDischarge') {
                // ÊîæÁîµÁä∂ÊÄÅ - ÈªÑËâ≤Ê∞¥Ê≥¢
                waterWaveContainer.style.background = '#FFC107';
            } else {
                // Êó†Áä∂ÊÄÅ - ÈùíËâ≤/ÊµÖËìùËâ≤Ê∞¥Ê≥¢
                waterWaveContainer.style.background = '#5AC8FA';
            }
        }
        
        // ‰∏ªÂúÜÂúàÁÇπÂáªÂ§ÑÁêÜ
        function handleMainCircleClick() {
            const regionStatus = regionData[selectedMainRegion] ? regionData[selectedMainRegion].status : 'none';
            
            // Âú®4ÁßçÁä∂ÊÄÅ‰∏ãÂìçÂ∫îÁÇπÂáªÔºöautoCharge, manualCharge, autoDischarge, manualDischarge
            if (regionStatus === 'autoCharge' || regionStatus === 'manualCharge' || 
                regionStatus === 'autoDischarge' || regionStatus === 'manualDischarge') {
                // ÊòæÁ§∫ÂÅúÊ≠¢Á°ÆËÆ§ÂºπÁ™ó
                showStopConfirmation();
            }
        }
        
        // Êö¥Èú≤ÂáΩÊï∞Âà∞ÂÖ®Â±Ä
        window.handleMainCircleHover = handleMainCircleHover;
        window.handleMainCircleLeave = handleMainCircleLeave;
        window.handleMainCircleClick = handleMainCircleClick;
        
        function showStopConfirmationModal() {
            // È¶ñÂÖàÈáçÁΩÆÂºπÁ™óÔºåÁ°Æ‰øùÊ≤°ÊúâÈ¢ÑËÆ°Êî∂Áõä
            resetConfirmationModal();
            
            // Ê†πÊçÆÂΩìÂâçÊìç‰ΩúÁ°ÆÂÆöÂÅúÊ≠¢Á±ªÂûã
            const currentOp = currentOperation || 'charge'; // ÈªòËÆ§‰∏∫ÂÖÖÁîµ
            const isCharging = currentOp === 'charge';
            
            // ‰ΩøÁî® confirmationModal ‰ª•‰øùÊåÅ‰∏éÂÖÖÁîµÂºπÁ™ó‰∏ÄËá¥ÁöÑÊ†∑Âºè
            const modal = document.getElementById('confirmationModal');
            if (!modal) {
                console.error('confirmationModal not found');
                return;
            }
            
            // È¶ñÂÖàÈáçÁΩÆÊâÄÊúâ‰ø°ÊÅØÈ°π‰∏∫ÂèØËßÅÁä∂ÊÄÅ
            const allInfoItems = modal.querySelectorAll('.modal-info-item');
            allInfoItems.forEach(item => {
                item.style.display = 'flex';
                item.style.flexDirection = 'column';
            });
            
            // ËÆæÁΩÆÂºπÁ™óÂÜÖÂÆπ
            const confirmTitle = document.getElementById('confirmTitle');
            const confirmMessage = document.getElementById('confirmMessage');
            const confirmOperationType = document.getElementById('confirmOperationType');
            const confirmTargetDevices = document.getElementById('confirmTargetDevices');
            const warningText = document.getElementById('warningText');
            const confirmExecuteBtn = document.getElementById('confirmExecuteBtn');
            const confirmIcon = document.getElementById('confirmIcon');
            
            // ËÆæÁΩÆÂõæÊ†áÂíåÊ†áÈ¢ò
            if (confirmIcon) confirmIcon.textContent = 'üõë';
            
            // Update modal icon style for stop operation
            const modalIcon = confirmIcon.parentElement;
            if (modalIcon) {
                modalIcon.style.background = 'linear-gradient(145deg, rgba(255, 68, 68, 0.15), rgba(255, 68, 68, 0.05))';
                modalIcon.style.boxShadow = '0 4px 12px rgba(255, 68, 68, 0.15)';
            }
            
            // Update operation type card color for stop
            const operationTypeElement = document.getElementById('confirmOperationType');
            if (operationTypeElement) {
                operationTypeElement.style.color = '#ff4444';
            }
            
            if (isCharging) {
                if (confirmTitle) confirmTitle.textContent = window.i18n ? window.i18n.getText('confirmStopChargeTitle') : 'Á°ÆËÆ§ÂÅúÊ≠¢ÂÖÖÁîµ';
                if (confirmMessage) confirmMessage.textContent = window.i18n ? window.i18n.getText('confirmStopChargeMessage') : 'ÊÇ®Á°ÆÂÆöË¶ÅÂÅúÊ≠¢ÂÖÖÁîµÊìç‰ΩúÂêóÔºü';
                if (confirmOperationType) confirmOperationType.textContent = window.i18n ? window.i18n.getText('stopCharge') : 'ÂÅúÊ≠¢ÂÖÖÁîµ';
                if (confirmExecuteBtn) {
                    confirmExecuteBtn.textContent = window.i18n ? window.i18n.getText('confirmStopCharge') : 'Á°ÆËÆ§ÂÅúÊ≠¢ÂÖÖÁîµ';
                    confirmExecuteBtn.style.background = 'linear-gradient(135deg, #ff4444, #ff3333)';
                    confirmExecuteBtn.style.color = '#fff';
                    confirmExecuteBtn.style.boxShadow = '0 4px 16px rgba(255, 68, 68, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.3)';
                    confirmExecuteBtn.onmouseover = function() { 
                        this.style.transform='translateY(-1px)'; 
                        this.style.boxShadow='0 6px 20px rgba(255, 68, 68, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.3)'; 
                    };
                    confirmExecuteBtn.onmouseout = function() { 
                        this.style.transform='translateY(0)'; 
                        this.style.boxShadow='0 4px 16px rgba(255, 68, 68, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.3)'; 
                    };
                }
                if (warningText) warningText.textContent = window.i18n ? window.i18n.getText('stopChargeWarning') : 'ÂÅúÊ≠¢Êìç‰ΩúÂ∞ÜÁ´ãÂç≥ÁªàÊ≠¢ÊâÄÊúâËÆæÂ§áÁöÑÂÖÖÁîµÁä∂ÊÄÅÔºåËÆæÂ§áÂ∞ÜÊÅ¢Â§çÂà∞ÂæÖÊú∫Ê®°Âºè„ÄÇ';
            } else {
                if (confirmTitle) confirmTitle.textContent = window.i18n ? window.i18n.getText('confirmStopDischargeTitle') : 'Á°ÆËÆ§ÂÅúÊ≠¢ÊîæÁîµ';
                if (confirmMessage) confirmMessage.textContent = window.i18n ? window.i18n.getText('confirmStopDischargeMessage') : 'ÊÇ®Á°ÆÂÆöË¶ÅÂÅúÊ≠¢ÊîæÁîµÊìç‰ΩúÂêóÔºü';
                if (confirmOperationType) confirmOperationType.textContent = window.i18n ? window.i18n.getText('stopDischarge') : 'ÂÅúÊ≠¢ÊîæÁîµ';
                if (confirmExecuteBtn) {
                    confirmExecuteBtn.textContent = window.i18n ? window.i18n.getText('confirmStopDischarge') : 'Á°ÆËÆ§ÂÅúÊ≠¢ÊîæÁîµ';
                    confirmExecuteBtn.style.background = 'linear-gradient(135deg, #ff4444, #ff3333)';
                    confirmExecuteBtn.style.color = '#fff';
                    confirmExecuteBtn.style.boxShadow = '0 4px 16px rgba(255, 68, 68, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.3)';
                    confirmExecuteBtn.onmouseover = function() { 
                        this.style.transform='translateY(-1px)'; 
                        this.style.boxShadow='0 6px 20px rgba(255, 68, 68, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.3)'; 
                    };
                    confirmExecuteBtn.onmouseout = function() { 
                        this.style.transform='translateY(0)'; 
                        this.style.boxShadow='0 4px 16px rgba(255, 68, 68, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.3)'; 
                    };
                }
                if (warningText) warningText.textContent = window.i18n ? window.i18n.getText('stopDischargeWarning') : 'ÂÅúÊ≠¢Êìç‰ΩúÂ∞ÜÁ´ãÂç≥ÁªàÊ≠¢ÊâÄÊúâËÆæÂ§áÁöÑÊîæÁîµÁä∂ÊÄÅÔºåËÆæÂ§áÂ∞ÜÊÅ¢Â§çÂà∞ÂæÖÊú∫Ê®°Âºè„ÄÇ';
            }
            
            // ËÆæÁΩÆÂΩ±ÂìçËÆæÂ§áÊï∞Èáè
            if (confirmTargetDevices) {
                const deviceCount = window.i18n && window.i18n.getCurrentLanguage() === 'en' ? '500' : '500‰∏™';
                confirmTargetDevices.textContent = deviceCount;
            }
            
            // ÈöêËóèÂÖ∂‰ªñ‰∏çÈúÄË¶ÅÁöÑ‰ø°ÊÅØÈ°π
            const estimatedPowerItem = document.getElementById('confirmEstimatedPower');
            const currentPriceItem = document.getElementById('confirmCurrentPrice');
            const durationItem = document.getElementById('confirmDuration');
            const costBenefitItem = document.getElementById('confirmCostBenefit');
            
            if (estimatedPowerItem && estimatedPowerItem.parentElement) {
                estimatedPowerItem.parentElement.style.display = 'none';
            }
            if (currentPriceItem && currentPriceItem.parentElement) {
                currentPriceItem.parentElement.style.display = 'none';
            }
            if (durationItem && durationItem.parentElement) {
                durationItem.parentElement.style.display = 'none';
            }
            if (costBenefitItem && costBenefitItem.parentElement) {
                costBenefitItem.parentElement.style.display = 'none';
            }
            
            // ËÆæÁΩÆpending operation‰∏∫ÂÅúÊ≠¢Êìç‰Ωú
            pendingOperation = 'stop';
            
            // ÊòæÁ§∫ÂºπÁ™ó
            modal.classList.add('show');
            modal.style.display = 'flex';
            
            // Ê∑ªÂä†Ê®°ÊÄÅÊ°ÜÊâìÂºÄÂä®Áîª
            setTimeout(() => {
                modal.style.opacity = '1';
            }, 10);
        }
        
        function executeStopOperation() {
            
            // Ë∞ÉÁî®ÂÅúÊ≠¢Êìç‰ΩúÂáΩÊï∞ÔºåÂÆÉ‰ºöÂ§ÑÁêÜÊâÄÊúâÁöÑÁä∂ÊÄÅÈáçÁΩÆÂíåUIÊõ¥Êñ∞
            stopOperation();
        }
        
        // Enhanced device animation with wave effect
        function startDeviceAnimation() {

            activatedDevices = 0;
            const totalDevices = 500;

            // Clear previous animation
            if (mapAnimationInterval) {
                clearInterval(mapAnimationInterval);
            }

            // Update UI - ‰ªéÂΩìÂâçÂú∞Âå∫ÁöÑÊï∞ÊçÆÂºÄÂßãÂä®Áîª,‰∏çÈáçÊñ∞ÁîüÊàêÈöèÊú∫Êï∞ÊçÆ
            const totalEl = document.getElementById('totalDevices');
            const successEl = document.getElementById('successfulDevices');
            const executingEl = document.getElementById('executingDevices');
            const failedEl = document.getElementById('failedDevices');


            // ‰ΩøÁî®ÂΩìÂâçÂú∞Âå∫Â∑≤ÊúâÁöÑËÆæÂ§áÁªüËÆ°Êï∞ÊçÆ‰Ωú‰∏∫Âä®ÁîªËµ∑ÁÇπ
            const currentRegionStats = regionData[selectedMainRegion]?.deviceStats;

            let initialSuccessCount, initialExecutingCount, initialFailedCount;

            if (currentRegionStats) {
                // ‰ΩøÁî®Âú∞Âå∫Â∑≤ÊúâÁöÑÊï∞ÊçÆ
                initialSuccessCount = currentRegionStats.success;
                initialExecutingCount = currentRegionStats.executing;
                initialFailedCount = currentRegionStats.failed;
            } else {
                // Â¶ÇÊûúÊ≤°ÊúâÊï∞ÊçÆ(‰∏çÂ∫îËØ•ÂèëÁîü),ÂàôÁîüÊàêÊñ∞ÁöÑÈöèÊú∫Êï∞ÊçÆ
                initialFailedCount = Math.floor(Math.random() * 46) + 5;
                initialSuccessCount = Math.floor(Math.random() * 101) + 100;
                initialExecutingCount = totalDevices - initialFailedCount - initialSuccessCount;
                console.warn(`No existing data for region ${selectedMainRegion}, generating new random data`);
            }

            // ËÆæÁΩÆÂàùÂßãÊøÄÊ¥ªÊï∞‰∏∫Â∑≤ÊàêÂäüÁöÑÊï∞Èáè
            activatedDevices = initialSuccessCount;

            if (totalEl) totalEl.textContent = totalDevices;
            if (successEl) successEl.textContent = initialSuccessCount;
            if (executingEl) executingEl.textContent = initialExecutingCount;
            if (failedEl) failedEl.textContent = initialFailedCount;

            // Êõ¥Êñ∞ËÆæÂ§áÁä∂ÊÄÅÊï∞ÊçÆ
            updateDeviceStatusCounts(initialSuccessCount, initialExecutingCount, initialFailedCount);

            
            let animationStep = 0;
            const maxSteps = totalDevices / 3; // Complete animation in ~167 steps
            
            // Start wave animation
            mapAnimationInterval = setInterval(() => {
                if (animationStep < maxSteps) {
                    // Create wave effect - activate 2-4 devices per step with some randomness
                    const baseActivation = Math.floor(3 + Math.random() * 2); // 3-4 devices
                    const waveBonus = Math.sin((animationStep / maxSteps) * Math.PI * 2) * 2; // Wave pattern
                    const actualActivation = Math.max(1, Math.floor(baseActivation + waveBonus));
                    
                    activatedDevices = Math.min(activatedDevices + actualActivation, totalDevices);
                    animationStep++;

                    // Update UI with smooth progress
                    // Â∑≤Â§ÑÁêÜÁöÑËÆæÂ§áÊï∞ÈÄêÊ∏êÂ¢ûÂä†
                    const processedDevices = activatedDevices;
                    const successCount = Math.floor(processedDevices * 0.95); // 95% success rate
                    const failCount = Math.floor(processedDevices * 0.05); // 5% failure rate
                    const executingCount = totalDevices - successCount - failCount; // Ââ©‰ΩôÊú™Â§ÑÁêÜÁöÑËÆæÂ§á

                    // Êõ¥Êñ∞ÊòæÁ§∫ÔºöÊàêÂäü + Â§±Ë¥• + ÊâßË°å‰∏≠ = ËÆæÂ§áÊÄªÊï∞Ôºà500Ôºâ
                    safeSetText('successfulDevices', successCount);
                    safeSetText('executingDevices', executingCount);
                    safeSetText('failedDevices', failCount);

                    // ÊØè10Ê≠•ÊâìÂç∞‰∏ÄÊ¨°ËøõÂ∫¶Êó•Âøó
                    if (animationStep % 10 === 0) {
                    }

                    // Update device status data
                    updateDeviceStatusCounts(successCount, executingCount, failCount);
                    
                    // Update map with animation - this will sync the statistics
                    try {
                        updateMapDevicesWithAnimation(activatedDevices);
                    } catch (error) {
                        console.error('Error updating map devices:', error);
                    }
                    
                    // Add some visual effects for special milestones
                    if (activatedDevices % 50 === 0) {
                        createEnergyWave();
                    }
                    
                } else {
                    // Animation complete
                    clearInterval(mapAnimationInterval);
                    
                    // Á°Æ‰øùÊâÄÊúâËÆæÂ§áÈÉΩÂ∑≤Â§ÑÁêÜÂÆåÊàê
                    activatedDevices = totalDevices;
                    const finalSuccessCount = Math.floor(totalDevices * 0.95); // 95% success (475)
                    const finalFailCount = Math.floor(totalDevices * 0.05); // 5% failure (25)
                    const finalExecutingCount = totalDevices - finalSuccessCount - finalFailCount; // Ââ©‰Ωô (0)

                    // Êõ¥Êñ∞ÊòæÁ§∫ÔºöÊàêÂäü + Â§±Ë¥• + ÊâßË°å‰∏≠ = ËÆæÂ§áÊÄªÊï∞Ôºà500Ôºâ
                    safeSetText('successfulDevices', finalSuccessCount);
                    safeSetText('executingDevices', finalExecutingCount);
                    safeSetText('failedDevices', finalFailCount);

                    // Update device status data
                    updateDeviceStatusCounts(finalSuccessCount, finalExecutingCount, finalFailCount);

                    // ‰øùÂ≠òÊúÄÁªàÊï∞ÊçÆÂõûÂú∞Âå∫Êï∞ÊçÆ,‰ª•‰æø‰∏ãÊ¨°ÂàáÊç¢ÂõûÊù•Êó∂ÊòæÁ§∫
                    if (regionData[selectedMainRegion]) {
                        regionData[selectedMainRegion].deviceStats = {
                            total: totalDevices,
                            success: finalSuccessCount,
                            executing: finalExecutingCount,
                            failed: finalFailCount
                        };
                    }

                    // ËÆ°ÁÆóÂÆûÈôÖËøõÂ∫¶
                    const actualProgress = Math.round((activatedDevices / totalDevices) * 100);
                    
                    // Âè™ÊúâÁúüÊ≠£ËææÂà∞100%Êó∂ÊâçÊòæÁ§∫ÁªüËÆ°ÂºπÁ™ó
                    if (actualProgress >= 100) {
                        // Âä®ÁîªÂÆåÊàêÂêéÊòæÁ§∫ÁªüËÆ°
                        setTimeout(() => {
                            showOperationStatistics();
                        }, 1000);
                    }
                }
            }, 80); // Slightly faster updates for smoother animation
        }

        function updateMapDevicesWithAnimation(activeCount) {
            if (!mapChart || !deviceLocations.length) return;
            
            // Update actual device statuses based on command progress
            // Simulate devices receiving commands and changing their real status
            const successRate = 0.85; // 85% of devices successfully receive and execute commands
            const executedDevices = Math.floor(activeCount * successRate);
            
            // Update device statuses to reflect real execution
            for (let i = 0; i < deviceLocations.length; i++) {
                const device = deviceLocations[i];

                if (device.status === 'offline' || device.status === 'hidden') {
                    // Offline devices stay offline, hidden devices stay hidden
                    continue;
                }
                
                if (i < executedDevices && currentOperation) {
                    // These devices have successfully received and executed the command
                    if (currentOperation === 'charge') {
                        device.status = 'charging';
                    } else if (currentOperation === 'discharge') {
                        device.status = 'discharging';
                    }
                } else if (i < activeCount) {
                    // These devices received command but haven't executed yet (processing)
                    device.status = 'active';
                } else {
                    // These devices are inactive/standby
                    if (device.status === 'charging' || device.status === 'discharging' || device.status === 'active') {
                        device.status = 'inactive';
                    }
                }
            }
            
            // Create animated device data based on real status (ËøáÊª§ÊéâhiddenÁä∂ÊÄÅ)
            const data = deviceLocations
                .filter(device => device.status !== 'hidden')  // ËøáÊª§ÊéâhiddenÁä∂ÊÄÅÁöÑËÆæÂ§á
                .map((device, index) => {
                    const justActivated = index >= activeCount - 5 && index < activeCount; // Last 5 devices that got commands

                    return {
                        value: device.value,
                        id: device.id,
                        status: device.status, // Use actual device status
                        region: device.region,
                        city: device.city,
                        justActivated: justActivated
                    };
                });
            
            // Update the device series with enhanced styling
            mapChart.setOption({
                series: [
                    {}, // Keep region centers unchanged
                    {
                        name: 'Devices',
                        type: 'scatter',
                        data: data,
                        symbolSize: function(value, params) {
                            const status = params.data.status;
                            const justActivated = params.data.justActivated;
                            
                            if (justActivated) {
                                return 14; // Larger for just activated
                            } else if (status === 'charging' || status === 'discharging') {
                                return 8; // Larger for operational devices
                            } else if (status === 'active') {
                                return 6;
                            } else if (status === 'offline') {
                                return 4;
                            }
                            return 5;
                        },
                        itemStyle: {
                            color: function(params) {
                                const status = params.data.status;
                                const justActivated = params.data.justActivated;
                                
                                if (justActivated) {
                                    // Bright pulse effect for just activated devices
                                    if (status === 'charging') return '#00ff88';
                                    if (status === 'discharging') return '#8A4AFF';
                                    if (status === 'active') return '#ffcc00';
                                }
                                
                                // Enhanced status colors with gradients
                                switch (status) {
                                    case 'charging': 
                                        return '#00ff88'; // Vibrant green for charging
                                    case 'discharging': 
                                        return '#FFD700'; // Yellow for discharging
                                    case 'active':
                                        return '#ffcc00'; // Bright yellow for active
                                    case 'offline': 
                                        return 'rgba(120, 120, 120, 0.4)'; // Gray for offline
                                    default:
                                        return 'rgba(255, 255, 255, 0.6)'; // Soft white for inactive
                                }
                            },
                            borderColor: function(params) {
                                const status = params.data.status;
                                const justActivated = params.data.justActivated;
                                
                                if (justActivated) {
                                    return '#ffffff';
                                }
                                
                                switch (status) {
                                    case 'charging': return 'rgba(0, 255, 136, 0.8)';
                                    case 'discharging': return 'rgba(255, 215, 0, 0.8)';
                                    case 'active': return 'rgba(255, 204, 0, 0.8)';
                                    default: return 'rgba(255, 255, 255, 0.4)';
                                }
                            },
                            borderWidth: function(params) {
                                const status = params.data.status;
                                if (params.data.justActivated) return 3;
                                if (status === 'charging' || status === 'discharging') return 2;
                                return 1;
                            },
                            shadowBlur: function(params) {
                                const status = params.data.status;
                                const justActivated = params.data.justActivated;
                                
                                if (justActivated) {
                                    return 25; // Enhanced glow for new activations
                                } else if (status === 'charging' || status === 'discharging') {
                                    return 15; // Medium glow for operational devices
                                } else if (status === 'active') {
                                    return 8;
                                }
                                return 4;
                            },
                            shadowColor: function(params) {
                                const status = params.data.status;
                                const justActivated = params.data.justActivated;
                                
                                if (justActivated) {
                                    if (status === 'charging') return 'rgba(0, 255, 136, 0.9)';
                                    if (status === 'discharging') return 'rgba(255, 51, 102, 0.9)';
                                    if (status === 'active') return 'rgba(255, 204, 0, 0.9)';
                                }
                                
                                switch (status) {
                                    case 'charging':
                                        return 'rgba(0, 255, 136, 0.8)';
                                    case 'discharging':
                                        return 'rgba(255, 215, 0, 0.8)';
                                    case 'active':
                                        return 'rgba(255, 170, 0, 0.8)';
                                    default:
                                        return 'rgba(255, 255, 255, 0.3)';
                                }
                            }
                        },
                        emphasis: {
                            scale: 1.8,
                            itemStyle: {
                                shadowBlur: 30,
                                shadowColor: function(params) {
                                    const status = params.data.status;
                                    switch (status) {
                                        case 'charging': return 'rgba(0, 255, 136, 1)';
                                        case 'discharging': return 'rgba(255, 215, 0, 1)';
                                        case 'active': return 'rgba(255, 204, 0, 1)';
                                        default: return 'rgba(255, 255, 255, 0.8)';
                                    }
                                },
                                borderWidth: 3,
                                borderColor: '#ffffff'
                            }
                        },
                        animation: true,
                        animationDuration: 800,
                        animationEasing: 'cubicOut'
                    }
                ]
            });
            
            
            // Update map statistics with current active count
            updateMapStatistics(activeCount);
        }

        function createEnergyWave() {
            // Visual effect for energy wave (could be enhanced with more sophisticated graphics)
            if (mapChart) {
                const option = mapChart.getOption();
                
                // Add temporary graphic element for wave effect
                const waveGraphic = {
                    type: 'circle',
                    shape: {
                        cx: 300,
                        cy: 250,
                        r: 50
                    },
                    style: {
                        stroke: currentOperation === 'charge' ? '#00ff88' : '#8A4AFF',
                        lineWidth: 3,
                        fill: 'transparent',
                        opacity: 0.8
                    },
                    z: 10
                };
                
                // Add wave and remove after animation
                setTimeout(() => {
                    if (mapChart) {
                        const currentGraphic = mapChart.getOption().graphic || [];
                        mapChart.setOption({
                            graphic: [...currentGraphic, waveGraphic]
                        });
                        
                        // Remove wave after 500ms
                        setTimeout(() => {
                            updateMapStatistics(); // This resets the graphic to just statistics
                        }, 500);
                    }
                }, 50);
            }
        }

        function updateMapDevices(activeCount) {
            if (!mapChart || !deviceLocations.length) return;

            // Create updated device data that works with both geo and cartesian2d
            // Filter out hidden devices
            const data = deviceLocations
                .filter(device => device.status !== 'hidden')
                .map((device, index) => {
                    const isActive = index < activeCount;

                    return {
                        name: `ËÆæÂ§á${device.id}`,
                        value: device.value.concat ? device.value.concat([device.id]) : device.value,
                        id: device.id,
                        status: isActive ? 'active' : 'inactive',
                        city: device.city
                    };
                });
            
            // Update the device series (series[1], after cities series[0])
            mapChart.setOption({
                series: [
                    {}, // Keep cities unchanged
                    {
                        name: 'Devices',
                        type: 'scatter',
                        data: data
                    }
                ]
            });
            
            // Update legend with new counts
            updateMapLegend();
        }

        // Êõ¥Êñ∞‰ª∑Ê†ºÂúÜÂúàÈ¢úËâ≤ÁöÑÂáΩÊï∞
        function updatePriceCircleColor() {
            // Update stop button visibility based on current state
            updateStopButtonVisibility();
            
            // Update action buttons visibility based on current state
            updateActionButtonsVisibility();
            
            // Ëé∑ÂèñÂΩìÂâçÈÄâ‰∏≠Âú∞Âå∫ÁöÑÁä∂ÊÄÅ - ‰ΩøÁî®regionDataËÄå‰∏çÊòØregionOperationStatus
            const regionStatus = regionData[selectedMainRegion] ? regionData[selectedMainRegion].status : 'none';
            
            // Update water wave colors based on operation status
            const waterWaveContainer = document.getElementById('waterWaveContainer');
            const mainCircle = document.getElementById('mainPriceCircle');
            
            if (!waterWaveContainer) {
                return;
            }
            
            const waterLevelContainer = document.getElementById('waterLevelContainer');
            
            if (regionStatus === 'autoCharge' || regionStatus === 'manualCharge') {
                // ÂÖÖÁîµÁä∂ÊÄÅ - ÊüîÂíåÁöÑÁªøËâ≤Ê∏êÂèòÔºå‰∏éÊ©ôËâ≤ÊòéÂ∫¶ÂåπÈÖç
                waterWaveContainer.style.background = 'linear-gradient(135deg, var(--color-circle-primary) 0%, #389e0d 100%)';
                if (waterLevelContainer) {
                    waterLevelContainer.style.height = '100%';
                }
            } else if (regionStatus === 'autoDischarge' || regionStatus === 'manualDischarge') {
                // ÊîæÁîµÁä∂ÊÄÅ - ‰ºòÂåñÁöÑÊ©ôËâ≤Ê∏êÂèòÔºåÊõ¥Âä†Ê∏©Êöñ
                waterWaveContainer.style.background = 'linear-gradient(135deg, #ff9500 0%, #ff7700 100%)';
                if (waterLevelContainer) {
                    waterLevelContainer.style.height = '100%';
                }
            } else {
                // Êó†Áä∂ÊÄÅ - ‰ºòÂåñÁöÑËìùËâ≤Ê∏êÂèòÔºåÊõ¥Âä†ÊüîÂíå
                waterWaveContainer.style.background = 'linear-gradient(135deg, #007AFF 0%, #0056CC 100%)';
                if (waterLevelContainer) {
                    waterLevelContainer.style.height = '100%';
                }
            }
            
            // Êõ¥Êñ∞Â§ßÂúÜÁöÑÂÖâÊ†áÊ†∑Âºè
            if (mainCircle) {
                if (currentOperationMode === 'auto') {
                    // Ëá™Âä®Ê®°Âºè‰∏ãÔºåÂ§ßÂúÜ‰∏çÂèØÁÇπÂáª
                    mainCircle.style.cursor = 'default';
                } else {
                    // ÊâãÂä®Ê®°Âºè‰∏ãÔºåÂè™ÊúâÂú®ÊúâÊìç‰ΩúËøõË°åÊó∂ÊâçÂèØÁÇπÂáª
                    if (currentOperation === 'charge' || currentOperation === 'discharge') {
                        mainCircle.style.cursor = 'pointer';
                    } else {
                        mainCircle.style.cursor = 'default';
                    }
                }
            }
        }

        // Êõ¥Êñ∞ÂÅúÊ≠¢ÊåâÈíÆÊòæÁ§∫Áä∂ÊÄÅ
        function updateStopButtonVisibility() {
            const mainPriceCircle = document.getElementById('mainPriceCircle');
            if (!mainPriceCircle) return;
            
            // Ëé∑ÂèñÂΩìÂâçÈÄâ‰∏≠Âú∞Âå∫ÁöÑÁä∂ÊÄÅ
            const regionStatus = regionData[selectedMainRegion] ? regionData[selectedMainRegion].status : 'none';
            
            // Âú®4ÁßçÁä∂ÊÄÅ‰∏ãÈÉΩÊòæÁ§∫ÂÅúÊ≠¢ÊåâÈíÆÔºöautoCharge, manualCharge, autoDischarge, manualDischarge
            const shouldShowStop = regionStatus === 'autoCharge' || regionStatus === 'manualCharge' || 
                                  regionStatus === 'autoDischarge' || regionStatus === 'manualDischarge';
            
            if (shouldShowStop) {
                mainPriceCircle.classList.add('manual-operation');
            } else {
                mainPriceCircle.classList.remove('manual-operation');
            }
        }


        // ÂàùÂßãÂåñSOCÊªëÂä®Êù°‰ΩçÁΩÆ
        function initSOCSliders() {
            // ÂàùÂßãÂåñÂÖÖÁîµÂÅúÊ≠¢SOCËøõÂ∫¶Êù°
            const chargeSOCSlider = document.getElementById('chargeSOCSlider');
            const chargeProgressBar = document.getElementById('chargeSOCProgressBar');
            const chargeProgressDot = document.getElementById('chargeSOCProgressDot');
            const chargeInput = document.getElementById('chargeStopSOCInput');
            if (chargeSOCSlider && chargeProgressBar && chargeProgressDot && chargeInput) {
                // ËÆæÁΩÆÂàùÂßãËøõÂ∫¶Êù°ÂÆΩÂ∫¶
                chargeProgressBar.style.width = chargeSOCSlider.value + '%';
                // ËÆæÁΩÆÂàùÂßãÂúÜÁÇπ‰ΩçÁΩÆ
                chargeProgressDot.style.left = chargeSOCSlider.value + '%';
                // ËÆæÁΩÆÂàùÂßãËæìÂÖ•Ê°ÜÂÄº
                chargeInput.value = chargeSOCSlider.value;
            }
            
            // ÂàùÂßãÂåñÊîæÁîµÂÅúÊ≠¢SOCËøõÂ∫¶Êù°
            const dischargeSOCSlider = document.getElementById('dischargeSOCSlider');
            const dischargeProgressBar = document.getElementById('dischargeSOCProgressBar');
            const dischargeProgressDot = document.getElementById('dischargeSOCProgressDot');
            const dischargeInput = document.getElementById('dischargeStopSOCInput');
            if (dischargeSOCSlider && dischargeProgressBar && dischargeProgressDot && dischargeInput) {
                // ËÆæÁΩÆÂàùÂßãËøõÂ∫¶Êù°‰ΩçÁΩÆ (‰ªéÊªëÂùó‰ΩçÁΩÆÂà∞100%)
                dischargeProgressBar.style.left = dischargeSOCSlider.value + '%';
                dischargeProgressBar.style.width = (100 - dischargeSOCSlider.value) + '%';
                // ËÆæÁΩÆÂàùÂßãÂúÜÁÇπ‰ΩçÁΩÆ
                dischargeProgressDot.style.left = dischargeSOCSlider.value + '%';
                // ËÆæÁΩÆÂàùÂßãËæìÂÖ•Ê°ÜÂÄº
                dischargeInput.value = dischargeSOCSlider.value;
            }
        }

        // Êõ¥Êñ∞ÂÖÖÁîµÂÅúÊ≠¢SOCËøõÂ∫¶Êù°
        function updateChargeSOC(socValue, skipConfirmation = false) {
            // Ê£ÄÊü•ÂΩìÂâçÂú∞Âå∫ÊòØÂê¶ÊúâËøêË°åÁä∂ÊÄÅ
            const regionStatus = getRegionOperationStatus(selectedMainRegion);
            const hasRunningStatus = regionStatus === 'charging' || regionStatus === 'discharging';
            
            if (hasRunningStatus && !skipConfirmation) {
                // ÊúâËøêË°åÁä∂ÊÄÅÔºåÊòæÁ§∫Á°ÆËÆ§ÂºπÁ™ó
                showSOCChangeConfirmation('charge', socValue);
                return;
            }
            
            const progressBar = document.getElementById('chargeSOCProgressBar');
            const progressDot = document.getElementById('chargeSOCProgressDot');
            const socInput = document.getElementById('chargeStopSOCInput');
            const socDisplay = document.getElementById('chargeStopSOCDisplay');
            const socSlider = document.getElementById('chargeSOCSlider');
            
            if (progressBar && progressDot && socInput && socSlider) {
                // Êõ¥Êñ∞ËøõÂ∫¶Êù°ÂÆΩÂ∫¶
                progressBar.style.width = socValue + '%';
                
                // Êõ¥Êñ∞ÂúÜÁÇπ‰ΩçÁΩÆ
                progressDot.style.left = socValue + '%';
                
                // Êõ¥Êñ∞ËæìÂÖ•Ê°ÜÂÄº
                socInput.value = socValue;
                
                // Êõ¥Êñ∞ÊòæÁ§∫ÂÄº
                if (socDisplay) {
                    socDisplay.textContent = socValue;
                }
                
                // Êõ¥Êñ∞ÊªëÂä®Êù°ÂÄº
                socSlider.value = socValue;
                
                // Êõ¥Êñ∞autoSettings‰∏≠ÁöÑÂÄº
                if (window.autoSettings) {
                    window.autoSettings.charge.stopSOC = parseInt(socValue);
                }
            }
            
        }

        // ‰ªéËæìÂÖ•Ê°ÜÊõ¥Êñ∞ÂÖÖÁîµÂÅúÊ≠¢SOC
        function updateChargeSOCFromInput(socValue) {
            // ÈôêÂà∂Âú®0-100ËåÉÂõ¥ÂÜÖ
            const validValue = Math.max(0, Math.min(100, parseInt(socValue) || 0));
            
            // Â¶ÇÊûúËæìÂÖ•ÂÄºÊó†ÊïàÔºåÈáçÁΩÆ‰∏∫ÊúâÊïàÂÄº
            const socInput = document.getElementById('chargeStopSOCInput');
            if (socInput) {
                socInput.value = validValue;
            }
            
            // Êõ¥Êñ∞ËøõÂ∫¶Êù°
            updateChargeSOC(validValue);
        }

        // Êõ¥Êñ∞ÊîæÁîµÂÅúÊ≠¢SOCËøõÂ∫¶Êù°
        function updateDischargeSOC(socValue, skipConfirmation = false) {
            // Ê£ÄÊü•ÂΩìÂâçÂú∞Âå∫ÊòØÂê¶ÊúâËøêË°åÁä∂ÊÄÅ
            const regionStatus = getRegionOperationStatus(selectedMainRegion);
            const hasRunningStatus = regionStatus === 'charging' || regionStatus === 'discharging';
            
            if (hasRunningStatus && !skipConfirmation) {
                // ÊúâËøêË°åÁä∂ÊÄÅÔºåÊòæÁ§∫Á°ÆËÆ§ÂºπÁ™ó
                showSOCChangeConfirmation('discharge', socValue);
                return;
            }
            
            const progressBar = document.getElementById('dischargeSOCProgressBar');
            const progressDot = document.getElementById('dischargeSOCProgressDot');
            const socInput = document.getElementById('dischargeStopSOCInput');
            const socDisplay = document.getElementById('dischargeStopSOCDisplay');
            const socSlider = document.getElementById('dischargeSOCSlider');
            
            if (progressBar && progressDot && socInput && socSlider) {
                // ËøõÂ∫¶Êù°‰ªé socValue Â°´ÂÖÖÂà∞ 100%
                progressBar.style.left = socValue + '%';
                progressBar.style.width = (100 - socValue) + '%';
                
                // Êõ¥Êñ∞ÂúÜÁÇπ‰ΩçÁΩÆ
                progressDot.style.left = socValue + '%';
                
                // Êõ¥Êñ∞ËæìÂÖ•Ê°ÜÂÄº
                socInput.value = socValue;
                
                // Êõ¥Êñ∞ÊòæÁ§∫ÂÄº
                if (socDisplay) {
                    socDisplay.textContent = socValue;
                }
                
                // Êõ¥Êñ∞ÊªëÂä®Êù°ÂÄº
                socSlider.value = socValue;
                
                // Êõ¥Êñ∞autoSettings‰∏≠ÁöÑÂÄº
                if (window.autoSettings) {
                    window.autoSettings.discharge.stopSOC = parseInt(socValue);
                }
            }
            
        }

        // ‰ªéËæìÂÖ•Ê°ÜÊõ¥Êñ∞ÊîæÁîµÂÅúÊ≠¢SOC
        function updateDischargeSOCFromInput(socValue) {
            // ÈôêÂà∂Âú®0-100ËåÉÂõ¥ÂÜÖ
            const validValue = Math.max(0, Math.min(100, parseInt(socValue) || 0));
            
            // Â¶ÇÊûúËæìÂÖ•ÂÄºÊó†ÊïàÔºåÈáçÁΩÆ‰∏∫ÊúâÊïàÂÄº
            const socInput = document.getElementById('dischargeStopSOCInput');
            if (socInput) {
                socInput.value = validValue;
            }
            
            // Êõ¥Êñ∞ËøõÂ∫¶Êù°
            updateDischargeSOC(validValue);
        }

        // Modal‰∏≠ÂÖÖÁîµSOCÊõ¥Êñ∞ÂáΩÊï∞
        function updateModalChargeSOC(socValue) {
            const validValue = Math.max(0, Math.min(100, parseInt(socValue) || 0));
            
            // Êõ¥Êñ∞ËæìÂÖ•Ê°Ü
            const socInput = document.getElementById('modalChargeStopSOC');
            const socInputAlt = document.getElementById('modalChargeSOCInput');
            if (socInput && parseInt(socInput.value) !== validValue) {
                socInput.value = validValue;
            }
            if (socInputAlt && parseInt(socInputAlt.value) !== validValue) {
                socInputAlt.value = validValue;
            }
            
            // Êõ¥Êñ∞ÊªëÂùó
            const socSlider = document.getElementById('modalChargeSOCSlider');
            if (socSlider && parseInt(socSlider.value) !== validValue) {
                socSlider.value = validValue;
            }
            
            // Êõ¥Êñ∞ËøõÂ∫¶Êù°
            const progressBar = document.getElementById('modalChargeSOCBar');
            if (progressBar) {
                progressBar.style.width = validValue + '%';
            } else {
                console.error('modalChargeSOCBar element not found!');
            }
            
            // Êõ¥Êñ∞ÊªëÂùó‰ΩçÁΩÆ
            const dot = document.getElementById('modalChargeSOCDot');
            const thumb = document.getElementById('modalChargeSOCThumb');
            if (dot) {
                dot.style.left = validValue + '%';
            } else {
                console.error('modalChargeSOCDot element not found!');
            }
            if (thumb) {
                thumb.style.left = validValue + '%';
            }
            
            // ÂêåÊ≠•Êõ¥Êñ∞‰∏ªÈ°µÈù¢ÊòæÁ§∫
            updateMainPageChargeSOC(validValue);
        }

        // Modal‰∏≠ÊîæÁîµSOCÊõ¥Êñ∞ÂáΩÊï∞
        function updateModalDischargeSOC(socValue) {
            const validValue = Math.max(0, Math.min(100, parseInt(socValue) || 0));
            
            // Êõ¥Êñ∞ËæìÂÖ•Ê°Ü
            const socInput = document.getElementById('modalDischargeStopSOC');
            const socInputAlt = document.getElementById('modalDischargeSOCInput');
            if (socInput && parseInt(socInput.value) !== validValue) {
                socInput.value = validValue;
            }
            if (socInputAlt && parseInt(socInputAlt.value) !== validValue) {
                socInputAlt.value = validValue;
            }
            
            // Êõ¥Êñ∞ÊªëÂùó
            const socSlider = document.getElementById('modalDischargeSOCSlider');
            if (socSlider && parseInt(socSlider.value) !== validValue) {
                socSlider.value = validValue;
            }
            
            // Êõ¥Êñ∞ËøõÂ∫¶Êù° (ÊîæÁîµ‰ªéÊï∞ÂÄº‰ΩçÁΩÆÂ°´ÂÖÖÂà∞100%)
            const progressBar = document.getElementById('modalDischargeSOCProgressBar');
            const progressBarAlt = document.getElementById('modalDischargeSOCBar');
            if (progressBar) {
                progressBar.style.left = validValue + '%';
                progressBar.style.width = (100 - validValue) + '%';
            } else {
                console.error('modalDischargeSOCProgressBar element not found!');
            }
            if (progressBarAlt) {
                progressBarAlt.style.left = validValue + '%';
                progressBarAlt.style.width = (100 - validValue) + '%';
            }
            
            // Êõ¥Êñ∞ÊªëÂùó‰ΩçÁΩÆ
            const dot = document.getElementById('modalDischargeSOCDot');
            const thumb = document.getElementById('modalDischargeSOCThumb');
            if (dot) {
                dot.style.left = validValue + '%';
            } else {
                console.error('modalDischargeSOCDot element not found!');
            }
            if (thumb) {
                thumb.style.left = validValue + '%';
            }
            
            // ÂêåÊ≠•Êõ¥Êñ∞‰∏ªÈ°µÈù¢ÊòæÁ§∫
            updateMainPageDischargeSOC(validValue);
        }

        // ÂêåÊ≠•Êõ¥Êñ∞‰∏ªÈ°µÈù¢ÂÖÖÁîµSOCÊòæÁ§∫
        function updateMainPageChargeSOC(socValue) {
            const valueDisplay = document.getElementById('chargeStopSOCValue');
            if (valueDisplay) {
                valueDisplay.textContent = socValue + '%';
            }
            
            const progressBar = document.getElementById('chargeSOCProgressBar');
            if (progressBar) {
                progressBar.style.width = socValue + '%';
            }
        }

        // ÂêåÊ≠•Êõ¥Êñ∞‰∏ªÈ°µÈù¢ÊîæÁîµSOCÊòæÁ§∫
        function updateMainPageDischargeSOC(socValue) {
            const valueDisplay = document.getElementById('dischargeStopSOCValue');
            if (valueDisplay) {
                valueDisplay.textContent = socValue + '%';
            }
            
            const progressBar = document.getElementById('dischargeSOCProgressBar');
            if (progressBar) {
                progressBar.style.left = socValue + '%';
                progressBar.style.width = (100 - socValue) + '%';
            }
        }

        // ÂêåÊ≠•‰∏ªÈ°µÈù¢SOCÂÄºÂà∞Modal
        function syncSOCToModal() {
            // Ëé∑Âèñ‰∏ªÈ°µÈù¢ÁöÑSOCÂÄº
            const chargeValue = document.getElementById('chargeStopSOCValue');
            const dischargeValue = document.getElementById('dischargeStopSOCValue');
            
            if (chargeValue) {
                const chargeSOC = parseInt(chargeValue.textContent) || 90;
                updateModalChargeSOC(chargeSOC);
            }
            
            if (dischargeValue) {
                const dischargeSOC = parseInt(dischargeValue.textContent) || 20;
                updateModalDischargeSOC(dischargeSOC);
            }
        }

        // ÁÇπÂáªÂÖÖÁîµSOCËøõÂ∫¶Êù°ËÆæÁΩÆÂÄº
        function handleChargeSOCClick(event) {
            const container = document.getElementById('chargeSOCProgressContainer');
            const rect = container.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const percentage = Math.round((clickX / rect.width) * 100);
            
            // ÈôêÂà∂Âú®0-100ËåÉÂõ¥ÂÜÖ
            const socValue = Math.max(0, Math.min(100, percentage));
            
            // Êõ¥Êñ∞SOCÂÄº
            updateChargeSOC(socValue);
        }

        // ÁÇπÂáªÊîæÁîµSOCËøõÂ∫¶Êù°ËÆæÁΩÆÂÄº
        function handleDischargeSOCClick(event) {
            const container = document.getElementById('dischargeSOCProgressContainer');
            const rect = container.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const percentage = Math.round((clickX / rect.width) * 100);
            
            // ÈôêÂà∂Âú®0-100ËåÉÂõ¥ÂÜÖ
            const socValue = Math.max(0, Math.min(100, percentage));
            
            // Êõ¥Êñ∞SOCÂÄº
            updateDischargeSOC(socValue);
        }

        // È™åËØÅSOCËæìÂÖ•
        function validateSOCInput(input, type) {
            const value = parseInt(input.value);
            if (isNaN(value) || value < 0 || value > 100) {
                // ÊÅ¢Â§çÂà∞‰πãÂâçÁöÑÊúâÊïàÂÄº
                if (type === 'charge') {
                    input.value = document.getElementById('chargeSOCSlider').value;
                } else {
                    input.value = document.getElementById('dischargeSOCSlider').value;
                }
                return;
            }
            
            // Êõ¥Êñ∞Áõ∏Â∫îÁöÑSOCÂÄº
            if (type === 'charge') {
                updateChargeSOC(value);
            } else {
                updateDischargeSOC(value);
            }
        }

        // ÊòæÁ§∫SOCÂèòÊõ¥Á°ÆËÆ§ÂºπÁ™ó
        function showSOCChangeConfirmation(type, newValue) {
            const regionStatus = getRegionOperationStatus(selectedMainRegion);
            const statusText = regionStatus === 'charging' ? 
                (window.i18n ? window.i18n.getText('charging') : 'ÂÖÖÁîµ‰∏≠') : 
                (window.i18n ? window.i18n.getText('discharging') : 'ÊîæÁîµ‰∏≠');
            
            const socTypeText = type === 'charge' ? 
                (window.i18n ? window.i18n.getText('chargeStopSOC') : 'ÂÖÖÁîµÂÅúÊ≠¢SOC') : 
                (window.i18n ? window.i18n.getText('dischargeStopSOC') : 'ÊîæÁîµÂÅúÊ≠¢SOC');
            
            const message = window.i18n?.getText('socChangeConfirmMessage') || 
                `ÂΩìÂâçÂú∞Âå∫Ê≠£Âú®${statusText}ÔºåÊòØÂê¶Á´ãÂç≥Â∫îÁî®${socTypeText}Êõ¥Êîπ‰∏∫${newValue}%Ôºü`;
            
            // ÂàõÂª∫Á°ÆËÆ§ÂºπÁ™ó
            const modal = document.createElement('div');
            modal.id = 'socChangeConfirmModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.6);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 2147483647;
                backdrop-filter: blur(15px) saturate(1.5);
            `;
            
            const dialog = document.createElement('div');
            dialog.style.cssText = `
                background: rgba(20, 20, 30, 0.95);
                border: 1px solid rgba(255, 255, 255, 0.2);
                border-radius: 10px;
                padding: 24px;
                max-width: 400px;
                width: 90%;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(20px);
                color: #fff;
            `;
            
            dialog.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 18px; font-weight: 600; margin-bottom: 12px; color: ${type === 'charge' ? '#00ff88' : '#ffc107'};">
                        ${window.i18n?.getText('confirmSOCChange') || 'SOCËÆæÁΩÆÁ°ÆËÆ§'}
                    </div>
                    <div style="font-size: 14px; line-height: 1.5; color: rgba(255, 255, 255, 0.8);">
                        ${message}
                    </div>
                </div>
                <div style="display: flex; gap: 12px; justify-content: center;">
                    <button id="socChangeApplyNow" style="
                        background: linear-gradient(135deg, ${type === 'charge' ? '#00ff88, #00cc6a' : '#ffc107, #ff9800'});
                        color: #000;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 10px;
                        font-size: 13px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.3s;
                    ">
                        ${window.i18n?.getText('applyNow') || 'Á´ãÂç≥Â∫îÁî®'}
                    </button>
                    <button id="socChangeApplyNext" style="
                        background: rgba(255, 255, 255, 0.08);
                        color: rgba(255, 255, 255, 0.8);
                        border: 1px solid rgba(255, 255, 255, 0.2);
                        padding: 10px 20px;
                        border-radius: 10px;
                        font-size: 13px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.3s;
                    ">
                        ${window.i18n?.getText('applyNext') || '‰∏ãÊ¨°Â∫îÁî®'}
                    </button>
                    <button id="socChangeCancel" style="
                        background: rgba(255, 255, 255, 0.05);
                        color: rgba(255, 255, 255, 0.6);
                        border: 1px solid rgba(255, 255, 255, 0.1);
                        padding: 10px 20px;
                        border-radius: 10px;
                        font-size: 13px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.3s;
                    ">
                        ${window.i18n?.getText('cancel') || 'ÂèñÊ∂à'}
                    </button>
                </div>
            `;
            
            modal.appendChild(dialog);
            document.body.appendChild(modal);
            
            // ÁªëÂÆö‰∫ã‰ª∂
            document.getElementById('socChangeApplyNow').onclick = () => {
                // Á´ãÂç≥Â∫îÁî®
                if (type === 'charge') {
                    updateChargeSOC(newValue, true);
                } else {
                    updateDischargeSOC(newValue, true);
                }
                closeSocChangeModal();
            };
            
            document.getElementById('socChangeApplyNext').onclick = () => {
                // ‰∏ãÊ¨°Â∫îÁî® - ‰øùÂ≠òËÆæÁΩÆ‰ΩÜ‰∏çÁ´ãÂç≥Êõ¥Êñ∞ÊòæÁ§∫
                if (window.autoSettings) {
                    if (type === 'charge') {
                        window.autoSettings.charge.stopSOC = parseInt(newValue);
                    } else {
                        window.autoSettings.discharge.stopSOC = parseInt(newValue);
                    }
                }
                closeSocChangeModal();
            };
            
            document.getElementById('socChangeCancel').onclick = () => {
                // ÂèñÊ∂à - ÊÅ¢Â§çÂéüÂÄº
                if (type === 'charge') {
                    const slider = document.getElementById('chargeSOCSlider');
                    const input = document.getElementById('chargeStopSOCInput');
                    if (slider && input) {
                        input.value = slider.value;
                    }
                } else {
                    const slider = document.getElementById('dischargeSOCSlider');
                    const input = document.getElementById('dischargeStopSOCInput');
                    if (slider && input) {
                        input.value = slider.value;
                    }
                }
                closeSocChangeModal();
            };
            
            // ÁÇπÂáªËÉåÊôØÂÖ≥Èó≠
            modal.onclick = (e) => {
                if (e.target === modal) {
                    document.getElementById('socChangeCancel').click();
                }
            };
        }

        // ÂÖ≥Èó≠SOCÂèòÊõ¥Á°ÆËÆ§ÂºπÁ™ó
        function closeSocChangeModal() {
            const modal = document.getElementById('socChangeConfirmModal');
            if (modal) {
                modal.remove();
            }
        }

        // Âú∞Âå∫Êù°‰ª∂ÊÄªËßàÂç°ÁâáÂäüËÉΩ
        let regionOverviewCardMinimized = false;

        // ÂàáÊç¢Âú∞Âå∫Êù°‰ª∂ÊÄªËßàÂç°ÁâáÂ±ïÂºÄ/Áº©Â∞èÁä∂ÊÄÅ
        function toggleRegionOverviewCardExpansion() {
            const card = document.getElementById('regionOverviewCard');
            if (!card) return;

            regionOverviewCardMinimized = !regionOverviewCardMinimized;
            
            if (regionOverviewCardMinimized) {
                card.classList.add('minimized');
            } else {
                card.classList.remove('minimized');
            }
        }
        
        // ÂÖ≥Èó≠Âú∞Âå∫Êù°‰ª∂ÊÄªËßàÂç°Áâá
        function closeRegionOverviewCard() {
            const card = document.getElementById('regionOverviewCard');
            const autoBtn = document.getElementById('autoConditionBtn');
            
            if (card) {
                card.style.display = 'none';
                // Á°Æ‰øù‰∏çÊòØÁº©Â∞èÁä∂ÊÄÅ
                card.classList.remove('minimized');
                regionOverviewCardMinimized = false;
                
                // ÊÅ¢Â§çÊåâÈíÆ‰∏∫Êú™ÈÄâ‰∏≠Áä∂ÊÄÅ
                if (autoBtn) {
                    autoBtn.style.background = 'rgba(255, 255, 255, 0.08)';
                    autoBtn.style.color = 'rgba(255, 255, 255, 0.8)';
                    autoBtn.style.border = '1px solid rgba(255, 255, 255, 0.1)';
                    autoBtn.style.boxShadow = 'none';
                    autoBtn.style.fontWeight = '600';
                    autoBtn.style.transform = 'scale(1)';
                    autoBtn.classList.remove('selected');
                }
            }
        }

        // ÂàùÂßãÂåñÂú∞Âå∫Êù°‰ª∂ÊÄªËßàÂç°Áâá
        function initRegionOverviewCard() {
            const card = document.getElementById('regionOverviewCard');
            if (!card) return;

            // ‰ΩøÂç°ÁâáÂèØÊãñÊãΩ
            makeRegionOverviewCardDraggable(card);
            
            // ÂàùÂßãÂåñÂÜÖÂÆπ
            updateRegionOverviewContent();
            
            // ÁõëÂê¨Âú∞Âå∫ÂèòÂåñ
            if (typeof selectedMainRegion !== 'undefined') {
                // ÂΩìÂú∞Âå∫ÂèòÂåñÊó∂Êõ¥Êñ∞ÂÜÖÂÆπ
                const originalSwitchRegion = window.switchMainRegion;
                if (originalSwitchRegion) {
                    window.switchMainRegion = function(region) {
                        originalSwitchRegion(region);
                        setTimeout(updateRegionOverviewContent, 100);
                    };
                }
            }
        }

        // ‰ΩøÂú∞Âå∫Êù°‰ª∂ÊÄªËßàÂç°ÁâáÂèØÊãñÊãΩ
        function makeRegionOverviewCardDraggable(element) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            
            element.onmousedown = dragMouseDown;

            function dragMouseDown(e) {
                e = e || window.event;
                
                // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÊåâÈíÆÔºå‰∏çÂêØÂä®ÊãñÊãΩ
                const target = e.target;
                if (target.tagName === 'BUTTON' || target.closest('button')) {
                    return;
                }
                
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
                element.style.cursor = 'grabbing';
                element.style.transition = 'none';
            }

            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                
                let newTop = element.offsetTop - pos2;
                let newLeft = element.offsetLeft - pos1;
                
                // ËæπÁïåÊ£ÄÊµã
                const rect = element.getBoundingClientRect();
                const maxX = window.innerWidth - rect.width;
                const maxY = window.innerHeight - rect.height;
                
                newLeft = Math.max(0, Math.min(newLeft, maxX));
                newTop = Math.max(0, Math.min(newTop, maxY));
                
                element.style.top = newTop + "px";
                element.style.left = newLeft + "px";
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
                element.style.cursor = 'move';
                element.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
            }
        }

        // Êõ¥Êñ∞Âú∞Âå∫Êù°‰ª∂ÊÄªËßàÂÜÖÂÆπ
        function updateRegionOverviewContent() {
            const body = document.getElementById('regionOverviewBody');
            if (!body) return;


            // Ê®°ÊãüÂú∞Âå∫Êï∞ÊçÆ
            const regions = [
                {
                    name: 'NSW',
                    status: getRegionOperationStatus('NSW'),
                    chargeCondition: {
                        timeCondition: '08:00-09:00',
                        priceCondition: '< 60$',
                        stopSOC: '70%'
                    },
                    dischargeCondition: {
                        timeCondition: '18:00-20:00', 
                        priceCondition: '> 100$',
                        stopSOC: '20%'
                    }
                },
                {
                    name: 'VIC',
                    status: getRegionOperationStatus('VIC'),
                    chargeCondition: {
                        timeCondition: '07:30-08:30',
                        priceCondition: '< 55$',
                        stopSOC: '80%'
                    },
                    dischargeCondition: {
                        timeCondition: '17:00-19:00',
                        priceCondition: '> 90$', 
                        stopSOC: '25%'
                    }
                },
                {
                    name: 'QLD', 
                    status: getRegionOperationStatus('QLD'),
                    chargeCondition: {
                        timeCondition: '09:00-10:00',
                        priceCondition: '< 50$',
                        stopSOC: '75%'
                    },
                    dischargeCondition: {
                        timeCondition: '16:00-18:00',
                        priceCondition: '> 110$',
                        stopSOC: '15%'
                    }
                },
                {
                    name: 'SA',
                    status: getRegionOperationStatus('SA'), 
                    chargeCondition: {
                        timeCondition: '08:15-09:15',
                        priceCondition: '< 65$',
                        stopSOC: '85%'
                    },
                    dischargeCondition: {
                        timeCondition: '17:30-19:30',
                        priceCondition: '> 95$',
                        stopSOC: '30%'
                    }
                },
                {
                    name: 'TAS',
                    status: getRegionOperationStatus('TAS'),
                    chargeCondition: {
                        timeCondition: '07:00-08:00', 
                        priceCondition: '< 45$',
                        stopSOC: '90%'
                    },
                    dischargeCondition: {
                        timeCondition: '18:30-20:30',
                        priceCondition: '> 85$',
                        stopSOC: '10%'
                    }
                }
            ];

            // ÁîüÊàêË°®Ê†ºHTML
            const tableHTML = `
                <table class="region-comparison-table">
                    <thead>
                        <tr>
                            <th style="width: 100px;" data-i18n="region">Âú∞Âå∫</th>
                            <th class="table-header-charge" colspan="3" data-i18n="chargeCondition">ÂÖÖÁîµÊù°‰ª∂</th>
                            <th class="table-header-discharge" colspan="3" data-i18n="dischargeCondition">ÊîæÁîµÊù°‰ª∂</th>
                        </tr>
                        <tr>
                            <th></th>
                            <th class="table-header-charge" data-i18n="timeCondition">Êó∂Èó¥</th>
                            <th class="table-header-charge" data-i18n="priceCondition">‰ª∑Ê†º</th>
                            <th class="table-header-charge" data-i18n="stopSOC">ÂÅúÊ≠¢SOC</th>
                            <th class="table-header-discharge" data-i18n="timeCondition">Êó∂Èó¥</th>
                            <th class="table-header-discharge" data-i18n="priceCondition">‰ª∑Ê†º</th>
                            <th class="table-header-discharge" data-i18n="stopSOC">ÂÅúÊ≠¢SOC</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${regions.map(region => {
                            // Â∞Ü 'none' Áä∂ÊÄÅÊò†Â∞Ñ‰∏∫ 'idle'
                            const mappedStatus = region.status === 'none' ? 'idle' : region.status;
                            const statusClass = mappedStatus === 'charging' ? 'charging' : 
                                              mappedStatus === 'discharging' ? 'discharging' : 'idle';
                            
                            return `
                                <tr>
                                    <td>
                                        <div class="region-name-cell">
                                            <span>${region.name}</span>
                                            <div class="region-status-indicator ${statusClass}"></div>
                                        </div>
                                    </td>
                                    <td class="condition-cell">
                                        <span class="condition-value">${region.chargeCondition.timeCondition}</span>
                                    </td>
                                    <td class="condition-cell">
                                        <span class="condition-value">${region.chargeCondition.priceCondition}</span>
                                    </td>
                                    <td class="condition-cell">
                                        <span class="condition-value">${region.chargeCondition.stopSOC}</span>
                                    </td>
                                    <td class="condition-cell">
                                        <span class="condition-value">${region.dischargeCondition.timeCondition}</span>
                                    </td>
                                    <td class="condition-cell">
                                        <span class="condition-value">${region.dischargeCondition.priceCondition}</span>
                                    </td>
                                    <td class="condition-cell">
                                        <span class="condition-value">${region.dischargeCondition.stopSOC}</span>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;

            body.innerHTML = tableHTML;

            // Â∫îÁî®i18nÁøªËØë
            if (window.i18n && window.i18n.isReady) {
                window.i18n.updatePageTexts();
            }
        }

        // ÂàáÊç¢Âú∞Âå∫ÊäòÂè†È°π
        function toggleRegionAccordion(regionName) {
            const item = document.querySelector(`.region-accordion-item[data-region="${regionName}"]`);
            if (!item) return;
            
            item.classList.toggle('expanded');
            
            // Â¶ÇÊûúÈúÄË¶ÅÔºåÂèØ‰ª•ÂÖ≥Èó≠ÂÖ∂‰ªñÂ±ïÂºÄÁöÑÈ°π
            // document.querySelectorAll('.region-accordion-item').forEach(otherItem => {
            //     if (otherItem !== item) {
            //         otherItem.classList.remove('expanded');
            //     }
            // });
        }

        // ÁºñËæëÂÖÖÁîµÂÅúÊ≠¢SOC
        function editChargeStopSOC() {
            const display = document.getElementById('chargeStopSOCDisplay');
            const input = document.getElementById('chargeStopSOCInput');
            if (display && input) {
                display.style.display = 'none';
                input.style.display = 'block';
                input.focus();
                input.select();
            }
        }

        // ÈöêËóèÂÖÖÁîµSOCËæìÂÖ•Ê°Ü
        function hideChargeSOCInput() {
            const display = document.getElementById('chargeStopSOCDisplay');
            const input = document.getElementById('chargeStopSOCInput');
            if (display && input) {
                display.style.display = 'inline';
                input.style.display = 'none';
                // Êõ¥Êñ∞ÊòæÁ§∫ÁöÑÂÄº
                display.textContent = input.value;
            }
        }

        // ÁºñËæëÊîæÁîµÂÅúÊ≠¢SOC
        function editDischargeStopSOC() {
            const display = document.getElementById('dischargeStopSOCDisplay');
            const input = document.getElementById('dischargeStopSOCInput');
            if (display && input) {
                display.style.display = 'none';
                input.style.display = 'block';
                input.focus();
                input.select();
            }
        }

        // ÈöêËóèÊîæÁîµSOCËæìÂÖ•Ê°Ü
        function hideDischargeSOCInput() {
            const display = document.getElementById('dischargeStopSOCDisplay');
            const input = document.getElementById('dischargeStopSOCInput');
            if (display && input) {
                display.style.display = 'inline';
                input.style.display = 'none';
                // Êõ¥Êñ∞ÊòæÁ§∫ÁöÑÂÄº
                display.textContent = input.value;
            }
        }
        
        // ÊòæÁ§∫SOCÁºñËæëËíôÁâà
        function showSOCEditOverlay() {
            const overlay = document.getElementById('socEditOverlay');
            if (overlay) {
                overlay.style.display = 'flex';
            }
        }
        
        // ÈöêËóèSOCÁºñËæëËíôÁâà
        function hideSOCEditOverlay() {
            const overlay = document.getElementById('socEditOverlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }
        
        // ÊâìÂºÄSOCÁºñËæëÂºπÁ™ó
        function openSOCEditModal() {
            const modal = document.getElementById('socEditModal');
            if (!modal) return;
            
            // Ëé∑ÂèñÂΩìÂâçÂÄº
            const chargeDisplay = document.getElementById('chargeStopSOCDisplay');
            const dischargeDisplay = document.getElementById('dischargeStopSOCDisplay');
            const currentCharge = chargeDisplay ? parseInt(chargeDisplay.textContent) : 90;
            const currentDischarge = dischargeDisplay ? parseInt(dischargeDisplay.textContent) : 20;
            
            // ËÆæÁΩÆÂºπÁ™óÂàùÂßãÂÄº
            const chargeSlider = document.getElementById('modalChargeSOCSlider');
            const chargeInput = document.getElementById('modalChargeSOCInput');
            const dischargeSlider = document.getElementById('modalDischargeSOCSlider');
            const dischargeInput = document.getElementById('modalDischargeSOCInput');
            
            if (chargeSlider) chargeSlider.value = currentCharge;
            if (chargeInput) chargeInput.value = currentCharge;
            if (dischargeSlider) dischargeSlider.value = currentDischarge;
            if (dischargeInput) dischargeInput.value = currentDischarge;
            
            // Êõ¥Êñ∞ËøõÂ∫¶Êù°
            updateModalChargeSOC(currentCharge);
            updateModalDischargeSOC(currentDischarge);
            
            // ÊòæÁ§∫ÂºπÁ™ó
            modal.style.display = 'flex';
            
            // Êõ¥Êñ∞i18n
            if (window.i18n && window.i18n.updatePageTexts) {
                setTimeout(() => {
                    window.i18n.updatePageTexts();
                }, 50);
            }
        }
        
        // ÂÖ≥Èó≠SOCÁºñËæëÂºπÁ™ó
        function closeSOCEditModal() {
            const modal = document.getElementById('socEditModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Êõ¥Êñ∞ÂºπÁ™ó‰∏≠ÁöÑÂÖÖÁîµSOC
        function updateModalChargeSOCFromInput(value) {
            const validValue = Math.max(0, Math.min(100, parseInt(value) || 0));
            const input = document.getElementById('modalChargeSOCInput');
            if (input) input.value = validValue;
            updateModalChargeSOC(validValue);
        }
        
        
        function updateModalDischargeSOCFromInput(value) {
            const validValue = Math.max(0, Math.min(100, parseInt(value) || 0));
            const input = document.getElementById('modalDischargeSOCInput');
            if (input) input.value = validValue;
            updateModalDischargeSOC(validValue);
        }
        
        // ‰øùÂ≠òSOCËÆæÁΩÆ
        function saveSOCSettings() {
            // Ëé∑ÂèñÊñ∞ÂÄº
            const chargeSOC = document.getElementById('modalChargeSOCInput').value;
            const dischargeSOC = document.getElementById('modalDischargeSOCInput').value;
            
            // Êõ¥Êñ∞‰∏ªÈ°µÈù¢ÊòæÁ§∫
            const chargeDisplay = document.getElementById('chargeStopSOCDisplay');
            const dischargeDisplay = document.getElementById('dischargeStopSOCDisplay');
            const chargeProgressBar = document.getElementById('chargeSOCProgressBar');
            const dischargeProgressBar = document.getElementById('dischargeSOCProgressBar');
            
            if (chargeDisplay) chargeDisplay.textContent = chargeSOC;
            if (dischargeDisplay) dischargeDisplay.textContent = dischargeSOC;
            if (chargeProgressBar) chargeProgressBar.style.width = chargeSOC + '%';
            if (dischargeProgressBar) {
                dischargeProgressBar.style.left = dischargeSOC + '%';
                dischargeProgressBar.style.width = (100 - dischargeSOC) + '%';
            }
            
            // Êõ¥Êñ∞ÂÖ®Â±ÄËÆæÁΩÆ
            if (window.autoSettings) {
                window.autoSettings.charge.stopSOC = parseInt(chargeSOC);
                window.autoSettings.discharge.stopSOC = parseInt(dischargeSOC);
            }
            
            // ÂÖ≥Èó≠ÂºπÁ™ó
            closeSOCEditModal();
            
        }

        // ÁÇπÂáªÂÖÖÁîµSOCËøõÂ∫¶Êù°ËÆæÁΩÆÂÄº
        function handleChargeSOCBarClick(event) {
            const progressContainer = event.currentTarget;
            const rect = progressContainer.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const containerWidth = rect.width;
            const percentage = Math.round((clickX / containerWidth) * 100);
            
            // ÈôêÂà∂Âú®0-100ËåÉÂõ¥ÂÜÖ
            const socValue = Math.max(0, Math.min(100, percentage));
            
            // Êõ¥Êñ∞ÊªëÂä®Êù°ÂÄº
            const slider = document.getElementById('chargeSOCSlider');
            if (slider) {
                slider.value = socValue;
                updateChargeSOC(socValue);
            }
        }

        // ÁÇπÂáªÊîæÁîµSOCËøõÂ∫¶Êù°ËÆæÁΩÆÂÄº
        function handleDischargeSOCBarClick(event) {
            const progressContainer = event.currentTarget;
            const rect = progressContainer.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const containerWidth = rect.width;
            const percentage = Math.round((clickX / containerWidth) * 100);
            
            // ÈôêÂà∂Âú®0-100ËåÉÂõ¥ÂÜÖ
            const socValue = Math.max(0, Math.min(100, percentage));
            
            // Êõ¥Êñ∞ÊªëÂä®Êù°ÂÄº
            const slider = document.getElementById('dischargeSOCSlider');
            if (slider) {
                slider.value = socValue;
                updateDischargeSOC(socValue);
            }
        }

        // Êõ¥Êñ∞ÂÖÖÁîµ/ÊîæÁîµÊåâÈíÆÁöÑÊòæÁ§∫Áä∂ÊÄÅ
        function updateActionButtonsVisibility() {
            const chargeBtn = document.getElementById('chargeBtn');
            const dischargeBtn = document.getElementById('dischargeBtn');
            const priceDisplay = document.getElementById('priceDisplay');
            const stopDisplay = document.getElementById('stopDisplay');

            if (!chargeBtn || !dischargeBtn) return;

            // ‰ΩøÁî® regionData Ëé∑ÂèñÊõ¥ÂáÜÁ°ÆÁöÑÁä∂ÊÄÅ
            const regionStatus = regionData[selectedMainRegion] ? regionData[selectedMainRegion].status : 'none';

            // Ê£ÄÊü•ÊòØÂê¶ÊúâÊìç‰ΩúÊ≠£Âú®ËøõË°å
            const shouldHideButtons = regionStatus === 'autoCharge' || regionStatus === 'manualCharge' ||
                                     regionStatus === 'autoDischarge' || regionStatus === 'manualDischarge';
            
            if (shouldHideButtons) {
                // Êìç‰ΩúËøõË°å‰∏≠ÔºåÈöêËóèÂÖÖÊîæÁîµÊåâÈíÆ
                chargeBtn.style.display = 'none';
                dischargeBtn.style.display = 'none';
            } else {
                // Ê≤°ÊúâÊìç‰ΩúËøõË°å‰∏≠ÔºåÊ†πÊçÆÊ®°ÂºèÊòæÁ§∫ÊåâÈíÆ
                if (currentOperationMode === 'auto') {
                    // Ëá™Âä®Ê®°Âºè‰∏ãÈöêËóèÊåâÈíÆ
                    chargeBtn.style.display = 'none';
                    dischargeBtn.style.display = 'none';
                } else {
                    // ÊâãÂä®Ê®°Âºè‰∏ãÊòæÁ§∫ÊåâÈíÆ
                    chargeBtn.style.display = 'flex';
                    dischargeBtn.style.display = 'flex';
                    chargeBtn.disabled = false;
                    dischargeBtn.disabled = false;
                    chargeBtn.style.opacity = '1';
                    dischargeBtn.style.opacity = '1';
                    chargeBtn.style.cursor = 'pointer';
                    dischargeBtn.style.cursor = 'pointer';
                }

                // ÊòæÁ§∫‰ª∑Ê†ºÊñáÂ≠ó
                if (priceDisplay) priceDisplay.style.display = 'block';
                if (stopDisplay) {
                    stopDisplay.style.display = 'none';
                    stopDisplay.style.opacity = '0';
                }

                // Êõ¥Êñ∞Â§ßÂúÜÊòæÁ§∫Áä∂ÊÄÅ
                updateCircleStatusDisplay();
            }
        }

        // ËÆ°ÁÆóÂΩìÂâç‰ª∑Ê†ºÂú®‰ªäÊó•‰ΩéÈ´ò‰ª∑Ê†º‰∏≠ÁöÑÂç†ÊØîÂπ∂Êõ¥Êñ∞Ê∞¥Ê≥¢È´òÂ∫¶
        function updateWaterWaveLevel() {
            const currentPriceElement = document.getElementById('currentPrice');
            const todayLowElement = document.getElementById('todayLow');
            const todayHighElement = document.getElementById('todayHigh');
            const pricePercentageElement = document.getElementById('pricePercentage');
            const waterWave = document.getElementById('waterWave');
            
            if (!currentPriceElement || !todayLowElement || !todayHighElement || !pricePercentageElement || !waterWave) {
                return;
            }
            
            // ÊèêÂèñ‰ª∑Ê†ºÊï∞ÂÄº
            const currentPrice = parseFloat(currentPriceElement.textContent.replace('$', '').replace(/[^0-9.-]/g, '')) || 0;
            const todayLow = parseFloat(todayLowElement.textContent.replace('$', '').replace(/[^0-9.-]/g, '')) || 0;
            const todayHigh = parseFloat(todayHighElement.textContent.replace('$', '').replace(/[^0-9.-]/g, '')) || 0;
            
            
            // ËÆ°ÁÆó‰ª∑Ê†ºÂç†ÊØî (0-100%)
            let percentage = 0;
            if (todayHigh > todayLow) {
                percentage = ((currentPrice - todayLow) / (todayHigh - todayLow)) * 100;
                percentage = Math.max(0, Math.min(100, percentage)); // ÈôêÂà∂Âú®0-100%ËåÉÂõ¥ÂÜÖ
            }
            
            // Êõ¥Êñ∞ÁôæÂàÜÊØîÊòæÁ§∫
            pricePercentageElement.textContent = `${Math.round(percentage)}%`;
            
            // Êõ¥Êñ∞Ê∞¥‰ΩçÂÆπÂô®È´òÂ∫¶ÔºåËÄå‰∏çÊòØÊ∞¥Ê≥¢È´òÂ∫¶
            const waterLevelContainer = document.getElementById('waterLevelContainer');
            if (waterLevelContainer) {
                // Áõ¥Êé•‰ΩøÁî®‰ª∑Ê†ºÂç†ÊØî‰Ωú‰∏∫Ê∞¥‰ΩçÈ´òÂ∫¶
                waterLevelContainer.style.height = '100%';
            }
        }

        function stopOperation() {
            // Stop animation
            if (mapAnimationInterval) {
                clearInterval(mapAnimationInterval);
            }
            
            // Ê∏ÖÈô§Â§áÁî®ÂÆöÊó∂Âô®
            if (window.operationFallbackTimer) {
                clearTimeout(window.operationFallbackTimer);
                window.operationFallbackTimer = null;
            }
            
            // ‰øùÂ≠òÂÅúÊ≠¢ÂâçÁöÑÊìç‰ΩúÁ±ªÂûãÔºåÁî®‰∫éÊòæÁ§∫ÁªüËÆ°
            window.lastStoppedOperation = currentOperation;
            
            // ÈáçÁΩÆÂΩìÂâçÊìç‰ΩúÁä∂ÊÄÅ
            currentOperation = null;
            
            // Êõ¥Êñ∞Âú∞Âå∫Áä∂ÊÄÅ - ÁßªÈô§ÂΩìÂâçÂú∞Âå∫ÁöÑÂÖÖÊîæÁîµÊ†áËÆ∞
            updateRegionOperationStatus(selectedMainRegion, 'none');
            
            // ÈáçÁΩÆregionData‰∏≠ÁöÑÁä∂ÊÄÅ
            if (regionData[selectedMainRegion]) {
                const currentStatus = regionData[selectedMainRegion].status;
                // Â¶ÇÊûúÊòØËá™Âä®Ê®°ÂºèÊìç‰ΩúÔºåÂÅúÊ≠¢ÂêéÂèò‰∏∫Á≠âÂæÖÊâßË°å‰∏≠
                if (currentStatus === 'autoCharge' || currentStatus === 'autoDischarge') {
                    regionData[selectedMainRegion].status = 'waitingExecution';
                    updatePowerStationStatus(selectedMainRegion, 'waitingExecution');
                    
                    // Êõ¥Êñ∞Âú∞Âå∫ÈÄâÊã©Âô®Áä∂ÊÄÅ
                    setTimeout(() => {
                        const selectedRegionTab = document.querySelector('.region-select-tab.active');
                        if (selectedRegionTab) {
                            const statusBadge = selectedRegionTab.querySelector('.region-status-badge');
                            if (statusBadge) {
                                statusBadge.setAttribute('data-status', 'waitingExecution');
                                statusBadge.textContent = window.i18n ? window.i18n.getText('waitingExecution') : 'Á≠âÂæÖÊâßË°å‰∏≠';
                            }
                        }
                    }, 100);
                } else {
                    // ÊâãÂä®Ê®°ÂºèÊìç‰ΩúÔºåÂÅúÊ≠¢ÂêéÂèò‰∏∫none
                    regionData[selectedMainRegion].status = 'none';
                    updatePowerStationStatus(selectedMainRegion, 'none');
                }
            }
            
            // Êõ¥Êñ∞Âú∞Âå∫Áä∂ÊÄÅÊåáÁ§∫Âô®
            updateRegionStatusIndicators();
            
            // Êõ¥Êñ∞Âú∞Âå∫Áä∂ÊÄÅÊòæÁ§∫
            updateRegionStatusDisplay();
            
            // Á´ãÂç≥Êõ¥Êñ∞‰ª∑Ê†ºÂúÜÂúàÈ¢úËâ≤
            updatePriceCircleColor();
            
            // Ê∑ªÂä†Âª∂ËøüÁ°Æ‰øùÂúÜÂúàÈ¢úËâ≤Êõ¥Êñ∞
            setTimeout(() => {
                updatePriceCircleColor();
            }, 100);
            
            // ÊÅ¢Â§çÂÖÖÊîæÁîµÊåâÈíÆ
            updateActionButtonsToChargeDis();
            
            // ÂàáÊç¢Âà∞Ë°åÊÉÖÈù¢Êùø
            switchPanel('market');
            
            // Show operation completion modal with device response statistics
            setTimeout(() => {
                showOperationStatistics();
            }, 500);
            
            // Start gradual device reset animation
            startDeviceResetAnimation();
            
            // Update UI to initial state
            safeSetText('successfulDevices', '0');
            safeSetText('executingDevices', '0');
            safeSetText('failedDevices', '0');
            safeSetText('totalDevices', '500');
            
            // Reset buttons to original state
            resetButtons();
            
            // Don't reset currentOperation immediately - keep it for the modal
            // It will be reset when the modal is closed
            
            // Update map to show initial device distribution
            updateMapStatistics();
        }

        function startDeviceResetAnimation() {
            
            let resetStep = 0;
            const maxResetSteps = 50; // Reset animation over 50 steps
            const devicesPerStep = Math.ceil(deviceLocations.length / maxResetSteps);
            
            const resetInterval = setInterval(() => {
                if (resetStep >= maxResetSteps) {
                    clearInterval(resetInterval);
                    activatedDevices = 0;
                    return;
                }
                
                // Reset a batch of devices each step
                const startIndex = resetStep * devicesPerStep;
                const endIndex = Math.min(startIndex + devicesPerStep, deviceLocations.length);
                
                for (let i = startIndex; i < endIndex; i++) {
                    const device = deviceLocations[i];
                    // Gradually change to initial status distribution based on region state
                    const rand = Math.random();

                    // Ëé∑ÂèñËÆæÂ§áÊâÄÂú®Âú∞Âå∫ÁöÑÁä∂ÊÄÅ
                    const regionStatus = regionData[device.region] ? regionData[device.region].status : 'none';

                    // Ê†πÊçÆÂú∞Âå∫Áä∂ÊÄÅÂÜ≥ÂÆöËÆæÂ§áÁä∂ÊÄÅ
                    if (regionStatus === 'waitingExecution' || regionStatus === 'none') {
                        // Á≠âÂæÖÊâßË°å‰∏≠ÊàñÊó†Áä∂ÊÄÅÔºöËÆæÂ§á‰∏çÊòæÁ§∫ÔºàÊâÄÊúâÁä∂ÊÄÅ‰∏∫0Ôºâ
                        device.status = 'hidden';
                    } else {
                        // ÊúâÊìç‰ΩúÁä∂ÊÄÅÁöÑÂú∞Âå∫ÔºöÊ≠£Â∏∏ÂàÜÈÖçÁä∂ÊÄÅ
                        if (rand < 0.05) {
                            device.status = 'offline';  // 5% offline
                        } else if (rand < 0.12 && (regionStatus === 'autoDischarge' || regionStatus === 'manualDischarge')) {
                            device.status = 'discharging';  // 7% discharging (‰ªÖÂú®ÊîæÁîµÂú∞Âå∫)
                        } else if (rand < 0.18 && (regionStatus === 'autoCharge' || regionStatus === 'manualCharge')) {
                            device.status = 'charging';  // 6% charging (‰ªÖÂú®ÂÖÖÁîµÂú∞Âå∫)
                        } else {
                            device.status = 'inactive';  // ÂÖ∂‰Ωô‰∏∫inactive
                        }
                    }
                }
                
                // Update map display
                updateMapWithDeviceStates();
                
                resetStep++;
            }, 100); // Update every 100ms for smooth animation
        }

        function resetDevicesToInitialState() {
            // Reset all devices to their original initial status based on region state
            deviceLocations.forEach(device => {
                const rand = Math.random();

                // Ëé∑ÂèñËÆæÂ§áÊâÄÂú®Âú∞Âå∫ÁöÑÁä∂ÊÄÅ
                const regionStatus = regionData[device.region] ? regionData[device.region].status : 'none';

                // Ê†πÊçÆÂú∞Âå∫Áä∂ÊÄÅÂÜ≥ÂÆöËÆæÂ§áÁä∂ÊÄÅ
                if (regionStatus === 'waitingExecution' || regionStatus === 'none') {
                    // Á≠âÂæÖÊâßË°å‰∏≠ÊàñÊó†Áä∂ÊÄÅÔºöËÆæÂ§á‰∏çÊòæÁ§∫ÔºàÊâÄÊúâÁä∂ÊÄÅ‰∏∫0Ôºâ
                    device.status = 'hidden';
                } else {
                    // ÊúâÊìç‰ΩúÁä∂ÊÄÅÁöÑÂú∞Âå∫ÔºöÊ≠£Â∏∏ÂàÜÈÖçÁä∂ÊÄÅ
                    if (rand < 0.05) {
                        device.status = 'offline';  // 5% offline
                    } else if (rand < 0.12 && (regionStatus === 'autoDischarge' || regionStatus === 'manualDischarge')) {
                        device.status = 'discharging';  // 7% discharging (‰ªÖÂú®ÊîæÁîµÂú∞Âå∫)
                    } else if (rand < 0.18 && (regionStatus === 'autoCharge' || regionStatus === 'manualCharge')) {
                        device.status = 'charging';  // 6% charging (‰ªÖÂú®ÂÖÖÁîµÂú∞Âå∫)
                    } else {
                        device.status = 'inactive';  // ÂÖ∂‰Ωô‰∏∫inactive
                    }
                }
            });

            // Update the map with initial device states
            // Filter out hidden devices
            if (mapChart && deviceLocations.length) {
                const data = deviceLocations
                    .filter(device => device.status !== 'hidden')
                    .map(device => ({
                        value: device.value,
                        id: device.id,
                        status: device.status,
                        region: device.region,
                        city: device.city
                    }));
                
                mapChart.setOption({
                    series: [
                        {}, // Keep state centers unchanged
                        {
                            name: 'Devices',
                            type: 'scatter',
                            data: data,
                            symbolSize: function(value, params) {
                                const status = params.data.status;
                                if (status === 'charging' || status === 'discharging') {
                                    return 8;
                                } else if (status === 'offline') {
                                    return 3;
                                }
                                return 5;
                            },
                            itemStyle: {
                                color: function(params) {
                                    const status = params.data.status;
                                    switch (status) {
                                        case 'charging': 
                                            return '#00ff88';
                                        case 'discharging': 
                                            return '#FFD700';
                                        case 'offline': 
                                            return 'rgba(255, 255, 255, 0.2)';
                                        default: 
                                            return 'rgba(255, 255, 255, 0.5)';
                                    }
                                },
                                borderColor: 'rgba(255, 255, 255, 0.3)',
                                borderWidth: 1,
                                shadowBlur: function(params) {
                                    const status = params.data.status;
                                    return (status === 'charging' || status === 'discharging') ? 10 : 3;
                                },
                                shadowColor: function(params) {
                                    const status = params.data.status;
                                    switch (status) {
                                        case 'charging':
                                            return 'rgba(0, 255, 136, 0.8)';
                                        case 'discharging':
                                            return 'rgba(255, 215, 0, 0.8)';
                                        default:
                                            return 'rgba(255, 255, 255, 0.3)';
                                    }
                                }
                            },
                            animation: true,
                            animationDuration: 800,
                            animationEasing: 'cubicOut'
                        }
                    ]
                });
            }
        }

        function resetButtons() {
            const chargeBtn = document.getElementById('chargeBtn');
            const dischargeBtn = document.getElementById('dischargeBtn');
            const actionButtons = document.querySelector('.action-buttons');
            
            if (actionButtons) {
                actionButtons.classList.remove('operating');
            }
            
            // Reset charge button
            if (chargeBtn) {
                chargeBtn.innerHTML = `<span data-i18n="charge">${window.i18n ? window.i18n.getText('charge') : 'ÂÖÖÁîµ'}</span>`;
                chargeBtn.classList.remove('stop-btn');
                chargeBtn.classList.add('charge-btn');
                chargeBtn.style.display = 'flex';
                chargeBtn.style.removeProperty('background');
                chargeBtn.style.color = '#000'; // Á°Æ‰øùÊñáÂ≠óÈ¢úËâ≤‰∏∫ÈªëËâ≤
                chargeBtn.onclick = handleCharge;
                chargeBtn.style.pointerEvents = 'auto';
                
                // Ê†πÊçÆÂΩìÂâçÊ®°ÂºèËÆæÁΩÆÊåâÈíÆÁä∂ÊÄÅ
                if (currentOperationMode === 'auto') {
                    chargeBtn.style.display = 'none';
                } else {
                    chargeBtn.disabled = false;
                    chargeBtn.style.opacity = '1';
                    chargeBtn.style.cursor = 'pointer';
                }
                
            }
            
            // Reset discharge button
            if (dischargeBtn) {
                dischargeBtn.innerHTML = `<span data-i18n="discharge">${window.i18n ? window.i18n.getText('discharge') : 'ÊîæÁîµ'}</span>`;
                dischargeBtn.classList.remove('stop-btn');
                dischargeBtn.classList.add('discharge-btn');
                dischargeBtn.style.display = 'flex';
                dischargeBtn.style.removeProperty('background');
                dischargeBtn.style.color = '#000'; // Á°Æ‰øùÊñáÂ≠óÈ¢úËâ≤‰∏∫ÈªëËâ≤
                dischargeBtn.onclick = handleDischarge;
                dischargeBtn.style.pointerEvents = 'auto';
                
                // Ê†πÊçÆÂΩìÂâçÊ®°ÂºèËÆæÁΩÆÊåâÈíÆÁä∂ÊÄÅ
                if (currentOperationMode === 'auto') {
                    dischargeBtn.style.display = 'none';
                } else {
                    dischargeBtn.disabled = false;
                    dischargeBtn.style.opacity = '1';
                    dischargeBtn.style.cursor = 'pointer';
                }
                
            }
            
            // Êõ¥Êñ∞Â§ßÂúÜÊòæÁ§∫Áä∂ÊÄÅ
            updateCircleStatusDisplay();
        }

        // Update map statistics display (shows actual device status, not command status)
        function updateMapStatistics(activeCount = 0) {
            if (!deviceLocations || !mapChart) return;


            // Ëé∑ÂèñÂΩìÂâçÂú∞Âå∫ÁöÑÊï∞ÊçÆ
            const currentRegion = regionData[selectedMainRegion] || regionData['NSW'];
            const regionStatus = currentRegion.status;
            const successCount = currentRegion.deviceStats.success;


            // ÂàùÂßãÂåñËÆ°Êï∞
            let counts = {
                charging: 0,
                discharging: 0,
                processing: 0,
                inactive: 0,
                offline: 0
            };

            // Ê†πÊçÆÂú∞Âå∫Áä∂ÊÄÅÂíå‰∏ãÂèëÊàêÂäüÊï∞ÈáèËÆ°ÁÆóÊòæÁ§∫Êï∞Â≠ó
            if (regionStatus === 'waitingExecution' || regionStatus === 'none') {
                // NSWÁ≠âÂæÖÊâßË°å‰∏≠ÔºöÂÖ®ÈÉ®‰∏∫0
                counts = {
                    charging: 0,
                    discharging: 0,
                    processing: 0,
                    inactive: 0,
                    offline: 0
                };
            } else if (regionStatus === 'autoCharge' || regionStatus === 'manualCharge') {
                // ÂÖÖÁîµÂú∞Âå∫ÔºöÂÖÖÁîµ‰∏≠ + ÂæÖÊú∫ + Á¶ªÁ∫ø = ‰∏ãÂèëÊàêÂäüÊï∞ÈáèÔºåÊîæÁîµ‰∏≠ = 0
                const total = successCount;
                counts.charging = Math.floor(total * 0.2);      // 20% ÂÖÖÁîµ‰∏≠
                counts.inactive = Math.floor(total * 0.7);      // 70% ÂæÖÊú∫
                counts.offline = total - counts.charging - counts.inactive; // Ââ©‰Ωô‰∏∫Á¶ªÁ∫ø
                counts.discharging = 0; // ÂÖÖÁîµÂú∞Âå∫Êó†ÊîæÁîµËÆæÂ§á
            } else if (regionStatus === 'autoDischarge' || regionStatus === 'manualDischarge') {
                // ÊîæÁîµÂú∞Âå∫ÔºöÊîæÁîµ‰∏≠ + ÂæÖÊú∫ + Á¶ªÁ∫ø = ‰∏ãÂèëÊàêÂäüÊï∞ÈáèÔºåÂÖÖÁîµ‰∏≠ = 0
                const total = successCount;
                counts.discharging = Math.floor(total * 0.2);   // 20% ÊîæÁîµ‰∏≠
                counts.inactive = Math.floor(total * 0.7);      // 70% ÂæÖÊú∫
                counts.offline = total - counts.discharging - counts.inactive; // Ââ©‰Ωô‰∏∫Á¶ªÁ∫ø
                counts.charging = 0; // ÊîæÁîµÂú∞Âå∫Êó†ÂÖÖÁîµËÆæÂ§á
            }


            // Update statistics display without background box
            const statisticsGraphic = [
                {
                    type: 'group',
                    right: 20,
                    top: 20,
                    children: [
                        // Charging indicator
                        {
                            type: 'circle',
                            shape: { r: 5 },
                            style: { fill: '#00ff88' },
                            position: [-15, 6],
                            z: 101
                        },
                        {
                            type: 'text',
                            style: {
                                text: `${window.i18n ? window.i18n.getText('charging') : 'ÂÖÖÁîµ‰∏≠'}: ${counts.charging}`,
                                fill: '#00ff88',
                                fontSize: 12
                            },
                            position: [0, 0],
                            z: 101
                        },
                        // Discharging indicator
                        {
                            type: 'circle',
                            shape: { r: 5 },
                            style: { fill: '#FFD700' },
                            position: [-15, 26],
                            z: 101
                        },
                        {
                            type: 'text',
                            style: {
                                text: `${window.i18n ? window.i18n.getText('discharging') : 'ÊîæÁîµ‰∏≠'}: ${counts.discharging}`,
                                fill: '#FFD700',
                                fontSize: 12
                            },
                            position: [0, 20],
                            z: 101
                        },
                        // Standby indicator
                        {
                            type: 'circle',
                            shape: { r: 5 },
                            style: { fill: 'rgba(255, 255, 255, 0.8)' },
                            position: [-15, 46],
                            z: 101
                        },
                        {
                            type: 'text',
                            style: {
                                text: `${window.i18n ? window.i18n.getText('standby') : 'ÂæÖÊú∫'}: ${counts.inactive}`,
                                fill: 'rgba(255, 255, 255, 0.8)',
                                fontSize: 12
                            },
                            position: [0, 40],
                            z: 101
                        },
                        // Offline indicator
                        {
                            type: 'circle',
                            shape: { r: 5 },
                            style: { fill: '#ff6b6b' },
                            position: [-15, 66],
                            z: 101
                        },
                        {
                            type: 'text',
                            style: {
                                text: `${window.i18n ? window.i18n.getText('offline') : 'Á¶ªÁ∫ø'}: ${counts.offline}`,
                                fill: '#ff6b6b',
                                fontSize: 12
                            },
                            position: [0, 60],
                            z: 101
                        }
                    ]
                }
            ];

            // Update the chart with new statistics
            mapChart.setOption({
                graphic: statisticsGraphic
            });
        }

        function fullReset() {
            resetButtons();
            currentOperation = null;
        }

        // Êñ∞ÁöÑÊìç‰ΩúÁªüËÆ°ÊòæÁ§∫ÂáΩÊï∞
        function showOperationStatistics() {
            
            // Ê£ÄÊü•Áî®Êà∑ÊòØÂê¶Â∑≤ÁªèÂÖ≥Èó≠‰∫ÜÂºπÁ™ó
            if (window.deviceResponseModalClosed) {
                return;
            }
            
            const modal = document.getElementById('deviceResponseModal');
            if (!modal) {
                console.error('Device response modal not found!');
                return;
            }
            
            // ËÆæÁΩÆÊìç‰ΩúÁ±ªÂûãÂíåÊ∂àÊÅØ
            let operationName = '';
            let messageText = '';
            let isStopOperation = false;
            
            const lastOperation = currentOperation || 'stop'; // Â¶ÇÊûúcurrentOperation‰∏∫nullÔºåËØ¥ÊòéÊòØÂÅúÊ≠¢Êìç‰Ωú
            
            if (lastOperation === 'charge') {
                operationName = window.i18n ? window.i18n.getText('charge') : 'Charge';
                messageText = window.i18n ? window.i18n.getText('chargeCompleteMessage') : 'Charging command completed. Here is the device response statistics report:';
            } else if (lastOperation === 'discharge') {
                operationName = window.i18n ? window.i18n.getText('discharge') : 'Discharge';
                messageText = window.i18n ? window.i18n.getText('dischargeCompleteMessage') : 'Discharging command completed. Here is the device response statistics report:';
            } else {
                // ËøôÊòØÂÅúÊ≠¢Êìç‰Ωú
                isStopOperation = true;
                const stoppedType = window.lastStoppedOperation;
                if (stoppedType === 'charge') {
                    operationName = window.i18n ? window.i18n.getText('stopCharge') || 'ÂÅúÊ≠¢ÂÖÖÁîµ' : 'Stop Charging';
                } else if (stoppedType === 'discharge') {
                    operationName = window.i18n ? window.i18n.getText('stopDischarge') || 'ÂÅúÊ≠¢ÊîæÁîµ' : 'Stop Discharging';
                } else {
                    operationName = window.i18n ? window.i18n.getText('stop') : 'Stop';
                }
                messageText = window.i18n ? window.i18n.getText('stopCompleteMessage') : 'Stop command completed. Here is the device response statistics report:';
            }
            
            // Êõ¥Êñ∞Ê®°ÊÄÅÊ°ÜÂÜÖÂÆπ
            const operationTypeDisplay = document.getElementById('operationTypeDisplay');
            const operationCompleteMessage = document.getElementById('operationCompleteMessage');
            const targetDevicesDisplay = document.getElementById('targetDevicesDisplay');
            const responseModalIcon = document.getElementById('responseModalIcon');
            const modalIcon = document.getElementById('modalIcon');
            
            if (operationTypeDisplay) {
                operationTypeDisplay.textContent = operationName;
                // Ê†πÊçÆÊìç‰ΩúÁ±ªÂûãËÆæÁΩÆÈ¢úËâ≤
                if (isStopOperation) {
                    // ÂÅúÊ≠¢Êìç‰Ωú‰ΩøÁî®Á∫¢Ëâ≤
                    operationTypeDisplay.style.color = '#ff6b6b';
                    if (responseModalIcon) {
                        responseModalIcon.style.background = 'linear-gradient(145deg, rgba(255, 107, 107, 0.15), rgba(255, 107, 107, 0.05))';
                        responseModalIcon.style.boxShadow = '0 4px 12px rgba(255, 107, 107, 0.15)';
                    }
                    if (modalIcon) modalIcon.textContent = 'üõë';
                } else if (lastOperation === 'discharge') {
                    operationTypeDisplay.style.color = '#ffd700';
                    if (responseModalIcon) {
                        responseModalIcon.style.background = 'linear-gradient(145deg, rgba(255, 215, 0, 0.15), rgba(255, 215, 0, 0.05))';
                        responseModalIcon.style.boxShadow = '0 4px 12px rgba(255, 215, 0, 0.15)';
                    }
                    if (modalIcon) modalIcon.textContent = 'üîã';
                } else {
                    operationTypeDisplay.style.color = '#00ff88';
                    if (responseModalIcon) {
                        responseModalIcon.style.background = 'linear-gradient(145deg, rgba(0, 255, 136, 0.15), rgba(0, 255, 136, 0.05))';
                        responseModalIcon.style.boxShadow = '0 4px 12px rgba(0, 255, 136, 0.15)';
                    }
                    if (modalIcon) modalIcon.textContent = '‚ö°';
                }
            }
            if (operationCompleteMessage) operationCompleteMessage.textContent = messageText;
            if (targetDevicesDisplay) {
                const unit = window.i18n && window.i18n.getCurrentLanguage() === 'en' ? '' : '‰∏™';
                targetDevicesDisplay.textContent = '500' + unit;
            }
            
            // Ëé∑ÂèñÂΩìÂâçÂú∞Âå∫ÁöÑËÆæÂ§áÁªüËÆ°Êï∞ÊçÆ
            const currentRegionData = regionData[selectedMainRegion] || regionData['NSW'];
            const deviceStats = currentRegionData.deviceStats;

            // Êõ¥Êñ∞ÂºπÁ™ó‰∏≠ÁöÑÁªüËÆ°Êï∞Â≠ó
            const modalSuccessCount = document.getElementById('modalSuccessCount');
            const modalExecutingCount = document.getElementById('modalExecutingCount');
            const modalFailedCount = document.getElementById('modalFailedCount');

            if (modalSuccessCount) modalSuccessCount.textContent = deviceStats.success || 450;
            if (modalExecutingCount) modalExecutingCount.textContent = deviceStats.executing || 0;
            if (modalFailedCount) modalFailedCount.textContent = deviceStats.failed || 50;
            
            // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü - ‰ΩøÁî®flexÂ±Ö‰∏≠
            modal.style.display = 'flex';
            
        }

        // Áõ¥Êé•Â§çÂà∂Êìç‰ΩúËÆ∞ÂΩïÈ°µÈù¢ÁöÑÊäΩÂ±âÁªÑ‰ª∂
        class HomeOperationDrawer extends DrawerComponent {
            constructor() {
                super({
                    containerId: 'homeOperationDrawer',
                    title: window.i18n ? window.i18n.getText('operationDetails') : 'Êìç‰ΩúËÆ∞ÂΩïËØ¶ÊÉÖ',
                    width: '500px',
                    tabs: [
                        { key: 'basic', label: window.i18n ? window.i18n.getText('basicInfo') : 'Âü∫Êú¨‰ø°ÊÅØ' },
                        { key: 'stations', label: window.i18n ? window.i18n.getText('stationDetails') : 'ÁîµÁ´ôËØ¶ÊÉÖ' },
                        { key: 'timeline', label: window.i18n ? window.i18n.getText('executionTimeline') : 'ÊâßË°åÊó∂Èó¥Á∫ø' }
                    ],
                    onClose: () => {
                    },
                    onTabSwitch: (tabKey, data) => {
                        this.setContent(data, tabKey);
                    }
                });
                
                // Âú®ÂàõÂª∫ÂêéÁ´ãÂç≥ËÆæÁΩÆz-index
                this.forceTopZIndex();
            }
            
            forceTopZIndex() {
                // ‰ΩøÁî®ÂÆöÊó∂Âô®Á°Æ‰øùDOMÂ∑≤ÁªèÂàõÂª∫
                const attempts = 0;
                const maxAttempts = 10;
                
                const setZIndex = () => {
                    const drawer = document.getElementById(this.containerId);
                    if (drawer) {
                        // ËÆæÁΩÆÊäΩÂ±âÁöÑz-index
                        drawer.style.setProperty('z-index', '2147483647', 'important');
                        drawer.style.setProperty('position', 'fixed', 'important');
                        
                        // ËÆæÁΩÆÂÜÖÈÉ®ÂÖÉÁ¥†ÁöÑz-index
                        const allElements = drawer.querySelectorAll('*');
                        allElements.forEach(el => {
                            el.style.setProperty('z-index', '2147483647', 'important');
                        });
                        
                        return true;
                    }
                    return false;
                };
                
                // Á´ãÂç≥Â∞ùËØï‰∏ÄÊ¨°
                if (!setZIndex() && attempts < maxAttempts) {
                    // Â¶ÇÊûúÂ§±Ë¥•Ôºå‰ΩøÁî®ÂÆöÊó∂Âô®ÈáçËØï
                    const interval = setInterval(() => {
                        if (setZIndex() || attempts >= maxAttempts) {
                            clearInterval(interval);
                        }
                        attempts++;
                    }, 100);
                }
            }
            
            // ÈáçÂÜôopenÊñπÊ≥ïÁ°Æ‰øùz-indexÊúÄÈ´ò
            open(data = null) {
                super.open(data);
                
                // Â§öÊ¨°Á°Æ‰øùz-indexËÆæÁΩÆ
                const ensureZIndex = () => {
                    const drawer = document.getElementById(this.containerId);
                    if (drawer) {
                        // ËÆæÁΩÆÂÆπÂô®z-index
                        drawer.style.setProperty('z-index', '2147483647', 'important');
                        drawer.style.setProperty('position', 'fixed', 'important');
                        
                        // ËÆæÁΩÆÊâÄÊúâÂ≠êÂÖÉÁ¥†
                        const overlay = drawer.querySelector('.drawer-overlay');
                        const container = drawer.querySelector('.drawer-container');
                        
                        if (overlay) {
                            overlay.style.setProperty('z-index', '2147483647', 'important');
                            overlay.style.setProperty('position', 'fixed', 'important');
                        }
                        
                        if (container) {
                            container.style.setProperty('z-index', '2147483647', 'important');
                            container.style.setProperty('position', 'fixed', 'important');
                        }
                    }
                };
                
                // Á´ãÂç≥ÊâßË°å
                ensureZIndex();
                
                // Âª∂ËøüÊâßË°åÂ§öÊ¨°‰ª•Á°Æ‰øù
                [10, 50, 100, 200, 500].forEach(delay => {
                    setTimeout(ensureZIndex, delay);
                });
                
                // ÂÜçÊ¨°Âº∫Âà∂ËÆæÁΩÆz-index
                this.forceTopZIndex();
            }
            
            generateContent(operation, tabKey) {
                if (!operation) return `<div>Loading data...</div>`;
                
                const commandInfo = this.getCommandInfo(operation.command);
                
                switch(tabKey) {
                    case 'basic':
                        return this.generateBasicInfo(operation, commandInfo);
                    case 'stations':
                        return this.generateStationDetails(operation);
                    case 'timeline':
                        return this.generateTimeline(operation);
                    default:
                        return this.generateBasicInfo(operation, commandInfo);
                }
            }
            
            getCommandInfo(command) {
                const commandTexts = {
                    'charge': window.i18n ? window.i18n.getText('charge') : 'ÂÖÖÁîµ',
                    'discharge': window.i18n ? window.i18n.getText('discharge') : 'ÊîæÁîµ',
                    'stop': window.i18n ? window.i18n.getText('stop') : 'ÂÅúÊ≠¢'
                };
                const commandMap = {
                    'charge': { text: commandTexts['charge'], class: 'charge' },
                    'discharge': { text: commandTexts['discharge'], class: 'discharge' },
                    'stop': { text: commandTexts['stop'], class: 'stop' }
                };
                return commandMap[command] || { text: command, class: 'default' };
            }

            generateBasicInfo(operation, commandInfo) {
                return `
                    <div class="detail-section">
                        <div class="detail-section-title">
                            <span>üìä</span>
                            ${window.i18n ? window.i18n.getText('operationOverview') : 'Êìç‰ΩúÊ¶ÇËßà'}
                        </div>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value">${operation.stations || operation.dispatched}</div>
                                <div class="stat-label">${window.i18n ? window.i18n.getText('totalStations') : 'ÊÄªÁîµÁ´ôÊï∞'}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${operation.success || operation.activated}</div>
                                <div class="stat-label">${window.i18n ? window.i18n.getText('successCount') : 'ÊàêÂäüÊï∞'}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${operation.failed || (operation.dispatched - operation.activated)}</div>
                                <div class="stat-label">${window.i18n ? window.i18n.getText('failedCount') : 'Â§±Ë¥•Êï∞'}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${operation.successRate || Math.round((operation.activated / operation.dispatched) * 100)}%</div>
                                <div class="stat-label">${window.i18n ? window.i18n.getText('successRate') : 'ÊàêÂäüÁéá'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <div class="detail-section-title">
                            <span>üìù</span>
                            ${window.i18n ? window.i18n.getText('basicInfo') : 'Âü∫Êú¨‰ø°ÊÅØ'}
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">${window.i18n ? window.i18n.getText('operationTime') : 'Êìç‰ΩúÊó∂Èó¥'}</span>
                            <span class="detail-value">${operation.time || new Date().toLocaleString(window.i18n ? (window.i18n.getCurrentLanguage() === 'zh' ? 'zh-CN' : 'en-US') : 'zh-CN')}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">${window.i18n ? window.i18n.getText('operationCommand') : 'Êìç‰ΩúÂëΩ‰ª§'}</span>
                            <span class="detail-value">
                                <span class="command-tag ${commandInfo.class}">${commandInfo.text}</span>
                            </span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">${window.i18n ? window.i18n.getText('operator') : 'Êìç‰Ωú‰∫∫Âëò'}</span>
                            <span class="detail-value">${window.i18n ? window.i18n.getText('systemAdmin') : 'Á≥ªÁªüÁÆ°ÁêÜÂëò'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">${window.i18n ? window.i18n.getText('operationId') : 'Êìç‰ΩúÁºñÂè∑'}</span>
                            <span class="detail-value">#${operation.id ? operation.id.toString().padStart(8, '0') : Date.now().toString().slice(-8)}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">${window.i18n ? window.i18n.getText('executionStatus') : 'ÊâßË°åÁä∂ÊÄÅ'}</span>
                            <span class="detail-value">
                                <span class="status-tag success">${window.i18n ? window.i18n.getText('allSuccess') : 'ÂÖ®ÈÉ®ÊàêÂäü'}</span>
                            </span>
                        </div>
                    </div>
                `;
            }

            generateStationDetails(operation) {
                // ÁîüÊàêÊ®°ÊãüÁöÑÁîµÁ´ôÊï∞ÊçÆ
                const stationCount = operation.stations || operation.dispatched || 500;
                const successCount = operation.success || operation.activated || 450;
                const stations = [];
                for (let i = 0; i < Math.min(stationCount, 10); i++) {
                    const isSuccess = i < successCount;
                    stations.push({
                        id: `ST${(1000 + i).toString()}`,
                        name: `${window.i18n ? window.i18n.getText('station') : 'ÁîµÁ´ô'}${String.fromCharCode(65 + (i % 26))}${Math.floor(i / 26) + 1}`,
                        status: isSuccess ? 'success' : 'failed',
                        location: `${window.i18n ? window.i18n.getText('area') : 'Âå∫Âüü'}${Math.floor(i / 10) + 1}`,
                        executeTime: new Date(new Date().getTime() + i * 1000).toLocaleTimeString('zh-CN')
                    });
                }
                
                return `
                    <div class="detail-section flex-fill">
                        <div class="detail-section-title">
                            <span>‚ö°</span>
                            ${window.i18n ? window.i18n.getText('stationExecutionDetails') : 'ÁîµÁ´ôÊâßË°åËØ¶ÊÉÖ'}
                        </div>
                        <div class="scrollable-list">
                            ${stations.map(station => `
                                <div class="detail-row">
                                    <div>
                                        <div class="detail-label">${station.name} (${station.id})</div>
                                        <div style="font-size: 12px; color: rgba(255, 255, 255, 0.5); margin-top: 2px;">
                                            ${station.location} ‚Ä¢ ${station.executeTime}
                                        </div>
                                    </div>
                                    <span class="status-tag ${station.status === 'success' ? 'success' : 'danger'}">
                                        ${station.status === 'success' ? (window.i18n ? window.i18n.getText('success') : 'ÊàêÂäü') : (window.i18n ? window.i18n.getText('failed') : 'Â§±Ë¥•')}
                                    </span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            generateTimeline(operation) {
                const startTime = new Date(operation.time || Date.now());
                const successCount = operation.success || operation.activated || 450;
                const failedCount = operation.failed || (operation.dispatched - operation.activated) || 50;
                const timeline = [
                    { time: new Date(startTime.getTime() - 60000), event: window.i18n ? window.i18n.getText('commandCreated') : 'Êìç‰ΩúÂëΩ‰ª§ÂàõÂª∫', status: 'success' },
                    { time: new Date(startTime.getTime() - 30000), event: window.i18n ? window.i18n.getText('validationPassed') : 'ÂëΩ‰ª§È™åËØÅÈÄöËøá', status: 'success' },
                    { time: startTime, event: window.i18n ? window.i18n.getText('executionStarted') : 'ÂºÄÂßãÊâßË°åÂëΩ‰ª§', status: 'success' },
                    { time: new Date(startTime.getTime() + 30000), event: `${successCount}${window.i18n ? window.i18n.getText('stationsSuccess') : '‰∏™ÁîµÁ´ôÊâßË°åÊàêÂäü'}`, status: 'success' },
                ];
                
                if (failedCount > 0) {
                    timeline.push({
                        time: new Date(startTime.getTime() + 45000),
                        event: `${failedCount}${window.i18n ? window.i18n.getText('stationsFailed') : '‰∏™ÁîµÁ´ôÊâßË°åÂ§±Ë¥•'}`,
                        status: 'danger'
                    });
                }
                
                timeline.push({
                    time: new Date(startTime.getTime() + 60000),
                    event: window.i18n ? window.i18n.getText('executionCompleted') : 'Êìç‰ΩúÊâßË°åÂÆåÊàê',
                    status: failedCount === 0 ? 'success' : 'warning'
                });
                
                return `
                    <div class="detail-section">
                        <div class="detail-section-title">
                            <span>üï∞Ô∏è</span>
                            ${window.i18n ? window.i18n.getText('executionTimeline') : 'ÊâßË°åÊó∂Èó¥Á∫ø'}
                        </div>
                        <div style="position: relative; padding-left: 24px;">
                            <div style="position: absolute; left: 8px; top: 0; bottom: 0; width: 2px; background: rgba(255, 255, 255, 0.1);"></div>
                            ${timeline.map((item, index) => `
                                <div style="position: relative; margin-bottom: 24px;">
                                    <div style="position: absolute; left: -20px; top: 2px; width: 12px; height: 12px; border-radius: 50%; background: ${item.status === 'success' ? '#34c759' : item.status === 'warning' ? '#ff9500' : '#ff3b30'};"></div>
                                    <div class="detail-row" style="border: none; padding: 0; margin-bottom: 4px;">
                                        <span class="detail-label">${item.event}</span>
                                        <span class="status-tag ${item.status}">
                                            ${item.status === 'success' ? (window.i18n ? window.i18n.getText('normal') : 'Ê≠£Â∏∏') : item.status === 'warning' ? (window.i18n ? window.i18n.getText('warning') : 'Ë≠¶Âëä') : (window.i18n ? window.i18n.getText('error') : 'ÈîôËØØ')}
                                        </span>
                                    </div>
                                    <div style="font-size: 12px; color: rgba(255, 255, 255, 0.5);">
                                        ${item.time.toLocaleString('zh-CN')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
        }

        // Device Response Drawer Class - ÂÆåÂÖ®Â§çÂà∂Ëá™ OperationDrawer
        class DeviceResponseDrawer extends DrawerComponent {
            constructor() {
                super({
                    containerId: 'deviceResponseDrawerComponent',
                    title: window.i18n ? window.i18n.getText('operationLog.detailTitle') : 'Êìç‰ΩúËÆ∞ÂΩïËØ¶ÊÉÖ',
                    width: '500px',
                    tabs: [
                        { key: 'basic', label: window.i18n ? window.i18n.getText('operationLog.tabs.basic') : 'Âü∫Êú¨‰ø°ÊÅØ' },
                        { key: 'stations', label: window.i18n ? window.i18n.getText('operationLog.tabs.stations') : 'ÁîµÁ´ôËØ¶ÊÉÖ' },
                        { key: 'timeline', label: window.i18n ? window.i18n.getText('operationLog.tabs.timeline') : 'ÊâßË°åÊó∂Èó¥Á∫ø' }
                    ],
                    onClose: () => {
                    },
                    onTabSwitch: (tabKey, data) => {
                        this.setContent(data, tabKey);
                    }
                });
                
                // Á°Æ‰øùÊäΩÂ±âÂú®ÊúÄÈ°∂Â±Ç
                this.forceTopZIndex();
            }
            
            forceTopZIndex() {
                setTimeout(() => {
                    // ÂÆπÂô®Êú¨Ë∫´Â∞±ÊòØ drawer-overlay
                    const drawer = document.querySelector(`#${this.containerId}`);
                    if (drawer) {
                        drawer.style.setProperty('z-index', '2147483647', 'important');
                        drawer.style.setProperty('position', 'fixed', 'important');

                        // ËÆæÁΩÆÂÜÖÈÉ®ÂÆπÂô®
                        const container = drawer.querySelector('.drawer-container');
                        if (container) {
                            container.style.setProperty('z-index', '2147483647', 'important');
                            container.style.setProperty('position', 'fixed', 'important');
                        }
                    }
                }, 10);
            }

            open(operation) {
                super.open(operation);
                this.forceTopZIndex();
            }

            generateContent(operation, tabKey) {
                if (!operation) {
                    return `<div>${window.i18n ? window.i18n.getText('dataLoading') : 'Loading data...'}</div>`;
                }

                const commandInfo = this.getCommandInfo(operation.command || 'charge');

                switch(tabKey) {
                    case 'basic':
                        return this.generateBasicInfo(operation, commandInfo);
                    case 'stations':
                        return this.generateStationDetails(operation);
                    case 'timeline':
                        return this.generateTimeline(operation);
                    default:
                        return this.generateBasicInfo(operation, commandInfo);
                }
            }
            
            getCommandInfo(command) {
                const commandMap = {
                    'charge': {
                        text: window.i18n ? window.i18n.getText('operationLog.commands.charge') : 'ÂÖÖÁîµ',
                        class: 'charge'
                    },
                    'discharge': {
                        text: window.i18n ? window.i18n.getText('operationLog.commands.discharge') : 'ÊîæÁîµ',
                        class: 'discharge'
                    },
                    'stop_charge': {
                        text: window.i18n ? window.i18n.getText('operationLog.commands.stopCharge') : 'ÂÅúÊ≠¢ÂÖÖÁîµ',
                        class: 'stop-charge'
                    },
                    'stop_discharge': {
                        text: window.i18n ? window.i18n.getText('operationLog.commands.stopDischarge') : 'ÂÅúÊ≠¢ÊîæÁîµ',
                        class: 'stop-discharge'
                    }
                };
                return commandMap[command] || { text: command, class: '' };
            }
            
            generateBasicInfo(operation, commandInfo) {
                return `
                    <div class="detail-section">
                        <div class="detail-section-title">
                            <span>üìä</span>
                            ${window.i18n ? window.i18n.getText('operationLog.overview.title') : 'Êìç‰ΩúÊ¶ÇËßà'}
                        </div>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value">${operation.stations || operation.totalStations || 235}</div>
                                <div class="stat-label">${window.i18n ? window.i18n.getText('operationLog.overview.totalStations') : 'ÊÄªÁîµÁ´ôÊï∞'}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${operation.success || operation.onlineStations || 230}</div>
                                <div class="stat-label">${window.i18n ? window.i18n.getText('operationLog.overview.successCount') : 'ÊàêÂäüÊï∞'}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${operation.failed || 5}</div>
                                <div class="stat-label">${window.i18n ? window.i18n.getText('operationLog.overview.failedCount') : 'Â§±Ë¥•Êï∞'}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${operation.successRate || Math.round((230 / 235) * 100)}%</div>
                                <div class="stat-label">${window.i18n ? window.i18n.getText('operationLog.overview.successRate') : 'ÊàêÂäüÁéá'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <div class="detail-section-title">
                            <span>üìù</span>
                            ${window.i18n ? window.i18n.getText('operationLog.basicInfo.title') : 'Âü∫Êú¨‰ø°ÊÅØ'}
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">${window.i18n ? window.i18n.getText('operationLog.basicInfo.operationTime') : 'Êìç‰ΩúÊó∂Èó¥'}</span>
                            <span class="detail-value">${operation.time || new Date().toLocaleString()}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">${window.i18n ? window.i18n.getText('operationLog.basicInfo.operationCommand') : 'Êìç‰ΩúÂëΩ‰ª§'}</span>
                            <span class="detail-value">
                                <span class="command-tag ${commandInfo.class}">${commandInfo.text}</span>
                            </span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">${window.i18n ? window.i18n.getText('operationLog.basicInfo.operator') : 'Êìç‰Ωú‰∫∫Âëò'}</span>
                            <span class="detail-value">${this.getOperatorName(operation.operator || 'System')}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">${window.i18n ? window.i18n.getText('operationLog.basicInfo.operationId') : 'Êìç‰ΩúÁºñÂè∑'}</span>
                            <span class="detail-value">#${(operation.id || Date.now()).toString().padStart(8, '0')}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">${window.i18n ? window.i18n.getText('operationLog.basicInfo.executionStatus') : 'ÊâßË°åÁä∂ÊÄÅ'}</span>
                            <span class="detail-value">
                                <span class="status-tag ${(operation.failed || 5) === 0 ? 'success' : (operation.success || 230) > (operation.failed || 5) ? 'warning' : 'danger'}">
                                    ${(operation.failed || 5) === 0 ? (window.i18n ? window.i18n.getText('operationLog.basicInfo.allSuccess') : 'ÂÖ®ÈÉ®ÊàêÂäü') : (operation.success || 230) > (operation.failed || 5) ? (window.i18n ? window.i18n.getText('operationLog.basicInfo.partialSuccess') : 'ÈÉ®ÂàÜÊàêÂäü') : (window.i18n ? window.i18n.getText('operationLog.basicInfo.mostlyFailed') : 'Â§öÊï∞Â§±Ë¥•')}
                                </span>
                            </span>
                        </div>
                    </div>
                `;
            }
            
            getOperatorName(operator) {
                if (operator === 'System') {
                    return window.i18n ? window.i18n.getText('system') : 'Á≥ªÁªü';
                }
                return operator;
            }
            
            generateStationDetails(operation) {
                // ÁîüÊàêÊ®°ÊãüÁöÑÁîµÁ´ôÊï∞ÊçÆ
                const stations = [];
                const totalStations = operation.stations || operation.totalStations || 235;
                const successCount = operation.success || operation.onlineStations || 230;
                
                for (let i = 0; i < totalStations; i++) {
                    const isSuccess = i < successCount;
                    stations.push({
                        id: `ST${(1000 + i).toString()}`,
                        name: `${window.i18n ? window.i18n.getText('operationLog.stationDetails.station') : 'ÁîµÁ´ô'}${String.fromCharCode(65 + (i % 26))}${Math.floor(i / 26) + 1}`,
                        status: isSuccess ? 'success' : 'failed',
                        location: `${window.i18n ? window.i18n.getText('operationLog.stationDetails.area') : 'Âå∫Âüü'}${Math.floor(i / 10) + 1}`,
                        executeTime: new Date(new Date().getTime() + i * 1000).toLocaleTimeString(window.i18n ? (window.i18n.getCurrentLanguage() === 'zh' ? 'zh-CN' : 'en-US') : 'zh-CN')
                    });
                }
                
                return `
                    <div class="detail-section flex-fill" style="margin-bottom: 0;">
                        <div class="detail-section-title">
                            <span>‚ö°</span>
                            ${window.i18n ? window.i18n.getText('operationLog.stationDetails.title') : 'ÁîµÁ´ôÊâßË°åËØ¶ÊÉÖ'}
                        </div>
                        <div class="scrollable-list" style="flex: 1; min-height: 600px; padding-bottom: 16px;">
                            ${stations.map(station => `
                                <div class="detail-row">
                                    <div>
                                        <div class="detail-label">${station.name} (${station.id})</div>
                                        <div style="font-size: 12px; color: rgba(255, 255, 255, 0.5); margin-top: 2px;">
                                            ${station.location} ‚Ä¢ ${station.executeTime}
                                        </div>
                                    </div>
                                    <span class="status-tag ${station.status === 'success' ? 'success' : 'danger'}">
                                        ${station.status === 'success' ? (window.i18n ? window.i18n.getText('operationLog.stationDetails.success') : 'ÊàêÂäü') : (window.i18n ? window.i18n.getText('operationLog.stationDetails.failed') : 'Â§±Ë¥•')}
                                    </span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            generateTimeline(operation) {
                const startTime = new Date(operation.time || new Date());
                const successCount = operation.success || operation.onlineStations || 230;
                const failedCount = operation.failed || 5;
                
                const timeline = [
                    { time: new Date(startTime.getTime() - 60000), event: window.i18n ? window.i18n.getText('operationLog.timeline.commandCreated') : 'Êìç‰ΩúÂëΩ‰ª§ÂàõÂª∫', status: 'success' },
                    { time: new Date(startTime.getTime() - 30000), event: window.i18n ? window.i18n.getText('operationLog.timeline.validationPassed') : 'ÂëΩ‰ª§È™åËØÅÈÄöËøá', status: 'success' },
                    { time: startTime, event: window.i18n ? window.i18n.getText('operationLog.timeline.executionStarted') : 'ÂºÄÂßãÊâßË°åÂëΩ‰ª§', status: 'success' },
                    { time: new Date(startTime.getTime() + 30000), event: `${successCount}${window.i18n ? window.i18n.getText('operationLog.timeline.stationsSuccess') : '‰∏™ÁîµÁ´ôÊâßË°åÊàêÂäü'}`, status: 'success' },
                ];
                
                if (failedCount > 0) {
                    timeline.push({
                        time: new Date(startTime.getTime() + 45000),
                        event: `${failedCount}${window.i18n ? window.i18n.getText('operationLog.timeline.stationsFailed') : '‰∏™ÁîµÁ´ôÊâßË°åÂ§±Ë¥•'}`,
                        status: 'danger'
                    });
                }
                
                timeline.push({
                    time: new Date(startTime.getTime() + 60000),
                    event: window.i18n ? window.i18n.getText('operationLog.timeline.executionCompleted') : 'Êìç‰ΩúÊâßË°åÂÆåÊàê',
                    status: failedCount === 0 ? 'success' : 'warning'
                });
                
                return `
                    <div class="detail-section">
                        <div class="detail-section-title">
                            <span>üï∞Ô∏è</span>
                            ${window.i18n ? window.i18n.getText('operationLog.timeline.title') : 'ÊâßË°åÊó∂Èó¥Á∫ø'}
                        </div>
                        <div style="position: relative; padding-left: 24px;">
                            <div style="position: absolute; left: 8px; top: 0; bottom: 0; width: 2px; background: rgba(255, 255, 255, 0.1);"></div>
                            ${timeline.map((item, index) => `
                                <div style="position: relative; margin-bottom: 16px;">
                                    <div style="position: absolute; left: -20px; top: 2px; width: 12px; height: 12px; border-radius: 50%; background: ${item.status === 'success' ? '#34c759' : item.status === 'warning' ? '#ff9500' : '#ff3b30'};"></div>
                                    <div class="detail-row" style="border: none; padding: 0; margin-bottom: 4px;">
                                        <span class="detail-label">${item.event}</span>
                                        <span class="status-tag ${item.status}">
                                            ${item.status === 'success' ? (window.i18n ? window.i18n.getText('operationLog.timeline.normal') : 'Ê≠£Â∏∏') : item.status === 'warning' ? (window.i18n ? window.i18n.getText('operationLog.timeline.warning') : 'Ë≠¶Âëä') : (window.i18n ? window.i18n.getText('operationLog.timeline.error') : 'ÈîôËØØ')}
                                        </span>
                                    </div>
                                    <div style="font-size: 12px; color: rgba(255, 255, 255, 0.5);">
                                        ${item.time.toLocaleString(window.i18n ? (window.i18n.getCurrentLanguage() === 'zh' ? 'zh-CN' : 'en-US') : 'zh-CN')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
        }

        // ÂàùÂßãÂåñÊäΩÂ±âÁªÑ‰ª∂ÔºàÂÖ®Â±ÄÂèòÈáèÔºâ
        window.homeOperationDrawer = null;

        // ÊâìÂºÄÊìç‰ΩúËØ¶ÊÉÖÊäΩÂ±â
        function openOperationDrawer() {
            
            if (!window.homeOperationDrawer) {
                window.homeOperationDrawer = new HomeOperationDrawer();
            }

            // ÊûÑÈÄ†Êìç‰ΩúËÆ∞ÂΩïÊ†ºÂºèÁöÑÊï∞ÊçÆ
            const dispatched = parseInt(document.getElementById('devicesDispatched')?.textContent || '500');
            const successRate = parseInt(document.getElementById('successRate')?.textContent || '89');
            const activated = Math.floor(dispatched * (successRate / 100));
            const operation = {
                id: Date.now() % 100000000,
                time: new Date().toLocaleString('zh-CN'),
                command: currentOperation || 'charge',
                operator: 'admin',
                stations: dispatched,
                success: activated,
                failed: dispatched - activated,
                dispatched: dispatched,
                activated: activated,
                successRate: Math.round((activated / dispatched) * 100)
            };

            
            // Áõ¥Êé•ÊâìÂºÄÊäΩÂ±âÂπ∂ËÆæÁΩÆÂÜÖÂÆπ
            window.homeOperationDrawer.open();
            
            // Âº∫Âà∂Á°Æ‰øùÊäΩÂ±âÂú®ÊúÄÈ°∂Â±Ç
            setTimeout(() => {
                const drawerElement = document.getElementById('homeOperationDrawer');
                if (drawerElement) {
                    // ËÆæÁΩÆÊúÄÈ´òz-index
                    drawerElement.style.setProperty('z-index', '2147483647', 'important');
                    drawerElement.style.setProperty('position', 'fixed', 'important');
                    
                    // Êü•ÊâæÂπ∂ËÆæÁΩÆoverlayÁöÑz-index
                    const overlay = document.querySelector('.drawer-overlay');
                    if (overlay) {
                        overlay.style.setProperty('z-index', '2147483646', 'important');
                        overlay.style.setProperty('position', 'fixed', 'important');
                    }
                    
                    // Êü•ÊâæÊäΩÂ±âÂÆπÂô®
                    const container = drawerElement.querySelector('.drawer-container') || 
                                    document.querySelector('.drawer-container');
                    if (container) {
                        container.style.setProperty('z-index', '2147483647', 'important');
                        container.style.setProperty('position', 'fixed', 'important');
                    }
                    
                }
            }, 100);
            
            // ËÆæÁΩÆÂÜÖÂÆπÊï∞ÊçÆ
            homeOperationDrawer.setContent(operation, 'basic');
        }

        // ÂÖ®Â±Äz-indexÁõëÊéßÂô®
        function startDrawerZIndexMonitor() {
            setInterval(() => {
                const drawer = document.getElementById('homeOperationDrawer');
                if (drawer && drawer.style.display !== 'none') {
                    // Á°Æ‰øùÊäΩÂ±âÂßãÁªàÂú®ÊúÄÈ°∂Â±Ç
                    drawer.style.setProperty('z-index', '2147483647', 'important');
                    drawer.style.setProperty('position', 'fixed', 'important');
                    
                    const overlay = drawer.querySelector('.drawer-overlay');
                    if (overlay) {
                        overlay.style.setProperty('z-index', '2147483647', 'important');
                    }
                    
                    const container = drawer.querySelector('.drawer-container');
                    if (container) {
                        container.style.setProperty('z-index', '2147483647', 'important');
                    }
                }
            }, 100);
        }

        // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°ÜÂáΩÊï∞
        function closeModal() {
            const modal = document.getElementById('operationModal');
            const statusSummary = document.getElementById('statusSummary');
            const infoGrid = document.querySelector('.modal-info-grid');
            
            modal.style.display = 'none';
            
            // Reset modal display states
            statusSummary.style.display = 'none';
            infoGrid.style.display = 'grid';
            
            // Reset current operation after modal is closed
            currentOperation = null;
        }

        function viewDetails() {
            // Close the modal
            closeModal();
            
            // Update details panel with current operation data
            const detailsPanel = document.getElementById('operationDetailsPanel');
            const operationType = document.getElementById('operationType').textContent;
            const targetDevices = document.getElementById('targetDevices').textContent;
            const estimatedProfit = document.getElementById('estimatedProfit').textContent;
            
            // Update details panel content
            document.getElementById('detailsOperationType').textContent = operationType;
            document.getElementById('detailsTargetDevices').textContent = targetDevices;
            document.getElementById('detailsEstimatedProfit').textContent = estimatedProfit;
            document.getElementById('detailsOperationTime').textContent = new Date().toLocaleString();
            
            // Update execution status numbers
            document.getElementById('detailsDispatched').textContent = document.getElementById('devicesDispatched').textContent;
            
            // Show the details panel
            detailsPanel.style.display = 'block';
            setTimeout(() => {
                detailsPanel.classList.add('show');
            }, 10);
        }
        
        // Remove duplicate function - using the one at line 5875 instead

        function closeDetailsPanel() {
            const detailsPanel = document.getElementById('operationDetailsPanel');
            detailsPanel.classList.remove('show');
            setTimeout(() => {
                detailsPanel.style.display = 'none';
            }, 300);
        }

        // Device Status Drawer Functions
        let deviceStatusData = {
            failed: [],
            success: [],
            executing: []
        };

        // Update device status counts based on animation progress
        function updateDeviceStatusCounts(successCount, executingCount, failCount, detailedStats) {
            // Â§±Ë¥•ÂéüÂõ†ÂàóË°®
            const failureReasons = [
                'ÁΩëÁªúËøûÊé•Ë∂ÖÊó∂',
                'ËÆæÂ§áÁ¶ªÁ∫ø',
                'Êåá‰ª§Ê†ºÂºèÈîôËØØ',
                'ËÆæÂ§áÂøôÁ¢å',
                'ÁîµÈáè‰∏çË∂≥',
                'ÈÄö‰ø°ÂçèËÆÆÈîôËØØ',
                'ËÆæÂ§áÊú™ÂìçÂ∫î',
                'ÂèÇÊï∞Ê†°È™åÂ§±Ë¥•',
                'CRCÊ†°È™åÈîôËØØ',
                'ËÆæÂ§áÊïÖÈöú'
            ];

            // Update success devices - all with 'success' status (‰∏ãÂèëÊàêÂäü)
            deviceStatusData.success = [];
            let nmiIndex = 2000;

            // ÊâÄÊúâ‰∏ãÂèëÊàêÂäüÁöÑËÆæÂ§áÁªü‰∏ÄÁä∂ÊÄÅ‰∏∫'success'
            for (let i = 0; i < successCount; i++) {
                deviceStatusData.success.push({
                    nmi: `NMI${String(nmiIndex++).padStart(6, '0')}`,
                    failureCount: 0,
                    status: 'success'
                });
            }

            // Update executing devices
            deviceStatusData.executing = [];
            for (let i = 0; i < executingCount; i++) {
                deviceStatusData.executing.push({
                    nmi: `NMI${String(3000 + i).padStart(6, '0')}`,
                    failureCount: 0,
                    status: 'executing'
                });
            }

            // Update failed devices - Ê∑ªÂä†Â§±Ë¥•ÂéüÂõ†
            deviceStatusData.failed = [];
            for (let i = 0; i < failCount; i++) {
                const failureCount = Math.floor(Math.random() * 5) + 1;
                // ÈöèÊú∫ÈÄâÊã©Â§±Ë¥•ÂéüÂõ†
                const randomReason = failureReasons[Math.floor(Math.random() * failureReasons.length)];

                deviceStatusData.failed.push({
                    nmi: `NMI${String(1000 + i).padStart(6, '0')}`,
                    failureCount: failureCount,
                    failureReason: randomReason,
                    status: 'failed'
                });
            }

        }

        // Generate mock device data
        function generateDeviceData() {
            const totalDevices = 500;
            const failedCount = Math.floor(totalDevices * 0.05); // 5% failed
            const successCount = Math.floor(totalDevices * 0.95); // 95% success

            // Â§±Ë¥•ÂéüÂõ†ÂàóË°®
            const failureReasons = [
                'ÁΩëÁªúËøûÊé•Ë∂ÖÊó∂',
                'ËÆæÂ§áÁ¶ªÁ∫ø',
                'Êåá‰ª§Ê†ºÂºèÈîôËØØ',
                'ËÆæÂ§áÂøôÁ¢å',
                'ÁîµÈáè‰∏çË∂≥',
                'ÈÄö‰ø°ÂçèËÆÆÈîôËØØ',
                'ËÆæÂ§áÊú™ÂìçÂ∫î',
                'ÂèÇÊï∞Ê†°È™åÂ§±Ë¥•',
                'CRCÊ†°È™åÈîôËØØ',
                'ËÆæÂ§áÊïÖÈöú'
            ];

            // Generate failed devices - Ê∑ªÂä†Â§±Ë¥•ÂéüÂõ†
            deviceStatusData.failed = [];
            for (let i = 0; i < failedCount; i++) {
                const failureCount = Math.floor(Math.random() * 5) + 1;
                const randomReason = failureReasons[Math.floor(Math.random() * failureReasons.length)];

                deviceStatusData.failed.push({
                    nmi: `NMI${String(1000 + i).padStart(6, '0')}`,
                    failureCount: failureCount,
                    failureReason: randomReason,
                    status: 'failed'
                });
            }

            // Generate success devices
            deviceStatusData.success = [];
            for (let i = 0; i < successCount; i++) {
                deviceStatusData.success.push({
                    nmi: `NMI${String(2000 + i).padStart(6, '0')}`,
                    failureCount: 0,
                    status: 'success'
                });
            }

            // Generate executing devices (initially 0, will be populated during operation)
            deviceStatusData.executing = [];
        }

        // ÂΩìÂâçÊ¥ªÂä®ÁöÑtabÁ±ªÂûã
        let currentActiveTab = 'success';

        // Open device status drawer - Êö¥Èú≤Âà∞ÂÖ®Â±Ä‰ΩúÁî®Âüü
        window.openDeviceStatusDrawer = function(type) {

            const drawer = document.getElementById('deviceStatusDrawer');
            const drawerTableBody = document.getElementById('drawerTableBody');


            // ÂÆâÂÖ®Ê£ÄÊü•ÔºöÁ°Æ‰øùÊâÄÊúâÂøÖË¶ÅÁöÑÂÖÉÁ¥†ÈÉΩÂ≠òÂú®
            if (!drawer || !drawerTableBody) {
                console.error('‚ùå Drawer elements not found!', {
                    drawer: !!drawer,
                    drawerTableBody: !!drawerTableBody
                });
                return;
            }

            // If no data exists yet (first time opening), use current displayed counts
            if (deviceStatusData.failed.length === 0 && deviceStatusData.success.length === 0 && deviceStatusData.executing.length === 0) {
                const currentSuccess = parseInt(document.getElementById('successfulDevices')?.textContent || '0');
                const currentExecuting = parseInt(document.getElementById('executingDevices')?.textContent || '0');
                const currentFailed = parseInt(document.getElementById('failedDevices')?.textContent || '0');


                // Ëé∑ÂèñÂΩìÂâçÂú∞Âå∫ÁöÑËØ¶ÁªÜÁªüËÆ°Êï∞ÊçÆ
                const currentRegionStats = regionData[selectedMainRegion]?.deviceStats;
                updateDeviceStatusCounts(currentSuccess, currentExecuting, currentFailed, currentRegionStats);
            }

            // Êõ¥Êñ∞tabËÆ°Êï∞
            document.getElementById('tabCountSuccess').textContent = deviceStatusData.success.length;
            document.getElementById('tabCountExecuting').textContent = deviceStatusData.executing.length;
            document.getElementById('tabCountFailed').textContent = deviceStatusData.failed.length;

            // ËÆæÁΩÆÂΩìÂâçÊ¥ªÂä®tabÂπ∂ÊòæÁ§∫ÂØπÂ∫îÊï∞ÊçÆ
            currentActiveTab = type || 'success';
            switchDeviceTab(currentActiveTab);

            // Show drawer - Ê∑ªÂä† show Á±ªÊù•ÊòæÁ§∫ÊäΩÂ±â

            // Ëé∑ÂèñÈÅÆÁΩ©Â±ÇÂíåÂÜÖÂÆπ
            const overlay = drawer.querySelector('.drawer-overlay');
            const content = drawer.querySelector('.drawer-content');

            // Ê∑ªÂä† show Á±ªËß¶ÂèëCSSÂä®Áîª
            drawer.classList.add('show');

            // ÂêåÊó∂‰ΩøÁî®ÂÜÖËÅîÊ†∑ÂºèÂº∫Âà∂ÊòæÁ§∫ÔºàÁ°Æ‰øù‰∏ÄÂÆöËÉΩÊòæÁ§∫Ôºâ
            drawer.style.visibility = 'visible';
            drawer.style.pointerEvents = 'all';
            drawer.style.zIndex = '999999';

            // Âº∫Âà∂ÊòæÁ§∫ÈÅÆÁΩ©Â±Ç - ‰ΩøÁî®ÊâÄÊúâÂèØËÉΩÁöÑÊ†∑ÂºèÂ±ûÊÄß
            if (overlay) {
                overlay.style.cssText = `
                    position: fixed !important;
                    top: 0 !important;
                    left: 0 !important;
                    width: 100% !important;
                    height: 100% !important;
                    background: rgba(0, 0, 0, 0.6) !important;
                    opacity: 1 !important;
                    display: block !important;
                    visibility: visible !important;
                    pointer-events: all !important;
                    z-index: 999998 !important;
                    backdrop-filter: blur(4px);
                `;
            } else {
                console.error('‚ùå Overlay element not found!');
            }

            // Á°Æ‰øùÂÜÖÂÆπÂú®ÊúÄ‰∏äÂ±Ç
            if (content) {
                content.style.zIndex = '999999';
                content.style.position = 'fixed';
            }

            // Âº∫Âà∂ÊµèËßàÂô®ÈáçÊéí‰ª•Á°Æ‰øùÊ†∑ÂºèÁîüÊïà
            drawer.offsetHeight;

        };

        // Close device status drawer - Êö¥Èú≤Âà∞ÂÖ®Â±Ä‰ΩúÁî®Âüü
        window.closeDeviceStatusDrawer = function() {
            const drawer = document.getElementById('deviceStatusDrawer');
            const overlay = drawer.querySelector('.drawer-overlay');

            // ÁßªÈô§ show Á±ªËß¶ÂèëÂÖ≥Èó≠Âä®Áîª
            drawer.classList.remove('show');

            // Á´ãÂç≥Á¶ÅÁî®ÈÅÆÁΩ©Â±ÇÁöÑÁÇπÂáª‰∫ã‰ª∂ÔºåÈò≤Ê≠¢ÈòªÊå°È°µÈù¢ÁÇπÂáª
            if (overlay) {
                overlay.style.pointerEvents = 'none';
                overlay.style.opacity = '0';
            }

            // Á´ãÂç≥Á¶ÅÁî®drawerÁöÑÁÇπÂáª‰∫ã‰ª∂
            drawer.style.pointerEvents = 'none';

            // Âª∂ËøüÂêéÂÆåÂÖ®ÈöêËóèÂπ∂Ê∏ÖÁêÜÊâÄÊúâÊ†∑Âºè
            setTimeout(() => {
                drawer.style.visibility = 'hidden';

                // ÂÆåÂÖ®ÈöêËóèÈÅÆÁΩ©Â±Ç
                if (overlay) {
                    overlay.style.display = 'none';
                    overlay.style.visibility = 'hidden';
                }

            }, 300);
        };

        // Export drawer data - Êö¥Èú≤Âà∞ÂÖ®Â±Ä‰ΩúÁî®Âüü
        window.exportDrawerData = function() {

            // Get current active tab data
            let data = [];
            let tabName = '';

            if (currentActiveTab === 'failed') {
                data = deviceStatusData.failed;
                tabName = window.i18n ? window.i18n.getText('failed') : '‰∏ãÂèëÂ§±Ë¥•';
            } else if (currentActiveTab === 'success') {
                data = deviceStatusData.success;
                tabName = window.i18n ? window.i18n.getText('success') : '‰∏ãÂèëÊàêÂäü';
            } else if (currentActiveTab === 'executing') {
                data = deviceStatusData.executing;
                tabName = window.i18n ? window.i18n.getText('executing') : 'ÊâßË°å‰∏≠';
            }

            if (data.length === 0) {
                const message = window.i18n && window.i18n.getCurrentLanguage() === 'en' ?
                    'No data to export' : 'Ê≤°ÊúâÊï∞ÊçÆÂèØ‰ª•ÂØºÂá∫';
                alert(message);
                return;
            }

            // Get current language
            const currentLang = window.i18n ? window.i18n.getCurrentLanguage() : 'zh';

            // Create CSV headers based on tab type and language
            let headers = [];
            if (currentActiveTab === 'failed') {
                // ‰∏ãÂèëÂ§±Ë¥•ÔºöNMI„ÄÅÂ§±Ë¥•Ê¨°Êï∞„ÄÅÂ§±Ë¥•ÂéüÂõ†
                headers = currentLang === 'en' ?
                    ['NMI', 'Failure Count', 'Failure Reason'] :
                    ['NMI', 'Â§±Ë¥•Ê¨°Êï∞', 'Â§±Ë¥•ÂéüÂõ†'];
            } else {
                // ‰∏ãÂèëÊàêÂäüÂíåÊâßË°å‰∏≠ÔºöNMI„ÄÅÁä∂ÊÄÅ
                headers = currentLang === 'en' ?
                    ['NMI', 'Status'] :
                    ['NMI', 'Áä∂ÊÄÅ'];
            }

            // Status translation mapping
            const statusI18nKeys = {
                'success': 'success',
                'failed': 'failed',
                'charging': 'charging',
                'discharging': 'discharging',
                'standby': 'standby',
                'offline': 'offline',
                'executing': 'executing'
            };

            // Create CSV content
            let csvContent = '\uFEFF' + headers.join(',') + '\n'; // Add BOM for UTF-8

            // Add data rows based on tab type
            data.forEach(device => {
                let row = [];

                if (currentActiveTab === 'failed') {
                    // ‰∏ãÂèëÂ§±Ë¥•ÔºöÂØºÂá∫ NMI„ÄÅÂ§±Ë¥•Ê¨°Êï∞„ÄÅÂ§±Ë¥•ÂéüÂõ†
                    row = [
                        device.nmi || '-',
                        device.failureCount || 0,
                        device.failureReason || 'Êú™Áü•ÈîôËØØ'
                    ];
                } else {
                    // ‰∏ãÂèëÊàêÂäüÂíåÊâßË°å‰∏≠ÔºöÂØºÂá∫ NMI„ÄÅÁä∂ÊÄÅ
                    const i18nKey = statusI18nKeys[device.status] || device.status;
                    const statusText = window.i18n ? window.i18n.getText(i18nKey) : device.status;

                    row = [
                        device.nmi || '-',
                        statusText
                    ];
                }

                csvContent += row.join(',') + '\n';
            });

            // Create blob and download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            const now = new Date();
            const timestamp = now.getTime();
            const filename = `device_response_${currentActiveTab}_${timestamp}.csv`;

            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // Show success message
            const message = currentLang === 'en' ?
                `Export successful! (${data.length} records)` :
                `ÂØºÂá∫ÊàêÂäüÔºÅÂÖ± ${data.length} Êù°Êï∞ÊçÆ`;
            alert(message);
        };

        // Switch device tab - Êö¥Èú≤Âà∞ÂÖ®Â±Ä‰ΩúÁî®Âüü
        window.switchDeviceTab = function(type) {

            // Êõ¥Êñ∞ÂΩìÂâçÊ¥ªÂä®Ê†áÁ≠æ
            currentActiveTab = type;

            // Êõ¥Êñ∞tabÊøÄÊ¥ªÁä∂ÊÄÅ
            document.querySelectorAll('.drawer-tab').forEach(tab => {
                if (tab.getAttribute('data-tab') === type) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });

            // Ëé∑ÂèñÂØπÂ∫îÁ±ªÂûãÁöÑÊï∞ÊçÆ
            let data = [];
            if (type === 'failed') {
                data = deviceStatusData.failed;
            } else if (type === 'success') {
                data = deviceStatusData.success;
            } else if (type === 'executing') {
                data = deviceStatusData.executing;
            }

            // Êõ¥Êñ∞Ë°®Ê†ºË°®Â§¥ÂíåÊï∞ÊçÆ
            const drawerTableHead = document.getElementById('drawerTableHead');
            const drawerTableBody = document.getElementById('drawerTableBody');

            if (!drawerTableHead || !drawerTableBody) {
                console.error('‚ùå Table elements not found');
                return;
            }

            // Ê†πÊçÆtabÁ±ªÂûãÂä®ÊÄÅËÆæÁΩÆË°®Â§¥
            if (type === 'failed') {
                // ‰∏ãÂèëÂ§±Ë¥•ÔºöÊòæÁ§∫ NMI„ÄÅÊ¨°Êï∞„ÄÅÂ§±Ë¥•ÂéüÂõ†
                drawerTableHead.innerHTML = `
                    <tr>
                        <th data-i18n="nmi">NMI</th>
                        <th data-i18n="failureCount">Â§±Ë¥•Ê¨°Êï∞</th>
                        <th data-i18n="failureReason">Â§±Ë¥•ÂéüÂõ†</th>
                    </tr>
                `;
            } else {
                // ‰∏ãÂèëÊàêÂäüÂíåÊâßË°å‰∏≠ÔºöÊòæÁ§∫ NMI„ÄÅÁä∂ÊÄÅ
                drawerTableHead.innerHTML = `
                    <tr>
                        <th data-i18n="nmi">NMI</th>
                        <th data-i18n="status">Áä∂ÊÄÅ</th>
                    </tr>
                `;
            }

            // Áä∂ÊÄÅÊñáÂ≠óÁøªËØëÊò†Â∞Ñ
            const statusI18nKeys = {
                'success': 'success',
                'failed': 'failed',
                'charging': 'charging',
                'discharging': 'discharging',
                'standby': 'standby',
                'offline': 'offline',
                'executing': 'executing'
            };

            // Ê∏ÖÁ©∫Ë°®Ê†ºÂπ∂Â°´ÂÖÖÊï∞ÊçÆ
            drawerTableBody.innerHTML = '';
            data.forEach(device => {
                const row = document.createElement('tr');

                if (type === 'failed') {
                    // ‰∏ãÂèëÂ§±Ë¥•ÔºöÊòæÁ§∫ NMI„ÄÅÊ¨°Êï∞„ÄÅÂ§±Ë¥•ÂéüÂõ†
                    row.innerHTML = `
                        <td>${device.nmi || '-'}</td>
                        <td>${device.failureCount || 0}</td>
                        <td><span style="color: rgba(255, 107, 107, 0.9);">${device.failureReason || 'Êú™Áü•ÈîôËØØ'}</span></td>
                    `;
                } else {
                    // ‰∏ãÂèëÊàêÂäüÂíåÊâßË°å‰∏≠ÔºöÊòæÁ§∫ NMI„ÄÅÁä∂ÊÄÅ
                    // Ê†πÊçÆËÆæÂ§áÁä∂ÊÄÅÁîüÊàêÂØπÂ∫îÁöÑÂæΩÁ´†
                    let badgeClass = '';
                    const i18nKey = statusI18nKeys[device.status] || device.status;
                    let statusText = window.i18n ? window.i18n.getText(i18nKey) : device.status;

                    // Ê†πÊçÆ‰∏çÂêåÁä∂ÊÄÅËÆæÁΩÆÊ†∑ÂºèÁ±ª
                    switch(device.status) {
                        case 'success':
                            badgeClass = 'success';
                            break;
                        case 'charging':
                            badgeClass = 'success';
                            break;
                        case 'discharging':
                            badgeClass = 'warning';
                            break;
                        case 'standby':
                            badgeClass = 'info';
                            break;
                        case 'offline':
                            badgeClass = 'secondary';
                            break;
                        case 'executing':
                            badgeClass = 'executing';
                            break;
                        default:
                            badgeClass = 'default';
                    }

                    const statusBadge = `<span class="status-badge ${badgeClass}">${statusText}</span>`;

                    row.innerHTML = `
                        <td>${device.nmi || '-'}</td>
                        <td>${statusBadge}</td>
                    `;
                }

                drawerTableBody.appendChild(row);
            });

            // Â¶ÇÊûúÂêØÁî®‰∫Üi18nÔºåÈáçÊñ∞Â∫îÁî®ÁøªËØë
            if (window.i18n && window.i18n.updatePageTexts) {
                window.i18n.updatePageTexts();
            }

        };

        function populateOperationDrawerData() {
            // Update basic information
            const operationType = currentOperation === 'charge' ? 'ÂÖÖÁîµ' : (currentOperation === 'discharge' ? 'ÊîæÁîµ' : 'ÂÅúÊ≠¢Êìç‰Ωú');
            document.getElementById('detailsOperationType').textContent = operationType;
            document.getElementById('detailsTargetDevices').textContent = (window.i18n && window.i18n.getCurrentLanguage() === 'en') ? '500 Devices' : '500‰∏™ËÆæÂ§á';
            const profitElement = document.getElementById('detailsEstimatedProfit');
            if (profitElement) {
                profitElement.innerHTML = '<span data-i18n="estimatedProfitValue">+$340</span>';
            }
            document.getElementById('detailsOperationTime').textContent = new Date().toLocaleString();
        }

        // Operation Details Tabs Functions (copied from OperationDrawer)
        let currentOperationData = null;
        let activeOperationTab = 'basic';

        function switchOperationTab(tabKey) {
            // Update active tab
            document.querySelectorAll('.operation-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabKey}"]`).classList.add('active');
            
            activeOperationTab = tabKey;
            
            // Generate content for the selected tab
            if (currentOperationData) {
                generateOperationTabContent(currentOperationData, tabKey);
            }
        }

        function generateOperationTabContent(operation, tabKey) {
            const contentContainer = document.getElementById('operationTabContent');
            
            switch(tabKey) {
                case 'basic':
                    contentContainer.innerHTML = generateBasicInfo(operation);
                    break;
                case 'stations':
                    contentContainer.innerHTML = generateStationDetails(operation);
                    break;
                case 'timeline':
                    contentContainer.innerHTML = generateTimeline(operation);
                    break;
                default:
                    contentContainer.innerHTML = generateBasicInfo(operation);
            }
        }

        function generateBasicInfo(operation) {
            const commandInfo = getCommandInfo(operation.command);
            
            return `
                <div class="detail-section">
                    <div class="detail-section-title">
                        <span>üìä</span>
                        ${window.i18n ? window.i18n.getText('operationLog.overview.title') : 'Êìç‰ΩúÊ¶ÇËßà'}
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${operation.stations}</div>
                            <div class="stat-label">${window.i18n ? window.i18n.getText('operationLog.overview.totalStations') : 'ÊÄªÁîµÁ´ôÊï∞'}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${operation.success}</div>
                            <div class="stat-label">${window.i18n ? window.i18n.getText('operationLog.overview.successCount') : 'ÊàêÂäüÊï∞'}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${operation.failed}</div>
                            <div class="stat-label">${window.i18n ? window.i18n.getText('operationLog.overview.failedCount') : 'Â§±Ë¥•Êï∞'}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${Math.round((operation.success / operation.stations) * 100)}%</div>
                            <div class="stat-label">${window.i18n ? window.i18n.getText('operationLog.overview.successRate') : 'ÊàêÂäüÁéá'}</div>
                        </div>
                    </div>
                </div>
                
                <div class="detail-section">
                    <div class="detail-section-title">
                        <span>üìù</span>
                        ${window.i18n ? window.i18n.getText('operationLog.basicInfo.title') : 'Âü∫Êú¨‰ø°ÊÅØ'}
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">${window.i18n ? window.i18n.getText('operationLog.basicInfo.operationTime') : 'Êìç‰ΩúÊó∂Èó¥'}</span>
                        <span class="detail-value">${operation.time}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">${window.i18n ? window.i18n.getText('operationLog.basicInfo.operationCommand') : 'Êìç‰ΩúÂëΩ‰ª§'}</span>
                        <span class="detail-value">
                            <span class="command-tag ${commandInfo.class}">${commandInfo.text}</span>
                        </span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">${window.i18n ? window.i18n.getText('operationLog.basicInfo.operator') : 'Êìç‰Ωú‰∫∫Âëò'}</span>
                        <span class="detail-value">${getOperatorName(operation.operator)}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">${window.i18n ? window.i18n.getText('operationLog.basicInfo.operationId') : 'Êìç‰ΩúÁºñÂè∑'}</span>
                        <span class="detail-value">#${operation.id.toString().padStart(8, '0')}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">${window.i18n ? window.i18n.getText('operationLog.basicInfo.executionStatus') : 'ÊâßË°åÁä∂ÊÄÅ'}</span>
                        <span class="detail-value">
                            <span class="status-tag ${operation.failed === 0 ? 'success' : operation.success > operation.failed ? 'warning' : 'danger'}">
                                ${operation.failed === 0 ? (window.i18n ? window.i18n.getText('operationLog.basicInfo.allSuccess') : 'ÂÖ®ÈÉ®ÊàêÂäü') : operation.success > operation.failed ? (window.i18n ? window.i18n.getText('operationLog.basicInfo.partialSuccess') : 'ÈÉ®ÂàÜÊàêÂäü') : (window.i18n ? window.i18n.getText('operationLog.basicInfo.mostlyFailed') : 'Â§öÊï∞Â§±Ë¥•')}
                            </span>
                        </span>
                    </div>
                </div>
            `;
        }

        function generateStationDetails(operation) {
            // Generate simulated station data
            const stations = [];
            for (let i = 0; i < operation.stations; i++) {
                const isSuccess = i < operation.success;
                stations.push({
                    id: `ST${(1000 + i).toString()}`,
                    name: `${window.i18n ? window.i18n.getText('operationLog.stationDetails.station') : 'ÁîµÁ´ô'}${String.fromCharCode(65 + (i % 26))}${Math.floor(i / 26) + 1}`,
                    status: isSuccess ? 'success' : 'failed',
                    location: `${window.i18n ? window.i18n.getText('operationLog.stationDetails.area') : 'Âå∫Âüü'}${Math.floor(i / 10) + 1}`,
                    executeTime: new Date(new Date(operation.time).getTime() + i * 1000).toLocaleTimeString(window.i18n ? (window.i18n.getCurrentLanguage() === 'zh' ? 'zh-CN' : 'en-US') : 'zh-CN')
                });
            }
            
            return `
                <div class="detail-section">
                    <div class="detail-section-title">
                        <span>‚ö°</span>
                        ${window.i18n ? window.i18n.getText('operationLog.stationDetails.title') : 'ÁîµÁ´ôÊâßË°åËØ¶ÊÉÖ'}
                    </div>
                    <div class="scrollable-list">
                        ${stations.map(station => `
                            <div class="detail-row">
                                <div>
                                    <div class="detail-label">${station.name} (${station.id})</div>
                                    <div style="font-size: 12px; color: rgba(255, 255, 255, 0.5); margin-top: 2px;">
                                        ${station.location} ‚Ä¢ ${station.executeTime}
                                    </div>
                                </div>
                                <span class="status-tag ${station.status === 'success' ? 'success' : 'danger'}">
                                    ${station.status === 'success' ? (window.i18n ? window.i18n.getText('operationLog.stationDetails.success') : 'ÊàêÂäü') : (window.i18n ? window.i18n.getText('operationLog.stationDetails.failed') : 'Â§±Ë¥•')}
                                </span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function generateTimeline(operation) {
            const startTime = new Date(operation.time);
            const timeline = [
                { time: new Date(startTime.getTime() - 60000), event: window.i18n ? window.i18n.getText('operationLog.timeline.commandCreated') : 'Êìç‰ΩúÂëΩ‰ª§ÂàõÂª∫', status: 'success' },
                { time: new Date(startTime.getTime() - 30000), event: window.i18n ? window.i18n.getText('operationLog.timeline.validationPassed') : 'ÂëΩ‰ª§È™åËØÅÈÄöËøá', status: 'success' },
                { time: startTime, event: window.i18n ? window.i18n.getText('operationLog.timeline.executionStarted') : 'ÂºÄÂßãÊâßË°åÂëΩ‰ª§', status: 'success' },
                { time: new Date(startTime.getTime() + 30000), event: `${operation.success}${window.i18n ? window.i18n.getText('operationLog.timeline.stationsSuccess') : '‰∏™ÁîµÁ´ôÊâßË°åÊàêÂäü'}`, status: 'success' },
            ];
            
            if (operation.failed > 0) {
                timeline.push({
                    time: new Date(startTime.getTime() + 45000),
                    event: `${operation.failed}${window.i18n ? window.i18n.getText('operationLog.timeline.stationsFailed') : '‰∏™ÁîµÁ´ôÊâßË°åÂ§±Ë¥•'}`,
                    status: 'danger'
                });
            }
            
            timeline.push({
                time: new Date(startTime.getTime() + 60000),
                event: window.i18n ? window.i18n.getText('operationLog.timeline.executionCompleted') : 'Êìç‰ΩúÊâßË°åÂÆåÊàê',
                status: operation.failed === 0 ? 'success' : 'warning'
            });
            
            return `
                <div class="detail-section">
                    <div class="detail-section-title">
                        <span>üï∞Ô∏è</span>
                        ${window.i18n ? window.i18n.getText('operationLog.timeline.title') : 'ÊâßË°åÊó∂Èó¥Á∫ø'}
                    </div>
                    <div style="position: relative; padding-left: 24px;">
                        <div style="position: absolute; left: 8px; top: 0; bottom: 0; width: 2px; background: rgba(255, 255, 255, 0.1);"></div>
                        ${timeline.map((item, index) => `
                            <div style="position: relative; margin-bottom: 24px;">
                                <div style="position: absolute; left: -20px; top: 2px; width: 12px; height: 12px; border-radius: 50%; background: ${item.status === 'success' ? '#34c759' : item.status === 'warning' ? '#ff9500' : '#ff3b30'};"></div>
                                <div class="detail-row" style="border: none; padding: 0; margin-bottom: 4px;">
                                    <span class="detail-label">${item.event}</span>
                                    <span class="status-tag ${item.status}">
                                        ${item.status === 'success' ? (window.i18n ? window.i18n.getText('operationLog.timeline.normal') : 'Ê≠£Â∏∏') : item.status === 'warning' ? (window.i18n ? window.i18n.getText('operationLog.timeline.warning') : 'Ë≠¶Âëä') : (window.i18n ? window.i18n.getText('operationLog.timeline.error') : 'ÈîôËØØ')}
                                    </span>
                                </div>
                                <div style="font-size: 12px; color: rgba(255, 255, 255, 0.5);">
                                    ${item.time.toLocaleString(window.i18n ? (window.i18n.getCurrentLanguage() === 'zh' ? 'zh-CN' : 'en-US') : 'zh-CN')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Helper functions
        function getCommandInfo(command) {
            const commands = {
                'charge': { text: window.i18n ? window.i18n.getText('charge') : 'ÂÖÖÁîµ', class: 'charge' },
                'discharge': { text: window.i18n ? window.i18n.getText('discharge') : 'ÊîæÁîµ', class: 'discharge' }
            };
            return commands[command] || { text: command, class: 'charge' };
        }

        function getOperatorName(operator) {
            const operators = {
                'admin': window.i18n ? window.i18n.getText('systemAdmin') : 'Á≥ªÁªüÁÆ°ÁêÜÂëò',
                'user1': window.i18n ? window.i18n.getText('operatorA') : 'Êìç‰ΩúÂëòA',
                'user2': window.i18n ? window.i18n.getText('operatorB') : 'Êìç‰ΩúÂëòB'
            };
            return operators[operator] || operator;
        }

        // Initialize operation data when modal shows device response statistics
        function initializeOperationData() {
            const now = new Date();
            currentOperationData = {
                id: Math.floor(Math.random() * 1000000),
                time: now.toLocaleString(window.i18n ? (window.i18n.getCurrentLanguage() === 'zh' ? 'zh-CN' : 'en-US') : 'zh-CN'),
                command: currentOperation || 'discharge',
                operator: 'admin',
                stations: parseInt(document.getElementById('devicesDispatched')?.textContent || '500'),
                success: Math.floor(parseInt(document.getElementById('devicesDispatched')?.textContent || '500') * (parseInt(document.getElementById('successRate')?.textContent || '89') / 100)),
                failed: parseInt(document.getElementById('devicesDispatched')?.textContent || '500') - Math.floor(parseInt(document.getElementById('devicesDispatched')?.textContent || '500') * (parseInt(document.getElementById('successRate')?.textContent || '89') / 100))
            };
            
            // Generate initial content for the basic tab
            generateOperationTabContent(currentOperationData, 'basic');
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('operationModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'r':
                        e.preventDefault();
                        updateRealtimeData();
                        break;
                    case '1':
                        e.preventDefault();
                        switchRegion('NSW', document.querySelector('.tab.active'));
                        break;
                    case '2':
                        e.preventDefault();
                        switchRegion('QLD', document.querySelectorAll('.tab')[1]);
                        break;
                }
            }
        });

        // Touch gestures for mobile
        let touchStartX = 0;
        let touchEndX = 0;

        document.addEventListener('touchstart', function(e) {
            touchStartX = e.changedTouches[0].screenX;
        });

        document.addEventListener('touchend', function(e) {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        });

        function handleSwipe() {
            if (touchEndX < touchStartX - 50) {
                // Swipe left - next region
                const tabs = document.querySelectorAll('.chart-controls .tab');
                const activeIndex = Array.from(tabs).findIndex(tab => tab.classList.contains('active'));
                if (activeIndex < tabs.length - 1) {
                    tabs[activeIndex + 1].click();
                }
            }
            if (touchEndX > touchStartX + 50) {
                // Swipe right - previous region
                const tabs = document.querySelectorAll('.chart-controls .tab');
                const activeIndex = Array.from(tabs).findIndex(tab => tab.classList.contains('active'));
                if (activeIndex > 0) {
                    tabs[activeIndex - 1].click();
                }
            }
        }

        // Header functions
        function toggleMessages() {
            window.location.href = 'message-center.html';
        }

        function toggleLanguage() {
            const dropdown = document.getElementById('languageDropdown');
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        }

        function changeLanguage(langCode, langName) {
            document.getElementById('currentLang').textContent = langName;
            document.getElementById('languageDropdown').style.display = 'none';
            // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†ÂÆûÈôÖÁöÑËØ≠Ë®ÄÂàáÊç¢ÈÄªËæë
        }

        function toggleUserMenu() {
            window.location.href = 'user-settings.html';
        }

        // ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÂÖ≥Èó≠‰∏ãÊãâËèúÂçï
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.language-selector')) {
                document.getElementById('languageDropdown').style.display = 'none';
            }
        });

        
        // Force apply button colors
        function forceButtonStyles() {
            const chargeBtn = document.getElementById('chargeBtn');
            const dischargeBtn = document.getElementById('dischargeBtn');
            
            if (chargeBtn && !chargeBtn.classList.contains('stop-btn')) {
                chargeBtn.style.setProperty('background', 'linear-gradient(135deg, #00D67A, #00FF88)', 'important');
                chargeBtn.style.setProperty('border', '2px solid rgba(0, 255, 136, 0.3)', 'important');
                chargeBtn.style.setProperty('color', '#000', 'important');
                chargeBtn.style.setProperty('box-shadow', '0 4px 12px rgba(0, 255, 136, 0.3)', 'important');
            }
            
            if (dischargeBtn && !dischargeBtn.classList.contains('stop-btn')) {
                dischargeBtn.style.setProperty('background', 'linear-gradient(135deg, #FFA500, #FFD700)', 'important');
                dischargeBtn.style.setProperty('border', '2px solid rgba(255, 215, 0, 0.3)', 'important');
                dischargeBtn.style.setProperty('color', '#000', 'important');
                dischargeBtn.style.setProperty('box-shadow', '0 4px 12px rgba(255, 215, 0, 0.3)', 'important');
            }
            
        }
        

        // ‰∏ªÈ¢òÂàáÊç¢ÊåâÈíÆÈÄªËæë
        const themeToggle = document.getElementById('themeToggle');
        if (themeToggle) {
            themeToggle.onclick = function() {
                document.body.classList.toggle('theme-dark');
                this.textContent = document.body.classList.contains('theme-dark') ? '‚òÄÔ∏è' : 'üåô';
            }
        }
        
        // Êõ¥Êñ∞Âä®ÊÄÅÂÜÖÂÆπÁöÑÂáΩÊï∞
        function updateDynamicContent(language) {
            if (!window.i18n) {
                console.warn('window.i18n not available in updateDynamicContent');
                return;
            }
            
            try {
                // Êõ¥Êñ∞ÊâÄÊúâi18nÂÖÉÁ¥†
                window.i18n.updatePageTexts();
                
                // Êõ¥Êñ∞È°µÈù¢Ê†áÈ¢ò
                const pageTitles = {
                    'zh': 'ËÉΩÊ∫êÁÆ°ÁêÜ‰∏≠ÂøÉ',
                    'en': 'Energy Management Center',
                    'ja': '„Ç®„Éç„É´„ÇÆ„ÉºÁÆ°ÁêÜ„Çª„É≥„Çø„Éº',
                    'ko': 'ÏóêÎÑàÏßÄ Í¥ÄÎ¶¨ ÏÑºÌÑ∞'
                };
                document.title = pageTitles[language] || pageTitles['zh'];
                
                // Êõ¥Êñ∞Á°ÆËÆ§ÊåâÈíÆÊñáÊú¨ (Âä®ÊÄÅËÆæÁΩÆÁöÑ)
                const confirmBtn = document.getElementById('confirmExecuteBtn');
                if (confirmBtn) {
                    const confirmText = window.i18n.getText('confirmExecute');
                    if (confirmText !== 'confirmExecute') {
                        confirmBtn.innerHTML = '<span data-i18n="confirmExecute">' + confirmText + '</span>';
                    }
                }
                
                // No need to update current operation text anymore as it's removed
                
                // Êõ¥Êñ∞ÂõæË°®Ê†áÈ¢òÂíåÂõæ‰æã
                updateChartTitles(language);
                
                // Êõ¥Êñ∞ÈòàÂÄºÁä∂ÊÄÅÊñáÊú¨
                const thresholdStatus = document.querySelector('[data-threshold-status]');
                if (thresholdStatus) {
                    const statusKey = thresholdStatus.getAttribute('data-threshold-status');
                    if (statusKey) {
                        const translations = {
                            'zh': { 'not_exceeded': 'Êú™Ë∂ÖÈòà', 'exceeded': 'Â∑≤Ë∂ÖÈòà', 'warning': 'Ë≠¶Âëä' },
                            'en': { 'not_exceeded': 'Below Threshold', 'exceeded': 'Exceeded', 'warning': 'Warning' },
                            'ja': { 'not_exceeded': 'ÈñæÂÄ§Êú™Ê∫Ä', 'exceeded': 'ÈñæÂÄ§Ë∂ÖÈÅé', 'warning': 'Ë≠¶Âëä' },
                            'ko': { 'not_exceeded': 'ÏûÑÍ≥ÑÍ∞í ÎØ∏Îßå', 'exceeded': 'ÏûÑÍ≥ÑÍ∞í Ï¥àÍ≥º', 'warning': 'Í≤ΩÍ≥†' }
                        };
                        const text = translations[language] && translations[language][statusKey];
                        if (text) {
                            thresholdStatus.textContent = text;
                        }
                    }
                }
                
                // Êõ¥Êñ∞‰ª∑Ê†ºÁªüËÆ°ÊñáÊú¨
                const priceLabels = document.querySelectorAll('[data-price-label]');
                priceLabels.forEach(label => {
                    const labelKey = label.getAttribute('data-price-label');
                    if (labelKey === 'current-cumulative') {
                        const text = language === 'en' ? 'Current Cumulative Price' :
                                   language === 'ja' ? 'ÁèæÂú®„ÅÆÁ¥ØÁ©ç‰æ°Ê†º' :
                                   language === 'ko' ? 'ÌòÑÏû¨ ÎàÑÏ†Å Í∞ÄÍ≤©' : 'ÂΩìÂâçÁ¥ØËÆ°‰ª∑Ê†º';
                        label.textContent = text;
                    } else if (labelKey === 'forecast-cumulative') {
                        const text = language === 'en' ? 'Forecast Cumulative Price (5min)' :
                                   language === 'ja' ? '‰∫àÊ∏¨Á¥ØÁ©ç‰æ°Ê†ºÔºà5ÂàÜÔºâ' :
                                   language === 'ko' ? 'ÏòàÏ∏° ÎàÑÏ†Å Í∞ÄÍ≤© (5Î∂Ñ)' : 'È¢ÑÊµãÁ¥ØËÆ°‰ª∑Ê†º(5min)';
                        label.textContent = text;
                    } else if (labelKey === 'threshold-status') {
                        const text = language === 'en' ? 'Threshold Status' :
                                   language === 'ja' ? 'ÈñæÂÄ§Áä∂ÊÖã' :
                                   language === 'ko' ? 'ÏûÑÍ≥ÑÍ∞í ÏÉÅÌÉú' : 'ÈòàÂÄºÁä∂ÊÄÅ';
                        label.textContent = text;
                    }
                });
                
                // Êõ¥Êñ∞ÁôæÂàÜÊØîÂèòÂåñÊñáÊú¨
                const changeElements = document.querySelectorAll('[data-change-text]');
                changeElements.forEach(elem => {
                    const changeValue = elem.getAttribute('data-change-text');
                    if (changeValue) {
                        const changeText = language === 'en' ? `‚Üë ${changeValue}% vs Yesterday` :
                                         language === 'ja' ? `‚Üë Êò®Êó•ÊØî${changeValue}%` :
                                         language === 'ko' ? `‚Üë Ïñ¥Ï†úÎåÄÎπÑ ${changeValue}%` : `‚Üë ÊØîÊò®Êó•${changeValue}%`;
                        elem.textContent = changeText;
                    }
                });
                
                // Êõ¥Êñ∞Êï∞ÈáèÂçï‰Ωç (‰∏™ -> units)
                const countElements = ['totalHomes', 'confirmTargetDevices', 'targetDevices', 'totalFamiliesCard', 'todayDischargeFamilies', 'familySummaryCard'];
                countElements.forEach(id => {
                    const elem = document.getElementById(id);
                    if (elem && elem.textContent.includes('‰∏™')) {
                        const number = elem.textContent.replace('‰∏™', '');
                        const unit = language === 'en' ? '' : 
                                   language === 'ja' ? 'ÂÄã' :
                                   language === 'ko' ? 'Í∞ú' : '‰∏™';
                        elem.textContent = number + unit;
                    }
                });
                
                // ÂÆ∂Â∫≠Âçï‰ΩçÂ∑≤Âà†Èô§Ôºå‰∏çÈúÄË¶ÅÊõ¥Êñ∞
                
                // Êõ¥Êñ∞ÂÆ∂Â∫≠/FamilyÊòæÁ§∫ÂàáÊç¢
                const chineseTexts = document.querySelectorAll('.chinese-text');
                const englishTexts = document.querySelectorAll('.english-text');
                
                if (language === 'en') {
                    chineseTexts.forEach(elem => elem.style.display = 'none');
                    englishTexts.forEach(elem => elem.style.display = 'inline');
                } else {
                    chineseTexts.forEach(elem => elem.style.display = 'inline');
                    englishTexts.forEach(elem => elem.style.display = 'none');
                }
                
                // Êõ¥Êñ∞Âú∞Âå∫Áä∂ÊÄÅÊòæÁ§∫
                if (typeof updateRegionStatusDisplay === 'function') {
                    updateRegionStatusDisplay();
                } else {
                    console.warn('updateRegionStatusDisplay function not found');
                }
                
                // Êõ¥Êñ∞ÁîµÁ´ôÁä∂ÊÄÅÊ†áÁ≠æ
                if (typeof updateStationStatusLabel === 'function') {
                    const currentRegionStatus = regionData[selectedMainRegion] ? regionData[selectedMainRegion].status : 'none';
                    updateStationStatusLabel(currentRegionStatus);
                } else {
                    console.warn('updateStationStatusLabel function not found');
                }
                
            } catch (error) {
                console.error('Error updating dynamic content:', error);
            }
        }
        
        // Êõ¥Êñ∞ÂõæË°®Ê†áÈ¢ò
        function updateChartTitles(language) {
            // Êõ¥Êñ∞Â∏ÇÂú∫ÂõæË°®
            if (marketChart) {
                const option = marketChart.getOption();
                if (option && option.legend && option.legend[0]) {
                    option.legend[0].data = [
                        window.i18n.getText('historicalPrice'),
                        window.i18n.getText('demand'),
                        window.i18n.getText('predictedPrice'),
                        window.i18n.getText('predictedDemand')
                    ];
                }
                if (option && option.yAxis) {
                    option.yAxis[0].name = window.i18n.getText('price');
                    option.yAxis[1].name = window.i18n.getText('demand');
                }
                if (option && option.series) {
                    option.series[0].name = window.i18n.getText('historicalPrice');
                    option.series[1].name = window.i18n.getText('demand');
                    option.series[2].name = window.i18n.getText('predictedPrice');
                    option.series[3].name = window.i18n.getText('predictedDemand');
                }
                marketChart.setOption(option, true);
            }
            
            // Êõ¥Êñ∞ÂäüÁéáÂõæË°®
            if (powerChart) {
                const option = powerChart.getOption();
                if (option && option.legend && option.legend[0]) {
                    option.legend[0].data = [
                        window.i18n.getText('input'),
                        window.i18n.getText('output'),
                        window.i18n.getText('profit')
                    ];
                }
                if (option && option.series) {
                    option.series[0].name = window.i18n.getText('input');
                    option.series[1].name = window.i18n.getText('output');
                    option.series[2].name = window.i18n.getText('profit');
                }
                powerChart.setOption(option, true);
                
                // Force chart refresh for 'month' period to fix display issue
                if (powerChartTimeSelector && powerChartTimeSelector.getCurrentPeriod() === 'month') {
                    const { labels, power, revenue } = generateAnalyticsData('month');
                    updatePowerChartWithData(labels, power, revenue, 'month');
                }
            }
            
            // Êõ¥Êñ∞ÂõæË°®Ê†áÈ¢ò
            const powerChartTitle = document.getElementById('powerChartTitle');
            if (powerChartTitle) {
                powerChartTitle.textContent = window.i18n.getText('powerRevenueTrend');
            }
        }
    </script>
    
    <!-- Device Command Modal -->
    <div id="deviceCommandModal" class="modal" style="display: none;">
        <div class="modal-overlay" onclick="closeDeviceCommandModal()"></div>
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title" data-i18n="deviceCommand">ËÆæÂ§áÊåá‰ª§</h3>
                <button class="modal-close" onclick="closeDeviceCommandModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="command-info">
                    <div class="info-row">
                        <label data-i18n="operationType">Êìç‰ΩúÁ±ªÂûã</label>
                        <span id="commandOperationType" class="operation-type"></span>
                    </div>
                    <div class="info-row">
                        <label data-i18n="targetDevices">ÁõÆÊ†áËÆæÂ§á</label>
                        <span id="commandTargetDevices">235 <span data-i18n="devices">ËÆæÂ§á</span></span>
                    </div>
                    <div class="info-row">
                        <label data-i18n="executionTime">È¢ÑËÆ°ÊâßË°åÊó∂Èó¥</label>
                        <span id="commandExecutionTime"><span data-i18n="immediately">Á´ãÂç≥</span></span>
                    </div>
                    <div class="info-row" id="estimatedRevenueRow" style="display: none;">
                        <label data-i18n="estimatedProfit">È¢ÑËÆ°Ëé∑Âà©</label>
                        <span id="commandEstimatedRevenue" style="color: #00ff88; font-weight: 600;"><span data-i18n="estimatedProfitValue">+$340</span></span>
                    </div>
                </div>
                <div class="warning-message">
                    <span data-i18n="operationWarning">Ê≠§Êìç‰ΩúÂ∞ÜÂΩ±ÂìçÊâÄÊúâÈÄâ‰∏≠ÁöÑËÆæÂ§áÔºåËØ∑Á°ÆËÆ§ÂêéÁªßÁª≠„ÄÇ</span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDeviceCommandModal()" data-i18n="cancel">ÂèñÊ∂à</button>
                <button class="btn btn-primary" id="confirmCommandBtn" onclick="executeDeviceCommand()" data-i18n="confirmExecute">Á°ÆËÆ§ÊâßË°å</button>
            </div>
        </div>
    </div>
    
    <!-- Operation Result Modal (shown after charge/discharge command) -->
    <div id="operationResultModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10001;">
        <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(15px) saturate(1.5);" onclick="closeOperationResultModal()"></div>
        <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1a1f2e; border-radius: 16px; border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5); max-width: 600px; width: 90vw; overflow: hidden;">
            <div class="modal-header" style="padding: 24px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); display: flex; align-items: center; justify-content: space-between;">
                <div style="display: flex; align-items: center; gap: 16px;">
                    <div style="width: 48px; height: 48px; border-radius: 50%; background: rgba(0, 255, 136, 0.2); display: flex; align-items: center; justify-content: center;">
                        <span style="font-size: 24px;">üìä</span>
                    </div>
                    <h3 style="margin: 0; font-size: 20px; font-weight: 600; color: #fff;" data-i18n="deviceResponseStatisticsTitle">ËÆæÂ§áÂìçÂ∫îÁªüËÆ°</h3>
                </div>
                <button style="background: none; border: none; font-size: 24px; color: rgba(255, 255, 255, 0.6); cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%;" onclick="closeOperationResultModal()" onmouseover="this.style.background='rgba(255, 255, 255, 0.1)'; this.style.color='#fff';" onmouseout="this.style.background='none'; this.style.color='rgba(255, 255, 255, 0.6)';">√ó</button>
            </div>
            <div style="padding: 24px;">
                <p id="operationResultMessage" style="color: rgba(255, 255, 255, 0.8); margin-bottom: 24px; font-size: 14px;"></p>
                
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px;">
                    <div style="background: rgba(255, 255, 255, 0.05); border-radius: 10px; padding: 16px; text-align: center;">
                        <div style="font-size: 12px; color: rgba(255, 255, 255, 0.6); margin-bottom: 8px;" data-i18n="operationType">Êìç‰ΩúÁ±ªÂûã</div>
                        <div id="resultOperationType" style="font-size: 16px; font-weight: 600;"></div>
                    </div>
                    <div style="background: rgba(255, 255, 255, 0.05); border-radius: 10px; padding: 16px; text-align: center;">
                        <div style="font-size: 12px; color: rgba(255, 255, 255, 0.6); margin-bottom: 8px;" data-i18n="targetDevices">ÁõÆÊ†áËÆæÂ§á</div>
                        <div id="resultTargetDevices" style="font-size: 16px; font-weight: 600; color: #fff;">500</div>
                    </div>
                    <div style="background: rgba(255, 255, 255, 0.05); border-radius: 10px; padding: 16px; text-align: center;">
                        <div style="font-size: 12px; color: rgba(255, 255, 255, 0.6); margin-bottom: 8px;" data-i18n="estimatedDuration">È¢ÑËÆ°Êó∂Èïø</div>
                        <div style="font-size: 16px; font-weight: 600; color: #fff;">15-30 <span data-i18n="minutes">ÂàÜÈíü</span></div>
                    </div>
                </div>
                
                <div style="background: rgba(0, 255, 136, 0.1); border-radius: 16px; padding: 24px;">
                    <h4 style="color: #00ff88; margin: 0 0 20px 0; text-align: center; font-size: 16px;" data-i18n="deviceResponseStatistics">Device Response Statistics</h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                        <div style="text-align: center;">
                            <div style="font-size: 36px; font-weight: 700; color: #00ff88;">500</div>
                            <div style="color: rgba(255, 255, 255, 0.7); font-size: 14px;" data-i18n="commandsSent">‰∏ãÂèëËÆæÂ§á</div>
                        </div>
                        <div style="text-align: center;">
                            <div id="successRate" style="font-size: 36px; font-weight: 700; color: #00ff88;">89%</div>
                            <div style="color: rgba(255, 255, 255, 0.7); font-size: 14px;" data-i18n="successRate">Success Rate</div>
                        </div>
                    </div>
                </div>
            </div>
            <div style="padding: 32px 24px; min-height: 100px; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                <button style="background: rgba(255, 255, 255, 0.1); color: #fff; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 10px; padding: 8px 16px; font-size: 14px; cursor: pointer; transition: all 0.3s;" onclick="closeOperationResultModal()" onmouseover="this.style.background='rgba(255, 255, 255, 0.15)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.1)'" data-i18n="close">ÂÖ≥Èó≠</button>
                <button style="background: #00ff88; color: #000; border: none; border-radius: 10px; padding: 8px 24px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s;" onclick="viewDetailsFromResult()" onmouseover="this.style.background='#00dd77'" onmouseout="this.style.background='#00ff88'">
                    <span data-i18n="viewDetails">Êü•ÁúãËØ¶ÊÉÖ</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Device Response Statistics Modal -->
    <div id="deviceResponseModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 10002; align-items: center; justify-content: center; backdrop-filter: blur(15px) saturate(1.5);">
        <div class="modal-content" style="background: linear-gradient(145deg, #1e1e2e 0%, #252535 100%); border: none; padding: 0; overflow: hidden; width: 480px; max-width: 90%; border-radius: 24px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8), 0 0 1px rgba(255, 255, 255, 0.1);">
            <div class="modal-header" style="padding: 28px 32px; border-bottom: 1px solid rgba(255, 255, 255, 0.08); display: flex; align-items: center; justify-content: flex-start; background: rgba(255, 255, 255, 0.02);">
                <div class="modal-icon" id="responseModalIcon" style="width: 48px; height: 48px; background: linear-gradient(145deg, rgba(0, 255, 136, 0.15), rgba(0, 255, 136, 0.05)); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 16px; box-shadow: 0 4px 12px rgba(0, 255, 136, 0.15);">
                    <span id="modalIcon" style="font-size: 24px;">üìä</span>
                </div>
                <h3 class="modal-title" style="margin: 0; font-size: 20px; font-weight: 700; color: #fff; letter-spacing: 0.3px;" data-i18n="deviceResponseStatistics">ËÆæÂ§áÂìçÂ∫îÁªüËÆ°</h3>
            </div>
            
            <div class="modal-body" style="padding: 32px;">
                <p class="modal-message" style="color: rgba(255, 255, 255, 0.7); margin: 0 0 12px 0; font-size: 15px; font-weight: 400; line-height: 1.5; text-align: left;" id="operationCompleteMessage">Êìç‰ΩúÂÆåÊàêÔºå‰ª•‰∏ãÊòØËÆæÂ§áÂìçÂ∫îÁªüËÆ°Êä•ÂëäÔºö</p>

                <!-- Êìç‰ΩúÁ±ªÂûãÂíåÂΩ±ÂìçËÆæÂ§á‰ø°ÊÅØ -->
                <div class="modal-info-grid" style="display: flex; flex-direction: column; gap: 0; margin-bottom: 20px;">
                    <div style="display: flex; gap: 16px;">
                        <div class="modal-info-item" style="flex: 1; background: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 10px; padding: 16px 20px; transition: all 0.3s;">
                            <div class="modal-info-label" style="color: rgba(255, 255, 255, 0.6); font-size: 13px; margin-bottom: 6px; font-weight: 400;" data-i18n="operationType">Êìç‰ΩúÁ±ªÂûã</div>
                            <div class="modal-info-value" id="operationTypeDisplay" style="color: #00ff88; font-size: 18px; font-weight: 600; letter-spacing: 0.3px;">ÂÖÖÁîµ</div>
                        </div>
                        <div class="modal-info-item" style="flex: 1; background: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 10px; padding: 16px 20px; transition: all 0.3s;">
                            <div class="modal-info-label" style="color: rgba(255, 255, 255, 0.6); font-size: 13px; margin-bottom: 6px; font-weight: 400;">ÂèØË∞ÉÂ∫¶ËÆæÂ§á</div>
                            <div class="modal-info-value" id="targetDevicesDisplay" style="color: #fff; font-size: 18px; font-weight: 600;">500‰∏™</div>
                        </div>
                    </div>
                </div>

                <p style="color: rgba(255, 255, 255, 0.5); margin: 0 0 20px 0; font-size: 13px; font-weight: 400; line-height: 1.4; text-align: left;">üí° ÁÇπÂáª‰∏ãÊñπÊï∞Â≠óÊü•ÁúãËÆæÂ§áËØ¶ÊÉÖ</p>

                <!-- ËÆæÂ§áÁä∂ÊÄÅÁªüËÆ° - ÂèØÁÇπÂáª -->
                <div class="status-summary" style="background: linear-gradient(145deg, rgba(0, 255, 136, 0.08), rgba(0, 255, 136, 0.04)); border: 1px solid rgba(0, 255, 136, 0.15); border-radius: 10px; padding: 20px; backdrop-filter: blur(20px) saturate(1.5);">
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                        <!-- ‰∏ãÂèëÊàêÂäü -->
                        <div onclick="openDeviceStatusDrawerFromModal('success')" style="text-align: center; cursor: pointer; padding: 12px; border-radius: 10px; transition: all 0.3s; background: rgba(255, 255, 255, 0.03);" onmouseover="this.style.background='rgba(255, 255, 255, 0.08)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.03)'; this.style.transform='translateY(0)'">
                            <div id="modalSuccessCount" style="font-size: 36px; font-weight: 700; color: #00ff88; line-height: 1;">450</div>
                            <div style="color: rgba(255, 255, 255, 0.7); font-size: 13px; margin-top: 8px; font-weight: 500;" data-i18n="success">‰∏ãÂèëÊàêÂäü</div>
                        </div>

                        <!-- ÊâßË°å‰∏≠ -->
                        <div onclick="openDeviceStatusDrawerFromModal('executing')" style="text-align: center; cursor: pointer; padding: 12px; border-radius: 10px; transition: all 0.3s; background: rgba(255, 255, 255, 0.03);" onmouseover="this.style.background='rgba(255, 255, 255, 0.08)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.03)'; this.style.transform='translateY(0)'">
                            <div id="modalExecutingCount" style="font-size: 36px; font-weight: 700; color: #1e7fff; line-height: 1;">0</div>
                            <div style="color: rgba(255, 255, 255, 0.7); font-size: 13px; margin-top: 8px; font-weight: 500;" data-i18n="executing">ÊâßË°å‰∏≠</div>
                        </div>

                        <!-- ‰∏ãÂèëÂ§±Ë¥• -->
                        <div onclick="openDeviceStatusDrawerFromModal('failed')" style="text-align: center; cursor: pointer; padding: 12px; border-radius: 10px; transition: all 0.3s; background: rgba(255, 255, 255, 0.03);" onmouseover="this.style.background='rgba(255, 255, 255, 0.08)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.03)'; this.style.transform='translateY(0)'">
                            <div id="modalFailedCount" style="font-size: 36px; font-weight: 700; color: #ff6b6b; line-height: 1;">50</div>
                            <div style="color: rgba(255, 255, 255, 0.7); font-size: 13px; margin-top: 8px; font-weight: 500;" data-i18n="failed">‰∏ãÂèëÂ§±Ë¥•</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer" style="padding: 20px 28px 28px; display: flex; justify-content: center; gap: 16px;">
                <button class="modal-btn modal-export-btn" onclick="openDeviceStatusDrawerFromModal('success')" style="background: linear-gradient(135deg, #1e7fff, #0d5dd8); color: #fff; border: none; padding: 12px 32px; border-radius: 999px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; min-width: 120px; box-shadow: 0 2px 8px rgba(30, 127, 255, 0.3);" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(30, 127, 255, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(30, 127, 255, 0.3)'">
                    <span data-i18n="viewDetails">Êü•ÁúãËØ¶ÊÉÖ</span>
                </button>
                <button class="modal-btn modal-cancel-btn" onclick="closeDeviceResponseModal()" style="background: linear-gradient(135deg, #00ff88, #00dd77); color: #000; border: none; padding: 12px 32px; border-radius: 999px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; min-width: 120px; box-shadow: 0 2px 8px rgba(0, 255, 136, 0.3);" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(0, 255, 136, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0, 255, 136, 0.3)'" data-i18n="close">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>
    
    
    <style>
        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(15px) saturate(1.5);
        }
        
        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(15px) saturate(1.5);
        }
        
        .modal-content {
            position: relative;
            background: #1a1f2e;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }
        
        .modal-header {
            padding: 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #fff;
            margin: 0;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            transition: all 0.3s;
        }
        
        .modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }
        
        .modal-body {
            padding: 24px;
        }
        
        .command-info {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .info-row label {
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
        }
        
        .info-row span {
            color: #fff;
            font-size: 16px;
            font-weight: 500;
        }
        
        .operation-type {
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 14px;
        }
        
        .operation-type.charge {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }
        
        .operation-type.discharge {
            background: rgba(255, 165, 0, 0.2);
            color: #ffa500;
        }
        
        .operation-type.stop {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
        }
        
        .warning-message {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 10px;
            padding: 16px;
            color: #ffc107;
            font-size: 14px;
            line-height: 1.5;
        }
        
        
        .btn {
            padding: 10px 24px;
            border-radius: 22px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            min-width: 100px;
            height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #00D67A, #00FF88);
            color: #000;
        }
        
        .btn-primary:hover {
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3);
        }
        
        /* Device Response Modal Styles */
        .modal-tabs {
            display: flex;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.02);
        }
        
        .modal-tab {
            flex: 1;
            padding: 16px;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .modal-tab.active {
            color: #fff;
        }
        
        .modal-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: #00ff88;
        }
        
        .tab-content {
            padding: 24px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .station-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }
        
        .station-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .station-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .station-name {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
        }
        
        .station-status {
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
        }
        
        .status-active {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 14px;
        }
        
        .detail-label {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .detail-value {
            color: #fff;
        }
        
        .timeline {
            position: relative;
            padding-left: 40px;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: 16px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .timeline-item {
            position: relative;
            padding-bottom: 32px;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -28px;
            top: 4px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid #1a1f2e;
        }
        
        .timeline-item.completed::before {
            background: #00ff88;
        }
        
        .timeline-item.active::before {
            background: #ffa500;
            box-shadow: 0 0 0 4px rgba(255, 165, 0, 0.2);
        }
        
        .timeline-time {
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
            margin-bottom: 8px;
        }
        
        .timeline-title {
            color: #fff;
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .timeline-desc {
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
        }
        
        /* Result Modal Styles */
        .result-info-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
        }
        
        .result-info-item {
            text-align: center;
        }
        
        .result-info-item label {
            display: block;
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .result-info-item span {
            color: #fff;
            font-size: 16px;
            font-weight: 500;
        }
    </style>
    
    <script>
        // Device Command Modal Functions
        let isOperationActive = false;
        
        // ÁßªÈô§ÈáçÂ§çÁöÑÂáΩÊï∞ÂÆö‰πâÔºå‰ΩøÁî®‰∏ªË¶ÅÁöÑhandleChargeÂíåhandleDischargeÂáΩÊï∞
        
        
        function showDeviceCommandModal(operation, currentOpText) {
            const modal = document.getElementById('deviceCommandModal');
            const modalTitle = modal.querySelector('.modal-title');
            const operationType = document.getElementById('commandOperationType');
            const confirmBtn = document.getElementById('confirmCommandBtn');
            const warningMessage = modal.querySelector('.warning-message span');
            const executionTime = document.getElementById('commandExecutionTime');
            
            // Update modal based on operation type
            if (operation === 'charge') {
                modalTitle.textContent = window.i18n ? window.i18n.getText('confirmCharge') : 'Á°ÆËÆ§ÂÖÖÁîµ';
                operationType.textContent = window.i18n ? window.i18n.getText('charge') : 'ÂÖÖÁîµ';
                operationType.className = 'operation-type charge';
                operationType.style.color = '#00ff88';
                warningMessage.textContent = window.i18n ? window.i18n.getText('operationWarning') : 'Ê≠§Êìç‰ΩúÂ∞ÜÂΩ±ÂìçÊâÄÊúâÈÄâ‰∏≠ÁöÑËÆæÂ§áÔºåËØ∑Á°ÆËÆ§ÂêéÁªßÁª≠„ÄÇ';
                
                // Hide estimated revenue for charge
                const revenueRow = document.getElementById('estimatedRevenueRow');
                if (revenueRow) revenueRow.style.display = 'none';
            } else if (operation === 'discharge') {
                modalTitle.textContent = window.i18n ? window.i18n.getText('confirmDischarge') : 'Á°ÆËÆ§ÊîæÁîµ';
                operationType.textContent = window.i18n ? window.i18n.getText('discharge') : 'ÊîæÁîµ';
                operationType.className = 'operation-type discharge';
                warningMessage.textContent = window.i18n ? window.i18n.getText('operationWarning') : 'Ê≠§Êìç‰ΩúÂ∞ÜÂΩ±ÂìçÊâÄÊúâÈÄâ‰∏≠ÁöÑËÆæÂ§áÔºåËØ∑Á°ÆËÆ§ÂêéÁªßÁª≠„ÄÇ';
                
                // Show estimated revenue for discharge
                const revenueRow = document.getElementById('estimatedRevenueRow');
                if (revenueRow) {
                    revenueRow.style.display = 'flex';
                    const revenueElement = document.getElementById('commandEstimatedRevenue');
                    if (revenueElement) {
                        revenueElement.innerHTML = '<span data-i18n="estimatedProfitValue">+$340</span>';
                    }
                }
            } else if (operation === 'stop') {
                modalTitle.textContent = window.i18n ? window.i18n.getText('confirmStop') : 'Á°ÆËÆ§ÂÅúÊ≠¢';
                const stopText = window.i18n ? window.i18n.getText('stopOperation') : 'ÂÅúÊ≠¢Êìç‰Ωú';
                operationType.textContent = stopText;
                operationType.className = 'operation-type stop';
                warningMessage.textContent = window.i18n ? window.i18n.getText('stopWarning') : 'ÂÅúÊ≠¢Êìç‰ΩúÂ∞ÜÁ´ãÂç≥ÁªàÊ≠¢ÊâÄÊúâËÆæÂ§áÁöÑÂÖÖÁîµ/ÊîæÁîµÁä∂ÊÄÅÔºåËÆæÂ§áÂ∞ÜÊÅ¢Â§çÂà∞ÂæÖÊú∫Ê®°Âºè„ÄÇ';
                
                // Hide estimated revenue for stop
                const revenueRow = document.getElementById('estimatedRevenueRow');
                if (revenueRow) revenueRow.style.display = 'none';
            }
            
            // Store operation for execution
            confirmBtn.setAttribute('data-operation', operation);
            
            // Show modal
            modal.style.display = 'flex';
        }
        
        function closeDeviceCommandModal() {
            const modal = document.getElementById('deviceCommandModal');
            if (modal) {
                modal.classList.remove('show');
                modal.style.display = 'none';
                modal.style.opacity = '0';
            }
        }
        
        function executeDeviceCommand() {
            const confirmBtn = document.getElementById('confirmCommandBtn');
            const operation = confirmBtn.getAttribute('data-operation');
            
            closeDeviceCommandModal();
            
            // Update button states
            const chargeBtn = document.getElementById('chargeBtn');
            const dischargeBtn = document.getElementById('dischargeBtn');
            const actionButtons = document.querySelector('.action-buttons');
            
            if (operation === 'stop') {
                // ÊâßË°åÂÅúÊ≠¢Êìç‰Ωú
                executeStopOperation();
            } else {
                // Set active operation
                isOperationActive = true;
                currentOperation = operation;
                
                // Add operating class to container for centering
                actionButtons.classList.add('operating');
                
                // Update buttons - only show one centered stop button
                if (operation === 'charge') {
                    chargeBtn.innerHTML = `<span data-i18n="stop">${window.i18n ? window.i18n.getText('stop') : 'ÂÅúÊ≠¢'}</span>`;
                    chargeBtn.classList.remove('charge-btn');
                    chargeBtn.classList.add('stop-btn');
                    chargeBtn.style.setProperty('background', 'linear-gradient(135deg, #ff4444, #ff6b6b)', 'important');
                    chargeBtn.style.setProperty('border', '2px solid rgba(255, 68, 68, 0.3)', 'important');
                    chargeBtn.style.setProperty('color', '#fff', 'important');
                    chargeBtn.style.setProperty('flex', '1', 'important');
                    chargeBtn.style.setProperty('max-width', '200px', 'important');
                    
                    // Hide discharge button
                    dischargeBtn.style.display = 'none';
                } else if (operation === 'discharge') {
                    dischargeBtn.innerHTML = `<span data-i18n="stop">${window.i18n ? window.i18n.getText('stop') : 'ÂÅúÊ≠¢'}</span>`;
                    dischargeBtn.classList.remove('discharge-btn');
                    dischargeBtn.classList.add('stop-btn');
                    dischargeBtn.style.setProperty('background', 'linear-gradient(135deg, #ff4444, #ff6b6b)', 'important');
                    dischargeBtn.style.setProperty('border', '2px solid rgba(255, 68, 68, 0.3)', 'important');
                    dischargeBtn.style.setProperty('color', '#fff', 'important');
                    dischargeBtn.style.setProperty('flex', '1', 'important');
                    dischargeBtn.style.setProperty('max-width', '200px', 'important');
                    
                    // Hide charge button
                    chargeBtn.style.display = 'none';
                }
            }
            
            // Only show modal immediately for stop operation
            // For charge/discharge, the animation will handle showing the modal when complete
            if (operation === 'stop') {
                setTimeout(() => {
                    // ‰∏çÂÜçËá™Âä®ÊâìÂºÄËØ¶ÊÉÖÊäΩÂ±â
                }, 1500);
            }
        }
        
        function showNotification(message, type = 'info') {
            // Simple notification (you can enhance this)
        }
        
        // Operation Result Modal Functions
        function showOperationResultModal(operation) {
            const modal = document.getElementById('operationResultModal');
            const message = document.getElementById('operationResultMessage');
            const operationType = document.getElementById('resultOperationType');
            const targetDevices = document.getElementById('resultTargetDevices');
            
            // Set operation type
            if (operation === 'charge') {
                operationType.textContent = window.i18n ? window.i18n.getText('charge') : 'ÂÖÖÁîµ';
                operationType.style.color = '#00ff88';
                message.textContent = window.i18n ? window.i18n.getText('chargingCompleteMessage') : 'ÂÖÖÁîµÊåá‰ª§‰∏ãÂèëÂÆåÊàêÔºå‰ª•‰∏ãÊòØËÆæÂ§áÂìçÂ∫îÁªüËÆ°Êä•ÂëäÔºö';
            } else if (operation === 'discharge') {
                operationType.textContent = window.i18n ? window.i18n.getText('discharge') : 'ÊîæÁîµ';
                operationType.style.color = '#ffd700';
                message.textContent = window.i18n ? window.i18n.getText('dischargingCompleteMessage') : 'ÊîæÁîµÊåá‰ª§‰∏ãÂèëÂÆåÊàêÔºå‰ª•‰∏ãÊòØËÆæÂ§áÂìçÂ∫îÁªüËÆ°Êä•ÂëäÔºö';
            }
            
            // Set target devices - Ëã±ÊñáÊ®°ÂºèÂè™ÊòæÁ§∫Êï∞Â≠ó
            const currentLang = window.i18n ? window.i18n.getCurrentLanguage() : 'zh';
            if (currentLang === 'en') {
                targetDevices.textContent = '500';
            } else {
                targetDevices.textContent = (window.i18n && window.i18n.getCurrentLanguage() === 'en') ? '500' : '500‰∏™';
            }
            
            // ÁîüÊàêÈöèÊú∫ÁªüËÆ°Êï∞ÊçÆ
            const commandsReceived = Math.floor(Math.random() * 10) + 490; // 490-499
            const devicesActivated = Math.floor(Math.random() * 50) + 430; // 430-479
            const successRate = Math.floor((devicesActivated / 500) * 100);
            
            document.getElementById('commandsReceived').textContent = commandsReceived;
            document.getElementById('devicesActivated').textContent = devicesActivated;
            document.getElementById('successRate').textContent = successRate + '%';
            
            // ÊòæÁ§∫ÂºπÁ™ó
            modal.style.display = 'block';
        }
        
        function closeOperationResultModal() {
            document.getElementById('operationResultModal').style.display = 'none';
        }
        
        function viewDetailsFromResult() {
            closeOperationResultModal();
            showDeviceResponseModal();
        }
        
        // Device Response Modal Functions
        function showDeviceResponseModal() {
            const modal = document.getElementById('deviceResponseModal');
            modal.style.display = 'flex';
            // Load data for the modal
            loadDeviceResponseData();
        }
        
        // Export device response statistics
        function exportDeviceResponseStatistics() {
            // Get current data from modal
            const operationType = document.getElementById('operationTypeDisplay').textContent;
            const targetDevices = document.getElementById('targetDevicesDisplay').textContent;
            const successCount = document.getElementById('modalSuccessCount').textContent;
            const executingCount = document.getElementById('modalExecutingCount').textContent;
            const failedCount = document.getElementById('modalFailedCount').textContent;

            // Get current language
            const currentLang = window.i18n ? window.i18n.getCurrentLanguage() : 'zh';

            // Create CSV headers based on language
            const headers = currentLang === 'en' ?
                ['Export Time', 'Operation Type', 'Target Devices', 'Success', 'Executing', 'Failed', 'Success Rate'] :
                ['ÂØºÂá∫Êó∂Èó¥', 'Êìç‰ΩúÁ±ªÂûã', 'ÂΩ±ÂìçËÆæÂ§á', '‰∏ãÂèëÊàêÂäü', 'ÊâßË°å‰∏≠', '‰∏ãÂèëÂ§±Ë¥•', 'ÊàêÂäüÁéá'];

            // Calculate success rate
            const total = parseInt(successCount) + parseInt(executingCount) + parseInt(failedCount);
            const successRate = total > 0 ? ((parseInt(successCount) / total) * 100).toFixed(1) + '%' : '0%';

            // Get current timestamp
            const now = new Date();
            const timestamp = now.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });

            // Create CSV content
            let csvContent = '\uFEFF' + headers.join(',') + '\n'; // Add BOM for UTF-8

            // Add data row
            const row = [
                timestamp,
                operationType,
                targetDevices,
                successCount,
                executingCount,
                failedCount,
                successRate
            ];
            csvContent += row.join(',') + '\n';

            // Create blob and download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            link.setAttribute('href', url);
            link.setAttribute('download', `device_response_statistics_${now.getTime()}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // Show success message
            const message = currentLang === 'en' ? 'Export successful!' : 'ÂØºÂá∫ÊàêÂäüÔºÅ';
            alert(message);
        }

        function closeDeviceResponseModal() {
            document.getElementById('deviceResponseModal').style.display = 'none';
            // ËÆæÁΩÆÊ†áÂøóÔºåÈò≤Ê≠¢Ëá™Âä®ÈáçÊñ∞ÊòæÁ§∫
            window.deviceResponseModalClosed = true;
        }

        // ‰ªéËÆæÂ§áÂìçÂ∫îÂºπÁ™óÁÇπÂáªÁªüËÆ°Êï∞Â≠óÊâìÂºÄËÆæÂ§áÁä∂ÊÄÅÊäΩÂ±â
        window.openDeviceStatusDrawerFromModal = function(type) {
            // ‰∏çÂÖ≥Èó≠ËÆæÂ§áÂìçÂ∫îÁªüËÆ°ÂºπÁ™óÔºåÁõ¥Êé•ÊâìÂºÄËÆæÂ§áÁä∂ÊÄÅÊäΩÂ±â
            openDeviceStatusDrawer(type);
        };
        
        function viewDeviceResponseDetails() {
            // ‰ΩøÁî®Êñ∞ÁöÑÊäΩÂ±âÁªÑ‰ª∂
            if (!window.deviceResponseDrawer) {
                window.deviceResponseDrawer = new DeviceResponseDrawer();
            }

            // ÂàõÂª∫‰∏éÊìç‰ΩúËÆ∞ÂΩïÈ°µÈù¢Áõ∏ÂêåÊ†ºÂºèÁöÑÊï∞ÊçÆ
            const operation = {
                id: Date.now(),
                time: new Date().toLocaleString(),
                command: currentOperation || 'charge',
                operator: 'System',
                region: selectedMainRegion || 'NSW',
                stations: 235,
                success: 230,
                failed: 5
            };

            // ÊâìÂºÄÊäΩÂ±â - ‰∏çÂÖ≥Èó≠ËÆæÂ§áÂìçÂ∫îÁªüËÆ°ÂºπÁ™ó
            window.deviceResponseDrawer.open(operation);
        }
        
        
        function switchDeviceResponseTab(tabName, tabElement) {
            // Update active tab
            document.querySelectorAll('.modal-tab').forEach(tab => tab.classList.remove('active'));
            tabElement.classList.add('active');
            
            // Show corresponding content
            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
            document.getElementById(tabName + 'Tab').style.display = 'block';
        }
        
        function loadDeviceResponseData(operation) {
            // Ê®°ÊãüÂä†ËΩΩËÆæÂ§áÂìçÂ∫îÊï∞ÊçÆ
            const deviceData = {
                operation: operation || currentOperation || 'charge',
                totalDevices: 500,
                commandsReceived: Math.floor(Math.random() * 10) + 490,
                devicesActivated: Math.floor(Math.random() * 50) + 430,
                onlineDevices: Math.floor(Math.random() * 10) + 490,
                executingDevices: Math.floor(Math.random() * 50) + 430,
                stations: generateStationData(50), // ÁîüÊàê50‰∏™ÁîµÁ´ôÊï∞ÊçÆ
                timeline: generateTimelineData()
            };
            
            // Â≠òÂÇ®Êï∞ÊçÆ‰ª•‰æõÂêéÁª≠‰ΩøÁî®
            window.currentDeviceResponseData = deviceData;
            
            return deviceData;
        }
        
        // ÁîüÊàêÈöèÊú∫ÁîµÁ´ôÊï∞ÊçÆ
        function generateStationData(count) {
            const stations = [];
            const regions = ['NSW', 'VIC', 'QLD', 'WA', 'SA', 'TAS', 'NT', 'ACT'];
            const statuses = ['online', 'charging', 'discharging', 'idle', 'offline'];
            const statusLabels = {
                online: { zh: 'Âú®Á∫ø', en: 'Online' },
                charging: { zh: 'ÂÖÖÁîµ‰∏≠', en: 'Charging' },
                discharging: { zh: 'ÊîæÁîµ‰∏≠', en: 'Discharging' },
                idle: { zh: 'Á©∫Èó≤', en: 'Idle' },
                offline: { zh: 'Á¶ªÁ∫ø', en: 'Offline' }
            };
            
            for (let i = 0; i < count; i++) {
                const region = regions[Math.floor(Math.random() * regions.length)];
                const status = statuses[Math.floor(Math.random() * statuses.length)];
                stations.push({
                    id: `${region}-${String(i + 1).padStart(3, '0')}`,
                    name: `Station ${region}-${String(i + 1).padStart(3, '0')}`,
                    region: region,
                    location: `${region} Region`,
                    capacity: Math.floor(Math.random() * 400) + 100, // 100-500 kWh
                    power: Math.floor(Math.random() * 200) + 50, // 50-250 kW
                    soc: Math.floor(Math.random() * 100), // 0-100%
                    status: status,
                    statusLabel: statusLabels[status]
                });
            }
            
            return stations;
        }
        
        // ÁîüÊàêÊó∂Èó¥Á∫øÊï∞ÊçÆ
        function generateTimelineData() {
            const now = new Date();
            const timeline = [];
            
            // Êåá‰ª§‰∏ãÂèë
            timeline.push({
                time: formatTime(now),
                title: { zh: 'Êåá‰ª§‰∏ãÂèë', en: 'Command Issued' },
                description: { zh: 'Á≥ªÁªüÂêëÊâÄÊúâËÆæÂ§áÂèëÈÄÅÊìç‰ΩúÊåá‰ª§', en: 'System sent operation command to all devices' },
                type: 'success'
            });
            
            // ËÆæÂ§áÂìçÂ∫î
            const responseTime = new Date(now.getTime() + 5000);
            const respondedCount = Math.floor(Math.random() * 10) + 490;
            timeline.push({
                time: formatTime(responseTime),
                title: { zh: 'ËÆæÂ§áÂìçÂ∫î', en: 'Devices Responded' },
                description: { 
                    zh: `${respondedCount}‰∏™ËÆæÂ§áÁ°ÆËÆ§Êî∂Âà∞Êåá‰ª§`, 
                    en: `${respondedCount} devices confirmed receipt of command` 
                },
                type: 'success'
            });
            
            // ÂºÄÂßãÊâßË°å
            const executionTime = new Date(now.getTime() + 15000);
            const executingCount = Math.floor(Math.random() * 50) + 430;
            timeline.push({
                time: formatTime(executionTime),
                title: { zh: 'ÂºÄÂßãÊâßË°å', en: 'Execution Started' },
                description: { 
                    zh: `${executingCount}‰∏™ËÆæÂ§áÂºÄÂßãÊâßË°åÊìç‰Ωú`, 
                    en: `${executingCount} devices started executing operation` 
                },
                type: 'active'
            });
            
            // ÈÉ®ÂàÜÂÆåÊàê
            const partialTime = new Date(now.getTime() + 60000);
            const completedCount = Math.floor(Math.random() * 100) + 300;
            timeline.push({
                time: formatTime(partialTime),
                title: { zh: 'ÈÉ®ÂàÜÂÆåÊàê', en: 'Partial Completion' },
                description: { 
                    zh: `${completedCount}‰∏™ËÆæÂ§áÂ∑≤ÂÆåÊàêÊìç‰Ωú`, 
                    en: `${completedCount} devices completed operation` 
                },
                type: 'info'
            });
            
            return timeline;
        }
        
        // Ê†ºÂºèÂåñÊó∂Èó¥
        function formatTime(date) {
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }
        
        
        // Ê∑ªÂä†ÂÖ®Â±ÄÂº∫Âà∂ÂàáÊç¢Âà∞Â∏ÇÂú∫È°µÈù¢ÁöÑÂëΩ‰ª§
        window.forceMarket = function() {
            switchPanel('market');
            
            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            const marketTab = document.querySelector('[onclick*="switchPanel(\'market\')"]');
            const mapTab = document.querySelector('[onclick*="switchPanel(\'map\')"]');
            if (marketTab) marketTab.classList.add('active');
            if (mapTab) mapTab.classList.remove('active');
            
            // Êõ¥Êñ∞Èù¢ÊùøÊòæÁ§∫
            const marketPanel = document.getElementById('marketPanel');
            const mapPanel = document.getElementById('mapPanel');
            if (marketPanel) {
                marketPanel.style.display = 'block';
                marketPanel.classList.add('active');
            }
            if (mapPanel) {
                mapPanel.style.display = 'none';
                mapPanel.classList.remove('active');
            }
            
        };
        
        // Âú®ÊéßÂà∂Âè∞ËæìÂá∫Â∏ÆÂä©‰ø°ÊÅØ
        
        // Ê∑ªÂä†ÊâãÂä®ÊµãËØïÂáΩÊï∞
        window.testMarketChart = function() {
            const container = document.getElementById('marketChart');
            if (!container) {
                // error('Market chart container not found!');
                return;
            }
            
            
            // ÈîÄÊØÅÊóßÂÆû‰æã
            if (marketChart) {
                marketChart.dispose();
            }
            
            // ÂàõÂª∫Êñ∞ÂÆû‰æã
            marketChart = echarts.init(container);
            
            // ‰ΩøÁî®ÊúÄÁÆÄÂçïÁöÑÈÖçÁΩÆ
            const option = {
                title: { text: 'Market Test' },
                xAxis: { type: 'category', data: ['A', 'B', 'C'] },
                yAxis: { type: 'value' },
                series: [{ data: [120, 200, 150], type: 'line' }]
            };
            
            marketChart.setOption(option);
        };
        
        window.testMapChart = function() {
            const container = document.getElementById('australiaMap');
            if (!container) {
                console.error('Map chart container not found!');
                return;
            }
            
            // ÂàáÊç¢Âà∞Âú∞ÂõæÈù¢Êùø
            switchPanel('map');
            
            setTimeout(() => {
                
                // ÈîÄÊØÅÊóßÂÆû‰æã
                if (mapChart) {
                    mapChart.dispose();
                }
                
                // ÂàõÂª∫Êñ∞ÂÆû‰æã
                mapChart = echarts.init(container);
                
                // ‰ΩøÁî®ÊúÄÁÆÄÂçïÁöÑÈÖçÁΩÆ
                const option = {
                    title: { text: 'Map Test' },
                    xAxis: { type: 'category', data: ['A', 'B', 'C'] },
                    yAxis: { type: 'value' },
                    series: [{ data: [120, 200, 150], type: 'bar' }]
                };
                
                mapChart.setOption(option);
            }, 300);
        };
        
        
        // ‰øÆÂ§çÂáΩÊï∞ - ÈáçÊñ∞ÂàùÂßãÂåñÊâÄÊúâÂõæË°®
        window.fixCharts = function() {
            
            // Á°Æ‰øùÂÆπÂô®ÂèØËßÅ
            const marketPanel = document.getElementById('marketPanel');
            const mapPanel = document.getElementById('mapPanel');
            
            // ÊøÄÊ¥ªÂ∏ÇÂú∫Èù¢Êùø
            marketPanel.classList.add('active');
            marketPanel.style.display = 'flex';
            mapPanel.classList.remove('active');
            mapPanel.style.display = 'none';
            
            // ÈáçÊñ∞ÂàùÂßãÂåñÂ∏ÇÂú∫ÂõæË°®
            setTimeout(() => {
                if (marketChart) {
                    marketChart.dispose();
                }
                initMarketChart();
                
                // ÂàáÊç¢Âà∞Âú∞ÂõæÈù¢ÊùøÂπ∂ÂàùÂßãÂåñ
                setTimeout(() => {
                    mapPanel.classList.add('active');
                    mapPanel.style.display = 'flex';
                    marketPanel.classList.remove('active');
                    marketPanel.style.display = 'none';
                    
                    if (mapChart) {
                        mapChart.dispose();
                    }
                    initMap();
                    
                    // ÂàáÂõûÂ∏ÇÂú∫Èù¢Êùø
                    setTimeout(() => {
                        marketPanel.classList.add('active');
                        marketPanel.style.display = 'flex';
                        mapPanel.classList.remove('active');
                        mapPanel.style.display = 'none';
                        
                        if (marketChart) {
                            if (marketChart && typeof marketChart.resize === 'function') {
                            if (marketChart && typeof marketChart.resize === 'function') {
                        marketChart.resize();
                    }
                        }
                        }
                        
                    }, 500);
                }, 500);
            }, 100);
        };
        
        
        // Update power revenue chart when language changes
        window.updatePowerRevenueChartLanguage = function() {
            if (!powerRevenueChart) return;
            
            powerRevenueChart.setOption({
                legend: {
                    data: [window.i18n.getText('input'), window.i18n.getText('output'), window.i18n.getText('profit')]
                },
                yAxis: [
                    {
                        name: window.i18n.getText('discharge')
                    },
                    {
                        name: window.i18n.getText('profit')
                    }
                ],
                series: [
                    {
                        name: window.i18n.getText('input')
                    },
                    {
                        name: window.i18n.getText('output')
                    },
                    {
                        name: window.i18n.getText('profit')
                    }
                ]
            });
        };
        
        // Update market chart when language changes
        window.updateMarketChartLanguage = function() {
            if (!marketChart) return;
            
            const getText = (key) => window.i18n ? window.i18n.getText(key) : translations.en[key];
            const translations = {
                en: {
                    historicalPrice: 'Historical Price',
                    predictedPrice: 'Predicted Price',
                    demand: 'Demand',
                    predictedDemand: 'Predicted Demand',
                    price: 'Price ($/MWh)',
                    demandUnit: 'Demand (MW)'
                },
                zh: {
                    historicalPrice: 'ÂéÜÂè≤‰ª∑Ê†º',
                    predictedPrice: 'È¢ÑÊµã‰ª∑Ê†º',
                    demand: 'ÈúÄÊ±Ç',
                    predictedDemand: 'È¢ÑÊµãÈúÄÊ±Ç',
                    price: '‰ª∑Ê†º ($/MWh)',
                    demandUnit: 'ÈúÄÊ±Ç (MW)'
                }
            };
            
            marketChart.setOption({
                legend: {
                    data: [getText('historicalPrice'), getText('demand'), getText('predictedPrice'), getText('predictedDemand')]
                },
                yAxis: [
                    {
                        name: getText('price')
                    },
                    {
                        name: getText('demandUnit')
                    }
                ],
                series: [
                    {
                        name: getText('historicalPrice')
                    },
                    {
                        name: getText('demand')
                    },
                    {
                        name: getText('predictedPrice')
                    },
                    {
                        name: getText('predictedDemand')
                    }
                ]
            });
        };
        
        // Force re-initialization when page is fully loaded
        window.addEventListener('load', function() {
            setTimeout(() => {
                // Force reinitialize market chart if it's not visible
                const marketPanel = document.getElementById('marketPanel');
                if (marketPanel && marketPanel.classList.contains('active')) {
                    const marketContainer = document.getElementById('marketChart');
                    if (marketContainer && (!marketChart || marketContainer.offsetHeight === 0)) {
                        initMarketChart();
                    } else if (marketChart) {
                        if (marketChart && typeof marketChart.resize === 'function') {
                            if (marketChart && typeof marketChart.resize === 'function') {
                        marketChart.resize();
                    }
                        }
                    }
                }
            }, 1000);
        });
        
    </script>
    
    <style>
        /* ÊúÄÁªàÂº∫Âà∂Ë¶ÜÁõñ - Á°Æ‰øùÊäΩÂ±âÂú®ÁªùÂØπÊúÄÈ°∂Â±Ç */
        #homeOperationDrawer,
        #homeOperationDrawer .drawer-overlay,
        #homeOperationDrawer .drawer-container,
        #deviceResponseDrawerComponent,
        #deviceResponseDrawerComponent .drawer-overlay,
        #deviceResponseDrawerComponent .drawer-container {
            z-index: 2147483647 !important;
            position: fixed !important;
        }
        
        .drawer-overlay {
            z-index: 2147483647 !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            pointer-events: auto !important;
        }
        
        .drawer-overlay.show {
            z-index: 2147483647 !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            pointer-events: auto !important;
        }
        
        .drawer-overlay.show .drawer-container {
            z-index: 2147483647 !important;
            position: fixed !important;
            top: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            pointer-events: auto !important;
        }
        
        /* Èôç‰ΩéÈ¶ñÈ°µÂÖ∂‰ªñÂÖÉÁ¥†ÁöÑz-index */
        .hero-section, .hero-section * {
            z-index: 1 !important;
        }
        
        .dashboard-content, .dashboard-content * {
            z-index: 1 !important;
        }
        
        .panel-content {
            z-index: 1 !important;
        }
        
        .container, .container * {
            z-index: 1 !important;
        }
        
        /* Á°Æ‰øùÊìç‰ΩúÁªüËÆ°Ê®°ÊÄÅÊ°Ü‰πüÂú®ÂêàÁêÜÂ±ÇÁ∫ß */
        #operationModal {
            z-index: 9999 !important;
        }
        
        /* Á°Æ‰øùÊâÄÊúâÂÖ∂‰ªñÊ®°ÊÄÅÊ°ÜÂú®ÊäΩÂ±â‰∏ãÊñπ */
        .modal:not(#homeOperationDrawer) {
            z-index: 1000 !important;
        }
        
        /* ÁâπÂÆöÂÖÉÁ¥†Â±ÇÁ∫ßË¶ÜÁõñ */
        .modal-content,
        .price-card,
        .chart-container,
        .info-card,
        .glass {
            z-index: 1 !important;
        }
    </style>
    
        </div>
    </div>
    
    <!-- Êù°‰ª∂ÂºÄÂÖ≥ÂäüËÉΩ -->
    <script>
        
        // Ê®°ÊãüÂú∞Âå∫Êï∞ÊçÆ - Êâ©Â±ïÂÖ®Â±ÄregionDataÂØπË±°
        Object.assign(regionData, {
            'NSW': {
                status: 'none',
                chargeTime: '08:00-09:00',
                dischargeTime: '18:00-22:00',
                chargePrice: '60$',
                dischargePrice: '120$',
                chargeSoc: '70%',
                dischargeSoc: '30%'
            },
            'QLD': {
                status: 'autoCharge',
                chargeTime: '07:00-11:00',
                dischargeTime: '17:00-21:00',
                chargePrice: '45$',
                dischargePrice: '110$',
                chargeSoc: '75%',
                dischargeSoc: '25%'
            },
            'VIC': {
                status: 'manualCharge',
                chargeTime: '06:00-10:00',
                dischargeTime: '19:00-23:00',
                chargePrice: '55$',
                dischargePrice: '130$',
                chargeSoc: '80%',
                dischargeSoc: '20%'
            },
            'SA': {
                status: 'autoDischarge',
                chargeTime: '09:00-13:00',
                dischargeTime: '16:00-20:00',
                chargePrice: '50$',
                dischargePrice: '125$',
                chargeSoc: '85%',
                dischargeSoc: '15%'
            },
            'TAS': {
                status: 'manualDischarge',
                chargeTime: '10:00-14:00',
                dischargeTime: '15:00-19:00',
                chargePrice: '40$',
                dischargePrice: '100$',
                chargeSoc: '90%',
                dischargeSoc: '10%'
            }
        });
        
        // Áä∂ÊÄÅÊñáÊú¨Êò†Â∞Ñ
        const statusText = {
            'none': { 'zh': '', 'en': '' },
            'autoCharge': { 'zh': 'Êô∫ËÉΩÂÖÖÁîµ', 'en': 'AI Charge' },
            'autoDischarge': { 'zh': 'Êô∫ËÉΩÊîæÁîµ', 'en': 'AI Discharge' },
            'manualCharge': { 'zh': 'ÊâãÂä®ÂÖÖÁîµ', 'en': 'Manual Charge' },
            'manualDischarge': { 'zh': 'ÊâãÂä®ÊîæÁîµ', 'en': 'Manual Discharge' }
        };
        
        // ÂΩìÂâçÊù°‰ª∂ËßÜÂõæÁä∂ÊÄÅ
        let currentConditionView = 'default';
        
        // ÊòæÁ§∫Ëá™Âä®Êù°‰ª∂
        function showAutoCondition() {
            const autoBtn = document.getElementById('autoConditionBtn');
            const regionOverviewCard = document.getElementById('regionOverviewCard');
            
            if (regionOverviewCard) {
                if (regionOverviewCard.style.display === 'none' || !regionOverviewCard.style.display) {
                    // ÊòæÁ§∫Âç°Áâá
                    regionOverviewCard.style.display = 'block';
                    // Êõ¥Êñ∞ÊåâÈíÆ‰∏∫ÈÄâ‰∏≠Áä∂ÊÄÅ - ‰ΩøÁî®Ê∑±Ëâ≤‰∏ªÈ¢òÈ£éÊ†º
                    autoBtn.style.background = 'rgba(0, 255, 136, 0.15)';
                    autoBtn.style.color = '#00ff88';
                    autoBtn.style.border = '2px solid rgba(0, 255, 136, 0.3)';
                    autoBtn.style.boxShadow = '0 0 0 4px rgba(0, 255, 136, 0.1)';
                    autoBtn.style.fontWeight = '700';
                    autoBtn.style.transform = 'scale(1)';
                    autoBtn.classList.add('selected');
                    // Â¶ÇÊûúÊòØÁº©Â∞èÁä∂ÊÄÅÔºåÂ±ïÂºÄÂÆÉ
                    if (regionOverviewCardMinimized) {
                        toggleRegionOverviewCardExpansion();
                    }
                } else {
                    // ÈöêËóèÂç°Áâá
                    regionOverviewCard.style.display = 'none';
                    // ÊÅ¢Â§çÊåâÈíÆ‰∏∫Êú™ÈÄâ‰∏≠Áä∂ÊÄÅ
                    autoBtn.style.background = 'rgba(255, 255, 255, 0.08)';
                    autoBtn.style.color = 'rgba(255, 255, 255, 0.8)';
                    autoBtn.style.border = '1px solid rgba(255, 255, 255, 0.1)';
                    autoBtn.style.boxShadow = 'none';
                    autoBtn.style.fontWeight = '600';
                    autoBtn.style.transform = 'scale(1)';
                    autoBtn.classList.remove('selected');
                }
            }
        }
        
        // ÊòæÁ§∫ÂÖÖÁîµÊù°‰ª∂
        function showChargeCondition() {
            const chargeBtn = document.getElementById('chargeConditionBtn');
            const dischargeBtn = document.getElementById('dischargeConditionBtn');
            const defaultContainer = document.querySelector('.region-selection-tabs');
            const conditionContainer = document.getElementById('conditionRegionContainer');
            const selectorContainer = document.getElementById('regionSelectorContainer');
            
            if (currentConditionView === 'charge') {
                // ÂèñÊ∂àÂÖÖÁîµÊù°‰ª∂ËßÜÂõæ
                currentConditionView = 'default';
                chargeBtn.style.background = 'rgba(255,255,255,0.08)';
                chargeBtn.style.color = 'var(--color-text-secondary)';
                // ÊòæÁ§∫ÈªòËÆ§Âú∞Âå∫ÈÄâÊã©ÔºåÈöêËóèÊù°‰ª∂Âú∞Âå∫ÈÄâÊã©
                defaultContainer.style.display = 'flex';
                conditionContainer.style.display = 'none';
                // ÊÅ¢Â§çÈªòËÆ§È´òÂ∫¶
                selectorContainer.style.minHeight = '80px';
                // Á°Æ‰øùÈÄâ‰∏≠ÁöÑÂú∞Âå∫‰øùÊåÅactiveÁä∂ÊÄÅ
                const activeTab = document.querySelector(`.region-select-tab[data-region="${selectedMainRegion}"]`);
                if (activeTab && !activeTab.classList.contains('active')) {
                    selectMainRegion(selectedMainRegion, activeTab);
                }
            } else {
                // ÊòæÁ§∫ÂÖÖÁîµÊù°‰ª∂ËßÜÂõæ
                currentConditionView = 'charge';
                chargeBtn.style.background = '#4CD964';
                chargeBtn.style.color = '#000';
                // ÈáçÁΩÆÊîæÁîµÊåâÈíÆ
                dischargeBtn.style.background = 'rgba(255,255,255,0.08)';
                dischargeBtn.style.color = 'var(--color-text-secondary)';
                // ÈöêËóèÈªòËÆ§Âú∞Âå∫ÈÄâÊã©ÔºåÊòæÁ§∫Êù°‰ª∂Âú∞Âå∫ÈÄâÊã©
                defaultContainer.style.display = 'none';
                conditionContainer.style.display = 'flex';
                createConditionRegions('charge');
                // Ë∞ÉÊï¥ÂÆπÂô®È´òÂ∫¶‰ª•ÈÄÇÂ∫îÊù°‰ª∂ËßÜÂõæ
                selectorContainer.style.minHeight = '140px';
                // Êõ¥Êñ∞ÂÜÖÂÆπÂå∫ÂüüÊòæÁ§∫ÂΩìÂâçÈÄâ‰∏≠Âú∞Âå∫ÁöÑÊï∞ÊçÆ
                updatePriceCircleRegion(selectedMainRegion);
            }
            
            // Âª∂ËøüË∞ÉÊï¥Èó¥Ë∑ùÔºåÁ≠âÂæÖÈ´òÂ∫¶Âä®ÁîªÂÆåÊàê
            setTimeout(() => {
                adjustSpacingForRegionSelector();
            }, 160);
        }
        
        // ÊòæÁ§∫ÊîæÁîµÊù°‰ª∂
        function showDischargeCondition() {
            const chargeBtn = document.getElementById('chargeConditionBtn');
            const dischargeBtn = document.getElementById('dischargeConditionBtn');
            const defaultContainer = document.querySelector('.region-selection-tabs');
            const conditionContainer = document.getElementById('conditionRegionContainer');
            const selectorContainer = document.getElementById('regionSelectorContainer');
            
            if (currentConditionView === 'discharge') {
                // ÂèñÊ∂àÊîæÁîµÊù°‰ª∂ËßÜÂõæ
                currentConditionView = 'default';
                dischargeBtn.style.background = 'rgba(255,255,255,0.08)';
                dischargeBtn.style.color = 'var(--color-text-secondary)';
                // ÊòæÁ§∫ÈªòËÆ§Âú∞Âå∫ÈÄâÊã©ÔºåÈöêËóèÊù°‰ª∂Âú∞Âå∫ÈÄâÊã©
                defaultContainer.style.display = 'flex';
                conditionContainer.style.display = 'none';
                // ÊÅ¢Â§çÈªòËÆ§È´òÂ∫¶
                selectorContainer.style.minHeight = '80px';
                // Á°Æ‰øùÈÄâ‰∏≠ÁöÑÂú∞Âå∫‰øùÊåÅactiveÁä∂ÊÄÅ
                const activeTab = document.querySelector(`.region-select-tab[data-region="${selectedMainRegion}"]`);
                if (activeTab && !activeTab.classList.contains('active')) {
                    selectMainRegion(selectedMainRegion, activeTab);
                }
            } else {
                // ÊòæÁ§∫ÊîæÁîµÊù°‰ª∂ËßÜÂõæ
                currentConditionView = 'discharge';
                dischargeBtn.style.background = '#FFC107';
                dischargeBtn.style.color = '#000';
                // ÈáçÁΩÆÂÖÖÁîµÊåâÈíÆ
                chargeBtn.style.background = 'rgba(255,255,255,0.08)';
                chargeBtn.style.color = 'var(--color-text-secondary)';
                // ÈöêËóèÈªòËÆ§Âú∞Âå∫ÈÄâÊã©ÔºåÊòæÁ§∫Êù°‰ª∂Âú∞Âå∫ÈÄâÊã©
                defaultContainer.style.display = 'none';
                conditionContainer.style.display = 'flex';
                createConditionRegions('discharge');
                // Ë∞ÉÊï¥ÂÆπÂô®È´òÂ∫¶‰ª•ÈÄÇÂ∫îÊù°‰ª∂ËßÜÂõæ
                selectorContainer.style.minHeight = '140px';
                // Êõ¥Êñ∞ÂÜÖÂÆπÂå∫ÂüüÊòæÁ§∫ÂΩìÂâçÈÄâ‰∏≠Âú∞Âå∫ÁöÑÊï∞ÊçÆ
                updatePriceCircleRegion(selectedMainRegion);
            }
            
            // Âª∂ËøüË∞ÉÊï¥Èó¥Ë∑ùÔºåÁ≠âÂæÖÈ´òÂ∫¶Âä®ÁîªÂÆåÊàê
            setTimeout(() => {
                adjustSpacingForRegionSelector();
            }, 160);
        }
        
        // ÂàõÂª∫Êù°‰ª∂Âú∞Âå∫ÊåâÈíÆ
        function createConditionRegions(type) {
            const container = document.getElementById('conditionRegionContainer');
            const regions = ['NSW', 'QLD', 'VIC', 'SA', 'TAS'];
            
            container.innerHTML = '';
            container.style.display = 'flex';
            
            regions.forEach((region, index) => {
                const timeText = window.i18n ? window.i18n.getText('timeCondition') : 'Êó∂Èó¥Êù°‰ª∂';
                const priceText = window.i18n ? window.i18n.getText('priceCondition') : '‰ª∑Ê†ºÊù°‰ª∂';
                const chargeStopSOCText = window.i18n ? window.i18n.getText('chargeStopSOC') : 'ÂÖÖÁîµÂÅúÊ≠¢SOC';
                const dischargeStopSOCText = window.i18n ? window.i18n.getText('dischargeStopSOC') : 'ÊîæÁîµÂÅúÊ≠¢SOC';
                
                const bgColor = type === 'charge' ? '#4CD964' : 
                               type === 'discharge' ? '#FFC107' : 
                               'linear-gradient(135deg, #00ff88, #00dd77)';
                
                // Ê£ÄÊü•ÊòØÂê¶ÊòØÂΩìÂâçÈÄâ‰∏≠ÁöÑÂú∞Âå∫Ôºà‰∏é‰∏ªÂú∞Âå∫ÈÄâÊã©‰øùÊåÅ‰∏ÄËá¥Ôºâ
                const isSelected = region === selectedMainRegion;
                
                const button = document.createElement('button');
                button.className = 'condition-region-btn';
                button.dataset.region = region;
                
                // Ê†πÊçÆtypeË∞ÉÊï¥ÊåâÈíÆÈ´òÂ∫¶
                const minHeight = type === 'auto' ? '160px' : '100px';
                
                button.style.cssText = `
                    padding: 14px 16px;
                    background: ${isSelected ? bgColor : 'transparent'};
                    color: ${isSelected ? '#000' : 'var(--color-text-secondary)'};
                    border: ${isSelected ? '2px solid #000' : '1px solid var(--color-border)'};
                    border-radius: 50px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.3s;
                    display: flex;
                    align-items: flex-start;
                    justify-content: flex-start;
                    flex: 1;
                    min-height: ${minHeight};
                    flex-direction: column;
                    gap: 4px;
                `;
                
                // Ëé∑ÂèñËØ•Âú∞Âå∫ÁöÑÁä∂ÊÄÅ
                const status = regionData[region].status;
                let statusBadgeHTML = '';
                
                if (status !== 'none') {
                    const statusTextMap = {
                        'autoCharge': window.i18n ? window.i18n.getText('autoCharge') : 'Êô∫ËÉΩÂÖÖÁîµ',
                        'manualCharge': window.i18n ? window.i18n.getText('manualCharge') : 'ÊâãÂä®ÂÖÖÁîµ',
                        'autoDischarge': window.i18n ? window.i18n.getText('autoDischarge') : 'Êô∫ËÉΩÊîæÁîµ',
                        'manualDischarge': window.i18n ? window.i18n.getText('manualDischarge') : 'ÊâãÂä®ÊîæÁîµ'
                    };
                    const statusText = statusTextMap[status] || status;
                    
                    // ‰∏∫ÈÄâ‰∏≠Áä∂ÊÄÅ‰ºòÂåñÊ†∑ÂºèÔºåÁ°Æ‰øùÂú®ÂΩ©Ëâ≤ËÉåÊôØ‰∏äÁöÑÂèØËØªÊÄß
                    if (isSelected) {
                        const borderStyle = (status === 'autoCharge' || status === 'autoDischarge') ? 'dashed' : 'solid';
                        statusBadgeHTML = `<span style="background: rgba(0,0,0,0.3); color: #000; padding: 6px 12px; border-radius: 16px; font-size: 13px; font-weight: 700; border: 1px ${borderStyle} #000;">${statusText}</span>`;
                    } else {
                        const statusStyle = getStatusStyle(status, false);
                        statusBadgeHTML = `<span style="${statusStyle.cssText}">${statusText}</span>`;
                    }
                }
                
                // Ê†πÊçÆtypeÁîüÊàê‰∏çÂêåÁöÑÂÜÖÂÆπ
                if (type === 'auto') {
                    button.innerHTML = `
                        <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 8px; width: 100%; padding: 0 8px;">
                            <div style="display: flex; align-items: center; gap: 8px; width: 100%;">
                                <span style="font-size: 14px; font-weight: 600;">${region}</span>
                                ${statusBadgeHTML}
                            </div>
                            <div style="font-size: 11px; opacity: 0.9; text-align: left; line-height: 1.6; display: flex; flex-direction: column; gap: 6px;">
                                <div style="color: #4CD964; font-weight: 600;">ÂÖÖÁîµÊù°‰ª∂</div>
                                <div style="padding-left: 8px;">
                                    <div>${timeText}: ${regionData[region].chargeTime}</div>
                                    <div>${priceText}: ${regionData[region].chargePrice}</div>
                                    <div>${chargeStopSOCText}: ${regionData[region].chargeSoc}</div>
                                </div>
                                <div style="color: #FFC107; font-weight: 600;">ÊîæÁîµÊù°‰ª∂</div>
                                <div style="padding-left: 8px;">
                                    <div>${timeText}: ${regionData[region].dischargeTime}</div>
                                    <div>${priceText}: ${regionData[region].dischargePrice}</div>
                                    <div>${dischargeStopSOCText}: ${regionData[region].dischargeSoc}</div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    const stopSOCText = type === 'charge' ? chargeStopSOCText : dischargeStopSOCText;
                    button.innerHTML = `
                        <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 6px; width: 100%; padding: 0 8px;">
                            <div style="display: flex; align-items: center; gap: 8px; width: 100%;">
                                <span style="font-size: 14px; font-weight: 600;">${region}</span>
                                ${statusBadgeHTML}
                            </div>
                            <div style="font-size: 11px; opacity: 0.9; text-align: left; line-height: 1.6; display: flex; flex-direction: column; gap: 4px;">
                                <div>${timeText}: ${type === 'charge' ? regionData[region].chargeTime : regionData[region].dischargeTime}</div>
                                <div>${priceText}: ${type === 'charge' ? regionData[region].chargePrice : regionData[region].dischargePrice}</div>
                                <div>${stopSOCText}: ${type === 'charge' ? regionData[region].chargeSoc : regionData[region].dischargeSoc}</div>
                            </div>
                        </div>
                    `;
                }
                
                button.onclick = function() {
                    selectConditionRegion(region, this, type);
                };
                
                container.appendChild(button);
            });
        }
        
        // ÈÄâÊã©Êù°‰ª∂Âú∞Âå∫
        function selectConditionRegion(region, button, type) {
            // Êõ¥Êñ∞selectedMainRegion‰ª•‰øùÊåÅ‰∏é‰∏ªÂú∞Âå∫ÈÄâÊã©ÂêåÊ≠•
            selectedMainRegion = region;
            
            // ÈáçÊñ∞ÂàõÂª∫Êù°‰ª∂Âú∞Âå∫ÊåâÈíÆ‰ª•ÂèçÊò†Êñ∞ÁöÑÈÄâ‰∏≠Áä∂ÊÄÅ
            createConditionRegions(type);
            
            // Ëé∑ÂèñËØ•Âú∞Âå∫ÁöÑÁä∂ÊÄÅ
            const regionStatus = regionData[region].status;
            
            // Êõ¥Êñ∞ÁîµÁ´ôÁÆ°ÁêÜÁä∂ÊÄÅ
            updatePowerStationStatus(region, regionStatus);

            // Êõ¥Êñ∞Áõ∏ÂÖ≥ÊòæÁ§∫
            updatePriceCircleRegion(region);

            // Êõ¥Êñ∞È°µÈù¢Êï∞ÊçÆ - ËøôÊòØÂÖ≥ÈîÆÁöÑÁº∫Â§±ÈÉ®ÂàÜ
            updatePageDataByRegion(region);
            
            // Êõ¥Êñ∞Âú∞Âå∫ÊòæÁ§∫
            updateRegionDisplay();
            
            // Ë∞ÉÊï¥Èó¥Ë∑ù
            // Âª∂ËøüË∞ÉÊï¥Èó¥Ë∑ùÔºåÁ≠âÂæÖÈ´òÂ∫¶Âä®ÁîªÂÆåÊàê
            setTimeout(() => {
                adjustSpacingForRegionSelector();
            }, 160);
        }
        
        // Êõ¥Êñ∞Âú∞Âå∫ÊòæÁ§∫
        function updateRegionDisplay() {
            const regions = ['NSW', 'QLD', 'VIC', 'SA', 'TAS'];
            const currentLang = getCurrentLanguage() || 'zh';
            
            
            regions.forEach(region => {
                const regionButton = document.querySelector(`[data-region="${region}"]`);
                if (!regionButton) {
                    return;
                }
                
                // ÈáçÊñ∞Ëé∑ÂèñspanÂÖÉÁ¥†ÔºåÂõ†‰∏∫innerHTMLÂèØËÉΩÊîπÂèò‰∫ÜDOMÁªìÊûÑ
                let regionSpan = regionButton.querySelector('span:first-child');
                let statusBadge = regionButton.querySelector('.region-status-badge');
                
                if (!regionSpan || !statusBadge) {
                    return;
                }
                
                // ÈªòËÆ§Áä∂ÊÄÅÔºöÂè™ÊòæÁ§∫Âú∞Âå∫ÂêçÁß∞ÂíåÁä∂ÊÄÅ
                regionSpan.textContent = region;
                
                // Á°Æ‰øùÂú∞Âå∫ÂêçÁß∞ÊúâÊ≠£Á°ÆÁöÑÈ¢úËâ≤
                const isActive = regionButton.classList.contains('active');
                if (isActive) {
                    regionSpan.style.color = '#000'; // ÈÄâ‰∏≠ÁöÑÂú∞Âå∫Áî®ÈªëËâ≤ÊñáÂ≠óÔºàÂú®‰∫ÆÁªøËâ≤ËÉåÊôØ‰∏äÔºâ
                    regionSpan.style.fontWeight = '700';
                } else {
                    regionSpan.style.color = 'var(--color-text-secondary)'; // Êú™ÈÄâ‰∏≠ÁöÑÂú∞Âå∫Áî®Ê¨°Ë¶ÅÊñáÂ≠óÈ¢úËâ≤
                    regionSpan.style.fontWeight = '500';
                }
                
                // Êõ¥Êñ∞data-statusÂ±ûÊÄß
                statusBadge.setAttribute('data-status', regionData[region].status);
                
                // Ê†πÊçÆÂú∞Âå∫Áä∂ÊÄÅÂÜ≥ÂÆöÊòØÂê¶ÊòæÁ§∫Áä∂ÊÄÅÊ†áËÆ∞
                const status = regionData[region].status;
                if (status === 'none') {
                    statusBadge.style.display = 'none';
                    statusBadge.innerHTML = '';
                } else {
                    // Ëé∑ÂèñÁä∂ÊÄÅÊ†∑Âºè
                    const statusStyle = getStatusStyle(status, isActive);
                    statusBadge.style.cssText = statusStyle.cssText;
                    statusBadge.innerHTML = statusStyle.text;
                    statusBadge.style.display = 'inline-block';
                }
            });
            
            // Ë∞ÉÊï¥Èó¥Ë∑ù
            setTimeout(adjustSpacingForRegionSelector, 100);
        }
        
        // Ëé∑ÂèñÁä∂ÊÄÅÊ†áËÆ∞Ê†∑Âºè
        function getStatusStyle(status, isActive) {
            if (status === 'none') return { cssText: '', text: '' };
            
            const statusTextMap = {
                'autoCharge': window.i18n ? window.i18n.getText('autoCharge') : 'Êô∫ËÉΩÂÖÖÁîµ',
                'manualCharge': window.i18n ? window.i18n.getText('manualCharge') : 'ÊâãÂä®ÂÖÖÁîµ',
                'autoDischarge': window.i18n ? window.i18n.getText('autoDischarge') : 'Êô∫ËÉΩÊîæÁîµ',
                'manualDischarge': window.i18n ? window.i18n.getText('manualDischarge') : 'ÊâãÂä®ÊîæÁîµ'
            };
            
            const statusColors = {
                'autoCharge': { bg: 'rgba(76, 217, 100, 0.2)', color: '#4CD964', border: '#4CD964', borderStyle: 'dashed' },
                'manualCharge': { bg: 'rgba(76, 217, 100, 0.2)', color: '#4CD964', border: '#4CD964', borderStyle: 'solid' },
                'autoDischarge': { bg: 'rgba(255, 193, 7, 0.2)', color: '#FFC107', border: '#FFC107', borderStyle: 'dashed' },
                'manualDischarge': { bg: 'rgba(255, 193, 7, 0.2)', color: '#FFC107', border: '#FFC107', borderStyle: 'solid' }
            };
            
            const style = statusColors[status];
            const text = statusTextMap[status];
            if (!style || !text) return { cssText: '', text: '' };
            
            // Â¶ÇÊûúÊòØÈÄâ‰∏≠Áä∂ÊÄÅÔºå‰ΩøÁî®ÈªëËâ≤ÊñáÂ≠óÂíåËæπÊ°Ü
            const textColor = isActive ? '#000' : style.color;
            const borderColor = isActive ? '#000' : style.border;
            
            const cssText = `background: ${style.bg}; color: ${textColor}; padding: 6px 12px; border-radius: 16px; font-size: 13px; font-weight: 700; border: 1px ${style.borderStyle} ${borderColor};`;
            
            return { cssText, text };
        }
        
        
        // Âä®ÊÄÅË∞ÉÊï¥Èó¥Ë∑ù‰ª•ÈÄÇÂ∫îÂú∞Âå∫ÈÄâÊã©Ê†èÈ´òÂ∫¶ÂèòÂåñ
        function adjustSpacingForRegionSelector() {
            const regionSelector = document.querySelector('.region-selector-fixed');
            const mainContent = document.querySelector('.main-content-scrollable');
            const regionSelectorContainer = document.getElementById('regionSelectorContainer');
            
            if (regionSelector && mainContent && regionSelectorContainer) {
                // Ëé∑ÂèñregionSelectorContainerÁöÑÂÆûÈôÖÈ´òÂ∫¶ÔºàËøôÊòØÂåÖÂê´ÂÜÖÂÆπÁöÑÂÆπÂô®Ôºâ
                const containerRect = regionSelectorContainer.getBoundingClientRect();
                const containerHeight = containerRect.height;
                
                // Ëé∑Âèñregion-selector-fixedÁöÑpadding
                const selectorStyles = window.getComputedStyle(regionSelector);
                const paddingTop = parseFloat(selectorStyles.paddingTop) || 0;
                const paddingBottom = parseFloat(selectorStyles.paddingBottom) || 0;
                
                // ËÆ°ÁÆóÊÄªÈ´òÂ∫¶
                const totalHeight = containerHeight + paddingTop + paddingBottom;
                
                // Âü∫Á°ÄtopÂÄº(100px) + ÈÄâÊã©Âô®ÊÄªÈ´òÂ∫¶ + È¢ùÂ§ñÈó¥Ë∑ù
                const extraSpacing = currentConditionView !== 'default' ? 30 : 20;
                const newMarginTop = 100 + totalHeight + extraSpacing;
                
                // ËÆæÁΩÆÊñ∞ÁöÑmargin-top
                mainContent.style.marginTop = newMarginTop + 'px';
                
            }
        }
        
        // Ê∑ªÂä†ResizeObserverÁõëÂê¨Âú∞Âå∫ÈÄâÊã©Âô®È´òÂ∫¶ÂèòÂåñ
        let regionSelectorObserver;
        
        function initRegionSelectorObserver() {
            const regionSelectorContainer = document.getElementById('regionSelectorContainer');
            if (regionSelectorContainer && !regionSelectorObserver) {
                regionSelectorObserver = new ResizeObserver(entries => {
                    for (const entry of entries) {
                        // ‰ΩøÁî®requestAnimationFrameÁ°Æ‰øùÂú®DOMÊõ¥Êñ∞ÂêéË∞ÉÊï¥Èó¥Ë∑ù
                        requestAnimationFrame(() => {
                            adjustSpacingForRegionSelector();
                        });
                    }
                });
                regionSelectorObserver.observe(regionSelectorContainer);
            }
        }
        
        // Ê∏ÖÁêÜResizeObserver
        function cleanupRegionSelectorObserver() {
            if (regionSelectorObserver) {
                regionSelectorObserver.disconnect();
                regionSelectorObserver = null;
            }
        }
        
        // Êõ¥Êñ∞Âú∞Âå∫Áä∂ÊÄÅÊòæÁ§∫
        function updateRegionStatusDisplay() {
            const regions = ['NSW', 'QLD', 'VIC', 'SA', 'TAS'];
            const currentLang = getCurrentLanguage() || 'zh';
            
            regions.forEach(region => {
                const regionButton = document.querySelector(`[data-region="${region}"]`);
                if (!regionButton) {
                    return;
                }
                
                const statusBadge = regionButton.querySelector('.region-status-badge');
                if (!statusBadge) {
                    return;
                }
                
                const status = regionData[region].status;
                
                // ‰ΩøÁî®i18nÁ≥ªÁªüËé∑ÂèñÁä∂ÊÄÅÊñáÊú¨
                let statusDisplay = '';
                if (status !== 'none') {
                    const statusTextMap = {
                        'autoCharge': window.i18n ? window.i18n.getText('autoCharge') : 'Êô∫ËÉΩÂÖÖÁîµ‰∏≠',
                        'manualCharge': window.i18n ? window.i18n.getText('manualCharge') : 'ÊâãÂä®ÂÖÖÁîµ‰∏≠',
                        'autoDischarge': window.i18n ? window.i18n.getText('autoDischarge') : 'Êô∫ËÉΩÊîæÁîµ‰∏≠',
                        'manualDischarge': window.i18n ? window.i18n.getText('manualDischarge') : 'ÊâãÂä®ÊîæÁîµ‰∏≠',
                        'waitingExecution': window.i18n ? window.i18n.getText('waitingExecution') : 'Á≠âÂæÖÊâßË°å‰∏≠'
                    };
                    statusDisplay = statusTextMap[status] || status;
                } else {
                    // ÂØπ‰∫éÊâÄÊúâÂú∞Âå∫ÔºåÂ¶ÇÊûúÊòØËá™Âä®Ê®°ÂºèÔºåÊòæÁ§∫"Á≠âÂæÖÊâßË°å‰∏≠"
                    if (currentOperationMode === 'auto') {
                        statusDisplay = window.i18n ? window.i18n.getText('waitingExecution') : 'Á≠âÂæÖÊâßË°å‰∏≠';
                    }
                }
                
                // ÁâπÊÆäÂ§ÑÁêÜNSWÔºöÂ¶ÇÊûúÂÖ∂Áä∂ÊÄÅ‰∏∫waitingExecutionÔºåÁ°Æ‰øùÊòæÁ§∫ÊñáÂ≠ó
                if (region === 'NSW' && status === 'waitingExecution') {
                    statusDisplay = window.i18n ? window.i18n.getText('waitingExecution') : 'Á≠âÂæÖÊâßË°å‰∏≠';
                }
                
                // Êõ¥Êñ∞Áä∂ÊÄÅÊñáÊú¨
                statusBadge.textContent = statusDisplay;
                
                // Ê†πÊçÆÊòæÁ§∫Áä∂ÊÄÅËÆæÁΩÆdata-statusÂ±ûÊÄß
                if (statusDisplay && currentOperationMode === 'auto' && status === 'none') {
                    statusBadge.setAttribute('data-status', 'waitingExecution');
                } else {
                    statusBadge.setAttribute('data-status', status);
                }
                
                // Ê†πÊçÆÁä∂ÊÄÅËÆæÁΩÆÈ¢úËâ≤ÂíåËæπÊ°ÜÊ†∑Âºè
                const statusColors = {
                    'none': { bg: 'transparent', color: 'transparent', border: 'transparent', borderStyle: 'none' },
                    'autoCharge': { bg: 'rgba(76, 217, 100, 0.2)', color: '#4CD964', border: '#4CD964', borderStyle: 'dashed' },
                    'manualCharge': { bg: 'rgba(76, 217, 100, 0.2)', color: '#4CD964', border: '#4CD964', borderStyle: 'solid' },
                    'autoDischarge': { bg: 'rgba(255, 193, 7, 0.2)', color: '#FFC107', border: '#FFC107', borderStyle: 'dashed' },
                    'manualDischarge': { bg: 'rgba(255, 193, 7, 0.2)', color: '#FFC107', border: '#FFC107', borderStyle: 'solid' },
                    'waitingExecution': { bg: 'rgba(30, 127, 255, 0.2)', color: '#1E7FFF', border: '#1E7FFF', borderStyle: 'dashed' }
                };
                
                // Ëé∑ÂèñÂÆûÈôÖÁöÑÊòæÁ§∫Áä∂ÊÄÅ
                let displayStatus = status;
                if (statusDisplay && currentOperationMode === 'auto' && status === 'none') {
                    displayStatus = 'waitingExecution';
                }
                
                let colorScheme = statusColors[displayStatus];
                let shouldDisplay = displayStatus !== 'none';
                
                // Á°Æ‰øùwaitingExecutionÁä∂ÊÄÅË¢´Ê≠£Á°ÆÊòæÁ§∫
                if (displayStatus === 'waitingExecution') {
                    shouldDisplay = true;
                }
                
                if (colorScheme) {
                    statusBadge.style.background = colorScheme.bg;
                    statusBadge.style.color = colorScheme.color;
                    statusBadge.style.borderColor = colorScheme.border;
                    statusBadge.style.borderStyle = colorScheme.borderStyle;
                    statusBadge.style.borderWidth = shouldDisplay ? '1px' : '0';
                    statusBadge.style.display = shouldDisplay ? 'inline-block' : 'none';
                    statusBadge.style.fontSize = '13px';
                    statusBadge.style.fontWeight = '700';
                    statusBadge.style.padding = '6px 12px';
                }
            });
            
            // ÊØèÊ¨°Êõ¥Êñ∞ÊòæÁ§∫ÂêéË∞ÉÊï¥Èó¥Ë∑ù
            setTimeout(adjustSpacingForRegionSelector, 100);
            
            // Êõ¥Êñ∞Â§ßÂúÜÂÜÖÁöÑÁä∂ÊÄÅÊòæÁ§∫
            updateCircleStatusDisplay();
        }
        
        // Êõ¥Êñ∞Â§ßÂúÜÂÜÖÁöÑÁä∂ÊÄÅÊòæÁ§∫
        function updateCircleStatusDisplay() {
            const priceDisplay = document.getElementById('priceDisplay');
            const statusDisplay = document.getElementById('statusDisplay');
            const statusTextElement = document.getElementById('statusText');
            
            if (!priceDisplay || !statusDisplay || !statusTextElement) return;
            
            const selectedRegion = selectedMainRegion;
            if (!selectedRegion) return;
            
            const regionStatus = regionData[selectedRegion] ? regionData[selectedRegion].status : 'none';
            const data = regionData[selectedRegion];
            
            
            // ÊÄªÊòØÊòæÁ§∫‰ª∑Ê†ºÔºåÈöêËóèÂçïÁã¨ÁöÑÁä∂ÊÄÅÊòæÁ§∫
            priceDisplay.style.display = 'block';
            priceDisplay.style.opacity = '1';
            statusDisplay.style.display = 'none';
            statusDisplay.style.opacity = '0';
            
            // Êõ¥Êñ∞‰ª∑Ê†ºÊòæÁ§∫‰∏≠ÁöÑÁä∂ÊÄÅÊ†áÁ≠æÔºåÊ†πÊçÆÂú∞Âå∫ÁöÑÂÆûÈôÖÁä∂ÊÄÅ
            const stationStatusLabel = document.getElementById('stationStatusLabel');
            if (stationStatusLabel) {
                let statusText = '';
                
                if (regionStatus === 'autoCharge') {
                    statusText = window.i18n ? window.i18n.getText('autoCharge') : 'Êô∫ËÉΩÂÖÖÁîµ‰∏≠';
                } else if (regionStatus === 'autoDischarge') {
                    statusText = window.i18n ? window.i18n.getText('autoDischarge') : 'Êô∫ËÉΩÊîæÁîµ‰∏≠';
                } else if (regionStatus === 'manualCharge') {
                    statusText = window.i18n ? window.i18n.getText('manualCharge') : 'ÊâãÂä®ÂÖÖÁîµ‰∏≠';
                } else if (regionStatus === 'manualDischarge') {
                    statusText = window.i18n ? window.i18n.getText('manualDischarge') : 'ÊâãÂä®ÊîæÁîµ‰∏≠';
                } else if (regionStatus === 'waitingExecution') {
                    statusText = window.i18n ? window.i18n.getText('waitingExecution') : 'Á≠âÂæÖÊâßË°å‰∏≠';
                } else {
                    // Êó†Áä∂ÊÄÅÊó∂Ê†πÊçÆÂΩìÂâçÊ®°ÂºèÊòæÁ§∫
                    if (currentOperationMode === 'auto') {
                        statusText = window.i18n ? window.i18n.getText('waitingExecution') : 'Á≠âÂæÖÊâßË°å‰∏≠';
                    } else {
                        statusText = window.i18n ? window.i18n.getText('manualMode') : 'ÊâãÂä®Ê®°Âºè';
                    }
                }
                
                stationStatusLabel.textContent = statusText;
                stationStatusLabel.style.color = 'rgba(255,255,255,0.9)';
            }
            
            // Êõ¥Êñ∞Ëá™Âä®ÂºÄÂÖ≥ÁöÑÁ¶ÅÁî®Áä∂ÊÄÅ
            updateAutoSwitchDisabledState();
        }
        
        // Êõ¥Êñ∞Ëá™Âä®ÂºÄÂÖ≥ÁöÑÁ¶ÅÁî®Áä∂ÊÄÅ
        function updateAutoSwitchDisabledState() {
            const operationStatus = getRegionOperationStatus(selectedMainRegion);
            const isOperationActive = operationStatus === 'charging' || operationStatus === 'discharging';
            const toggleSwitch = document.querySelector('.auto-toggle-switch');
            
            if (!toggleSwitch) return;
            
            if (isOperationActive) {
                // Á¶ÅÁî®Áä∂ÊÄÅÔºöÈôç‰ΩéÈÄèÊòéÂ∫¶ÔºåÊ∑ªÂä†Á¶ÅÁî®ÂÖâÊ†á
                toggleSwitch.style.opacity = '0.5';
                toggleSwitch.style.cursor = 'not-allowed';
                toggleSwitch.style.pointerEvents = 'auto'; // ‰øùÊåÅÂèØÁÇπÂáª‰ª•ÊòæÁ§∫ÊèêÁ§∫
            } else {
                // ÂêØÁî®Áä∂ÊÄÅÔºöÊÅ¢Â§çÊ≠£Â∏∏Â§ñËßÇ
                toggleSwitch.style.opacity = '1';
                toggleSwitch.style.cursor = 'pointer';
                toggleSwitch.style.pointerEvents = 'auto';
            }
        }
        
        // Ëé∑ÂèñÂΩìÂâçËØ≠Ë®Ä
        function getCurrentLanguage() {
            // ‰ºòÂÖà‰ªéi18nÁ≥ªÁªüËé∑ÂèñÂΩìÂâçËØ≠Ë®Ä
            if (window.i18n && typeof window.i18n.getCurrentLanguage === 'function') {
                return window.i18n.getCurrentLanguage();
            }
            // ÈôçÁ∫ßÊñπÊ°àÔºö‰ªéHTMLÂ±ûÊÄßËé∑Âèñ
            return document.documentElement.getAttribute('data-language') || 
                   document.documentElement.lang === 'zh-CN' ? 'zh' : 'en';
        }
        
        // ÂàùÂßãÂåñÊòæÁ§∫
        document.addEventListener('DOMContentLoaded', function() {
            updateRegionDisplay();
            // ÂàùÂßãÂåñÂúÜÂΩ¢Áä∂ÊÄÅÊòæÁ§∫
            updateCircleStatusDisplay();
            // ÂàùÂßãÂåñÊó∂Ë∞ÉÊï¥Èó¥Ë∑ù
            setTimeout(adjustSpacingForRegionSelector, 300);
            
            // Âº∫Âà∂Êõ¥Êñ∞NSWÁä∂ÊÄÅÊòæÁ§∫
            setTimeout(() => {
                updateRegionStatusDisplay();
            }, 500);
            
            // ÂàùÂßãÂåñResizeObserverÁõëÂê¨Âú∞Âå∫ÈÄâÊã©Âô®È´òÂ∫¶ÂèòÂåñ
            setTimeout(() => {
                initRegionSelectorObserver();
            }, 500);
            
            // Á°Æ‰øùÂàùÂßãÈÄâ‰∏≠ÁöÑÂú∞Âå∫ÊúâÊ≠£Á°ÆÁöÑÈ¢úËâ≤
            setTimeout(() => {
                const activeRegion = document.querySelector('.region-select-tab.active');
                if (activeRegion) {
                    activeRegion.style.background = 'var(--color-region-primary)';
                    activeRegion.style.color = '#000';
                    const activeSpan = activeRegion.querySelector('span:first-child');
                    if (activeSpan && !activeSpan.innerHTML.includes('<div')) {
                        activeSpan.style.color = '#000';
                        activeSpan.style.fontWeight = '700';
                    }
                }
            }, 100);
        });
        
        // Á´ãÂç≥ÊâßË°å‰∏ÄÊ¨°ÂàùÂßãÂåñÔºàÈò≤Ê≠¢DOMContentLoadedÂ∑≤ÁªèËß¶ÂèëÔºâ
        setTimeout(function() {
            updateRegionDisplay();
            adjustSpacingForRegionSelector();
            
            // ÂàùÂßãÂåñResizeObserver
            setTimeout(() => {
                initRegionSelectorObserver();
            }, 200);
            
            // Á°Æ‰øùÈÄâ‰∏≠Âú∞Âå∫È¢úËâ≤Ê≠£Á°Æ
            const activeRegion = document.querySelector('.region-select-tab.active');
            if (activeRegion) {
                activeRegion.style.background = 'var(--color-region-primary)';
                activeRegion.style.color = '#000';
                const activeSpan = activeRegion.querySelector('span:first-child');
                if (activeSpan && !activeSpan.innerHTML.includes('<div')) {
                    activeSpan.style.color = '#000';
                    activeSpan.style.fontWeight = '700';
                }
            }
        }, 100);
        
        // Êõ¥Âº∫Âà∂ÁöÑÂàùÂßãÂåñ
        window.addEventListener('load', function() {
            updateRegionDisplay();
            setTimeout(adjustSpacingForRegionSelector, 500);
            
            // Á°Æ‰øùResizeObserverÂ∑≤ÂàùÂßãÂåñ
            setTimeout(() => {
                initRegionSelectorObserver();
            }, 600);
            
            // ÊúÄÁªàÁ°Æ‰øùÈÄâ‰∏≠Âú∞Âå∫È¢úËâ≤Ê≠£Á°Æ
            setTimeout(() => {
                const activeRegion = document.querySelector('.region-select-tab.active');
                if (activeRegion) {
                    activeRegion.style.background = 'var(--color-region-primary)';
                    activeRegion.style.color = '#000';
                    const activeSpan = activeRegion.querySelector('span:first-child');
                    if (activeSpan && !activeSpan.innerHTML.includes('<div')) {
                        activeSpan.style.color = '#000';
                        activeSpan.style.fontWeight = '700';
                    }
                }
            }, 200);
        });
        
        // Â¶ÇÊûúÈ°µÈù¢Â∑≤ÁªèÂä†ËΩΩÂÆåÊàêÔºåÁ´ãÂç≥ÊâßË°å
        if (document.readyState === 'complete') {
            updateRegionDisplay();
            setTimeout(adjustSpacingForRegionSelector, 100);
            
            // Á´ãÂç≥ÂàùÂßãÂåñResizeObserver
            setTimeout(() => {
                initRegionSelectorObserver();
            }, 150);
            
            // Á°Æ‰øùÈÄâ‰∏≠Âú∞Âå∫È¢úËâ≤Ê≠£Á°Æ
            setTimeout(() => {
                const activeRegion = document.querySelector('.region-select-tab.active');
                if (activeRegion) {
                    activeRegion.style.background = 'var(--color-region-primary)';
                    activeRegion.style.color = '#000';
                    const activeSpan = activeRegion.querySelector('span:first-child');
                    if (activeSpan && !activeSpan.innerHTML.includes('<div')) {
                        activeSpan.style.color = '#000';
                        activeSpan.style.fontWeight = '700';
                    }
                }
            }, 50);
        }
        
        // ÊµãËØïÂäüËÉΩÔºöÂº∫Âà∂Êõ¥Êñ∞ÁøªËØë
        window.forceUpdateTranslations = function() {
            if (window.i18n && window.i18n.updatePageTexts) {
                window.i18n.updatePageTexts();
            }
            updateRegionDisplay();
            setTimeout(adjustSpacingForRegionSelector, 100);
            
            // Á°Æ‰øùResizeObserverÂ∑≤ÂàùÂßãÂåñ
            setTimeout(() => {
                initRegionSelectorObserver();
            }, 120);
            
            // Á°Æ‰øùÈÄâ‰∏≠Âú∞Âå∫È¢úËâ≤Ê≠£Á°Æ
            setTimeout(() => {
                const activeRegion = document.querySelector('.region-select-tab.active');
                if (activeRegion) {
                    activeRegion.style.background = 'var(--color-region-primary)';
                    activeRegion.style.color = '#000';
                    const activeSpan = activeRegion.querySelector('span:first-child');
                    if (activeSpan && !activeSpan.innerHTML.includes('<div')) {
                        activeSpan.style.color = '#000';
                        activeSpan.style.fontWeight = '700';
                    }
                }
            }, 150);
        };
        
        // Êù°‰ª∂ËÆæÁΩÆÂºπÁ™óÂäüËÉΩ
        
        // Simplified modal - old complex functions removed
        
        // Simplified settings - removed complex timeline variables
        
        // Removed complex timeline functions - simplified modal only needs basic settings
        
        // Â§öÊÆµÊó∂Èó¥ÈÄâÊã©ÂäüËÉΩ
        let currentConditionType = 'charge'; // ÂΩìÂâçÊù°‰ª∂Á±ªÂûã: charge Êàñ discharge
        let currentSelectedRegion = 'NSW'; // ÂΩìÂâçÈÄâ‰∏≠ÁöÑÂú∞Âå∫
        let selectedRegionData = {}; // Â≠òÂÇ®ÊØè‰∏™Âú∞Âå∫ÁöÑÊó∂Èó¥ËÆæÁΩÆ
        
        // Êó∂Èó¥ÊÆµÊï∞ÊçÆÁªìÊûÑ
        let chargeTimeSettings = { segments: [{ start: 22, end: 6, id: 'charge-1' }] }; // 22:00 - 06:00
        let dischargeTimeSettings = { segments: [{ start: 6, end: 22, id: 'discharge-1' }] }; // 06:00 - 22:00
        
        function switchConditionType(type) {
            // ‰øùÂ≠òÂΩìÂâçÊï∞ÊçÆ
            saveRegionData(currentSelectedRegion, currentConditionType);
            
            // ÂàáÊç¢Êù°‰ª∂Á±ªÂûã
            currentConditionType = type;
            
            // Âä†ËΩΩÊñ∞ÁöÑÊï∞ÊçÆ
            loadRegionData(currentSelectedRegion, type);
            
            // Êõ¥Êñ∞UI
            updateModalUI();
            updateTimelineDisplay();
            updateModalCurrentSettings();
        }
        
        function switchModalRegion(region, button) {
            // ‰øùÂ≠òÂΩìÂâçÊï∞ÊçÆ
            saveRegionData(currentSelectedRegion, currentConditionType);
            
            // ÂàáÊç¢Âú∞Âå∫
            currentSelectedRegion = region;
            
            // Êõ¥Êñ∞Âú∞Âå∫ÊåâÈíÆÁä∂ÊÄÅ
            document.querySelectorAll('.modal-region-tab').forEach(tab => {
                tab.classList.remove('active');
                tab.style.background = 'rgba(255,255,255,0.1)';
                tab.style.color = 'rgba(255,255,255,0.7)';
                tab.style.border = '1px solid rgba(255,255,255,0.2)';
            });
            
            button.classList.add('active');
            button.style.background = 'var(--color-region-primary)';
            button.style.color = '#000';
            button.style.border = 'none';
            
            // Âä†ËΩΩÊñ∞Âú∞Âå∫Êï∞ÊçÆ
            loadRegionData(region, currentConditionType);
            
            // Êõ¥Êñ∞Êó∂Èó¥ËΩ¥
            updateTimelineDisplay();
            updateModalCurrentSettings();
        }
        
        function updateModalUI() {
            const chargeBtn = document.getElementById('modalChargeBtn');
            const dischargeBtn = document.getElementById('modalDischargeBtn');
            
            if (currentConditionType === 'charge') {
                chargeBtn.style.background = 'linear-gradient(135deg, #00ff88, #00cc6a)';
                chargeBtn.style.color = '#000';
                chargeBtn.style.border = 'none';
                
                dischargeBtn.style.background = 'rgba(255,255,255,0.1)';
                dischargeBtn.style.color = 'rgba(255,255,255,0.6)';
                dischargeBtn.style.border = '1px solid rgba(255,255,255,0.2)';
            } else {
                dischargeBtn.style.background = 'linear-gradient(135deg, #FFC107, #FFB000)';
                dischargeBtn.style.color = '#000';
                dischargeBtn.style.border = 'none';
                
                chargeBtn.style.background = 'rgba(255,255,255,0.1)';
                chargeBtn.style.color = 'rgba(255,255,255,0.6)';
                chargeBtn.style.border = '1px solid rgba(255,255,255,0.2)';
            }
        }
        
        function loadRegionData(region, type) {
            // Á°Æ‰øùÊúâÂú∞Âå∫Êï∞ÊçÆ
            if (!selectedRegionData[region]) {
                selectedRegionData[region] = { charge: {}, discharge: {} };
            }
            
            const regionData = selectedRegionData[region];
            
            // Âä†ËΩΩÂÖÖÁîµËÆæÁΩÆ
            if (regionData.charge) {
                chargeTimeSettings = { 
                    segments: regionData.charge.segments || [{ start: 22, end: 6, id: `charge-${Date.now()}` }]
                };
                // ËÆæÁΩÆcheckboxÁä∂ÊÄÅ
                const chargeTimeCheckbox = document.getElementById('chargeTimeEnabled');
                const chargePriceCheckbox = document.getElementById('chargePriceEnabled');
                const chargePriceInput = document.getElementById('chargePrice');
                
                if (chargeTimeCheckbox) chargeTimeCheckbox.checked = regionData.charge.timeEnabled !== false;
                if (chargePriceCheckbox) chargePriceCheckbox.checked = regionData.charge.priceEnabled !== false;
                if (chargePriceInput && regionData.charge.priceThreshold) {
                    chargePriceInput.value = regionData.charge.priceThreshold;
                }
            } else {
                chargeTimeSettings = { segments: [{ start: 22, end: 6, id: `charge-${Date.now()}` }] };
            }
            
            // Âä†ËΩΩÊîæÁîµËÆæÁΩÆ
            if (regionData.discharge) {
                dischargeTimeSettings = { 
                    segments: regionData.discharge.segments || [{ start: 6, end: 22, id: `discharge-${Date.now()}` }]
                };
                // ËÆæÁΩÆcheckboxÁä∂ÊÄÅ
                const dischargeTimeCheckbox = document.getElementById('dischargeTimeEnabled');
                const dischargePriceCheckbox = document.getElementById('dischargePriceEnabled');
                const dischargePriceInput = document.getElementById('dischargePrice');
                
                if (dischargeTimeCheckbox) dischargeTimeCheckbox.checked = regionData.discharge.timeEnabled !== false;
                if (dischargePriceCheckbox) dischargePriceCheckbox.checked = regionData.discharge.priceEnabled !== false;
                if (dischargePriceInput && regionData.discharge.priceThreshold) {
                    dischargePriceInput.value = regionData.discharge.priceThreshold;
                }
            } else {
                dischargeTimeSettings = { segments: [{ start: 6, end: 22, id: `discharge-${Date.now()}` }] };
            }
        }
        
        function saveRegionData(region, type) {
            // Á°Æ‰øù selectedRegionData[region] Â≠òÂú®
            if (!selectedRegionData[region]) {
                selectedRegionData[region] = { charge: {}, discharge: {} };
            }
            
            // Ëé∑ÂèñcheckboxÁä∂ÊÄÅ
            const chargeTimeEnabled = document.getElementById('chargeTimeEnabled')?.checked;
            const chargePriceEnabled = document.getElementById('chargePriceEnabled')?.checked;
            const dischargeTimeEnabled = document.getElementById('dischargeTimeEnabled')?.checked;
            const dischargePriceEnabled = document.getElementById('dischargePriceEnabled')?.checked;
            
            // Ëé∑Âèñ‰ª∑Ê†ºÂÄº
            const chargePriceValue = document.getElementById('chargePrice')?.value || 50;
            const dischargePriceValue = document.getElementById('dischargePrice')?.value || 100;
            
            // ‰øùÂ≠òÂÖÖÁîµËÆæÁΩÆ
            selectedRegionData[region].charge = {
                segments: chargeTimeSettings.segments,
                timeEnabled: chargeTimeEnabled !== undefined ? chargeTimeEnabled : true,
                priceEnabled: chargePriceEnabled !== undefined ? chargePriceEnabled : true,
                priceThreshold: parseInt(chargePriceValue)
            };
            
            // ‰øùÂ≠òÊîæÁîµËÆæÁΩÆ
            selectedRegionData[region].discharge = {
                segments: dischargeTimeSettings.segments,
                timeEnabled: dischargeTimeEnabled !== undefined ? dischargeTimeEnabled : true,
                priceEnabled: dischargePriceEnabled !== undefined ? dischargePriceEnabled : true,
                priceThreshold: parseInt(dischargePriceValue)
            };
        }
        
        function updateModalCurrentSettings() {
            const currentSettings = document.getElementById('modalCurrentSettings');
            const typeText = currentConditionType === 'charge' ? 'ÂÖÖÁîµ' : 'ÊîæÁîµ';
            const settings = currentConditionType === 'charge' ? chargeTimeSettings : dischargeTimeSettings;
            
            if (settings.segments.length === 0) {
                currentSettings.innerHTML = `${currentSelectedRegion} - ${typeText}: ${window.i18n && window.i18n.getCurrentLanguage() === 'en' ? 'No time slots' : 'Êú™ËÆæÁΩÆÊó∂Èó¥ÊÆµ'}`;
            } else if (settings.segments.length === 1) {
                const segment = settings.segments[0];
                const timeText = `${segment.start.toString().padStart(2, '0')}:00 - ${segment.end.toString().padStart(2, '0')}:00`;
                currentSettings.innerHTML = `${currentSelectedRegion} - ${typeText}: ${timeText}`;
            } else {
                currentSettings.innerHTML = `${currentSelectedRegion} - ${typeText}: ${settings.segments.length}${window.i18n && window.i18n.getCurrentLanguage() === 'en' ? ' slots' : '‰∏™Êó∂Èó¥ÊÆµ'}`;
            }
        }
        
        function updateTimelineDisplay() {
            const timeline = document.getElementById('timeline');
            if (!timeline) return;
            
            // Ê∏ÖÈô§Áé∞ÊúâÊó∂Èó¥ÊÆµ
            document.querySelectorAll('.time-segment').forEach(segment => segment.remove());
            
            // ‰∏çÂú®Êó∂Èó¥ËΩ¥‰∏äÊòæÁ§∫Êó∂Èó¥ÊÆµÔºåÂè™Âú®Êó∂Èó¥Êù°‰ª∂Âç°Áâá‰∏≠ÊòæÁ§∫
            // // ÂàõÂª∫ÂΩìÂâçÁ±ªÂûãÁöÑÊó∂Èó¥ÊÆµ
            // const settings = currentConditionType === 'charge' ? chargeTimeSettings : dischargeTimeSettings;
            // settings.segments.forEach((segment, index) => {
            //     createTimeSegment(currentConditionType, segment, index);
            // });
        }
        
        function createTimeSegment(type, segment, index) {
            const timeline = document.getElementById('timeline');
            const element = document.createElement('div');
            element.className = 'time-segment';
            element.dataset.type = type;
            element.dataset.segmentId = segment.id;
            element.dataset.index = index;
            
            const color = type === 'charge' ? '#00ff88' : '#FFC107';
            const gradientColor = type === 'charge' ? '#00cc6a' : '#FFB000';
            
            // ËÆ°ÁÆó‰ΩçÁΩÆÂíåÂÆΩÂ∫¶
            let left, width;
            if (segment.start > segment.end) {
                // Ë∑®Êó•Â§ÑÁêÜ
                left = (segment.start / 24 * 100);
                width = ((24 - segment.start + segment.end) / 24 * 100);
            } else {
                left = (segment.start / 24 * 100);
                width = ((segment.end - segment.start) / 24 * 100);
            }
            
            element.style.cssText = `
                position: absolute;
                left: ${left}%;
                width: ${width}%;
                height: 48px;
                top: 6px;
                background: linear-gradient(135deg, ${color}, ${gradientColor});
                border-radius: 10px;
                cursor: move;
                display: flex;
                align-items: center;
                justify-content: center;
                color: #000;
                font-size: 10px;
                font-weight: 600;
                user-select: none;
                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                border: 1px solid rgba(255,255,255,0.2);
            `;
            
            const timeText = `${segment.start.toString().padStart(2, '0')}:00-${segment.end.toString().padStart(2, '0')}:00`;
            element.innerHTML = `
                <span>${timeText}</span>
                <button onclick="removeTimeSegment('${segment.id}')" style="position: absolute; top: -4px; right: -4px; width: 16px; height: 16px; background: #ff4444; color: #fff; border: none; border-radius: 50%; font-size: 10px; cursor: pointer; display: none;" class="delete-btn">√ó</button>
            `;
            
            // Ê∑ªÂä†ÊÇ¨ÂÅúÊïàÊûúÊòæÁ§∫Âà†Èô§ÊåâÈíÆ
            element.addEventListener('mouseenter', () => {
                element.querySelector('.delete-btn').style.display = 'flex';
            });
            element.addEventListener('mouseleave', () => {
                element.querySelector('.delete-btn').style.display = 'none';
            });
            
            // ‰∏çÂú®Êó∂Èó¥ËΩ¥‰∏äÊòæÁ§∫Êó∂Èó¥ÊÆµ
            // timeline.appendChild(element);
        }
        
        function addTimeSegment() {
            const settings = currentConditionType === 'charge' ? chargeTimeSettings : dischargeTimeSettings;
            const newSegment = {
                start: 10,
                end: 14,
                id: `${currentConditionType}-${Date.now()}`
            };
            
            settings.segments.push(newSegment);
            updateTimelineDisplay();
            updateModalCurrentSettings();
            
            updateSelectionInfo(`<span style="color: #00ff88;">‚úì Êñ∞Êó∂Èó¥ÊÆµÂ∑≤Ê∑ªÂä†: 10:00-14:00</span>`);
        }
        
        function removeTimeSegment(segmentId) {
            const settings = currentConditionType === 'charge' ? chargeTimeSettings : dischargeTimeSettings;
            settings.segments = settings.segments.filter(s => s.id !== segmentId);
            
            updateTimelineDisplay();
            updateModalCurrentSettings();
            
            updateSelectionInfo(`<span style="color: #ff4444;">‚úì Êó∂Èó¥ÊÆµÂ∑≤Âà†Èô§</span>`);
        }
        
        function clearAllTimeSegments() {
            const settings = currentConditionType === 'charge' ? chargeTimeSettings : dischargeTimeSettings;
            settings.segments = [];
            
            updateTimelineDisplay();
            updateModalCurrentSettings();
            
            updateSelectionInfo(`<span style="color: #ff4444;">‚úì ÊâÄÊúâÊó∂Èó¥ÊÆµÂ∑≤Ê∏ÖÈô§</span>`);
        }
        
        function updateSelectionInfo(message) {
            const info = document.getElementById('timeSelectionInfo');
            if (info) {
                info.innerHTML = message;
                setTimeout(() => {
                    info.innerHTML = '<span style="color: rgba(255,255,255,0.6); font-size: 12px;">üí° ' + (window.i18n ? window.i18n.getText('dragToAddTimeSlot') : 'ÁÇπÂáªÁ©∫ÁôΩÂå∫ÂüüÊ∑ªÂä†Êó∂Èó¥ÊÆµÔºåÊãñÊãΩÊó∂Èó¥ÊÆµË∞ÉÊï¥Êó∂Èó¥') + '</span>';
                }, 3000);
            }
        }
        
        // Switch Modal Mode Function (Â∑≤ÁßªÈô§tabÔºåÂáΩÊï∞‰øùÁïô‰ª•ÂÖºÂÆπ)
        function switchModalMode(mode) {
            // Áî±‰∫éÂ∑≤ÁßªÈô§ÊâãÂä®/Ëá™Âä®tabÔºåÊ≠§ÂáΩÊï∞Áé∞Âú®‰∏çÊâßË°å‰ªª‰ΩïÊìç‰Ωú
            // Ëá™Âä®Êù°‰ª∂ÂßãÁªàÊòæÁ§∫
            const autoConditions = document.getElementById('autoModeConditions');
            if (autoConditions) {
                autoConditions.style.display = 'block';
            }
            
            // ‰ªçÁÑ∂‰øùÂ≠òÊ®°Âºè‰ª•ÂÖºÂÆπÂÖ∂‰ªñÂèØËÉΩÁöÑË∞ÉÁî®
            localStorage.setItem('modalMode', mode);
        }

        // ÊóßÂáΩÊï∞Â∑≤Â∫üÂºÉÔºåÁî± condition-settings-modal.js ‰∏≠ÁöÑÂêåÂêçÂáΩÊï∞Êõø‰ª£
        // function saveConditionSettings() {
        //     // ‰øùÂ≠òÂΩìÂâçÊ≠£Âú®ÁºñËæëÁöÑÊï∞ÊçÆ
        //     saveRegionData(currentSelectedRegion, currentConditionType);
        //
        //     // ‰øùÂ≠òÊâÄÊúâÂú∞Âå∫ÁöÑËÆæÁΩÆÊï∞ÊçÆÂà∞localStorage
        //     localStorage.setItem('regionTimeSettings', JSON.stringify(selectedRegionData));
        //
        //     // Êõ¥Êñ∞ÊòæÁ§∫ÁöÑÂãæÈÄâÁä∂ÊÄÅ
        //     updateConditionsDisplayFromSaved();
        //
        //     // ÂÖ≥Èó≠ÂºπÁ™ó
        //     closeConditionSettingsModal();
        //
        //     // ÊòæÁ§∫‰øùÂ≠òÊàêÂäüÊèêÁ§∫
        //     showAutoOperationNotification('ËÆæÁΩÆ', 'Â§öÂú∞Âå∫Êù°‰ª∂ËÆæÁΩÆÂ∑≤‰øùÂ≠ò');
        //
        //     console.log('Â§öÂú∞Âå∫Êó∂Èó¥Êù°‰ª∂ËÆæÁΩÆÂ∑≤‰øùÂ≠ò:', selectedRegionData);
        // }
        
        // ‰ªé‰øùÂ≠òÁöÑËÆæÁΩÆÊõ¥Êñ∞ÊòæÁ§∫
        function updateConditionsDisplayFromSaved() {
            const currentRegion = selectedMainRegion || 'NSW';
            const regionData = selectedRegionData[currentRegion];
            
            if (!regionData) {
                // Â¶ÇÊûúÊ≤°Êúâ‰øùÂ≠òÁöÑÊï∞ÊçÆÔºå‰ΩøÁî®ÈªòËÆ§ÂÄº
                var _ct = document.getElementById('chargeTimeEnabledDisplay');
                var _cp = document.getElementById('chargePriceEnabledDisplay');
                var _dt = document.getElementById('dischargeTimeEnabledDisplay');
                var _dp = document.getElementById('dischargePriceEnabledDisplay');
                if (_ct) _ct.checked = true;
                if (_cp) _cp.checked = true;
                if (_dt) _dt.checked = true;
                if (_dp) _dp.checked = true;
                return;
            }
            
            // ‰ªé‰øùÂ≠òÁöÑÊï∞ÊçÆ‰∏≠Ëé∑ÂèñcheckboxÁä∂ÊÄÅ
            const chargeTimeEnabled = regionData.charge?.timeEnabled !== false;
            const chargePriceEnabled = regionData.charge?.priceEnabled !== false;
            const dischargeTimeEnabled = regionData.discharge?.timeEnabled !== false;
            const dischargePriceEnabled = regionData.discharge?.priceEnabled !== false;
            
            // Êõ¥Êñ∞checkboxÊòæÁ§∫
            const chargeTimeCheckbox = document.getElementById('chargeTimeEnabledDisplay');
            const chargePriceCheckbox = document.getElementById('chargePriceEnabledDisplay');
            const dischargeTimeCheckbox = document.getElementById('dischargeTimeEnabledDisplay');
            const dischargePriceCheckbox = document.getElementById('dischargePriceEnabledDisplay');
            
            if (chargeTimeCheckbox) chargeTimeCheckbox.checked = chargeTimeEnabled;
            if (chargePriceCheckbox) chargePriceCheckbox.checked = chargePriceEnabled;
            if (dischargeTimeCheckbox) dischargeTimeCheckbox.checked = dischargeTimeEnabled;
            if (dischargePriceCheckbox) dischargePriceCheckbox.checked = dischargePriceEnabled;
            
            // Êõ¥Êñ∞ÊòæÁ§∫ÁöÑÈÄèÊòéÂ∫¶ÂíåÊú™‰ΩøÁî®Ê†áÁ≠æ
            updateConditionDisplayStyle('charge', 'time', chargeTimeEnabled);
            updateConditionDisplayStyle('charge', 'price', chargePriceEnabled);
            updateConditionDisplayStyle('discharge', 'time', dischargeTimeEnabled);
            updateConditionDisplayStyle('discharge', 'price', dischargePriceEnabled);
            
            // Êõ¥Êñ∞Êó∂Èó¥Âíå‰ª∑Ê†ºÂÄº
            if (regionData.charge) {
                const chargeSegments = regionData.charge.segments || regionData.charge.timeSegments;
                if (chargeSegments && chargeSegments.length > 0) {
                    document.getElementById('chargeStartTime').textContent = chargeSegments[0].start + ':00';
                    document.getElementById('chargeEndTime').textContent = chargeSegments[0].end + ':00';
                }
                if (regionData.charge.priceThreshold !== undefined) {
                    document.getElementById('chargePriceValue').textContent = regionData.charge.priceThreshold;
                }
            }
            
            if (regionData.discharge) {
                const dischargeSegments = regionData.discharge.segments || regionData.discharge.timeSegments;
                if (dischargeSegments && dischargeSegments.length > 0) {
                    document.getElementById('dischargeStartTime').textContent = dischargeSegments[0].start + ':00';
                    document.getElementById('dischargeEndTime').textContent = dischargeSegments[0].end + ':00';
                }
                if (regionData.discharge.priceThreshold !== undefined) {
                    document.getElementById('dischargePriceValue').textContent = regionData.discharge.priceThreshold;
                }
            }
        }
        
        // Êõ¥Êñ∞Êù°‰ª∂ÊòæÁ§∫Ê†∑Âºè
        function updateConditionDisplayStyle(type, condition, enabled) {
            const prefix = type === 'charge' ? 'charge' : 'discharge';
            const suffix = condition === 'time' ? 'Time' : 'Price';
            
            const display = document.getElementById(`${prefix}${suffix}Display`);
            const disabled = document.getElementById(`${prefix}${suffix}Disabled`);
            
            if (display && disabled) {
                if (enabled) {
                    display.style.opacity = '1';
                    disabled.style.display = 'none';
                } else {
                    display.style.opacity = '0.4';
                    disabled.style.display = 'inline';
                }
            }
        }
        
        // È°µÈù¢Âä†ËΩΩÊó∂ÊÅ¢Â§çËÆæÁΩÆ
        function loadConditionSettings() {
            const savedRegionSettings = localStorage.getItem('regionTimeSettings');
            if (savedRegionSettings) {
                try {
                    selectedRegionData = JSON.parse(savedRegionSettings);
                    // Êõ¥Êñ∞ÊòæÁ§∫
                    updateConditionsDisplayFromSaved();
                } catch (e) {
                    console.error('ÊÅ¢Â§çÂú∞Âå∫ËÆæÁΩÆÊó∂Âá∫Èîô:', e);
                    selectedRegionData = {};
                }
            } else {
                // Â¶ÇÊûúÊ≤°Êúâ‰øùÂ≠òÁöÑËÆæÁΩÆÔºå‰πüÊõ¥Êñ∞ÊòæÁ§∫‰∏∫ÈªòËÆ§ÂÄº
                updateConditionsDisplayFromSaved();
            }
        }
        
        // Âú®È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÊÅ¢Â§çËÆæÁΩÆ
        window.addEventListener('load', function() {
            setTimeout(loadConditionSettings, 500);
            // ÂÜçÊ¨°Ê£ÄÊü•Ê®°ÊÄÅÊ°ÜÁä∂ÊÄÅÔºåÁ°Æ‰øùÂú®ÊâÄÊúâËµÑÊ∫êÂä†ËΩΩÂÆåÊàêÂêéÊÅ¢Â§ç
            setTimeout(checkAndRestoreModal, 1000);
        });
        
        // ÂàùÂßãÂåñÊù°‰ª∂Ê®°ÊÄÅÊ°Ü
        function initializeConditionModal() {
            // Á°Æ‰øùÂÖ®Â±ÄÂèòÈáèÂ≠òÂú®
            if (!window.chargeTimeSegments) {
                window.chargeTimeSegments = [{ start: '22:00', end: '06:00' }];
            }
            if (!window.dischargeTimeSegments) {
                window.dischargeTimeSegments = [{ start: '16:00', end: '21:00' }];
            }
            
            // Á°Æ‰øùÂ±ÄÈÉ®ÂèòÈáèÂ∑≤Â£∞ÊòéÂπ∂ÂêåÊ≠•
            if (typeof chargeTimeSegments === 'undefined') {
                // Â¶ÇÊûúÂ±ÄÈÉ®ÂèòÈáèÊú™ÂÆö‰πâÔºåÂàõÂª∫‰∏Ä‰∏™‰∏¥Êó∂ÁöÑÂ±ÄÈÉ®ÂèòÈáè
                var chargeTimeSegments = [...window.chargeTimeSegments];
                var dischargeTimeSegments = [...window.dischargeTimeSegments];
                
                // Â∞ÜÂÆÉ‰ª¨ËÆæÁΩÆ‰∏∫ÂÖ®Â±ÄÂèòÈáè‰ª•‰æõÂêéÁª≠‰ΩøÁî®
                window.chargeTimeSegments = chargeTimeSegments;
                window.dischargeTimeSegments = dischargeTimeSegments;
            } else {
                // ÂêåÊ≠•Êï∞ÊçÆ
                chargeTimeSegments = [...window.chargeTimeSegments];
                dischargeTimeSegments = [...window.dischargeTimeSegments];
            }
            
            
            // ÂêåÊ≠•SOCÂÄºÂà∞Modal
            syncSOCToModal();
            
            // ÊµãËØïÔºöÂº∫Âà∂ËÆæÁΩÆ‰∏Ä‰∏™Â∑≤Áü•ÂÄº
            setTimeout(() => {
                updateModalChargeSOC(90);
                updateModalDischargeSOC(20);
                
                // ÊµãËØïËæìÂÖ•Ê°Ü‰∫ã‰ª∂ÁªëÂÆö
                const chargeInput = document.getElementById('modalChargeStopSOC');
                const dischargeInput = document.getElementById('modalDischargeStopSOC');
                
                if (chargeInput) {
                }
                if (dischargeInput) {
                }
                
                // Ë∞ÉÁî®ÊµãËØïÂáΩÊï∞
                testSOCFunctionality();
            }, 500);
        }
        
        // ÊµãËØïSOCÂäüËÉΩÁöÑÂáΩÊï∞
        function testSOCFunctionality() {
            
            // Ê£ÄÊü•ÊâÄÊúâÁõ∏ÂÖ≥ÂÖÉÁ¥†
            const elements = {
                chargeInput: document.getElementById('modalChargeStopSOC'),
                chargeSlider: document.getElementById('modalChargeSOCSlider'),
                chargeBar: document.getElementById('modalChargeSOCBar'),
                chargeDot: document.getElementById('modalChargeSOCDot'),
                dischargeInput: document.getElementById('modalDischargeStopSOC'),
                dischargeSlider: document.getElementById('modalDischargeSOCSlider'),
                dischargeBar: document.getElementById('modalDischargeSOCBar'),
                dischargeDot: document.getElementById('modalDischargeSOCDot')
            };
            
            
            // ÊµãËØïÂÖÖÁîµSOC
            updateModalChargeSOC(75);
            
            // ÊµãËØïÊîæÁîµSOC
            updateModalDischargeSOC(30);
            
            // Ê£ÄÊü•Ê†∑ÂºèÊòØÂê¶Ê≠£Á°ÆÂ∫îÁî®
            setTimeout(() => {
            }, 100);
        }
        
        // Â§ÑÁêÜËÆæÁΩÆÁºñËæëÊåâÈíÆÁÇπÂáª
        function handleSettingsEdit() {
            // Ê£ÄÊü•ÂΩìÂâçÈÄâ‰∏≠Âú∞Âå∫ÁöÑÁä∂ÊÄÅ
            const currentRegionStatus = regionData[selectedMainRegion] ? regionData[selectedMainRegion].status : 'none';
            
            // Â¶ÇÊûúÊòØËá™Âä®ÂÖÖÁîµÊàñËá™Âä®ÊîæÁîµÁä∂ÊÄÅÔºåÊòæÁ§∫ÊèêÁ§∫Âπ∂Á¶ÅÊ≠¢ÁºñËæë
            if (currentRegionStatus === 'autoCharge' || currentRegionStatus === 'autoDischarge') {
                showSettingsEditDisabledTooltip();
                return;
            }
            
            // ÂÖ∂‰ªñÊÉÖÂÜµ‰∏ãÂèØ‰ª•Ê≠£Â∏∏ÁºñËæë
            openConditionSettingsModal();
        }
        
        // ÊòæÁ§∫ËÆæÁΩÆÁºñËæëÁ¶ÅÁî®ÊèêÁ§∫
        function showSettingsEditDisabledTooltip() {
            const editBtn = document.getElementById('settingsEditBtn');
            if (!editBtn) return;
            
            // ÁßªÈô§Áé∞ÊúâÁöÑÊèêÁ§∫
            const existingTooltip = document.getElementById('settingsEditTooltip');
            if (existingTooltip) {
                existingTooltip.remove();
            }
            
            // ÂàõÂª∫ÊèêÁ§∫ÂÖÉÁ¥†
            const tooltip = document.createElement('div');
            tooltip.id = 'settingsEditTooltip';
            tooltip.style.cssText = `
                position: fixed;
                background: rgba(0, 0, 0, 0.9);
                color: white;
                padding: 8px 12px;
                border-radius: 6px;
                font-size: 12px;
                z-index: 10000;
                white-space: nowrap;
                opacity: 0;
                transition: opacity 0.3s ease;
                pointer-events: none;
                border: 1px solid rgba(255, 255, 255, 0.2);
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            `;
            
            // ËÆæÁΩÆÊèêÁ§∫ÊñáÊú¨
            const currentStatus = regionData[selectedMainRegion].status;
            if (currentStatus === 'autoCharge') {
                tooltip.textContent = window.i18n ? window.i18n.getText('autoChargingCannotEdit') : 'Êô∫ËÉΩÂÖÖÁîµËøõË°å‰∏≠ÔºåÊó†Ê≥ïÁºñËæëËÆæÁΩÆ';
            } else if (currentStatus === 'autoDischarge') {
                tooltip.textContent = window.i18n ? window.i18n.getText('autoDischargingCannotEdit') : 'Êô∫ËÉΩÊîæÁîµËøõË°å‰∏≠ÔºåÊó†Ê≥ïÁºñËæëËÆæÁΩÆ';
            }
            
            // ËÆ°ÁÆó‰ΩçÁΩÆ
            const rect = editBtn.getBoundingClientRect();
            tooltip.style.top = (rect.top - 45) + 'px';
            tooltip.style.left = (rect.left + rect.width / 2) + 'px';
            tooltip.style.transform = 'translateX(-50%)';
            
            document.body.appendChild(tooltip);
            
            // ÊòæÁ§∫ÊèêÁ§∫
            setTimeout(() => {
                tooltip.style.opacity = '1';
            }, 10);
            
            // 3ÁßíÂêéËá™Âä®ÈöêËóè
            setTimeout(() => {
                tooltip.style.opacity = '0';
                setTimeout(() => {
                    if (tooltip.parentNode) {
                        tooltip.parentNode.removeChild(tooltip);
                    }
                }, 300);
            }, 3000);
        }
        
        // Êó∂Èó¥ÊÆµÁÆ°ÁêÜÁ≥ªÁªü
        class TimeSegmentManager {
            constructor() {
                this.chargeSegments = [{ id: 'charge_1', start: '22:00', end: '06:00' }];
                this.dischargeSegments = [{ id: 'discharge_1', start: '16:00', end: '21:00' }];
            }
            
            // Ê£ÄÊü•Êó∂Èó¥ÊÆµÊòØÂê¶ÊúâÊïàÔºà‰∏çÈáçÂè†Ôºâ
            isValidTimeSegment(newSegment, type, excludeId = null) {
                const segments = type === 'charge' ? this.chargeSegments : this.dischargeSegments;
                const filteredSegments = segments.filter(seg => seg.id !== excludeId);
                
                for (let segment of filteredSegments) {
                    if (this.isTimeOverlap(newSegment, segment)) {
                        return false;
                    }
                }
                return true;
            }
            
            // Ê£ÄÊü•‰∏§‰∏™Êó∂Èó¥ÊÆµÊòØÂê¶ÈáçÂè†
            isTimeOverlap(seg1, seg2) {
                const start1 = this.timeToMinutes(seg1.start);
                const end1 = this.timeToMinutes(seg1.end);
                const start2 = this.timeToMinutes(seg2.start);
                const end2 = this.timeToMinutes(seg2.end);
                
                // Â§ÑÁêÜË∑®Êó•ÊÉÖÂÜµ
                const end1Adjusted = end1 < start1 ? end1 + 1440 : end1;
                const end2Adjusted = end2 < start2 ? end2 + 1440 : end2;
                
                // Ê£ÄÊü•ÈáçÂè†
                return !(end1Adjusted <= start2 || end2Adjusted <= start1);
            }
            
            // Êó∂Èó¥ËΩ¨Êç¢‰∏∫ÂàÜÈíü
            timeToMinutes(time) {
                const [hours, minutes] = time.split(':').map(Number);
                return hours * 60 + minutes;
            }
            
            // ÂàÜÈíüËΩ¨Êç¢‰∏∫Êó∂Èó¥
            minutesToTime(minutes) {
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
            }
            
            // Ê∑ªÂä†Êó∂Èó¥ÊÆµ
            addTimeSegment(type, start, end) {
                const newSegment = {
                    id: `${type}_${Date.now()}`,
                    start: start,
                    end: end
                };
                
                if (this.isValidTimeSegment(newSegment, type)) {
                    if (type === 'charge') {
                        this.chargeSegments.push(newSegment);
                    } else {
                        this.dischargeSegments.push(newSegment);
                    }
                    return newSegment;
                }
                return null;
            }
            
            // Êõ¥Êñ∞Êó∂Èó¥ÊÆµ
            updateTimeSegment(id, start, end) {
                const chargeIndex = this.chargeSegments.findIndex(seg => seg.id === id);
                const dischargeIndex = this.dischargeSegments.findIndex(seg => seg.id === id);
                
                if (chargeIndex !== -1) {
                    const newSegment = { id, start, end };
                    if (this.isValidTimeSegment(newSegment, 'charge', id)) {
                        this.chargeSegments[chargeIndex] = newSegment;
                        return true;
                    }
                } else if (dischargeIndex !== -1) {
                    const newSegment = { id, start, end };
                    if (this.isValidTimeSegment(newSegment, 'discharge', id)) {
                        this.dischargeSegments[dischargeIndex] = newSegment;
                        return true;
                    }
                }
                return false;
            }
            
            // Âà†Èô§Êó∂Èó¥ÊÆµ
            removeTimeSegment(id) {
                this.chargeSegments = this.chargeSegments.filter(seg => seg.id !== id);
                this.dischargeSegments = this.dischargeSegments.filter(seg => seg.id !== id);
            }
            
            // Ëé∑ÂèñÊó∂Èó¥ÊÆµ
            getTimeSegments(type) {
                return type === 'charge' ? this.chargeSegments : this.dischargeSegments;
            }
        }
        
        // ÂÖ®Â±ÄÊó∂Èó¥ÊÆµÁÆ°ÁêÜÂô®ÂÆû‰æã
        window.timeSegmentManager = new TimeSegmentManager();
        
        // Êõ¥Êñ∞openConditionSettingsModalÂáΩÊï∞‰ª•ÂàùÂßãÂåñÊñ∞ÁöÑÁÆÄÂåñÂºπÁ™ó
        function openConditionSettingsModal() {
            
            try {
                // Á°Æ‰øùÊó∂Èó¥ÊÆµÁÆ°ÁêÜÂô®Â∑≤ÂàùÂßãÂåñ
                if (!window.timeSegmentManager) {
                    window.timeSegmentManager = new TimeSegmentManager();
                }
                
                // ÈáçÊñ∞Âä†ËΩΩÊ®°ÊÄÅÊ°ÜÂÜÖÂÆπÔºåÈÅøÂÖçÂàùÂßãÂåñÈóÆÈ¢ò
                initializeConditionModal();
                
                const modalContent = document.getElementById('modalContent');
                if (!modalContent) {
                    console.error('Modal content element not found!');
                    return;
                }
                
                modalContent.style.display = 'flex';
                
                // Restore saved mode or default to manual
                const savedMode = localStorage.getItem('modalMode') || 'manual';
                switchModalMode(savedMode);
                
                // ‰øùÂ≠òÊ®°ÊÄÅÊ°ÜÊâìÂºÄÁä∂ÊÄÅÂà∞localStorage
                localStorage.setItem('conditionSettingsModalOpen', 'true');
                localStorage.setItem('modalPosition', JSON.stringify({
                    top: modalContent.style.top || '5%',
                    left: modalContent.style.left || 'calc(50% - 450px)'
                }));
                
                // ÂàùÂßãÂåñÊ®°ÊÄÅÊ°ÜÊãñÊãΩÂäüËÉΩ
                makeModalDraggable(modalContent);
                
                // Âº∫Âà∂ËÆæÁΩÆÊúÄÈ´òÂ±ÇÁ∫ß
                modalContent.style.setProperty('z-index', '2147483648', 'important');
                modalContent.style.setProperty('position', 'fixed', 'important');
                
                // Êõ¥Êñ∞Ê®°ÊÄÅÊ°ÜÁöÑi18nÁøªËØë
                if (window.i18n && window.i18n.isReady) {
                    window.i18n.updatePageTexts();
                    // Á´ãÂç≥Êõ¥Êñ∞Ê®°ÊÄÅÊ°ÜÁøªËØë
                    updateModalTranslations();
                    // ÂÜçÊ¨°Âº∫Âà∂Êõ¥Êñ∞‰ª•Á°Æ‰øùÁîüÊïà
                    setTimeout(() => {
                        updateModalTranslations();
                    }, 100);
                    setTimeout(() => {
                        updateModalTranslations();
                    }, 300);
                }
                
                // Á°Æ‰øùÊó∂Èó¥ÊÆµÂàóË°®ÂÆπÂô®Â≠òÂú®
                setTimeout(() => {
                    const chargeContainer = document.getElementById('chargeTimeSegmentsList');
                    const dischargeContainer = document.getElementById('dischargeTimeSegmentsList');
                    
                    // Á´ãÂç≥Êõ¥Êñ∞ÊòæÁ§∫
                    updateTimeSegmentsList();
                }, 100);
                
                // ÊòæÁ§∫ÂΩìÂâçÈÄâ‰∏≠Âú∞Âå∫ÂêçÁß∞
                const regionNameEl = document.getElementById('modalRegionName');
                if (regionNameEl) {
                    regionNameEl.textContent = selectedMainRegion;
                }
                
                // ÂàùÂßãÂåñÂÖ®Â±ÄÂèòÈáè
                if (!window.chargeTimeSegments) {
                    window.chargeTimeSegments = [{ start: '22:00', end: '06:00' }];
                }
                if (!window.dischargeTimeSegments) {
                    window.dischargeTimeSegments = [{ start: '16:00', end: '21:00' }];
                }
                
                // Âä†ËΩΩÂΩìÂâçÂú∞Âå∫ÁöÑËÆæÁΩÆ
                loadCurrentRegionConditionSettings();
                
                // ÁªëÂÆö‰∫ã‰ª∂ÁõëÂê¨
                setTimeout(() => {
                    bindTimeInputEvents();
                    // Á°Æ‰øùÊó∂Èó¥ÈÄâÊã©‰∫ã‰ª∂‰πüÁªëÂÆö
                    bindTimeSelectionEvents();
                    
                    // ÂÜçÊ¨°Êõ¥Êñ∞i18n‰ª•Á°Æ‰øùÊâÄÊúâÂä®ÊÄÅÂÜÖÂÆπÈÉΩË¢´ÁøªËØë
                    if (window.i18n && window.i18n.isReady) {
                        window.i18n.updatePageTexts();
                        updateModalTranslations();
                    }
                }, 200);
            } catch (error) {
                console.error('Error opening modal:', error);
                alert((window.i18n && window.i18n.getCurrentLanguage() === 'en' ? 'Error opening settings: ' : 'ÊâìÂºÄËÆæÁΩÆÂºπÁ™óÊó∂Âá∫ÈîôÔºö') + error.message);
            }
        }
        
        // ‰∏ìÈó®Áî®‰∫éÊõ¥Êñ∞Ê®°ÊÄÅÊ°ÜÁøªËØëÁöÑÂáΩÊï∞ - Âº∫Âà∂ÁâàÊú¨
        function updateModalTranslations() {
            if (!window.i18n || !window.i18n.isReady) {
                return;
            }
            
            const currentLang = window.i18n.getCurrentLanguage();
            
            // Áõ¥Êé•Âº∫Âà∂Êõ¥Êñ∞ÊØè‰∏™ÊúâÈóÆÈ¢òÁöÑÂÖÉÁ¥†
            const forcedUpdates = [
                // Ê®°ÊÄÅÊ°ÜÊ†áÈ¢ò
                {
                    selector: '#conditionSettingsModal h3[data-i18n="automationConditionsSettings"]',
                    chinese: 'Êô∫ËÉΩÁ≠ñÁï•ËÆæÁΩÆ',
                    english: 'AI Strategy Settings'
                },
                {
                    selector: 'span[data-i18n="socSettings"]',
                    chinese: 'SOCËÆæÁΩÆ',
                    english: 'SOC Settings'
                },
                {
                    selector: 'h3[data-i18n="settings"]',
                    chinese: 'ËÆæÁΩÆ',
                    english: 'Settings'
                },
                {
                    selector: 'span[data-i18n="autoConditions"]',
                    chinese: 'Êô∫ËÉΩÁ≠ñÁï•',
                    english: 'AI Strategy'
                },
                {
                    selector: 'span[data-i18n="autoSettings"]',
                    chinese: 'Êô∫ËÉΩÊâòÁÆ°ËÆæÁΩÆ',
                    english: 'AI Custody Settings'
                },
                {
                    selector: 'span[data-i18n="edit"]',
                    chinese: 'ÁºñËæë',
                    english: 'Edit'
                },
                {
                    selector: 'div[data-i18n="autoChargeCondition"]',
                    chinese: 'Êô∫ËÉΩÂÖÖÁîµÊù°‰ª∂',
                    english: 'AI Charge Conditions'
                },
                {
                    selector: 'div[data-i18n="autoDischargeCondition"]',
                    chinese: 'Êô∫ËÉΩÊîæÁîµÊù°‰ª∂',
                    english: 'AI Discharge Conditions'
                },
                {
                    selector: 'span[data-i18n="notUsed"]',
                    chinese: '(Êú™‰ΩøÁî®)',
                    english: '(Not Used)'
                },
                // ÈÄâÊã©ÂÖÖÁîµÊó∂Èó¥ÊåâÈíÆ
                {
                    selector: '#chargeSelectBtn span[data-i18n="selectChargeTime"]',
                    chinese: 'ÈÄâÊã©ÂÖÖÁîµÊó∂Èó¥',
                    english: 'Select Charge Time'
                },
                // ÈÄâÊã©ÊîæÁîµÊó∂Èó¥ÊåâÈíÆ
                {
                    selector: '#dischargeSelectBtn span[data-i18n="selectDischargeTime"]',
                    chinese: 'ÈÄâÊã©ÊîæÁîµÊó∂Èó¥',
                    english: 'Select Discharge Time'
                },
                // ÂÖÖÁîµÊó∂Èó¥ÊÆµÊ†áÁ≠æ
                {
                    selector: 'span[data-i18n="chargeTimeSlot"]',
                    chinese: 'ÂÖÖÁîµÊó∂Èó¥ÊÆµ',
                    english: 'Charge Time Slot'
                },
                // ÊîæÁîµÊó∂Èó¥ÊÆµÊ†áÁ≠æ
                {
                    selector: 'span[data-i18n="dischargeTimeSlot"]',
                    chinese: 'ÊîæÁîµÊó∂Èó¥ÊÆµ',
                    english: 'Discharge Time Slot'
                },
                // ÊãñÊãΩÊèêÁ§∫
                {
                    selector: 'span[data-i18n="dragToAddTimeSlot"]',
                    chinese: 'Âú®Êó∂Èó¥ËΩ¥‰∏äÊãñÊãΩÂç≥ÂèØÊ∑ªÂä†Êó∂Èó¥ÊÆµ',
                    english: 'Drag on the timeline to add time slots'
                },
                // Êó∂Èó¥Êù°‰ª∂
                {
                    selector: 'span[data-i18n="timeCondition"]',
                    chinese: 'Êó∂Èó¥Êù°‰ª∂',
                    english: 'Time Condition'
                },
                // ÂÖÖÁîµ
                {
                    selector: 'span[data-i18n="charge"]',
                    chinese: 'ÂÖÖÁîµ',
                    english: 'Charge'
                },
                // ÊîæÁîµ
                {
                    selector: 'span[data-i18n="discharge"]',
                    chinese: 'ÊîæÁîµ',
                    english: 'Discharge'
                },
                // ÂÖÖÁîµÊù°‰ª∂
                {
                    selector: 'h4[data-i18n="chargeConditionSingle"]',
                    chinese: 'ÂÖÖÁîµÊù°‰ª∂',
                    english: 'Charge Condition'
                },
                // ÊîæÁîµÊù°‰ª∂
                {
                    selector: 'h4[data-i18n="dischargeConditionSingle"]',
                    chinese: 'ÊîæÁîµÊù°‰ª∂',
                    english: 'Discharge Condition'
                },
                // ‰ª∑Ê†ºÊù°‰ª∂
                {
                    selector: 'span[data-i18n="priceCondition"]',
                    chinese: '‰ª∑Ê†ºÊù°‰ª∂',
                    english: 'Price Condition'
                },
                // ‰Ωé‰∫é
                {
                    selector: 'span[data-i18n="lessThan"]',
                    chinese: '‰Ωé‰∫é',
                    english: 'Less than'
                },
                // È´ò‰∫é
                {
                    selector: 'span[data-i18n="greaterThan"]',
                    chinese: 'È´ò‰∫é',
                    english: 'Greater than'
                },
                // ÂèñÊ∂à
                {
                    selector: 'button[data-i18n="cancel"]',
                    chinese: 'ÂèñÊ∂à',
                    english: 'Cancel'
                },
                // ‰øùÂ≠òËÆæÁΩÆ
                {
                    selector: 'button[data-i18n="saveSettings"]',
                    chinese: '‰øùÂ≠òËÆæÁΩÆ',
                    english: 'Save Settings'
                }
            ];
            
            forcedUpdates.forEach(update => {
                const elements = document.querySelectorAll(update.selector);
                elements.forEach(element => {
                    if (element) {
                        const oldText = element.textContent;
                        const newText = currentLang === 'en' ? update.english : update.chinese;
                        element.textContent = newText;
                    }
                });
            });
            
            // È¢ùÂ§ñÂ§ÑÁêÜÊó∂Èó¥ÊÆµÂàóË°®‰∏≠ÁöÑÂä®ÊÄÅÂÜÖÂÆπ
            updateTimeSegmentListTranslations();
        }
        
        // Êõ¥Êñ∞Êó∂Èó¥ÊÆµÂàóË°®‰∏≠ÁöÑÂä®ÊÄÅÁøªËØëÂÜÖÂÆπ
        function updateTimeSegmentListTranslations() {
            if (!window.i18n || !window.i18n.isReady) return;
            
            const currentLang = window.i18n.getCurrentLanguage();
            
            // Êõ¥Êñ∞Á©∫Áä∂ÊÄÅÊèêÁ§∫ÊñáÊú¨
            const chargeContainer = document.getElementById('chargeTimeSegmentsList');
            if (chargeContainer && chargeContainer.innerHTML.includes('ÊöÇÊó†ÂÖÖÁîµÊó∂Èó¥ÊÆµ')) {
                const emptyText = currentLang === 'en' ? 'No charge time slots' : 'ÊöÇÊó†ÂÖÖÁîµÊó∂Èó¥ÊÆµ';
                chargeContainer.innerHTML = `<div style="color: rgba(255,255,255,0.5); font-size: 12px; padding: 8px;">${emptyText}</div>`;
            }
            
            const dischargeContainer = document.getElementById('dischargeTimeSegmentsList');
            if (dischargeContainer && dischargeContainer.innerHTML.includes('ÊöÇÊó†ÊîæÁîµÊó∂Èó¥ÊÆµ')) {
                const emptyText = currentLang === 'en' ? 'No discharge time slots' : 'ÊöÇÊó†ÊîæÁîµÊó∂Èó¥ÊÆµ';
                dischargeContainer.innerHTML = `<div style="color: rgba(255,255,255,0.5); font-size: 12px; padding: 8px;">${emptyText}</div>`;
            }
        }
        
        // ÊóßÂáΩÊï∞Â∑≤Â∫üÂºÉÔºåÁî± condition-settings-modal.js ‰∏≠ÁöÑÂêåÂêçÂáΩÊï∞Êõø‰ª£
        // function closeConditionSettingsModal() {
        //     console.log('Closing condition settings modal...');
        //     try {
        //         const modalContent = document.getElementById('modalContent');
        //         if (modalContent) {
        //             modalContent.style.display = 'none';
        //
        //             // Ê∏ÖÈô§localStorageÁä∂ÊÄÅ
        //             localStorage.removeItem('conditionSettingsModalOpen');
        //             localStorage.removeItem('modalPosition');
        //
        //             console.log('Modal closed successfully');
        //         } else {
        //             console.error('Modal content element not found when trying to close!');
        //         }
        //     } catch (error) {
        //         console.error('Error closing modal:', error);
        //     }
        // }
        
        // ÂàùÂßãÂåñÊó∂Èó¥ÊÆµÊòæÁ§∫
        function initTimeSegmentDisplay() {
            createTimeSegmentVisualizer();
            updateTimeSegmentDisplay();
        }
        
        // ÂàõÂª∫Êó∂Èó¥ÊÆµÂèØËßÜÂåñÂô®
        function createTimeSegmentVisualizer() {
            const container = document.getElementById('timeSegmentContainer');
            if (!container) return;
            
            container.innerHTML = `
                <div class="time-visualizer">
                    <div class="time-ruler">
                        <div class="time-hours"></div>
                        <div class="time-segments-display"></div>
                    </div>
                    <div class="time-controls">
                        <div class="segment-type-tabs">
                            <button class="segment-tab active" data-type="charge">ÂÖÖÁîµÊó∂Èó¥</button>
                            <button class="segment-tab" data-type="discharge">ÊîæÁîµÊó∂Èó¥</button>
                        </div>
                        <div class="segment-list"></div>
                        <button class="add-segment-btn">+ Ê∑ªÂä†Êó∂Èó¥ÊÆµ</button>
                    </div>
                </div>
            `;
            
            // ÂàõÂª∫Êó∂Èó¥ÂàªÂ∫¶
            const timeHours = container.querySelector('.time-hours');
            for (let i = 0; i < 24; i++) {
                const hour = document.createElement('div');
                hour.className = 'time-hour';
                hour.textContent = i.toString().padStart(2, '0') + ':00';
                hour.style.left = `${(i / 24) * 100}%`;
                timeHours.appendChild(hour);
            }
            
            // ÁªëÂÆö‰∫ã‰ª∂
            container.querySelectorAll('.segment-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    container.querySelectorAll('.segment-tab').forEach(t => t.classList.remove('active'));
                    e.target.classList.add('active');
                    updateTimeSegmentDisplay();
                });
            });
            
            container.querySelector('.add-segment-btn').addEventListener('click', () => {
                const activeType = container.querySelector('.segment-tab.active').dataset.type;
                showAddSegmentModal(activeType);
            });
        }
        
        // Êõ¥Êñ∞Êó∂Èó¥ÊÆµÊòæÁ§∫
        function updateTimeSegmentDisplay() {
            const container = document.getElementById('timeSegmentContainer');
            if (!container) return;
            
            const activeType = container.querySelector('.segment-tab.active').dataset.type;
            const segments = window.timeSegmentManager.getTimeSegments(activeType);
            const segmentsDisplay = container.querySelector('.time-segments-display');
            const segmentList = container.querySelector('.segment-list');
            
            // Ê∏ÖÁ©∫Áé∞ÊúâÊòæÁ§∫
            segmentsDisplay.innerHTML = '';
            segmentList.innerHTML = '';
            
            // ÊòæÁ§∫Êó∂Èó¥ÊÆµ
            segments.forEach((segment, index) => {
                // Âú®Êó∂Èó¥ËΩ¥‰∏äÊòæÁ§∫
                const segmentBar = createSegmentBar(segment, activeType);
                segmentsDisplay.appendChild(segmentBar);
                
                // Âú®ÂàóË°®‰∏≠ÊòæÁ§∫
                const segmentItem = createSegmentListItem(segment, activeType, index);
                segmentList.appendChild(segmentItem);
            });
        }
        
        // ÂàõÂª∫Êó∂Èó¥ÊÆµÊù°ÂΩ¢Âõæ
        function createSegmentBar(segment, type) {
            const bar = document.createElement('div');
            bar.className = 'time-segment-bar';
            bar.dataset.segmentId = segment.id;
            
            const startMinutes = window.timeSegmentManager.timeToMinutes(segment.start);
            const endMinutes = window.timeSegmentManager.timeToMinutes(segment.end);
            
            let left, width;
            if (endMinutes > startMinutes) {
                // Âêå‰∏ÄÂ§©
                left = (startMinutes / 1440) * 100;
                width = ((endMinutes - startMinutes) / 1440) * 100;
            } else {
                // Ë∑®Â§©
                left = (startMinutes / 1440) * 100;
                width = ((1440 - startMinutes + endMinutes) / 1440) * 100;
            }
            
            bar.style.left = left + '%';
            bar.style.width = width + '%';
            bar.style.backgroundColor = type === 'charge' ? '#00ff88' : '#FFC107';
            bar.style.opacity = '0.8';
            
            // Ê∑ªÂä†Êó∂Èó¥Ê†áÁ≠æ
            const label = document.createElement('span');
            label.className = 'segment-label';
            label.textContent = `${segment.start} - ${segment.end}`;
            bar.appendChild(label);
            
            return bar;
        }
        
        // ÂàõÂª∫Êó∂Èó¥ÊÆµÂàóË°®È°π
        function createSegmentListItem(segment, type, index) {
            const item = document.createElement('div');
            item.className = 'segment-list-item';
            item.innerHTML = `
                <div class="segment-info">
                    <span class="segment-time">${segment.start} - ${segment.end}</span>
                    <span class="segment-type">${type === 'charge' ? 'ÂÖÖÁîµ' : 'ÊîæÁîµ'}</span>
                </div>
                <div class="segment-actions">
                    <button class="edit-segment-btn" onclick="editTimeSegment('${segment.id}')">ÁºñËæë</button>
                    <button class="delete-segment-btn" onclick="deleteTimeSegment('${segment.id}')">Âà†Èô§</button>
                </div>
            `;
            
            return item;
        }
        
        // ÊòæÁ§∫Ê∑ªÂä†Êó∂Èó¥ÊÆµÂºπÁ™ó
        function showAddSegmentModal(type) {
            const modal = document.createElement('div');
            modal.className = 'add-segment-modal';
            modal.innerHTML = `
                <div class="modal-overlay">
                    <div class="modal-content">
                        <h3>Ê∑ªÂä†${type === 'charge' ? 'ÂÖÖÁîµ' : 'ÊîæÁîµ'}Êó∂Èó¥ÊÆµ</h3>
                        <div class="time-inputs">
                            <div class="input-group">
                                <label>ÂºÄÂßãÊó∂Èó¥</label>
                                <input type="time" id="segmentStart" value="09:00">
                            </div>
                            <div class="input-group">
                                <label>ÁªìÊùüÊó∂Èó¥</label>
                                <input type="time" id="segmentEnd" value="17:00">
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button class="cancel-btn" onclick="closeAddSegmentModal()">ÂèñÊ∂à</button>
                            <button class="confirm-btn" onclick="confirmAddSegment('${type}')">Á°ÆËÆ§</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.style.display = 'flex';
        }
        
        // Á°ÆËÆ§Ê∑ªÂä†Êó∂Èó¥ÊÆµ
        function confirmAddSegment(type) {
            const startTime = document.getElementById('segmentStart').value;
            const endTime = document.getElementById('segmentEnd').value;
            
            if (!startTime || !endTime) {
                alert(window.i18n && window.i18n.getCurrentLanguage() === 'en' ? 'Please select start and end time' : 'ËØ∑ÈÄâÊã©ÂºÄÂßãÂíåÁªìÊùüÊó∂Èó¥');
                return;
            }
            
            const newSegment = window.timeSegmentManager.addTimeSegment(type, startTime, endTime);
            if (newSegment) {
                updateTimeSegmentDisplay();
                closeAddSegmentModal();
            } else {
                alert(window.i18n && window.i18n.getCurrentLanguage() === 'en' ? 'Time slots overlap, please reselect' : 'Êó∂Èó¥ÊÆµÈáçÂè†ÔºåËØ∑ÈáçÊñ∞ÈÄâÊã©Êó∂Èó¥');
            }
        }
        
        // ÂÖ≥Èó≠Ê∑ªÂä†Êó∂Èó¥ÊÆµÂºπÁ™ó
        function closeAddSegmentModal() {
            const modal = document.querySelector('.add-segment-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // ÁºñËæëÊó∂Èó¥ÊÆµ
        function editTimeSegment(segmentId) {
            const allSegments = [...window.timeSegmentManager.chargeSegments, ...window.timeSegmentManager.dischargeSegments];
            const segment = allSegments.find(seg => seg.id === segmentId);
            if (!segment) return;
            
            const type = segmentId.startsWith('charge') ? 'charge' : 'discharge';
            
            const modal = document.createElement('div');
            modal.className = 'edit-segment-modal';
            modal.innerHTML = `
                <div class="modal-overlay">
                    <div class="modal-content">
                        <h3>ÁºñËæë${type === 'charge' ? 'ÂÖÖÁîµ' : 'ÊîæÁîµ'}Êó∂Èó¥ÊÆµ</h3>
                        <div class="time-inputs">
                            <div class="input-group">
                                <label>ÂºÄÂßãÊó∂Èó¥</label>
                                <input type="time" id="editSegmentStart" value="${segment.start}">
                            </div>
                            <div class="input-group">
                                <label>ÁªìÊùüÊó∂Èó¥</label>
                                <input type="time" id="editSegmentEnd" value="${segment.end}">
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button class="cancel-btn" onclick="closeEditSegmentModal()">ÂèñÊ∂à</button>
                            <button class="confirm-btn" onclick="confirmEditSegment('${segmentId}')">Á°ÆËÆ§</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.style.display = 'flex';
        }
        
        // Á°ÆËÆ§ÁºñËæëÊó∂Èó¥ÊÆµ
        function confirmEditSegment(segmentId) {
            const startTime = document.getElementById('editSegmentStart').value;
            const endTime = document.getElementById('editSegmentEnd').value;
            
            if (!startTime || !endTime) {
                alert('ËØ∑ÈÄâÊã©ÂºÄÂßãÂíåÁªìÊùüÊó∂Èó¥');
                return;
            }
            
            const success = window.timeSegmentManager.updateTimeSegment(segmentId, startTime, endTime);
            if (success) {
                updateTimeSegmentDisplay();
                closeEditSegmentModal();
            } else {
                alert('Êó∂Èó¥ÊÆµÈáçÂè†ÔºåËØ∑ÈáçÊñ∞ÈÄâÊã©Êó∂Èó¥');
            }
        }
        
        // ÂÖ≥Èó≠ÁºñËæëÊó∂Èó¥ÊÆµÂºπÁ™ó
        function closeEditSegmentModal() {
            const modal = document.querySelector('.edit-segment-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Âà†Èô§Êó∂Èó¥ÊÆµ
        function deleteTimeSegment(segmentId) {
            if (confirm(window.i18n && window.i18n.getCurrentLanguage() === 'en' ? 'Delete this time slot?' : 'Á°ÆËÆ§Âà†Èô§Ê≠§Êó∂Èó¥ÊÆµÔºü')) {
                window.timeSegmentManager.removeTimeSegment(segmentId);
                updateTimeSegmentDisplay();
            }
        }
        
        // Á°Æ‰øùÂáΩÊï∞ÂÖ®Â±ÄÂèØÁî®
        // window.openConditionSettingsModal = openConditionSettingsModal; // Â∑≤Ë¢´ condition-settings-modal.js Ë¶ÜÁõñ
        // window.closeConditionSettingsModal = closeConditionSettingsModal; // Â∑≤Ë¢´ condition-settings-modal.js Ë¶ÜÁõñ
        // window.saveConditionSettings = saveConditionSettings; // Â∑≤Ë¢´ condition-settings-modal.js Ë¶ÜÁõñ
        window.saveCurrentRegionSettings = saveCurrentRegionSettings;
        window.updateModalTranslations = updateModalTranslations;
        // window.checkAndRestoreModal = checkAndRestoreModal; // Â∑≤Ë¢´ condition-settings-modal.js Ë¶ÜÁõñ
        window.editTimeSegment = editTimeSegment;
        window.deleteTimeSegment = deleteTimeSegment;
        window.closeAddSegmentModal = closeAddSegmentModal;
        window.confirmAddSegment = confirmAddSegment;
        window.closeEditSegmentModal = closeEditSegmentModal;
        window.confirmEditSegment = confirmEditSegment;
        
        // Ë∞ÉËØïÂáΩÊï∞ - ÂèØ‰ª•Âú®ÊéßÂà∂Âè∞ÊâãÂä®Ë∞ÉÁî®
        window.forceModalTranslation = function() {
            updateModalTranslations();
        };
        
        // Ê∑ªÂä†ËØ≠Ë®ÄÂèòÂåñÁõëÂê¨Âô®ÔºåÁ°Æ‰øùÊ®°ÊÄÅÊ°ÜÂÜÖÂÆπ‰πü‰ºöÊõ¥Êñ∞
        document.addEventListener('languageChanged', function(event) {
            // Â¶ÇÊûúÊ®°ÊÄÅÊ°ÜÊòØÊâìÂºÄÁöÑÔºåÊõ¥Êñ∞ÂÖ∂ÁøªËØë
            const modalContent = document.getElementById('modalContent');
            if (modalContent && modalContent.style.display === 'block') {
                updateModalTranslations();
                setTimeout(() => {
                    updateModalTranslations();
                }, 50);
                setTimeout(() => {
                    updateModalTranslations();
                }, 200);
                setTimeout(() => {
                    updateModalTranslations();
                }, 500);
            }
        });
        
        // Âä†ËΩΩÂΩìÂâçÂú∞Âå∫ÁöÑÊù°‰ª∂ËÆæÁΩÆ
        function loadCurrentRegionConditionSettings() {
            const region = selectedMainRegion;
            if (!regionConditions[region]) {
                regionConditions[region] = {
                    charge: {
                        timeEnabled: true,
                        timeSegments: [{ start: '22:00', end: '06:00' }],
                        priceEnabled: true,
                        priceValue: 50
                    },
                    discharge: {
                        timeEnabled: true,
                        timeSegments: [{ start: '16:00', end: '21:00' }],
                        priceEnabled: true,
                        priceValue: 100
                    }
                };
            }
            
            const conditions = regionConditions[region];
            
            // Âä†ËΩΩÂÖÖÁîµÊù°‰ª∂
            const chargeTimeEnabledEl = document.getElementById('modalChargeTimeEnabled');
            const chargePriceEnabledEl = document.getElementById('modalChargePriceEnabled');
            const chargePriceValueEl = document.getElementById('modalChargePriceValue');
            
            
            if (chargeTimeEnabledEl) chargeTimeEnabledEl.checked = conditions.charge.timeEnabled;
            if (chargePriceEnabledEl) chargePriceEnabledEl.checked = conditions.charge.priceEnabled;
            if (chargePriceValueEl) chargePriceValueEl.value = conditions.charge.priceValue;
            
            // Âä†ËΩΩÊîæÁîµÊù°‰ª∂
            const dischargeTimeEnabledEl = document.getElementById('modalDischargeTimeEnabled');
            const dischargePriceEnabledEl = document.getElementById('modalDischargePriceEnabled');
            const dischargePriceValueEl = document.getElementById('modalDischargePriceValue');
            
            
            if (dischargeTimeEnabledEl) dischargeTimeEnabledEl.checked = conditions.discharge.timeEnabled;
            if (dischargePriceEnabledEl) dischargePriceEnabledEl.checked = conditions.discharge.priceEnabled;
            if (dischargePriceValueEl) dischargePriceValueEl.value = conditions.discharge.priceValue;
            
            // Á°Æ‰øùÂÖ®Â±ÄÂèòÈáèÂ∑≤ÂàùÂßãÂåñ
            window.chargeTimeSegments = window.chargeTimeSegments || [{ start: '22:00', end: '06:00' }];
            window.dischargeTimeSegments = window.dischargeTimeSegments || [{ start: '16:00', end: '21:00' }];
            
            // ÂàùÂßãÂåñÊó∂Èó¥ÊÆµÊï∞ÁªÑ
            chargeTimeSegments = [...(conditions.charge.timeSegments || [{ start: '22:00', end: '06:00' }])];
            dischargeTimeSegments = [...(conditions.discharge.timeSegments || [{ start: '16:00', end: '21:00' }])];
            
            // Êõ¥Êñ∞ÂÖ®Â±ÄÂèòÈáè
            window.chargeTimeSegments = chargeTimeSegments;
            window.dischargeTimeSegments = dischargeTimeSegments;
            
            // ÂàùÂßãÂåñÊñ∞Á≥ªÁªüÁöÑÊó∂Èó¥Êù°‰ª∂Êï∞ÊçÆÔºåÁ°Æ‰øùÊØè‰∏™segmentÈÉΩÊúâtypeÂ±ûÊÄß
            timeConditionSegments.charge = chargeTimeSegments.map(seg => ({
                ...seg,
                type: 'charge',
                id: seg.id || Date.now().toString() + Math.random()
            }));
            timeConditionSegments.discharge = dischargeTimeSegments.map(seg => ({
                ...seg,
                type: 'discharge',
                id: seg.id || Date.now().toString() + Math.random()
            }));
            
            
            // Âª∂ËøüÊ∏≤Êüì‰ª•Á°Æ‰øù DOM ÂÖÉÁ¥†Â∑≤ÁªèÂä†ËΩΩ
            setTimeout(() => {
                renderTimeSegments();
                updateTimeline();
                toggleConditionSettings();
                
                // Êõ¥Êñ∞Êñ∞Á≥ªÁªüÁöÑÊó∂Èó¥ËΩ¥ÊòæÁ§∫
                updateTimelineDisplay();
                updateTimeSegmentsList();
            }, 100);
        }
        
        // ‰øùÂ≠òÂΩìÂâçÂú∞Âå∫ÁöÑËÆæÁΩÆ
        function saveCurrentRegionSettings() {
            const region = selectedMainRegion;
            
            try {
                if (!regionConditions[region]) {
                    regionConditions[region] = {
                        charge: {},
                        discharge: {}
                    };
                }
                
                // Ëé∑ÂèñÂÖÉÁ¥†Âπ∂Ê£ÄÊü•ÊòØÂê¶Â≠òÂú®
                const chargeTimeEnabledEl = document.getElementById('modalChargeTimeEnabled');
                const chargePriceEnabledEl = document.getElementById('modalChargePriceEnabled');
                const chargePriceValueEl = document.getElementById('modalChargePriceValue');
                const dischargeTimeEnabledEl = document.getElementById('modalDischargeTimeEnabled');
                const dischargePriceEnabledEl = document.getElementById('modalDischargePriceEnabled');
                const dischargePriceValueEl = document.getElementById('modalDischargePriceValue');
                
                // ‰øùÂ≠òÂÖÖÁîµÊù°‰ª∂Ôºå‰ΩøÁî®Êñ∞Á≥ªÁªüÁöÑÊï∞ÊçÆÔºàÂåÖÂê´typeÂ±ûÊÄßÔºâ
                regionConditions[region].charge = {
                    timeEnabled: chargeTimeEnabledEl ? chargeTimeEnabledEl.checked : true,
                    timeSegments: timeConditionSegments.charge.map(seg => ({
                        start: seg.start,
                        end: seg.end,
                        type: 'charge',
                        id: seg.id
                    })),
                    priceEnabled: chargePriceEnabledEl ? chargePriceEnabledEl.checked : true,
                    priceCondition: 'below', // Âõ∫ÂÆö‰∏∫‰Ωé‰∫é
                    priceValue: chargePriceValueEl ? parseFloat(chargePriceValueEl.value) : 50
                };
                
                // ‰øùÂ≠òÊîæÁîµÊù°‰ª∂Ôºå‰ΩøÁî®Êñ∞Á≥ªÁªüÁöÑÊï∞ÊçÆÔºàÂåÖÂê´typeÂ±ûÊÄßÔºâ
                regionConditions[region].discharge = {
                    timeEnabled: dischargeTimeEnabledEl ? dischargeTimeEnabledEl.checked : true,
                    timeSegments: timeConditionSegments.discharge.map(seg => ({
                        start: seg.start,
                        end: seg.end,
                        type: 'discharge',
                        id: seg.id
                    })),
                    priceEnabled: dischargePriceEnabledEl ? dischargePriceEnabledEl.checked : true,
                    priceCondition: 'above', // Âõ∫ÂÆö‰∏∫È´ò‰∫é
                    priceValue: dischargePriceValueEl ? parseFloat(dischargePriceValueEl.value) : 100
                };
                
                
                // ‰øùÂ≠òÂà∞localStorage
                localStorage.setItem('regionConditions', JSON.stringify(regionConditions));
                
                // ÂÖ≥Èó≠ÂºπÁ™ó
                closeConditionSettingsModal();
                
                // Êõ¥Êñ∞Ëá™Âä®Êù°‰ª∂ÊòæÁ§∫
                if (typeof updateAutoConditionsDisplay === 'function') {
                    updateAutoConditionsDisplay();
                }
                
                
                // ÊòæÁ§∫‰øùÂ≠òÊàêÂäüÊèêÁ§∫
                alert(window.i18n && window.i18n.getCurrentLanguage() === 'en' ? 'Settings saved!' : 'ËÆæÁΩÆÂ∑≤‰øùÂ≠òÊàêÂäüÔºÅ');
            } catch (error) {
                console.error('‰øùÂ≠òËÆæÁΩÆÊó∂Âá∫Èîô:', error);
                alert((window.i18n && window.i18n.getCurrentLanguage() === 'en' ? 'Save failed: ' : '‰øùÂ≠òËÆæÁΩÆÂ§±Ë¥•Ôºö') + error.message);
            }
        }
        
        // ‰øùÁïôÂéüÊúâÁöÑloadAllConditionSettingsÂáΩÊï∞‰ª•Èò≤ÂÖºÂÆπÊÄßÈóÆÈ¢ò
        function loadAllConditionSettings() {
            const regions = ['NSW', 'QLD', 'VIC', 'SA', 'TAS'];
            
            regions.forEach(region => {
                // ÂÖÖÁîµÊù°‰ª∂
                const chargeStartElement = document.getElementById(`chargeStart${region}`);
                const chargeEndElement = document.getElementById(`chargeEnd${region}`);
                const chargePriceConditionElement = document.getElementById(`chargePriceCondition${region}`);
                const chargePriceValueElement = document.getElementById(`chargePriceValue${region}`);
                
                if (chargeStartElement && chargeEndElement && chargePriceConditionElement && chargePriceValueElement) {
                    // ‰ªélocalStorageÊàñ‰ΩøÁî®ÈªòËÆ§ÂÄº
                    const savedChargeData = localStorage.getItem(`charge_${region}`);
                    if (savedChargeData) {
                        try {
                            const data = JSON.parse(savedChargeData);
                            chargeStartElement.value = data.startTime || '22:00';
                            chargeEndElement.value = data.endTime || '06:00';
                            chargePriceConditionElement.value = data.priceCondition || 'below';
                            chargePriceValueElement.value = data.priceValue || '50';
                        } catch (e) {
                            console.error('Error loading charge data for', region, e);
                        }
                    }
                }
                
                // ÊîæÁîµÊù°‰ª∂
                const dischargeStartElement = document.getElementById(`dischargeStart${region}`);
                const dischargeEndElement = document.getElementById(`dischargeEnd${region}`);
                const dischargePriceConditionElement = document.getElementById(`dischargePriceCondition${region}`);
                const dischargePriceValueElement = document.getElementById(`dischargePriceValue${region}`);
                
                if (dischargeStartElement && dischargeEndElement && dischargePriceConditionElement && dischargePriceValueElement) {
                    // ‰ªélocalStorageÊàñ‰ΩøÁî®ÈªòËÆ§ÂÄº
                    const savedDischargeData = localStorage.getItem(`discharge_${region}`);
                    if (savedDischargeData) {
                        try {
                            const data = JSON.parse(savedDischargeData);
                            dischargeStartElement.value = data.startTime || '17:00';
                            dischargeEndElement.value = data.endTime || '21:00';
                            dischargePriceConditionElement.value = data.priceCondition || 'above';
                            dischargePriceValueElement.value = data.priceValue || '120';
                        } catch (e) {
                            console.error('Error loading discharge data for', region, e);
                        }
                    }
                }
            });
        }
        
        // ‰øùÂ≠òÊâÄÊúâÂú∞Âå∫ÁöÑÊù°‰ª∂ËÆæÁΩÆ
        function saveAllConditionSettings() {
            const regions = ['NSW', 'QLD', 'VIC', 'SA', 'TAS'];
            let savedCount = 0;
            
            regions.forEach(region => {
                // ‰øùÂ≠òÂÖÖÁîµÊù°‰ª∂
                const chargeData = {
                    startTime: document.getElementById(`chargeStart${region}`)?.value || '22:00',
                    endTime: document.getElementById(`chargeEnd${region}`)?.value || '06:00',
                    priceCondition: document.getElementById(`chargePriceCondition${region}`)?.value || 'below',
                    priceValue: document.getElementById(`chargePriceValue${region}`)?.value || '50'
                };
                
                localStorage.setItem(`charge_${region}`, JSON.stringify(chargeData));
                
                // ‰øùÂ≠òÊîæÁîµÊù°‰ª∂
                const dischargeData = {
                    startTime: document.getElementById(`dischargeStart${region}`)?.value || '17:00',
                    endTime: document.getElementById(`dischargeEnd${region}`)?.value || '21:00',
                    priceCondition: document.getElementById(`dischargePriceCondition${region}`)?.value || 'above',
                    priceValue: document.getElementById(`dischargePriceValue${region}`)?.value || '120'
                };
                
                localStorage.setItem(`discharge_${region}`, JSON.stringify(dischargeData));
                savedCount++;
            });
            
            // ÂÖ≥Èó≠ÂºπÁ™ó
            closeConditionSettingsModal();
            
            // ÊòæÁ§∫‰øùÂ≠òÊàêÂäüÊèêÁ§∫
            showAutoOperationNotification('ËÆæÁΩÆ', `Â∑≤‰øùÂ≠ò${savedCount}‰∏™Âú∞Âå∫ÁöÑËá™Âä®ÂåñÊù°‰ª∂ËÆæÁΩÆ`);
            
        }
        
        // Êù°‰ª∂ÂºÄÂÖ≥ÂáΩÊï∞
        function toggleConditionSettings() {
            // ÂÖÖÁîµÊó∂Èó¥Êù°‰ª∂
            const chargeTimeEnabled = document.getElementById('chargeTimeEnabled')?.checked;
            const chargeTimeSettings = document.getElementById('chargeTimeSettings');
            if (chargeTimeSettings) {
                chargeTimeSettings.style.opacity = chargeTimeEnabled ? '1' : '0.5';
                chargeTimeSettings.style.pointerEvents = chargeTimeEnabled ? 'auto' : 'none';
            }
            
            // ÂÖÖÁîµ‰ª∑Ê†ºÊù°‰ª∂
            const chargePriceEnabled = document.getElementById('chargePriceEnabled')?.checked;
            const chargePriceSettings = document.getElementById('chargePriceSettings');
            if (chargePriceSettings) {
                chargePriceSettings.style.opacity = chargePriceEnabled ? '1' : '0.5';
                chargePriceSettings.style.pointerEvents = chargePriceEnabled ? 'auto' : 'none';
            }
            
            // ÊîæÁîµÊó∂Èó¥Êù°‰ª∂
            const dischargeTimeEnabled = document.getElementById('dischargeTimeEnabled')?.checked;
            const dischargeTimeSettings = document.getElementById('dischargeTimeSettings');
            if (dischargeTimeSettings) {
                dischargeTimeSettings.style.opacity = dischargeTimeEnabled ? '1' : '0.5';
                dischargeTimeSettings.style.pointerEvents = dischargeTimeEnabled ? 'auto' : 'none';
            }
            
            // ÊîæÁîµ‰ª∑Ê†ºÊù°‰ª∂
            const dischargePriceEnabled = document.getElementById('dischargePriceEnabled')?.checked;
            const dischargePriceSettings = document.getElementById('dischargePriceSettings');
            if (dischargePriceSettings) {
                dischargePriceSettings.style.opacity = dischargePriceEnabled ? '1' : '0.5';
                dischargePriceSettings.style.pointerEvents = dischargePriceEnabled ? 'auto' : 'none';
            }
        }
        
        // Ê∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨
        setTimeout(() => {
            const checkboxes = [
                'chargeTimeEnabled',
                'chargePriceEnabled', 
                'dischargeTimeEnabled',
                'dischargePriceEnabled'
            ];
            
            checkboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) {
                    checkbox.addEventListener('change', toggleConditionSettings);
                }
            });
        }, 500);
        
        // Â§öÊÆµÊó∂Èó¥ÁÆ°ÁêÜ - ‰ΩøÁî®Â∑≤ÁªèÂú®È°∂ÈÉ®Â£∞ÊòéÁöÑÂÖ®Â±ÄÂèòÈáè
        
        // Ê∑ªÂä†ÂÖÖÁîµÊó∂Èó¥ÊÆµ
        function addChargeTimeSegment() {
            const newSegment = { start: '22:00', end: '06:00' };
            window.chargeTimeSegments.push(newSegment);
            chargeTimeSegments = window.chargeTimeSegments;
            renderTimeSegments();
            updateTimeline();
            // ÈáçÊñ∞ÁªëÂÆö‰∫ã‰ª∂
            setTimeout(() => bindTimeInputEvents(), 50);
        }
        
        // Ê∑ªÂä†ÊîæÁîµÊó∂Èó¥ÊÆµ
        function addDischargeTimeSegment() {
            const newSegment = { start: '16:00', end: '21:00' };
            window.dischargeTimeSegments.push(newSegment);
            dischargeTimeSegments = window.dischargeTimeSegments;
            renderTimeSegments();
            updateTimeline();
            // ÈáçÊñ∞ÁªëÂÆö‰∫ã‰ª∂
            setTimeout(() => bindTimeInputEvents(), 50);
        }
        
        // Ê∏≤ÊüìÊó∂Èó¥ÊÆµ
        function renderTimeSegments() {
            
            // Ê∏≤ÊüìÂÖÖÁîµÊó∂Èó¥ÊÆµ
            const chargeContainer = document.getElementById('chargeTimeSegments');
            if (chargeContainer) {
                chargeContainer.innerHTML = '';
                chargeTimeSegments.forEach((segment, index) => {
                    const segmentDiv = createTimeSegmentElement(segment, index, 'charge');
                    chargeContainer.appendChild(segmentDiv);
                });
            } else {
                console.warn('chargeTimeSegments container not found');
            }
            
            // Ê∏≤ÊüìÊîæÁîµÊó∂Èó¥ÊÆµ
            const dischargeContainer = document.getElementById('dischargeTimeSegments');
            if (dischargeContainer) {
                dischargeContainer.innerHTML = '';
                dischargeTimeSegments.forEach((segment, index) => {
                    const segmentDiv = createTimeSegmentElement(segment, index, 'discharge');
                    dischargeContainer.appendChild(segmentDiv);
                });
            } else {
                console.warn('dischargeTimeSegments container not found');
            }
        }
        
        // ÂàõÂª∫Êó∂Èó¥ÊÆµÂÖÉÁ¥†
        function createTimeSegmentElement(segment, index, type) {
            const segmentDiv = document.createElement('div');
            segmentDiv.className = 'time-segment';
            segmentDiv.style.cssText = 'display: flex; align-items: center; gap: 8px; padding: 6px; background: rgba(255,255,255,0.05); border-radius: 6px; border: 1px solid rgba(255,255,255,0.1);';
            
            const color = type === 'charge' ? '#00ff88' : '#FFC107';
            
            segmentDiv.innerHTML = `
                <span style="color: ${color}; font-size: 12px; min-width: 20px; font-weight: 500;">${index + 1}.</span>
                <input type="time" value="${segment.start}" data-index="${index}" data-field="start" data-type="${type}" class="time-input" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 4px 6px; border-radius: 6px; font-size: 11px; outline: none; width: 70px;">
                <span style="color: rgba(255,255,255,0.6); font-size: 12px;">-</span>
                <input type="time" value="${segment.end}" data-index="${index}" data-field="end" data-type="${type}" class="time-input" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 4px 6px; border-radius: 6px; font-size: 11px; outline: none; width: 70px;">
                <button onclick="removeTimeSegment(${index}, '${type}')" style="background: rgba(255,0,0,0.2); border: 1px solid rgba(255,0,0,0.3); color: #ff6b6b; padding: 2px 6px; border-radius: 6px; font-size: 10px; cursor: pointer; transition: all 0.3s;">√ó</button>
            `;
            
            return segmentDiv;
        }
        
        // ÁªëÂÆöÊó∂Èó¥ËæìÂÖ•‰∫ã‰ª∂
        function bindTimeInputEvents() {
            // ÁßªÈô§ÊóßÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
            if (window.timeInputHandler) {
                document.removeEventListener('change', window.timeInputHandler);
            }
            
            // ÂàõÂª∫Êñ∞ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
            window.timeInputHandler = function(e) {
                if (e.target.classList.contains('time-input')) {
                    const index = parseInt(e.target.getAttribute('data-index'));
                    const field = e.target.getAttribute('data-field');
                    const type = e.target.getAttribute('data-type');
                    const value = e.target.value;
                    
                    updateTimeSegment(index, field, value, type);
                }
            };
            
            document.addEventListener('change', window.timeInputHandler);
        }
        
        // Êõ¥Êñ∞Êó∂Èó¥ÊÆµ
        function updateTimeSegment(index, field, value, type) {
            
            if (type === 'charge' && index < chargeTimeSegments.length) {
                chargeTimeSegments[index][field] = value;
            } else if (type === 'discharge' && index < dischargeTimeSegments.length) {
                dischargeTimeSegments[index][field] = value;
            }
            
            // Ê£ÄÊü•Âπ∂Ëß£ÂÜ≥ÂÜ≤Á™Å
            resolveTimeConflicts();
            updateTimeline();
        }
        
        // Âà†Èô§Êó∂Èó¥ÊÆµ
        function removeTimeSegment(index, type) {
            if (type === 'charge') {
                chargeTimeSegments.splice(index, 1);
            } else {
                dischargeTimeSegments.splice(index, 1);
            }
            
            renderTimeSegments();
            updateTimeline();
        }
        
        // Ëß£ÂÜ≥Êó∂Èó¥ÂÜ≤Á™ÅÔºàÊñ∞ÁöÑË¶ÜÁõñÊóßÁöÑÔºâ
        function resolveTimeConflicts() {
            
            // ÂÖàËß£ÂÜ≥ÂÖÖÁîµÂÜÖÈÉ®ÂÜ≤Á™Å
            const originalChargeLength = chargeTimeSegments.length;
            chargeTimeSegments = resolveInternalConflicts(chargeTimeSegments);
            
            // ÂÜçËß£ÂÜ≥ÊîæÁîµÂÜÖÈÉ®ÂÜ≤Á™Å
            const originalDischargeLength = dischargeTimeSegments.length;
            dischargeTimeSegments = resolveInternalConflicts(dischargeTimeSegments);
            
            // ÊúÄÂêéËß£ÂÜ≥ÂÖÖÁîµÂíåÊîæÁîµ‰πãÈó¥ÁöÑÂÜ≤Á™Å
            resolveCrossTypeConflicts();
            
            // Âè™Âú®Êï∞ÈáèÂèëÁîüÂèòÂåñÊó∂ÊâçÈáçÊñ∞Ê∏≤Êüì
            if (chargeTimeSegments.length !== originalChargeLength || dischargeTimeSegments.length !== originalDischargeLength) {
                renderTimeSegments();
            }
        }
        
        // Ëß£ÂÜ≥ÂÜÖÈÉ®ÂÜ≤Á™Å
        function resolveInternalConflicts(segments) {
            const resolved = [];
            
            segments.forEach(newSegment => {
                let hasConflict = false;
                
                // Ê£ÄÊü•‰∏éÂ∑≤Â≠òÂú®ÊÆµÁöÑÂÜ≤Á™Å
                for (let i = resolved.length - 1; i >= 0; i--) {
                    if (timeSegmentsOverlap(newSegment, resolved[i])) {
                        // ÊúâÂÜ≤Á™ÅÔºåÂà†Èô§ÊóßÁöÑ
                        resolved.splice(i, 1);
                        hasConflict = true;
                    }
                }
                
                resolved.push(newSegment);
            });
            
            return resolved;
        }
        
        // Ëß£ÂÜ≥ÂÖÖÁîµÂíåÊîæÁîµ‰πãÈó¥ÁöÑÂÜ≤Á™Å
        function resolveCrossTypeConflicts() {
            const allSegments = [
                ...chargeTimeSegments.map(s => ({ ...s, type: 'charge', index: chargeTimeSegments.indexOf(s) })),
                ...dischargeTimeSegments.map(s => ({ ...s, type: 'discharge', index: dischargeTimeSegments.indexOf(s) }))
            ];
            
            // ÊåâÊ∑ªÂä†È°∫Â∫èÊéíÂ∫èÔºàÊñ∞ÁöÑÂú®ÂêéÔºâ
            for (let i = allSegments.length - 1; i >= 0; i--) {
                const current = allSegments[i];
                
                for (let j = i - 1; j >= 0; j--) {
                    const other = allSegments[j];
                    
                    if (timeSegmentsOverlap(current, other)) {
                        // ÊúâÂÜ≤Á™ÅÔºåÂà†Èô§ËæÉÊó©ÁöÑÈÇ£‰∏™
                        if (other.type === 'charge') {
                            chargeTimeSegments.splice(other.index, 1);
                        } else {
                            dischargeTimeSegments.splice(other.index, 1);
                        }
                        
                        // Êõ¥Êñ∞Á¥¢Âºï
                        allSegments.splice(j, 1);
                        i--; // Ë∞ÉÊï¥ÂΩìÂâçÁ¥¢Âºï
                    }
                }
            }
        }
        
        // Âà§Êñ≠Êó∂Èó¥ÊÆµÊòØÂê¶ÈáçÂè†
        function timeSegmentsOverlap(segment1, segment2) {
            const start1 = timeToMinutes(segment1.start);
            const end1 = timeToMinutes(segment1.end);
            const start2 = timeToMinutes(segment2.start);
            const end2 = timeToMinutes(segment2.end);
            
            // Â§ÑÁêÜË∑®Â§úÊÉÖÂÜµ
            const isOvernight1 = end1 < start1;
            const isOvernight2 = end2 < start2;
            
            if (isOvernight1 && isOvernight2) {
                return true; // ‰∏§‰∏™ÈÉΩË∑®Â§úÔºåËÆ§‰∏∫ÊúâÈáçÂè†
            } else if (isOvernight1) {
                return (start2 >= start1 || end2 <= end1);
            } else if (isOvernight2) {
                return (start1 >= start2 || end1 <= end2);
            } else {
                return (start1 < end2 && start2 < end1);
            }
        }
        
        // Êó∂Èó¥ËΩ¨Êç¢‰∏∫ÂàÜÈíü
        function timeToMinutes(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }
        
        // Êõ¥Êñ∞Êó∂Èó¥ËΩ¥ÊòæÁ§∫ - Â∑≤Â∫üÂºÉÔºåÁî± condition-settings-modal.js ‰∏≠ÁöÑ updateTimelineDisplay() Êõø‰ª£
        function updateTimeline() {
            // ‚ö†Ô∏è ‰∏çË¶ÅÊ∏ÖÁ©∫ timelineDisplayÔºåÊñ∞Á≥ªÁªü‰ΩøÁî® chargeTimelineBlocks Âíå dischargeTimelineBlocks
            // Êóß‰ª£Á†Å‰ºöÂπ≤Êâ∞Êñ∞ÁöÑÊó∂Èó¥ËΩ¥Ê∏≤ÊüìÁ≥ªÁªüÔºåÊâÄ‰ª•Ëøô‰∏™ÂáΩÊï∞Áé∞Âú®‰ªÄ‰πàÈÉΩ‰∏çÂÅö

            // const timelineDisplay = document.getElementById('timelineDisplay');
            // if (!timelineDisplay) return;
            // timelineDisplay.innerHTML = '';  // ‚ùå ËøôË°å‰ª£Á†Å‰ºöÊ∏ÖÁ©∫Êó∂Èó¥ËΩ¥ÔºÅ

            // ‰∏çÂú®Êó∂Èó¥ËΩ¥‰∏äÊòæÁ§∫Êó∂Èó¥ÊÆµÔºåÂè™Âú®Êó∂Èó¥Êù°‰ª∂Âç°Áâá‰∏≠ÊòæÁ§∫
            // // ÊòæÁ§∫ÂÖÖÁîµÊó∂Èó¥ÊÆµ
            // chargeTimeSegments.forEach(segment => {
            //     const segmentBar = createTimelineSegment(segment, 'charge');
            //     timelineDisplay.appendChild(segmentBar);
            // });

            // // ÊòæÁ§∫ÊîæÁîµÊó∂Èó¥ÊÆµ
            // dischargeTimeSegments.forEach(segment => {
            //     const segmentBar = createTimelineSegment(segment, 'discharge');
            //     timelineDisplay.appendChild(segmentBar);
            // });
        }
        
        // ÂàõÂª∫Êó∂Èó¥ËΩ¥ÊÆµ
        function createTimelineSegment(segment, type) {
            const startHour = parseFloat(segment.start.replace(':', '.'));
            const endHour = parseFloat(segment.end.replace(':', '.'));
            
            const div = document.createElement('div');
            const color = type === 'charge' ? 'linear-gradient(135deg, #00ff88, #00dd77)' : 'linear-gradient(135deg, #FFC107, #FFB300)';
            
            if (endHour < startHour) {
                // Ë∑®Â§úÊÉÖÂÜµÔºåÂàÜ‰∏§ÊÆµÊòæÁ§∫
                const container = document.createElement('div');
                
                // Á¨¨‰∏ÄÊÆµ
                const part1 = document.createElement('div');
                const leftPercent1 = (startHour / 24) * 100;
                const widthPercent1 = ((24 - startHour) / 24) * 100;
                part1.style.cssText = `
                    position: absolute;
                    left: ${leftPercent1}%;
                    width: ${widthPercent1}%;
                    height: 24px;
                    background: ${color};
                    border-radius: 10px;
                    top: 4px;
                    opacity: 0.8;
                    transition: all 0.3s;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: #000;
                    font-size: 10px;
                    font-weight: 600;
                `;
                part1.innerHTML = `${segment.start}-24:00`;
                
                // Á¨¨‰∫åÊÆµ
                const part2 = document.createElement('div');
                const widthPercent2 = (endHour / 24) * 100;
                part2.style.cssText = `
                    position: absolute;
                    left: 0%;
                    width: ${widthPercent2}%;
                    height: 24px;
                    background: ${color};
                    border-radius: 10px;
                    top: 4px;
                    opacity: 0.8;
                    transition: all 0.3s;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: #000;
                    font-size: 10px;
                    font-weight: 600;
                `;
                part2.innerHTML = `00:00-${segment.end}`;
                
                container.appendChild(part1);
                container.appendChild(part2);
                return container;
            } else {
                // Ê≠£Â∏∏ÊÉÖÂÜµ
                const leftPercent = (startHour / 24) * 100;
                const widthPercent = ((endHour - startHour) / 24) * 100;
                
                div.style.cssText = `
                    position: absolute;
                    left: ${leftPercent}%;
                    width: ${widthPercent}%;
                    height: 24px;
                    background: ${color};
                    border-radius: 10px;
                    top: 4px;
                    opacity: 0.8;
                    transition: all 0.3s;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: #000;
                    font-size: 10px;
                    font-weight: 600;
                `;
                
                div.innerHTML = `${segment.start}-${segment.end}`;
                
                // Ê∑ªÂä†ÊÇ¨ÂÅúÊïàÊûú
                div.onmouseenter = () => {
                    div.style.opacity = '1';
                    div.style.transform = 'scale(1.02)';
                };
                div.onmouseleave = () => {
                    div.style.opacity = '0.8';
                    div.style.transform = 'scale(1)';
                };
                
                return div;
            }
        }
        
        // Êõ¥Êñ∞Êó∂Èó¥ËΩ¥ÊòæÁ§∫ÔºàÂêå updateTimelineÔºâ
        function updateTimelineDisplay() {
            updateTimeline();
        }
        
        // ÂàõÂª∫Êó∂Èó¥ËΩ¥ÊÆµÔºàÂêå createTimelineSegmentÔºâ
        function createTimeSegmentBar(segment) {
            return createTimelineSegment(segment, segment.type || 'charge');
        }
        
        // Ê£ÄÊü•Êó∂Èó¥ÂÜ≤Á™ÅÔºàÂÖºÂÆπÊÄßÊé•Âè£Ôºâ
        function checkTimeConflicts(chargeSegments, dischargeSegments) {
            resolveTimeConflicts();
        }

        // ============== Êó∂Èó¥Êù°‰ª∂ÁÆ°ÁêÜÁ≥ªÁªü ==============
        
        // Êó∂Èó¥Êù°‰ª∂Áä∂ÊÄÅÁÆ°ÁêÜÔºàÂèòÈáèÂ∑≤Âú®È°∂ÈÉ®Â£∞ÊòéÔºâ
        
        let currentTimeSelectionMode = null; // 'charge' Êàñ 'discharge'
        let timeSelection = {
            isSelecting: false,
            startX: 0,
            current: null // { start: '09:00', end: '17:00', type: 'charge' }
        };

        // ËÆæÁΩÆÊó∂Èó¥ÈÄâÊã©Ê®°Âºè
        function setTimeSelectionMode(mode) {
            
            // Á°Æ‰øù timeConditionSegments Â∑≤ÂàùÂßãÂåñ
            if (!timeConditionSegments.charge || !timeConditionSegments.discharge) {
                console.error('timeConditionSegments not properly initialized!');
                timeConditionSegments = {
                    charge: [],
                    discharge: []
                };
            }
            
            currentTimeSelectionMode = mode;
            
            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            const chargeBtn = document.getElementById('chargeSelectBtn');
            const dischargeBtn = document.getElementById('dischargeSelectBtn');
            const selectionBox = document.getElementById('timeSelectionBox');
            const interactArea = document.getElementById('timelineInteractArea');
            
            // ÈáçÁΩÆÊâÄÊúâÊåâÈíÆ
            chargeBtn.style.background = 'rgba(0,255,136,0.15)';
            chargeBtn.style.borderColor = 'rgba(0,255,136,0.3)';
            dischargeBtn.style.background = 'rgba(255,193,7,0.15)';
            dischargeBtn.style.borderColor = 'rgba(255,193,7,0.3)';
            
            if (mode === 'charge') {
                chargeBtn.style.background = 'rgba(0,255,136,0.3)';
                chargeBtn.style.borderColor = '#00ff88';
                if (selectionBox) {
                    selectionBox.style.background = 'rgba(0,255,136,0.3)';
                    selectionBox.style.borderColor = '#00ff88';
                }
                interactArea.style.cursor = 'crosshair';
            } else if (mode === 'discharge') {
                dischargeBtn.style.background = 'rgba(255,193,7,0.3)';
                dischargeBtn.style.borderColor = '#FFC107';
                if (selectionBox) {
                    selectionBox.style.background = 'rgba(255,193,7,0.3)';
                    selectionBox.style.borderColor = '#FFC107';
                }
                interactArea.style.cursor = 'crosshair';
            }
            
            // ÁªëÂÆöÊãñÊãΩ‰∫ã‰ª∂ÔºàÂè™‰ºöÁªëÂÆö‰∏ÄÊ¨°Ôºâ
            bindTimeSelectionEvents();
            
            
            // Á°Æ‰øùÊó∂Èó¥ÊÆµÊòæÁ§∫Ê≠£Á°Æ
            updateTimelineDisplay();
            updateTimeSegmentsList();
        }

        // ÂÖ®Â±ÄÂèòÈáèÁî®‰∫é‰∫ã‰ª∂Â§ÑÁêÜ
        let timeSelectionEventsBound = false;
        let isDraggingGlobal = false;
        let startXGlobal = 0;

        // ÁªëÂÆöÊó∂Èó¥ÈÄâÊã©ÊãñÊãΩ‰∫ã‰ª∂ÔºàÂè™ÁªëÂÆö‰∏ÄÊ¨°Ôºâ
        function bindTimeSelectionEvents() {
            if (timeSelectionEventsBound) {
                return; // Èò≤Ê≠¢ÈáçÂ§çÁªëÂÆö
            }
            
            const interactArea = document.getElementById('timelineInteractArea');
            if (!interactArea) {
                console.error('timelineInteractArea not found!');
                return;
            }
            
            
            // Èº†Ê†áÊåâ‰∏ã
            interactArea.addEventListener('mousedown', (e) => {
                if (!currentTimeSelectionMode) return;
                
                isDraggingGlobal = true;
                timeSelection.isSelecting = true;
                startXGlobal = e.clientX - interactArea.getBoundingClientRect().left;
                timeSelection.startX = startXGlobal;
                
                const selectionBox = document.getElementById('timeSelectionBox');
                if (selectionBox) {
                    selectionBox.style.display = 'block';
                    selectionBox.style.left = startXGlobal + 'px';
                    selectionBox.style.width = '0px';
                }
                
                e.preventDefault();
            });
            
            // Èº†Ê†áÁßªÂä®
            interactArea.addEventListener('mousemove', (e) => {
                if (!isDraggingGlobal || !currentTimeSelectionMode) return;
                
                const currentX = e.clientX - interactArea.getBoundingClientRect().left;
                const selectionBox = document.getElementById('timeSelectionBox');
                
                const left = Math.min(startXGlobal, currentX);
                const width = Math.abs(currentX - startXGlobal);
                
                if (selectionBox) {
                    selectionBox.style.left = left + 'px';
                    selectionBox.style.width = width + 'px';
                }
                
                // ÂÆûÊó∂ËÆ°ÁÆóÊó∂Èó¥ËåÉÂõ¥
                updateCurrentTimeSelection(left, width, interactArea.getBoundingClientRect().width);
            });
            
            // Èº†Ê†áÊä¨Ëµ∑
            interactArea.addEventListener('mouseup', (e) => {
                
                if (!isDraggingGlobal || !currentTimeSelectionMode) {
                    return;
                }
                
                isDraggingGlobal = false;
                timeSelection.isSelecting = false;
                
                const currentX = e.clientX - interactArea.getBoundingClientRect().left;
                const totalWidth = interactArea.getBoundingClientRect().width;
                const left = Math.min(startXGlobal, currentX);
                const width = Math.abs(currentX - startXGlobal);
                
                
                if (width > 10) { // ÊúÄÂ∞èÊãñÊãΩË∑ùÁ¶ª
                    updateCurrentTimeSelection(left, width, totalWidth);
                    
                    // Ëá™Âä®Ê∑ªÂä†Êó∂Èó¥ÊÆµ
                    autoAddTimeSegment();
                } else {
                    // Ê∏ÖÈô§ÈÄâÊã©
                    clearTimeSelection();
                }
            });
            
            // Èò≤Ê≠¢ÊãñÊãΩÂà∞Â§ñÈÉ®
            document.addEventListener('mouseup', () => {
                if (isDraggingGlobal) {
                    isDraggingGlobal = false;
                    timeSelection.isSelecting = false;
                }
            });
            
            timeSelectionEventsBound = true;
        }

        // Êõ¥Êñ∞ÂΩìÂâçÊó∂Èó¥ÈÄâÊã©
        function updateCurrentTimeSelection(left, width, totalWidth) {
            const startPercent = left / totalWidth;
            const endPercent = (left + width) / totalWidth;
            
            const startHour = Math.floor(startPercent * 24);
            const endHour = Math.ceil(endPercent * 24);
            
            const formatTime = (hour) => {
                return hour.toString().padStart(2, '0') + ':00';
            };
            
            timeSelection.current = {
                start: formatTime(Math.max(0, startHour)),
                end: formatTime(Math.min(24, endHour)),
                type: currentTimeSelectionMode
            };
            
        }

        // Ëá™Âä®Ê∑ªÂä†Êó∂Èó¥ÊÆµÔºàÊ°ÜÈÄâÂÆåÊàêÂêéËá™Âä®Ë∞ÉÁî®Ôºâ
        function autoAddTimeSegment() {
            if (!timeSelection.current || !currentTimeSelectionMode) {
                return;
            }
            
            // ÂàõÂª∫Êñ∞Êó∂Èó¥ÊÆµÊó∂ÔºåÁ°Æ‰øùÂåÖÂê´ÂΩìÂâçÁ±ªÂûã
            const newSegment = {
                start: timeSelection.current.start,
                end: timeSelection.current.end,
                id: Date.now().toString(), // ÂîØ‰∏ÄID
                type: currentTimeSelectionMode // ÊòéÁ°ÆËÆ∞ÂΩïÁ±ªÂûã
            };
            
            
            // Ê£ÄÊü•‰∏éÂØπÊñπÁ±ªÂûãÁöÑÊó∂Èó¥ÂÜ≤Á™ÅÂπ∂Â§ÑÁêÜ
            const oppositeType = currentTimeSelectionMode === 'charge' ? 'discharge' : 'charge';
            const newOppositeSegments = [];
            
            timeConditionSegments[oppositeType].forEach((segment) => {
                if (isTimeSegmentOverlap(newSegment, segment)) {
                    // ÊúâÈáçÂè†ÔºåÈúÄË¶ÅÂ§ÑÁêÜ
                    const splitSegments = splitSegmentByOverlap(segment, newSegment);
                    newOppositeSegments.push(...splitSegments);
                } else {
                    // Êó†ÈáçÂè†Ôºå‰øùÁïôÂéüÊÆµ
                    newOppositeSegments.push(segment);
                }
            });
            
            // Êõ¥Êñ∞ÂØπÊñπÁ±ªÂûãÁöÑÊó∂Èó¥ÊÆµ
            timeConditionSegments[oppositeType] = newOppositeSegments;
            
            // Ê£ÄÊü•‰∏éËá™Â∑±Á±ªÂûãÁöÑÊó∂Èó¥ÊÆµÔºåÂêàÂπ∂Áõ∏ÈÇªÊàñÈáçÂè†ÁöÑÊÆµ
            const mergedSegment = { ...newSegment };
            const segmentsToRemove = [];
            
            
            timeConditionSegments[currentTimeSelectionMode].forEach((segment, index) => {
                if (shouldMergeSegments(mergedSegment, segment)) {
                    
                    // ÂêàÂπ∂Êó∂Èó¥ÊÆµ
                    const merged = mergeTimeSegments(mergedSegment, segment);
                    mergedSegment.start = merged.start;
                    mergedSegment.end = merged.end;
                    
                    segmentsToRemove.push(index);
                }
            });
            
            
            // ÁßªÈô§Ë¶ÅÂêàÂπ∂ÁöÑÊó∂Èó¥ÊÆµ
            for (let i = segmentsToRemove.length - 1; i >= 0; i--) {
                const removedSegment = timeConditionSegments[currentTimeSelectionMode].splice(segmentsToRemove[i], 1)[0];
            }
            
            // Ê∑ªÂä†ÂêàÂπ∂ÂêéÁöÑÊó∂Èó¥ÊÆµÂà∞Ê≠£Á°ÆÁöÑÊï∞ÁªÑ
            timeConditionSegments[currentTimeSelectionMode].push(mergedSegment);
            
            // ÂêåÊ≠•Âà∞ÊóßÁ≥ªÁªüÁöÑÂÖ®Â±ÄÂèòÈáè
            if (currentTimeSelectionMode === 'charge') {
                window.chargeTimeSegments = [...timeConditionSegments.charge];
                chargeTimeSegments = window.chargeTimeSegments;
            } else {
                window.dischargeTimeSegments = [...timeConditionSegments.discharge];
                dischargeTimeSegments = window.dischargeTimeSegments;
            }
            
            // Á´ãÂç≥Êõ¥Êñ∞ÊâÄÊúâÊòæÁ§∫
            updateTimelineDisplay();
            updateTimeSegmentsList();
            
            // ‰πüÊõ¥Êñ∞ÊóßÁ≥ªÁªüÁöÑÊòæÁ§∫ÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
            if (typeof renderTimeSegments === 'function') {
                renderTimeSegments();
            }
            if (typeof updateTimeline === 'function') {
                updateTimeline();
            }
            
            // Ê∏ÖÈô§ÈÄâÊã©Ê°Ü‰ΩÜ‰øùÊåÅÈÄâÊã©Ê®°Âºè
            clearTimeSelection();
            
            
            // Ë∞ÉËØïÔºöÊòæÁ§∫ÂΩìÂâçÊâÄÊúâÊó∂Èó¥ÊÆµ
            const chargeList = timeConditionSegments.charge.map(s => `${s.start}-${s.end}`).join(', ');
            const dischargeList = timeConditionSegments.discharge.map(s => `${s.start}-${s.end}`).join(', ');
        }

        // Ê∑ªÂä†ÂΩìÂâçÊó∂Èó¥ÈÄâÊã©
        function addCurrentTimeSelection() {
            
            if (!timeSelection.current || !currentTimeSelectionMode) {
                alert(window.i18n && window.i18n.getCurrentLanguage() === 'en' ? 'Please select time slots on timeline first' : 'ËØ∑ÂÖàÂú®Êó∂Èó¥ËΩ¥‰∏äÈÄâÊã©Êó∂Èó¥ÊÆµ');
                return;
            }
            
            const newSegment = {
                start: timeSelection.current.start,
                end: timeSelection.current.end,
                id: Date.now().toString() // ÂîØ‰∏ÄID
            };
            
            
            // Ê£ÄÊü•‰∏éÂØπÊñπÁ±ªÂûãÁöÑÊó∂Èó¥ÂÜ≤Á™Å
            const oppositeType = currentTimeSelectionMode === 'charge' ? 'discharge' : 'charge';
            const conflictingSegments = [];
            
            timeConditionSegments[oppositeType].forEach((segment, index) => {
                if (isTimeSegmentOverlap(newSegment, segment)) {
                    conflictingSegments.push(index);
                }
            });
            
            // ÁßªÈô§ÂÜ≤Á™ÅÁöÑÂØπÊñπÊó∂Èó¥ÊÆµ
            for (let i = conflictingSegments.length - 1; i >= 0; i--) {
                const removedSegment = timeConditionSegments[oppositeType].splice(conflictingSegments[i], 1)[0];
            }
            
            // Ê£ÄÊü•‰∏éËá™Â∑±Á±ªÂûãÁöÑÊó∂Èó¥ÂÜ≤Á™Å
            const sameTypeConflicts = [];
            timeConditionSegments[currentTimeSelectionMode].forEach((segment, index) => {
                if (isTimeSegmentOverlap(newSegment, segment)) {
                    sameTypeConflicts.push(index);
                }
            });
            
            // ÁßªÈô§ÂÜ≤Á™ÅÁöÑÂêåÁ±ªÂûãÊó∂Èó¥ÊÆµ
            for (let i = sameTypeConflicts.length - 1; i >= 0; i--) {
                const removedSegment = timeConditionSegments[currentTimeSelectionMode].splice(sameTypeConflicts[i], 1)[0];
            }
            
            // Ê∑ªÂä†Êñ∞Êó∂Èó¥ÊÆµ
            timeConditionSegments[currentTimeSelectionMode].push(newSegment);
            
            // Êõ¥Êñ∞ÊòæÁ§∫
            updateTimelineDisplay();
            updateTimeSegmentsList();
            
            // Âè™Ê∏ÖÈô§ÂΩìÂâçÈÄâÊã©Ê°ÜÔºå‰ΩÜ‰øùÊåÅÈÄâÊã©Ê®°Âºè
            clearTimeSelection();
            
        }

        // Ê∏ÖÈô§Êó∂Èó¥ÈÄâÊã©
        function clearTimeSelection() {
            timeSelection.current = null;
            
            const selectionBox = document.getElementById('timeSelectionBox');
            if (selectionBox) {
                selectionBox.style.display = 'none';
            } else {
                console.error('timeSelectionBox not found!');
            }
        }
        
        // ============== Êó∂Èó¥Êù°‰ª∂Áü©ÂΩ¢Êù°Á≥ªÁªü ==============
        
        let currentTimeBarMode = null; // 'charge' Êàñ 'discharge'
        let timeBarSelection = {
            isSelecting: false,
            startX: 0,
            current: null
        };
        
        // ËÆæÁΩÆÊó∂Èó¥Êù°ÈÄâÊã©Ê®°Âºè
        function setTimeBarMode(mode) {
            
            currentTimeBarMode = mode;
            
            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            const chargeBtn = document.getElementById('chargeTimeBarBtn');
            const dischargeBtn = document.getElementById('dischargeTimeBarBtn');
            const selectionBox = document.getElementById('timeBarSelection');
            
            if (chargeBtn && dischargeBtn) {
                if (mode === 'charge') {
                    chargeBtn.style.boxShadow = '0 0 12px rgba(0,255,136,0.5)';
                    dischargeBtn.style.boxShadow = 'none';
                    selectionBox.style.borderColor = '#00ff88';
                    selectionBox.style.backgroundColor = 'rgba(0,255,136,0.2)';
                } else {
                    dischargeBtn.style.boxShadow = '0 0 12px rgba(255,193,7,0.5)';
                    chargeBtn.style.boxShadow = 'none';
                    selectionBox.style.borderColor = '#FFC107';
                    selectionBox.style.backgroundColor = 'rgba(255,193,7,0.2)';
                }
            }
            
            // ÁªëÂÆöÊó∂Èó¥Êù°‰∫§‰∫í‰∫ã‰ª∂
            initTimeBarInteraction();
        }
        
        // ÂàùÂßãÂåñÊó∂Èó¥Êù°‰∫§‰∫í
        function initTimeBarInteraction() {
            const interactArea = document.getElementById('timeBarInteraction');
            if (!interactArea) {
                return; // timeBar not in current layout
                return;
            }
            
            // Ê∏ÖÈô§Áé∞Êúâ‰∫ã‰ª∂ÁõëÂê¨Âô®
            interactArea.removeEventListener('mousedown', handleTimeBarMouseDown);
            interactArea.removeEventListener('mousemove', handleTimeBarMouseMove);
            interactArea.removeEventListener('mouseup', handleTimeBarMouseUp);
            
            // Ê∑ªÂä†Êñ∞ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
            interactArea.addEventListener('mousedown', handleTimeBarMouseDown);
            interactArea.addEventListener('mousemove', handleTimeBarMouseMove);
            interactArea.addEventListener('mouseup', handleTimeBarMouseUp);
        }
        
        // Â§ÑÁêÜÊó∂Èó¥Êù°Èº†Ê†áÊåâ‰∏ã
        function handleTimeBarMouseDown(e) {
            if (!currentTimeBarMode) return;
            
            const rect = e.target.getBoundingClientRect();
            const x = e.clientX - rect.left;
            
            timeBarSelection.isSelecting = true;
            timeBarSelection.startX = x;
            
            const selectionBox = document.getElementById('timeBarSelection');
            if (selectionBox) {
                selectionBox.style.left = x + 'px';
                selectionBox.style.width = '0px';
                selectionBox.style.display = 'block';
            }
        }
        
        // Â§ÑÁêÜÊó∂Èó¥Êù°Èº†Ê†áÁßªÂä®
        function handleTimeBarMouseMove(e) {
            if (!timeBarSelection.isSelecting || !currentTimeBarMode) return;
            
            const rect = e.target.getBoundingClientRect();
            const x = e.clientX - rect.left;
            
            const selectionBox = document.getElementById('timeBarSelection');
            if (selectionBox) {
                const left = Math.min(timeBarSelection.startX, x);
                const width = Math.abs(x - timeBarSelection.startX);
                
                selectionBox.style.left = left + 'px';
                selectionBox.style.width = width + 'px';
                
                // ËÆ°ÁÆóÊó∂Èó¥ËåÉÂõ¥
                const containerWidth = rect.width;
                const startPercent = left / containerWidth;
                const endPercent = (left + width) / containerWidth;
                
                const startTime = percentToTime(startPercent);
                const endTime = percentToTime(endPercent);
                
                timeBarSelection.current = {
                    start: startTime,
                    end: endTime,
                    type: currentTimeBarMode
                };
            }
        }
        
        // Â§ÑÁêÜÊó∂Èó¥Êù°Èº†Ê†áÊùæÂºÄ
        function handleTimeBarMouseUp(e) {
            if (!timeBarSelection.isSelecting || !currentTimeBarMode) return;
            
            timeBarSelection.isSelecting = false;
            
            // Â¶ÇÊûúÊúâÊúâÊïàÈÄâÊã©ÔºåÊ∑ªÂä†Êó∂Èó¥ÊÆµ
            if (timeBarSelection.current) {
                addTimeBarSegment(timeBarSelection.current);
            }
            
            // Ê∏ÖÈô§ÈÄâÊã©Ê°Ü
            const selectionBox = document.getElementById('timeBarSelection');
            if (selectionBox) {
                selectionBox.style.display = 'none';
            }
            
            timeBarSelection.current = null;
        }
        
        // Ê∑ªÂä†Êó∂Èó¥Êù°ÊÆµ
        function addTimeBarSegment(segment) {
            
            // Á°Æ‰øù timeConditionSegments Â∑≤ÂàùÂßãÂåñ
            if (!timeConditionSegments.charge || !timeConditionSegments.discharge) {
                timeConditionSegments = {
                    charge: [],
                    discharge: []
                };
            }
            
            const newSegment = {
                id: Date.now().toString() + Math.random(),
                start: segment.start,
                end: segment.end,
                type: segment.type
            };
            
            // Ê∑ªÂä†Âà∞Áõ∏Â∫îÁöÑÊï∞ÁªÑ
            if (segment.type === 'charge') {
                timeConditionSegments.charge.push(newSegment);
            } else {
                timeConditionSegments.discharge.push(newSegment);
            }
            
            // Êõ¥Êñ∞ÊòæÁ§∫
            updateTimeConditionBars();
            updateTimeSegmentsList();
            
        }
        
        // Êõ¥Êñ∞Êó∂Èó¥Êù°‰ª∂Áü©ÂΩ¢Êù°
        function updateTimeConditionBars() {
            const container = document.getElementById('timeConditionBars');
            if (!container) return;
            
            container.innerHTML = '';
            
            // Ê∑ªÂä†ÂÖÖÁîµÊó∂Èó¥ÊÆµ
            timeConditionSegments.charge.forEach((segment, index) => {
                const bar = createTimeBar(segment, 'charge', index);
                container.appendChild(bar);
            });
            
            // Ê∑ªÂä†ÊîæÁîµÊó∂Èó¥ÊÆµ
            timeConditionSegments.discharge.forEach((segment, index) => {
                const bar = createTimeBar(segment, 'discharge', index);
                container.appendChild(bar);
            });
        }
        
        // ÂàõÂª∫Êó∂Èó¥Êù°
        function createTimeBar(segment, type, index) {
            const bar = document.createElement('div');
            bar.className = `time-bar ${type}-bar`;
            
            const startPercent = timeToPercent(segment.start);
            const endPercent = timeToPercent(segment.end);
            const width = endPercent - startPercent;
            
            const color = type === 'charge' ? 
                'linear-gradient(135deg, #00ff88, #00dd77)' : 
                'linear-gradient(135deg, #FFC107, #FFB300)';
            
            const topPosition = type === 'charge' ? 6 : 24;
            
            bar.style.cssText = `
                position: absolute;
                top: ${topPosition}px;
                height: 18px;
                background: ${color};
                border-radius: 6px;
                left: ${startPercent}%;
                width: ${width}%;
                opacity: 0.9;
                cursor: pointer;
                transition: all 0.3s;
            `;
            
            // Ê∑ªÂä†Âà†Èô§ÂäüËÉΩ
            bar.addEventListener('click', () => {
                removeTimeBarSegment(segment.id, type);
            });
            
            bar.addEventListener('mouseenter', () => {
                bar.style.opacity = '1';
                bar.style.transform = 'scale(1.02)';
            });
            
            bar.addEventListener('mouseleave', () => {
                bar.style.opacity = '0.9';
                bar.style.transform = 'scale(1)';
            });
            
            return bar;
        }
        
        // Âà†Èô§Êó∂Èó¥Êù°ÊÆµ
        function removeTimeBarSegment(segmentId, type) {
            if (type === 'charge') {
                timeConditionSegments.charge = timeConditionSegments.charge.filter(s => s.id !== segmentId);
            } else {
                timeConditionSegments.discharge = timeConditionSegments.discharge.filter(s => s.id !== segmentId);
            }
            
            updateTimeConditionBars();
            updateTimeSegmentsList();
        }
        
        // Êó∂Èó¥ËΩ¨Êç¢‰∏∫ÁôæÂàÜÊØî
        function timeToPercent(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return ((hours * 60 + minutes) / (24 * 60)) * 100;
        }
        
        // ÁôæÂàÜÊØîËΩ¨Êç¢‰∏∫Êó∂Èó¥
        function percentToTime(percent) {
            const totalMinutes = (percent * 24 * 60) / 100;
            const hours = Math.floor(totalMinutes / 60);
            const minutes = Math.floor(totalMinutes % 60);
            
            // ÂØπÈΩêÂà∞30ÂàÜÈíüÈó¥Èöî
            const alignedMinutes = Math.round(minutes / 30) * 30;
            const adjustedHours = alignedMinutes === 60 ? hours + 1 : hours;
            const finalMinutes = alignedMinutes === 60 ? 0 : alignedMinutes;
            
            return `${String(adjustedHours).padStart(2, '0')}:${String(finalMinutes).padStart(2, '0')}`;
        }
        
        // ÂàùÂßãÂåñÊó∂Èó¥Êù°‰ª∂Áü©ÂΩ¢Êù°
        function initTimeConditionBars() {
            
            // Êõ¥Êñ∞Êó∂Èó¥Êù°‰ª∂Áü©ÂΩ¢Êù°ÊòæÁ§∫
            updateTimeConditionBars();
            
            // ÈªòËÆ§ÈÄâÊã©ÂÖÖÁîµÊ®°Âºè
            setTimeBarMode('charge');
            
        }

        // Êõ¥Êñ∞Êó∂Èó¥ËΩ¥ÊòæÁ§∫
        function updateTimelineDisplay() {
            
            const display = document.getElementById('timelineSegmentDisplay');
            if (!display) {
                return; // timeline not in current layout
                return;
            }
            
            // Ê∏ÖÁ©∫Áé∞ÊúâÊòæÁ§∫
            display.innerHTML = '';
            
            // ÊòæÁ§∫ÂÖÖÁîµÊó∂Èó¥ÊÆµ
            timeConditionSegments.charge.forEach((segment, index) => {
                const element = createTimelineSegmentElement(segment, 'charge');
                display.appendChild(element);
            });
            
            // ÊòæÁ§∫ÊîæÁîµÊó∂Èó¥ÊÆµ
            timeConditionSegments.discharge.forEach((segment, index) => {
                const element = createTimelineSegmentElement(segment, 'discharge');
                display.appendChild(element);
            });
            
        }

        // ÂàõÂª∫Êó∂Èó¥ËΩ¥ÊÆµÂÖÉÁ¥†
        function createTimelineSegmentElement(segment, type) {
            const element = document.createElement('div');
            
            const startHour = parseInt(segment.start.split(':')[0]);
            const endHour = parseInt(segment.end.split(':')[0]);
            
            const startPercent = (startHour / 24) * 100;
            let widthPercent = ((endHour - startHour) / 24) * 100;
            
            // Â§ÑÁêÜË∑®ÂçàÂ§úÁöÑÊÉÖÂÜµ
            if (endHour < startHour) {
                widthPercent = ((24 - startHour + endHour) / 24) * 100;
            }
            
            // ‰ΩøÁî®segmentËá™Ë∫´ÁöÑtypeÂ±ûÊÄßÔºàÂ¶ÇÊûúÊúâÔºâÔºåÂê¶Âàô‰ΩøÁî®‰º†ÂÖ•ÁöÑtype
            const actualType = segment.type || type;
            const color = actualType === 'charge' ? '#00ff88' : '#FFC107';
            const bgColor = actualType === 'charge' ? 'rgba(0,255,136,0.3)' : 'rgba(255,193,7,0.3)';
            
            element.style.cssText = `
                position: absolute;
                left: ${startPercent}%;
                width: ${widthPercent}%;
                height: 100%;
                background: ${bgColor};
                border: 1px solid ${color};
                border-radius: 6px;
                cursor: pointer;
                transition: all 0.2s ease;
            `;
            
            // Ê∑ªÂä†ÊÇ¨ÂÅúÊïàÊûú
            element.onmouseenter = function() {
                element.style.opacity = '0.7';
                element.style.borderWidth = '2px';
            };
            
            element.onmouseleave = function() {
                element.style.opacity = '1';
                element.style.borderWidth = '1px';
            };
            
            // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂‰ª•ÁßªÈô§Êó∂Èó¥ÊÆµ
            element.onclick = function(e) {
                e.stopPropagation(); // Èò≤Ê≠¢Ëß¶ÂèëÊó∂Èó¥ËΩ¥ÁöÑÊãñÊãΩ‰∫ã‰ª∂
                
                // ‰ªéÁõ∏Â∫îÁöÑÊï∞ÁªÑ‰∏≠ÁßªÈô§ËØ•Êó∂Èó¥ÊÆµ
                const segmentId = element.dataset.segmentId;
                const segmentType = element.dataset.segmentType;
                
                if (segmentType === 'charge') {
                    timeConditionSegments.charge = timeConditionSegments.charge.filter(s => s.id !== segmentId);
                } else if (segmentType === 'discharge') {
                    timeConditionSegments.discharge = timeConditionSegments.discharge.filter(s => s.id !== segmentId);
                }
                
                // Êõ¥Êñ∞ÊòæÁ§∫
                updateTimelineDisplay();
                updateTimeSegmentsList();
                
            };
            
            element.dataset.segmentType = actualType;
            element.dataset.segmentId = segment.id || `${actualType}-${Date.now()}`;
            
            return element;
        }

        // Êõ¥Êñ∞Êó∂Èó¥ÊÆµÂàóË°®
        function updateTimeSegmentsList() {
            updateChargeSegmentsList();
            updateDischargeSegmentsList();
        }

        // Êõ¥Êñ∞ÂÖÖÁîµÊó∂Èó¥ÊÆµÂàóË°®
        function updateChargeSegmentsList() {
            const container = document.getElementById('chargeTimeSegmentsList');
            const countLabel = document.getElementById('chargeSegmentCount');
            
            if (!container) {
                return; // charge segments not in current layout
                return;
            }
            
            const segments = timeConditionSegments.charge;
            // ‰∏çÂÜçÊòæÁ§∫Êï∞Èáè
            // countLabel.textContent = `(${segments.length}‰∏™)`;
            
            container.innerHTML = '';
            // ËÆæÁΩÆÂÆπÂô®‰∏∫Ê∞¥Âπ≥Â∏ÉÂ±Ä
            container.style.cssText = 'display: flex; flex-wrap: wrap; gap: 8px; min-height: 30px;';
            
            if (segments.length === 0) {
                const currentLang = window.i18n ? window.i18n.getCurrentLanguage() : 'zh';
                const emptyText = currentLang === 'en' ? 'No charge time slots' : 'ÊöÇÊó†ÂÖÖÁîµÊó∂Èó¥ÊÆµ';
                container.innerHTML = `<div style="color: rgba(255,255,255,0.5); font-size: 12px; padding: 8px;">${emptyText}</div>`;
                return;
            }
            
            segments.forEach((segment, index) => {
                const segmentElement = createTimeSegmentListItem(segment, index, 'charge');
                container.appendChild(segmentElement);
            });
            
            // Á°Æ‰øùÁøªËØëÂ∑≤Êõ¥Êñ∞
            if (window.i18n && window.i18n.isReady) {
                updateTimeSegmentListTranslations();
            }
        }

        // Êõ¥Êñ∞ÊîæÁîµÊó∂Èó¥ÊÆµÂàóË°®
        function updateDischargeSegmentsList() {
            
            const container = document.getElementById('dischargeTimeSegmentsList');
            const countLabel = document.getElementById('dischargeSegmentCount');
            
            if (!container) {
                return; // discharge segments not in current layout
                return;
            }
            
            const segments = timeConditionSegments.discharge;
            // ‰∏çÂÜçÊòæÁ§∫Êï∞Èáè
            // countLabel.textContent = `(${segments.length}‰∏™)`;
            
            container.innerHTML = '';
            // ËÆæÁΩÆÂÆπÂô®‰∏∫Ê∞¥Âπ≥Â∏ÉÂ±Ä
            container.style.cssText = 'display: flex; flex-wrap: wrap; gap: 8px; min-height: 30px;';
            
            if (segments.length === 0) {
                const currentLang = window.i18n ? window.i18n.getCurrentLanguage() : 'zh';
                const emptyText = currentLang === 'en' ? 'No discharge time slots' : 'ÊöÇÊó†ÊîæÁîµÊó∂Èó¥ÊÆµ';
                container.innerHTML = `<div style="color: rgba(255,255,255,0.5); font-size: 12px; padding: 8px;">${emptyText}</div>`;
                return;
            }
            
            segments.forEach((segment, index) => {
                const segmentElement = createTimeSegmentListItem(segment, index, 'discharge');
                container.appendChild(segmentElement);
            });
            
            // Á°Æ‰øùÁøªËØëÂ∑≤Êõ¥Êñ∞
            if (window.i18n && window.i18n.isReady) {
                updateTimeSegmentListTranslations();
            }
        }

        // ÂàõÂª∫Êó∂Èó¥ÊÆµÂàóË°®È°π
        function createTimeSegmentListItem(segment, index, type) {
            const item = document.createElement('div');
            // ‰ΩøÁî®segmentËá™Ë∫´ÁöÑtypeÂ±ûÊÄßÔºàÂ¶ÇÊûúÊúâÔºâÔºåÂê¶Âàô‰ΩøÁî®‰º†ÂÖ•ÁöÑtype
            const actualType = segment.type || type;
            const color = actualType === 'charge' ? '#00ff88' : '#FFC107';
            const bgColor = actualType === 'charge' ? 'rgba(0,255,136,0.1)' : 'rgba(255,193,7,0.1)';
            const borderColor = actualType === 'charge' ? 'rgba(0,255,136,0.3)' : 'rgba(255,193,7,0.3)';
            
            item.style.cssText = `
                position: relative;
                display: inline-flex;
                align-items: center;
                padding: 6px 12px;
                background: ${bgColor};
                border: 1px solid ${borderColor};
                border-radius: 10px;
                font-size: 12px;
                color: ${color};
                font-weight: 500;
                min-width: 80px;
                justify-content: center;
            `;
            
            item.dataset.segmentType = actualType;
            item.dataset.segmentIndex = index;
            item.dataset.segmentId = segment.id;
            
            // ÂàõÂª∫ÂèØÁºñËæëÁöÑÊó∂Èó¥ÊòæÁ§∫
            const timeDisplay = document.createElement('span');
            timeDisplay.style.cursor = 'pointer';
            timeDisplay.textContent = `${segment.start} - ${segment.end}`;
            timeDisplay.onclick = () => enableTimeEditing(item, segment, index, actualType);
            
            item.innerHTML = `
                <button onclick="deleteTimeSegment(${index}, '${actualType}')" 
                        style="position: absolute; top: -4px; right: -4px; width: 16px; height: 16px; 
                               background: #ff4444; color: #fff; border: none; border-radius: 50%; 
                               font-size: 10px; cursor: pointer; display: flex; align-items: center; 
                               justify-content: center; line-height: 1; padding: 0; transition: all 0.3s;
                               box-shadow: 0 2px 4px rgba(0,0,0,0.2);"
                        onmouseover="this.style.background='#ff6666'" 
                        onmouseout="this.style.background='#ff4444'">√ó</button>
            `;
            
            item.insertBefore(timeDisplay, item.firstChild);
            
            return item;
        }

        // ÂêØÁî®Êó∂Èó¥ÁºñËæë
        function enableTimeEditing(item, segment, index, type) {
            const color = type === 'charge' ? '#00ff88' : '#FFC107';
            const bgColor = type === 'charge' ? 'rgba(0,255,136,0.1)' : 'rgba(255,193,7,0.1)';
            
            // ÂàõÂª∫ËæìÂÖ•Ê°Ü
            const startInput = document.createElement('input');
            startInput.type = 'time';
            startInput.value = segment.start;
            startInput.style.cssText = `
                background: rgba(255,255,255,0.1);
                border: 1px solid rgba(255,255,255,0.2);
                color: #fff;
                padding: 2px 4px;
                border-radius: 6px;
                font-size: 11px;
                outline: none;
                width: 60px;
            `;
            
            const endInput = document.createElement('input');
            endInput.type = 'time';
            endInput.value = segment.end;
            endInput.style.cssText = startInput.style.cssText;
            
            const separator = document.createElement('span');
            separator.textContent = ' - ';
            separator.style.color = color;
            
            // ‰øùÂ≠òÂéüÂßãÂÜÖÂÆπ
            const originalContent = item.innerHTML;
            
            // Ê∏ÖÁ©∫Âπ∂Ê∑ªÂä†ËæìÂÖ•Ê°Ü
            item.innerHTML = '';
            item.appendChild(startInput);
            item.appendChild(separator);
            item.appendChild(endInput);
            
            // Ê∑ªÂä†Á°ÆËÆ§ÂíåÂèñÊ∂àÊåâÈíÆ
            const confirmBtn = document.createElement('button');
            confirmBtn.textContent = '‚úì';
            confirmBtn.style.cssText = `
                margin-left: 4px;
                background: ${bgColor};
                border: 1px solid ${color};
                color: ${color};
                padding: 2px 6px;
                border-radius: 6px;
                font-size: 10px;
                cursor: pointer;
            `;
            
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = '‚úó';
            cancelBtn.style.cssText = confirmBtn.style.cssText.replace(color, '#ff6666').replace(bgColor, 'rgba(255,0,0,0.1)');
            
            confirmBtn.onclick = () => {
                const newStart = startInput.value;
                const newEnd = endInput.value;
                
                if (newStart && newEnd) {
                    updateTimeSegment(index, 'start', newStart, type);
                    updateTimeSegment(index, 'end', newEnd, type);
                }
                
                // ÊÅ¢Â§çÊ≠£Â∏∏ÊòæÁ§∫
                updateTimeSegmentsList();
            };
            
            cancelBtn.onclick = () => {
                // ÊÅ¢Â§çÂéüÂßãÂÜÖÂÆπ
                item.innerHTML = originalContent;
                // ÈáçÊñ∞ÁªëÂÆö‰∫ã‰ª∂
                const timeDisplay = item.querySelector('span');
                if (timeDisplay) {
                    timeDisplay.onclick = () => enableTimeEditing(item, segment, index, type);
                }
            };
            
            item.appendChild(confirmBtn);
            item.appendChild(cancelBtn);
            
            // ËÅöÁÑ¶Á¨¨‰∏Ä‰∏™ËæìÂÖ•Ê°Ü
            startInput.focus();
            startInput.select();
        }

        // Êõ¥Êñ∞Êó∂Èó¥ÊÆµ
        function updateTimeSegment(index, field, value, type) {
            if (!timeConditionSegments[type][index]) return;
            
            const oldSegment = { ...timeConditionSegments[type][index] };
            timeConditionSegments[type][index][field] = value;
            
            
            // Ê£ÄÊü•Êõ¥Êñ∞ÂêéÁöÑÊó∂Èó¥ÊÆµÊòØÂê¶‰∏éÂÖ∂‰ªñÊó∂Èó¥ÊÆµÂÜ≤Á™Å
            const updatedSegment = timeConditionSegments[type][index];
            const oppositeType = type === 'charge' ? 'discharge' : 'charge';
            
            // Ê£ÄÊü•‰∏éÂØπÊñπÁ±ªÂûãÁöÑÂÜ≤Á™Å
            const conflictingOpposite = [];
            timeConditionSegments[oppositeType].forEach((segment, idx) => {
                if (isTimeSegmentOverlap(updatedSegment, segment)) {
                    conflictingOpposite.push(idx);
                }
            });
            
            // ÁßªÈô§ÂÜ≤Á™ÅÁöÑÂØπÊñπÊó∂Èó¥ÊÆµ
            for (let i = conflictingOpposite.length - 1; i >= 0; i--) {
                const removed = timeConditionSegments[oppositeType].splice(conflictingOpposite[i], 1)[0];
            }
            
            // Ê£ÄÊü•‰∏éÂêåÁ±ªÂûãÂÖ∂‰ªñÊó∂Èó¥ÊÆµÁöÑÂÜ≤Á™Å
            const conflictingSame = [];
            timeConditionSegments[type].forEach((segment, idx) => {
                if (idx !== index && isTimeSegmentOverlap(updatedSegment, segment)) {
                    conflictingSame.push(idx);
                }
            });
            
            // ÁßªÈô§ÂÜ≤Á™ÅÁöÑÂêåÁ±ªÂûãÊó∂Èó¥ÊÆµ
            for (let i = conflictingSame.length - 1; i >= 0; i--) {
                const removed = timeConditionSegments[type].splice(conflictingSame[i], 1)[0];
                // Â¶ÇÊûúÂà†Èô§ÁöÑÁ¥¢ÂºïÂ∞è‰∫éÂΩìÂâçÁ¥¢ÂºïÔºåÈúÄË¶ÅË∞ÉÊï¥ÂΩìÂâçÁ¥¢Âºï
                if (conflictingSame[i] < index) {
                    index--;
                }
            }
            
            // ÂêàÂπ∂ÊâÄÊúâÁõ∏ÈÇªÊàñÈáçÂè†ÁöÑÂêåÁ±ªÂûãÊó∂Èó¥ÊÆµ
            consolidateTimeSegments(type);
            
            // ÂêåÊ≠•Âà∞ÊóßÁ≥ªÁªü
            if (type === 'charge') {
                window.chargeTimeSegments = [...timeConditionSegments.charge];
                chargeTimeSegments = window.chargeTimeSegments;
            } else {
                window.dischargeTimeSegments = [...timeConditionSegments.discharge];
                dischargeTimeSegments = window.dischargeTimeSegments;
            }
            
            // Êõ¥Êñ∞ÊòæÁ§∫
            updateTimelineDisplay();
            updateTimeSegmentsList();
            
            // Êõ¥Êñ∞ÊóßÁ≥ªÁªüÊòæÁ§∫
            if (typeof renderTimeSegments === 'function') {
                renderTimeSegments();
            }
            if (typeof updateTimeline === 'function') {
                updateTimeline();
            }
        }

        // Âà†Èô§Êó∂Èó¥ÊÆµ
        function deleteTimeSegment(index, type) {
            if (!timeConditionSegments[type][index]) return;
            
            const removedSegment = timeConditionSegments[type].splice(index, 1)[0];
            
            // ÂêàÂπ∂ÊâÄÊúâÁõ∏ÈÇªÊàñÈáçÂè†ÁöÑÂêåÁ±ªÂûãÊó∂Èó¥ÊÆµ
            consolidateTimeSegments(type);
            
            // ÂêåÊ≠•Âà∞ÊóßÁ≥ªÁªü
            if (type === 'charge') {
                window.chargeTimeSegments = [...timeConditionSegments.charge];
                chargeTimeSegments = window.chargeTimeSegments;
            } else {
                window.dischargeTimeSegments = [...timeConditionSegments.discharge];
                dischargeTimeSegments = window.dischargeTimeSegments;
            }
            
            // Êõ¥Êñ∞ÊòæÁ§∫
            updateTimelineDisplay();
            updateTimeSegmentsList();
            
            // Êõ¥Êñ∞ÊóßÁ≥ªÁªüÊòæÁ§∫
            if (typeof renderTimeSegments === 'function') {
                renderTimeSegments();
            }
            if (typeof updateTimeline === 'function') {
                updateTimeline();
            }
        }

        // Ê£ÄÊü•Êó∂Èó¥ÊÆµÈáçÂè†
        function isTimeSegmentOverlap(segment1, segment2) {
            const start1 = timeStringToMinutes(segment1.start);
            const end1 = timeStringToMinutes(segment1.end);
            const start2 = timeStringToMinutes(segment2.start);
            const end2 = timeStringToMinutes(segment2.end);
            
            // Â§ÑÁêÜË∑®ÂçàÂ§úÁöÑÊÉÖÂÜµ
            if (end1 < start1) { // segment1 Ë∑®ÂçàÂ§ú
                if (end2 < start2) { // segment2 ‰πüË∑®ÂçàÂ§ú
                    // ‰∏§‰∏™ÈÉΩË∑®ÂçàÂ§úÔºåÈúÄË¶ÅÊ£ÄÊü•ÊòØÂê¶ÁúüÁöÑÊúâÈáçÂè†
                    // ‰∏çÈáçÂè†ÁöÑÊÉÖÂÜµÔºösegment1ÁöÑÁªìÊùüÊó∂Èó¥ < segment2ÁöÑÂºÄÂßãÊó∂Èó¥ ‰∏î segment2ÁöÑÁªìÊùüÊó∂Èó¥ < segment1ÁöÑÂºÄÂßãÊó∂Èó¥
                    return !(end1 < start2 && end2 < start1);
                } else {
                    // segment1Ë∑®ÂçàÂ§úÔºåsegment2‰∏çË∑®ÂçàÂ§ú
                    // segment2Ë¶Å‰πàÂú®Êôö‰∏äÈÉ®ÂàÜÔºåË¶Å‰πàÂú®Êó©‰∏äÈÉ®ÂàÜ
                    return (start2 >= start1) || (end2 <= end1);
                }
            } else if (end2 < start2) { // Âè™Êúâ segment2 Ë∑®ÂçàÂ§ú
                // segment2Ë∑®ÂçàÂ§úÔºåsegment1‰∏çË∑®ÂçàÂ§ú
                return (start1 >= start2) || (end1 <= end2);
            } else { // ÈÉΩ‰∏çË∑®ÂçàÂ§ú
                return (start1 < end2) && (end1 > start2);
            }
        }

        // Êó∂Èó¥Â≠óÁ¨¶‰∏≤ËΩ¨ÂàÜÈíüÊï∞
        function timeStringToMinutes(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        // ÂàÜÈíüÊï∞ËΩ¨Êó∂Èó¥Â≠óÁ¨¶‰∏≤
        function minutesToTimeString(minutes) {
            // Â§ÑÁêÜË¥üÊï∞ÂíåË∂ÖËøá24Â∞èÊó∂ÁöÑÊÉÖÂÜµ
            minutes = ((minutes % 1440) + 1440) % 1440;
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
        }

        // Ê£ÄÊü•‰∏§‰∏™Êó∂Èó¥ÊÆµÊòØÂê¶Â∫îËØ•ÂêàÂπ∂ÔºàÈáçÂè†ÊàñÁõ∏ÈÇªÔºâ
        function shouldMergeSegments(segment1, segment2) {
            const start1 = timeStringToMinutes(segment1.start);
            const end1 = timeStringToMinutes(segment1.end);
            const start2 = timeStringToMinutes(segment2.start);
            const end2 = timeStringToMinutes(segment2.end);
            
            // Â§ÑÁêÜË∑®ÂçàÂ§úÁöÑÊÉÖÂÜµ
            if (end1 < start1 || end2 < start2) {
                // Â§çÊùÇÊÉÖÂÜµÔºåÊöÇÊó∂Âè™Â§ÑÁêÜÊúâÈáçÂè†ÁöÑÊÉÖÂÜµ
                return isTimeSegmentOverlap(segment1, segment2);
            }
            
            // ÈÉΩ‰∏çË∑®ÂçàÂ§úÁöÑÁÆÄÂçïÊÉÖÂÜµ
            // Ê£ÄÊü•ÊòØÂê¶ÈáçÂè†ÊàñÁõ∏ÈÇªÔºàÁõ∏Â∑Æ‰∏çË∂ÖËøá1ÂàÜÈíüËßÜ‰∏∫Áõ∏ÈÇªÔºâ
            const gap = Math.min(Math.abs(start1 - end2), Math.abs(start2 - end1));
            return isTimeSegmentOverlap(segment1, segment2) || gap <= 1;
        }

        // ÂêàÂπ∂‰∏§‰∏™Êó∂Èó¥ÊÆµ
        function mergeTimeSegments(segment1, segment2) {
            const start1 = timeStringToMinutes(segment1.start);
            const end1 = timeStringToMinutes(segment1.end);
            const start2 = timeStringToMinutes(segment2.start);
            const end2 = timeStringToMinutes(segment2.end);
            
            // Â§ÑÁêÜË∑®ÂçàÂ§úÁöÑÊÉÖÂÜµ
            const overnight1 = end1 < start1;
            const overnight2 = end2 < start2;
            
            if (overnight1 && overnight2) {
                // ‰∏§‰∏™ÈÉΩË∑®ÂçàÂ§úÔºåÂêàÂπ∂Âêé‰ªçË∑®ÂçàÂ§ú
                const minStart = Math.min(start1, start2);
                const maxEnd = Math.max(end1, end2);
                return {
                    start: minutesToTimeString(minStart),
                    end: minutesToTimeString(maxEnd)
                };
            } else if (overnight1 || overnight2) {
                // ÂÖ∂‰∏≠‰∏Ä‰∏™Ë∑®ÂçàÂ§úÔºåÈúÄË¶ÅÁâπÊÆäÂ§ÑÁêÜ
                // ÁÆÄÂåñÂ§ÑÁêÜÔºöËøîÂõûË¶ÜÁõñ‰∏§‰∏™Êó∂Èó¥ÊÆµÁöÑÊúÄÂ§ßËåÉÂõ¥
                let allTimes = [start1, end1, start2, end2];
                
                if (overnight1) {
                    // segment1Ë∑®ÂçàÂ§ú
                    if (start2 >= start1 || end2 <= end1) {
                        // segment2Âú®Êôö‰∏äÈÉ®ÂàÜÊàñÊó©‰∏äÈÉ®ÂàÜ
                        return segment1; // segment1Â∑≤ÁªèÂåÖÂê´segment2
                    }
                    // ÈúÄË¶ÅÊâ©Â±ï
                    if (start2 < start1 && end2 > end1) {
                        // segment2Ë∑®Ë∂ä‰∫Üsegment1ÁöÑÈó¥Èöô
                        return {
                            start: '00:00',
                            end: '24:00'
                        };
                    }
                    return {
                        start: minutesToTimeString(Math.min(start1, start2)),
                        end: minutesToTimeString(Math.max(end1, end2))
                    };
                } else {
                    // segment2Ë∑®ÂçàÂ§ú
                    if (start1 >= start2 || end1 <= end2) {
                        return segment2; // segment2Â∑≤ÁªèÂåÖÂê´segment1
                    }
                    if (start1 < start2 && end1 > end2) {
                        return {
                            start: '00:00',
                            end: '24:00'
                        };
                    }
                    return {
                        start: minutesToTimeString(Math.min(start1, start2)),
                        end: minutesToTimeString(Math.max(end1, end2))
                    };
                }
            } else {
                // ÈÉΩ‰∏çË∑®ÂçàÂ§úÔºåÁÆÄÂçïÂêàÂπ∂
                const minStart = Math.min(start1, start2);
                const maxEnd = Math.max(end1, end2);
                return {
                    start: minutesToTimeString(minStart),
                    end: minutesToTimeString(maxEnd)
                };
            }
        }

        // ÂêàÂπ∂ÂêåÁ±ªÂûãÁöÑÊâÄÊúâÁõ∏ÈÇªÊàñÈáçÂè†Êó∂Èó¥ÊÆµ
        function consolidateTimeSegments(type) {
            const segments = timeConditionSegments[type];
            if (segments.length <= 1) return;
            
            
            // ÈáçÂ§çÂêàÂπ∂Áõ¥Âà∞Ê≤°ÊúâÂèØÂêàÂπ∂ÁöÑÊÆµ
            let hasChanges = true;
            while (hasChanges) {
                hasChanges = false;
                
                for (let i = 0; i < segments.length - 1; i++) {
                    for (let j = i + 1; j < segments.length; j++) {
                        if (shouldMergeSegments(segments[i], segments[j])) {
                            // ÂêàÂπ∂Ëøô‰∏§‰∏™ÊÆµ
                            const merged = mergeTimeSegments(segments[i], segments[j]);
                            
                            // ‰øùÁïôÂêàÂπ∂ÂêéÁöÑÊÆµÂú®i‰ΩçÁΩÆ
                            segments[i] = {
                                ...merged,
                                id: segments[i].id, // ‰øùÁïôÂéüID
                                type: type
                            };
                            
                            // Âà†Èô§j‰ΩçÁΩÆÁöÑÊÆµ
                            segments.splice(j, 1);
                            
                            hasChanges = true;
                            break;
                        }
                    }
                    if (hasChanges) break;
                }
            }
            
        }

        // Ê†πÊçÆÈáçÂè†ÂàÜÂâ≤Êó∂Èó¥ÊÆµ
        function splitSegmentByOverlap(existingSegment, newSegment) {
            const existing = {
                start: timeStringToMinutes(existingSegment.start),
                end: timeStringToMinutes(existingSegment.end)
            };
            const newSeg = {
                start: timeStringToMinutes(newSegment.start),
                end: timeStringToMinutes(newSegment.end)
            };
            
            const result = [];
            
            // Â§ÑÁêÜË∑®ÂçàÂ§úÁöÑÊÉÖÂÜµ
            const existingOvernight = existing.end < existing.start;
            const newOvernight = newSeg.end < newSeg.start;
            
            if (existingOvernight && newOvernight) {
                // ‰∏§‰∏™ÈÉΩË∑®ÂçàÂ§úÔºåÁâπÊÆäÂ§ÑÁêÜ
                // ÂèØËÉΩ‰∫ßÁîü0-2‰∏™ÁâáÊÆµ
                if (newSeg.end < existing.start && existing.end < newSeg.start) {
                    // Êñ∞ÊÆµÂÆåÂÖ®Ë¶ÜÁõñÊóßÊÆµÔºåËøîÂõûÁ©∫
                    return [];
                }
                
                if (existing.start > newSeg.end && newSeg.start > existing.end) {
                    // Êó†ÈáçÂè†
                    return [existingSegment];
                }
                
                // ÈÉ®ÂàÜÈáçÂè†
                if (existing.start > newSeg.end) {
                    // ‰øùÁïôÊôö‰∏äÈÉ®ÂàÜ
                    result.push({
                        ...existingSegment,
                        start: minutesToTimeString(existing.start),
                        end: minutesToTimeString(newSeg.start)
                    });
                }
                if (newSeg.end < existing.end) {
                    // ‰øùÁïôÊó©‰∏äÈÉ®ÂàÜ
                    result.push({
                        ...existingSegment,
                        start: minutesToTimeString(newSeg.end),
                        end: minutesToTimeString(existing.end)
                    });
                }
            } else if (existingOvernight) {
                // Âè™ÊúâexistingË∑®ÂçàÂ§ú
                if (newSeg.start >= existing.start || newSeg.end <= existing.end) {
                    // Êñ∞ÊÆµÂú®Êôö‰∏äÊàñÊó©‰∏äÈÉ®ÂàÜ
                    if (newSeg.start >= existing.start) {
                        // Êñ∞ÊÆµÂú®Êôö‰∏äÈÉ®ÂàÜ
                        if (newSeg.end < 1440) {
                            // ‰øùÁïôÊõ¥ÊôöÁöÑÈÉ®ÂàÜ
                            result.push({
                                ...existingSegment,
                                start: minutesToTimeString(newSeg.end),
                                end: existingSegment.end
                            });
                        }
                        // ‰øùÁïôÊó©‰∏äÈÉ®ÂàÜ
                        result.push({
                            ...existingSegment,
                            start: '00:00',
                            end: existingSegment.end
                        });
                    } else {
                        // Êñ∞ÊÆµÂú®Êó©‰∏äÈÉ®ÂàÜ
                        result.push({
                            ...existingSegment,
                            start: existingSegment.start,
                            end: '24:00'
                        });
                        if (newSeg.start > 0) {
                            result.push({
                                ...existingSegment,
                                start: '00:00',
                                end: minutesToTimeString(newSeg.start)
                            });
                        }
                        if (newSeg.end < existing.end) {
                            result.push({
                                ...existingSegment,
                                start: minutesToTimeString(newSeg.end),
                                end: existingSegment.end
                            });
                        }
                    }
                } else {
                    // Êñ∞ÊÆµË∑®Ë∂äÂçàÂ§úÂàÜÁïå
                    if (newSeg.start > existing.end && newSeg.end < existing.start) {
                        // ‰øùÁïôexisting
                        return [existingSegment];
                    }
                }
            } else if (newOvernight) {
                // Âè™ÊúânewË∑®ÂçàÂ§ú
                if (existing.start >= newSeg.start || existing.end <= newSeg.end) {
                    // existingÂÆåÂÖ®Ë¢´Ë¶ÜÁõñ
                    return [];
                }
                // ÈÉ®ÂàÜË¶ÜÁõñ
                if (existing.start < newSeg.start && existing.end > newSeg.start) {
                    result.push({
                        ...existingSegment,
                        start: existingSegment.start,
                        end: minutesToTimeString(newSeg.start)
                    });
                }
                if (existing.start < newSeg.end && existing.end > newSeg.end) {
                    result.push({
                        ...existingSegment,
                        start: minutesToTimeString(newSeg.end),
                        end: existingSegment.end
                    });
                }
            } else {
                // ÈÉΩ‰∏çË∑®ÂçàÂ§úÔºåÁÆÄÂçïÊÉÖÂÜµ
                if (newSeg.start <= existing.start && newSeg.end >= existing.end) {
                    // ÂÆåÂÖ®Ë¶ÜÁõñ
                    return [];
                }
                
                if (newSeg.start > existing.start && newSeg.start < existing.end) {
                    // ‰øùÁïôÂâçÂçäÈÉ®ÂàÜ
                    result.push({
                        ...existingSegment,
                        start: existingSegment.start,
                        end: minutesToTimeString(newSeg.start)
                    });
                }
                
                if (newSeg.end > existing.start && newSeg.end < existing.end) {
                    // ‰øùÁïôÂêéÂçäÈÉ®ÂàÜ
                    result.push({
                        ...existingSegment,
                        start: minutesToTimeString(newSeg.end),
                        end: existingSegment.end
                    });
                }
            }
            
            // ËøáÊª§ÊéâÊó†ÊïàÁöÑÊó∂Èó¥ÊÆµÔºàÂºÄÂßãÊó∂Èó¥Á≠â‰∫éÁªìÊùüÊó∂Èó¥Ôºâ
            return result.filter(seg => seg.start !== seg.end);
        }

        // ÂàùÂßãÂåñÊó∂Èó¥Êù°‰ª∂Ê®°Âùó
        function initTimeConditions() {
            
            // Á°Æ‰øùtimeConditionSegmentsÂ∑≤ÂàùÂßãÂåñ
            if (typeof timeConditionSegments === 'undefined' || !timeConditionSegments.charge || !timeConditionSegments.discharge) {
                window.timeConditionSegments = {
                    charge: [
                        { id: 'default-charge', start: '22:00', end: '06:00', type: 'charge' }
                    ],
                    discharge: [
                        { id: 'default-discharge', start: '16:00', end: '21:00', type: 'discharge' }
                    ]
                };
                timeConditionSegments = window.timeConditionSegments;
            }
            
            // ÂàùÂßãÂåñÊó∂Èó¥Êù°‰ª∂Áü©ÂΩ¢Êù°
            initTimeConditionBars();
            
            // ÂàùÂßãÂåñÊóßÁ≥ªÁªüÁöÑÂÖ®Â±ÄÂèòÈáè
            if (!window.chargeTimeSegments) {
                window.chargeTimeSegments = [];
            }
            if (!window.dischargeTimeSegments) {
                window.dischargeTimeSegments = [];
            }
            
            // Á°Æ‰øùÂ±ÄÈÉ®ÂèòÈáè‰πüÂàùÂßãÂåñ
            chargeTimeSegments = window.chargeTimeSegments;
            dischargeTimeSegments = window.dischargeTimeSegments;
            
            // ÂàùÂßãÂåñÊòæÁ§∫
            updateTimelineDisplay();
            updateTimeSegmentsList();
            
        }
        
        // Âú®È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
        setTimeout(() => {
            initTimeConditions();
        }, 100);
        
        // ÊµãËØïÂáΩÊï∞ - ÊâãÂä®Ê∑ªÂä†Êó∂Èó¥ÊÆµ
        window.testAddTimeSegment = function(type = 'charge', start = '10:00', end = '12:00') {
            
            if (!timeConditionSegments[type]) {
                console.error('timeConditionSegments not initialized!');
                return;
            }
            
            const testSegment = {
                start: start,
                end: end,
                id: Date.now().toString(),
                type: type
            };
            
            timeConditionSegments[type].push(testSegment);
            
            // Êõ¥Êñ∞ÊòæÁ§∫
            updateTimelineDisplay();
            updateTimeSegmentsList();
            
        };
        
        // Ë∞ÉËØïÂáΩÊï∞ - Ê£ÄÊü•ÊâÄÊúâÁõ∏ÂÖ≥ÂÖÉÁ¥†
        window.checkTimeConditionElements = function() {
            
            const elements = {
                'timelineInteractArea': document.getElementById('timelineInteractArea'),
                'timeSelectionBox': document.getElementById('timeSelectionBox'),
                'timelineSegmentDisplay': document.getElementById('timelineSegmentDisplay'),
                'chargeTimeSegmentsList': document.getElementById('chargeTimeSegmentsList'),
                'dischargeTimeSegmentsList': document.getElementById('dischargeTimeSegmentsList'),
                'chargeSelectBtn': document.getElementById('chargeSelectBtn'),
                'dischargeSelectBtn': document.getElementById('dischargeSelectBtn'),
                'chargeSegmentCount': document.getElementById('chargeSegmentCount'),
                'dischargeSegmentCount': document.getElementById('dischargeSegmentCount')
            };
            
            for (const [id, element] of Object.entries(elements)) {
            }
            
            
            return elements;
        };
        
        // Ê£ÄÊü•‰∏§‰∏™Êó∂Èó¥ÊÆµÊòØÂê¶ÈáçÂè†
        function isTimeOverlap(segment1, segment2) {
            const start1 = timeToMinutes(segment1.start);
            const end1 = timeToMinutes(segment1.end);
            const start2 = timeToMinutes(segment2.start);
            const end2 = timeToMinutes(segment2.end);
            
            // Â§ÑÁêÜË∑®ÂçàÂ§úÁöÑÊÉÖÂÜµ
            if (end1 < start1) { // segment1 Ë∑®ÂçàÂ§ú
                if (end2 < start2) { // segment2 ‰πüË∑®ÂçàÂ§ú
                    return true; // ‰∏§‰∏™Ë∑®ÂçàÂ§úÁöÑÊÆµËÇØÂÆöÈáçÂè†
                } else {
                    return (start2 >= start1) || (end2 <= end1);
                }
            } else if (end2 < start2) { // Âè™Êúâ segment2 Ë∑®ÂçàÂ§ú
                return (start1 >= start2) || (end1 <= end2);
            } else { // ÈÉΩ‰∏çË∑®ÂçàÂ§ú
                return (start1 < end2) && (end1 > start2);
            }
        }
        
        // Â∞ÜÊó∂Èó¥Â≠óÁ¨¶‰∏≤ËΩ¨Êç¢‰∏∫ÂàÜÈíüÊï∞
        function timeToMinutes(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }
        
        // ÂàùÂßãÂåñ‰∫ã‰ª∂ÁõëÂê¨ÂíåÊï∞ÊçÆ
        setTimeout(() => {
            // ÂàùÂßãÂåñÊó∂Èó¥ÊÆµÊï∞ÁªÑ
            if (typeof chargeTimeSegments === 'undefined') {
                chargeTimeSegments = [{ start: '22:00', end: '06:00' }];
            }
            if (typeof dischargeTimeSegments === 'undefined') {
                dischargeTimeSegments = [{ start: '16:00', end: '21:00' }];
            }
            
        }, 500);
        
        // ËÆæÁΩÆÂç°ÁâáÁöÑÂèñÊ∂àÂíå‰øùÂ≠òÂäüËÉΩ
        function cancelSettings() {
            // ËøôÈáåÂèØ‰ª•ÈáçÁΩÆËÆæÁΩÆÂà∞‰πãÂâçÁöÑÁä∂ÊÄÅ
            // ÊöÇÊó∂Âè™ÊòæÁ§∫ÊèêÁ§∫
            alert(window.i18n && window.i18n.getCurrentLanguage() === 'en' ? 'Settings cancelled' : 'ËÆæÁΩÆÂ∑≤ÂèñÊ∂à');
        }
        
        function saveSettings() {
            // ËøôÈáåÂèØ‰ª•‰øùÂ≠òÂΩìÂâçËÆæÁΩÆÁä∂ÊÄÅ
            // ÊöÇÊó∂Âè™ÊòæÁ§∫ÊèêÁ§∫
            alert(window.i18n && window.i18n.getCurrentLanguage() === 'en' ? 'Settings saved' : 'ËÆæÁΩÆÂ∑≤‰øùÂ≠ò');
        }
    </script>
    
    <!-- Condition Settings Modal -->
    <div id="modalContent" class="modal-content" style="display: none; position: fixed; top: 3%; left: calc(50% - 450px); background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); padding: 0; width: 900px; max-width: 95%; max-height: 94vh; border-radius: 16px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); z-index: 2147483648; transition: none; user-select: none; cursor: move; flex-direction: column;">
            <div class="modal-header" style="padding: 24px 32px 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.08); display: flex; align-items: center; justify-content: space-between; background: rgba(255, 255, 255, 0.02); position: sticky; top: 0; z-index: 1;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <h3 style="margin: 0; font-size: 18px; font-weight: 700; color: #fff;" data-i18n="settings">ËÆæÁΩÆ</h3>
                    <span id="modalRegionName" style="padding: 4px 12px; background: var(--color-primary); color: #000; border-radius: 16px; font-size: 12px; font-weight: 600;">NSW</span>
                </div>
                <button onclick="closeConditionSettingsModal()" style="background: none; border: none; color: rgba(255,255,255,0.6); font-size: 24px; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='none'">√ó</button>
            </div>
            
            <div class="modal-body" style="padding: 24px 32px; overflow-y: auto; flex: 1; min-height: 0;">
                <!-- SOCËÆæÁΩÆ -->
                <div style="background: rgba(255,255,255,0.03); border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); padding: 20px; margin-bottom: 24px;">
                    <div style="color: rgba(255,255,255,0.9); font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
                        üîã <span data-i18n="socSettings">SOCËÆæÁΩÆ</span>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                        <!-- Charge Stop SOC -->
                        <div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <span style="font-size: 14px; color: #00ff88; font-weight: 600;" data-i18n="chargeStopSOC">ÂÖÖÁîµÂÅúÊ≠¢SOC</span>
                                <div style="display: flex; align-items: center; gap: 4px;">
                                    <input type="number" id="modalChargeStopSOC" value="90" min="0" max="100" 
                                           style="background: rgba(255,255,255,0.1); border: 1px solid rgba(0, 255, 136, 0.3); color: #00ff88; font-size: 12px; font-weight: 700; padding: 4px 8px; width: 50px; border-radius: 6px; text-align: center; outline: none;" 
                                           oninput="var bar = document.getElementById('modalChargeSOCBar'); var dot = document.getElementById('modalChargeSOCDot'); if(bar) bar.style.width = this.value + '%'; if(dot) dot.style.left = this.value + '%'; updateModalChargeSOC(this.value);" 
                                           onchange="var bar = document.getElementById('modalChargeSOCBar'); var dot = document.getElementById('modalChargeSOCDot'); if(bar) bar.style.width = this.value + '%'; if(dot) dot.style.left = this.value + '%'; updateModalChargeSOC(this.value);"
                                           onkeyup="var bar = document.getElementById('modalChargeSOCBar'); var dot = document.getElementById('modalChargeSOCDot'); if(bar) bar.style.width = this.value + '%'; if(dot) dot.style.left = this.value + '%'; updateModalChargeSOC(this.value);">
                                    <span style="font-size: 12px; color: #00ff88;">%</span>
                                </div>
                            </div>
                            <div style="position: relative;">
                                <div style="width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 6px; position: relative;">
                                    <div id="modalChargeSOCBar" style="width: 90%; height: 100%; background: #00ff88; border-radius: 6px; transition: width 0.3s;"></div>
                                    <div id="modalChargeSOCDot" style="position: absolute; left: 90%; width: 16px; height: 16px; background: #00ff88; border-radius: 50%; transform: translateX(-50%); top: 50%; margin-top: -8px; border: 2px solid #fff; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3); cursor: grab; transition: left 0.3s; z-index: 5;"></div>
                                </div>
                                <input type="range" id="modalChargeSOCSlider" min="0" max="100" value="90" 
                                       style="position: absolute; top: -8px; left: 0; width: 100%; height: 24px; opacity: 0; cursor: pointer; z-index: 10;" 
                                       oninput="updateModalChargeSOC(this.value)" onchange="updateModalChargeSOC(this.value)"
                                       onmousedown="event.stopPropagation();" onmousemove="event.stopPropagation();">
                            </div>
                        </div>
                        
                        <!-- Discharge Stop SOC -->
                        <div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <span style="font-size: 14px; color: #ffc107; font-weight: 600;" data-i18n="dischargeStopSOC">ÊîæÁîµÂÅúÊ≠¢SOC</span>
                                <div style="display: flex; align-items: center; gap: 4px;">
                                    <input type="number" id="modalDischargeStopSOC" value="20" min="0" max="100" 
                                           style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255, 193, 7, 0.3); color: #ffc107; font-size: 12px; font-weight: 700; padding: 4px 8px; width: 50px; border-radius: 6px; text-align: center; outline: none;" 
                                           oninput="var bar = document.getElementById('modalDischargeSOCBar'); var dot = document.getElementById('modalDischargeSOCDot'); if(bar) { bar.style.left = this.value + '%'; bar.style.width = (100 - this.value) + '%'; } if(dot) dot.style.left = this.value + '%'; updateModalDischargeSOC(this.value);" 
                                           onchange="var bar = document.getElementById('modalDischargeSOCBar'); var dot = document.getElementById('modalDischargeSOCDot'); if(bar) { bar.style.left = this.value + '%'; bar.style.width = (100 - this.value) + '%'; } if(dot) dot.style.left = this.value + '%'; updateModalDischargeSOC(this.value);"
                                           onkeyup="var bar = document.getElementById('modalDischargeSOCBar'); var dot = document.getElementById('modalDischargeSOCDot'); if(bar) { bar.style.left = this.value + '%'; bar.style.width = (100 - this.value) + '%'; } if(dot) dot.style.left = this.value + '%'; updateModalDischargeSOC(this.value);">
                                    <span style="font-size: 12px; color: #ffc107;">%</span>
                                </div>
                            </div>
                            <div style="position: relative;">
                                <div style="width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 6px; position: relative;">
                                    <div id="modalDischargeSOCBar" style="position: absolute; left: 20%; width: 80%; height: 100%; background: #ffc107; border-radius: 6px; transition: width 0.3s, left 0.3s;"></div>
                                    <div id="modalDischargeSOCDot" style="position: absolute; left: 20%; width: 16px; height: 16px; background: #ffc107; border-radius: 50%; transform: translateX(-50%); top: 50%; margin-top: -8px; border: 2px solid #fff; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3); cursor: grab; transition: left 0.3s; z-index: 5;"></div>
                                </div>
                                <input type="range" id="modalDischargeSOCSlider" min="0" max="100" value="20" 
                                       style="position: absolute; top: -8px; left: 0; width: 100%; height: 24px; opacity: 0; cursor: pointer; z-index: 10;" 
                                       oninput="updateModalDischargeSOC(this.value)" onchange="updateModalDischargeSOC(this.value)"
                                       onmousedown="event.stopPropagation();" onmousemove="event.stopPropagation();">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Ëá™Âä®Êù°‰ª∂Ê†áÈ¢ò -->
                <h2 style="margin: 0 0 20px 0; font-size: 18px; font-weight: 700; color: #fff;" data-i18n="autoConditions">Ëá™Âä®Êù°‰ª∂</h2>
                
                <!-- Auto Mode Conditions Container -->
                <div id="autoModeConditions" style="display: block;">

                <!-- Êó∂Èó¥Êù°‰ª∂ËÆæÁΩÆ -->
                <div style="background: rgba(255,255,255,0.03); border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); padding: 20px; margin-bottom: 24px;">
                    <div style="color: rgba(255,255,255,0.9); font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                        ‚è∞ <span data-i18n="timeConditionSettings">ÂàÜÊó∂ÊÆµ‰ª∑Ê†ºÁ≠ñÁï•</span>
                    </div>
                    <div style="margin-bottom: 20px; padding: 12px; background: rgba(0, 150, 255, 0.08); border-left: 3px solid #0096ff; border-radius: 6px; font-size: 13px; color: rgba(255, 255, 255, 0.8); line-height: 1.6;">
                        <span data-i18n="multiPeriodStrategyTip">üí° ‰∏∫‰∏çÂêåÊó∂Èó¥ÊÆµËÆæÁΩÆ‰∏çÂêå‰ª∑Ê†ºÈòàÂÄºÔºåÁ≥ªÁªüÂ∞ÜÂêåÊó∂ÁõëÊµãÊâÄÊúâÊó∂Èó¥ÊÆµÔºå‰ªªÊÑèÊù°‰ª∂Êª°Ë∂≥Âç≥Ëß¶ÂèëÁõ∏Â∫îÊìç‰Ωú„ÄÇÂãæÈÄâ‰ª∑Ê†ºÊù°‰ª∂ÂèØÂêØÁî®/Á¶ÅÁî®ËØ•Êó∂ÊÆµÁöÑ‰ª∑Ê†ºÈôêÂà∂„ÄÇ</span>
                    </div>
                    
                    <!-- 24Â∞èÊó∂Êó∂Èó¥ËΩ¥ÊòæÁ§∫ -->
                    <div style="margin-bottom: 24px;">
                        <div id="timelineDisplay" style="position: relative; height: 30px; background: rgba(255,255,255,0.05); border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); overflow: visible;">
                            <!-- Â∞èÊó∂ÂàªÂ∫¶Á∫ø -->
                            <div style="position: absolute; top: 0; left: 0; right: 0; height: 24px;">
                                <!-- ‰∏ªË¶ÅÂàªÂ∫¶Á∫ø (ÊØè6Â∞èÊó∂) -->
                                <div style="position: absolute; top: 0; bottom: 0; left: 0%; width: 1px; background: rgba(255,255,255,0.3);"></div>
                                <div style="position: absolute; top: 0; bottom: 0; left: 25%; width: 1px; background: rgba(255,255,255,0.3);"></div>
                                <div style="position: absolute; top: 0; bottom: 0; left: 50%; width: 1px; background: rgba(255,255,255,0.3);"></div>
                                <div style="position: absolute; top: 0; bottom: 0; left: 75%; width: 1px; background: rgba(255,255,255,0.3);"></div>
                                <div style="position: absolute; top: 0; bottom: 0; right: 0%; width: 1px; background: rgba(255,255,255,0.3);"></div>
                                <!-- Ê¨°Ë¶ÅÂàªÂ∫¶Á∫ø (ÊØè3Â∞èÊó∂) -->
                                <div style="position: absolute; top: 0; bottom: 0; left: 12.5%; width: 1px; background: rgba(255,255,255,0.15);"></div>
                                <div style="position: absolute; top: 0; bottom: 0; left: 37.5%; width: 1px; background: rgba(255,255,255,0.15);"></div>
                                <div style="position: absolute; top: 0; bottom: 0; left: 62.5%; width: 1px; background: rgba(255,255,255,0.15);"></div>
                                <div style="position: absolute; top: 0; bottom: 0; left: 87.5%; width: 1px; background: rgba(255,255,255,0.15);"></div>
                            </div>
                            <!-- Êó∂Èó¥Ê†áÁ≠æ -->
                            <div style="position: absolute; bottom: -18px; left: 0; right: 0; height: 16px; display: flex; justify-content: space-between; color: rgba(255,255,255,0.8); font-size: 11px; font-weight: 600;">
                                <span style="transform: translateX(-50%);">00:00</span>
                                <span style="transform: translateX(-50%);">03:00</span>
                                <span style="transform: translateX(-50%);">06:00</span>
                                <span style="transform: translateX(-50%);">09:00</span>
                                <span style="transform: translateX(-50%);">12:00</span>
                                <span style="transform: translateX(-50%);">15:00</span>
                                <span style="transform: translateX(-50%);">18:00</span>
                                <span style="transform: translateX(-50%);">21:00</span>
                                <span style="transform: translateX(-50%);">24:00</span>
                            </div>
                            <!-- ÂÖÖÁîµÂíåÊîæÁîµÊó∂Èó¥ÊÆµÊòæÁ§∫Âå∫Âüü - Âêå‰∏ÄË°å -->
                            <div id="chargeTimelineBlocks" style="position: absolute; top: 4px; left: 0; right: 0; height: 8px;"></div>
                            <div id="dischargeTimelineBlocks" style="position: absolute; top: 12px; left: 0; right: 0; height: 8px;"></div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                        <!-- ÂÖÖÁîµÊó∂Èó¥ÊÆµ -->
                        <div>
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                                <h4 style="font-size: 14px; font-weight: 600; color: #00ff88; margin: 0;" data-i18n="chargeTime" data-text-zh="ÂÖÖÁîµÊó∂Èó¥" data-text-en="Charge Time">ÂÖÖÁîµÊó∂Èó¥</h4>
                                <button onclick="addTimePeriod('charge')" style="background: transparent; border: 1px dashed rgba(0, 255, 136, 0.4); color: #00ff88; padding: 4px 8px; border-radius: 6px; font-size: 12px; cursor: pointer;">
                                    + <span data-i18n="add" data-text-zh="Ê∑ªÂä†" data-text-en="Add">Ê∑ªÂä†</span>
                                </button>
                            </div>
                            <div id="chargeTimePeriods" style="display: flex; flex-direction: column; gap: 8px;"></div>
                        </div>

                        <!-- ÊîæÁîµÊó∂Èó¥ÊÆµ -->
                        <div>
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                                <h4 style="font-size: 14px; font-weight: 600; color: #ffc107; margin: 0;" data-i18n="dischargeTime" data-text-zh="ÊîæÁîµÊó∂Èó¥" data-text-en="Discharge Time">ÊîæÁîµÊó∂Èó¥</h4>
                                <button onclick="addTimePeriod('discharge')" style="background: transparent; border: 1px dashed rgba(255, 193, 7, 0.4); color: #ffc107; padding: 4px 8px; border-radius: 6px; font-size: 12px; cursor: pointer;">
                                    + <span data-i18n="add" data-text-zh="Ê∑ªÂä†" data-text-en="Add">Ê∑ªÂä†</span>
                                </button>
                            </div>
                            <div id="dischargeTimePeriods" style="display: flex; flex-direction: column; gap: 8px;"></div>
                        </div>
                    </div>
                </div>
                    
                    <!-- Êó∂Èó¥Êù°‰ª∂Ê†∑Âºè -->
                    <style>
                        .time-period-item {
                            display: flex;
                            align-items: center;
                            gap: 6px;
                            padding: 8px 10px;
                            background: rgba(255, 255, 255, 0.03);
                            border-radius: 6px;
                            border: 1px solid rgba(255, 255, 255, 0.08);
                            transition: all 0.3s ease;
                            min-width: 0;
                        }

                        .time-period-item:hover {
                            background: rgba(255, 255, 255, 0.05);
                            border-color: rgba(255, 255, 255, 0.1);
                        }

                        .time-period-inputs {
                            display: flex;
                            align-items: center;
                            gap: 6px;
                            flex: 1;
                            min-width: 0;
                            flex-wrap: nowrap;
                        }

                        .time-input {
                            width: 70px;
                            padding: 4px 6px;
                            background: rgba(255, 255, 255, 0.05);
                            border: 1px solid rgba(255, 255, 255, 0.1);
                            border-radius: 6px;
                            color: rgba(255, 255, 255, 0.9);
                            font-size: 12px;
                            text-align: center;
                            transition: all 0.3s ease;
                            flex-shrink: 0;
                        }

                        .time-input.price-input {
                            width: 60px;
                        }

                        .time-input:focus {
                            outline: none;
                            border-color: #00ff88;
                            box-shadow: 0 0 0 2px rgba(0, 255, 136, 0.1);
                        }

                        .time-period-separator {
                            color: rgba(255, 255, 255, 0.6);
                            font-size: 12px;
                            flex-shrink: 0;
                        }

                        .period-action-btn {
                            padding: 4px 6px;
                            background: transparent;
                            border: none;
                            color: #ff6b6b;
                            font-size: 12px;
                            cursor: pointer;
                            border-radius: 6px;
                            transition: all 0.3s ease;
                            flex-shrink: 0;
                        }

                        .period-action-btn:hover {
                            background: rgba(255, 107, 107, 0.1);
                            color: #ff8a8a;
                        }
                    </style>
                </div>
                </div><!-- End of autoModeConditions -->
                
                <!-- Modal Footer Buttons -->
                <div style="display: flex; justify-content: flex-end; gap: 12px; margin: 32px 24px 24px 24px; padding-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.08);">
                    <button onclick="closeConditionSettingsModal()" style="background: rgba(255, 255, 255, 0.08); color: rgba(255, 255, 255, 0.8); border: 1px solid rgba(255, 255, 255, 0.1); padding: 10px 20px; border-radius: 10px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.3s;" data-i18n="cancel">ÂèñÊ∂à</button>
                    <button onclick="saveConditionSettings()" style="background: linear-gradient(135deg, #00ff88, #00dd77); color: #000; padding: 10px 20px; border-radius: 10px; font-size: 13px; font-weight: 700; cursor: pointer; transition: all 0.3s; border: none;" data-i18n="saveSettings">‰øùÂ≠òËÆæÁΩÆ</button>
                </div>
                
                </div>
            </div>
            
            
        </div>
    </div>
    
    <!-- SOC Edit Modal -->
    <div id="socEditModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 10003; align-items: center; justify-content: center; backdrop-filter: blur(15px) saturate(1.5);">
        <div class="modal-content" style="background: linear-gradient(145deg, #1e1e2e 0%, #252535 100%); border: none; padding: 0; overflow: hidden; width: 480px; max-width: 90%; border-radius: 24px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8), 0 0 1px rgba(255, 255, 255, 0.1);">
            <div class="modal-header" style="padding: 28px 32px; border-bottom: 1px solid rgba(255, 255, 255, 0.08); display: flex; align-items: center; justify-content: space-between; background: rgba(255, 255, 255, 0.02);">
                <h3 style="margin: 0; font-size: 20px; font-weight: 700; color: #fff; letter-spacing: 0.3px;" data-i18n="socSettings">SOC ËÆæÁΩÆ</h3>
                <button onclick="closeSOCEditModal()" style="background: none; border: none; color: rgba(255,255,255,0.6); font-size: 24px; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='none'">√ó</button>
            </div>
            
            <div class="modal-body" style="padding: 32px;">
                <!-- Charge Stop SOC Setting -->
                <div style="margin-bottom: 28px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <label style="color: #00ff88; font-size: 14px; font-weight: 600;" data-i18n="chargeStopSOC">ÂÖÖÁîµÂÅúÊ≠¢SOC</label>
                        <div style="display: flex; align-items: center; gap: 4px;">
                            <input type="number" id="modalChargeSOCInput" min="0" max="100" value="90" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 6px 8px; border-radius: 6px; width: 50px; font-size: 13px; outline: none; transition: all 0.2s;" oninput="updateModalChargeSOCFromInput(this.value)" onfocus="this.style.borderColor='rgba(0,255,136,0.5)'; this.style.background='rgba(255,255,255,0.15)'" onblur="this.style.borderColor='rgba(255,255,255,0.2)'; this.style.background='rgba(255,255,255,0.1)'">
                            <span style="color: rgba(255,255,255,0.7); font-size: 14px;">%</span>
                        </div>
                    </div>
                    <div style="position: relative; width: 100%; height: 32px; display: flex; align-items: center;">
                        <div style="width: 100%; height: 8px; background: linear-gradient(to bottom, rgba(0, 0, 0, 0.2), rgba(255, 255, 255, 0.05)); border-radius: 6px; position: absolute; box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.05);">
                            <div id="modalChargeSOCProgressBar" style="width: 90%; height: 100%; background: linear-gradient(90deg, #00ff88 0%, #00dd77 50%, #00ff88 100%); border-radius: 6px; transition: width 0.3s ease; box-shadow: 0 0 15px rgba(0, 255, 136, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.3); position: relative; overflow: hidden;">
                                <div style="position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.3) 50%, transparent 100%); animation: shimmer 2s infinite;"></div>
                            </div>
                        </div>
                        <!-- ÊªëÂùóÂúÜÁÇπ -->
                        <div id="modalChargeSOCThumb" style="position: absolute; left: 90%; width: 20px; height: 20px; background: radial-gradient(circle at 30% 30%, #00ff88, #00cc6a); border-radius: 50%; transform: translateX(-50%); border: 2px solid rgba(255, 255, 255, 0.2); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3), inset 0 1px 2px rgba(255, 255, 255, 0.3); transition: box-shadow 0.15s ease, transform 0.15s ease; pointer-events: none; z-index: 1;"></div>
                        <input type="range" id="modalChargeSOCSlider" min="0" max="100" value="90" style="position: absolute; width: 100%; height: 32px; opacity: 0; cursor: pointer; z-index: 2;" oninput="updateModalChargeSOC(this.value)" onmouseover="document.getElementById('modalChargeSOCThumb').style.transform='translateX(-50%) scale(1.15)'; document.getElementById('modalChargeSOCThumb').style.boxShadow='0 0 20px rgba(0, 255, 136, 0.6), 0 4px 12px rgba(0, 0, 0, 0.4), inset 0 1px 2px rgba(255, 255, 255, 0.4)'" onmouseout="document.getElementById('modalChargeSOCThumb').style.transform='translateX(-50%)'; document.getElementById('modalChargeSOCThumb').style.boxShadow='0 2px 8px rgba(0, 0, 0, 0.3), inset 0 1px 2px rgba(255, 255, 255, 0.3)'">
                    </div>
                </div>
                
                <!-- Discharge Stop SOC Setting -->
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <label style="color: #ffc107; font-size: 14px; font-weight: 600;" data-i18n="dischargeStopSOC">ÊîæÁîµÂÅúÊ≠¢SOC</label>
                        <div style="display: flex; align-items: center; gap: 4px;">
                            <input type="number" id="modalDischargeSOCInput" min="0" max="100" value="20" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 6px 8px; border-radius: 6px; width: 50px; font-size: 13px; outline: none; transition: all 0.2s;" oninput="updateModalDischargeSOCFromInput(this.value)" onfocus="this.style.borderColor='rgba(255,193,7,0.5)'; this.style.background='rgba(255,255,255,0.15)'" onblur="this.style.borderColor='rgba(255,255,255,0.2)'; this.style.background='rgba(255,255,255,0.1)'">
                            <span style="color: rgba(255,255,255,0.7); font-size: 14px;">%</span>
                        </div>
                    </div>
                    <div style="position: relative; width: 100%; height: 32px; display: flex; align-items: center;">
                        <div style="width: 100%; height: 8px; background: linear-gradient(to bottom, rgba(0, 0, 0, 0.2), rgba(255, 255, 255, 0.05)); border-radius: 6px; position: absolute; box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.05);">
                            <div id="modalDischargeSOCProgressBar" style="position: absolute; left: 20%; width: 80%; height: 100%; background: linear-gradient(90deg, #ffc107 0%, #ff9800 50%, #ffc107 100%); border-radius: 6px; transition: all 0.3s ease; box-shadow: 0 0 15px rgba(255, 193, 7, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.3); position: relative; overflow: hidden;">
                                <div style="position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.3) 50%, transparent 100%); animation: shimmer 2s infinite;"></div>
                            </div>
                        </div>
                        <!-- ÊªëÂùóÂúÜÁÇπ -->
                        <div id="modalDischargeSOCThumb" style="position: absolute; left: 20%; width: 20px; height: 20px; background: radial-gradient(circle at 30% 30%, #ffc107, #ff9800); border-radius: 50%; transform: translateX(-50%); border: 2px solid rgba(255, 255, 255, 0.2); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3), inset 0 1px 2px rgba(255, 255, 255, 0.3); transition: box-shadow 0.15s ease, transform 0.15s ease; pointer-events: none; z-index: 1;"></div>
                        <input type="range" id="modalDischargeSOCSlider" min="0" max="100" value="20" style="position: absolute; width: 100%; height: 32px; opacity: 0; cursor: pointer; z-index: 2;" oninput="updateModalDischargeSOC(this.value)" onmouseover="document.getElementById('modalDischargeSOCThumb').style.transform='translateX(-50%) scale(1.15)'; document.getElementById('modalDischargeSOCThumb').style.boxShadow='0 0 20px rgba(255, 193, 7, 0.6), 0 4px 12px rgba(0, 0, 0, 0.4), inset 0 1px 2px rgba(255, 255, 255, 0.4)'" onmouseout="document.getElementById('modalDischargeSOCThumb').style.transform='translateX(-50%)'; document.getElementById('modalDischargeSOCThumb').style.boxShadow='0 2px 8px rgba(0, 0, 0, 0.3), inset 0 1px 2px rgba(255, 255, 255, 0.3)'">
                    </div>
                </div>
            </div>
            
            <div class="modal-footer" style="padding: 28px 36px 32px; background: rgba(0, 0, 0, 0.2); border-top: 1px solid rgba(255, 255, 255, 0.08); display: flex; justify-content: flex-end; gap: 16px;">
                <button onclick="closeSOCEditModal()" style="background: rgba(255, 255, 255, 0.08); color: rgba(255, 255, 255, 0.8); border: 1px solid rgba(255, 255, 255, 0.1); padding: 14px 36px; border-radius: 999px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s; backdrop-filter: blur(20px) saturate(1.5); letter-spacing: 0.5px;" onmouseover="this.style.background='rgba(255, 255, 255, 0.12)'; this.style.borderColor='rgba(255, 255, 255, 0.2)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.08)'; this.style.borderColor='rgba(255, 255, 255, 0.1)'" data-i18n="cancel">ÂèñÊ∂à</button>
                <button onclick="saveSOCSettings()" style="background: linear-gradient(135deg, #00ff88, #00dd77); color: #000; padding: 14px 36px; border-radius: 999px; font-size: 15px; font-weight: 700; cursor: pointer; transition: all 0.3s; border: none; box-shadow: 0 4px 16px rgba(0, 255, 136, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.3); letter-spacing: 0.5px;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 6px 20px rgba(0, 255, 136, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 16px rgba(0, 255, 136, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.3)'" data-i18n="save">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>
    
    <!-- ÂÖ®Â±ÄÊé®ÈÄÅÂºπÁ™ó -->
    <!-- ÊôÆÈÄöÂÖÖÁîµÊèêÈÜí -->
    <div class="push-notification" id="normalChargeNotification">
        <div class="push-notification-header">
            <div class="push-notification-title">
                <span class="push-notification-icon">‚ö°</span>
                <span><span data-i18n="chargeReminder">ÂÖÖÁîµÊèêÈÜí</span>‚Äî‚Äî<span class="notification-region">NSW</span></span>
            </div>
            <button class="push-notification-close" onclick="closePushNotification('normalChargeNotification')">
                <span>√ó</span>
            </button>
        </div>
        <div class="push-notification-content">
            <p><span data-i18n="currentPrice">ÂΩìÂâç‰ª∑Ê†º</span><span class="highlight-number notification-price">$300</span><span data-i18n="belowThreshold">Ôºå‰Ωé‰∫éÈòàÂÄº</span><span class="highlight-value notification-threshold">$250</span><span data-i18n="pleaseCharge">ÔºåËØ∑ÂÖÖÁîµ</span></p>
        </div>
    </div>

    <!-- ÊôÆÈÄöÊîæÁîµÊèêÈÜí -->
    <div class="push-notification" id="normalDischargeNotification">
        <div class="push-notification-header">
            <div class="push-notification-title">
                <span class="push-notification-icon">üîã</span>
                <span><span data-i18n="dischargeReminder">ÊîæÁîµÊèêÈÜí</span>‚Äî‚Äî<span class="notification-region">NSW</span></span>
            </div>
            <button class="push-notification-close" onclick="closePushNotification('normalDischargeNotification')">
                <span>√ó</span>
            </button>
        </div>
        <div class="push-notification-content">
            <p><span data-i18n="currentPrice">ÂΩìÂâç‰ª∑Ê†º</span><span class="highlight-number notification-price">$300</span><span data-i18n="aboveThreshold">ÔºåÈ´ò‰∫éÈòàÂÄº</span><span class="highlight-value notification-threshold">$250</span><span data-i18n="pleaseDischarge">ÔºåËØ∑ÊîæÁîµ</span></p>
        </div>
    </div>

    <!-- ÊúÄ‰Ω≥ÂÖÖÁîµ/ÊîæÁîµÊèêÈÜí -->
    <div class="push-notification" id="optimalNotification">
        <div class="push-notification-header">
            <div class="push-notification-title">
                <span class="push-notification-icon">üéØ</span>
                <span><span data-i18n="optimalReminder">ÊúÄ‰Ω≥ÂÖÖÁîµÊèêÈÜí</span>‚Äî‚Äî<span class="notification-region">NSW</span></span>
            </div>
            <button class="push-notification-close" onclick="closePushNotification('optimalNotification')">
                <span>√ó</span>
            </button>
        </div>
        <div class="push-notification-content">
            <p><span class="notification-region">NSW</span><span data-i18n="regionPrice">Âú∞Âå∫ÂÖÖÁîµ‰ª∑Ê†º</span><span class="highlight-number notification-price">$319</span><span data-i18n="timeRemaining">ÔºåËøòÊúâ</span><span class="highlight-value notification-time">27</span><span data-i18n="minutesToOptimal">ÂàÜÈíüÂà∞ËææÊúÄ‰Ω≥ÊîæÁîµÊó∂Êú∫ÔºåËØ∑ÂÅöÂ•ΩÂáÜÂ§á</span></p>
        </div>
    </div>

    <!-- È´ò‰ª∑/‰Ωé‰ª∑ÂÖÖÁîµ/ÊîæÁîµÊèêÈÜí -->
    <div class="push-notification" id="priceAlertNotification">
        <div class="push-notification-header">
            <div class="push-notification-title">
                <span class="push-notification-icon">üí∞</span>
                <span><span class="notification-price-type">È´ò‰ª∑</span><span class="notification-action-type">ÂÖÖÁîµ</span><span data-i18n="priceAlert">ÊèêÈÜí</span>‚Äî‚Äî<span class="notification-region">NSW</span></span>
            </div>
            <button class="push-notification-close" onclick="closePushNotification('priceAlertNotification')">
                <span>√ó</span>
            </button>
        </div>
        <div class="push-notification-content">
            <p><span class="notification-region">NSW</span><span data-i18n="regionPrice">Âú∞Âå∫ÂÖÖÁîµ‰ª∑Ê†º</span><span class="highlight-number notification-price">$319</span><span data-i18n="timeRemaining">ÔºåËøòÊúâ</span><span class="highlight-value notification-time">27</span><span data-i18n="minutesToPrice">ÂàÜÈíüÂà∞Ëææ</span><span class="notification-price-type">È´ò‰ª∑</span><span class="notification-action-type">ÂÖÖÁîµ</span><span data-i18n="timeOpportunity">Êó∂Êú∫ÔºåËØ∑ÂÅöÂ•ΩÂáÜÂ§á</span></p>
        </div>
    </div>
    

    <!-- Á´ãÂç≥Â∞ùËØïÂàùÂßãÂåñHeaderNav -->
    <script>
        // ÂÖ®Â±ÄÊé®ÈÄÅÂºπÁ™óÂäüËÉΩ
        let pushNotificationTimeouts = {};

        // ÊòæÁ§∫Êé®ÈÄÅÂºπÁ™ó
        function showPushNotification(notificationId, data = {}) {
            const notification = document.getElementById(notificationId);
            
            if (!notification) return;
            
            // Êõ¥Êñ∞ÂÜÖÂÆπ
            if (data.region || data.price || data.threshold || data.action || data.timeRemaining) {
                updateNotificationContent(notificationId, data);
            }
            
            // ÊòæÁ§∫ÂºπÁ™ó
            notification.classList.add('show');
            notification.classList.remove('hide');
            
            // ‰∏çËÆæÁΩÆËá™Âä®ÈöêËóèÂÆöÊó∂Âô®ÔºåÂè™ËÉΩÊâãÂä®ÂÖ≥Èó≠
            // Ê∏ÖÈô§‰πãÂâçÁöÑÂÆöÊó∂Âô®ÔºàÂ¶ÇÊûúÊúâÁöÑËØùÔºâ
            if (pushNotificationTimeouts[notificationId]) {
                clearTimeout(pushNotificationTimeouts[notificationId]);
                delete pushNotificationTimeouts[notificationId];
            }
        }

        // ÂÖ≥Èó≠Êé®ÈÄÅÂºπÁ™ó
        function closePushNotification(notificationId) {
            const notification = document.getElementById(notificationId);
            if (!notification) return;
            
            notification.classList.add('hide');
            notification.classList.remove('show');
            
            // Ê∏ÖÈô§ÂÆöÊó∂Âô®
            if (pushNotificationTimeouts[notificationId]) {
                clearTimeout(pushNotificationTimeouts[notificationId]);
                delete pushNotificationTimeouts[notificationId];
            }
        }
        
        
        // Êõ¥Êñ∞ÂºπÁ™óÂÜÖÂÆπ
        function updateNotificationContent(notificationId, data) {
            const notification = document.getElementById(notificationId);
            if (!notification) return;
            
            const contentElement = notification.querySelector('.push-notification-content p');
            const titleElement = notification.querySelector('.push-notification-title span:last-child');
            if (!contentElement) return;
            
            const currentLang = window.i18n ? window.i18n.getCurrentLanguage() : 'zh';
            
            if (notificationId === 'normalPushNotification') {
                const action = data.action || 'ÂÖÖÁîµ';
                const region = data.region || 'NSW';
                const price = data.price || '300';
                const threshold = data.threshold || '250';
                
                // ÊôÆÈÄöÔºöÊîæÁîµ/ÂÖÖÁîµÊèêÈÜí‚Äî‚ÄîÂú∞Âå∫
                if (titleElement) {
                    if (currentLang === 'en') {
                        const actionEn = action === 'ÂÖÖÁîµ' ? 'Charge' : 'Discharge';
                        titleElement.textContent = data.customTitleEn || `${actionEn} Reminder - ${region}`;
                    } else {
                        titleElement.textContent = data.customTitle || `${action}ÊèêÈÜí‚Äî‚Äî${region}`;
                    }
                }
                
                // ÂÜÖÂÆπÔºöÂΩìÂâç‰ª∑Ê†ºÂ§öÂ∞ëÔºåË∂ÖËøá/‰Ωé‰∫éÈòàÂÄºÔºåËØ∑ÊîæÁîµ/ÂÖÖÁîµ
                const highlightPrice = `<span class="highlight-number">$${price}</span>`;
                const highlightThreshold = `<span class="highlight-number">$${threshold}</span>`;
                
                if (currentLang === 'en') {
                    const comparison = action === 'ÂÖÖÁîµ' ? 'below threshold' : 'above threshold';
                    const actionEn = action === 'ÂÖÖÁîµ' ? 'charge' : 'discharge';
                    const highlightAction = `<span class="highlight-action">${actionEn}</span>`;
                    contentElement.innerHTML = `Current price ${highlightPrice} ${comparison} ${highlightThreshold}, please ${highlightAction}`;
                } else {
                    const comparison = action === 'ÂÖÖÁîµ' ? '‰Ωé‰∫é' : 'Ë∂ÖËøá';
                    const highlightAction = `<span class="highlight-action">${action}</span>`;
                    contentElement.innerHTML = (window.i18n && window.i18n.getCurrentLanguage() === 'en') ? `Price ${highlightPrice}, ${comparison} threshold ${highlightThreshold}, please ${highlightAction}` : `ÂΩìÂâç‰ª∑Ê†º${highlightPrice}Ôºå${comparison}ÈòàÂÄº${highlightThreshold}ÔºåËØ∑${highlightAction}`;
                }
                
            } else if (notificationId === 'advancedPushNotification') {
                const region = data.region || 'NSW';
                const price = data.price || '300';
                const timeRemaining = data.timeRemaining || '15ÂàÜÈíü';
                const action = data.action || 'ÂÖÖÁîµ';
                
                // È´òÁ∫ßÔºöÊúÄ‰Ω≥ÊîæÁîµÊó∂Êú∫‚Äî‚ÄîÂú∞Âå∫
                if (titleElement) {
                    if (currentLang === 'en') {
                        const actionEn = action === 'ÂÖÖÁîµ' ? 'Charge' : 'Discharge';
                        titleElement.textContent = data.customTitleEn || `Optimal ${actionEn} Reminder - ${region}`;
                    } else {
                        titleElement.textContent = data.customTitle || `ÊúÄ‰Ω≥${action}Êó∂Êú∫‚Äî‚Äî${region}`;
                    }
                }
                
                // ÂÜÖÂÆπÔºöÂΩìÂâç‰ª∑Ê†ºÂ§öÂ∞ëÔºåËøòÊúâÂ§ö‰πÖÂà∞ËææÊúÄ‰Ω≥ÊîæÁîµÊó∂Èó¥ÔºåËØ∑ÂÅöÂ•ΩÂáÜÂ§á
                const highlightPrice = `<span class="highlight-number">$${price}</span>`;
                const highlightTime = `<span class="highlight-time">${timeRemaining}</span>`;
                
                if (currentLang === 'en') {
                    const actionEn = action === 'ÂÖÖÁîµ' ? 'charge' : 'discharge';
                    const timeEn = timeRemaining.replace('ÂàÜÈíü', ' minutes');
                    contentElement.innerHTML = `${region} region ${actionEn} price ${highlightPrice}, ${timeEn} until optimal ${actionEn} time, please prepare`;
                } else {
                    const opportunityText = `ÊúÄ‰Ω≥${action}Êó∂Èó¥`;
                    contentElement.innerHTML = (window.i18n && window.i18n.getCurrentLanguage() === 'en') ? `Price ${highlightPrice}, ${highlightTime} to ${opportunityText}, please prepare` : `ÂΩìÂâç‰ª∑Ê†º${highlightPrice}ÔºåËøòÊúâ${highlightTime}Âà∞Ëææ${opportunityText}ÔºåËØ∑ÂÅöÂ•ΩÂáÜÂ§á`;
                }
            }
        }

        // Ê®°ÊãüÊé®ÈÄÅÈÄöÁü•ÂáΩÊï∞Ôºà‰æõÊµãËØï‰ΩøÁî®Ôºâ
        function simulatePushNotifications() {
            let pushCount = 0;
            
            // ÂÆö‰πâÂõõÁßçÊé®ÈÄÅÁ±ªÂûã
            const pushTypes = [
                {
                    type: 'normal',
                    action: 'ÂÖÖÁîµ',
                    title: 'ÂÖÖÁîµÊèêÈÜí‚Äî‚ÄîNSW',
                    titleEn: 'Charging Alert - NSW',
                    price: () => (200 + Math.floor(Math.random() * 50)).toString(),
                    threshold: '250',
                    region: 'NSW'
                },
                {
                    type: 'normal',
                    action: 'ÊîæÁîµ',
                    title: 'ÊîæÁîµÊèêÈÜí‚Äî‚ÄîNSW',
                    titleEn: 'Discharging Alert - NSW',
                    price: () => (350 + Math.floor(Math.random() * 100)).toString(),
                    threshold: '300',
                    region: 'NSW'
                },
                {
                    type: 'advanced',
                    action: 'ÂÖÖÁîµ',
                    title: 'ÊúÄ‰Ω≥ÂÖÖÁîµÊó∂Êú∫‚Äî‚ÄîNSW',
                    titleEn: 'Optimal Charging Time - NSW',
                    price: () => (180 + Math.floor(Math.random() * 80)).toString(),
                    timeRemaining: () => (5 + Math.floor(Math.random() * 25)) + 'ÂàÜÈíü',
                    region: 'NSW'
                },
                {
                    type: 'advanced',
                    action: 'ÊîæÁîµ',
                    title: 'ÊúÄ‰Ω≥ÊîæÁîµÊó∂Êú∫‚Äî‚ÄîNSW',
                    titleEn: 'Optimal Discharging Time - NSW',
                    price: () => (400 + Math.floor(Math.random() * 100)).toString(),
                    timeRemaining: () => (10 + Math.floor(Math.random() * 30)) + 'ÂàÜÈíü',
                    region: 'NSW'
                }
            ];
            
            // ÊØè10ÁßíÊé®ÈÄÅ‰∏ÄÊ¨°ÔºåÂæ™ÁéØÊòæÁ§∫ÂõõÁßçÁ±ªÂûã
            setInterval(() => {
                const currentPush = pushTypes[pushCount % 4];
                pushCount++;
                
                if (currentPush.type === 'normal') {
                    showPushNotification('normal', {
                        region: 'NSW',
                        price: currentPush.price(),
                        threshold: currentPush.threshold,
                        action: currentPush.action,
                        customTitle: currentPush.title,
                        customTitleEn: currentPush.titleEn
                    });
                } else {
                    showPushNotification('advanced', {
                        region: 'NSW',
                        price: currentPush.price(),
                        timeRemaining: currentPush.timeRemaining(),
                        action: currentPush.action,
                        customTitle: currentPush.title,
                        customTitleEn: currentPush.titleEn
                    });
                }
            }, 10000); // ÊØè10ÁßíÊé®ÈÄÅ‰∏ÄÊ¨°
            
            // È¶ñÊ¨°Êé®ÈÄÅÔºàÈ°µÈù¢Âä†ËΩΩÂêé3ÁßíÔºâ- ÊôÆÈÄöÂÖÖÁîµ
            setTimeout(() => {
                showPushNotification('normal', {
                    region: 'NSW',
                    price: '300',
                    threshold: '250',
                    action: 'ÂÖÖÁîµ',
                    customTitle: 'ÂÖÖÁîµÊèêÈÜí‚Äî‚ÄîÊôÆÈÄö',
                    customTitleEn: 'Charging Alert - Normal'
                });
            }, 3000);
        }

        // Á´ãÂç≥Â∞ùËØïÂàùÂßãÂåñHeaderNav
        setTimeout(() => {
            if (typeof initHeaderNav === 'function') {
                initHeaderNav();
            }
        }, 100);
        
        // Âº∫Âà∂ÊâßË°åÂú∞Âå∫ÊòæÁ§∫Êõ¥Êñ∞
        setTimeout(() => {
            if (typeof updateRegionDisplay === 'function') {
                updateRegionDisplay();
            }
        }, 200);
        
        // ÂêØÂä®Ê®°ÊãüÊé®ÈÄÅÔºà‰ªÖ‰æõÊµãËØïÔºåÂèØÊ≥®ÈáäÊéâÔºâ
        // simulatePushNotifications();
        
    </script>

    <script>


        // ÊãñÊãΩÂäüËÉΩÂÆûÁé∞
        function makeDraggable(element) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            
            element.onmousedown = dragMouseDown;

            function dragMouseDown(e) {
                e = e || window.event;
                
                // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÊåâÈíÆÊàñË°®ÂçïÂÖÉÁ¥†Ôºå‰∏çÂêØÂä®ÊãñÊãΩ
                const target = e.target;
                if (target.tagName === 'BUTTON' || target.tagName === 'INPUT' || target.tagName === 'SELECT' || 
                    target.tagName === 'TEXTAREA' || target.closest('button') || target.closest('input') ||
                    target.closest('select') || target.closest('textarea') || target.classList.contains('expand-btn')) {
                    return;
                }
                
                // Â¶ÇÊûúÊòØÁº©Â∞èÁä∂ÊÄÅ‰∏î‰∏çÊòØÂ±ïÂºÄÁÇπÂáªÔºåÂÖÅËÆ∏ÊãñÊãΩ
                if (element.classList.contains('minimized')) {
                    // ËÆ∞ÂΩïÂàùÂßãÈº†Ê†á‰ΩçÁΩÆÔºåÁî®‰∫éÂà§Êñ≠ÊòØÁÇπÂáªËøòÊòØÊãñÊãΩ
                    window.dragStartX = e.clientX;
                    window.dragStartY = e.clientY;
                    window.isDragging = false;
                }
                
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
                element.style.cursor = 'grabbing';
                element.style.transition = 'none';
            }

            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                
                // Ê†áËÆ∞‰∏∫Ê≠£Âú®ÊãñÊãΩ
                if (element.classList.contains('minimized')) {
                    const deltaX = Math.abs(e.clientX - window.dragStartX);
                    const deltaY = Math.abs(e.clientY - window.dragStartY);
                    if (deltaX > 5 || deltaY > 5) {
                        window.isDragging = true;
                    }
                }
                
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                
                let newTop = element.offsetTop - pos2;
                let newLeft = element.offsetLeft - pos1;
                
                // ËæπÁïåÊ£ÄÊµã
                const rect = element.getBoundingClientRect();
                const maxX = window.innerWidth - rect.width;
                const maxY = window.innerHeight - rect.height;
                
                newLeft = Math.max(0, Math.min(newLeft, maxX));
                newTop = Math.max(0, Math.min(newTop, maxY));
                
                element.style.top = newTop + "px";
                element.style.left = newLeft + "px";
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
                element.style.cursor = 'move';
                element.style.transition = 'transform 0.2s ease';
            }
        }

        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñÊãñÊãΩÂäüËÉΩ
        document.addEventListener('DOMContentLoaded', function() {
            
            // ÂàùÂßãÂåñÂú∞Âå∫Êù°‰ª∂ÊÄªËßàÂç°Áâá
            setTimeout(() => {
                initRegionOverviewCard();
            }, 500);
            
            // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊÅ¢Â§çÊ®°ÊÄÅÊ°Ü
            checkAndRestoreModal();
        });
        
        // Ê£ÄÊü•Âπ∂ÊÅ¢Â§çÊ®°ÊÄÅÊ°ÜÁä∂ÊÄÅ
        function checkAndRestoreModal() {
            const isModalOpen = localStorage.getItem('conditionSettingsModalOpen');
            const savedPosition = localStorage.getItem('modalPosition');
            
            if (isModalOpen === 'true') {
                const modalContent = document.getElementById('modalContent');
                if (modalContent) {
                    // Á°Æ‰øùÊó∂Èó¥ÊÆµÂèòÈáèÂ∑≤ÂàùÂßãÂåñ
                    window.chargeTimeSegments = window.chargeTimeSegments || [{ start: '22:00', end: '06:00' }];
                    window.dischargeTimeSegments = window.dischargeTimeSegments || [{ start: '16:00', end: '21:00' }];
                    
                    // ÊÅ¢Â§çÊ®°ÊÄÅÊ°ÜÊòæÁ§∫
                    modalContent.style.display = 'flex';
                    
                    // ÊÅ¢Â§ç‰ΩçÁΩÆ
                    if (savedPosition) {
                        try {
                            const position = JSON.parse(savedPosition);
                            modalContent.style.top = position.top;
                            modalContent.style.left = position.left;
                        } catch (e) {
                            console.error('Error parsing saved position:', e);
                        }
                    }
                    
                    // ÂàùÂßãÂåñÊãñÊãΩÂäüËÉΩ
                    makeModalDraggable(modalContent);
                    
                    // Âº∫Âà∂ËÆæÁΩÆÊúÄÈ´òÂ±ÇÁ∫ß
                    modalContent.style.setProperty('z-index', '2147483648', 'important');
                    modalContent.style.setProperty('position', 'fixed', 'important');
                    
                    // Êõ¥Êñ∞ÁøªËØë
                    if (window.i18n && window.i18n.isReady) {
                        window.i18n.updatePageTexts();
                        updateModalTranslations();
                    }
                    
                    // Restore saved mode
                    const savedMode = localStorage.getItem('modalMode') || 'manual';
                    switchModalMode(savedMode);
                    
                    // Âä†ËΩΩÂΩìÂâçÂú∞Âå∫ÁöÑÊù°‰ª∂ËÆæÁΩÆ
                    setTimeout(loadConditionSettings, 500);
                    
                }
            }
        }

        // Ê®°ÊÄÅÊ°ÜÊãñÊãΩÂäüËÉΩ - Â§çÂà∂ÊµãËØïÂç°ÁâáÈÄªËæë
        function makeModalDraggable(element) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            
            element.onmousedown = dragMouseDown;
            
            // Âä®ÊÄÅËÆæÁΩÆÂÖâÊ†á
            element.addEventListener('mouseover', function(e) {
                const target = e.target;
                if (target.tagName === 'BUTTON' || target.tagName === 'INPUT' || target.tagName === 'SELECT' || 
                    target.tagName === 'TEXTAREA' || target.closest('button') || target.closest('input') ||
                    target.closest('select') || target.closest('textarea') || target.type === 'range' || 
                    target.closest('input[type="range"]') || target.closest('[id*="SOC"]')) {
                    // Âú®‰∫§‰∫íÂÖÉÁ¥†‰∏äÊòæÁ§∫ÈªòËÆ§ÂÖâÊ†á
                    return;
                } else {
                    // Âú®ÂÖ∂‰ªñÂå∫ÂüüÊòæÁ§∫ÁßªÂä®ÂÖâÊ†á
                    element.style.cursor = 'move';
                }
            });

            function dragMouseDown(e) {
                e = e || window.event;
                
                // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÊåâÈíÆÊàñË°®ÂçïÂÖÉÁ¥†Ôºå‰∏çÂêØÂä®ÊãñÊãΩ
                const target = e.target;
                if (target.tagName === 'BUTTON' || target.tagName === 'INPUT' || target.tagName === 'SELECT' || 
                    target.tagName === 'TEXTAREA' || target.closest('button') || target.closest('input') ||
                    target.closest('select') || target.closest('textarea') || target.type === 'range' || 
                    target.closest('input[type="range"]') || target.closest('[id*="SOC"]')) {
                    return;
                }
                
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
                element.style.cursor = 'grabbing';
                element.style.transition = 'none';
            }

            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                
                let newTop = element.offsetTop - pos2;
                let newLeft = element.offsetLeft - pos1;
                
                // ËæπÁïåÊ£ÄÊµã
                const rect = element.getBoundingClientRect();
                const maxX = window.innerWidth - rect.width;
                const maxY = window.innerHeight - rect.height;
                
                newLeft = Math.max(0, Math.min(newLeft, maxX));
                newTop = Math.max(0, Math.min(newTop, maxY));
                
                element.style.top = newTop + "px";
                element.style.left = newLeft + "px";
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
                element.style.cursor = 'move';
                element.style.transition = 'none';
                
                // ‰øùÂ≠òÊãñÊãΩÂêéÁöÑ‰ΩçÁΩÆ
                if (localStorage.getItem('conditionSettingsModalOpen') === 'true') {
                    localStorage.setItem('modalPosition', JSON.stringify({
                        top: element.style.top,
                        left: element.style.left
                    }));
                }
            }
        }


        // ÁßªÂä®Âç°ÁâáÂà∞ÊúÄËøëÁöÑÂ±èÂπïËæπÁºò
        function moveToEdge(element) {
            const rect = element.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            const screenWidth = window.innerWidth;
            const screenHeight = window.innerHeight;
            
            // ËÆ°ÁÆóÂà∞ÂêÑËæπÁºòÁöÑË∑ùÁ¶ª
            const distanceToLeft = centerX;
            const distanceToRight = screenWidth - centerX;
            const distanceToTop = centerY;
            const distanceToBottom = screenHeight - centerY;
            
            // ÊâæÂà∞ÊúÄËøëÁöÑËæπÁºò
            const minDistance = Math.min(distanceToLeft, distanceToRight, distanceToTop, distanceToBottom);
            
            let newLeft, newTop;
            
            if (minDistance === distanceToLeft) {
                // ÁßªÂä®Âà∞Â∑¶ËæπÁºò
                newLeft = 10;
                newTop = Math.max(10, Math.min(screenHeight - 70, rect.top));
            } else if (minDistance === distanceToRight) {
                // ÁßªÂä®Âà∞Âè≥ËæπÁºò
                newLeft = screenWidth - 70;
                newTop = Math.max(10, Math.min(screenHeight - 70, rect.top));
            } else if (minDistance === distanceToTop) {
                // ÁßªÂä®Âà∞È°∂ÈÉ®ËæπÁºò
                newLeft = Math.max(10, Math.min(screenWidth - 70, rect.left));
                newTop = 10;
            } else {
                // ÁßªÂä®Âà∞Â∫ïÈÉ®ËæπÁºò
                newLeft = Math.max(10, Math.min(screenWidth - 70, rect.left));
                newTop = screenHeight - 70;
            }
            
            // Â∫îÁî®Âä®ÁîªÁßªÂä®
            element.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
            element.style.left = newLeft + 'px';
            element.style.top = newTop + 'px';
            
            // ÈáçÁΩÆtransition‰ª•‰æøÂêéÁª≠ÊãñÊãΩ
            setTimeout(() => {
                element.style.transition = '';
            }, 500);
        }

        // Progress Dialog Variables
        let currentProgressData = {
            operationType: null,
            step1: { progress: 0, status: 'pending' },
            step2: { progress: 0, status: 'pending' },
            commandsSent: 0,
            successRate: 0
        };
        let progressAnimationInterval = null;

        // Show Progress Dialog
        function showProgressDialog(operationType) {
            
            // Reset progress data
            currentProgressData.operationType = operationType;
            currentProgressData.step1 = { progress: 0, status: 'pending' };
            currentProgressData.step2 = { progress: 0, status: 'pending' };
            currentProgressData.commandsSent = 500;
            currentProgressData.successRate = 0;
            
            // Update dialog content
            const progressTitle = document.getElementById('progressTitle');
            const progressIcon = document.getElementById('progressIcon');
            const progressSubtitle = document.getElementById('progressSubtitle');
            
            if (operationType === 'charge') {
                progressTitle.textContent = window.i18n ? window.i18n.getText('chargingProgress') : 'ÂÖÖÁîµËøõÂ∫¶';
                progressIcon.textContent = '‚ö°';
                progressSubtitle.textContent = window.i18n ? window.i18n.getText('operationInProgress') : 'Ê≠£Âú®ÊâßË°åÊìç‰Ωú...';
            } else if (operationType === 'discharge') {
                progressTitle.textContent = window.i18n ? window.i18n.getText('dischargingProgress') : 'ÊîæÁîµËøõÂ∫¶';
                progressIcon.textContent = 'üîã';
                progressSubtitle.textContent = window.i18n ? window.i18n.getText('operationInProgress') : 'Ê≠£Âú®ÊâßË°åÊìç‰Ωú...';
            }
            
            // Update progress info
            document.getElementById('progressCommandsSent').textContent = currentProgressData.commandsSent;
            const operationTypeElement = document.getElementById('progressOperationType');
            if (operationType === 'charge') {
                operationTypeElement.textContent = window.i18n ? window.i18n.getText('charge') : 'ÂÖÖÁîµ';
                operationTypeElement.style.color = '#00ff88';
            } else if (operationType === 'discharge') {
                operationTypeElement.textContent = window.i18n ? window.i18n.getText('discharge') : 'ÊîæÁîµ';
                operationTypeElement.style.color = '#ffc107';
            }
            
            // Reset step status and progress bars
            document.getElementById('step1Status').textContent = window.i18n ? window.i18n.getText('waiting') : 'Á≠âÂæÖ‰∏≠';
            document.getElementById('step1Status').style.background = 'rgba(255, 255, 255, 0.1)';
            document.getElementById('step1Status').style.color = 'rgba(255, 255, 255, 0.5)';
            document.getElementById('step1Progress').textContent = '0/100';
            document.getElementById('step1ProgressBar').style.width = '0%';
            
            document.getElementById('step2Status').textContent = window.i18n ? window.i18n.getText('waiting') : 'Á≠âÂæÖ‰∏≠';
            document.getElementById('step2Status').style.background = 'rgba(255, 255, 255, 0.1)';
            document.getElementById('step2Status').style.color = 'rgba(255, 255, 255, 0.5)';
            document.getElementById('step2Progress').textContent = '0/100';
            document.getElementById('step2ProgressBar').style.width = '0%';
            
            // Show modal
            const progressDialog = document.getElementById('progressDialog');
            progressDialog.style.display = 'block';
            
            // Make dialog draggable
            makeProgressDialogDraggable();
            
            // Generate floating balls for all regions
            generateFloatingBalls(operationType);
        }

        // Make Progress Dialog Draggable
        function makeProgressDialogDraggable() {
            const dialog = document.getElementById('progressDialog');
            const header = dialog.querySelector('.progress-header');
            let isDragging = false;
            let currentX;
            let currentY;
            let initialX;
            let initialY;

            function dragStart(e) {
                if (e.type === "touchstart") {
                    initialX = e.touches[0].clientX - dialog.offsetLeft;
                    initialY = e.touches[0].clientY - dialog.offsetTop;
                } else {
                    initialX = e.clientX - dialog.offsetLeft;
                    initialY = e.clientY - dialog.offsetTop;
                }

                if (e.target === header || header.contains(e.target)) {
                    isDragging = true;
                    dialog.style.transition = 'none';
                }
            }

            function dragEnd() {
                isDragging = false;
                dialog.style.transition = '';
            }

            function drag(e) {
                if (isDragging) {
                    e.preventDefault();
                    
                    if (e.type === "touchmove") {
                        currentX = e.touches[0].clientX - initialX;
                        currentY = e.touches[0].clientY - initialY;
                    } else {
                        currentX = e.clientX - initialX;
                        currentY = e.clientY - initialY;
                    }

                    dialog.style.left = currentX + "px";
                    dialog.style.top = currentY + "px";
                    dialog.style.transform = "none";
                }
            }

            // Mouse events
            header.addEventListener("mousedown", dragStart);
            document.addEventListener("mousemove", drag);
            document.addEventListener("mouseup", dragEnd);

            // Touch events
            header.addEventListener("touchstart", dragStart, { passive: false });
            document.addEventListener("touchmove", drag, { passive: false });
            document.addEventListener("touchend", dragEnd);
        }

        // Make Floating Container Draggable
        function makeFloatingContainerDraggable() {
            const container = document.getElementById('progressFloatingContainer');
            const toggleBtn = document.getElementById('progressToggleBtn');
            let isDragging = false;
            let hasDragged = false;
            let currentX;
            let currentY;
            let initialX;
            let initialY;
            let startX;
            let startY;

            function dragStart(e) {
                if (e.type === "touchstart") {
                    initialX = e.touches[0].clientX - container.offsetLeft;
                    initialY = e.touches[0].clientY - container.offsetTop;
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                } else {
                    initialX = e.clientX - container.offsetLeft;
                    initialY = e.clientY - container.offsetTop;
                    startX = e.clientX;
                    startY = e.clientY;
                }

                if (e.target === toggleBtn || toggleBtn.contains(e.target)) {
                    isDragging = true;
                    hasDragged = false;
                    container.style.transition = 'none';
                }
            }

            function dragEnd(e) {
                if (isDragging) {
                    isDragging = false;
                    container.style.transition = '';
                    
                    // If we have dragged, set flag to prevent toggle
                    if (hasDragged) {
                        isDragOperation = true;
                        e.preventDefault();
                        e.stopPropagation();
                    }
                    
                    // Reset drag state after a short delay
                    setTimeout(() => {
                        hasDragged = false;
                    }, 100);
                }
            }

            function drag(e) {
                if (isDragging) {
                    let currentMouseX, currentMouseY;
                    
                    if (e.type === "touchmove") {
                        currentMouseX = e.touches[0].clientX;
                        currentMouseY = e.touches[0].clientY;
                        currentX = currentMouseX - initialX;
                        currentY = currentMouseY - initialY;
                    } else {
                        currentMouseX = e.clientX;
                        currentMouseY = e.clientY;
                        currentX = currentMouseX - initialX;
                        currentY = currentMouseY - initialY;
                    }

                    // Check if we've moved enough to consider it a drag
                    const dragDistance = Math.sqrt(
                        Math.pow(currentMouseX - startX, 2) + Math.pow(currentMouseY - startY, 2)
                    );
                    
                    if (dragDistance > 5) {
                        hasDragged = true;
                        e.preventDefault();
                        
                        container.style.left = currentX + "px";
                        container.style.top = currentY + "px";
                        container.style.right = "auto";
                        container.style.transform = "none";
                    }
                }
            }

            // Mouse events
            toggleBtn.addEventListener("mousedown", dragStart);
            document.addEventListener("mousemove", drag);
            document.addEventListener("mouseup", dragEnd);

            // Touch events
            toggleBtn.addEventListener("touchstart", dragStart, { passive: false });
            document.addEventListener("touchmove", drag, { passive: false });
            document.addEventListener("touchend", dragEnd);
        }

        // Minimize Progress Dialog to Floating Ball
        function minimizeProgressDialog() {
            const progressDialog = document.getElementById('progressDialog');
            const floatingContainer = document.getElementById('progressFloatingContainer');
            
            progressDialog.style.display = 'none';
            floatingContainer.style.display = 'block';
            
            // Make floating container draggable
            makeFloatingContainerDraggable();
        }

        // Toggle Progress Balls Expand/Collapse
        let isDragOperation = false;
        
        function toggleProgressBalls(e) {
            // Don't toggle if this was triggered after a drag operation
            if (isDragOperation) {
                isDragOperation = false;
                return;
            }
            
            const ballsContainer = document.getElementById('progressBallsContainer');
            const toggleIcon = document.getElementById('progressToggleIcon');
            
            if (ballsContainer.style.display === 'none') {
                // Expand
                ballsContainer.style.display = 'block';
                toggleIcon.textContent = '‚ñº';
                toggleIcon.style.color = '#00ff88';
            } else {
                // Collapse
                ballsContainer.style.display = 'none';
                toggleIcon.textContent = '‚ñ≤';
                toggleIcon.style.color = '#ffc107';
            }
        }

        // Generate Floating Balls for All Regions
        function generateFloatingBalls(operationType) {
            const container = document.getElementById('progressFloatingContainer');
            const regions = ['NSW', 'QLD', 'VIC', 'SA', 'TAS'];
            
            // Clear existing balls container content
            let ballsContainer = document.getElementById('progressBallsContainer');
            if (ballsContainer) {
                ballsContainer.innerHTML = '';
            } else {
                // Create balls container if it doesn't exist
                ballsContainer = document.createElement('div');
                ballsContainer.id = 'progressBallsContainer';
                ballsContainer.style.cssText = `
                    display: block;
                    transition: all 0.3s ease;
                `;
                container.appendChild(ballsContainer);
            }
            
            regions.forEach((region, index) => {
                const ball = document.createElement('div');
                ball.className = `progress-floating-ball progress-ball-${region.toLowerCase()}`;
                ball.setAttribute('data-region', region);
                
                // For discharge, only show progress for selected region
                const isSelectedRegion = region === selectedMainRegion;
                const shouldShowProgress = operationType === 'charge' || isSelectedRegion;
                
                ball.style.cssText = `
                    width: 60px;
                    height: 60px;
                    border-radius: 50%;
                    background: linear-gradient(145deg, #1e1e2e, #2a2a3a);
                    border: 2px solid ${shouldShowProgress ? (operationType === 'charge' ? '#00ff88' : '#ffc107') : 'rgba(255, 255, 255, 0.3)'};
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    margin-bottom: 12px;
                    cursor: pointer;
                    transition: all 0.3s;
                    position: relative;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                    opacity: ${shouldShowProgress ? '1' : '0.5'};
                `;
                
                ball.innerHTML = `
                    <div style="font-size: 10px; font-weight: 600; color: #fff; margin-bottom: 2px;">${region}</div>
                    <div style="font-size: 12px; font-weight: 700; color: ${shouldShowProgress ? (operationType === 'charge' ? '#00ff88' : '#ffc107') : 'rgba(255, 255, 255, 0.5)'};">0%</div>
                `;
                
                ball.onclick = () => expandProgressDialog();
                ballsContainer.appendChild(ball);
            });
        }

        // Expand Progress Dialog from Floating Ball
        function expandProgressDialog() {
            const progressDialog = document.getElementById('progressDialog');
            const floatingContainer = document.getElementById('progressFloatingContainer');
            
            floatingContainer.style.display = 'none';
            progressDialog.style.display = 'block';
        }

        // Start Progress Animation
        function startProgressAnimation(operationType) {
            
            let step1Complete = false;
            let step2Complete = false;
            
            // Clear any existing interval
            if (progressAnimationInterval) {
                clearInterval(progressAnimationInterval);
            }
            
            progressAnimationInterval = setInterval(() => {
                // Step 1: Read device settings
                if (!step1Complete) {
                    currentProgressData.step1.progress += Math.random() * 5;
                    if (currentProgressData.step1.progress >= 100) {
                        currentProgressData.step1.progress = 100;
                        currentProgressData.step1.status = 'completed';
                        step1Complete = true;
                        
                        // Update step 1 status
                        document.getElementById('step1Status').textContent = window.i18n ? window.i18n.getText('completed') : 'Â∑≤ÂÆåÊàê';
                        document.getElementById('step1Status').style.background = 'rgba(0, 255, 136, 0.2)';
                        document.getElementById('step1Status').style.color = '#00ff88';
                    } else {
                        currentProgressData.step1.status = 'in_progress';
                        document.getElementById('step1Status').textContent = window.i18n ? window.i18n.getText('reading') : 'ËØªÂèñ‰∏≠';
                        document.getElementById('step1Status').style.background = 'rgba(255, 193, 7, 0.2)';
                        document.getElementById('step1Status').style.color = '#ffc107';
                    }
                    document.getElementById('step1Progress').textContent = `${Math.floor(currentProgressData.step1.progress)}/100`;
                    document.getElementById('step1ProgressBar').style.width = `${currentProgressData.step1.progress}%`;
                }
                
                // Step 2: Modify device settings (starts only when step 1 is completed)
                // Sync with map page execution progress
                if (step1Complete && !step2Complete) {
                    // Get map execution progress from executing devices
                    const executingCount = parseInt(document.getElementById('executingDevices')?.textContent || '0');
                    const totalCount = parseInt(document.getElementById('totalDevices')?.textContent || '500');
                    const mapProgressValue = executingCount === 0 ? 100 : Math.floor(((totalCount - executingCount) / totalCount) * 100);
                    
                    // Sync step2 progress with map progress
                    currentProgressData.step2.progress = mapProgressValue;
                    
                    if (currentProgressData.step2.progress >= 100) {
                        currentProgressData.step2.progress = 100;
                        currentProgressData.step2.status = 'completed';
                        step2Complete = true;
                        
                        // Update step 2 status
                        document.getElementById('step2Status').textContent = window.i18n ? window.i18n.getText('completed') : 'Â∑≤ÂÆåÊàê';
                        document.getElementById('step2Status').style.background = 'rgba(0, 255, 136, 0.2)';
                        document.getElementById('step2Status').style.color = '#00ff88';
                        
                        // All steps complete, stop animation
                        clearInterval(progressAnimationInterval);
                    } else {
                        currentProgressData.step2.status = 'in_progress';
                        document.getElementById('step2Status').textContent = window.i18n ? window.i18n.getText('setting') : 'ËÆæÁΩÆ‰∏≠';
                        document.getElementById('step2Status').style.background = 'rgba(255, 193, 7, 0.2)';
                        document.getElementById('step2Status').style.color = '#ffc107';
                    }
                    document.getElementById('step2Progress').textContent = `${Math.floor(currentProgressData.step2.progress)}/100`;
                    document.getElementById('step2ProgressBar').style.width = `${currentProgressData.step2.progress}%`;
                }
                
                // Calculate total progress for floating balls
                const totalProgress = (currentProgressData.step1.progress + currentProgressData.step2.progress) / 2;
                
                // Update floating balls
                updateFloatingBalls(totalProgress);
                
            }, 100); // Update every 100ms
        }

        // Update Floating Balls Progress
        function updateFloatingBalls(progress) {
            const balls = document.querySelectorAll('.progress-floating-ball');
            balls.forEach(ball => {
                const region = ball.getAttribute('data-region');
                const progressElement = ball.querySelector('div:last-child');
                
                if (progressElement) {
                    // Only update the selected region, regardless of charge or discharge
                    if (region === selectedMainRegion) {
                        progressElement.textContent = `${Math.floor(progress)}%`;
                    } else {
                        // Keep other regions at 0% 
                        progressElement.textContent = '0%';
                    }
                }
            });
        }

    </script>


    <!-- ÂèØÊãñÊãΩËá™Âä®ÂåñÊù°‰ª∂Âç°Áâá -->
    <div id="regionOverviewCard" class="draggable-region-overview-card" style="display: none;">
        <div class="region-overview-header">
            <h3 class="region-overview-title" data-i18n="automationConditions">Ëá™Âä®ÂåñÊù°‰ª∂</h3>
            <button class="region-overview-minimize-btn" onclick="closeRegionOverviewCard()" title="ÂÖ≥Èó≠">√ó</button>
        </div>
        <div class="region-overview-content">
            <div class="region-overview-body" id="regionOverviewBody">
                <!-- Ëá™Âä®ÂåñÊù°‰ª∂ÂÜÖÂÆπÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
            </div>
        </div>
    </div>


    <!-- Á°Æ‰øù condition-settings-modal.js ÁöÑÂáΩÊï∞Ë¶ÜÁõñ dashboard.html ‰∏≠ÁöÑÊóßÂáΩÊï∞ -->
    <script>
        // Âª∂ËøüÊâßË°å‰ª•Á°Æ‰øù condition-settings-modal.js Â∑≤Âä†ËΩΩ
        setTimeout(() => {
            if (typeof window.updateMainPageConditionsDisplay === 'function') {
                // Á´ãÂç≥Êõ¥Êñ∞‰∏ªÁïåÈù¢ÊòæÁ§∫
                window.updateMainPageConditionsDisplay();
            } else {
                console.error('‚ùå condition-settings-modal.js functions not found!');
            }
        }, 100);
    </script>
</body>
</html>
