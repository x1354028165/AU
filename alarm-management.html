<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•…éšœå‘Šè­¦ - AU BESS Platform</title>
    <link rel="stylesheet" href="components/common-styles.css">
    <link rel="stylesheet" href="components/drawer-component.css">
    <link rel="stylesheet" href="components/i18n.css">
    <link rel="stylesheet" href="components/notification-center.css">
    <script src="components/drawer-component.js"></script>
    <script src="components/i18n.js"></script>
    <script src="components/simple-message-icon.js"></script>
    <link rel="stylesheet" href="components/header-nav.css">
    <link rel="stylesheet" href="components/standard-layout.css">
    <link rel="stylesheet" href="components/pagination.css">
    <script src="components/header-nav.js"></script>
    <script src="components/user-menu-link.js"></script>
    <script src="components/user-dropdown-simple-new.js"></script>
    <script src="components/pagination.js"></script>
    <style>
        html, body {
            background: var(--color-bg) !important;
            width: 100vw;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            color: var(--color-text);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .container {
            background: var(--color-bg);
            max-width: 95%;
            margin: 0 auto;
            box-sizing: border-box;
            padding: 100px 10px 40px;
            min-height: calc(100vh - 200px);
        }

        /* Page Header */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 36px;
            padding: 24px 0;
            border-bottom: 1px solid var(--color-border);
        }

        .page-title {
            font-size: 28px;
            font-weight: 600;
            color: var(--color-text);
            margin: 0;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        /* Filter Section */
        .filter-section {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            align-items: center;
            margin-bottom: 32px;
            padding: 20px 24px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid var(--color-border);
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-label {
            font-size: 14px;
            color: var(--color-text-secondary);
            white-space: nowrap;
            min-width: 60px;
        }

        .filter-select {
            min-width: 140px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: #fff;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23fff' fill-opacity='0.5' d='M6 8.5L1.5 4h9z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            padding-right: 28px;
        }

        .filter-select:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(0, 255, 136, 0.5);
        }

        .filter-select option {
            background: #1a1a1a;
            color: #fff;
        }

        .date-range-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .date-input {
            width: 130px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: #fff;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .date-input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(0, 255, 136, 0.5);
        }

        .date-input::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }

        .date-separator {
            color: rgba(255, 255, 255, 0.4);
            font-size: 14px;
            font-weight: 400;
        }

        /* Status Tabs */
        .status-tabs-section {
            margin-bottom: 24px;
        }

        .status-tabs {
            display: flex;
            border-bottom: 1px solid var(--color-border);
            padding: 0;
        }

        .status-tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            font-size: 14px;
            color: var(--color-text-secondary);
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 2px solid transparent;
            position: relative;
            font-weight: 500;
        }

        .status-tab:hover {
            color: rgba(255, 255, 255, 0.8);
            background: rgba(255, 255, 255, 0.02);
        }

        .status-tab.active {
            color: #00ff88;
            border-bottom-color: #00ff88;
        }

        .tab-count {
            margin-left: 8px;
            font-size: 13px;
            color: var(--color-text-secondary);
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 12px;
        }

        .status-tab.active .tab-count {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }

        /* Action Bar */
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding: 16px 0;
        }

        .bulk-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .select-all-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .select-all-wrapper input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #00ff88;
        }

        .select-all-label {
            font-size: 14px;
            color: var(--color-text-secondary);
            cursor: pointer;
        }

        .btn-action {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .btn-action.primary {
            background: #00ff88;
            border: 1px solid #00ff88;
            color: #000;
        }

        .btn-action.primary:hover {
            background: #00cc6f;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3);
        }

        .btn-action.secondary {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: var(--color-text-secondary);
        }

        .btn-action.secondary:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--color-text);
        }

        .btn-export {
            padding: 8px 16px;
            background: rgba(30, 127, 255, 0.1);
            border: 1px solid rgba(30, 127, 255, 0.3);
            border-radius: 6px;
            color: #1e7fff;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-export:hover {
            background: rgba(30, 127, 255, 0.2);
            border-color: #1e7fff;
        }

        /* Table */
        .table-container {
            overflow-x: auto;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.02);
        }

        .alarm-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }

        .alarm-table th {
            background: rgba(255, 255, 255, 0.03);
            padding: 14px 16px;
            text-align: left;
            font-size: 13px;
            font-weight: 500;
            color: var(--color-text-secondary);
            border-bottom: 1px solid var(--color-border);
            white-space: nowrap;
        }

        .alarm-table td {
            padding: 14px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
            vertical-align: middle;
        }

        .alarm-table tbody tr {
            transition: background 0.2s ease;
        }

        .alarm-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .alarm-table input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #00ff88;
            cursor: pointer;
        }

        /* Sortable Header */
        .sortable-header {
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .sort-icon {
            font-size: 10px;
            color: var(--color-text-secondary);
            transition: color 0.3s;
        }

        .sort-icon.active {
            color: #00ff88;
        }

        /* Alarm Badges */
        .alarm-level {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
        }

        .alarm-level-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .alarm-level-dot.warning {
            background: #ff9500;
            box-shadow: 0 0 6px rgba(255, 149, 0, 0.5);
        }

        .alarm-level-dot.danger {
            background: #ff3b30;
            box-shadow: 0 0 6px rgba(255, 59, 48, 0.5);
        }

        .alarm-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
        }

        .alarm-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .alarm-status-dot.unprocessed {
            background: #ffd93d;
            box-shadow: 0 0 6px rgba(255, 217, 61, 0.5);
        }

        .alarm-status-dot.processed {
            background: #00ff88;
            box-shadow: 0 0 6px rgba(0, 255, 136, 0.5);
        }

        .alarm-status-dot.recovered {
            background: #007aff;
            box-shadow: 0 0 6px rgba(0, 122, 255, 0.5);
        }

        /* Action Buttons */
        .btn-detail {
            padding: 4px 12px;
            background: transparent;
            border: 1px solid #00ff88;
            border-radius: 4px;
            color: #00ff88;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .btn-detail:hover {
            background: #00ff88;
            color: #000;
            transform: translateY(-1px);
        }

        /* Pagination */
        .pagination-section {
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid var(--color-border);
        }

        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pagination-info {
            font-size: 14px;
            color: var(--color-text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pagination-btn {
            padding: 6px 12px;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            color: var(--color-text-secondary);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pagination-btn:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.05);
            color: var(--color-text);
        }

        .pagination-btn.active {
            background: #00ff88;
            color: #000;
            border-color: #00ff88;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-size-select {
            padding: 6px 8px;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            color: #fff;
            font-size: 14px;
            cursor: pointer;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                max-width: 98%;
                padding: 80px 8px 20px;
            }

            .filter-section {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }

            .filter-group {
                flex-direction: column;
                align-items: stretch;
                gap: 6px;
            }

            .filter-select,
            .date-input {
                width: 100%;
            }

            .action-bar {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }

            .bulk-actions {
                flex-wrap: wrap;
                gap: 8px;
            }

            .status-tabs {
                overflow-x: auto;
                padding-bottom: 2px;
            }

            .alarm-table {
                min-width: 900px;
            }

            .pagination-container {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <!-- Header Navigation Component -->
    <header-nav></header-nav>

    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title" data-i18n="faultAlarm.title">æ•…éšœå‘Šè­¦</h1>
            <div class="header-actions">
                <button class="btn-export" onclick="exportAlarms()">
                    <span>ğŸ“Š</span>
                    <span data-i18n="faultAlarm.buttons.export">å¯¼å‡º</span>
                </button>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="filter-section">
            <div class="filter-group">
                <label class="filter-label" data-i18n="faultAlarm.filters.station">ç«™ç‚¹:</label>
                <select class="filter-select" id="stationFilter" onchange="applyFilters()">
                    <option value="" data-i18n="faultAlarm.filters.allStations">å…¨éƒ¨ç«™ç‚¹</option>
                    <option value="sydney-north">æ‚‰å°¼åŒ—éƒ¨å‚¨èƒ½ç«™</option>
                    <option value="melbourne-west">å¢¨å°”æœ¬è¥¿éƒ¨å‚¨èƒ½ç«™</option>
                    <option value="brisbane-south">å¸ƒé‡Œæ–¯ç­å—éƒ¨å‚¨èƒ½ç«™</option>
                    <option value="adelaide-central">é˜¿å¾·è±å¾·ä¸­å¤®å‚¨èƒ½ç«™</option>
                    <option value="perth-east">ç€æ–¯ä¸œéƒ¨å‚¨èƒ½ç«™</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label" data-i18n="faultAlarm.filters.level">ç­‰çº§:</label>
                <select class="filter-select" id="levelFilter" onchange="applyFilters()">
                    <option value="" data-i18n="faultAlarm.filters.allLevels">å…¨éƒ¨ç­‰çº§</option>
                    <option value="fault" data-i18n="faultAlarm.levels.fault">æ•…éšœ</option>
                    <option value="alarm" data-i18n="faultAlarm.levels.alarm">å‘Šè­¦</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label" data-i18n="faultAlarm.filters.status">çŠ¶æ€:</label>
                <select class="filter-select" id="statusFilter" onchange="applyFilters()">
                    <option value="" data-i18n="faultAlarm.filters.allStatus">å…¨éƒ¨çŠ¶æ€</option>
                    <option value="unprocessed" data-i18n="faultAlarm.status.unprocessed">æœªå¤„ç†</option>
                    <option value="processed" data-i18n="faultAlarm.status.processed">å·²å¤„ç†</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label" data-i18n="faultAlarm.filters.dateRange">æ—¶é—´:</label>
                <div class="date-range-group">
                    <input type="date" class="date-input" id="startDate" onchange="applyFilters()">
                    <span class="date-separator" data-i18n="faultAlarm.filters.to">è‡³</span>
                    <input type="date" class="date-input" id="endDate" onchange="applyFilters()">
                </div>
            </div>
        </div>

        <!-- Status Tabs -->
        <div class="status-tabs-section">
            <div class="status-tabs">
                <button class="status-tab active" onclick="switchStatusTab(this, 'all')">
                    <span data-i18n="faultAlarm.tabs.all">å…¨éƒ¨</span>
                    <span class="tab-count" id="countAll">(0)</span>
                </button>
                <button class="status-tab" onclick="switchStatusTab(this, 'unprocessed')">
                    <span data-i18n="faultAlarm.tabs.unprocessed">æœªå¤„ç†</span>
                    <span class="tab-count" id="countUnprocessed">(0)</span>
                </button>
                <button class="status-tab" onclick="switchStatusTab(this, 'processed')">
                    <span data-i18n="faultAlarm.tabs.processed">å·²å¤„ç†</span>
                    <span class="tab-count" id="countProcessed">(0)</span>
                </button>
            </div>
        </div>

        <!-- Action Bar -->
        <div class="action-bar">
            <div class="bulk-actions">
                <div class="select-all-wrapper" id="selectAllWrapper">
                    <input type="checkbox" id="selectAllBtn" onchange="toggleSelectAll()">
                    <label for="selectAllBtn" class="select-all-label" data-i18n="faultAlarm.selectAll">å…¨é€‰</label>
                </div>
                <button class="btn-action primary" id="btnBatchProcess" onclick="batchProcess()" style="display:none;">
                    <span data-i18n="faultAlarm.buttons.batchProcess">ä¸€é”®å¤„ç†</span>
                </button>
            </div>
        </div>

        <!-- Alarm Table -->
        <div class="table-container">
            <table class="alarm-table">
                <thead>
                    <tr>
                        <th style="width: 40px;">
                            <input type="checkbox" id="selectAllHeader" onchange="toggleSelectAll()">
                        </th>
                        <th style="width: 160px;">
                            <div class="sortable-header" onclick="sortTable('time')">
                                <span data-i18n="faultAlarm.headers.time">å‘Šè­¦æ—¶é—´</span>
                                <span class="sort-icon" id="sort-time">â‡…</span>
                            </div>
                        </th>
                        <th style="width: 200px;" data-i18n="faultAlarm.headers.description">å‘Šè­¦æè¿°</th>
                        <th style="width: 100px;" data-i18n="faultAlarm.headers.level">å‘Šè­¦ç­‰çº§</th>
                        <th style="width: 120px;" data-i18n="faultAlarm.headers.device">å‘Šè­¦è®¾å¤‡</th>
                        <th style="width: 140px;" data-i18n="faultAlarm.headers.station">å‘Šè­¦ç«™ç‚¹</th>
                        <th style="width: 100px;" data-i18n="faultAlarm.headers.status">å‘Šè­¦çŠ¶æ€</th>
                        <th style="width: 120px;">
                            <div class="sortable-header" onclick="sortTable('recovery')">
                                <span data-i18n="faultAlarm.headers.recovery">æ¢å¤æ—¶é—´</span>
                                <span class="sort-icon" id="sort-recovery">â‡…</span>
                            </div>
                        </th>
                        <th style="width: 80px;" data-i18n="faultAlarm.headers.actions">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="alarmTableBody">
                    <!-- Table content will be rendered by JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="pagination-section">
            <div class="pagination-container">
                <div class="pagination-info">
                    <span data-i18n="faultAlarm.pagination.total">å…±</span>
                    <span id="totalCount">0</span>
                    <span data-i18n="faultAlarm.pagination.items">é¡¹å‘Šè­¦</span>
                    <span data-i18n="faultAlarm.pagination.pageSize">ï¼Œæ¯é¡µ</span>
                    <select class="page-size-select" onchange="changePageSize(this.value)">
                        <option value="10">10</option>
                        <option value="20" selected>20</option>
                        <option value="50">50</option>
                    </select>
                    <span data-i18n="faultAlarm.pagination.itemsPerPage">é¡¹</span>
                </div>
                <div class="pagination-controls">
                    <button class="pagination-btn" id="prevPage" onclick="changePage(-1)">â€¹</button>
                    <input type="number" id="currentPageInput" value="1" min="1" 
                           style="width: 60px; text-align: center; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: #fff; padding: 6px;"
                           onchange="goToPage(this.value)">
                    <button class="pagination-btn" id="nextPage" onclick="changePage(1)">â€º</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Mock data and state management
        let allAlarms = [];
        let filteredAlarms = [];
        let currentTab = 'all';
        let currentPage = 1;
        let pageSize = 20;
        let sortField = 'time';
        let sortOrder = 'desc';

        // Generate mock alarm data
        function generateMockAlarms() {
            const stations = [
                { id: 'sydney-north', name: 'æ‚‰å°¼åŒ—éƒ¨å‚¨èƒ½ç«™' },
                { id: 'melbourne-west', name: 'å¢¨å°”æœ¬è¥¿éƒ¨å‚¨èƒ½ç«™' },
                { id: 'brisbane-south', name: 'å¸ƒé‡Œæ–¯ç­å—éƒ¨å‚¨èƒ½ç«™' },
                { id: 'adelaide-central', name: 'é˜¿å¾·è±å¾·ä¸­å¤®å‚¨èƒ½ç«™' },
                { id: 'perth-east', name: 'ç€æ–¯ä¸œéƒ¨å‚¨èƒ½ç«™' }
            ];

            const devices = ['ç”µæ± æ¨¡ç»„', 'åŠŸç‡è½¬æ¢å™¨', 'HVACç³»ç»Ÿ', 'å®‰å…¨ç³»ç»Ÿ', 'ç”µç½‘è¿æ¥', 'ç›‘æ§è®¾å¤‡'];
            const descriptions = [
                'ç”µæ± æ¸©åº¦è¶…è¿‡å®‰å…¨è¿è¡ŒèŒƒå›´ï¼Œéœ€è¦å†·å´ç³»ç»Ÿå¹²é¢„',
                'åŠŸç‡è½¬æ¢æ•ˆç‡ä½äºæœ€ä¼˜é˜ˆå€¼ï¼Œéœ€è¦æ€§èƒ½ç›‘æ§',
                'HVACç³»ç»Ÿè´Ÿè½½é«˜äºé¢„æœŸï¼Œæ£€æŸ¥é€šé£è¿‡æ»¤å™¨',
                'æ£€æµ‹åˆ°ç”µç½‘é¢‘ç‡åå·®ï¼Œç³»ç»Ÿè‡ªåŠ¨è°ƒæ•´',
                'ç”±äºçƒŸé›¾æ£€æµ‹æ¿€æ´»ç´§æ€¥åœæ­¢ç³»ç»Ÿ',
                'ç›‘æ§é€šä¿¡ä¸­æ–­ï¼Œæ£€æŸ¥ç½‘ç»œè¿æ¥'
            ];

            const alarms = [];
            for (let i = 0; i < 50; i++) {
                const station = stations[Math.floor(Math.random() * stations.length)];
                const device = devices[Math.floor(Math.random() * devices.length)];
                const description = descriptions[Math.floor(Math.random() * descriptions.length)];
                const level = Math.random() > 0.6 ? 'fault' : 'alarm';
                const status = Math.random() > 0.7 ? 'unprocessed' : 'processed';
                
                const time = new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000);
                const recoveryTime = status === 'processed' ? new Date(time.getTime() + Math.random() * 4 * 60 * 60 * 1000) : null;

                alarms.push({
                    id: i + 1,
                    time: time,
                    description: description,
                    level: level,
                    levelName: level === 'fault' ? 'æ•…éšœ' : 'å‘Šè­¦',
                    device: device + ' ' + (Math.floor(Math.random() * 10) + 1).toString().padStart(2, '0'),
                    station: station.name,
                    stationId: station.id,
                    status: status,
                    statusName: status === 'unprocessed' ? 'æœªå¤„ç†' : 'å·²å¤„ç†',
                    recoveryTime: recoveryTime,
                    selected: false,
                    timezone: 'UTC+10:00'
                });
            }
            return alarms.sort((a, b) => b.time - a.time);
        }

        // Filter functions
        function applyFilters() {
            const stationFilter = document.getElementById('stationFilter').value;
            const levelFilter = document.getElementById('levelFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            filteredAlarms = allAlarms.filter(alarm => {
                // Tab filter
                if (currentTab === 'unprocessed' && alarm.status !== 'unprocessed') return false;
                if (currentTab === 'processed' && alarm.status !== 'processed') return false;

                // Station filter
                if (stationFilter && alarm.stationId !== stationFilter) return false;

                // Level filter
                if (levelFilter && alarm.level !== levelFilter) return false;

                // Status filter
                if (statusFilter && alarm.status !== statusFilter) return false;

                // Date filter
                if (startDate) {
                    const start = new Date(startDate);
                    if (alarm.time < start) return false;
                }
                if (endDate) {
                    const end = new Date(endDate);
                    end.setHours(23, 59, 59, 999);
                    if (alarm.time > end) return false;
                }

                return true;
            });

            sortAlarms();
            currentPage = 1;
            renderTable();
            updateCounts();
        }

        function sortAlarms() {
            filteredAlarms.sort((a, b) => {
                let valA, valB;
                if (sortField === 'time') {
                    valA = a.time.getTime();
                    valB = b.time.getTime();
                } else if (sortField === 'recovery') {
                    valA = a.recoveryTime ? a.recoveryTime.getTime() : 0;
                    valB = b.recoveryTime ? b.recoveryTime.getTime() : 0;
                }
                return sortOrder === 'asc' ? valA - valB : valB - valA;
            });
        }

        function sortTable(field) {
            if (sortField === field) {
                sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                sortField = field;
                sortOrder = 'desc';
            }

            // Update sort icons
            document.querySelectorAll('.sort-icon').forEach(icon => {
                icon.textContent = 'â‡…';
                icon.classList.remove('active');
            });
            const activeIcon = document.getElementById(`sort-${field}`);
            if (activeIcon) {
                activeIcon.textContent = sortOrder === 'asc' ? 'â–²' : 'â–¼';
                activeIcon.classList.add('active');
            }

            sortAlarms();
            renderTable();
        }

        // Tab functions
        function switchStatusTab(btn, status) {
            document.querySelectorAll('.status-tab').forEach(tab => tab.classList.remove('active'));
            btn.classList.add('active');
            currentTab = status;
            currentPage = 1;

            // Reset select all checkbox
            const selectAllBtn = document.getElementById('selectAllBtn');
            if (selectAllBtn) selectAllBtn.checked = false;
            const selectAllHeader = document.getElementById('selectAllHeader');
            if (selectAllHeader) selectAllHeader.checked = false;

            updateActionButtons();
            applyFilters();
        }

        function updateActionButtons() {
            const selectAllWrapper = document.getElementById('selectAllWrapper');
            const btnBatchProcess = document.getElementById('btnBatchProcess');

            if (currentTab === 'unprocessed') {
                selectAllWrapper.style.display = 'flex';
                btnBatchProcess.style.display = 'block';
            } else {
                selectAllWrapper.style.display = 'flex';
                btnBatchProcess.style.display = 'none';
            }
        }

        // Table rendering
        function formatAlarmTime(date, timezone) {
            if (!date) return '--';
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const seconds = date.getSeconds().toString().padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }

        function getLevelHTML(level) {
            const dotClass = level === 'alarm' ? 'warning' : 'danger';
            const name = level === 'fault' ? 'æ•…éšœ' : 'å‘Šè­¦';
            return `<span class="alarm-level"><span class="alarm-level-dot ${dotClass}"></span>${name}</span>`;
        }

        function getStatusHTML(status) {
            const dotClass = status === 'unprocessed' ? 'unprocessed' : 'processed';
            const name = status === 'unprocessed' ? 'æœªå¤„ç†' : 'å·²å¤„ç†';
            return `<span class="alarm-status"><span class="alarm-status-dot ${dotClass}"></span>${name}</span>`;
        }

        function renderTable() {
            const tbody = document.getElementById('alarmTableBody');
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = startIndex + pageSize;
            const pageAlarms = filteredAlarms.slice(startIndex, endIndex);

            const rows = pageAlarms.map(alarm => `
                <tr>
                    <td>
                        <input type="checkbox" ${alarm.selected ? 'checked' : ''} 
                               onchange="toggleAlarmSelect(${alarm.id}, this.checked)">
                    </td>
                    <td>${formatAlarmTime(alarm.time, alarm.timezone)}</td>
                    <td style="max-width: 200px; word-wrap: break-word;">${alarm.description}</td>
                    <td>${getLevelHTML(alarm.level)}</td>
                    <td>${alarm.device}</td>
                    <td>${alarm.station}</td>
                    <td>${getStatusHTML(alarm.status)}</td>
                    <td>${alarm.recoveryTime ? formatAlarmTime(alarm.recoveryTime) : '--'}</td>
                    <td>
                        <button class="btn-detail" onclick="showAlarmDetail(${alarm.id})">æŸ¥çœ‹</button>
                    </td>
                </tr>
            `).join('');

            tbody.innerHTML = rows;
            updatePagination();
        }

        // Selection functions
        function toggleSelectAll() {
            const selectAllBtn = document.getElementById('selectAllBtn');
            const selectAllHeader = document.getElementById('selectAllHeader');
            const isChecked = selectAllBtn ? selectAllBtn.checked : selectAllHeader.checked;
            
            // Sync both checkboxes
            if (selectAllBtn) selectAllBtn.checked = isChecked;
            if (selectAllHeader) selectAllHeader.checked = isChecked;

            filteredAlarms.forEach(alarm => {
                alarm.selected = isChecked;
            });
            renderTable();
        }

        function toggleAlarmSelect(alarmId, checked) {
            const alarm = allAlarms.find(a => a.id === alarmId);
            if (alarm) {
                alarm.selected = checked;
            }
        }

        // Batch actions
        function batchProcess() {
            const selected = allAlarms.filter(a => a.selected && a.status === 'unprocessed');
            
            if (selected.length === 0) {
                // Process all visible unprocessed alarms
                filteredAlarms.forEach(alarm => {
                    if (alarm.status === 'unprocessed') {
                        alarm.status = 'processed';
                        alarm.statusName = 'å·²å¤„ç†';
                        alarm.recoveryTime = new Date();
                    }
                });
            } else {
                selected.forEach(alarm => {
                    alarm.status = 'processed';
                    alarm.statusName = 'å·²å¤„ç†';
                    alarm.recoveryTime = new Date();
                    alarm.selected = false;
                });
            }
            
            applyFilters();
        }

        function showAlarmDetail(alarmId) {
            // Placeholder for alarm detail modal
            alert('å‘Šè­¦è¯¦æƒ…åŠŸèƒ½å¾…å®ç°');
        }

        function exportAlarms() {
            // Generate CSV
            const headers = ['å‘Šè­¦æ—¶é—´', 'å‘Šè­¦æè¿°', 'å‘Šè­¦ç­‰çº§', 'å‘Šè­¦è®¾å¤‡', 'å‘Šè­¦ç«™ç‚¹', 'å‘Šè­¦çŠ¶æ€', 'æ¢å¤æ—¶é—´'];
            const rows = filteredAlarms.map(alarm => [
                formatAlarmTime(alarm.time, alarm.timezone),
                alarm.description,
                alarm.levelName,
                alarm.device,
                alarm.station,
                alarm.statusName,
                alarm.recoveryTime ? formatAlarmTime(alarm.recoveryTime) : '--'
            ]);

            let csv = '\uFEFF' + headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(cell => `"${cell}"`).join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `fault_alarms_${new Date().toISOString().slice(0, 10)}.csv`;
            link.click();
        }

        // Count updates
        function updateCounts() {
            const counts = {
                all: allAlarms.length,
                unprocessed: allAlarms.filter(a => a.status === 'unprocessed').length,
                processed: allAlarms.filter(a => a.status === 'processed').length
            };

            document.getElementById('countAll').textContent = `(${counts.all})`;
            document.getElementById('countUnprocessed').textContent = `(${counts.unprocessed})`;
            document.getElementById('countProcessed').textContent = `(${counts.processed})`;
        }

        // Pagination
        function updatePagination() {
            const totalPages = Math.max(1, Math.ceil(filteredAlarms.length / pageSize));
            document.getElementById('totalCount').textContent = filteredAlarms.length;
            document.getElementById('currentPageInput').value = currentPage;
            document.getElementById('prevPage').disabled = currentPage <= 1;
            document.getElementById('nextPage').disabled = currentPage >= totalPages;
        }

        function changePage(delta) {
            const totalPages = Math.max(1, Math.ceil(filteredAlarms.length / pageSize));
            const newPage = currentPage + delta;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderTable();
            }
        }

        function goToPage(value) {
            const totalPages = Math.max(1, Math.ceil(filteredAlarms.length / pageSize));
            const page = parseInt(value);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                renderTable();
            }
        }

        function changePageSize(value) {
            pageSize = parseInt(value);
            currentPage = 1;
            renderTable();
        }

        // Initialize page
        function initPage() {
            // Set default date range (last 7 days)
            const now = new Date();
            const weekAgo = new Date(now);
            weekAgo.setDate(weekAgo.getDate() - 7);

            document.getElementById('startDate').value = weekAgo.toISOString().slice(0, 10);
            document.getElementById('endDate').value = now.toISOString().slice(0, 10);

            // Load data
            allAlarms = generateMockAlarms();
            updateActionButtons();
            applyFilters();
        }

        // Start the application
        document.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>